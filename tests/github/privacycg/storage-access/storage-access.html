<!doctype html><html lang="en">
 <head>
  <meta charset="utf-8">
  <title>The Storage Access API</title>
  <meta content="width=device-width" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://privacycg.github.io/storage-access/" rel="canonical">
  <link href="https://www.w3.org/2008/site/images/favicon.ico" rel="icon">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
.XXX {
    color: #E50000;
    font-weight: bold;
}
.XXX::before {
    content: "TODO: ";
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body>
  <header>
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="no-ref" id="title">The Storage Access API</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="subtitle"><span class="content">Draft Community Group Report, <time datetime="1970-01-01">1 January 1970</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://privacycg.github.io/storage-access/">https://privacycg.github.io/storage-access/</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard" data-editor-id="40614"><a class="p-name fn u-email email" href="mailto:hober@apple.com">Theresa O’Connor</a> (<a class="p-org org" href="https://apple.com">Apple Inc.</a>)
     <dd class="editor p-author h-card vcard" data-editor-id="89478"><a class="p-name fn u-email email" href="mailto:wilander@apple.com">John Wilander</a> (<a class="p-org org" href="https://apple.com/">Apple Inc.</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 the Contributors to “The Storage Access API”, published by the <a href="http://www.w3.org/community/privacycg/">Privacy Community Group</a>.

This document is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

Contributions to this document are made under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. </p>
   <hr title="Separator for header">
  </header>
  <div data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The Storage Access API enables content in iframes to request access to website data (such as cookies).</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p>This specification is intended to be merged into the HTML Living Standard. It is neither a WHATWG Living Standard nor is it on the standards track at W3C.</p>
   <p>It was published by the <a href="http://www.w3.org/community/privacycg/">Privacy Community Group</a>.
Please note that under the <a href="http://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.
Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#infra"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
    <li>
     <a href="#the-storage-access-api"><span class="secno">3</span> <span class="content">The Storage Access API</span></a>
     <ol class="toc">
      <li><a href="#ua-state"><span class="secno">3.1</span> <span class="content">User Agent state related to storage access</span></a>
      <li>
       <a href="#the-document-object"><span class="secno">3.2</span> <span class="content">Changes to <code class="idl"><span>Document</span></code></span></a>
       <ol class="toc">
        <li><a href="#ua-policy"><span class="secno">3.2.1</span> <span class="content">User Agent storage access policies</span></a>
       </ol>
      <li><a href="#navigation"><span class="secno">3.3</span> <span class="content">Changes to navigation</span></a>
      <li>
       <a href="#storage"><span class="secno">3.4</span> <span class="content">Changes to various client-side storage mechanisms</span></a>
       <ol class="toc">
        <li><a href="#cookies"><span class="secno">3.4.1</span> <span class="content">Cookies</span></a>
       </ol>
      <li><a href="#sandboxing-storage-access"><span class="secno">3.5</span> <span class="content">Sandboxing storage access</span></a>
     </ol>
    <li><a href="#privacy"><span class="secno">4</span> <span class="content">Privacy considerations</span></a>
    <li><a href="#security"><span class="secno">5</span> <span class="content">Security considerations</span></a>
    <li>
     <a href="#automation"><span class="secno">6</span> <span class="content">Automation</span></a>
     <ol class="toc">
      <li><a href="#set-storage-access-command"><span class="secno">6.1</span> <span class="content">Set Storage Access</span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno"></span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section class="non-normative">
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is non-normative.</em></p>
    <p>User Agents sometimes prevent content inside certain <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element">iframe</a></code>s from accessing data stored in client-side storage mechanisms like cookies. This can break embedded content which relies on having access to client-side storage.</p>
    <p>The Storage Access API enables content inside <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element①">iframe</a></code>s to request and be granted access to their client-side storage, so that embedded content which relies on having access to client-side storage can work in such User Agents. <a data-link-type="biblio" href="#biblio-storage-access-intro" title="Introducing Storage Access API">[STORAGE-ACCESS-INTRO]</a></p>
   </section>
   <h2 class="heading settled" data-level="2" id="infra"><span class="secno">2. </span><span class="content">Infrastructure</span><a class="self-link" href="#infra"></a></h2>
   <p>This specification depends on the Infra standard. <a data-link-type="biblio" href="#biblio-infra" title="Infra Standard">[INFRA]</a></p>
   <h2 class="heading settled" data-level="3" id="the-storage-access-api"><span class="secno">3. </span><span class="content">The Storage Access API</span><a class="self-link" href="#the-storage-access-api"></a></h2>
   <p>This specification defines a method to query whether or not a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> currently has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data">unpartitioned data</a> (<code class="idl"><a data-link-type="idl" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess">hasStorageAccess()</a></code>), and a method that can be used to request access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data①">unpartitioned data</a> (<code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess">requestStorageAccess()</a></code>).</p>
   <div class="example" id="example-a7805ce9">
    <a class="self-link" href="#example-a7805ce9"></a> 
    <p>Alex visits <code>https://social.example/</code>. The page sets a cookie. This cookie has been set in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context">first-party-site context</a>.</p>
    <p>Later on, Alex visits <code>https://video.example/</code>, which has an <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element②">iframe</a></code> on it which loads <code>https://social.example/heart-button</code>. In this case, the <code>social.example</code> <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> <var>doc</var> is in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context">third party context</a>, and the cookie set previously might or might not be visible from <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie" id="ref-for-dom-document-cookie">cookie</a></code>, depending on User Agent storage access policies.</p>
    <p>Script in the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element③">iframe</a></code> can call <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess①">hasStorageAccess()</a></code> to determine if it has access to the cookie. If it does not have access, it can request access by calling <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess①">requestStorageAccess()</a></code>.</p>
   </div>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="unpartitioned-data">Unpartitioned data</dfn> is client-side storage that would be available to a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site">site</a> were it loaded in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context①">first-party-site context</a>.</p>
   <p>A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> is in a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="first-party-site-context">first-party-site context</dfn> if it is the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document">active document</a> of a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context">top-level browsing context</a>. Otherwise, it is in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context②">first-party-site context</a> if it is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document①">active document</a> and the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin">origin</a> and <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin">top-level origin</a> of its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a> are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site">same site</a> with one another.</p>
   <p>A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> is in a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="third-party-context">third party context</dfn> if it is not in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context③">first-party-site context</a>.</p>
   <p class="issue" id="issue-b7678c76"><a class="self-link" href="#issue-b7678c76"></a> If we let nested <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element④">iframe</a></code>s use this API, we may have to revisit these definitions. <a href="https://github.com/privacycg/storage-access/issues/10">[Issue #10]</a></p>
   <h3 class="heading settled" data-level="3.1" id="ua-state"><span class="secno">3.1. </span><span class="content">User Agent state related to storage access</span><a class="self-link" href="#ua-state"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="storage-access-map">storage access map</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">map</a> whose keys are <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key">partitioned storage keys</a> and whose values are <a data-link-type="dfn" href="#storage-access-flag-set" id="ref-for-storage-access-flag-set">storage access flag sets</a>.</p>
   <p>User Agents maintain a single <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="global-storage-access-map">global storage access map</dfn>.</p>
   <p class="issue" id="issue-c97088f3"><a class="self-link" href="#issue-c97088f3"></a> What is the lifecycle of the <a data-link-type="dfn" href="#global-storage-access-map" id="ref-for-global-storage-access-map">global storage access map</a>? How long do we remember its contents? Firefox and Safari differ here. <a href="https://github.com/privacycg/storage-access/issues/2">[Issue #2]</a></p>
   <p class="issue" id="issue-5b7f617d"><a class="self-link" href="#issue-5b7f617d"></a> When do we age out entries in the <a data-link-type="dfn" href="#global-storage-access-map" id="ref-for-global-storage-access-map①">global storage access map</a>? See also <a href="https://github.com/privacycg/storage-access#scope-of-storage-access">Scope of Storage Access</a>. <a href="https://github.com/privacycg/storage-access/issues/5">[Issue #5]</a></p>
   <p>Each <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-agent-clusters" id="ref-for-sec-agent-clusters">agent cluster</a> has a <dfn class="dfn-paneled" data-dfn-for="agent cluster" data-dfn-type="dfn" data-noexport id="agent-cluster-storage-access-map">storage access map</dfn>.</p>
   <p>When an <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-agent-clusters" id="ref-for-sec-agent-clusters①">agent cluster</a> is created, its <a data-link-type="dfn" href="#agent-cluster-storage-access-map" id="ref-for-agent-cluster-storage-access-map">storage access map</a> is initialized with a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-clone" id="ref-for-map-clone">clone</a> of the <a data-link-type="dfn" href="#global-storage-access-map" id="ref-for-global-storage-access-map②">global storage access map</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="obtain-the-storage-access-map" type="abstract-op">obtain the storage access map</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code> <var>doc</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Return the <a data-link-type="dfn" href="#agent-cluster-storage-access-map" id="ref-for-agent-cluster-storage-access-map①">storage access map</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-agent" id="ref-for-relevant-agent">relevant agent</a>'s <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-agent-clusters" id="ref-for-sec-agent-clusters②">agent cluster</a>.</p>
   </ol>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="partitioned-storage-key">partitioned storage key</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple">tuple</a> consisting of a <dfn class="dfn-paneled" data-dfn-for="partitioned storage key" data-dfn-type="dfn" data-noexport id="partitioned-storage-key-top-level-site">top-level site</dfn> and an <dfn class="dfn-paneled" data-dfn-for="partitioned storage key" data-dfn-type="dfn" data-noexport id="partitioned-storage-key-embedded-site">embedded site</dfn> (both <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①">sites</a>).</p>
   <div class="example" id="example-2fc6d38b">
    <a class="self-link" href="#example-2fc6d38b"></a> 
    <p><code>(("https", "news.example"), ("https", "social.example"))</code> is a <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key①">partitioned storage key</a> whose <a data-link-type="dfn" href="#partitioned-storage-key-top-level-site" id="ref-for-partitioned-storage-key-top-level-site">top-level site</a> is <code>("https", "news.example")</code> and whose <a data-link-type="dfn" href="#partitioned-storage-key-embedded-site" id="ref-for-partitioned-storage-key-embedded-site">embedded site</a> is <code>("https", "social.example")</code>.</p>
   </div>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="generate-a-partitioned-storage-key" type="abstract-op">generate a partitioned storage key</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code> <var>doc</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object①">relevant settings object</a>.</p>
    <li data-md>
     <p>Let <var>site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin①">origin</a>.</p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc">browsing context</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context①">top-level browsing context</a>, return the <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key②">partitioned storage key</a> (<var>site</var>, <var>site</var>).</p>
    <li data-md>
     <p>Let <var>top-level site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site①">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin①">top-level origin</a>.</p>
    <li data-md>
     <p>Return the <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key③">partitioned storage key</a> (<var>top-level site</var>, <var>site</var>).</p>
   </ol>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="storage-access-flag-set">storage access flag set</dfn> is a set of zero or more of the following flags, which are used to gate access to client-side storage for <var>embedded site</var> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context①">third party context</a> on <var>top-level site</var>:</p>
   <dl>
    <dt data-md>The <dfn class="dfn-paneled" data-dfn-for="storage access flag set" data-dfn-type="dfn" data-noexport id="has-storage-access-flag">has storage access flag</dfn>
    <dd data-md>
     <p>When set, this flag indicates <var>embedded site</var> has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data②">unpartitioned data</a> when it’s loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context②">third party context</a> on <var>top-level site</var>.</p>
    <dt data-md>The <dfn class="dfn-paneled" data-dfn-for="storage access flag set" data-dfn-type="dfn" data-noexport id="was-expressly-denied-storage-access-flag">was expressly denied storage access flag</dfn>
    <dd data-md>
     <p>When set, this flag indicates that the user expressly denied <var>embedded site</var> access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data③">unpartitioned data</a> when it’s loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context③">third party context</a> on <var>top-level site</var>.</p>
   </dl>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="obtain-a-storage-access-flag-set" type="abstract-op">obtain a storage access flag set</dfn> for a <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key④">partitioned storage key</a> <var>key</var> from a <a data-link-type="dfn" href="#storage-access-map" id="ref-for-storage-access-map">storage access map</a> <var>map</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>map</var>[<var>key</var>] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists">does not exist</a>, run these steps:</p>
     <ol>
      <li data-md>
       <p>Let <var>flags</var> be a new <a data-link-type="dfn" href="#storage-access-flag-set" id="ref-for-storage-access-flag-set①">storage access flag set</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set">Set</a> <var>map</var>[<var>key</var>] to <var>flags</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>map</var>[<var>key</var>].</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="save-the-storage-access-flag-set" type="abstract-op">save the storage access flag set</dfn> for a <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key⑤">partitioned storage key</a> <var>key</var> in a <a data-link-type="dfn" href="#storage-access-map" id="ref-for-storage-access-map①">storage access map</a> <var>map</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set①">Set</a> <a data-link-type="dfn" href="#global-storage-access-map" id="ref-for-global-storage-access-map③">global storage access map</a>[<var>key</var>] to <var>map</var>[<var>key</var>].</p>
   </ol>
   <h3 class="heading settled" data-level="3.2" id="the-document-object"><span class="secno">3.2. </span><span class="content">Changes to <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑥">Document</a></code></span><a class="self-link" href="#the-document-object"></a></h3>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑦"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess②"><c- g>hasStorageAccess</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise①"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess②"><c- g>requestStorageAccess</c-></a>();
};
</pre>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑧">Document</a></code> <var>doc</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-hasstorageaccess"><code>hasStorageAccess()</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise">a new promise</a>.</p>
    <li data-md>
     <p>Let <var>map</var> be the result of <a data-link-type="dfn" href="#obtain-the-storage-access-map" id="ref-for-obtain-the-storage-access-map">obtaining the storage access map</a> for <var>doc</var>.</p>
    <li data-md>
     <p>Let <var>key</var> be the result of <a data-link-type="dfn" href="#generate-a-partitioned-storage-key" id="ref-for-generate-a-partitioned-storage-key">generating a partitioned storage key</a> from <var>doc</var>.</p>
    <li data-md>
     <p>If <var>key</var> is failure, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">resolve</a> <var>p</var> with false and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>flag set</var> be the result of <a data-link-type="dfn" href="#obtain-a-storage-access-flag-set" id="ref-for-obtain-a-storage-access-flag-set">obtaining the storage access flag set</a> with <var>key</var> from <var>map</var>.</p>
    <li data-md>
     <p>If <var>flag set</var>’s <a data-link-type="dfn" href="#was-expressly-denied-storage-access-flag" id="ref-for-was-expressly-denied-storage-access-flag">was expressly denied storage access flag</a> is set, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①">resolve</a> <var>p</var> with false and return <var>p</var>. </p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin">origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve②">resolve</a> <var>p</var> with false and return <var>p</var>. </p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc①">browsing context</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context②">top-level browsing context</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve③">resolve</a> <var>p</var> with true and return <var>p</var>. </p>
    <li data-md>
     <p>Let <var>topDoc</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document②">active document</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc②">browsing context</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context③">top-level browsing context</a>.</p>
    <li data-md>
     <p>If <var>doc</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin">same origin</a> with <var>topDoc</var>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve④">resolve</a> <var>p</var> with true and return <var>p</var>. </p>
    <li data-md>
     <p>Let <var>key</var> be the result of <a data-link-type="dfn" href="#generate-a-partitioned-storage-key" id="ref-for-generate-a-partitioned-storage-key①">generating a partitioned storage key</a> from <var>doc</var>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑤">Resolve</a> <var>p</var> with the result of running <a data-link-type="dfn" href="#determine-if-a-site-has-storage-access" id="ref-for-determine-if-a-site-has-storage-access">determine if a site has storage access</a> with <var>key</var> and <var>doc</var>. </p>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p class="issue" id="issue-9416e44b"><a class="self-link" href="#issue-9416e44b"></a> Shouldn’t step 7 be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site①">same site</a>?</p>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑨">Document</a></code> <var>doc</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-requeststorageaccess"><code>requestStorageAccess()</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise①">a new promise</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps" id="ref-for-enqueue-the-following-steps">Enqueue the following steps</a> on the <a data-link-type="dfn">permission task source</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>map</var> be the result of <a data-link-type="dfn" href="#obtain-the-storage-access-map" id="ref-for-obtain-the-storage-access-map①">obtaining the storage access map</a> for <var>doc</var>.</p>
      <li data-md>
       <p>Let <var>key</var> be the result of <a data-link-type="dfn" href="#generate-a-partitioned-storage-key" id="ref-for-generate-a-partitioned-storage-key②">generating a partitioned storage key</a> from <var>doc</var>.</p>
      <li data-md>
       <p>If <var>key</var> is failure, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject">reject</a> <var>p</var>.</p>
      <li data-md>
       <p>Let <var>flag set</var> be the result of <a data-link-type="dfn" href="#obtain-a-storage-access-flag-set" id="ref-for-obtain-a-storage-access-flag-set①">obtaining the storage access flag set</a> with <var>key</var> from <var>map</var>.</p>
      <li data-md>
       <p>If <var>flag set</var>’s <a data-link-type="dfn" href="#was-expressly-denied-storage-access-flag" id="ref-for-was-expressly-denied-storage-access-flag①">was expressly denied storage access flag</a> is set, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject①">reject</a> <var>p</var>.</p>
      <li data-md>
       <p>If <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag">has storage access flag</a> is set, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑥">resolve</a> <var>p</var>. </p>
      <li data-md>
       <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin①">origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque①">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject②">reject</a> <var>p</var>. </p>
      <li data-md>
       <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc③">browsing context</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context④">top-level browsing context</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑦">resolve</a> <var>p</var>. </p>
      <li data-md>
       <p>Let <var>topDoc</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document③">active document</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc④">browsing context</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context⑤">top-level browsing context</a>.</p>
      <li data-md>
       <p>If <var>doc</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin①">same origin</a> with <var>topDoc</var>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑧">resolve</a> <var>p</var>. </p>
      <li data-md>
       <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set" id="ref-for-active-sandboxing-flag-set">active sandboxing flag set</a> has its <a data-link-type="dfn" href="#sandbox-storage-access-by-user-activation-flag" id="ref-for-sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</a> set, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject③">reject</a> <var>p</var>. </p>
      <li data-md>
       <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc⑤">browsing context</a>'s <a data-link-type="dfn">parent browsing context</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context⑥">top-level browsing context</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject④">reject</a> <var>p</var>. </p>
      <li data-md>
       <p>If this algorithm was invoked when <var>doc</var>’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window">Window</a></code> object did not have <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation">transient activation</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑤">reject</a> <var>p</var>. </p>
      <li data-md>
       <p><a data-link-type="dfn" href="#determine-the-storage-access-policy" id="ref-for-determine-the-storage-access-policy">Determine the storage access policy</a> with <var>key</var>, <var>doc</var>, and <var>p</var>. </p>
      <li data-md>
       <p>Set <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag①">has storage access flag</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#save-the-storage-access-flag-set" id="ref-for-save-the-storage-access-flag-set">Save the storage access flag set</a> for <var>key</var> in <var>map</var>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑨">Resolve</a> <var>p</var>. </p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p class="issue" id="issue-18c86ea4"><a class="self-link" href="#issue-18c86ea4"></a> Shouldn’t step 3.7 be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site②">same site</a>?</p>
   <p class="issue" id="issue-41e7fe80"><a class="self-link" href="#issue-41e7fe80"></a> Remove step 3.9 if we determine that nested <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element⑤">iframe</a></code>s should be able to request storage access. <a href="https://github.com/privacycg/storage-access/issues/10">[Issue #10]</a></p>
   <h4 class="heading settled" data-level="3.2.1" id="ua-policy"><span class="secno">3.2.1. </span><span class="content">User Agent storage access policies</span><a class="self-link" href="#ua-policy"></a></h4>
   <p>Different User Agents have different policies around whether or not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site②">sites</a> may access their <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data④">unpartitioned data</a> when they’re in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context④">third party context</a>. User Agents check and/or modify these policies when client-side storage is accessed (see <a href="#storage">§ 3.4 Changes to various client-side storage mechanisms</a>) as well as when <code class="idl"><a data-link-type="idl" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess③">hasStorageAccess()</a></code> and <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess③">requestStorageAccess()</a></code> are called.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-if-a-site-has-storage-access" type="abstract-op">determine if a site has storage access</dfn> with <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key⑥">partitioned storage key</a> <var>key</var> and <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⓪">Document</a></code> <var>doc</var>, run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>map</var> be the result of <a data-link-type="dfn" href="#obtain-the-storage-access-map" id="ref-for-obtain-the-storage-access-map②">obtaining the storage access map</a> for <var>doc</var>.</p>
    <li data-md>
     <p>Let <var>flag set</var> be the result of <a data-link-type="dfn" href="#obtain-a-storage-access-flag-set" id="ref-for-obtain-a-storage-access-flag-set②">obtaining the storage access flag set</a> with <var>key</var> from <var>map</var>.</p>
    <li data-md>
     <p>If <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag②">has storage access flag</a> is set, return true.</p>
    <li data-md>
     <p>Let <var>has storage access</var> (a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean">boolean</a>) be the result of running an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> set of steps to determine if <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-embedded-site" id="ref-for-partitioned-storage-key-embedded-site①">embedded site</a> has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑤">unpartitioned data</a> on <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-top-level-site" id="ref-for-partitioned-storage-key-top-level-site①">top-level site</a>.</p>
    <li data-md>
     <p>If <var>has storage access</var> is true, set <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag③">has storage access flag</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#save-the-storage-access-flag-set" id="ref-for-save-the-storage-access-flag-set①">Save the storage access flag set</a> for <var>key</var> in <var>map</var>.</p>
    <li data-md>
     <p>Return <var>has storage access</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-the-storage-access-policy" type="abstract-op">determine the storage access policy</dfn> for <a data-link-type="dfn" href="#partitioned-storage-key" id="ref-for-partitioned-storage-key⑦">partitioned storage key</a> <var>key</var> with <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①①">Document</a></code> <var>doc</var> and <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise②">Promise</a></code> <var>p</var>, run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>map</var> be the result of <a data-link-type="dfn" href="#obtain-the-storage-access-map" id="ref-for-obtain-the-storage-access-map③">obtaining the storage access map</a> for <var>doc</var>.</p>
    <li data-md>
     <p>Let <var>flag set</var> be the result of <a data-link-type="dfn" href="#obtain-a-storage-access-flag-set" id="ref-for-obtain-a-storage-access-flag-set③">obtaining the storage access flag set</a> with <var>key</var> from <var>map</var>.</p>
    <li data-md>
     <p>Let <var>implicitly granted</var> and <var>implicitly denied</var> (each a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean①">boolean</a>) be the result of running an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined①">implementation-defined</a> set of steps to determine if <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-embedded-site" id="ref-for-partitioned-storage-key-embedded-site②">embedded site</a>'s request for storage access on <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-top-level-site" id="ref-for-partitioned-storage-key-top-level-site②">top-level site</a> should be granted or denied without prompting the user.</p>
     <p class="note" role="note"><span class="marker">Note:</span> These <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined②">implementation-defined</a> set of steps might result in <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag④">has storage access flag</a> and <a data-link-type="dfn" href="#was-expressly-denied-storage-access-flag" id="ref-for-was-expressly-denied-storage-access-flag②">was expressly denied storage access flag</a> changing, since the User Agent could have relevant out-of-band information (e.g. a user preference that changed) that this specification is unaware of.</p>
    <li data-md>
     <p>If <var>implicitly granted</var> is true, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①⓪">resolve</a> <var>p</var> and return.</p>
    <li data-md>
     <p>If <var>implicitly denied</var> is true, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑥">reject</a> <var>p</var> and return.</p>
    <li data-md>
     <p>Ask the user if they would like to grant <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-embedded-site" id="ref-for-partitioned-storage-key-embedded-site③">embedded site</a> access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑥">unpartitioned data</a> when it’s loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑤">third party context</a> on <var>key</var>’s <a data-link-type="dfn" href="#partitioned-storage-key-top-level-site" id="ref-for-partitioned-storage-key-top-level-site③">top-level site</a>, and wait for an answer. Let <var>expressly granted</var> and <var>expressly denied</var> (both <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean②">booleans</a>) be the result.</p>
     <p class="note" role="note"><span class="marker">Note:</span> While <var>expressly granted</var> and <var>expressly denied</var> cannot both be true, they could both be false in User Agents which allow users to dismiss the prompt without choosing to allow or deny the request. (Such a dismissal is interpreted in this algorithm as a denial.)</p>
    <li data-md>
     <p>If <var>expressly granted</var> is true, run these steps:</p>
     <ol>
      <li data-md>
       <p>Unset <var>flag set</var>’s <a data-link-type="dfn" href="#was-expressly-denied-storage-access-flag" id="ref-for-was-expressly-denied-storage-access-flag③">was expressly denied storage access flag</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#save-the-storage-access-flag-set" id="ref-for-save-the-storage-access-flag-set②">Save the storage access flag set</a> for <var>key</var> in <var>map</var>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①①">Resolve</a> <var>p</var> and return. </p>
     </ol>
    <li data-md>
     <p>Unset <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag⑤">has storage access flag</a>.</p>
    <li data-md>
     <p>If <var>expressly denied</var> is true, run these steps:</p>
     <ol>
      <li data-md>
       <p>If <var>doc</var>’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window①">Window</a></code> object has <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation①">transient activation</a>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation" id="ref-for-consume-user-activation">consume user activation</a> with it. </p>
      <li data-md>
       <p>Set <var>flag set</var>’s <a data-link-type="dfn" href="#was-expressly-denied-storage-access-flag" id="ref-for-was-expressly-denied-storage-access-flag④">was expressly denied storage access flag</a>.</p>
     </ol>
    <li data-md>
     <p><a data-link-type="dfn" href="#save-the-storage-access-flag-set" id="ref-for-save-the-storage-access-flag-set③">Save the storage access flag set</a> for <var>key</var> in <var>map</var>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑦">Reject</a> <var>p</var> and return. </p>
   </ol>
   <p class="issue" id="issue-65ce4cf9"><a class="self-link" href="#issue-65ce4cf9"></a> <a href="https://github.com/privacycg/storage-access/pull/24#discussion_r408784492">since this is UA-defined, does it make sense to follow-up separately with a user prompt?</a></p>
   <h3 class="heading settled" data-level="3.3" id="navigation"><span class="secno">3.3. </span><span class="content">Changes to navigation</span><a class="self-link" href="#navigation"></a></h3>
   <p>Before changing the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-current-entry" id="ref-for-navigation-current-entry">current entry</a> of a <a data-link-type="dfn">session history</a>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>doc</var> be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-current-entry" id="ref-for-navigation-current-entry①">current entry</a>'s <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①②">Document</a></code>.</p>
    <li data-md>
     <p>Let <var>map</var> be the result of <a data-link-type="dfn" href="#obtain-the-storage-access-map" id="ref-for-obtain-the-storage-access-map④">obtaining the storage access map</a> for <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc⑥">browsing context</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context⑦">top-level browsing context</a>.</p>
    <li data-md>
     <p>Let <var>key</var> be the result of <a data-link-type="dfn" href="#generate-a-partitioned-storage-key" id="ref-for-generate-a-partitioned-storage-key③">generating a partitioned storage key</a> from <var>doc</var>.</p>
    <li data-md>
     <p>If <var>key</var> is failure, abort these steps.</p>
    <li data-md>
     <p>Let <var>flag set</var> be the result of <a data-link-type="dfn" href="#obtain-a-storage-access-flag-set" id="ref-for-obtain-a-storage-access-flag-set④">obtaining the storage access flag set</a> with <var>key</var> from <var>map</var>.</p>
    <li data-md>
     <p>Unset <var>flag set</var>’s <a data-link-type="dfn" href="#has-storage-access-flag" id="ref-for-has-storage-access-flag⑥">has storage access flag</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#save-the-storage-access-flag-set" id="ref-for-save-the-storage-access-flag-set④">Save the storage access flag set</a> for <var>key</var> in <var>map</var>.</p>
   </ol>
   <p class="issue" id="issue-0b5538d9"><a class="self-link" href="#issue-0b5538d9"></a> What this section should look like ultimately hinges on <a href="https://github.com/privacycg/storage-access/issues/3">[Issue #3]</a></p>
   <h3 class="heading settled" data-level="3.4" id="storage"><span class="secno">3.4. </span><span class="content">Changes to various client-side storage mechanisms</span><a class="self-link" href="#storage"></a></h3>
   <p class="issue" id="issue-322b6430"><a class="self-link" href="#issue-322b6430"></a> Write this section. For each kind of client-side storage affected, modify them to invoke <a data-link-type="dfn" href="#determine-if-a-site-has-storage-access" id="ref-for-determine-if-a-site-has-storage-access①">determine if a site has storage access</a> &amp; modify their behavior based on the result.</p>
   <p class="issue" id="issue-924f0e5d"><a class="self-link" href="#issue-924f0e5d"></a> Should this API affect client-side storage other than cookies? <a href="https://github.com/privacycg/storage-access/issues/4">[Issue #4]</a></p>
   <h4 class="heading settled" data-level="3.4.1" id="cookies"><span class="secno">3.4.1. </span><span class="content">Cookies</span><a class="self-link" href="#cookies"></a></h4>
   <p class="issue" id="issue-089b92ec"><a class="self-link" href="#issue-089b92ec"></a> Write this section.</p>
   <h3 class="heading settled" data-level="3.5" id="sandboxing-storage-access"><span class="secno">3.5. </span><span class="content">Sandboxing storage access</span><a class="self-link" href="#sandboxing-storage-access"></a></h3>
   <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set" id="ref-for-sandboxing-flag-set">sandboxing flag set</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</dfn>. This flag prevents content from requesting storage access.</p>
   <p>To the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive" id="ref-for-parse-a-sandboxing-directive">parse a sandboxing directive</a> algorithm, add the following under step 3:</p>
   <ul>
    <li>The <a data-link-type="dfn" href="#sandbox-storage-access-by-user-activation-flag" id="ref-for-sandbox-storage-access-by-user-activation-flag①">sandbox storage access by user activation flag</a>, unless <var>tokens</var> contains the <dfn class="dfn-paneled" data-dfn-for="iframe/sandbox" data-dfn-type="attr-value" data-export id="attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation"><code>allow-storage-access-by-user-activation</code></dfn> keyword. 
   </ul>
   <p class="issue" id="issue-4c448f45"><a class="self-link" href="#issue-4c448f45"></a> What about Feature Policy? <a href="https://github.com/privacycg/storage-access/issues/12">[Issue #12]</a></p>
   <h2 class="heading settled" data-level="4" id="privacy"><span class="secno">4. </span><span class="content">Privacy considerations</span><a class="self-link" href="#privacy"></a></h2>
   <p class="issue" id="issue-089b92ec①"><a class="self-link" href="#issue-089b92ec①"></a> Write this section.</p>
   <figure id="example-prompt">
     <img alt="A modal dialog box which states &apos;Do you want to allow “video.example” to use cookies and website data while browsing “news.example”? This will allow “video.example” to track your activity.&apos; and which has two buttons, “Don’t Allow” and “Allow”." src="images/storage-access-prompt.png"> 
    <figcaption>An example prompt which could be shown to the user when a site calls <code>document.</code><code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess④">requestStorageAccess()</a></code>.</figcaption>
   </figure>
   <h2 class="heading settled" data-level="5" id="security"><span class="secno">5. </span><span class="content">Security considerations</span><a class="self-link" href="#security"></a></h2>
   <p class="issue" id="issue-089b92ec②"><a class="self-link" href="#issue-089b92ec②"></a> Write this section.</p>
   <h2 class="heading settled" data-level="6" id="automation"><span class="secno">6. </span><span class="content">Automation</span><a class="self-link" href="#automation"></a></h2>
   <p>For the purposes of user-agent automation and application testing, this document defines the following <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands" id="ref-for-dfn-extension-commands">extension command</a> for the <a data-link-type="biblio" href="#biblio-webdriver" title="WebDriver">[WebDriver]</a> specification.</p>
   <h3 class="heading settled" data-level="6.1" id="set-storage-access-command"><span class="secno">6.1. </span><span class="content">Set Storage Access</span><a class="self-link" href="#set-storage-access-command"></a></h3>
   <table>
    <tbody>
     <tr>
      <th>HTTP Method
      <th>URI Template
     <tr>
      <td>POST
      <td>/session/{session id}/storageaccess
   </table>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="set-storage-access">Set Storage Access</dfn> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands" id="ref-for-dfn-extension-commands①">extension command</a> modifies the storage access policy for the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context">current browsing context</a>.</p>
   <p>The <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps" id="ref-for-dfn-remote-end-steps">remote end steps</a> are:</p>
   <ol>
    <li data-md>
     <p>Let <var>blocked</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties" id="ref-for-dfn-getting-properties">getting a property</a> from <var>parameters</var> named <code>blocked</code>.</p>
    <li data-md>
     <p>If <var>blocked</var> is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean③">boolean</a> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument" id="ref-for-dfn-invalid-argument">invalid argument</a>.</p>
    <li data-md>
     <p>Let <var>origin</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties" id="ref-for-dfn-getting-properties①">getting a property</a> from <var>parameters</var> named <code>origin</code>.</p>
    <li data-md>
     <p>If <var>origin</var> is not a single U+002A ASTERISK character (*), then:</p>
     <ol>
      <li data-md>
       <p>Let <var>parsedURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser">URL parser</a> on <var>origin</var>.</p>
      <li data-md>
       <p>If <var>parsedURL</var> is failure, then return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error①">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code①">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument" id="ref-for-dfn-invalid-argument①">invalid argument</a>.</p>
      <li data-md>
       <p>Set <var>origin</var> to <var>parsedURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a>.</p>
     </ol>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context①">current browsing context</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context⑧">top-level browsing context</a> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error②">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code②">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation" id="ref-for-dfn-unsupported-operation">unsupported operation</a>.</p>
    <li data-md>
     <p>Let <var>doc</var> be the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context②">current browsing context</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document④">active document</a>.</p>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object②">relevant settings object</a>.</p>
    <li data-md>
     <p>Let <var>top-level site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site②">obtaining a site</a> from <var>settings</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin②">origin</a>.</p>
    <li data-md>
     <p>If <var>origin</var> is a single U+002A ASTERISK character (*), then:</p>
     <ol>
      <li data-md>
       <p>If <var>blocked</var> is <code>true</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined③">implementation-defined</a> set of steps to ensure that no site has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑦">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑥">third party context</a> on <var>top-level site</var>.</p>
       </ol>
      <li data-md>
       <p>Otherwise, if <var>blocked</var> is <code>false</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined④">implementation-defined</a> set of steps to ensure that any site has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑧">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑦">third party context</a> on <var>top-level site</var>.</p>
       </ol>
     </ol>
    <li data-md>
     <p>Otherwise:</p>
     <ol>
      <li data-md>
       <p>Let <var>embedded site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site③">obtaining a site</a> from <var>origin</var>.</p>
      <li data-md>
       <p>If <var>embedded site</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site③">same site</a> with <var>top-level site</var> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error③">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code③">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation" id="ref-for-dfn-unsupported-operation①">unsupported operation</a>.</p>
      <li data-md>
       <p>If <var>blocked</var> is <code>true</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑤">implementation-defined</a> set of steps to ensure that <var>embedded site</var> does not have access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑨">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑧">third party context</a> on <var>top-level site</var>.</p>
       </ol>
      <li data-md>
       <p>Otherwise, if <var>blocked</var> is <code>false</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑥">implementation-defined</a> set of steps to ensure that <var>embedded site</var> has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data①⓪">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑨">third party context</a> on <var>top-level site</var>.</p>
       </ol>
     </ol>
    <li data-md>
     <p>If the above <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑦">implementation-defined</a> step of steps resulted in failure, return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error④">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code④">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error" id="ref-for-dfn-unknown-error">unknown error</a>.</p>
    <li data-md>
     <p>Return <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success" id="ref-for-dfn-success">success</a> with data <code>null</code>.</p>
   </ol>
   <h2 class="no-num heading settled" id="acknowledgements"><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p>Many thanks to
Anne van Kesteren,
Ben Kelly,
Brad Girardeau,
Brad Hill,
Brady Eidson,
Brandon Maslen,
Chris Mills,
Dave Longley,
Domenic Denicola,
Ehsan Akhgari,
Geoffrey Garen,
Jack Frankland,
James Coleman,
James Hartig,
Jeffrey Yasskin,
Kushal Dave,
Luís Rudge,
Maciej Stachowiak,
Matias Woloski,
Mike O’Neill,
Mike West,
Pete Snyder,
Rob Stone,
Stefan Leyhane,
Steven Englehardt,
Theresa O’Connor,
Travis Leithead,
Yan Zhu,
Zach Edwards,
and everyone who commented on <a href="https://github.com/whatwg/html/issues/3338">whatwg/html#3338</a>, <a href="https://github.com/privacycg/proposals/issues/2">privacycg/proposals#2</a>, and <a href="https://github.com/privacycg/storage-access/issues">privacycg/storage-access/issues</a> for their feedback on this proposal.</p>
   <p>Thanks to the <a href="https://webkit.org/">WebKit Open Source Project</a> for allowing us to use the <a href="#example-prompt">Storage Access API Prompt</a> image, which was <a href="https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/">originally published on webkit.org</a>.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation">allow-storage-access-by-user-activation</a><span>, in § 3.5</span>
   <li><a href="#determine-if-a-site-has-storage-access">determine if a site has storage access</a><span>, in § 3.2.1</span>
   <li><a href="#determine-the-storage-access-policy">determine the storage access policy</a><span>, in § 3.2.1</span>
   <li><a href="#partitioned-storage-key-embedded-site">embedded site</a><span>, in § 3.1</span>
   <li><a href="#first-party-site-context">first-party-site context</a><span>, in § 3</span>
   <li><a href="#generate-a-partitioned-storage-key">generate a partitioned storage key</a><span>, in § 3.1</span>
   <li><a href="#global-storage-access-map">global storage access map</a><span>, in § 3.1</span>
   <li><a href="#dom-document-hasstorageaccess">hasStorageAccess()</a><span>, in § 3.2</span>
   <li><a href="#has-storage-access-flag">has storage access flag</a><span>, in § 3.1</span>
   <li><a href="#obtain-a-storage-access-flag-set">obtain a storage access flag set</a><span>, in § 3.1</span>
   <li><a href="#obtain-the-storage-access-map">obtain the storage access map</a><span>, in § 3.1</span>
   <li><a href="#partitioned-storage-key">partitioned storage key</a><span>, in § 3.1</span>
   <li><a href="#dom-document-requeststorageaccess">requestStorageAccess()</a><span>, in § 3.2</span>
   <li><a href="#sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</a><span>, in § 3.5</span>
   <li><a href="#save-the-storage-access-flag-set">save the storage access flag set</a><span>, in § 3.1</span>
   <li><a href="#set-storage-access">Set Storage Access</a><span>, in § 6.1</span>
   <li><a href="#storage-access-flag-set">storage access flag set</a><span>, in § 3.1</span>
   <li>
    storage access map
    <ul>
     <li><a href="#storage-access-map">definition of</a><span>, in § 3.1</span>
     <li><a href="#agent-cluster-storage-access-map">dfn for agent cluster</a><span>, in § 3.1</span>
    </ul>
   <li><a href="#third-party-context">third party context</a><span>, in § 3</span>
   <li><a href="#partitioned-storage-key-top-level-site">top-level site</a><span>, in § 3.1</span>
   <li><a href="#unpartitioned-data">Unpartitioned data</a><span>, in § 3</span>
   <li><a href="#was-expressly-denied-storage-access-flag">was expressly denied storage access flag</a><span>, in § 3.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="c62cd7cf">origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ECMASCRIPT]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="f6e4cbfd">agent cluster</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="35972864">active document</span>
     <li><span class="dfn-paneled" id="27e10eaf">active sandboxing flag set</span>
     <li><span class="dfn-paneled" id="3b2ff63e">browsing context</span>
     <li><span class="dfn-paneled" id="aca22383">consume user activation</span>
     <li><span class="dfn-paneled" id="a1e6e861">cookie</span>
     <li><span class="dfn-paneled" id="cff2c60f">current entry</span>
     <li><span class="dfn-paneled" id="102df61f">enqueue the following steps</span>
     <li><span class="dfn-paneled" id="87fcd40c">iframe</span>
     <li><span class="dfn-paneled" id="602b1a68">obtain a site</span>
     <li><span class="dfn-paneled" id="b01b1359">opaque origin</span>
     <li><span class="dfn-paneled" id="43ac8374">origin</span>
     <li><span class="dfn-paneled" id="53f0ea4e">parse a sandboxing directive</span>
     <li><span class="dfn-paneled" id="d8049b98">relevant agent</span>
     <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="f0482ed2">same site</span>
     <li><span class="dfn-paneled" id="457a6f4c">sandboxing flag set</span>
     <li><span class="dfn-paneled" id="fb9bb722">site</span>
     <li><span class="dfn-paneled" id="ae2a6342">top-level browsing context</span>
     <li><span class="dfn-paneled" id="c63519ed">top-level origin</span>
     <li><span class="dfn-paneled" id="47fe679e">transient activation</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="36858240">boolean</span>
     <li><span class="dfn-paneled" id="ab3919d2">clone</span>
     <li><span class="dfn-paneled" id="1243a891">exist</span>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
     <li><span class="dfn-paneled" id="3fca5a9e">map</span>
     <li><span class="dfn-paneled" id="0e6b2056">set</span>
     <li><span class="dfn-paneled" id="0e8de730">tuple</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="959ad97b">origin</span>
     <li><span class="dfn-paneled" id="ca3ca4ae">url parser</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WebDriver]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d695a1e4">current browsing context</span>
     <li><span class="dfn-paneled" id="64eb4e66">extension command</span>
     <li><span class="dfn-paneled" id="ae66758d">getting a property</span>
     <li><span class="dfn-paneled" id="48968b5b">invalid argument</span>
     <li><span class="dfn-paneled" id="5661b7f6">remote end steps</span>
     <li><span class="dfn-paneled" id="986c69cd">success</span>
     <li><span class="dfn-paneled" id="2dfbf26c">unknown error</span>
     <li><span class="dfn-paneled" id="87b50d92">unsupported operation</span>
     <li><span class="dfn-paneled" id="991d0ba3">webdriver error</span>
     <li><span class="dfn-paneled" id="c45850fd">webdriver error code</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
     <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
     <li><span class="dfn-paneled" id="b262501e">reject</span>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
     <li><span class="dfn-paneled" id="5f90bbfb">undefined</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-ecmascript">[ECMASCRIPT]
   <dd><a href="https://tc39.es/ecma262/multipage/"><cite>ECMAScript Language Specification</cite></a>. URL: <a href="https://tc39.es/ecma262/multipage/">https://tc39.es/ecma262/multipage/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-webdriver">[WebDriver]
   <dd>Simon Stewart; David Burns. <a href="https://w3c.github.io/webdriver/"><cite>WebDriver</cite></a>. URL: <a href="https://w3c.github.io/webdriver/">https://w3c.github.io/webdriver/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-storage-access-intro">[STORAGE-ACCESS-INTRO]
   <dd>John Wilander. <a href="https://webkit.org/blog/8124/introducing-storage-access-api/"><cite>Introducing Storage Access API</cite></a>. February 2018. Blog post. URL: <a href="https://webkit.org/blog/8124/introducing-storage-access-api/">https://webkit.org/blog/8124/introducing-storage-access-api/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasstorageaccess"><c- g>hasStorageAccess</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-requeststorageaccess"><c- g>requestStorageAccess</c-></a>();
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> If we let nested <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element">iframe</a></code>s use this API, we may have to revisit these definitions. <a href="https://github.com/privacycg/storage-access/issues/10">[Issue #10]</a> <a class="issue-return" href="#issue-b7678c76" title="Jump to section">↵</a></div>
   <div class="issue"> What is the lifecycle of the <a data-link-type="dfn" href="#global-storage-access-map">global storage access map</a>? How long do we remember its contents? Firefox and Safari differ here. <a href="https://github.com/privacycg/storage-access/issues/2">[Issue #2]</a> <a class="issue-return" href="#issue-c97088f3" title="Jump to section">↵</a></div>
   <div class="issue"> When do we age out entries in the <a data-link-type="dfn" href="#global-storage-access-map">global storage access map</a>? See also <a href="https://github.com/privacycg/storage-access#scope-of-storage-access">Scope of Storage Access</a>. <a href="https://github.com/privacycg/storage-access/issues/5">[Issue #5]</a> <a class="issue-return" href="#issue-5b7f617d" title="Jump to section">↵</a></div>
   <div class="issue"> Shouldn’t step 7 be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site">same site</a>? <a class="issue-return" href="#issue-9416e44b" title="Jump to section">↵</a></div>
   <div class="issue"> Shouldn’t step 3.7 be <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site">same site</a>? <a class="issue-return" href="#issue-18c86ea4" title="Jump to section">↵</a></div>
   <div class="issue"> Remove step 3.9 if we determine that nested <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element">iframe</a></code>s should be able to request storage access. <a href="https://github.com/privacycg/storage-access/issues/10">[Issue #10]</a> <a class="issue-return" href="#issue-41e7fe80" title="Jump to section">↵</a></div>
   <div class="issue"> <a href="https://github.com/privacycg/storage-access/pull/24#discussion_r408784492">since this is UA-defined, does it make sense to follow-up separately with a user prompt?</a> <a class="issue-return" href="#issue-65ce4cf9" title="Jump to section">↵</a></div>
   <div class="issue"> What this section should look like ultimately hinges on <a href="https://github.com/privacycg/storage-access/issues/3">[Issue #3]</a> <a class="issue-return" href="#issue-0b5538d9" title="Jump to section">↵</a></div>
   <div class="issue"> Write this section. For each kind of client-side storage affected, modify them to invoke <a data-link-type="dfn" href="#determine-if-a-site-has-storage-access">determine if a site has storage access</a> &amp; modify their behavior based on the result. <a class="issue-return" href="#issue-322b6430" title="Jump to section">↵</a></div>
   <div class="issue"> Should this API affect client-side storage other than cookies? <a href="https://github.com/privacycg/storage-access/issues/4">[Issue #4]</a> <a class="issue-return" href="#issue-924f0e5d" title="Jump to section">↵</a></div>
   <div class="issue"> Write this section. <a class="issue-return" href="#issue-089b92ec" title="Jump to section">↵</a></div>
   <div class="issue"> What about Feature Policy? <a href="https://github.com/privacycg/storage-access/issues/12">[Issue #12]</a> <a class="issue-return" href="#issue-4c448f45" title="Jump to section">↵</a></div>
   <div class="issue"> Write this section. <a class="issue-return" href="#issue-089b92ec①" title="Jump to section">↵</a></div>
   <div class="issue"> Write this section. <a class="issue-return" href="#issue-089b92ec②" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0e6b2056": {"dfnID":"0e6b2056","dfnText":"set","external":true,"refSections":[{"refs":[{"id":"ref-for-map-set"},{"id":"ref-for-map-set\u2460"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#map-set"},
"0e8de730": {"dfnID":"0e8de730","dfnText":"tuple","external":true,"refSections":[{"refs":[{"id":"ref-for-tuple"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#tuple"},
"102df61f": {"dfnID":"102df61f","dfnText":"enqueue the following steps","external":true,"refSections":[{"refs":[{"id":"ref-for-enqueue-the-following-steps"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"},
"1243a891": {"dfnID":"1243a891","dfnText":"exist","external":true,"refSections":[{"refs":[{"id":"ref-for-map-exists"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#map-exists"},
"27e10eaf": {"dfnID":"27e10eaf","dfnText":"active sandboxing flag set","external":true,"refSections":[{"refs":[{"id":"ref-for-active-sandboxing-flag-set"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"2dfbf26c": {"dfnID":"2dfbf26c","dfnText":"unknown error","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-unknown-error"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error"},
"35972864": {"dfnID":"35972864","dfnText":"active document","external":true,"refSections":[{"refs":[{"id":"ref-for-nav-document"},{"id":"ref-for-nav-document\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-nav-document\u2461"},{"id":"ref-for-nav-document\u2462"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-nav-document\u2463"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"36858240": {"dfnID":"36858240","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-boolean"},{"id":"ref-for-boolean\u2460"},{"id":"ref-for-boolean\u2461"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-boolean\u2462"}],"title":"6.1. Set Storage Access"}],"url":"https://infra.spec.whatwg.org/#boolean"},
"3b2ff63e": {"dfnID":"3b2ff63e","dfnText":"browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-bc"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-concept-document-bc\u2460"},{"id":"ref-for-concept-document-bc\u2461"},{"id":"ref-for-concept-document-bc\u2462"},{"id":"ref-for-concept-document-bc\u2463"},{"id":"ref-for-concept-document-bc\u2464"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-concept-document-bc\u2465"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"3b90bdcd": {"dfnID":"3b90bdcd","dfnText":"resolve","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve"},{"id":"ref-for-resolve\u2460"},{"id":"ref-for-resolve\u2461"},{"id":"ref-for-resolve\u2462"},{"id":"ref-for-resolve\u2463"},{"id":"ref-for-resolve\u2464"},{"id":"ref-for-resolve\u2465"},{"id":"ref-for-resolve\u2466"},{"id":"ref-for-resolve\u2467"},{"id":"ref-for-resolve\u2468"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-resolve\u2460\u24ea"},{"id":"ref-for-resolve\u2460\u2460"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://webidl.spec.whatwg.org/#resolve"},
"3fca5a9e": {"dfnID":"3fca5a9e","dfnText":"map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"43ac8374": {"dfnID":"43ac8374","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-origin"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-settings-object-origin\u2460"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-concept-settings-object-origin\u2461"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"457a6f4c": {"dfnID":"457a6f4c","dfnText":"sandboxing flag set","external":true,"refSections":[{"refs":[{"id":"ref-for-sandboxing-flag-set"}],"title":"3.5. Sandboxing storage access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set"},
"47fe679e": {"dfnID":"47fe679e","dfnText":"transient activation","external":true,"refSections":[{"refs":[{"id":"ref-for-transient-activation"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-transient-activation\u2460"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"48968b5b": {"dfnID":"48968b5b","dfnText":"invalid argument","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-invalid-argument"},{"id":"ref-for-dfn-invalid-argument\u2460"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument"},
"5372cca8": {"dfnID":"5372cca8","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-boolean"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"53f0ea4e": {"dfnID":"53f0ea4e","dfnText":"parse a sandboxing directive","external":true,"refSections":[{"refs":[{"id":"ref-for-parse-a-sandboxing-directive"}],"title":"3.5. Sandboxing storage access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive"},
"5661b7f6": {"dfnID":"5661b7f6","dfnText":"remote end steps","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-remote-end-steps"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-window\u2460"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"5f90bbfb": {"dfnID":"5f90bbfb","dfnText":"undefined","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-undefined"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"602b1a68": {"dfnID":"602b1a68","dfnText":"obtain a site","external":true,"refSections":[{"refs":[{"id":"ref-for-obtain-a-site"},{"id":"ref-for-obtain-a-site\u2460"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-obtain-a-site\u2461"},{"id":"ref-for-obtain-a-site\u2462"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"64eb4e66": {"dfnID":"64eb4e66","dfnText":"extension command","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-extension-commands"}],"title":"6. Automation"},{"refs":[{"id":"ref-for-dfn-extension-commands\u2460"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands"},
"7393da89": {"dfnID":"7393da89","dfnText":"same origin","external":true,"refSections":[{"refs":[{"id":"ref-for-same-origin"},{"id":"ref-for-same-origin\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"},{"id":"ref-for-document\u2460"},{"id":"ref-for-document\u2461"},{"id":"ref-for-document\u2462"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-document\u2463"},{"id":"ref-for-document\u2464"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-document\u2465"},{"id":"ref-for-document\u2466"},{"id":"ref-for-document\u2467"},{"id":"ref-for-document\u2468"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-document\u2460\u24ea"},{"id":"ref-for-document\u2460\u2460"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-document\u2460\u2461"}],"title":"3.3. Changes to navigation"}],"url":"https://dom.spec.whatwg.org/#document"},
"860300d4": {"dfnID":"860300d4","dfnText":"implementation-defined","external":true,"refSections":[{"refs":[{"id":"ref-for-implementation-defined"},{"id":"ref-for-implementation-defined\u2460"},{"id":"ref-for-implementation-defined\u2461"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-implementation-defined\u2462"},{"id":"ref-for-implementation-defined\u2463"},{"id":"ref-for-implementation-defined\u2464"},{"id":"ref-for-implementation-defined\u2465"},{"id":"ref-for-implementation-defined\u2466"}],"title":"6.1. Set Storage Access"}],"url":"https://infra.spec.whatwg.org/#implementation-defined"},
"87b50d92": {"dfnID":"87b50d92","dfnText":"unsupported operation","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-unsupported-operation"},{"id":"ref-for-dfn-unsupported-operation\u2460"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation"},
"87fcd40c": {"dfnID":"87fcd40c","dfnText":"iframe","external":true,"refSections":[{"refs":[{"id":"ref-for-the-iframe-element"},{"id":"ref-for-the-iframe-element\u2460"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-the-iframe-element\u2461"},{"id":"ref-for-the-iframe-element\u2462"},{"id":"ref-for-the-iframe-element\u2463"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-the-iframe-element\u2464"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"959ad97b": {"dfnID":"959ad97b","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-origin"}],"title":"6.1. Set Storage Access"}],"url":"https://url.spec.whatwg.org/#concept-url-origin"},
"986c69cd": {"dfnID":"986c69cd","dfnText":"success","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-success"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success"},
"991d0ba3": {"dfnID":"991d0ba3","dfnText":"webdriver error","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-error"},{"id":"ref-for-dfn-error\u2460"},{"id":"ref-for-dfn-error\u2461"},{"id":"ref-for-dfn-error\u2462"},{"id":"ref-for-dfn-error\u2463"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error"},
"9c4c1e66": {"dfnID":"9c4c1e66","dfnText":"relevant settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-relevant-settings-object"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-relevant-settings-object\u2460"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-relevant-settings-object\u2461"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"a1e6e861": {"dfnID":"a1e6e861","dfnText":"cookie","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-cookie"}],"title":"3. The Storage Access API"}],"url":"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie"},
"ab3919d2": {"dfnID":"ab3919d2","dfnText":"clone","external":true,"refSections":[{"refs":[{"id":"ref-for-map-clone"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#map-clone"},
"aca22383": {"dfnID":"aca22383","dfnText":"consume user activation","external":true,"refSections":[{"refs":[{"id":"ref-for-consume-user-activation"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation"},
"ae2a6342": {"dfnID":"ae2a6342","dfnText":"top-level browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-top-level-browsing-context"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2460"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2461"},{"id":"ref-for-top-level-browsing-context\u2462"},{"id":"ref-for-top-level-browsing-context\u2463"},{"id":"ref-for-top-level-browsing-context\u2464"},{"id":"ref-for-top-level-browsing-context\u2465"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2466"}],"title":"3.3. Changes to navigation"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2467"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"ae66758d": {"dfnID":"ae66758d","dfnText":"getting a property","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-getting-properties"},{"id":"ref-for-dfn-getting-properties\u2460"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties"},
"agent-cluster-storage-access-map": {"dfnID":"agent-cluster-storage-access-map","dfnText":"storage access map","external":false,"refSections":[{"refs":[{"id":"ref-for-agent-cluster-storage-access-map"},{"id":"ref-for-agent-cluster-storage-access-map\u2460"}],"title":"3.1. User Agent state related to storage access"}],"url":"#agent-cluster-storage-access-map"},
"attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation": {"dfnID":"attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation","dfnText":"allow-storage-access-by-user-activation","external":false,"refSections":[],"url":"#attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation"},
"b01b1359": {"dfnID":"b01b1359","dfnText":"opaque origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-opaque"},{"id":"ref-for-concept-origin-opaque\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"b262501e": {"dfnID":"b262501e","dfnText":"reject","external":true,"refSections":[{"refs":[{"id":"ref-for-reject"},{"id":"ref-for-reject\u2460"},{"id":"ref-for-reject\u2461"},{"id":"ref-for-reject\u2462"},{"id":"ref-for-reject\u2463"},{"id":"ref-for-reject\u2464"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-reject\u2465"},{"id":"ref-for-reject\u2466"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://webidl.spec.whatwg.org/#reject"},
"bdbd19d1": {"dfnID":"bdbd19d1","dfnText":"Promise","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-promise"},{"id":"ref-for-idl-promise\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-idl-promise\u2461"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://webidl.spec.whatwg.org/#idl-promise"},
"c45850fd": {"dfnID":"c45850fd","dfnText":"webdriver error code","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-error-code"},{"id":"ref-for-dfn-error-code\u2460"},{"id":"ref-for-dfn-error-code\u2461"},{"id":"ref-for-dfn-error-code\u2462"},{"id":"ref-for-dfn-error-code\u2463"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code"},
"c62cd7cf": {"dfnID":"c62cd7cf","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-origin"},{"id":"ref-for-concept-document-origin\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://dom.spec.whatwg.org/#concept-document-origin"},
"c63519ed": {"dfnID":"c63519ed","dfnText":"top-level origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-environment-top-level-origin"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-environment-top-level-origin\u2460"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"ca3ca4ae": {"dfnID":"ca3ca4ae","dfnText":"url parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-parser"}],"title":"6.1. Set Storage Access"}],"url":"https://url.spec.whatwg.org/#concept-url-parser"},
"cff2c60f": {"dfnID":"cff2c60f","dfnText":"current entry","external":true,"refSections":[{"refs":[{"id":"ref-for-navigation-current-entry"},{"id":"ref-for-navigation-current-entry\u2460"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-current-entry"},
"d695a1e4": {"dfnID":"d695a1e4","dfnText":"current browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-current-browsing-context"},{"id":"ref-for-dfn-current-browsing-context\u2460"},{"id":"ref-for-dfn-current-browsing-context\u2461"}],"title":"6.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context"},
"d8049b98": {"dfnID":"d8049b98","dfnText":"relevant agent","external":true,"refSections":[{"refs":[{"id":"ref-for-relevant-agent"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-agent"},
"dacde8b5": {"dfnID":"dacde8b5","dfnText":"a new promise","external":true,"refSections":[{"refs":[{"id":"ref-for-a-new-promise"},{"id":"ref-for-a-new-promise\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"determine-if-a-site-has-storage-access": {"dfnID":"determine-if-a-site-has-storage-access","dfnText":"determine if a site has storage access","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-if-a-site-has-storage-access"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-determine-if-a-site-has-storage-access\u2460"}],"title":"3.4. Changes to various client-side storage mechanisms"}],"url":"#determine-if-a-site-has-storage-access"},
"determine-the-storage-access-policy": {"dfnID":"determine-the-storage-access-policy","dfnText":"determine the storage access policy","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-the-storage-access-policy"}],"title":"3.2. Changes to Document"}],"url":"#determine-the-storage-access-policy"},
"dom-document-hasstorageaccess": {"dfnID":"dom-document-hasstorageaccess","dfnText":"hasStorageAccess()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-hasstorageaccess"},{"id":"ref-for-dom-document-hasstorageaccess\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-dom-document-hasstorageaccess\u2461"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dom-document-hasstorageaccess\u2462"}],"title":"3.2.1. User Agent storage access policies"}],"url":"#dom-document-hasstorageaccess"},
"dom-document-requeststorageaccess": {"dfnID":"dom-document-requeststorageaccess","dfnText":"requestStorageAccess()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-requeststorageaccess"},{"id":"ref-for-dom-document-requeststorageaccess\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2461"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2462"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2463"}],"title":"4. Privacy considerations"}],"url":"#dom-document-requeststorageaccess"},
"f0482ed2": {"dfnID":"f0482ed2","dfnText":"same site","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-site-same-site"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-site-same-site\u2460"},{"id":"ref-for-concept-site-same-site\u2461"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-concept-site-same-site\u2462"}],"title":"6.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site"},
"f6e4cbfd": {"dfnID":"f6e4cbfd","dfnText":"agent cluster","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-agent-clusters"},{"id":"ref-for-sec-agent-clusters\u2460"},{"id":"ref-for-sec-agent-clusters\u2461"}],"title":"3.1. User Agent state related to storage access"}],"url":"https://tc39.github.io/ecma262/#sec-agent-clusters"},
"fb9bb722": {"dfnID":"fb9bb722","dfnText":"site","external":true,"refSections":[{"refs":[{"id":"ref-for-site"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-site\u2460"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-site\u2461"}],"title":"3.2.1. User Agent storage access policies"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"first-party-site-context": {"dfnID":"first-party-site-context","dfnText":"first-party-site context","external":false,"refSections":[{"refs":[{"id":"ref-for-first-party-site-context"},{"id":"ref-for-first-party-site-context\u2460"},{"id":"ref-for-first-party-site-context\u2461"},{"id":"ref-for-first-party-site-context\u2462"}],"title":"3. The Storage Access API"}],"url":"#first-party-site-context"},
"generate-a-partitioned-storage-key": {"dfnID":"generate-a-partitioned-storage-key","dfnText":"generate a partitioned storage key","external":false,"refSections":[{"refs":[{"id":"ref-for-generate-a-partitioned-storage-key"},{"id":"ref-for-generate-a-partitioned-storage-key\u2460"},{"id":"ref-for-generate-a-partitioned-storage-key\u2461"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-generate-a-partitioned-storage-key\u2462"}],"title":"3.3. Changes to navigation"}],"url":"#generate-a-partitioned-storage-key"},
"global-storage-access-map": {"dfnID":"global-storage-access-map","dfnText":"global storage access map","external":false,"refSections":[{"refs":[{"id":"ref-for-global-storage-access-map"},{"id":"ref-for-global-storage-access-map\u2460"},{"id":"ref-for-global-storage-access-map\u2461"},{"id":"ref-for-global-storage-access-map\u2462"}],"title":"3.1. User Agent state related to storage access"}],"url":"#global-storage-access-map"},
"has-storage-access-flag": {"dfnID":"has-storage-access-flag","dfnText":"has storage access flag","external":false,"refSections":[{"refs":[{"id":"ref-for-has-storage-access-flag"},{"id":"ref-for-has-storage-access-flag\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-has-storage-access-flag\u2461"},{"id":"ref-for-has-storage-access-flag\u2462"},{"id":"ref-for-has-storage-access-flag\u2463"},{"id":"ref-for-has-storage-access-flag\u2464"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-has-storage-access-flag\u2465"}],"title":"3.3. Changes to navigation"}],"url":"#has-storage-access-flag"},
"obtain-a-storage-access-flag-set": {"dfnID":"obtain-a-storage-access-flag-set","dfnText":"obtain a storage access flag set","external":false,"refSections":[{"refs":[{"id":"ref-for-obtain-a-storage-access-flag-set"},{"id":"ref-for-obtain-a-storage-access-flag-set\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-obtain-a-storage-access-flag-set\u2461"},{"id":"ref-for-obtain-a-storage-access-flag-set\u2462"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-obtain-a-storage-access-flag-set\u2463"}],"title":"3.3. Changes to navigation"}],"url":"#obtain-a-storage-access-flag-set"},
"obtain-the-storage-access-map": {"dfnID":"obtain-the-storage-access-map","dfnText":"obtain the storage access map","external":false,"refSections":[{"refs":[{"id":"ref-for-obtain-the-storage-access-map"},{"id":"ref-for-obtain-the-storage-access-map\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-obtain-the-storage-access-map\u2461"},{"id":"ref-for-obtain-the-storage-access-map\u2462"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-obtain-the-storage-access-map\u2463"}],"title":"3.3. Changes to navigation"}],"url":"#obtain-the-storage-access-map"},
"partitioned-storage-key": {"dfnID":"partitioned-storage-key","dfnText":"partitioned storage key","external":false,"refSections":[{"refs":[{"id":"ref-for-partitioned-storage-key"},{"id":"ref-for-partitioned-storage-key\u2460"},{"id":"ref-for-partitioned-storage-key\u2461"},{"id":"ref-for-partitioned-storage-key\u2462"},{"id":"ref-for-partitioned-storage-key\u2463"},{"id":"ref-for-partitioned-storage-key\u2464"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-partitioned-storage-key\u2465"},{"id":"ref-for-partitioned-storage-key\u2466"}],"title":"3.2.1. User Agent storage access policies"}],"url":"#partitioned-storage-key"},
"partitioned-storage-key-embedded-site": {"dfnID":"partitioned-storage-key-embedded-site","dfnText":"embedded site","external":false,"refSections":[{"refs":[{"id":"ref-for-partitioned-storage-key-embedded-site"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-partitioned-storage-key-embedded-site\u2460"},{"id":"ref-for-partitioned-storage-key-embedded-site\u2461"},{"id":"ref-for-partitioned-storage-key-embedded-site\u2462"}],"title":"3.2.1. User Agent storage access policies"}],"url":"#partitioned-storage-key-embedded-site"},
"partitioned-storage-key-top-level-site": {"dfnID":"partitioned-storage-key-top-level-site","dfnText":"top-level site","external":false,"refSections":[{"refs":[{"id":"ref-for-partitioned-storage-key-top-level-site"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-partitioned-storage-key-top-level-site\u2460"},{"id":"ref-for-partitioned-storage-key-top-level-site\u2461"},{"id":"ref-for-partitioned-storage-key-top-level-site\u2462"}],"title":"3.2.1. User Agent storage access policies"}],"url":"#partitioned-storage-key-top-level-site"},
"sandbox-storage-access-by-user-activation-flag": {"dfnID":"sandbox-storage-access-by-user-activation-flag","dfnText":"sandbox storage access by user activation flag","external":false,"refSections":[{"refs":[{"id":"ref-for-sandbox-storage-access-by-user-activation-flag"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-sandbox-storage-access-by-user-activation-flag\u2460"}],"title":"3.5. Sandboxing storage access"}],"url":"#sandbox-storage-access-by-user-activation-flag"},
"save-the-storage-access-flag-set": {"dfnID":"save-the-storage-access-flag-set","dfnText":"save the storage access flag set","external":false,"refSections":[{"refs":[{"id":"ref-for-save-the-storage-access-flag-set"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-save-the-storage-access-flag-set\u2460"},{"id":"ref-for-save-the-storage-access-flag-set\u2461"},{"id":"ref-for-save-the-storage-access-flag-set\u2462"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-save-the-storage-access-flag-set\u2463"}],"title":"3.3. Changes to navigation"}],"url":"#save-the-storage-access-flag-set"},
"set-storage-access": {"dfnID":"set-storage-access","dfnText":"Set Storage Access","external":false,"refSections":[],"url":"#set-storage-access"},
"storage-access-flag-set": {"dfnID":"storage-access-flag-set","dfnText":"storage access flag set","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-flag-set"},{"id":"ref-for-storage-access-flag-set\u2460"}],"title":"3.1. User Agent state related to storage access"}],"url":"#storage-access-flag-set"},
"storage-access-map": {"dfnID":"storage-access-map","dfnText":"storage access map","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-map"},{"id":"ref-for-storage-access-map\u2460"}],"title":"3.1. User Agent state related to storage access"}],"url":"#storage-access-map"},
"third-party-context": {"dfnID":"third-party-context","dfnText":"third party context","external":false,"refSections":[{"refs":[{"id":"ref-for-third-party-context"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-third-party-context\u2460"},{"id":"ref-for-third-party-context\u2461"},{"id":"ref-for-third-party-context\u2462"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-third-party-context\u2463"},{"id":"ref-for-third-party-context\u2464"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-third-party-context\u2465"},{"id":"ref-for-third-party-context\u2466"},{"id":"ref-for-third-party-context\u2467"},{"id":"ref-for-third-party-context\u2468"}],"title":"6.1. Set Storage Access"}],"url":"#third-party-context"},
"unpartitioned-data": {"dfnID":"unpartitioned-data","dfnText":"Unpartitioned data","external":false,"refSections":[{"refs":[{"id":"ref-for-unpartitioned-data"},{"id":"ref-for-unpartitioned-data\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-unpartitioned-data\u2461"},{"id":"ref-for-unpartitioned-data\u2462"}],"title":"3.1. User Agent state related to storage access"},{"refs":[{"id":"ref-for-unpartitioned-data\u2463"},{"id":"ref-for-unpartitioned-data\u2464"},{"id":"ref-for-unpartitioned-data\u2465"}],"title":"3.2.1. User Agent storage access policies"},{"refs":[{"id":"ref-for-unpartitioned-data\u2466"},{"id":"ref-for-unpartitioned-data\u2467"},{"id":"ref-for-unpartitioned-data\u2468"},{"id":"ref-for-unpartitioned-data\u2460\u24ea"}],"title":"6.1. Set Storage Access"}],"url":"#unpartitioned-data"},
"was-expressly-denied-storage-access-flag": {"dfnID":"was-expressly-denied-storage-access-flag","dfnText":"was expressly denied storage access flag","external":false,"refSections":[{"refs":[{"id":"ref-for-was-expressly-denied-storage-access-flag"},{"id":"ref-for-was-expressly-denied-storage-access-flag\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-was-expressly-denied-storage-access-flag\u2461"},{"id":"ref-for-was-expressly-denied-storage-access-flag\u2462"},{"id":"ref-for-was-expressly-denied-storage-access-flag\u2463"}],"title":"3.2.1. User Agent storage access policies"}],"url":"#was-expressly-denied-storage-access-flag"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#agent-cluster-storage-access-map": {"export":true,"for_":["agent cluster"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"storage access map","type":"dfn","url":"#agent-cluster-storage-access-map"},
"#determine-if-a-site-has-storage-access": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine if a site has storage access","type":"dfn","url":"#determine-if-a-site-has-storage-access"},
"#determine-the-storage-access-policy": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine the storage access policy","type":"dfn","url":"#determine-the-storage-access-policy"},
"#dom-document-hasstorageaccess": {"export":true,"for_":["Document"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"hasStorageAccess()","type":"method","url":"#dom-document-hasstorageaccess"},
"#dom-document-requeststorageaccess": {"export":true,"for_":["Document"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"requestStorageAccess()","type":"method","url":"#dom-document-requeststorageaccess"},
"#first-party-site-context": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"first-party-site context","type":"dfn","url":"#first-party-site-context"},
"#generate-a-partitioned-storage-key": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"generate a partitioned storage key","type":"dfn","url":"#generate-a-partitioned-storage-key"},
"#global-storage-access-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"global storage access map","type":"dfn","url":"#global-storage-access-map"},
"#has-storage-access-flag": {"export":true,"for_":["storage access flag set"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"has storage access flag","type":"dfn","url":"#has-storage-access-flag"},
"#obtain-a-storage-access-flag-set": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"obtain a storage access flag set","type":"dfn","url":"#obtain-a-storage-access-flag-set"},
"#obtain-the-storage-access-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"obtain the storage access map","type":"dfn","url":"#obtain-the-storage-access-map"},
"#partitioned-storage-key": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"partitioned storage key","type":"dfn","url":"#partitioned-storage-key"},
"#partitioned-storage-key-embedded-site": {"export":true,"for_":["partitioned storage key"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"embedded site","type":"dfn","url":"#partitioned-storage-key-embedded-site"},
"#partitioned-storage-key-top-level-site": {"export":true,"for_":["partitioned storage key"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"top-level site","type":"dfn","url":"#partitioned-storage-key-top-level-site"},
"#sandbox-storage-access-by-user-activation-flag": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"sandbox storage access by user activation flag","type":"dfn","url":"#sandbox-storage-access-by-user-activation-flag"},
"#save-the-storage-access-flag-set": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"save the storage access flag set","type":"dfn","url":"#save-the-storage-access-flag-set"},
"#storage-access-flag-set": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"storage access flag set","type":"dfn","url":"#storage-access-flag-set"},
"#storage-access-map": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"storage access map","type":"dfn","url":"#storage-access-map"},
"#third-party-context": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"third party context","type":"dfn","url":"#third-party-context"},
"#unpartitioned-data": {"export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"unpartitioned data","type":"dfn","url":"#unpartitioned-data"},
"#was-expressly-denied-storage-access-flag": {"export":true,"for_":["storage access flag set"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"was expressly denied storage access flag","type":"dfn","url":"#was-expressly-denied-storage-access-flag"},
"https://dom.spec.whatwg.org/#concept-document-origin": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"origin","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document-origin"},
"https://dom.spec.whatwg.org/#document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active sandboxing flag set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opaque origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site": {"export":true,"for_":["site"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"obtain a site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"parse a sandboxing directive","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive"},
"https://html.spec.whatwg.org/multipage/browsers.html#same-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"sandboxing flag set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set"},
"https://html.spec.whatwg.org/multipage/browsers.html#site": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document": {"export":true,"for_":["navigable"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active document","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"cookie","type":"attribute","url":"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"iframe","type":"element","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps": {"export":true,"for_":["parallel queue"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"enqueue the following steps","type":"dfn","url":"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"},
"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"consume user activation","type":"dfn","url":"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation"},
"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"transient activation","type":"dfn","url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-current-entry": {"export":false,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"current entry","type":"dfn","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-current-entry"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin": {"export":true,"for_":["environment"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin": {"export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-agent": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant agent","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-agent"},
"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"https://infra.spec.whatwg.org/#boolean": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"boolean","type":"dfn","url":"https://infra.spec.whatwg.org/#boolean"},
"https://infra.spec.whatwg.org/#implementation-defined": {"export":true,"for_":[],"level":"","normative":true,"shortname":"infra","spec":"infra","status":"anchor-block","text":"implementation-defined","type":"dfn","url":"https://infra.spec.whatwg.org/#implementation-defined"},
"https://infra.spec.whatwg.org/#map-clone": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"clone","type":"dfn","url":"https://infra.spec.whatwg.org/#map-clone"},
"https://infra.spec.whatwg.org/#map-exists": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"exist","type":"dfn","url":"https://infra.spec.whatwg.org/#map-exists"},
"https://infra.spec.whatwg.org/#map-set": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"set","type":"dfn","url":"https://infra.spec.whatwg.org/#map-set"},
"https://infra.spec.whatwg.org/#ordered-map": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://infra.spec.whatwg.org/#tuple": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"tuple","type":"dfn","url":"https://infra.spec.whatwg.org/#tuple"},
"https://tc39.github.io/ecma262/#sec-agent-clusters": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ecmascript","spec":"ecmascript","status":"anchor-block","text":"agent cluster","type":"dfn","url":"https://tc39.github.io/ecma262/#sec-agent-clusters"},
"https://url.spec.whatwg.org/#concept-url-origin": {"export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"origin","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-origin"},
"https://url.spec.whatwg.org/#concept-url-parser": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"url parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-parser"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"current browsing context","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"webdriver error","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"webdriver error code","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"extension command","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"getting a property","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"invalid argument","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"remote end steps","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"success","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"unknown error","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"unsupported operation","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation"},
"https://webidl.spec.whatwg.org/#a-new-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"a new promise","type":"dfn","url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"https://webidl.spec.whatwg.org/#idl-boolean": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"boolean","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"https://webidl.spec.whatwg.org/#idl-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Promise","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-promise"},
"https://webidl.spec.whatwg.org/#idl-undefined": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"undefined","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"https://webidl.spec.whatwg.org/#reject": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"reject","type":"dfn","url":"https://webidl.spec.whatwg.org/#reject"},
"https://webidl.spec.whatwg.org/#resolve": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"resolve","type":"dfn","url":"https://webidl.spec.whatwg.org/#resolve"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>