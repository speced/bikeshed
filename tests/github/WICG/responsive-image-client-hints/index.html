<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Responsive Image Client Hints</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/responsive-image-client-hints" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Responsive Image Client Hints</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/responsive-image-client-hints">https://wicg.github.io/responsive-image-client-hints</a>
     <dt>Previous Versions:
     <dd><a href="https://whatpr.org/html/3774/images.html#image-related-client-hints-request-headers" rel="prev">https://whatpr.org/html/3774/images.html#image-related-client-hints-request-headers</a>
     <dd><a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-client-hints-06#section-3" rel="prev">https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-client-hints-06#section-3</a>
     <dd><a href="https://github.com/igrigorik/http-client-hints/blob/565e540d9d53681064c6903bf08ceb1dfbedebe4/draft.md#client-hint-request-header-fields" rel="prev">https://github.com/igrigorik/http-client-hints/blob/565e540d9d53681064c6903bf08ceb1dfbedebe4/draft.md#client-hint-request-header-fields</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://ericportis.com">Eric Portis</a> (<span class="p-org org">Cloudinary</span>) <a class="u-email email" href="mailto:e@ericportis.com">e@ericportis.com</a>
     <dt class="editor">Former Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://blog.yoav.ws">Yoav Weiss</a> (<span class="p-org org">Google</span>) <a class="u-email email" href="mailto:yoav@yoav.ws">yoav@yoav.ws</a>
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://www.igvita.com">Ilya Grigorik</a> (<span class="p-org org">Google</span>) <a class="u-email email" href="mailto:ilya@igvita.com">ilya@igvita.com</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 the Contributors to the Responsive Image Client Hints Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This spec introduces several client hints useful for delivering responsive images via pro-active content negotiation.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#responsive-image-hints"><span class="secno">2</span> <span class="content">Responsive Image Hints</span></a>
     <ol class="toc">
      <li><a href="#sec-ch-width"><span class="secno">2.1</span> <span class="content">The <code>Sec-CH-Width</code> Header Field</span></a>
      <li><a href="#sec-ch-viewport-width"><span class="secno">2.2</span> <span class="content">The <code>Sec-CH-Viewport-Width</code> Header Field</span></a>
      <li><a href="#sec-ch-viewport-height"><span class="secno">2.3</span> <span class="content">The <code>Sec-CH-Viewport-Height</code> Header Field</span></a>
      <li><a href="#sec-ch-dpr"><span class="secno">2.4</span> <span class="content">The <code>Sec-CH-DPR</code> Header Field</span></a>
      <li><a href="#fetch-integration"><span class="secno">2.5</span> <span class="content">Integration with Fetch</span></a>
     </ol>
    <li>
     <a href="#security-privacy"><span class="secno">3</span> <span class="content">Security and Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#secure-transport"><span class="secno">3.1</span> <span class="content">Secure Transport</span></a>
      <li><a href="#delegation"><span class="secno">3.2</span> <span class="content">Delegation</span></a>
      <li><a href="#access-and-accuracy"><span class="secno">3.3</span> <span class="content">Access and Accuracy Restrictions</span></a>
     </ol>
    <li><a href="#processing"><span class="secno">4</span> <span class="content">Interface and Processing model</span></a>
    <li>
     <a href="#impl-considerations"><span class="secno">5</span> <span class="content">Implementation Considerations</span></a>
     <ol class="toc">
      <li><a href="#sec-ch-prefix"><span class="secno">5.1</span> <span class="content">The Sec-CH prefix</span></a>
     </ol>
    <li>
     <a href="#iana-considerations"><span class="secno">6</span> <span class="content">IANA Considerations</span></a>
     <ol class="toc">
      <li><a href="#iana-width"><span class="secno">6.1</span> <span class="content"><code>Sec-CH-Width</code> Header Field</span></a>
      <li><a href="#iana-viewport-width"><span class="secno">6.2</span> <span class="content"><code>Sec-CH-Viewport-Width</code> Header Field</span></a>
      <li><a href="#iana-dpr"><span class="secno">6.3</span> <span class="content"><code>Sec-CH-DPR</code> Header Field</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>Existing solutions for the <a href="https://usecases.responsiveimages.org#use-cases">responsive image use cases</a> rely on a suite of markup (<code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-picture-element" id="ref-for-the-picture-element">picture</a></code> and <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset" id="ref-for-attr-img-srcset">srcset</a></code>) which allows authors and browsers to decide how images on the web should adapt to varying contexts, so that different users receive different resources, tailored to their particular context.</p>
   <p>Authors know the most about the page which an image is appearing; user agents know the most about the end user’s current context and preferences. Servers, however, often know the most about the <em>available resources</em>, and are well-situated to make good decisions in more-scalable, easier-to-implement-and-maintain ways, via <a href="https://httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html#rfc.section.7.4.1">proactive content negotiation</a>. Servers require a bit of extra information about the page and user, though, in order to make those decisions; that information may be delivered in a secure, privacy-preserving way via these <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#" id="ref-for-something">client hints</a>.</p>
   <p>By moving this decision-making to the server, we:</p>
   <ul>
    <li>
     de-couple responsive image decision making from markup. This: 
     <ul>
      <li>makes markup much easier to author and maintain.
      <li>allows the responsive image decision making to evolve more easily over time.
     </ul>
    <li>
     move responsive image decision making to the place where the resources live. This: 
     <ul>
      <li>allows responsive image decision making to be informed by image content.
      <li>allows resource generation to be informed by incoming requests.
     </ul>
   </ul>
   <div class="example" id="example-0d58c519">
    <a class="self-link" href="#example-0d58c519"></a> ShoeShoppe.biz wants to send responsive hero images on their product pages. With the responsive image client hints, they author markup like this: 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>img</c->
  <c- e>src</c-><c- o>=</c-><c- s>"https://media.shoeshoppe.biz/cool-shoe-hero.jpg"</c->
  <c- e>sizes</c-><c- o>=</c-><c- s>"(min-width: 800px) 800px, 100vw"</c->
  <c- e>alt</c-><c- o>=</c-><c- s>"A cool shoe"</c->
<c- p>/></c->
</pre>
    <p>...and send the following <a data-link-type="http-header" href="https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#section-3.1" id="ref-for-section-3.1">Accept-CH</a> and <a data-link-type="http-header" href="https://w3c.github.io/webappsec-permissions-policy/#permissions-policy-header" id="ref-for-permissions-policy-header">Permissions-Policy</a> response headers along with their root HTML document:</p>
<pre>Accept-CH: CH-DPR, CH-Width
Permissions-Policy: ch-dpr=(self "https://media.shoeshoppe.biz"), ch-width=(self "https://media.shoeshoppe.biz")
</pre>
    <p>A user agent running on a 3x device, with a 400-px-wide viewport, then sends the following headers along with the image request:</p>
<pre>GET https://media.shoeshoppe.biz/cool-shoe-hero.jpg
Sec-CH-Width: 1200
Sec-CH-DPR: 3
</pre>
    <p><code>media.shoeshoppe.biz</code> might note that <code>cool-shoe-hero.jpg</code> contains photographic content, and that the apparent-quality benefits of sending a full-3x, 1200-pixel-wide version won’t outweigh the cost in increased filesize. So it sends an 800-pixel-wide, 2x response instead, and <a href="https://github.com/whatwg/html/pull/5574">modifies the response resource’s EXIF resolution</a> in order to ensure that resulting <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element" id="ref-for-the-img-element">img</a></code> has the expected <a data-link-type="dfn">density-corrected intrinsic width</a> of 400px.</p>
   </div>
   <h2 class="heading settled" data-level="2" id="responsive-image-hints"><span class="secno">2. </span><span class="content">Responsive Image Hints</span><a class="self-link" href="#responsive-image-hints"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="sec-ch-width"><span class="secno">2.1. </span><span class="content">The <code>Sec-CH-Width</code> Header Field</span><a class="self-link" href="#sec-ch-width"></a></h3>
   <p>The <code><dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-ch-width">Sec-CH-Width</dfn></code> request header field gives a server the layout width of the image, <em>in device pixels</em> (or printed dots). It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#" id="ref-for-something①">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1" id="ref-for-section-3.3.1">integer</a> greater than or equal to 0.</p>
   <p>If the value is zero, it indicates that the image will not be displayed.</p>
   <p>For <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch">fetches</a> trigged by <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element" id="ref-for-the-img-element①">img</a></code> elements, its value SHOULD be calculated by multiplying the <a href="https://html.spec.whatwg.org/multipage/images.html#source-set">source set</a>’s current <a href="https://html.spec.whatwg.org/multipage/images.html#source-size-2">source size</a> by the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window">Window</a></code>'s current <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio" id="ref-for-dom-window-devicepixelratio">devicePixelRatio</a></code>.</p>
   <div class="example" id="example-65c910bb">
    <a class="self-link" href="#example-65c910bb"></a> Given: 
    <ol>
     <li>
      this markup: 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>img</c-> <c- e>src</c-><c- o>=</c-><c- s>"a.jpg"</c-> <c- e>sizes</c-><c- o>=</c-><c- s>"33vw"</c-><c- p>></c->
</pre>
     <li>a 1000-<a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-values-4/#px" id="ref-for-px">px</a>-wide viewport, and 
     <li>a <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio" id="ref-for-dom-window-devicepixelratio①">devicePixelRatio</a></code> of 2, 
    </ol>
    <p>...a user agent calculates the <code><a data-link-type="http-header" href="#http-headerdef-sec-ch-width" id="ref-for-http-headerdef-sec-ch-width">Sec-CH-Width</a></code> value to be the <a href="https://html.spec.whatwg.org/multipage/images.html#source-size-2">source size</a> (<code>33vw</code>, which in this context equals <code>330px</code>) * the <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio" id="ref-for-dom-window-devicepixelratio②">devicePixelRatio</a></code> (<code>2</code>), and attaches the following header to the request for <code>a.jpg</code>:</p>
<pre>Sec-CH-Width: 660
</pre>
   </div>
   <p class="note" role="note"><span class="marker">Note:</span> do we need to talk about fetches initiated by CSS (probably)? Other sorts of fetches?</p>
   <div class="note" role="note">
     Note: An older version of this hint gave the layout width in CSS <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-values-4/#px" id="ref-for-px①">px</a>. However, to improve cache reusability, <a href="https://github.com/igrigorik/http-client-hints/pull/61">the definition was changed to device pixels</a>. As long as the resources only <code>Vary: Sec-CH-Width</code>, this, for instance, allows the same 1000-pixel-wide cached resource to satisfy both 500px@2x and 1000px@1x requests, as both get <code>Sec-CH-Width: 1000</code> in their cache key. 
    <p>If servers want to know the layout width of the image in CSS <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-values-4/#px" id="ref-for-px②">px</a>, they need both the <a data-link-type="http-header" href="#http-headerdef-sec-ch-width" id="ref-for-http-headerdef-sec-ch-width①">Sec-CH-Width</a> and <a data-link-type="http-header" href="#http-headerdef-sec-ch-dpr" id="ref-for-http-headerdef-sec-ch-dpr">Sec-CH-DPR</a> hints: the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element" id="ref-for-the-img-element②">img</a></code>'s <a class="idl-code" data-link-type="attribute" href="https://drafts.csswg.org/cssom-view-1/#dom-element-clientwidth" id="ref-for-dom-element-clientwidth">clientWidth</a> is equal to the value of <a data-link-type="http-header" href="#http-headerdef-sec-ch-width" id="ref-for-http-headerdef-sec-ch-width②">Sec-CH-Width</a> divided by the value of <a data-link-type="http-header" href="#http-headerdef-sec-ch-dpr" id="ref-for-http-headerdef-sec-ch-dpr①">Sec-CH-DPR</a>.</p>
   </div>
   <p class="note" role="note"><span class="marker">Note:</span> does this get sent when there’s no <code>sizes</code>?</p>
   <h3 class="heading settled" data-level="2.2" id="sec-ch-viewport-width"><span class="secno">2.2. </span><span class="content">The <code>Sec-CH-Viewport-Width</code> Header Field</span><a class="self-link" href="#sec-ch-viewport-width"></a></h3>
   <p>The <code><dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-ch-viewport-width">Sec-CH-Viewport-Width</dfn></code> request header field gives a server information about the user-agent’s current <a href="https://www.w3.org/TR/CSS2/visuren.html#viewport">viewport</a> width. It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#" id="ref-for-something②">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1" id="ref-for-section-3.3.1①">integer</a> greater than or equal to 0.</p>
   <p>If the value is zero, it indicates that there is no <a href="https://www.w3.org/TR/CSS2/visuren.html#viewport">viewport</a>.</p>
   <p>For <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch①">fetches</a> within web contexts, its value SHOULD be the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window①">Window</a></code>'s current <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-innerwidth" id="ref-for-dom-window-innerwidth">innerWidth</a></code>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> window.innerWidth includes scrollbar width. Do we want to use the width of the initial containing block (minus any scrollbar width); gettable with <code> document.documentElement.clientWidth</code>), instead?</p>
   <div class="example" id="example-7547b197">
    <a class="self-link" href="#example-7547b197"></a> 
    <p>Given:</p>
    <ol>
     <li>
      this markup: 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>img</c-> <c- e>src</c-><c- o>=</c-><c- s>"a.jpg"</c-><c- p>></c->
</pre>
     <li>and a <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-innerwidth" id="ref-for-dom-window-innerwidth①">innerWidth</a></code> of 1000, 
    </ol>
    <p>...a user agent attaches the following header to the request for <code>a.jpg</code>:</p>
<pre>Sec-CH-Viewport-Width: 1000
</pre>
    <p>In the absence of any other client hints, the server does the best it can and sends back a 1000-pixel-wide response.</p>
   </div>
   <h3 class="heading settled" data-level="2.3" id="sec-ch-viewport-height"><span class="secno">2.3. </span><span class="content">The <code>Sec-CH-Viewport-Height</code> Header Field</span><a class="self-link" href="#sec-ch-viewport-height"></a></h3>
   <p>The <code><dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-ch-viewport-height">Sec-CH-Viewport-Height</dfn></code> request header field gives a server information about the user-agent’s current <a href="https://www.w3.org/TR/CSS2/visuren.html#viewport">viewport</a> height. It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#" id="ref-for-something③">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1" id="ref-for-section-3.3.1②">integer</a> greater than or equal to 0.</p>
   <p>If the value is zero, it indicates that there is no <a href="https://www.w3.org/TR/CSS2/visuren.html#viewport">viewport</a>.</p>
   <p>For <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch②">fetches</a> within web contexts, its value SHOULD be the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window②">Window</a></code>'s current <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-innerheight" id="ref-for-dom-window-innerheight">innerHeight</a></code>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> window.innerHeight includes horizontal scrollbar width. Do we want to use the height of the initial containing block (minus any scrollbar height); gettable with <code> document.documentElement.clientHeight</code>), instead?</p>
   <div class="example" id="example-1423b456">
    <a class="self-link" href="#example-1423b456"></a> 
    <p>Given:</p>
    <ol>
     <li>
      this markup: 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>img</c-> <c- e>src</c-><c- o>=</c-><c- s>"a.jpg"</c-><c- p>></c->
</pre>
     <li>and a <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-innerheight" id="ref-for-dom-window-innerheight①">innerHeight</a></code> of 1000, 
    </ol>
    <p>...a user agent attaches the following header to the request for <code>a.jpg</code>:</p>
<pre>Sec-CH-Viewport-Height: 1000
</pre>
    <p>In the absence of any other client hints, the server does the best it can and sends back an image optimized for a 1000-pixel-tall viewport.</p>
   </div>
   <h3 class="heading settled" data-level="2.4" id="sec-ch-dpr"><span class="secno">2.4. </span><span class="content">The <code>Sec-CH-DPR</code> Header Field</span><a class="self-link" href="#sec-ch-dpr"></a></h3>
   <p>The <code><dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-ch-dpr">Sec-CH-DPR</dfn></code> request header field gives a server information about the user-agent’s current device pixel ratio. It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#" id="ref-for-something④">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.2" id="ref-for-section-3.3.2">decimal</a> greater than 0.</p>
   <p>For <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch③">fetches</a> within web contexts, its value SHOULD be the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window③">Window</a></code>'s current <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio" id="ref-for-dom-window-devicepixelratio③">devicePixelRatio</a></code>.</p>
   <p>Servers that send resources in response to requests including <a data-link-type="http-header" href="#http-headerdef-sec-ch-dpr" id="ref-for-http-headerdef-sec-ch-dpr②">Sec-CH-DPR</a> SHOULD <a href="https://github.com/whatwg/html/pull/5574">adjust those resource’s intrinsic resolutions via metadata</a> to ensure that, even as the resolution of the width is changing, its <a data-link-type="dfn">density-corrected intrinsic width</a> does not.</p>
   <div class="example" id="example-343f2449">
    <a class="self-link" href="#example-343f2449"></a> 
    <p>Given:</p>
    <ol>
     <li>
      this markup: 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>img</c-> <c- e>src</c-><c- o>=</c-><c- s>"a.jpg"</c-><c- p>></c->
</pre>
     <li>and a <code class="idl"><a data-link-type="idl" href="https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio" id="ref-for-dom-window-devicepixelratio④">devicePixelRatio</a></code> of 2, 
    </ol>
    <p>...a user agent attaches the following header to the request for <code>a.jpg</code>:</p>
<pre>Sec-CH-DPR: 2
</pre>
    <p>The default (1x) version of a.jpg is 800x600. The server sees the <code>Sec-CH-DPR</code> header and sends a 2x, 1600x1200 response. It tells the user agent to treat the returned resource as 2x by ensuring that it contains the following EXIF metadata, before the image data:</p>
<pre>XResolution: 144
XResolutionUnit: Inch
PixelXDimensions: 800
PixelYDimensions: 600
</pre>
    <p>And it sends the following <code>Vary</code> header along with the response, so that <a data-link-type="http-header" href="#http-headerdef-sec-ch-dpr" id="ref-for-http-headerdef-sec-ch-dpr③">Sec-CH-DPR</a> header field is added to the cache key:</p>
<pre>Vary: DPR
</pre>
   </div>
   <h3 class="heading settled" data-level="2.5" id="fetch-integration"><span class="secno">2.5. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#fetch-integration"></a></h3>
   <p>This specification’s <a data-link-type="abstract-op" href="https://wicg.github.io/client-hints-infrastructure/#fetch" id="ref-for-fetch">integration with Fetch</a> is defined as part of the <a data-link-type="biblio" href="#biblio-client-hints-infrastructure" title="Client Hints Infrastructure">[client-hints-infrastructure]</a> specification.</p>
   <h2 class="heading settled" data-level="3" id="security-privacy"><span class="secno">3. </span><span class="content">Security and Privacy Considerations</span><a class="self-link" href="#security-privacy"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="secure-transport"><span class="secno">3.1. </span><span class="content">Secure Transport</span><a class="self-link" href="#secure-transport"></a></h3>
   <p>Client Hints will not be delivered to non-secure endpoints (see the secure transport requirements in Section 2.2.1 of <a data-link-type="biblio" href="#biblio-i-dietf-httpbis-client-hints" title="HTTP Client Hints">[I-D.ietf-httpbis-client-hints]</a>). This means that information about the user’s device pixel ratio and viewport size will not be leaked over plaintext channels, reducing the opportunity for network attackers to build a profile of a given agent’s behavior over time.</p>
   <h3 class="heading settled" data-level="3.2" id="delegation"><span class="secno">3.2. </span><span class="content">Delegation</span><a class="self-link" href="#delegation"></a></h3>
   <p>Client Hints will be delegated from top-level pages via Permissions Policy. This reduces the potential for <a data-link-type="dfn" href="https://www.w3.org/TR/fingerprinting-guidance/#dfn-passive-fingerprinting" id="ref-for-dfn-passive-fingerprinting">passive fingerprinting</a> by:</p>
   <ol>
    <li data-md>
     <p>Sending fewer hints to third parties.</p>
    <li data-md>
     <p>Never doing so indiscriminately. Information can only be revealed to third parties after the root page author explicitly asks it to be revealed to them.</p>
    <li data-md>
     <p>Ensuring that everyone (users, user agents, privacy advocates...) can see who is getting what information.</p>
   </ol>
   <p>That delegation is defined as part of <a data-link-type="abstract-op" href="https://wicg.github.io/client-hints-infrastructure/#abstract-opdef-append-client-hints-to-request" id="ref-for-abstract-opdef-append-client-hints-to-request">append client hints to request</a>.</p>
   <h3 class="heading settled" data-level="3.3" id="access-and-accuracy"><span class="secno">3.3. </span><span class="content">Access and Accuracy Restrictions</span><a class="self-link" href="#access-and-accuracy"></a></h3>
   <p>The information in the Client Hints defined above reveals extra information about the user’s context. User agents ought to exercise judgement before granting access to this information, and MAY impose restrictions above and beyond the secure transport and delegation requirements noted above. For instance, screen readers may choose not to indicate that they have no viewport, to ensure that their users are not <a href="https://tink.uk/thoughts-on-screen-reader-detection/">served separate content</a>. Similarly, user agents might offer users control over when hints are revealed to servers, gating them based on privacy modes or settings.</p>
   <p>User agents may also choose to reduce the accuracy of these values, by rounding to reduce variation between users, and/or adding jitter to increase variation for a single user.</p>
   <p>Servers MUST NOT require any of these hints in order to deliver content, and MUST NOT depend on pixel-accurate values in order to deliver acceptable experiences.</p>
   <h2 class="heading settled" data-level="4" id="processing"><span class="secno">4. </span><span class="content">Interface and Processing model</span><a class="self-link" href="#processing"></a></h2>
   <p class="issue" id="issue-d481809c"><a class="self-link" href="#issue-d481809c"></a> TODO!? Or do the "in web contexts" notes above, cover this? Do we need an IDL interface? Related - do I need ABNFs, or are the simple structured header types enough?</p>
   <h2 class="heading settled" data-level="5" id="impl-considerations"><span class="secno">5. </span><span class="content">Implementation Considerations</span><a class="self-link" href="#impl-considerations"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="sec-ch-prefix"><span class="secno">5.1. </span><span class="content">The Sec-CH prefix</span><a class="self-link" href="#sec-ch-prefix"></a></h3>
   <p class="issue" id="issue-8e5d3dd1"><a class="self-link" href="#issue-8e5d3dd1"></a> TODO (start with https://github.com/WICG/ua-client-hints/blob/master/index.bs#L282 or https://github.com/WICG/ua-client-hints/blob/master/index.bs#L554)</p>
   <h2 class="heading settled" data-level="6" id="iana-considerations"><span class="secno">6. </span><span class="content">IANA Considerations</span><a class="self-link" href="#iana-considerations"></a></h2>
   <p>This document intends to define the <code>Sec-CH-Width</code>, <code>Sec-CH-Viewport-Width</code>, and <code>Sec-CH-DPR</code> HTTP request header fields, and register them in the permanent message header field registry (<a data-link-type="biblio" href="#biblio-rfc3864" title="Registration Procedures for Message Header Fields">[RFC3864]</a>).</p>
   <h3 class="heading settled" data-level="6.1" id="iana-width"><span class="secno">6.1. </span><span class="content"><code>Sec-CH-Width</code> Header Field</span><a class="self-link" href="#iana-width"></a></h3>
   <p>Header field name: Sec-CH-Width</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-ch-width">§ 2.1 The Sec-CH-Width Header Field</a>)</p>
   <h3 class="heading settled" data-level="6.2" id="iana-viewport-width"><span class="secno">6.2. </span><span class="content"><code>Sec-CH-Viewport-Width</code> Header Field</span><a class="self-link" href="#iana-viewport-width"></a></h3>
   <p>Header field name: Sec-CH-Viewport-Width</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-ch-viewport-width">§ 2.2 The Sec-CH-Viewport-Width Header Field</a>)</p>
   <h3 class="heading settled" data-level="6.3" id="iana-dpr"><span class="secno">6.3. </span><span class="content"><code>Sec-CH-DPR</code> Header Field</span><a class="self-link" href="#iana-dpr"></a></h3>
   <p>Header field name: Sec-CH-DPR</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-ch-dpr">§ 2.4 The Sec-CH-DPR Header Field</a>)</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#http-headerdef-sec-ch-dpr">Sec-CH-DPR</a><span>, in § 2.4</span>
   <li><a href="#http-headerdef-sec-ch-viewport-height">Sec-CH-Viewport-Height</a><span>, in § 2.3</span>
   <li><a href="#http-headerdef-sec-ch-viewport-width">Sec-CH-Viewport-Width</a><span>, in § 2.2</span>
   <li><a href="#http-headerdef-sec-ch-width">Sec-CH-Width</a><span>, in § 2.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CLIENT-HINTS-INFRASTRUCTURE]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="6360ebfe">append client hints to request</span>
     <li><span class="dfn-paneled" id="bb83ce28">integration with Fetch</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-VALUES-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9ddea951">px</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSSOM-VIEW-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="04dca76c">clientWidth</span>
     <li><span class="dfn-paneled" id="c0159396">devicePixelRatio</span>
     <li><span class="dfn-paneled" id="fbaa3c26">innerHeight</span>
     <li><span class="dfn-paneled" id="4ae8a70a">innerWidth</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a33db89a">fetch</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FINGERPRINTING-GUIDANCE]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="64452633">passive fingerprinting</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="f0811ff8">img</span>
     <li><span class="dfn-paneled" id="29399d44">picture</span>
     <li><span class="dfn-paneled" id="c219fdf4">srcset</span>
    </ul>
   <li>
    <a data-link-type="biblio">[I-D.ietf-httpbis-client-hints]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="71da2fe7">Accept-CH</span>
     <li><span class="dfn-paneled" id="fd0770bc">client hints</span>
    </ul>
   <li>
    <a data-link-type="biblio">[I-D.ietf-httpbis-header-structure]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8cec60e9">decimal</span>
     <li><span class="dfn-paneled" id="089b1354">integer</span>
     <li><span class="dfn-paneled" id="455b8b09">structured header</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="0e3ba2bf">Permissions-Policy</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-client-hints-infrastructure">[CLIENT-HINTS-INFRASTRUCTURE]
   <dd>Yoav Weiss. <a href="https://wicg.github.io/client-hints-infrastructure/"><cite>Client Hints Infrastructure</cite></a>. CG-DRAFT. URL: <a href="https://wicg.github.io/client-hints-infrastructure/">https://wicg.github.io/client-hints-infrastructure/</a>
   <dt id="biblio-cssom-view-1">[CSSOM-VIEW-1]
   <dd>Simon Pieters. <a href="https://drafts.csswg.org/cssom-view/"><cite>CSSOM View Module</cite></a>. URL: <a href="https://drafts.csswg.org/cssom-view/">https://drafts.csswg.org/cssom-view/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-fingerprinting-guidance">[FINGERPRINTING-GUIDANCE]
   <dd>Nick Doty. <a href="https://w3c.github.io/fingerprinting-guidance/"><cite>Mitigating Browser Fingerprinting in Web Specifications</cite></a>. URL: <a href="https://w3c.github.io/fingerprinting-guidance/">https://w3c.github.io/fingerprinting-guidance/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-i-dietf-httpbis-client-hints">[I-D.ietf-httpbis-client-hints]
   <dd>Ilya Grigorik. <a href="https://tools.ietf.org/html/draft-ietf-httpbis-client-hints"><cite>HTTP Client Hints</cite></a>. ID. URL: <a href="https://tools.ietf.org/html/draft-ietf-httpbis-client-hints">https://tools.ietf.org/html/draft-ietf-httpbis-client-hints</a>
   <dt id="biblio-i-dietf-httpbis-header-structure">[I-D.ietf-httpbis-header-structure]
   <dd>Mark Nottingham; Poul-Henning Kamp. <a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure"><cite>Structured Headers for HTTP</cite></a>. ID. URL: <a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure">https://tools.ietf.org/html/draft-ietf-httpbis-header-structure</a>
   <dt id="biblio-respimg-usecases">[RESPIMG-USECASES]
   <dd>Marcos Caceres; et al. <a href="https://usecases.responsiveimages.org"><cite>Use Cases and Requirements for Standardizing Responsive Images</cite></a>. URL: <a href="https://usecases.responsiveimages.org">https://usecases.responsiveimages.org</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-css-values-4">[CSS-VALUES-4]
   <dd>Tab Atkins Jr.; Elika Etemad. <a href="https://drafts.csswg.org/css-values-4/"><cite>CSS Values and Units Module Level 4</cite></a>. URL: <a href="https://drafts.csswg.org/css-values-4/">https://drafts.csswg.org/css-values-4/</a>
   <dt id="biblio-permissions-policy-1">[PERMISSIONS-POLICY-1]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc3864">[RFC3864]
   <dd>G. Klyne; M. Nottingham; J. Mogul. <a href="https://www.rfc-editor.org/rfc/rfc3864"><cite>Registration Procedures for Message Header Fields</cite></a>. September 2004. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc3864">https://www.rfc-editor.org/rfc/rfc3864</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> TODO!? Or do the "in web contexts" notes above, cover this? Do we need an IDL interface? Related - do I need ABNFs, or are the simple structured header types enough? <a class="issue-return" href="#issue-d481809c" title="Jump to section">↵</a></div>
   <div class="issue"> TODO (start with https://github.com/WICG/ua-client-hints/blob/master/index.bs#L282 or https://github.com/WICG/ua-client-hints/blob/master/index.bs#L554) <a class="issue-return" href="#issue-8e5d3dd1" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"04dca76c": {"dfnID":"04dca76c","dfnText":"clientWidth","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-element-clientwidth"}],"title":"2.1. The Sec-CH-Width Header Field"}],"url":"https://drafts.csswg.org/cssom-view-1/#dom-element-clientwidth"},
"089b1354": {"dfnID":"089b1354","dfnText":"integer","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.3.1"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-section-3.3.1\u2460"}],"title":"2.2. The Sec-CH-Viewport-Width Header Field"},{"refs":[{"id":"ref-for-section-3.3.1\u2461"}],"title":"2.3. The Sec-CH-Viewport-Height Header Field"}],"url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1"},
"0e3ba2bf": {"dfnID":"0e3ba2bf","dfnText":"Permissions-Policy","external":true,"refSections":[{"refs":[{"id":"ref-for-permissions-policy-header"}],"title":"1. Introduction"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#permissions-policy-header"},
"29399d44": {"dfnID":"29399d44","dfnText":"picture","external":true,"refSections":[{"refs":[{"id":"ref-for-the-picture-element"}],"title":"1. Introduction"}],"url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-picture-element"},
"455b8b09": {"dfnID":"455b8b09","dfnText":"structured header","external":true,"refSections":[{"refs":[{"id":"ref-for-something\u2460"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-something\u2461"}],"title":"2.2. The Sec-CH-Viewport-Width Header Field"},{"refs":[{"id":"ref-for-something\u2462"}],"title":"2.3. The Sec-CH-Viewport-Height Header Field"},{"refs":[{"id":"ref-for-something\u2463"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#"},
"4ae8a70a": {"dfnID":"4ae8a70a","dfnText":"innerWidth","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-window-innerwidth"},{"id":"ref-for-dom-window-innerwidth\u2460"}],"title":"2.2. The Sec-CH-Viewport-Width Header Field"}],"url":"https://drafts.csswg.org/cssom-view-1/#dom-window-innerwidth"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-window\u2460"}],"title":"2.2. The Sec-CH-Viewport-Width Header Field"},{"refs":[{"id":"ref-for-window\u2461"}],"title":"2.3. The Sec-CH-Viewport-Height Header Field"},{"refs":[{"id":"ref-for-window\u2462"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"6360ebfe": {"dfnID":"6360ebfe","dfnText":"append client hints to request","external":true,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-append-client-hints-to-request"}],"title":"3.2. Delegation"}],"url":"https://wicg.github.io/client-hints-infrastructure/#abstract-opdef-append-client-hints-to-request"},
"64452633": {"dfnID":"64452633","dfnText":"passive fingerprinting","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-passive-fingerprinting"}],"title":"3.2. Delegation"}],"url":"https://www.w3.org/TR/fingerprinting-guidance/#dfn-passive-fingerprinting"},
"71da2fe7": {"dfnID":"71da2fe7","dfnText":"Accept-CH","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.1"}],"title":"1. Introduction"}],"url":"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#section-3.1"},
"8cec60e9": {"dfnID":"8cec60e9","dfnText":"decimal","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.3.2"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.2"},
"9ddea951": {"dfnID":"9ddea951","dfnText":"px","external":true,"refSections":[{"refs":[{"id":"ref-for-px"},{"id":"ref-for-px\u2460"},{"id":"ref-for-px\u2461"}],"title":"2.1. The Sec-CH-Width Header Field"}],"url":"https://drafts.csswg.org/css-values-4/#px"},
"a33db89a": {"dfnID":"a33db89a","dfnText":"fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-fetch"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-concept-fetch\u2460"}],"title":"2.2. The Sec-CH-Viewport-Width Header Field"},{"refs":[{"id":"ref-for-concept-fetch\u2461"}],"title":"2.3. The Sec-CH-Viewport-Height Header Field"},{"refs":[{"id":"ref-for-concept-fetch\u2462"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"bb83ce28": {"dfnID":"bb83ce28","dfnText":"integration with Fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-fetch"}],"title":"2.5. Integration with Fetch"}],"url":"https://wicg.github.io/client-hints-infrastructure/#fetch"},
"c0159396": {"dfnID":"c0159396","dfnText":"devicePixelRatio","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-window-devicepixelratio"},{"id":"ref-for-dom-window-devicepixelratio\u2460"},{"id":"ref-for-dom-window-devicepixelratio\u2461"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-dom-window-devicepixelratio\u2462"},{"id":"ref-for-dom-window-devicepixelratio\u2463"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio"},
"c219fdf4": {"dfnID":"c219fdf4","dfnText":"srcset","external":true,"refSections":[{"refs":[{"id":"ref-for-attr-img-srcset"}],"title":"1. Introduction"}],"url":"https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset"},
"f0811ff8": {"dfnID":"f0811ff8","dfnText":"img","external":true,"refSections":[{"refs":[{"id":"ref-for-the-img-element"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-the-img-element\u2460"},{"id":"ref-for-the-img-element\u2461"}],"title":"2.1. The Sec-CH-Width Header Field"}],"url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element"},
"fbaa3c26": {"dfnID":"fbaa3c26","dfnText":"innerHeight","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-window-innerheight"},{"id":"ref-for-dom-window-innerheight\u2460"}],"title":"2.3. The Sec-CH-Viewport-Height Header Field"}],"url":"https://drafts.csswg.org/cssom-view-1/#dom-window-innerheight"},
"fd0770bc": {"dfnID":"fd0770bc","dfnText":"client hints","external":true,"refSections":[{"refs":[{"id":"ref-for-something"}],"title":"1. Introduction"}],"url":"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#"},
"http-headerdef-sec-ch-dpr": {"dfnID":"http-headerdef-sec-ch-dpr","dfnText":"Sec-CH-DPR","external":false,"refSections":[{"refs":[{"id":"ref-for-http-headerdef-sec-ch-dpr"},{"id":"ref-for-http-headerdef-sec-ch-dpr\u2460"}],"title":"2.1. The Sec-CH-Width Header Field"},{"refs":[{"id":"ref-for-http-headerdef-sec-ch-dpr\u2461"},{"id":"ref-for-http-headerdef-sec-ch-dpr\u2462"}],"title":"2.4. The Sec-CH-DPR Header Field"}],"url":"#http-headerdef-sec-ch-dpr"},
"http-headerdef-sec-ch-viewport-height": {"dfnID":"http-headerdef-sec-ch-viewport-height","dfnText":"Sec-CH-Viewport-Height","external":false,"refSections":[],"url":"#http-headerdef-sec-ch-viewport-height"},
"http-headerdef-sec-ch-viewport-width": {"dfnID":"http-headerdef-sec-ch-viewport-width","dfnText":"Sec-CH-Viewport-Width","external":false,"refSections":[],"url":"#http-headerdef-sec-ch-viewport-width"},
"http-headerdef-sec-ch-width": {"dfnID":"http-headerdef-sec-ch-width","dfnText":"Sec-CH-Width","external":false,"refSections":[{"refs":[{"id":"ref-for-http-headerdef-sec-ch-width"},{"id":"ref-for-http-headerdef-sec-ch-width\u2460"},{"id":"ref-for-http-headerdef-sec-ch-width\u2461"}],"title":"2.1. The Sec-CH-Width Header Field"}],"url":"#http-headerdef-sec-ch-width"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#http-headerdef-sec-ch-dpr": {"displayText":"sec-ch-dpr","export":true,"for_":[],"level":"1","normative":true,"shortname":"respimg-ch","spec":"respimg-ch-1","status":"local","text":"sec-ch-dpr","type":"http-header","url":"#http-headerdef-sec-ch-dpr"},
"#http-headerdef-sec-ch-width": {"displayText":"sec-ch-width","export":true,"for_":[],"level":"1","normative":true,"shortname":"respimg-ch","spec":"respimg-ch-1","status":"local","text":"sec-ch-width","type":"http-header","url":"#http-headerdef-sec-ch-width"},
"https://drafts.csswg.org/css-values-4/#px": {"displayText":"px","export":true,"for_":["<length>"],"level":"4","normative":true,"shortname":"css-values","spec":"css-values-4","status":"current","text":"px","type":"value","url":"https://drafts.csswg.org/css-values-4/#px"},
"https://drafts.csswg.org/cssom-view-1/#dom-element-clientwidth": {"displayText":"clientWidth","export":true,"for_":["Element"],"level":"1","normative":true,"shortname":"cssom-view","spec":"cssom-view-1","status":"current","text":"clientWidth","type":"attribute","url":"https://drafts.csswg.org/cssom-view-1/#dom-element-clientwidth"},
"https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio": {"displayText":"devicePixelRatio","export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"cssom-view","spec":"cssom-view-1","status":"current","text":"devicePixelRatio","type":"attribute","url":"https://drafts.csswg.org/cssom-view-1/#dom-window-devicepixelratio"},
"https://drafts.csswg.org/cssom-view-1/#dom-window-innerheight": {"displayText":"innerHeight","export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"cssom-view","spec":"cssom-view-1","status":"current","text":"innerHeight","type":"attribute","url":"https://drafts.csswg.org/cssom-view-1/#dom-window-innerheight"},
"https://drafts.csswg.org/cssom-view-1/#dom-window-innerwidth": {"displayText":"innerWidth","export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"cssom-view","spec":"cssom-view-1","status":"current","text":"innerWidth","type":"attribute","url":"https://drafts.csswg.org/cssom-view-1/#dom-window-innerwidth"},
"https://fetch.spec.whatwg.org/#concept-fetch": {"displayText":"fetch","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset": {"displayText":"srcset","export":true,"for_":["img"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"srcset","type":"element-attr","url":"https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset"},
"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element": {"displayText":"img","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"img","type":"element","url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element"},
"https://html.spec.whatwg.org/multipage/embedded-content.html#the-picture-element": {"displayText":"picture","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"picture","type":"element","url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-picture-element"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"displayText":"Window","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#": {"displayText":"client hints","export":true,"for_":[],"level":"","normative":true,"shortname":"i-d.ietf-httpbis-client-hints","spec":"i-d.ietf-httpbis-client-hints","status":"anchor-block","text":"client hints","type":"dfn","url":"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#"},
"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#section-3.1": {"displayText":"Accept-CH","export":true,"for_":["client hints"],"level":"","normative":true,"shortname":"i-d.ietf-httpbis-client-hints","spec":"i-d.ietf-httpbis-client-hints","status":"anchor-block","text":"accept-ch","type":"http-header","url":"https://tools.ietf.org/html/draft-ietf-httpbis-client-hints#section-3.1"},
"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#": {"displayText":"structured header","export":true,"for_":[],"level":"","normative":true,"shortname":"i-d.ietf-httpbis-header-structure","spec":"i-d.ietf-httpbis-header-structure","status":"anchor-block","text":"structured header","type":"dfn","url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#"},
"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1": {"displayText":"integer","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"i-d.ietf-httpbis-header-structure","spec":"i-d.ietf-httpbis-header-structure","status":"anchor-block","text":"integer","type":"dfn","url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.1"},
"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.2": {"displayText":"decimal","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"i-d.ietf-httpbis-header-structure","spec":"i-d.ietf-httpbis-header-structure","status":"anchor-block","text":"decimal","type":"dfn","url":"https://tools.ietf.org/html/draft-ietf-httpbis-header-structure#section-3.3.2"},
"https://w3c.github.io/webappsec-permissions-policy/#permissions-policy-header": {"displayText":"Permissions-Policy","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"permissions-policy","type":"http-header","url":"https://w3c.github.io/webappsec-permissions-policy/#permissions-policy-header"},
"https://wicg.github.io/client-hints-infrastructure/#abstract-opdef-append-client-hints-to-request": {"displayText":"append client hints to request","export":true,"for_":["client-hints-infrastructure"],"level":"","normative":true,"shortname":"client-hints-infrastructure","spec":"client-hints-infrastructure","status":"anchor-block","text":"append client hints to request","type":"abstract-op","url":"https://wicg.github.io/client-hints-infrastructure/#abstract-opdef-append-client-hints-to-request"},
"https://wicg.github.io/client-hints-infrastructure/#fetch": {"displayText":"integration with Fetch","export":true,"for_":["client-hints-infrastructure"],"level":"","normative":true,"shortname":"client-hints-infrastructure","spec":"client-hints-infrastructure","status":"anchor-block","text":"integration with Fetch","type":"abstract-op","url":"https://wicg.github.io/client-hints-infrastructure/#fetch"},
"https://www.w3.org/TR/fingerprinting-guidance/#dfn-passive-fingerprinting": {"displayText":"passive fingerprinting","export":true,"for_":[],"level":"","normative":true,"shortname":"fingerprinting-guidance","spec":"fingerprinting-guidance","status":"anchor-block","text":"passive fingerprinting","type":"dfn","url":"https://www.w3.org/TR/fingerprinting-guidance/#dfn-passive-fingerprinting"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>