<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Idle Detection API</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/idle-detection/" rel="canonical">
  <link href="logo-idle.png" rel="icon">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
  table {
    border-collapse: collapse;
    border-left-style: hidden;
    border-right-style: hidden;
    text-align: left;
  }
  table td, table th {
    border: 1px solid black;
    padding: 3px;
  }
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-mdn-anno */
:root {
	--mdn-bg: #EEE;
	--mdn-shadow: #999;
	--mdn-nosupport-text: #ccc;
	--mdn-pass: green;
	--mdn-fail: red;
}
@media (prefers-color-scheme: dark) {
	:root {
		--mdn-bg: #222;
		--mdn-shadow: #444;
		--mdn-nosupport-text: #666;
		--mdn-pass: #690;
		--mdn-fail: #d22;
	}
}
.mdn-anno {
	background: var(--mdn-bg, #EEE);
	border-radius: .25em;
	box-shadow: 0 0 3px var(--mdn-shadow, #999);
	color: var(--text, black);
	font: 1em sans-serif;
	hyphens: none;
	max-width: min-content;
	overflow: hidden;
	padding: 0.2em;
	position: absolute;
	right: 0.3em;
	top: auto;
	white-space: nowrap;
	word-wrap: normal;
	z-index: 8;
}
.mdn-anno.unpositioned {
	display: none;
}
.mdn-anno.overlapping-main {
	opacity: .2;
	transition: opacity .1s;
}
.mdn-anno[open] {
	opacity: 1;
	z-index: 9;
	min-width: 9em;
}
.mdn-anno:hover {
	opacity: 1;
	outline: var(--text, black) 1px solid;
}
.mdn-anno > summary {
	font-weight: normal;
	text-align: right;
	cursor: pointer;
	display: block;
}
.mdn-anno > summary > .less-than-two-engines-flag {
	color: var(--mdn-fail);
	padding-right: 2px;
}
.mdn-anno > summary > .all-engines-flag {
	color: var(--mdn-pass);
	padding-right: 2px;
}
.mdn-anno > summary > span {
	color: #fff;
	background-color: #000;
	font-weight: normal;
	font-family: zillaslab, Palatino, "Palatino Linotype", serif;
	padding: 2px 3px 0px 3px;
	line-height: 1.3em;
	vertical-align: top;
}
.mdn-anno > .feature {
	margin-top: 20px;
}
.mdn-anno > .feature:not(:first-of-type) {
	border-top: 1px solid #999;
	margin-top: 6px;
	padding-top: 2px;
}
.mdn-anno > .feature > .less-than-two-engines-text {
	color: var(--mdn-fail);
}
.mdn-anno > .feature > .all-engines-text {
	color: var(--mdn-pass);
}
.mdn-anno > .feature > p {
	font-size: .75em;
	margin-top: 6px;
	margin-bottom: 0;
}
.mdn-anno > .feature > p + p {
	margin-top: 3px;
}
.mdn-anno > .feature > .support {
	display: block;
	font-size: 0.6em;
	margin: 0;
	padding: 0;
	margin-top: 2px;
}
.mdn-anno > .feature > .support + div {
	padding-top: 0.5em;
}
.mdn-anno > .feature > .support > hr {
	display: block;
	border: none;
	border-top: 1px dotted #999;
	padding: 3px 0px 0px 0px;
	margin: 2px 3px 0px 3px;
}
.mdn-anno > .feature > .support > hr::before {
	content: "";
}
.mdn-anno > .feature > .support > span {
	padding: 0.2em 0;
	display: block;
	display: table;
}
.mdn-anno > .feature > .support > span.no {
	color: var(--mdn-nosupport-text);
	filter: grayscale(100%);
}
.mdn-anno > .feature > .support > span.no::before {
	opacity: 0.5;
}
.mdn-anno > .feature > .support > span:first-of-type {
	padding-top: 0.5em;
}
.mdn-anno > .feature > .support > span > span {
	padding: 0 0.5em;
	display: table-cell;
}
.mdn-anno > .feature > .support > span > span:first-child {
	width: 100%;
}
.mdn-anno > .feature > .support > span > span:last-child {
	width: 100%;
	white-space: pre;
	padding: 0;
}
.mdn-anno > .feature > .support > span::before {
	content: ' ';
	display: table-cell;
	min-width: 1.5em;
	height: 1.5em;
	background: no-repeat center center;
	background-size: contain;
	text-align: right;
	font-size: 0.75em;
	font-weight: bold;
}
.mdn-anno > .feature > .support > .chrome_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
}
.mdn-anno > .feature > .support > .firefox_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
}
.mdn-anno > .feature > .support > .chrome::before {
	background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
}
.mdn-anno > .feature > .support > .edge_blink::before {
	background-image: url(https://resources.whatwg.org/browser-logos/edge.svg);
}
.mdn-anno > .feature > .support > .edge::before {
	background-image: url(https://resources.whatwg.org/browser-logos/edge_legacy.svg);
}
.mdn-anno > .feature > .support > .firefox::before {
	background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
}
.mdn-anno > .feature > .support > .ie::before {
	background-image: url(https://resources.whatwg.org/browser-logos/ie.png);
}
.mdn-anno > .feature > .support > .safari_ios::before {
	background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg);
}
.mdn-anno > .feature > .support > .nodejs::before {
	background-image: url(https://nodejs.org/static/images/favicons/favicon.ico);
}
.mdn-anno > .feature > .support > .opera_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
}
.mdn-anno > .feature > .support > .opera::before {
	background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
}
.mdn-anno > .feature > .support > .safari::before {
	background-image: url(https://resources.whatwg.org/browser-logos/safari.png);
}
.mdn-anno > .feature > .support > .samsunginternet_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/samsung.svg);
}
.mdn-anno > .feature > .support > .webview_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/android-webview.png);
}
.name-slug-mismatch {
	color: red;
}
.caniuse-status:hover {
	z-index: 9;
}
/* dt, li, .issue, .note, and .example are "position: relative", so to put annotation at right margin, must move to right of containing block */;
.h-entry:not(.status-LS) dt > .mdn-anno, .h-entry:not(.status-LS) li > .mdn-anno, .h-entry:not(.status-LS) .issue > .mdn-anno, .h-entry:not(.status-LS) .note > .mdn-anno, .h-entry:not(.status-LS) .example > .mdn-anno {
	right: -6.7em;
}
.h-entry p + .mdn-anno {
	margin-top: 0;
}
 h2 + .mdn-anno.after {
	margin: -48px 0 0 0;
}
 h3 + .mdn-anno.after {
	margin: -46px 0 0 0;
}
 h4 + .mdn-anno.after {
	margin: -42px 0 0 0;
}
 h5 + .mdn-anno.after {
	margin: -40px 0 0 0;
}
 h6 + .mdn-anno.after {
	margin: -40px 0 0 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
<style>/* Boilerplate: style-wpt */
:root {
    --wpt-border: hsl(0, 0%, 60%);
    --wpt-bg: hsl(0, 0%, 95%);
    --wpt-text: var(--text);
    --wptheading-text: hsl(0, 0%, 30%);
}
@media (prefers-color-scheme: dark) {
    :root {
        --wpt-border: hsl(0, 0%, 30%);
        --wpt-bg: var(--borderedblock-bg);
        --wpt-text: var(--text);
        --wptheading-text: hsl(0, 0%, 60%);
    }
}
.wpt-tests-block {
    list-style: none;
    border-left: .5em solid var(--wpt-border);
    background: var(--wpt-bg);
    color: var(--wpt-text);
    margin: 1em auto;
    padding: .5em;
}
.wpt-tests-block summary {
    color: var(--wptheading-text);
    font-weight: normal;
    text-transform: uppercase;
}
.wpt-tests-block summary::marker{
    color: var(--wpt-border);
}
.wpt-tests-block summary:hover::marker{
    color: var(--wpt-text);
}
/*
   The only content  of a wpt test block in its closed state is the <summary>,
   which contains the word TESTS,
   and that is absolutely positioned.
   In that closed state, wpt test blocks are styled
   to have a top margin whose height is exactly equal
   to the height of the absolutely positioned <summary>,
   and no other background/padding/margin/border.
   The wpt test block elements will therefore allow the maring
   of the previous/next block elements
   to collapse through them;
   if this combined margin would be larger than its own top margin,
   it stays as is,
   and therefore the pre-existing vertical rhythm of the document is undisturbed.
   If that combined margin would be smaller, it is grown to that size.
   This means that the wpt test block ensures
   that there's always enough vertical space to insert the summary,
   without adding more than is needed.
*/
.wpt-tests-block:not([open]){
    padding: 0;
    border: none;
    background: none;
    font-size: 0.75em;
    line-height: 1;
    position: relative;
    margin: 1em 0 0;
}
.wpt-tests-block:not([open]) summary {
    position: absolute;
    right: 0;
    bottom: 0;
}
/*
   It is possible that both the last child of a block element
   and the block element itself
   would be annotated with a <wpt> block each.
   If the block element has a padding or a border,
   that's fine, but otherwise
   the bottom margin of the block and of its last child would collapse
   and both <wpt> elements would overlap, being both placed there.
   To avoid that, add 1px of padding to the <wpt> element annotating the last child
   to prevent the bottom margin of the block and of its last child from collapsing
   (and as much negative margin,
   as wel only want to prevent margin collapsing,
   but are not trying to actually take more space).
*/
.wpt-tests-block:not([open]):last-child {
    padding-bottom: 1px;
    margin-bottom: -1px;
}
/*
   Exception to the previous rule:
   don't do that in non-last list items,
   because it's not necessary,
   and would therefore consume more space than strictly needed.
   Lists must have list items as children, not <wpt> elements,
   so a <wpt> element cannot be a sibling of a list item,
   and the collision that the previous rule avoids cannot happen.
*/
li:not(:last-child) > .wpt-tests-block:not([open]):last-child,
dd:not(:last-child) > .wpt-tests-block:not([open]):last-child {
    padding-bottom: 0;
    margin-bottom: 0;
}
.wpt-tests-block:not([open]):not(:hover){
    opacity: 0.5;
}
.wpt-tests-list {
    list-style: none;
    display: grid;
    margin: 0;
    padding: 0;
    grid-template-columns: 1fr max-content auto auto;
    grid-column-gap: .5em;
}
.wpt-tests-block hr:last-child {
    display: none;
}
.wpt-test {
    display: contents;
}
.wpt-test > a {
    text-decoration: underline;
    border: none;
}
.wpt-test > .wpt-name { grid-column: 1; }
.wpt-test > .wpt-results { grid-column: 2; }
.wpt-test > .wpt-live { grid-column: 3; }
.wpt-test > .wpt-source { grid-column: 4; }

.wpt-test > .wpt-results {
    display: flex;
    gap: .1em;
}
.wpt-test .wpt-result {
    display: inline-block;
    height: 1em;
    width: 1em;
    border-radius: 50%;
    position: relative;
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Idle Detection API</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/idle-detection/">https://wicg.github.io/idle-detection/</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard" data-editor-id="83788"><a class="p-name fn u-email email" href="mailto:reillyg@google.com">Reilly Grant</a> (<a class="p-org org" href="https://www.google.com">Google LLC</a>)
     <dt>Test Suite:
     <dd class="wpt-overview"><a href="https://wpt.fyi/results/idle-detection/">https://wpt.fyi/results/idle-detection/</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 the Contributors to the Idle Detection API Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document defines a web platform API for observing system-wide user presence signals.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#alternatives-considered"><span class="secno">1.1</span> <span class="content">Alternatives Considered</span></a>
     </ol>
    <li>
     <a href="#api"><span class="secno">2</span> <span class="content">Observing User Presence</span></a>
     <ol class="toc">
      <li>
       <a href="#api-model"><span class="secno">2.1</span> <span class="content">Model</span></a>
       <ol class="toc">
        <li><a href="#api-useridlestate"><span class="secno">2.1.1</span> <span class="content">The <code class="idl"><span>UserIdleState</span></code> enum</span></a>
        <li><a href="#api-screenidlestate"><span class="secno">2.1.2</span> <span class="content">The <code class="idl"><span>ScreenIdleState</span></code> enum</span></a>
       </ol>
      <li><a href="#api-permissions"><span class="secno">2.2</span> <span class="content">Permissions</span></a>
      <li><a href="#api-permissions-policy"><span class="secno">2.3</span> <span class="content">Permissions policy</span></a>
      <li>
       <a href="#api-idledetector"><span class="secno">2.4</span> <span class="content">The <code class="idl"><span>IdleDetector</span></code> interface</span></a>
       <ol class="toc">
        <li><a href="#api-idledetector-userstate"><span class="secno">2.4.1</span> <span class="content"><code class="idl"><span>userState</span></code> attribute</span></a>
        <li><a href="#api-idledetector-screenstate"><span class="secno">2.4.2</span> <span class="content"><code class="idl"><span>screenState</span></code> attribute</span></a>
        <li><a href="#api-idledetector-onchange"><span class="secno">2.4.3</span> <span class="content"><code class="idl"><span>onchange</span></code> attribute</span></a>
        <li><a href="#api-idledetector-requestpermission"><span class="secno">2.4.4</span> <span class="content"><code class="idl"><span>requestPermission()</span></code> method</span></a>
        <li><a href="#api-idledetector-start"><span class="secno">2.4.5</span> <span class="content"><code class="idl"><span>start()</span></code> method</span></a>
        <li><a href="#state-changes"><span class="secno">2.4.6</span> <span class="content">Reacting to state changes</span></a>
       </ol>
     </ol>
    <li>
     <a href="#security-and-privacy"><span class="secno">3</span> <span class="content">Security and privacy considerations</span></a>
     <ol class="toc">
      <li><a href="#privacy-cross-origin-leakage"><span class="secno">3.1</span> <span class="content">Cross-origin information leakage</span></a>
      <li><a href="#privacy-behavior-tracking"><span class="secno">3.2</span> <span class="content">Behavior tracking</span></a>
      <li><a href="#privacy-user-coercion"><span class="secno">3.3</span> <span class="content">User coercion</span></a>
     </ol>
    <li><a href="#accessibility"><span class="secno">4</span> <span class="content">Accessibility considerations</span></a>
    <li><a href="#internationalization"><span class="secno">5</span> <span class="content">Internationalization considerations</span></a>
    <li><a href="#acknowledgements"><span class="secno">6</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>Using existing capabilities a page is able to determine when it is currently
visible to the user (using the <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/page-visibility-2/#dom-document-hidden" id="ref-for-dom-document-hidden">hidden</a></code> property and <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/page-visibility-2/#dom-document-onvisibilitychange" id="ref-for-dom-document-onvisibilitychange">onvisibilitychange</a></code> event). It is also possible to know when the
user has recently interacted with the page by observing <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webappapis.html#handler-onmousemove" id="ref-for-handler-onmousemove">onmousemove</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webappapis.html#handler-onkeypress" id="ref-for-handler-onkeypress">onkeypress</a></code>, and
other events triggered by user input. While sufficiently reflecting user
engagement with a particular page these events give an incomplete picture of
whether the user is still present at their device. For example, if <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/page-visibility-2/#dom-document-hidden" id="ref-for-dom-document-hidden①">hidden</a></code> is <code>true</code>, then the device screensaver may have activated,
or the user could have switched to a different application. If it is <code>false</code> but
there have been no recent input events, then the user could have left their
computer to grab a cup of coffee, or they could be editing a document in another
window side-by-side with the page.</p>
   <p>Making these distinctions is important for applications which have the option of
delivering notifications across multiple devices, such as a desktop and
smartphone. Users may find it frustrating when notifications are delivered to
the wrong device or are disruptive. For example, if they switch from a tab
containing a messaging application to one for a document they are editing, the
messaging application, not being able to observe that the user is still
interacting with their device, may assume that they have left to grab a coffee
and start delivering notifications to their phone, causing it to buzz
distractingly, instead of displaying notifications on their desktop or
incrementing a badge count.</p>
   <h3 class="heading settled" data-level="1.1" id="alternatives-considered"><span class="secno">1.1. </span><span class="content">Alternatives Considered</span><a class="self-link" href="#alternatives-considered"></a></h3>
   <p>An alternative design would protect this information by allowing a notification
to be marked as "hide on active" or "hide on idle" and not allowing the page to
observe whether or not the notification was actually shown. The problem with
this approach is that the intelligent notification routing described previously
requires observing these signals of user presence and making centralized
decisions based on the state of all of the user’s devices.</p>
   <p>For example, to route notifications to a user’s mobile device when they get up
to grab a coffee the messaging application could detect that it is no longer
visible and start sending push messages to the mobile device while marking the
desktop notifications as "hide on active". If the user were still at their desk
but using a different application then they would start getting the distracting
notifications from their mobile device this proposal is attempting to avoid
whether or not the desktop is able to successfully suppress them. Successful
suppression of duplicate and disruptive notification requires multi-device
coordination.</p>
   <p>Allowing notifications to be hidden also breaks implementor mitigations for the <a data-link-type="biblio" href="#biblio-push-api" title="Push API">[PUSH-API]</a> being used to run silent background tasks.</p>
   <h2 class="heading settled" data-level="2" id="api"><span class="secno">2. </span><span class="content">Observing User Presence</span><a class="self-link" href="#api"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="api-model"><span class="secno">2.1. </span><span class="content">Model</span><a class="self-link" href="#api-model"></a></h3>
   <p>This specification defines a model for user presence on two dimensions: idle
state and screen lock.</p>
   <h4 class="heading settled" data-level="2.1.1" id="api-useridlestate"><span class="secno">2.1.1. </span><span class="content">The <code class="idl"><a data-link-type="idl" href="#enumdef-useridlestate" id="ref-for-enumdef-useridlestate">UserIdleState</a></code> enum</span><a class="self-link" href="#api-useridlestate"></a></h4>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-useridlestate"><code><c- g>UserIdleState</c-></code></dfn> {
    <dfn class="dfn-paneled idl-code" data-dfn-for="UserIdleState" data-dfn-type="enum-value" data-export id="dom-useridlestate-active"><code><c- s>"active"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="UserIdleState" data-dfn-type="enum-value" data-export id="dom-useridlestate-idle"><code><c- s>"idle"</c-></code></dfn>
};
</pre>
   <dl>
    <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-useridlestate-active" id="ref-for-dom-useridlestate-active">"active"</a></code>
    <dd data-md>
     <p>Indicates that the user has interacted with the device in the last <code class="idl"><a data-link-type="idl" href="#dom-idleoptions-threshold" id="ref-for-dom-idleoptions-threshold">threshold</a></code> milliseconds.</p>
    <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-useridlestate-idle" id="ref-for-dom-useridlestate-idle">"idle"</a></code>
    <dd data-md>
     <p>Indicates that the user has not interacted with the device in at least <code class="idl"><a data-link-type="idl" href="#dom-idleoptions-threshold" id="ref-for-dom-idleoptions-threshold①">threshold</a></code> milliseconds.</p>
   </dl>
   <h4 class="heading settled" data-level="2.1.2" id="api-screenidlestate"><span class="secno">2.1.2. </span><span class="content">The <code class="idl"><a data-link-type="idl" href="#enumdef-screenidlestate" id="ref-for-enumdef-screenidlestate">ScreenIdleState</a></code> enum</span><a class="self-link" href="#api-screenidlestate"></a></h4>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-screenidlestate"><code><c- g>ScreenIdleState</c-></code></dfn> {
    <dfn class="dfn-paneled idl-code" data-dfn-for="ScreenIdleState" data-dfn-type="enum-value" data-export id="dom-screenidlestate-locked"><code><c- s>"locked"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="ScreenIdleState" data-dfn-type="enum-value" data-export id="dom-screenidlestate-unlocked"><code><c- s>"unlocked"</c-></code></dfn>
};
</pre>
   <dl>
    <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-locked" id="ref-for-dom-screenidlestate-locked">"locked"</a></code>
    <dd data-md>
     <p>Indicates that the device has engaged a screensaver or lock screen which
prevents content from being seen or interacted with.</p>
    <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-unlocked" id="ref-for-dom-screenidlestate-unlocked">"unlocked"</a></code>
    <dd data-md>
     <p>Indicates that the device is able to display content and be interacted with.</p>
   </dl>
   <h3 class="heading settled" data-level="2.2" id="api-permissions"><span class="secno">2.2. </span><span class="content">Permissions</span><a class="self-link" href="#api-permissions"></a></h3>
   <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="PermissionName" data-dfn-type="enum-value" data-export id="dom-permissionname-idle-detection"><code>"idle-detection"</code></dfn> <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-powerful-feature" id="ref-for-dfn-powerful-feature">powerful
feature</a> is a <a data-link-type="dfn">boolean feature</a>.</p>
   <h3 class="heading settled" data-level="2.3" id="api-permissions-policy"><span class="secno">2.3. </span><span class="content">Permissions policy</span><a class="self-link" href="#api-permissions-policy"></a></h3>
   <p>This specification defines a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature">policy-controlled feature</a> identified by the
string <code>"idle-detection"</code>. Its <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist">default allowlist</a> is <code>'self'</code>.</p>
   <div class="note" role="note">
     The <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①">default allowlist</a> of <code>'self'</code> allows usage of this feature on
same-origin nested frames by default but prevents access by third-party content. 
    <p>Third-party usage can be selectively enabled by adding the <code>allow="idle-detection"</code> attribute to an <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#dom-requestdestination-iframe" id="ref-for-dom-requestdestination-iframe">iframe</a></code> element:</p>
    <div class="example" id="example-45553a3a">
     <a class="self-link" href="#example-45553a3a"></a> 
<pre class="language-html highlight"><c- p>&lt;</c-><c- f>iframe</c-> <c- e>src</c-><c- o>=</c-><c- s>"https://example.com"</c-> <c- e>allow</c-><c- o>=</c-><c- s>"idle-detection"</c-><c- p>>&lt;/</c-><c- f>iframe</c-><c- p>></c->
</pre>
    </div>
    <p>Alternatively, this feature can be disabled completely in first-party contexts
by specifying the permissions policy in an HTTP response header:</p>
    <div class="example" id="example-9e9c9d17">
     <a class="self-link" href="#example-9e9c9d17"></a> 
<pre class="language-http highlight">Permissions-Policy: idle-detection 'none'
</pre>
    </div>
    <p>See <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a> for more details.</p>
   </div>
   <h3 class="heading settled" data-level="2.4" id="api-idledetector"><span class="secno">2.4. </span><span class="content">The <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector">IdleDetector</a></code> interface</span><a class="self-link" href="#api-idledetector"></a></h3>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-idleoptions"><code><c- g>IdleOptions</c-></code></dfn> {
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#EnforceRange" id="ref-for-EnforceRange"><c- g>EnforceRange</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-unsigned-long-long" id="ref-for-idl-unsigned-long-long"><c- b>unsigned</c-> <c- b>long</c-> <c- b>long</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="IdleOptions" data-dfn-type="dict-member" data-export data-type="unsigned long long" id="dom-idleoptions-threshold"><code><c- g>threshold</c-></code></dfn>;
  <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#abortsignal" id="ref-for-abortsignal"><c- n>AbortSignal</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="IdleOptions" data-dfn-type="dict-member" data-export data-type="AbortSignal" id="dom-idleoptions-signal"><code><c- g>signal</c-></code></dfn>;
};

[
  <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext" id="ref-for-SecureContext"><c- g>SecureContext</c-></a>,
  <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>DedicatedWorker</c->)
] <c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="idledetector"><code><c- g>IdleDetector</c-></code></dfn> : <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#eventtarget" id="ref-for-eventtarget"><c- n>EventTarget</c-></a> {
  <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="constructor" data-export data-lt="IdleDetector()|constructor()" id="dom-idledetector-idledetector"><code><c- g>constructor</c-></code></dfn>();
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-useridlestate" id="ref-for-enumdef-useridlestate①"><c- n>UserIdleState</c-></a>? <a class="idl-code" data-link-type="attribute" data-readonly data-type="UserIdleState?" href="#dom-idledetector-userstate" id="ref-for-dom-idledetector-userstate"><c- g>userState</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-screenidlestate" id="ref-for-enumdef-screenidlestate①"><c- n>ScreenIdleState</c-></a>? <a class="idl-code" data-link-type="attribute" data-readonly data-type="ScreenIdleState?" href="#dom-idledetector-screenstate" id="ref-for-dom-idledetector-screenstate"><c- g>screenState</c-></a>;
  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler" id="ref-for-eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-idledetector-onchange" id="ref-for-dom-idledetector-onchange"><c- g>onchange</c-></a>;
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed①"><c- g>Exposed</c-></a>=<c- n>Window</c->] <c- b>static</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="https://w3c.github.io/permissions/#dom-permissionstate" id="ref-for-dom-permissionstate"><c- n>PermissionState</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-idledetector-requestpermission" id="ref-for-dom-idledetector-requestpermission"><c- g>requestPermission</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise①"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-idledetector-start" id="ref-for-dom-idledetector-start"><c- g>start</c-></a>(<c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-idleoptions" id="ref-for-dictdef-idleoptions"><c- n>IdleOptions</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector/start(options), IdleDetector/start()" data-dfn-type="argument" data-export id="dom-idledetector-start-options-options"><code><c- g>options</c-></code></dfn> = {});
};
</pre>
   <p>Instances of <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector①">IdleDetector</a></code> are created with the <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots" id="ref-for-sec-object-internal-methods-and-internal-slots">internal slots</a> described
in the following table:</p>
   <table>
    <tbody>
     <tr>
      <th><a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots" id="ref-for-sec-object-internal-methods-and-internal-slots①">Internal slot</a>
      <th>Initial value
      <th>Description (non-normative)
     <tr>
      <td><dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-state-slot"><code>[[state]]</code></dfn> 
      <td><code>"stopped"</code>
      <td>Tracks the active state of the <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector②">IdleDetector</a></code>
     <tr>
      <td><dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-threshold-slot"><code>[[threshold]]</code></dfn> 
      <td><code>undefined</code>
      <td>The configured idle detection threshold
     <tr>
      <td><dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-userstate-slot"><code>[[userState]]</code></dfn>
      <td><code>null</code>
      <td>The last known user idle state
     <tr>
      <td><dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-screenstate-slot"><code>[[screenState]]</code></dfn>
      <td><code>null</code>
      <td>The last known screen idle state
   </table>
   <details class="wpt-tests-block" dir="ltr" lang="en" open>
    <summary>Tests</summary>
    <ul class="wpt-tests-list">
     <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/idlharness-worker.https.window.js" title="idle-detection/idlharness-worker.https.window.js">idlharness-worker.https.window.js</a> <a class="wpt-live" href="https://wpt.live/idle-detection/idlharness-worker.https.window.js"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/idlharness-worker.https.window.js"><small>(source)</small></a>
     <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/idlharness.https.window.js" title="idle-detection/idlharness.https.window.js">idlharness.https.window.js</a> <a class="wpt-live" href="https://wpt.live/idle-detection/idlharness.https.window.js"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/idlharness.https.window.js"><small>(source)</small></a>
    </ul>
   </details>
   <p>Methods on this interface typically complete asynchronously, queuing work on the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="idle-detection-task-source">idle detection task source</dfn>.</p>
   <h4 class="heading settled" data-level="2.4.1" id="api-idledetector-userstate"><span class="secno">2.4.1. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate" id="ref-for-dom-idledetector-userstate①">userState</a></code> attribute</span><a class="self-link" href="#api-idledetector-userstate"></a></h4>
   <div class="algorithm" data-algorithm="userState" data-algorithm-for="IdleDetector">
     The <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-userstate"><code>userState</code></dfn> getter steps are: 
    <ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this">this</a>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate-slot" id="ref-for-dom-idledetector-userstate-slot">[[userState]]</a></code>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="2.4.2" id="api-idledetector-screenstate"><span class="secno">2.4.2. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate" id="ref-for-dom-idledetector-screenstate①">screenState</a></code> attribute</span><a class="self-link" href="#api-idledetector-screenstate"></a></h4>
   <div class="algorithm" data-algorithm="screenState" data-algorithm-for="IdleDetector">
     The <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-screenstate"><code>screenState</code></dfn> getter steps are: 
    <ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this①">this</a>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate-slot" id="ref-for-dom-idledetector-screenstate-slot">[[screenState]]</a></code>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="2.4.3" id="api-idledetector-onchange"><span class="secno">2.4.3. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-idledetector-onchange" id="ref-for-dom-idledetector-onchange①">onchange</a></code> attribute</span><a class="self-link" href="#api-idledetector-onchange"></a></h4>
   <p><dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="attribute" data-export id="dom-idledetector-onchange"><code>onchange</code></dfn> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes" id="ref-for-event-handler-idl-attributes">Event handler IDL
attribute</a> for the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change">change</a></code> event type.</p>
   <h4 class="heading settled" data-level="2.4.4" id="api-idledetector-requestpermission"><span class="secno">2.4.4. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-idledetector-requestpermission" id="ref-for-dom-idledetector-requestpermission①">requestPermission()</a></code> method</span><a class="self-link" href="#api-idledetector-requestpermission"></a></h4>
   <div class="algorithm" data-algorithm="requestPermission()" data-algorithm-for="IdleDetector">
     The <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="method" data-export id="dom-idledetector-requestpermission"><code>requestPermission()</code></dfn> method steps are: 
    <ol>
     <li data-md>
      <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global">relevant global object</a> of <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this②">this</a> does not have <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation">transient
activation</a>, return <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise">a new promise</a> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject">rejected</a> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code>.</p>
     <li data-md>
      <p>Let <var>result</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise①">a new promise</a>.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">In parallel</a>:</p>
      <ol>
       <li data-md>
        <p>Let <var>permissionState</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-request-permission-to-use" id="ref-for-dfn-request-permission-to-use">requesting permission to use</a> the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-powerful-feature" id="ref-for-dfn-powerful-feature①">powerful feature</a> named <code>"idle-detection"</code>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global①">relevant global object</a> of <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this③">this</a> using the <a data-link-type="dfn">permission task source</a> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">resolve</a> <var>result</var> with <var>permissionState</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>result</var>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="2.4.5" id="api-idledetector-start"><span class="secno">2.4.5. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-idledetector-start" id="ref-for-dom-idledetector-start①">start()</a></code> method</span><a class="self-link" href="#api-idledetector-start"></a></h4>
   <div class="algorithm" data-algorithm="start(options)" data-algorithm-for="IdleDetector">
    <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="IdleDetector" data-dfn-type="method" data-export data-lt="start(options)|start()" id="dom-idledetector-start"><code>start(<var>options</var>)</code></dfn> method steps are:</p>
    <ol>
     <li data-md>
      <p>Let <var>result</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise②">a new promise</a>.</p>
     <li data-md>
      <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global②">relevant global object</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window" id="ref-for-concept-document-window">associated Document</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use">allowed
to use</a> the <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature①">policy-controlled feature</a> named <code>"idle-detection"</code> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject①">reject</a> <var>result</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror①">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException①">DOMException</a></code> and return <var>result</var>.</p>
      <details class="wpt-tests-block" dir="ltr" lang="en" open>
       <summary>Tests</summary>
       <ul class="wpt-tests-list"></ul>
      </details>
     <li data-md>
      <p>If <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot">[[state]]</a></code> is not <code>"stopped"</code>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject②">reject</a> <var>result</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException②">DOMException</a></code> and return <var>result</var>.</p>
      <details class="wpt-tests-block" dir="ltr" lang="en" open>
       <summary>Tests</summary>
       <ul class="wpt-tests-list">
        <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/interceptor.https.html" title="idle-detection/interceptor.https.html">interceptor.https.html</a> <a class="wpt-live" href="https://wpt.live/idle-detection/interceptor.https.html"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/interceptor.https.html"><small>(source)</small></a>
       </ul>
      </details>
     <li data-md>
      <p>Set <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot①">[[state]]</a></code> to <code>"starting"</code>.</p>
     <li data-md>
      <p>If <var>options</var>[<code class="idl"><a data-link-type="idl" href="#dom-idleoptions-threshold" id="ref-for-dom-idleoptions-threshold②">"threshold"</a></code>] is less than 60,000 <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject③">reject</a> <var>result</var> with <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror">TypeError</a></code> and return <var>result</var>.</p>
      <details class="wpt-tests-block" dir="ltr" lang="en" open>
       <summary>Tests</summary>
       <ul class="wpt-tests-list">
        <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/basics.tentative.https.window.js" title="idle-detection/basics.tentative.https.window.js">basics.tentative.https.window.js</a> <a class="wpt-live" href="https://wpt.live/idle-detection/basics.tentative.https.window.js"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/basics.tentative.https.window.js"><small>(source)</small></a>
       </ul>
      </details>
     <li data-md>
      <p>If <var>options</var>["<code class="idl"><a data-link-type="idl" href="#dom-idleoptions-signal" id="ref-for-dom-idleoptions-signal">signal</a></code>"] is present, then perform the following sub-steps:</p>
      <ol>
       <li data-md>
        <p>If <var>options</var>["<code class="idl"><a data-link-type="idl" href="#dom-idleoptions-signal" id="ref-for-dom-idleoptions-signal①">signal</a></code>"]'s <a data-link-type="dfn">aborted flag</a> is set, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject④">reject</a> <var>result</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#aborterror" id="ref-for-aborterror">AbortError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException③">DOMException</a></code> and return <var>result</var>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#abortsignal-add" id="ref-for-abortsignal-add">Add the following abort steps</a> to <var>options</var>["<code class="idl"><a data-link-type="idl" href="#dom-idleoptions-signal" id="ref-for-dom-idleoptions-signal②">signal</a></code>"]:</p>
        <ol>
         <li data-md>
          <p>Set <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot②">[[state]]</a></code> to <code>"stopped"</code>.</p>
         <li data-md>
          <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑤">Reject</a> <var>result</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#aborterror" id="ref-for-aborterror①">AbortError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException④">DOMException</a></code>.</p>
        </ol>
      </ol>
      <details class="wpt-tests-block" dir="ltr" lang="en" open>
       <summary>Tests</summary>
       <ul class="wpt-tests-list">
        <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/interceptor.https.html" title="idle-detection/interceptor.https.html">interceptor.https.html</a> <a class="wpt-live" href="https://wpt.live/idle-detection/interceptor.https.html"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/interceptor.https.html"><small>(source)</small></a>
       </ul>
      </details>
     <li data-md>
      <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task①">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global③">relevant global object</a> of <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this④">this</a> using
the <a data-link-type="dfn" href="#idle-detection-task-source" id="ref-for-idle-detection-task-source">idle detection task source</a> to perform the following steps, but <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#abort-when" id="ref-for-abort-when">abort when</a> <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot③">[[state]]</a></code> becomes <code>"stopped"</code>.</p>
      <ol>
       <li data-md>
        <p>Let <var>permissionState</var> be the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-state" id="ref-for-dfn-permission-state">permission state</a> the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-powerful-feature" id="ref-for-dfn-powerful-feature②">powerful
feature</a> named <code>"idle-detection"</code>.</p>
       <li data-md>
        <p>If <var>permissionState</var> is <code>"denied"</code>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑥">reject</a> <var>result</var> with a
"<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror②">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑤">DOMException</a></code>, set <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot④">[[state]]</a></code> to <code>"stopped"</code> and abort these steps.</p>
        <details class="wpt-tests-block" dir="ltr" lang="en" open>
         <summary>Tests</summary>
         <ul class="wpt-tests-list">
          <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/idle-permission.tentative.https.window.js" title="idle-detection/idle-permission.tentative.https.window.js">idle-permission.tentative.https.window.js</a> <a class="wpt-live" href="https://wpt.live/idle-detection/idle-permission.tentative.https.window.js"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/idle-permission.tentative.https.window.js"><small>(source)</small></a>
         </ul>
        </details>
       <li data-md>
        <p>Set <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot⑤">[[state]]</a></code> to <code>"started"</code>.</p>
       <li data-md>
        <p>Set <var>this</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-threshold-slot" id="ref-for-dom-idledetector-threshold-slot">[[threshold]]</a></code> to <var>options</var>["<code class="idl"><a data-link-type="idl" href="#dom-idleoptions-threshold" id="ref-for-dom-idleoptions-threshold③">threshold</a></code>"].</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①">Resolve</a> <var>result</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>result</var>.</p>
    </ol>
   </div>
   <div class="example" id="example-412adf75">
    <a class="self-link" href="#example-412adf75"></a> 
    <p>The availability of this API can be detected by looking for the <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector③">IdleDetector</a></code> constructor in the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window">Window</a></code> object.</p>
<pre class="language-js highlight"><c- k>if</c-> <c- p>(</c-><c- o>!</c-><c- p>(</c-><c- t>'IdleDetector'</c-> <c- ow>in</c-> window<c- p>))</c-> <c- p>{</c->
  console<c- p>.</c->log<c- p>(</c-><c- t>'Idle detection is not available.'</c-><c- p>);</c->
  <c- k>return</c-><c- p>;</c->
<c- p>}</c->
</pre>
    <p>Calling <code class="idl"><a data-link-type="idl" href="#dom-idledetector-start" id="ref-for-dom-idledetector-start②">start()</a></code> will fail if the <code class="idl"><a data-link-type="idl" href="#dom-permissionname-idle-detection" id="ref-for-dom-permissionname-idle-detection">"idle-detection"</a></code> permission has not
been granted.</p>
<pre class="language-js highlight"><c- k>if</c-> <c- p>((</c-><c- k>await</c-> IdleDetector<c- p>.</c->requestPermission<c- p>())</c-> <c- o>!==</c-> <c- t>'granted'</c-><c- p>)</c-> <c- p>{</c->
  console<c- p>.</c->log<c- p>(</c-><c- t>'Idle detection permission not granted.'</c-><c- p>);</c->
  <c- k>return</c-><c- p>;</c->
<c- p>}</c->
</pre>
    <p>A set of options can be configured to control the threshold the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#user-agent" id="ref-for-user-agent">user agent</a> uses to decide when the user has become idle.</p>
<pre class="language-js highlight"><c- a>const</c-> controller <c- o>=</c-> <c- ow>new</c-> AbortController<c- p>();</c->
<c- a>const</c-> signal <c- o>=</c-> controller<c- p>.</c->signal<c- p>;</c->

<c- a>const</c-> options <c- o>=</c-> <c- p>{</c->
  threshold<c- o>:</c-> <c- mf>60</c->_000<c- p>,</c->
  signal<c- p>,</c->
<c- p>};</c->
</pre>
    <p>The <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector④">IdleDetector</a></code> can now be created and started. An listener for the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change①">"change"</a></code> event is added and will be fired if the <code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate" id="ref-for-dom-idledetector-userstate②">userState</a></code> or <code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate" id="ref-for-dom-idledetector-screenstate②">screenState</a></code> attributes change.</p>
<pre class="language-js highlight"><c- k>try</c-> <c- p>{</c->
  <c- a>const</c-> idleDetector <c- o>=</c-> <c- ow>new</c-> IdleDetector<c- p>();</c->
  idleDetector<c- p>.</c->addEventListener<c- p>(</c-><c- t>'change'</c-><c- p>,</c-> <c- p>()</c-> <c- p>=></c-> <c- p>{</c->
    console<c- p>.</c->log<c- p>(</c->\<c- sb>`Idle change: </c-><c- si>${</c->idleDetector<c- p>.</c->userState<c- si>}</c-><c- sb>, </c-><c- si>${</c->idleDetector<c- p>.</c->screenState<c- si>}</c-><c- sb>.\`);</c->
<c- sb>  });</c->
<c- sb>  await idleDetector.start(options);</c->
<c- sb>  console.log('IdleDetector is active.');</c->
<c- sb>} catch (err) {</c->
<c- sb>  // Deal with initialization errors like permission denied,</c->
<c- sb>  // running outside of top-level frame, etc.</c->
<c- sb>  console.error(err.name, err.message);</c->
<c- sb>}</c->
</pre>
    <p>At a later time the page can cancel its interest in state change events by
removing its event listeners or using the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#abortsignal" id="ref-for-abortsignal①">AbortSignal</a></code> that was passed to <code class="idl"><a data-link-type="idl" href="#dom-idledetector-start" id="ref-for-dom-idledetector-start③">start()</a></code>.</p>
<pre class="language-js highlight">controller<c- p>.</c->abort<c- p>();</c->
console<c- p>.</c->log<c- p>(</c-><c- t>'IdleDetector is stopped.'</c-><c- p>);</c->
</pre>
   </div>
   <h4 class="heading settled" data-level="2.4.6" id="state-changes"><span class="secno">2.4.6. </span><span class="content">Reacting to state changes</span><a class="self-link" href="#state-changes"></a></h4>
   <div class="algorithm" data-algorithm="state changes">
    <p>For each <code class="idl"><a data-link-type="idl" href="#idledetector" id="ref-for-idledetector⑤">IdleDetector</a></code> instance <var>detector</var> where <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-state-slot" id="ref-for-dom-idledetector-state-slot⑥">[[state]]</a></code> is <code>"started"</code> the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#user-agent" id="ref-for-user-agent①">user agent</a> MUST continuously monitor the following
conditions:</p>
    <ul>
     <li data-md>
      <p>If <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate-slot" id="ref-for-dom-idledetector-userstate-slot①">[[userState]]</a></code> is <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-active" id="ref-for-dom-useridlestate-active①">"active"</a></code> and the user has not
interacted with the device within the last <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-threshold-slot" id="ref-for-dom-idledetector-threshold-slot①">[[threshold]]</a></code> milliseconds, it MUST <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task②">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global④">relevant global
object</a> of <var>detector</var> using the <a data-link-type="dfn" href="#idle-detection-task-source" id="ref-for-idle-detection-task-source①">idle detection task source</a> to run the
following steps:</p>
      <ol>
       <li data-md>
        <p>Set <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate-slot" id="ref-for-dom-idledetector-userstate-slot②">[[userState]]</a></code> to <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-idle" id="ref-for-dom-useridlestate-idle①">"idle"</a></code>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire">Fire an event</a> named <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change②">"change"</a></code> at <var>detector</var>.</p>
      </ol>
     <li data-md>
      <p>If <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate-slot" id="ref-for-dom-idledetector-userstate-slot③">[[userState]]</a></code> is <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-idle" id="ref-for-dom-useridlestate-idle②">"idle"</a></code> and the user interacts with
the device, it MUST <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task③">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global⑤">relevant global
object</a> of <var>detector</var> using the <a data-link-type="dfn" href="#idle-detection-task-source" id="ref-for-idle-detection-task-source②">idle detection task source</a> to run the
following steps:</p>
      <ol>
       <li data-md>
        <p>Set <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-userstate-slot" id="ref-for-dom-idledetector-userstate-slot④">[[userState]]</a></code> to <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-active" id="ref-for-dom-useridlestate-active②">"active"</a></code>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire①">Fire an event</a> named <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change③">"change"</a></code> at <var>detector</var>.</p>
      </ol>
     <li data-md>
      <p>If <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate-slot" id="ref-for-dom-idledetector-screenstate-slot①">[[screenState]]</a></code> is <code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-unlocked" id="ref-for-dom-screenidlestate-unlocked①">"unlocked"</a></code> and the screen is
locked, it MUST <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task④">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global⑥">relevant global object</a> of <var>detector</var> using the <a data-link-type="dfn" href="#idle-detection-task-source" id="ref-for-idle-detection-task-source③">idle detection task source</a> to run the following
steps:</p>
      <ol>
       <li data-md>
        <p>Set <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate-slot" id="ref-for-dom-idledetector-screenstate-slot②">[[screenState]]</a></code> to <code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-locked" id="ref-for-dom-screenidlestate-locked①">"locked"</a></code>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire②">Fire an event</a> named <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change④">"change"</a></code> at <var>detector</var>.</p>
      </ol>
     <li data-md>
      <p>If <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate-slot" id="ref-for-dom-idledetector-screenstate-slot③">[[screenState]]</a></code> is <code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-locked" id="ref-for-dom-screenidlestate-locked②">"locked"</a></code> and the screen is
unlocked, it MUST <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task⑤">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global⑦">relevant global object</a> of <var>detector</var> using the <a data-link-type="dfn" href="#idle-detection-task-source" id="ref-for-idle-detection-task-source④">idle detection task source</a> to run the following
steps:</p>
      <ol>
       <li data-md>
        <p>Set <var>detector</var>.<code class="idl"><a data-link-type="idl" href="#dom-idledetector-screenstate-slot" id="ref-for-dom-idledetector-screenstate-slot④">[[screenState]]</a></code> to <code class="idl"><a data-link-type="idl" href="#dom-screenidlestate-unlocked" id="ref-for-dom-screenidlestate-unlocked②">"unlocked"</a></code>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire③">Fire an event</a> named <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/indices.html#event-change" id="ref-for-event-change⑤">"change"</a></code> at <var>detector</var>.</p>
      </ol>
    </ul>
   </div>
   <details class="wpt-tests-block" dir="ltr" lang="en" open>
    <summary>Tests</summary>
    <ul class="wpt-tests-list">
     <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/idle-detection/interceptor.https.html" title="idle-detection/interceptor.https.html">interceptor.https.html</a> <a class="wpt-live" href="https://wpt.live/idle-detection/interceptor.https.html"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/idle-detection/interceptor.https.html"><small>(source)</small></a>
    </ul>
   </details>
   <h2 class="heading settled" data-level="3" id="security-and-privacy"><span class="secno">3. </span><span class="content">Security and privacy considerations</span><a class="self-link" href="#security-and-privacy"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <h3 class="heading settled" data-level="3.1" id="privacy-cross-origin-leakage"><span class="secno">3.1. </span><span class="content">Cross-origin information leakage</span><a class="self-link" href="#privacy-cross-origin-leakage"></a></h3>
   <p>This interface exposes the state of global system properties and so care must be
taken to prevent them from being used as cross-origin communication or
identification channels. Similar concerns are present in specifications such as <a data-link-type="biblio" href="#biblio-device-orientation" title="Device Orientation and Motion">[DEVICE-ORIENTATION]</a> and <a data-link-type="biblio" href="#biblio-geolocation-api" title="Geolocation">[GEOLOCATION-API]</a>, which mitigate them by requiring
a visible or focused context. This prevents multiple origins from observing the
global state at the same time. These mitigations are unfortunately inappropriate
here because the intent of this specification is precisely to allow a limited
form of tracking in blurred and hidden contexts. A malicious page could notify a
tracking server whenever the user is detected as idle or active. If multiple
pages the user was visiting notified the same server it could use the timing of
the events to guess which sessions corresponded to a single user as they would
arrive roughly simultaneously.</p>
   <p>To reduce the number of independent contexts with access to this interface this
specification restricts it to top-level and same-origin contexts. Access can be
delegated to a cross-origin context through <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a>.</p>
   <p>To further reduce the number of contexts this specification requires
a page to obtain the <code class="idl"><a data-link-type="idl" href="#dom-permissionname-idle-detection" id="ref-for-dom-permissionname-idle-detection①">"idle-detection"</a></code> permission. User agents should inform
the user of the capability that this permission grants and encourage them to
only grant it to trusted sites which have a legitimate purpose for this data.</p>
   <p>Implementations that provide a "private browsing" mode should not allow this
capability in contexts where this mode is enabled. Implementations should be
careful however to avoid the lack of this capability from being used as a signal
that this mode is enabled. This can be accomplished by refusing to allow the <code class="idl"><a data-link-type="idl" href="#dom-permissionname-idle-detection" id="ref-for-dom-permissionname-idle-detection②">"idle-detection"</a></code> permission to be granted but delaying the automatic
dismissal of the permission request by a random interval so that it appears to
have been a user action.</p>
   <h3 class="heading settled" data-level="3.2" id="privacy-behavior-tracking"><span class="secno">3.2. </span><span class="content">Behavior tracking</span><a class="self-link" href="#privacy-behavior-tracking"></a></h3>
   <p>While this interface does not provide details of the user interaction which
triggered an <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-idle" id="ref-for-dom-useridlestate-idle③">"idle"</a></code> to <code class="idl"><a data-link-type="idl" href="#dom-useridlestate-active" id="ref-for-dom-useridlestate-active③">"active"</a></code> transition, with a sufficiently short
threshold these events could be used to detect behavior such as typing. This
specification therefore restricts the requested threshold to a minimum of at
least 60 seconds.</p>
   <p>The permission requirement described previously also helps to mitigate the
general concern that this interface can be used to build a profile of when and
for how long the user typically interacts with their device.</p>
   <h3 class="heading settled" data-level="3.3" id="privacy-user-coercion"><span class="secno">3.3. </span><span class="content">User coercion</span><a class="self-link" href="#privacy-user-coercion"></a></h3>
   <p>Sites may require the user to grant them the <code class="idl"><a data-link-type="idl" href="#dom-permissionname-idle-detection" id="ref-for-dom-permissionname-idle-detection③">"idle-detection"</a></code> permission
before unlocking some functionality. For example, a testing site could require
this permission as part of an anti-cheating mechanism to detect the user
consulting forbidden reference materials in another window. This type of
"Contract of Adhesion" has been observed with other permissions such as
notifications, FIDO attestation and DRM identifiers.</p>
   <p>A potential mitigation for this concern is to design that interface so that it
is not possible for a site to determine whether the user has granted or denied
the permission. An implementation could refuse to acknowledge that the user is
idle, reducing a site to only the signals currently available. This mitigation
could be detectable as it is unlikely that a user who has not interacted with a
page for hours has nevertheless still been continuously interacting with
something else. Implementations could instead insert fake idle transition events
which correspond to plausible behavior given the other signals available to the
page.</p>
   <p>This specification does not mandate this type of mitigation as it could create a
poor user experience when sites take action based on this false data. For
example, the message application mentioned previously would not deliver
notifications to the user’s mobile device because it believes the signals it has
been given indicate that they are still at their desktop. As the site cannot
detect that it is in this state it cannot directly recommend an action for the
user to take to get themselves out of it.</p>
   <p>The harm done by such a site is limited as tracking is only possible while the
user is visiting that page. Tracking across multiple origins requires permission
to be requested on each participating site.</p>
   <h2 class="heading settled" data-level="4" id="accessibility"><span class="secno">4. </span><span class="content">Accessibility considerations</span><a class="self-link" href="#accessibility"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>Users with physical or cognitive impairments may require more time to interact
with user agents and content. Implementations should not allow distinguishing
such users, or limiting their ability to interact with content any more than
existing observation of UI events. For example, implementation should ensure
that interactions from assistive technologies count towards considering the user
active.</p>
   <p>The use of a permission also requires that user agents provide a user interface
element to support requesting and managing that permission. Any such user
interface elements must be designed with accessibility tools in mind. For
example, a user interface describing the capability being requested should
provide the same description to tools such as screen readers.</p>
   <h2 class="heading settled" data-level="5" id="internationalization"><span class="secno">5. </span><span class="content">Internationalization considerations</span><a class="self-link" href="#internationalization"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>The interface described by this specification has limited internationalization
considerations, however the use of a permission does require that user agents
provide a user interface element to support requesting and managing that
permission. Any content displayed by the user agent in this context should be
translated into the user’s native language.</p>
   <h2 class="heading settled" data-level="6" id="acknowledgements"><span class="secno">6. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>Many thanks to
Kenneth Christiansen,
Samuel Goto,
Ayu Ishii and 
Thomas Steiner
for their help in crafting this proposal.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <details class="wpt-tests-block" dir="ltr" lang="en" open>
    <summary>Tests</summary>
    <p>Tests relating to the content of this specification
                     may be documented in “Tests” blocks like this one.
                     Any such block is non-normative.</p>
    <ul class="wpt-tests-list"></ul>
    <hr>
   </details>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#dom-useridlestate-active">"active"</a><span>, in § 2.1.1</span>
   <li><a href="#dom-idledetector-idledetector">constructor()</a><span>, in § 2.4</span>
   <li><a href="#dom-useridlestate-idle">"idle"</a><span>, in § 2.1.1</span>
   <li><a href="#dom-permissionname-idle-detection">"idle-detection"</a><span>, in § 2.2</span>
   <li><a href="#idle-detection-task-source">idle detection task source</a><span>, in § 2.4</span>
   <li><a href="#idledetector">IdleDetector</a><span>, in § 2.4</span>
   <li><a href="#dom-idledetector-idledetector">IdleDetector()</a><span>, in § 2.4</span>
   <li><a href="#dictdef-idleoptions">IdleOptions</a><span>, in § 2.4</span>
   <li><a href="#dom-screenidlestate-locked">"locked"</a><span>, in § 2.1.2</span>
   <li><a href="#dom-idledetector-onchange">onchange</a><span>, in § 2.4.3</span>
   <li><a href="#dom-idledetector-requestpermission">requestPermission()</a><span>, in § 2.4.4</span>
   <li><a href="#enumdef-screenidlestate">ScreenIdleState</a><span>, in § 2.1.2</span>
   <li><a href="#dom-idledetector-screenstate-slot">[[screenState]]</a><span>, in § 2.4</span>
   <li><a href="#dom-idledetector-screenstate">screenState</a><span>, in § 2.4.2</span>
   <li><a href="#dom-idleoptions-signal">signal</a><span>, in § 2.4</span>
   <li><a href="#dom-idledetector-start">start()</a><span>, in § 2.4.5</span>
   <li><a href="#dom-idledetector-start">start(options)</a><span>, in § 2.4.5</span>
   <li><a href="#dom-idledetector-state-slot">[[state]]</a><span>, in § 2.4</span>
   <li><a href="#dom-idledetector-threshold-slot">[[threshold]]</a><span>, in § 2.4</span>
   <li><a href="#dom-idleoptions-threshold">threshold</a><span>, in § 2.4</span>
   <li><a href="#dom-screenidlestate-unlocked">"unlocked"</a><span>, in § 2.1.2</span>
   <li><a href="#enumdef-useridlestate">UserIdleState</a><span>, in § 2.1.1</span>
   <li><a href="#dom-idledetector-userstate-slot">[[userState]]</a><span>, in § 2.4</span>
   <li><a href="#dom-idledetector-userstate">userState</a><span>, in § 2.4.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="cca3cdb2">AbortSignal</span>
     <li><span class="dfn-paneled" id="2bc0cdf4">EventTarget</span>
     <li><span class="dfn-paneled" id="87bc23a5">add</span>
     <li><span class="dfn-paneled" id="5fd23811">fire an event</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ECMASCRIPT]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c15f1628">internal slot</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="7691dbb6">"iframe"</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="f0951476">EventHandler</span>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="3610bd67">allowed to use</span>
     <li><span class="dfn-paneled" id="3349d69f">associated document</span>
     <li><span class="dfn-paneled" id="2b619939">change</span>
     <li><span class="dfn-paneled" id="03675365">event handler idl attribute</span>
     <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
     <li><span class="dfn-paneled" id="384a2229">onkeypress</span>
     <li><span class="dfn-paneled" id="541116eb">onmousemove</span>
     <li><span class="dfn-paneled" id="48438eb3">queue a global task</span>
     <li><span class="dfn-paneled" id="e99bd18e">relevant global object</span>
     <li><span class="dfn-paneled" id="47fe679e">transient activation</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1adcc035">abort when</span>
     <li><span class="dfn-paneled" id="6d19ac93">user agent</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PAGE-VISIBILITY-2]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="ac36400f">hidden</span>
     <li><span class="dfn-paneled" id="922b9e73">onvisibilitychange</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="6c3bee60">PermissionState</span>
     <li><span class="dfn-paneled" id="d124397f">permission state</span>
     <li><span class="dfn-paneled" id="6c2d7879">powerful feature</span>
     <li><span class="dfn-paneled" id="d357c753">requesting permission to use</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1570624a">default allowlist</span>
     <li><span class="dfn-paneled" id="cc890cc1">policy-controlled feature</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d25dfb2c">AbortError</span>
     <li><span class="dfn-paneled" id="dca2de17">DOMException</span>
     <li><span class="dfn-paneled" id="c01cbda0">EnforceRange</span>
     <li><span class="dfn-paneled" id="889e932f">Exposed</span>
     <li><span class="dfn-paneled" id="797018a7">InvalidStateError</span>
     <li><span class="dfn-paneled" id="ba556545">NotAllowedError</span>
     <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
     <li><span class="dfn-paneled" id="b75bb3bd">SecureContext</span>
     <li><span class="dfn-paneled" id="82ca3efc">TypeError</span>
     <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
     <li><span class="dfn-paneled" id="b262501e">reject</span>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
     <li><span class="dfn-paneled" id="4013a022">this</span>
     <li><span class="dfn-paneled" id="5f90bbfb">undefined</span>
     <li><span class="dfn-paneled" id="f14b47b8">unsigned long long</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-ecmascript">[ECMASCRIPT]
   <dd><a href="https://tc39.es/ecma262/multipage/"><cite>ECMAScript Language Specification</cite></a>. URL: <a href="https://tc39.es/ecma262/multipage/">https://tc39.es/ecma262/multipage/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-page-visibility-2">[PAGE-VISIBILITY-2]
   <dd>Ilya Grigorik; Marcos Caceres. <a href="https://w3c.github.io/page-visibility/"><cite>Page Visibility Level 2</cite></a>. URL: <a href="https://w3c.github.io/page-visibility/">https://w3c.github.io/page-visibility/</a>
   <dt id="biblio-permissions">[PERMISSIONS]
   <dd>Marcos Caceres; Mike Taylor. <a href="https://w3c.github.io/permissions/"><cite>Permissions</cite></a>. URL: <a href="https://w3c.github.io/permissions/">https://w3c.github.io/permissions/</a>
   <dt id="biblio-permissions-policy">[PERMISSIONS-POLICY]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-device-orientation">[DEVICE-ORIENTATION]
   <dd>Reilly Grant; Raphael Kubo da Costa; Marcos Caceres. <a href="https://w3c.github.io/deviceorientation/"><cite>Device Orientation and Motion</cite></a>. URL: <a href="https://w3c.github.io/deviceorientation/">https://w3c.github.io/deviceorientation/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-geolocation-api">[GEOLOCATION-API]
   <dd>Marcos Caceres; Reilly Grant. <a href="https://w3c.github.io/geolocation/"><cite>Geolocation</cite></a>. URL: <a href="https://w3c.github.io/geolocation/">https://w3c.github.io/geolocation/</a>
   <dt id="biblio-push-api">[PUSH-API]
   <dd>Peter Beverloo; Martin Thomson; Marcos Caceres. <a href="https://w3c.github.io/push-api/"><cite>Push API</cite></a>. URL: <a href="https://w3c.github.io/push-api/">https://w3c.github.io/push-api/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>enum</c-> <a href="#enumdef-useridlestate"><code><c- g>UserIdleState</c-></code></a> {
    <a href="#dom-useridlestate-active"><code><c- s>"active"</c-></code></a>,
    <a href="#dom-useridlestate-idle"><code><c- s>"idle"</c-></code></a>
};

<c- b>enum</c-> <a href="#enumdef-screenidlestate"><code><c- g>ScreenIdleState</c-></code></a> {
    <a href="#dom-screenidlestate-locked"><code><c- s>"locked"</c-></code></a>,
    <a href="#dom-screenidlestate-unlocked"><code><c- s>"unlocked"</c-></code></a>
};

<c- b>dictionary</c-> <a href="#dictdef-idleoptions"><code><c- g>IdleOptions</c-></code></a> {
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#EnforceRange"><c- g>EnforceRange</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-unsigned-long-long"><c- b>unsigned</c-> <c- b>long</c-> <c- b>long</c-></a> <a data-type="unsigned long long" href="#dom-idleoptions-threshold"><code><c- g>threshold</c-></code></a>;
  <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#abortsignal"><c- n>AbortSignal</c-></a> <a data-type="AbortSignal" href="#dom-idleoptions-signal"><code><c- g>signal</c-></code></a>;
};

[
  <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext"><c- g>SecureContext</c-></a>,
  <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>DedicatedWorker</c->)
] <c- b>interface</c-> <a href="#idledetector"><code><c- g>IdleDetector</c-></code></a> : <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#eventtarget"><c- n>EventTarget</c-></a> {
  <a href="#dom-idledetector-idledetector"><code><c- g>constructor</c-></code></a>();
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-useridlestate"><c- n>UserIdleState</c-></a>? <a class="idl-code" data-link-type="attribute" data-readonly data-type="UserIdleState?" href="#dom-idledetector-userstate"><c- g>userState</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-screenidlestate"><c- n>ScreenIdleState</c-></a>? <a class="idl-code" data-link-type="attribute" data-readonly data-type="ScreenIdleState?" href="#dom-idledetector-screenstate"><c- g>screenState</c-></a>;
  <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-idledetector-onchange"><c- g>onchange</c-></a>;
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->] <c- b>static</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="https://w3c.github.io/permissions/#dom-permissionstate"><c- n>PermissionState</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-idledetector-requestpermission"><c- g>requestPermission</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-idledetector-start"><c- g>start</c-></a>(<c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-idleoptions"><c- n>IdleOptions</c-></a> <a href="#dom-idledetector-start-options-options"><code><c- g>options</c-></code></a> = {});
};

</pre>
  <details class="mdn-anno unpositioned" data-anno-for="dom-idledetector-idledetector">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/IdleDetector" title="The IdleDetector() constructor creates a new IdleDetector object which provides events indicating when the user is no longer interacting with their device or the screen has locked.">IdleDetector/IdleDetector</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector-onchange">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/change_event" title="The change event of the IdleDetector interface fires when the value of userState or screenState has changed.">IdleDetector/change_event</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector-requestpermission">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/requestPermission_static" title="The requestPermission() static method of the IdleDetector interface returns a Promise that resolves with a string when the user has chosen whether to grant the origin access to their idle state. Resolves with &quot;granted&quot; on acceptance and &quot;denied&quot; on refusal.">IdleDetector/requestPermission_static</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector-screenstate">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/screenState" title="The screenState read-only property of the IdleDetector interface returns a string indicating whether the screen is locked, one of &quot;locked&quot; or &quot;unlocked&quot;.">IdleDetector/screenState</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector-start">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/start" title="The start() method of the IdleDetector interface returns a Promise that resolves when the detector starts listening for changes in the user&apos;s idle state. This method takes an optional options object with the threshold in milliseconds where inactivity should be reported and signal for an AbortSignal to abort the idle detector.">IdleDetector/start</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector-userstate">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector/userState" title="The userState read-only property of the IdleDetector interface returns a string indicating whether the user has interacted with the device since the call to start().">IdleDetector/userState</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-idledetector">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IdleDetector" title="The IdleDetector interface of the Idle Detection API provides methods and events for detecting user activity on a device or screen.">IdleDetector</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>None</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="api-permissions-policy">
   <summary><b class="less-than-two-engines-flag" title="This feature is in less than two current engines.">⚠</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy/idle-detection" title="The HTTP Permissions-Policy header idle-detection directive controls whether the current document is allowed to use the Idle Detection API to detect when users are interacting with their devices, for example to report &quot;available&quot;/&quot;away&quot; status in chat applications.">Headers/Permissions-Policy/idle-detection</a></p>
    <p class="less-than-two-engines-text">In only one current engine.</p>
    <div class="support">
     <span class="firefox no"><span>Firefox</span><span>None</span></span><span class="safari no"><span>Safari</span><span>None</span></span><span class="chrome yes"><span>Chrome</span><span>94+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>94+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"03675365": {"dfnID":"03675365","dfnText":"event handler idl attribute","external":true,"refSections":[{"refs":[{"id":"ref-for-event-handler-idl-attributes"}],"title":"2.4.3. onchange attribute"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes"},
"1570624a": {"dfnID":"1570624a","dfnText":"default allowlist","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature-default-allowlist"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460"}],"title":"2.3. Permissions policy"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"1adcc035": {"dfnID":"1adcc035","dfnText":"abort when","external":true,"refSections":[{"refs":[{"id":"ref-for-abort-when"}],"title":"2.4.5. start() method"}],"url":"https://infra.spec.whatwg.org/#abort-when"},
"2b619939": {"dfnID":"2b619939","dfnText":"change","external":true,"refSections":[{"refs":[{"id":"ref-for-event-change"}],"title":"2.4.3. onchange attribute"},{"refs":[{"id":"ref-for-event-change\u2460"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-event-change\u2461"},{"id":"ref-for-event-change\u2462"},{"id":"ref-for-event-change\u2463"},{"id":"ref-for-event-change\u2464"}],"title":"2.4.6. Reacting to state changes"}],"url":"https://html.spec.whatwg.org/multipage/indices.html#event-change"},
"2bc0cdf4": {"dfnID":"2bc0cdf4","dfnText":"EventTarget","external":true,"refSections":[{"refs":[{"id":"ref-for-eventtarget"}],"title":"2.4. The IdleDetector interface"}],"url":"https://dom.spec.whatwg.org/#eventtarget"},
"3349d69f": {"dfnID":"3349d69f","dfnText":"associated document","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-window"}],"title":"2.4.5. start() method"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window"},
"3610bd67": {"dfnID":"3610bd67","dfnText":"allowed to use","external":true,"refSections":[{"refs":[{"id":"ref-for-allowed-to-use"}],"title":"2.4.5. start() method"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"384a2229": {"dfnID":"384a2229","dfnText":"onkeypress","external":true,"refSections":[{"refs":[{"id":"ref-for-handler-onkeypress"}],"title":"1. Introduction"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onkeypress"},
"3b90bdcd": {"dfnID":"3b90bdcd","dfnText":"resolve","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-resolve\u2460"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#resolve"},
"4013a022": {"dfnID":"4013a022","dfnText":"this","external":true,"refSections":[{"refs":[{"id":"ref-for-this"}],"title":"2.4.1. userState attribute"},{"refs":[{"id":"ref-for-this\u2460"}],"title":"2.4.2. screenState attribute"},{"refs":[{"id":"ref-for-this\u2461"},{"id":"ref-for-this\u2462"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-this\u2463"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#this"},
"47fe679e": {"dfnID":"47fe679e","dfnText":"transient activation","external":true,"refSections":[{"refs":[{"id":"ref-for-transient-activation"}],"title":"2.4.4. requestPermission() method"}],"url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"48438eb3": {"dfnID":"48438eb3","dfnText":"queue a global task","external":true,"refSections":[{"refs":[{"id":"ref-for-queue-a-global-task"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-queue-a-global-task\u2460"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-queue-a-global-task\u2461"},{"id":"ref-for-queue-a-global-task\u2462"},{"id":"ref-for-queue-a-global-task\u2463"},{"id":"ref-for-queue-a-global-task\u2464"}],"title":"2.4.6. Reacting to state changes"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"541116eb": {"dfnID":"541116eb","dfnText":"onmousemove","external":true,"refSections":[{"refs":[{"id":"ref-for-handler-onmousemove"}],"title":"1. Introduction"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onmousemove"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"}],"title":"2.4.5. start() method"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"5f90bbfb": {"dfnID":"5f90bbfb","dfnText":"undefined","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-undefined"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"5fd23811": {"dfnID":"5fd23811","dfnText":"fire an event","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-event-fire"},{"id":"ref-for-concept-event-fire\u2460"},{"id":"ref-for-concept-event-fire\u2461"},{"id":"ref-for-concept-event-fire\u2462"}],"title":"2.4.6. Reacting to state changes"}],"url":"https://dom.spec.whatwg.org/#concept-event-fire"},
"6c2d7879": {"dfnID":"6c2d7879","dfnText":"powerful feature","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-powerful-feature"}],"title":"2.2. Permissions"},{"refs":[{"id":"ref-for-dfn-powerful-feature\u2460"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-dfn-powerful-feature\u2461"}],"title":"2.4.5. start() method"}],"url":"https://w3c.github.io/permissions/#dfn-powerful-feature"},
"6c3bee60": {"dfnID":"6c3bee60","dfnText":"PermissionState","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissionstate"}],"title":"2.4. The IdleDetector interface"}],"url":"https://w3c.github.io/permissions/#dom-permissionstate"},
"6d19ac93": {"dfnID":"6d19ac93","dfnText":"user agent","external":true,"refSections":[{"refs":[{"id":"ref-for-user-agent"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-user-agent\u2460"}],"title":"2.4.6. Reacting to state changes"}],"url":"https://infra.spec.whatwg.org/#user-agent"},
"7691dbb6": {"dfnID":"7691dbb6","dfnText":"\"iframe\"","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-requestdestination-iframe"}],"title":"2.3. Permissions policy"}],"url":"https://fetch.spec.whatwg.org/#dom-requestdestination-iframe"},
"797018a7": {"dfnID":"797018a7","dfnText":"InvalidStateError","external":true,"refSections":[{"refs":[{"id":"ref-for-invalidstateerror"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#invalidstateerror"},
"82ca3efc": {"dfnID":"82ca3efc","dfnText":"TypeError","external":true,"refSections":[{"refs":[{"id":"ref-for-exceptiondef-typeerror"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#exceptiondef-typeerror"},
"87bc23a5": {"dfnID":"87bc23a5","dfnText":"add","external":true,"refSections":[{"refs":[{"id":"ref-for-abortsignal-add"}],"title":"2.4.5. start() method"}],"url":"https://dom.spec.whatwg.org/#abortsignal-add"},
"889e932f": {"dfnID":"889e932f","dfnText":"Exposed","external":true,"refSections":[{"refs":[{"id":"ref-for-Exposed"},{"id":"ref-for-Exposed\u2460"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#Exposed"},
"922b9e73": {"dfnID":"922b9e73","dfnText":"onvisibilitychange","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-onvisibilitychange"}],"title":"1. Introduction"}],"url":"https://www.w3.org/TR/page-visibility-2/#dom-document-onvisibilitychange"},
"a72449dd": {"dfnID":"a72449dd","dfnText":"in parallel","external":true,"refSections":[{"refs":[{"id":"ref-for-in-parallel"}],"title":"2.4.4. requestPermission() method"}],"url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"ac36400f": {"dfnID":"ac36400f","dfnText":"hidden","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-hidden"},{"id":"ref-for-dom-document-hidden\u2460"}],"title":"1. Introduction"}],"url":"https://www.w3.org/TR/page-visibility-2/#dom-document-hidden"},
"b262501e": {"dfnID":"b262501e","dfnText":"reject","external":true,"refSections":[{"refs":[{"id":"ref-for-reject"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-reject\u2460"},{"id":"ref-for-reject\u2461"},{"id":"ref-for-reject\u2462"},{"id":"ref-for-reject\u2463"},{"id":"ref-for-reject\u2464"},{"id":"ref-for-reject\u2465"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#reject"},
"b75bb3bd": {"dfnID":"b75bb3bd","dfnText":"SecureContext","external":true,"refSections":[{"refs":[{"id":"ref-for-SecureContext"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#SecureContext"},
"ba556545": {"dfnID":"ba556545","dfnText":"NotAllowedError","external":true,"refSections":[{"refs":[{"id":"ref-for-notallowederror"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-notallowederror\u2460"},{"id":"ref-for-notallowederror\u2461"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#notallowederror"},
"bdbd19d1": {"dfnID":"bdbd19d1","dfnText":"Promise","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-promise"},{"id":"ref-for-idl-promise\u2460"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#idl-promise"},
"c01cbda0": {"dfnID":"c01cbda0","dfnText":"EnforceRange","external":true,"refSections":[{"refs":[{"id":"ref-for-EnforceRange"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#EnforceRange"},
"c15f1628": {"dfnID":"c15f1628","dfnText":"internal slot","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-object-internal-methods-and-internal-slots"},{"id":"ref-for-sec-object-internal-methods-and-internal-slots\u2460"}],"title":"2.4. The IdleDetector interface"}],"url":"https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots"},
"cc890cc1": {"dfnID":"cc890cc1","dfnText":"policy-controlled feature","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature"}],"title":"2.3. Permissions policy"},{"refs":[{"id":"ref-for-policy-controlled-feature\u2460"}],"title":"2.4.5. start() method"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"cca3cdb2": {"dfnID":"cca3cdb2","dfnText":"AbortSignal","external":true,"refSections":[{"refs":[{"id":"ref-for-abortsignal"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-abortsignal\u2460"}],"title":"2.4.5. start() method"}],"url":"https://dom.spec.whatwg.org/#abortsignal"},
"d124397f": {"dfnID":"d124397f","dfnText":"permission state","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-state"}],"title":"2.4.5. start() method"}],"url":"https://w3c.github.io/permissions/#dfn-permission-state"},
"d25dfb2c": {"dfnID":"d25dfb2c","dfnText":"AbortError","external":true,"refSections":[{"refs":[{"id":"ref-for-aborterror"},{"id":"ref-for-aborterror\u2460"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#aborterror"},
"d357c753": {"dfnID":"d357c753","dfnText":"requesting permission to use","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-request-permission-to-use"}],"title":"2.4.4. requestPermission() method"}],"url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"dacde8b5": {"dfnID":"dacde8b5","dfnText":"a new promise","external":true,"refSections":[{"refs":[{"id":"ref-for-a-new-promise"},{"id":"ref-for-a-new-promise\u2460"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-a-new-promise\u2461"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"dca2de17": {"dfnID":"dca2de17","dfnText":"DOMException","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMException"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-idl-DOMException\u2460"},{"id":"ref-for-idl-DOMException\u2461"},{"id":"ref-for-idl-DOMException\u2462"},{"id":"ref-for-idl-DOMException\u2463"},{"id":"ref-for-idl-DOMException\u2464"}],"title":"2.4.5. start() method"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"dictdef-idleoptions": {"dfnID":"dictdef-idleoptions","dfnText":"IdleOptions","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-idleoptions"}],"title":"2.4. The IdleDetector interface"}],"url":"#dictdef-idleoptions"},
"dom-idledetector-idledetector": {"dfnID":"dom-idledetector-idledetector","dfnText":"constructor","external":false,"refSections":[],"url":"#dom-idledetector-idledetector"},
"dom-idledetector-onchange": {"dfnID":"dom-idledetector-onchange","dfnText":"onchange","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-onchange"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-dom-idledetector-onchange\u2460"}],"title":"2.4.3. onchange attribute"}],"url":"#dom-idledetector-onchange"},
"dom-idledetector-requestpermission": {"dfnID":"dom-idledetector-requestpermission","dfnText":"requestPermission()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-requestpermission"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-dom-idledetector-requestpermission\u2460"}],"title":"2.4.4. requestPermission() method"}],"url":"#dom-idledetector-requestpermission"},
"dom-idledetector-screenstate": {"dfnID":"dom-idledetector-screenstate","dfnText":"screenState","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-screenstate"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-dom-idledetector-screenstate\u2460"}],"title":"2.4.2. screenState attribute"},{"refs":[{"id":"ref-for-dom-idledetector-screenstate\u2461"}],"title":"2.4.5. start() method"}],"url":"#dom-idledetector-screenstate"},
"dom-idledetector-screenstate-slot": {"dfnID":"dom-idledetector-screenstate-slot","dfnText":"[[screenState]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-screenstate-slot"}],"title":"2.4.2. screenState attribute"},{"refs":[{"id":"ref-for-dom-idledetector-screenstate-slot\u2460"},{"id":"ref-for-dom-idledetector-screenstate-slot\u2461"},{"id":"ref-for-dom-idledetector-screenstate-slot\u2462"},{"id":"ref-for-dom-idledetector-screenstate-slot\u2463"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-idledetector-screenstate-slot"},
"dom-idledetector-start": {"dfnID":"dom-idledetector-start","dfnText":"start(options)","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-start"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-dom-idledetector-start\u2460"},{"id":"ref-for-dom-idledetector-start\u2461"},{"id":"ref-for-dom-idledetector-start\u2462"}],"title":"2.4.5. start() method"}],"url":"#dom-idledetector-start"},
"dom-idledetector-start-options-options": {"dfnID":"dom-idledetector-start-options-options","dfnText":"options","external":false,"refSections":[],"url":"#dom-idledetector-start-options-options"},
"dom-idledetector-state-slot": {"dfnID":"dom-idledetector-state-slot","dfnText":"[[state]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-state-slot"},{"id":"ref-for-dom-idledetector-state-slot\u2460"},{"id":"ref-for-dom-idledetector-state-slot\u2461"},{"id":"ref-for-dom-idledetector-state-slot\u2462"},{"id":"ref-for-dom-idledetector-state-slot\u2463"},{"id":"ref-for-dom-idledetector-state-slot\u2464"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-dom-idledetector-state-slot\u2465"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-idledetector-state-slot"},
"dom-idledetector-threshold-slot": {"dfnID":"dom-idledetector-threshold-slot","dfnText":"[[threshold]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-threshold-slot"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-dom-idledetector-threshold-slot\u2460"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-idledetector-threshold-slot"},
"dom-idledetector-userstate": {"dfnID":"dom-idledetector-userstate","dfnText":"userState","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-userstate"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-dom-idledetector-userstate\u2460"}],"title":"2.4.1. userState attribute"},{"refs":[{"id":"ref-for-dom-idledetector-userstate\u2461"}],"title":"2.4.5. start() method"}],"url":"#dom-idledetector-userstate"},
"dom-idledetector-userstate-slot": {"dfnID":"dom-idledetector-userstate-slot","dfnText":"[[userState]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idledetector-userstate-slot"}],"title":"2.4.1. userState attribute"},{"refs":[{"id":"ref-for-dom-idledetector-userstate-slot\u2460"},{"id":"ref-for-dom-idledetector-userstate-slot\u2461"},{"id":"ref-for-dom-idledetector-userstate-slot\u2462"},{"id":"ref-for-dom-idledetector-userstate-slot\u2463"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-idledetector-userstate-slot"},
"dom-idleoptions-signal": {"dfnID":"dom-idleoptions-signal","dfnText":"signal","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idleoptions-signal"},{"id":"ref-for-dom-idleoptions-signal\u2460"},{"id":"ref-for-dom-idleoptions-signal\u2461"}],"title":"2.4.5. start() method"}],"url":"#dom-idleoptions-signal"},
"dom-idleoptions-threshold": {"dfnID":"dom-idleoptions-threshold","dfnText":"threshold","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-idleoptions-threshold"},{"id":"ref-for-dom-idleoptions-threshold\u2460"}],"title":"2.1.1. The UserIdleState enum"},{"refs":[{"id":"ref-for-dom-idleoptions-threshold\u2461"},{"id":"ref-for-dom-idleoptions-threshold\u2462"}],"title":"2.4.5. start() method"}],"url":"#dom-idleoptions-threshold"},
"dom-permissionname-idle-detection": {"dfnID":"dom-permissionname-idle-detection","dfnText":"\"idle-detection\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-permissionname-idle-detection"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-dom-permissionname-idle-detection\u2460"},{"id":"ref-for-dom-permissionname-idle-detection\u2461"}],"title":"3.1. Cross-origin information leakage"},{"refs":[{"id":"ref-for-dom-permissionname-idle-detection\u2462"}],"title":"3.3. User coercion"}],"url":"#dom-permissionname-idle-detection"},
"dom-screenidlestate-locked": {"dfnID":"dom-screenidlestate-locked","dfnText":"\"locked\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-screenidlestate-locked"}],"title":"2.1.2. The ScreenIdleState enum"},{"refs":[{"id":"ref-for-dom-screenidlestate-locked\u2460"},{"id":"ref-for-dom-screenidlestate-locked\u2461"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-screenidlestate-locked"},
"dom-screenidlestate-unlocked": {"dfnID":"dom-screenidlestate-unlocked","dfnText":"\"unlocked\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-screenidlestate-unlocked"}],"title":"2.1.2. The ScreenIdleState enum"},{"refs":[{"id":"ref-for-dom-screenidlestate-unlocked\u2460"},{"id":"ref-for-dom-screenidlestate-unlocked\u2461"}],"title":"2.4.6. Reacting to state changes"}],"url":"#dom-screenidlestate-unlocked"},
"dom-useridlestate-active": {"dfnID":"dom-useridlestate-active","dfnText":"\"active\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-useridlestate-active"}],"title":"2.1.1. The UserIdleState enum"},{"refs":[{"id":"ref-for-dom-useridlestate-active\u2460"},{"id":"ref-for-dom-useridlestate-active\u2461"}],"title":"2.4.6. Reacting to state changes"},{"refs":[{"id":"ref-for-dom-useridlestate-active\u2462"}],"title":"3.2. Behavior tracking"}],"url":"#dom-useridlestate-active"},
"dom-useridlestate-idle": {"dfnID":"dom-useridlestate-idle","dfnText":"\"idle\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-useridlestate-idle"}],"title":"2.1.1. The UserIdleState enum"},{"refs":[{"id":"ref-for-dom-useridlestate-idle\u2460"},{"id":"ref-for-dom-useridlestate-idle\u2461"}],"title":"2.4.6. Reacting to state changes"},{"refs":[{"id":"ref-for-dom-useridlestate-idle\u2462"}],"title":"3.2. Behavior tracking"}],"url":"#dom-useridlestate-idle"},
"e99bd18e": {"dfnID":"e99bd18e","dfnText":"relevant global object","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-relevant-global"},{"id":"ref-for-concept-relevant-global\u2460"}],"title":"2.4.4. requestPermission() method"},{"refs":[{"id":"ref-for-concept-relevant-global\u2461"},{"id":"ref-for-concept-relevant-global\u2462"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-concept-relevant-global\u2463"},{"id":"ref-for-concept-relevant-global\u2464"},{"id":"ref-for-concept-relevant-global\u2465"},{"id":"ref-for-concept-relevant-global\u2466"}],"title":"2.4.6. Reacting to state changes"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"enumdef-screenidlestate": {"dfnID":"enumdef-screenidlestate","dfnText":"ScreenIdleState","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-screenidlestate"}],"title":"2.1.2. The ScreenIdleState enum"},{"refs":[{"id":"ref-for-enumdef-screenidlestate\u2460"}],"title":"2.4. The IdleDetector interface"}],"url":"#enumdef-screenidlestate"},
"enumdef-useridlestate": {"dfnID":"enumdef-useridlestate","dfnText":"UserIdleState","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-useridlestate"}],"title":"2.1.1. The UserIdleState enum"},{"refs":[{"id":"ref-for-enumdef-useridlestate\u2460"}],"title":"2.4. The IdleDetector interface"}],"url":"#enumdef-useridlestate"},
"f0951476": {"dfnID":"f0951476","dfnText":"EventHandler","external":true,"refSections":[{"refs":[{"id":"ref-for-eventhandler"}],"title":"2.4. The IdleDetector interface"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"},
"f14b47b8": {"dfnID":"f14b47b8","dfnText":"unsigned long long","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-unsigned-long-long"}],"title":"2.4. The IdleDetector interface"}],"url":"https://webidl.spec.whatwg.org/#idl-unsigned-long-long"},
"idle-detection-task-source": {"dfnID":"idle-detection-task-source","dfnText":"idle detection task source","external":false,"refSections":[{"refs":[{"id":"ref-for-idle-detection-task-source"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-idle-detection-task-source\u2460"},{"id":"ref-for-idle-detection-task-source\u2461"},{"id":"ref-for-idle-detection-task-source\u2462"},{"id":"ref-for-idle-detection-task-source\u2463"}],"title":"2.4.6. Reacting to state changes"}],"url":"#idle-detection-task-source"},
"idledetector": {"dfnID":"idledetector","dfnText":"IdleDetector","external":false,"refSections":[{"refs":[{"id":"ref-for-idledetector"},{"id":"ref-for-idledetector\u2460"},{"id":"ref-for-idledetector\u2461"}],"title":"2.4. The IdleDetector interface"},{"refs":[{"id":"ref-for-idledetector\u2462"},{"id":"ref-for-idledetector\u2463"}],"title":"2.4.5. start() method"},{"refs":[{"id":"ref-for-idledetector\u2464"}],"title":"2.4.6. Reacting to state changes"}],"url":"#idledetector"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-position-annos */
"use strict";
{
function repositionAnnoPanels(){
    const panels = [...document.querySelectorAll("[data-anno-for]")];
    hydratePanels(panels);
    let vSoFar = 0;
    for(const panel of panels.sort(cmpTops)) {
        if(panel.top < vSoFar) {
            panel.top = vSoFar;
            panel.style.top = vSoFar + "px";
        }
        vSoFar = panel.top + panel.height + 15;
    }
}
function hydratePanels(panels) {
    const main = document.querySelector("main");
    let mainRect;
    if(main) mainRect = main.getBoundingClientRect();
    // First display them all, if they're not already visible.
    for(const panel of panels) {
        panel.classList.remove("unpositioned");
    }
    // Measure them all
    for(const panel of panels) {
        const dfn = document.getElementById(panel.getAttribute("data-anno-for"));
        if(!dfn) {
            console.log("Can't find the annotation panel target:", panel);
            continue;
        }
        panel.dfn = dfn;
        panel.top = window.scrollY + dfn.getBoundingClientRect().top;
        let panelRect = panel.getBoundingClientRect();
        panel.height = panelRect.height;
        if(main) {
            panel.overlappingMain = panelRect.left < mainRect.right;
        } else {
            panel.overlappingMain = false;
        }
    }
    // And finally position them
    for(const panel of panels) {
        const dfn = panel.dfn;
        if(!dfn) continue;
        panel.style.top = panel.top + "px";
        panel.classList.toggle("overlapping-main", panel.overlappingMain);
    }
}

function cmpTops(a,b) {
    return a.top - b.top;
}

window.addEventListener("load", repositionAnnoPanels);
window.addEventListener("resize", repositionAnnoPanels);
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#dictdef-idleoptions": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"IdleOptions","type":"dictionary","url":"#dictdef-idleoptions"},
"#dom-idledetector-onchange": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"onchange","type":"attribute","url":"#dom-idledetector-onchange"},
"#dom-idledetector-requestpermission": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"requestPermission()","type":"method","url":"#dom-idledetector-requestpermission"},
"#dom-idledetector-screenstate": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"screenState","type":"attribute","url":"#dom-idledetector-screenstate"},
"#dom-idledetector-screenstate-slot": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"[[screenState]]","type":"attribute","url":"#dom-idledetector-screenstate-slot"},
"#dom-idledetector-start": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"start(options)","type":"method","url":"#dom-idledetector-start"},
"#dom-idledetector-state-slot": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"[[state]]","type":"attribute","url":"#dom-idledetector-state-slot"},
"#dom-idledetector-threshold-slot": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"[[threshold]]","type":"attribute","url":"#dom-idledetector-threshold-slot"},
"#dom-idledetector-userstate": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"userState","type":"attribute","url":"#dom-idledetector-userstate"},
"#dom-idledetector-userstate-slot": {"export":true,"for_":["IdleDetector"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"[[userState]]","type":"attribute","url":"#dom-idledetector-userstate-slot"},
"#dom-idleoptions-signal": {"export":true,"for_":["IdleOptions"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"signal","type":"dict-member","url":"#dom-idleoptions-signal"},
"#dom-idleoptions-threshold": {"export":true,"for_":["IdleOptions"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"threshold","type":"dict-member","url":"#dom-idleoptions-threshold"},
"#dom-permissionname-idle-detection": {"export":true,"for_":["PermissionName"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"\"idle-detection\"","type":"enum-value","url":"#dom-permissionname-idle-detection"},
"#dom-screenidlestate-locked": {"export":true,"for_":["ScreenIdleState"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"\"locked\"","type":"enum-value","url":"#dom-screenidlestate-locked"},
"#dom-screenidlestate-unlocked": {"export":true,"for_":["ScreenIdleState"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"\"unlocked\"","type":"enum-value","url":"#dom-screenidlestate-unlocked"},
"#dom-useridlestate-active": {"export":true,"for_":["UserIdleState"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"\"active\"","type":"enum-value","url":"#dom-useridlestate-active"},
"#dom-useridlestate-idle": {"export":true,"for_":["UserIdleState"],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"\"idle\"","type":"enum-value","url":"#dom-useridlestate-idle"},
"#enumdef-screenidlestate": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"ScreenIdleState","type":"enum","url":"#enumdef-screenidlestate"},
"#enumdef-useridlestate": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"UserIdleState","type":"enum","url":"#enumdef-useridlestate"},
"#idle-detection-task-source": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"idle detection task source","type":"dfn","url":"#idle-detection-task-source"},
"#idledetector": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"idle-detection","spec":"idle-detection-1","status":"local","text":"IdleDetector","type":"interface","url":"#idledetector"},
"https://dom.spec.whatwg.org/#abortsignal": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"AbortSignal","type":"interface","url":"https://dom.spec.whatwg.org/#abortsignal"},
"https://dom.spec.whatwg.org/#abortsignal-add": {"export":true,"for_":["AbortSignal"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"add","type":"dfn","url":"https://dom.spec.whatwg.org/#abortsignal-add"},
"https://dom.spec.whatwg.org/#concept-event-fire": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"fire an event","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-event-fire"},
"https://dom.spec.whatwg.org/#eventtarget": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"EventTarget","type":"interface","url":"https://dom.spec.whatwg.org/#eventtarget"},
"https://fetch.spec.whatwg.org/#dom-requestdestination-iframe": {"export":true,"for_":["RequestDestination"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"\"iframe\"","type":"enum-value","url":"https://fetch.spec.whatwg.org/#dom-requestdestination-iframe"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"allowed to use","type":"dfn","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"https://html.spec.whatwg.org/multipage/indices.html#event-change": {"export":true,"for_":["HTMLElement"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"change","type":"event","url":"https://html.spec.whatwg.org/multipage/indices.html#event-change"},
"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"in parallel","type":"dfn","url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"transient activation","type":"dfn","url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"associated document","type":"dfn","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant global object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"event handler idl attribute","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes"},
"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"EventHandler","type":"typedef","url":"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"},
"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onkeypress": {"export":true,"for_":["HTMLElement","Document","Window","GlobalEventHandlers"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"onkeypress","type":"attribute","url":"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onkeypress"},
"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onmousemove": {"export":true,"for_":["HTMLElement","Document","Window","GlobalEventHandlers"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"onmousemove","type":"attribute","url":"https://html.spec.whatwg.org/multipage/webappapis.html#handler-onmousemove"},
"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"queue a global task","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"https://infra.spec.whatwg.org/#abort-when": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"abort when","type":"dfn","url":"https://infra.spec.whatwg.org/#abort-when"},
"https://infra.spec.whatwg.org/#user-agent": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"user agent","type":"dfn","url":"https://infra.spec.whatwg.org/#user-agent"},
"https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ecmascript","spec":"ecmascript","status":"anchor-block","text":"internal slot","type":"dfn","url":"https://tc39.github.io/ecma262/#sec-object-internal-methods-and-internal-slots"},
"https://w3c.github.io/permissions/#dfn-permission-state": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission state","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-state"},
"https://w3c.github.io/permissions/#dfn-powerful-feature": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"powerful feature","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-powerful-feature"},
"https://w3c.github.io/permissions/#dfn-request-permission-to-use": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"requesting permission to use","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"https://w3c.github.io/permissions/#dom-permissionstate": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"PermissionState","type":"enum","url":"https://w3c.github.io/permissions/#dom-permissionstate"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"policy-controlled feature","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist": {"export":true,"for_":["policy-controlled feature"],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"default allowlist","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"https://webidl.spec.whatwg.org/#EnforceRange": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"EnforceRange","type":"extended-attribute","url":"https://webidl.spec.whatwg.org/#EnforceRange"},
"https://webidl.spec.whatwg.org/#Exposed": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Exposed","type":"extended-attribute","url":"https://webidl.spec.whatwg.org/#Exposed"},
"https://webidl.spec.whatwg.org/#SecureContext": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"SecureContext","type":"extended-attribute","url":"https://webidl.spec.whatwg.org/#SecureContext"},
"https://webidl.spec.whatwg.org/#a-new-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"a new promise","type":"dfn","url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"https://webidl.spec.whatwg.org/#aborterror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"AbortError","type":"exception","url":"https://webidl.spec.whatwg.org/#aborterror"},
"https://webidl.spec.whatwg.org/#exceptiondef-typeerror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"TypeError","type":"exception","url":"https://webidl.spec.whatwg.org/#exceptiondef-typeerror"},
"https://webidl.spec.whatwg.org/#idl-DOMException": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMException","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"https://webidl.spec.whatwg.org/#idl-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Promise","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-promise"},
"https://webidl.spec.whatwg.org/#idl-undefined": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"undefined","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"https://webidl.spec.whatwg.org/#idl-unsigned-long-long": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"unsigned long long","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-unsigned-long-long"},
"https://webidl.spec.whatwg.org/#invalidstateerror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"InvalidStateError","type":"exception","url":"https://webidl.spec.whatwg.org/#invalidstateerror"},
"https://webidl.spec.whatwg.org/#notallowederror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"NotAllowedError","type":"exception","url":"https://webidl.spec.whatwg.org/#notallowederror"},
"https://webidl.spec.whatwg.org/#reject": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"reject","type":"dfn","url":"https://webidl.spec.whatwg.org/#reject"},
"https://webidl.spec.whatwg.org/#resolve": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"resolve","type":"dfn","url":"https://webidl.spec.whatwg.org/#resolve"},
"https://webidl.spec.whatwg.org/#this": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"this","type":"dfn","url":"https://webidl.spec.whatwg.org/#this"},
"https://www.w3.org/TR/page-visibility-2/#dom-document-hidden": {"export":true,"for_":["Document"],"level":"2","normative":true,"shortname":"page-visibility","spec":"page-visibility-2","status":"anchor-block","text":"hidden","type":"attribute","url":"https://www.w3.org/TR/page-visibility-2/#dom-document-hidden"},
"https://www.w3.org/TR/page-visibility-2/#dom-document-onvisibilitychange": {"export":true,"for_":["Document"],"level":"2","normative":true,"shortname":"page-visibility","spec":"page-visibility-2","status":"anchor-block","text":"onvisibilitychange","type":"attribute","url":"https://www.w3.org/TR/page-visibility-2/#dom-document-onvisibilitychange"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>
<script>/* Boilerplate: script-wpt */
"use strict";
{
let wptData = {
"paths": ["/idle-detection/"],
};

document.addEventListener("DOMContentLoaded", async ()=>{
    if(wptData.paths.length == 0) return;

    const runsUrl = "https://wpt.fyi/api/runs?label=master&label=stable&max-count=1&product=chrome&product=firefox&product=safari&product=edge";
    const runs = await (await fetch(runsUrl)).json();

    let testResults = [];
    for(const pathPrefix of wptData.paths) {
        const pathResults = await (await fetch("https://wpt.fyi/api/search", {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
            },
            body: JSON.stringify({
                "run_ids": runs.map(x=>x.id),
                "query": {"path": pathPrefix},
            })
        })).json();
        testResults = testResults.concat(pathResults.results);
    }

    const browsers = runs.map(x=>({name:x.browser_name, version:x.browser_version, passes:0, total: 0}));
    const resultsFromPath = new Map(testResults.map(result=>{
        const testPath = result.test;
        const passes = result.legacy_status.map(x=>[x.passes, x.total]);
        return [testPath, passes];
    }));
    const seenTests = new Set();
    document.querySelectorAll(".wpt-name").forEach(nameEl=>{
        const passData = resultsFromPath.get("/" + nameEl.getAttribute("title"));
        if(!passData) {
            console.log("Couldn't find test in results:", nameEl);
            return
        }
        const numTests = passData[0][1];
        if(numTests > 1) {
            nameEl.insertAdjacentElement("beforeend",
                mk.small({}, ` (${numTests} tests)`));
        }
        if(passData == undefined) return;
        const resultsEl = mk.span({"class":"wpt-results"},
            ...passData.map((p,i) => mk.span(
            {
                "title": `${browsers[i].name} ${p[0]}/${p[1]}`,
                "class": "wpt-result",
                "style": `background: conic-gradient(forestgreen ${p[0]/p[1]*360}deg, darkred 0deg);`,
            })),
        );
        nameEl.insertAdjacentElement("afterend", resultsEl);

        // Only update the summary pass/total count if we haven't seen this
        // test before, to support authors listing the same test multiple times
        // in a spec.
        if (!seenTests.has(nameEl.getAttribute("title"))) {
            seenTests.add(nameEl.getAttribute("title"));
            passData.forEach((p,i) => {
                browsers[i].passes += p[0];
                browsers[i].total += p[1];
            });
        }
    });
    const overview = document.querySelector(".wpt-overview");
    if(overview) {
        overview.appendChild(mk.ul({}, ...browsers.map(formatWptResult)));
        document.head.appendChild(mk.style({},
            `.wpt-overview ul { display: flex; flex-flow: row wrap; gap: .2em; justify-content: start; list-style: none; padding: 0; margin: 0;}
             .wpt-overview li { padding: .25em 1em; color: black; text-align: center; }
             .wpt-overview img { height: 1.5em; height: max(1.5em, 32px); background: transparent; }
             .wpt-overview .browser { font-weight: bold; }
             .wpt-overview .passes-none { background: #e57373; }
             .wpt-overview .passes-hardly { background: #ffb74d; }
             .wpt-overview .passes-a-few { background: #ffd54f; }
             .wpt-overview .passes-half { background: #fff176; }
             .wpt-overview .passes-lots { background: #dce775; }
             .wpt-overview .passes-most { background: #aed581; }
             .wpt-overview .passes-all { background: #81c784; }`));
    }
});

function formatWptResult({name, version, passes, total}) {
    const passRate = passes/total;
    let passClass = "";
    if(passRate == 0)      passClass = "passes-none";
    else if(passRate < .2) passClass = "passes-hardly";
    else if(passRate < .4) passClass = "passes-a-few";
    else if(passRate < .6) passClass = "passes-half";
    else if(passRate < .8) passClass = "passes-lots";
    else if(passRate < 1)  passClass = "passes-most";
    else                   passClass = "passes-all";

    name = name[0].toUpperCase() + name.slice(1);
    const shortVersion = /^\d+/.exec(version);
    const icon = []

    if(name == "Chrome") icon.push(mk.img({alt:"", src:"https://wpt.fyi/static/chrome_64x64.png"}));
    if(name == "Edge") icon.push(mk.img({alt:"", src:"https://wpt.fyi/static/edge_64x64.png"}));
    if(name == "Safari") icon.push(mk.img({alt:"", src:"https://wpt.fyi/static/safari_64x64.png"}));
    if(name == "Firefox") icon.push(mk.img({alt:"", src:"https://wpt.fyi/static/firefox_64x64.png"}));

    return mk.li({"class":passClass},
        mk.nobr({'class':'browser'}, ...icon, ` ${name} ${shortVersion}`),
        mk.br(),
        mk.nobr({'class':'pass-rate'}, `${passes}/${total}`)
    );
}
}
</script>