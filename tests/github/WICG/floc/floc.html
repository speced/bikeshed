<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Federated Learning of Cohorts</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/floc/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Federated Learning of Cohorts</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/floc/">https://wicg.github.io/floc/</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:yaoxia@chromium.org">Yao Xiao</a> (<span class="p-org org">Google</span>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:jkarlin@chromium.org">Josh Karlin</a> (<span class="p-org org">Google</span>)
     <dt>Participate:
     <dd><a href="https://github.com/WICG/floc">GitHub WICG/floc</a> (<a href="https://github.com/WICG/floc/issues/new">new issue</a>, <a href="https://github.com/WICG/floc/issues?state=open">open issues</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 the Contributors to the Federated Learning of Cohorts Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification describes a method that could enable ad-targeting based on the people’s general browsing interest without exposing the exact browsing history.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#interest-cohort-section"><span class="secno">2</span> <span class="content">Interest cohort</span></a>
    <li><a href="#the-api"><span class="secno">3</span> <span class="content">The API</span></a>
    <li><a href="#interpretation"><span class="secno">4</span> <span class="content">Interpretation</span></a>
    <li>
     <a href="#cohort-assignment-algorithm"><span class="secno">5</span> <span class="content">Cohort assignment algorithm</span></a>
     <ol class="toc">
      <li><a href="#input-and-output"><span class="secno">5.1</span> <span class="content">Input and output</span></a>
      <li><a href="#caching-the-result"><span class="secno">5.2</span> <span class="content">Caching the result</span></a>
      <li>
       <a href="#privacy-guarantees"><span class="secno">5.3</span> <span class="content">Privacy guarantees</span></a>
       <ol class="toc">
        <li><a href="#anonymity"><span class="secno">5.3.1</span> <span class="content">Anonymity</span></a>
        <li><a href="#no-browsing-history-recovering-from-cohorts"><span class="secno">5.3.2</span> <span class="content">No browsing history recovering from cohorts</span></a>
        <li><a href="#no-sensitive-cohorts"><span class="secno">5.3.3</span> <span class="content">No sensitive cohorts</span></a>
       </ol>
     </ol>
    <li><a href="#permissions-policy-integration"><span class="secno">6</span> <span class="content">Permissions policy integration</span></a>
    <li>
     <a href="#privacy-considerations"><span class="secno">7</span> <span class="content">Privacy considerations</span></a>
     <ol class="toc">
      <li>
       <a href="#permission"><span class="secno">7.1</span> <span class="content">Permission</span></a>
       <ol class="toc">
        <li><a href="#compute-eligibility"><span class="secno">7.1.1</span> <span class="content">Eligibility for a page to be included in the interest cohort computation</span></a>
        <li><a href="#access-eligibility"><span class="secno">7.1.2</span> <span class="content">Permission to access the interest cohort</span></a>
        <li><a href="#private-browsing-mode"><span class="secno">7.1.3</span> <span class="content">Private browsing / Incognito mode</span></a>
        <li><a href="#adoption-phase"><span class="secno">7.1.4</span> <span class="content">Adoption phase</span></a>
       </ol>
      <li><a href="#sensitive-information"><span class="secno">7.2</span> <span class="content">Sensitive information</span></a>
      <li><a href="#tracking-people-via-their-interest-cohort"><span class="secno">7.3</span> <span class="content">Tracking people via their interest cohort</span></a>
      <li><a href="#recovering-the-browsing-history-from-cohorts"><span class="secno">7.4</span> <span class="content">Recovering the browsing history from cohorts</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
    <p>In today’s web, people’s interests are typically inferred based on observing what sites or pages they visit, which relies on tracking techniques like third-party cookies or less-transparent mechanisms like device fingerprinting. It would be better for privacy if interest-based advertising could be accomplished without needing to collect a particular individual’s browsing history.</p>
    <p>This specification provides an API to enable ad-targeting based on the people’s general browsing interest, without exposing the exact browsing history.</p>
    <div class="example" id="example-d5ba1303">
     <a class="self-link" href="#example-d5ba1303"></a> Creating an ad based on the interest cohort: 
<pre class="lang-js highlight"><c- a>const</c-> cohort <c- o>=</c-> <c- k>await</c-> document<c- p>.</c->interestCohort<c- p>();</c->
<c- a>const</c-> url <c- o>=</c-> <c- ow>new</c-> URL<c- p>(</c-><c- u>"https://ads.example/getCreative"</c-><c- p>);</c->
url<c- p>.</c->searchParams<c- p>.</c->append<c- p>(</c-><c- u>"cohort_id"</c-><c- p>,</c-> cohort<c- p>.</c->id<c- p>);</c->
url<c- p>.</c->searchParams<c- p>.</c->append<c- p>(</c-><c- u>"cohort_version"</c-><c- p>,</c-> cohort<c- p>.</c->version<c- p>);</c->
<c- a>const</c-> creative <c- o>=</c-> <c- k>await</c-> fetch<c- p>(</c->url<c- p>);</c->
</pre>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="interest-cohort-section"><span class="secno">2. </span><span class="content">Interest cohort</span><a class="self-link" href="#interest-cohort-section"></a></h2>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="interest-cohort">interest cohort</dfn> is a user’s assigned interest group under a particular <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a>. An interest cohort comprises an <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id">interest cohort id</a> and an <a data-link-type="dfn" href="#interest-cohort-version" id="ref-for-interest-cohort-version">interest cohort version</a>.</p>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="interest-cohort-id">interest cohort id</dfn> represents the interest group that the user is assigned to by the <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a>. The total number of groups should not exceed 2^32, and each group can mapped to a 32 bit integer. The interest cohort id can be invalid, which means no group is assigned.</p>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="string-representation-of-the-interest-cohort-id">string representation of the interest cohort id</dfn> is the string representation of the mapped integer of the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①">interest cohort id</a> in decimal (e.g. “17319”). If the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id②">interest cohort id</a> is invalid, the string representation will be an empty string.</p>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="interest-cohort-version">interest cohort version</dfn> identifies the <a href="#cohort-assignment-algorithm">algorithm</a> used to compute the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id③">interest cohort id</a>.</p>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="string-representation-of-the-interest-cohort-version">string representation of the interest cohort version</dfn> is <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a>. It’s recommended that the browser vendor name is part of the version (e.g. “chrome.2.1”, “v21/mozilla”), so that when exposed to the Web, there won’t be naming collisions across browser vendors. As an exception, if two browsers choose to deliberately use the same cohort assignment algorithm, they should pick some other way to give it an unambiguous name and avoid collisions.</p>
    <p>The <code class="idl"><a data-link-type="idl" href="#dictdef-interestcohort" id="ref-for-dictdef-interestcohort">InterestCohort</a></code> dictionary is used to contain the <a data-link-type="dfn" href="#string-representation-of-the-interest-cohort-id" id="ref-for-string-representation-of-the-interest-cohort-id">string representation of the interest cohort id</a> and the <a data-link-type="dfn" href="#string-representation-of-the-interest-cohort-version" id="ref-for-string-representation-of-the-interest-cohort-version">string representation of the interest cohort version</a>.</p>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-interestcohort"><code><c- g>InterestCohort</c-></code></dfn> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="InterestCohort" data-dfn-type="dict-member" data-export data-type="DOMString" id="dom-interestcohort-id"><code><c- g>id</c-></code></dfn>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString①"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="InterestCohort" data-dfn-type="dict-member" data-export data-type="DOMString" id="dom-interestcohort-version"><code><c- g>version</c-></code></dfn>;
};
</pre>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="the-api"><span class="secno">3. </span><span class="content">The API</span><a class="self-link" href="#the-api"></a></h2>
    <p>The interest cohort API lives under the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> interface since the access permission is tied to the document scope, and the API is only available if the document is in <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context">secure context</a>.</p>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①"><c- g>Document</c-></a> {
    <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-interestcohort" id="ref-for-dictdef-interestcohort①"><c- n>InterestCohort</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-interestcohort" id="ref-for-dom-document-interestcohort"><c- g>interestCohort</c-></a>();
};
</pre>
    <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-interestcohort"><code>interestCohort()</code></dfn> method steps are:</p>
    <ol>
     <li data-md>
      <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise">a new promise</a>.</p>
     <li data-md>
      <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">in parallel</a>:</p>
      <ol>
       <li data-md>
        <p>If any of the following is true:</p>
        <ul>
         <li data-md>
          <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this">this</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use">allowed to use</a> the "<code><a href="#interest-cohort-policy-controlled-feature" id="ref-for-interest-cohort-policy-controlled-feature">interest-cohort</a></code>" feature.</p>
         <li data-md>
          <p>The document is not allowed to access the interest cohort per user preference settings.</p>
         <li data-md>
          <p>The user agent believes that too many high-entropy bits of information have already been consumed by the given document, and exposing an interest cohort would violate a privacy budget.</p>
         <li data-md>
          <p>The <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a> is unavailable.</p>
        </ul>
        <p>then:</p>
        <ol>
         <li data-md>
          <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">Queue a global task</a> on the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="interest-cohort-task-source">interest cohort task source</dfn> given <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this①">this</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global">relevant global object</a> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code>.</p>
         <li data-md>
          <p>Abort these steps.</p>
        </ol>
       <li data-md>
        <p>Let <var>id</var> be <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id④">interest cohort id</a> from running the <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a>.</p>
       <li data-md>
        <p>Let <var>version</var> be the <a data-link-type="dfn" href="#interest-cohort-version" id="ref-for-interest-cohort-version①">interest cohort version</a> corresponding to the <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task①">Queue a global task</a> on the <a data-link-type="dfn" href="#interest-cohort-task-source" id="ref-for-interest-cohort-task-source">interest cohort task source</a> given <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this②">this</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global①">relevant global object</a> to perform the following steps:</p>
        <ol>
         <li data-md>
          <p>Let <var>d</var> be the <code class="idl"><a data-link-type="idl" href="#dictdef-interestcohort" id="ref-for-dictdef-interestcohort②">InterestCohort</a></code> dictionary, with <code class="idl"><a data-link-type="idl" href="#dom-interestcohort-id" id="ref-for-dom-interestcohort-id">id</a></code> being the <a href="#string-representation-of-the-interest-cohort-id" id="ref-for-string-representation-of-the-interest-cohort-id①">string representation</a> of <var>id</var>, and <code class="idl"><a data-link-type="idl" href="#dom-interestcohort-version" id="ref-for-dom-interestcohort-version">version</a></code> being <a href="#string-representation-of-the-interest-cohort-version" id="ref-for-string-representation-of-the-interest-cohort-version①">string representation</a> of <var>version</var>.</p>
         <li data-md>
          <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">Resolve</a> <var>p</var> with <var>d</var>.</p>
        </ol>
      </ol>
     <li data-md>
      <p>Return <var>p</var>.</p>
    </ol>
   </section>
   <section>
    <h2 class="heading settled" data-level="4" id="interpretation"><span class="secno">4. </span><span class="content">Interpretation</span><a class="self-link" href="#interpretation"></a></h2>
     Organizations that wish to interpret cohorts can observe the habits of each <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort">interest cohort</a> and ad targeting can then be partly based on what group the person falls into. The browser vendors could publicly share more information about the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id⑤">interest cohort id</a> (e.g. the range of numbers, whether they have semantics, etc.) or the <a data-link-type="dfn" href="#interest-cohort-version" id="ref-for-interest-cohort-version②">interest cohort version</a> (e.g. the algorithm detail, the compatibility between versions, etc.) to help with their modeling decisions. 
   </section>
   <section>
    <h2 class="heading settled" data-level="5" id="cohort-assignment-algorithm"><span class="secno">5. </span><span class="content">Cohort assignment algorithm</span><a class="self-link" href="#cohort-assignment-algorithm"></a></h2>
     The browser could use machine learning algorithms to develop the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id⑥">interest cohort id</a> to expose to a given document. 
    <h3 class="heading settled" data-level="5.1" id="input-and-output"><span class="secno">5.1. </span><span class="content">Input and output</span><a class="self-link" href="#input-and-output"></a></h3>
     The input features to the algorithm should be based on information from the browsing history, which may include the URLs, the page contents, or other factors. 
    <p>The input features should be kept local on the browser and should not be uploaded elsewhere.</p>
    <p>The output of the algorithm is the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id⑦">interest cohort id</a>.</p>
    <h3 class="heading settled" data-level="5.2" id="caching-the-result"><span class="secno">5.2. </span><span class="content">Caching the result</span><a class="self-link" href="#caching-the-result"></a></h3>
     For performance concern and/or to mitigate the risk of <a href="#recovering-the-browsing-history-from-cohorts">recovering the browsing history from cohorts</a>, the algorithm could return a cached <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id⑧">interest cohort id</a> that was computed recently, instead of computing from scratch. 
    <h3 class="heading settled" data-level="5.3" id="privacy-guarantees"><span class="secno">5.3. </span><span class="content">Privacy guarantees</span><a class="self-link" href="#privacy-guarantees"></a></h3>
     The algorithm should have the following privacy properties. Sometimes generating an invalid <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id⑨">interest cohort id</a> may be helpful to meet these guarantees. 
    <h4 class="heading settled" data-level="5.3.1" id="anonymity"><span class="secno">5.3.1. </span><span class="content">Anonymity</span><a class="self-link" href="#anonymity"></a></h4>
     The browser should ensure that the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①⓪">interest cohort ids</a> are well distributed, so that each represents thousands of people, where a person is considered to be associated with an <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①①">interest cohort id</a> if that <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①②">interest cohort id</a> was recently computed for them. The browser may further leverage other anonymization methods, such as differential privacy. 
    <h4 class="heading settled" data-level="5.3.2" id="no-browsing-history-recovering-from-cohorts"><span class="secno">5.3.2. </span><span class="content">No browsing history recovering from cohorts</span><a class="self-link" href="#no-browsing-history-recovering-from-cohorts"></a></h4>
     The browser should ensure that the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①③">interest cohort ids</a> exposed to any given site does not reveal the browsing history. 
    <h4 class="heading settled" data-level="5.3.3" id="no-sensitive-cohorts"><span class="secno">5.3.3. </span><span class="content">No sensitive cohorts</span><a class="self-link" href="#no-sensitive-cohorts"></a></h4>
     The browser should ensure that the <a data-link-type="dfn" href="#interest-cohort-id" id="ref-for-interest-cohort-id①④">interest cohort ids</a> are not correlated with <a href="#sensitive-information">sensitive information</a>. 
   </section>
   <section>
    <h2 class="heading settled" data-level="6" id="permissions-policy-integration"><span class="secno">6. </span><span class="content">Permissions policy integration</span><a class="self-link" href="#permissions-policy-integration"></a></h2>
    <p>This specification defines a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature">policy-controlled feature</a> identified by the string
"<code><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="interest-cohort-policy-controlled-feature">interest-cohort</dfn></code>". Its <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist">default allowlist</a> is <code>*</code>. </p>
   </section>
   <section>
    <h2 class="heading settled" data-level="7" id="privacy-considerations"><span class="secno">7. </span><span class="content">Privacy considerations</span><a class="self-link" href="#privacy-considerations"></a></h2>
    <h3 class="heading settled" data-level="7.1" id="permission"><span class="secno">7.1. </span><span class="content">Permission</span><a class="self-link" href="#permission"></a></h3>
    <h4 class="heading settled" data-level="7.1.1" id="compute-eligibility"><span class="secno">7.1.1. </span><span class="content">Eligibility for a page to be included in the interest cohort computation</span><a class="self-link" href="#compute-eligibility"></a></h4>
     By default, a page is eligible for the interest cohort computation if the <code class="idl"><a data-link-type="idl" href="#dom-document-interestcohort" id="ref-for-dom-document-interestcohort①">interestCohort()</a></code> API is used in the page. 
    <p>The page can opt itself out of the interest cohort computation through the "<code><a href="#interest-cohort-policy-controlled-feature" id="ref-for-interest-cohort-policy-controlled-feature①">interest-cohort</a></code>" <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature①">policy-controlled feature</a>. <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a></p>
    <p>The user agent should offer a dedicated permission setting for the user to disallow sites from being included for interest cohort calculations.</p>
    <h4 class="heading settled" data-level="7.1.2" id="access-eligibility"><span class="secno">7.1.2. </span><span class="content">Permission to access the interest cohort</span><a class="self-link" href="#access-eligibility"></a></h4>
     The page can restrict itself or subframes from accessing the interest cohort through the "<code><a href="#interest-cohort-policy-controlled-feature" id="ref-for-interest-cohort-policy-controlled-feature②">interest-cohort</a></code>" <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature②">policy-controlled feature</a>. <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a> 
    <p><a href="#the-api">The API</a> will return a rejected promise if the user has specifically disallowed the site from accessing the <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①">interest cohort</a>.</p>
    <h4 class="heading settled" data-level="7.1.3" id="private-browsing-mode"><span class="secno">7.1.3. </span><span class="content">Private browsing / Incognito mode</span><a class="self-link" href="#private-browsing-mode"></a></h4>
     The interest cohort computation <a href="#cohort-assignment-algorithm">algorithm</a> and the <code class="idl"><a data-link-type="idl" href="#dom-document-interestcohort" id="ref-for-dom-document-interestcohort②">interestCohort()</a></code> API methods are applicable to the private browsing mode as well. That is, if the private browsing mode doesn’t save history at all, the "information from the browsing history" is expected to just be an empty set. 
    <h4 class="heading settled" data-level="7.1.4" id="adoption-phase"><span class="secno">7.1.4. </span><span class="content">Adoption phase</span><a class="self-link" href="#adoption-phase"></a></h4>
     To make the adoption easier, the user agent may relax the opt-in requirement while third-party cookies still exist. For example, pages with ads resources are an approximation of the pages that are going to opt-in to interest cohort computation in the long run. Thus, at the adoption phase, the page can be eligible to be included in the interest cohort computation if there are ads resources in the page, OR if <a href="#the-api">the API</a> is used. 
    <p>Additionally, during the adoption phase, the browser can use the existing cookie settings to approximate the interest cohort permission setting. For example, a page is not allowed to contribute to the interest cohort calculation if cookies are disallowed for that site; when cookies are cleared, previous page visits should not be used for interest cohort computation; accessing to the interest cohort within a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> should be denied if cookie access is not allowed in the document, or when third-party cookies are disallowed in general.</p>
    <h3 class="heading settled" data-level="7.2" id="sensitive-information"><span class="secno">7.2. </span><span class="content">Sensitive information</span><a class="self-link" href="#sensitive-information"></a></h3>
     An <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort②">interest cohort</a> might reveal sensitive information. As a first mitigation, the browser should remove sensitive categories from its data collection. But this does not mean sensitive information can’t be leaked. Some people are sensitive to categories that others are not, and there is no globally accepted notion of sensitive categories. 
    <p>Cohorts could be evaluated for fairness by measuring and limiting their deviation from population-level demographics with respect to the prevalence of sensitive categories, to prevent their use as proxies for a sensitive category. However, this evaluation would require knowing how many individual people in each cohort were in the sensitive categories, information which could be difficult or intrusive to obtain. As an approximation, the browser could use a mechanism for recognizing which web pages are in sensitive categories. Evaluations could also consider that what is deemed sensitive may depend on the country or region of the world.</p>
    <p>It should be clear that FLoC will never be able to prevent all misuse. There will be categories that are sensitive in contexts that weren’t predicted. Beyond FLoC’s technical means of preventing abuse, sites that use cohorts will need to ensure that people are treated fairly, just as they must with algorithmic decisions made based on any other data today.</p>
    <h3 class="heading settled" data-level="7.3" id="tracking-people-via-their-interest-cohort"><span class="secno">7.3. </span><span class="content">Tracking people via their interest cohort</span><a class="self-link" href="#tracking-people-via-their-interest-cohort"></a></h3>
     An <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort③">interest cohort</a> could be used as a user identifier. It may not have enough bits of information to individually identify someone, but in combination with other information (such as an IP address), it might. One design mitigation is to ensure cohort sizes are large enough that they are not useful for tracking. In addition, if the user agent believes that too many high-entropy bits of information have already been consumed by a given <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code>, then the <code class="idl"><a data-link-type="idl" href="#dom-document-interestcohort" id="ref-for-dom-document-interestcohort③">interestCohort()</a></code> algorithm will return a rejected promise, which can help mitigate such tracking. 
    <p>If for any short time period the <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort④">interest cohorts</a> exposed to different sites tends to be the same, then the time series of <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort⑤">interest cohorts</a> can also be used as a user identifier. Sites could associate users' first-party identity with a series of <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort⑥">interest cohorts</a> observed over time, and could report these series to a single tracking service. The tracking service could then associate each series with the sites to know the browsing history of an individual.</p>
    <h3 class="heading settled" data-level="7.4" id="recovering-the-browsing-history-from-cohorts"><span class="secno">7.4. </span><span class="content">Recovering the browsing history from cohorts</span><a class="self-link" href="#recovering-the-browsing-history-from-cohorts"></a></h3>
     Updating the <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort⑦">interest cohort</a> too often may increase the likelihood of identifying portions of a user’s browsing history, for instance by using <a href="https://en.wikipedia.org/wiki/Compressed_sensing">compressed sensing</a>. 
    <p>One possible mitigation is: when the <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort⑧">interest cohort</a> is computed and exposed to an origin, pin that <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort⑨">interest cohort</a> to that origin for a period of time. When an <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①⓪">interest cohort</a> is pinned to an origin, the execution of the <a href="#cohort-assignment-algorithm">cohort assignment algorithm</a> on that origin will return the cached <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①①">interest cohort</a> instead of computing a new one.</p>
    <p>If the browser decide to cache <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①②">interest cohorts</a>, it should ensure proper handling of data deletion:</p>
    <ul>
     <li data-md>
      <p>When site data are deleted, and some cached <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①③">interest cohorts</a> are derived from any affected site, those <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①④">interest cohorts</a> should be cleared.</p>
     <li data-md>
      <p>When the browsing history is deleted and some cached <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①⑤">interest cohorts</a> are derived from any deleted browsing history, those <a data-link-type="dfn" href="#interest-cohort" id="ref-for-interest-cohort①⑥">interest cohorts</a> should be cleared.</p>
    </ul>
   </section>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#dom-interestcohort-id">id</a><span>, in § 2</span>
   <li><a href="#interest-cohort">interest cohort</a><span>, in § 2</span>
   <li><a href="#interest-cohort-policy-controlled-feature">interest-cohort</a><span>, in § 6</span>
   <li><a href="#dictdef-interestcohort">InterestCohort</a><span>, in § 2</span>
   <li><a href="#dom-document-interestcohort">interestCohort()</a><span>, in § 3</span>
   <li><a href="#interest-cohort-id">interest cohort id</a><span>, in § 2</span>
   <li><a href="#interest-cohort-task-source">interest cohort task source</a><span>, in § 3</span>
   <li><a href="#interest-cohort-version">interest cohort version</a><span>, in § 2</span>
   <li><a href="#string-representation-of-the-interest-cohort-id">string representation of the interest cohort id</a><span>, in § 2</span>
   <li><a href="#string-representation-of-the-interest-cohort-version">string representation of the interest cohort version</a><span>, in § 2</span>
   <li><a href="#dom-interestcohort-version">version</a><span>, in § 2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3610bd67">allowed to use</span>
     <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
     <li><span class="dfn-paneled" id="48438eb3">queue a global task</span>
     <li><span class="dfn-paneled" id="e99bd18e">relevant global object</span>
     <li><span class="dfn-paneled" id="65181da8">secure context</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1570624a">default allowlist</span>
     <li><span class="dfn-paneled" id="cc890cc1">policy-controlled feature</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="dca2de17">DOMException</span>
     <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
     <li><span class="dfn-paneled" id="ba556545">NotAllowedError</span>
     <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
     <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
     <li><span class="dfn-paneled" id="b262501e">reject</span>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
     <li><span class="dfn-paneled" id="4013a022">this</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions-policy">[PERMISSIONS-POLICY]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>dictionary</c-> <a href="#dictdef-interestcohort"><code><c- g>InterestCohort</c-></code></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a data-type="DOMString" href="#dom-interestcohort-id"><code><c- g>id</c-></code></a>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a data-type="DOMString" href="#dom-interestcohort-version"><code><c- g>version</c-></code></a>;
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
    <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-interestcohort"><c- n>InterestCohort</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-interestcohort"><c- g>interestCohort</c-></a>();
};

</pre>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"1570624a": {"dfnID":"1570624a","dfnText":"default allowlist","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature-default-allowlist"}],"title":"6. Permissions policy integration"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"3610bd67": {"dfnID":"3610bd67","dfnText":"allowed to use","external":true,"refSections":[{"refs":[{"id":"ref-for-allowed-to-use"}],"title":"3. The API"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"3b90bdcd": {"dfnID":"3b90bdcd","dfnText":"resolve","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#resolve"},
"4013a022": {"dfnID":"4013a022","dfnText":"this","external":true,"refSections":[{"refs":[{"id":"ref-for-this"},{"id":"ref-for-this\u2460"},{"id":"ref-for-this\u2461"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#this"},
"48438eb3": {"dfnID":"48438eb3","dfnText":"queue a global task","external":true,"refSections":[{"refs":[{"id":"ref-for-queue-a-global-task"},{"id":"ref-for-queue-a-global-task\u2460"}],"title":"3. The API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"65181da8": {"dfnID":"65181da8","dfnText":"secure context","external":true,"refSections":[{"refs":[{"id":"ref-for-secure-context"}],"title":"3. The API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"},{"id":"ref-for-document\u2460"}],"title":"3. The API"},{"refs":[{"id":"ref-for-document\u2461"}],"title":"7.1.4. Adoption phase"},{"refs":[{"id":"ref-for-document\u2462"}],"title":"7.3. Tracking people via their interest cohort"}],"url":"https://dom.spec.whatwg.org/#document"},
"860300d4": {"dfnID":"860300d4","dfnText":"implementation-defined","external":true,"refSections":[{"refs":[{"id":"ref-for-implementation-defined"}],"title":"2. Interest cohort"}],"url":"https://infra.spec.whatwg.org/#implementation-defined"},
"8855a9aa": {"dfnID":"8855a9aa","dfnText":"DOMString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMString"},{"id":"ref-for-idl-DOMString\u2460"}],"title":"2. Interest cohort"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"a72449dd": {"dfnID":"a72449dd","dfnText":"in parallel","external":true,"refSections":[{"refs":[{"id":"ref-for-in-parallel"}],"title":"3. The API"}],"url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"b262501e": {"dfnID":"b262501e","dfnText":"reject","external":true,"refSections":[{"refs":[{"id":"ref-for-reject"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#reject"},
"ba556545": {"dfnID":"ba556545","dfnText":"NotAllowedError","external":true,"refSections":[{"refs":[{"id":"ref-for-notallowederror"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#notallowederror"},
"bdbd19d1": {"dfnID":"bdbd19d1","dfnText":"Promise","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-promise"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#idl-promise"},
"cc890cc1": {"dfnID":"cc890cc1","dfnText":"policy-controlled feature","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature"}],"title":"6. Permissions policy integration"},{"refs":[{"id":"ref-for-policy-controlled-feature\u2460"}],"title":"7.1.1. Eligibility for a page to be included in the interest cohort computation"},{"refs":[{"id":"ref-for-policy-controlled-feature\u2461"}],"title":"7.1.2. Permission to access the interest cohort"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"dacde8b5": {"dfnID":"dacde8b5","dfnText":"a new promise","external":true,"refSections":[{"refs":[{"id":"ref-for-a-new-promise"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"dca2de17": {"dfnID":"dca2de17","dfnText":"DOMException","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMException"}],"title":"3. The API"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"dictdef-interestcohort": {"dfnID":"dictdef-interestcohort","dfnText":"InterestCohort","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-interestcohort"}],"title":"2. Interest cohort"},{"refs":[{"id":"ref-for-dictdef-interestcohort\u2460"},{"id":"ref-for-dictdef-interestcohort\u2461"}],"title":"3. The API"}],"url":"#dictdef-interestcohort"},
"dom-document-interestcohort": {"dfnID":"dom-document-interestcohort","dfnText":"interestCohort()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-interestcohort"}],"title":"3. The API"},{"refs":[{"id":"ref-for-dom-document-interestcohort\u2460"}],"title":"7.1.1. Eligibility for a page to be included in the interest cohort computation"},{"refs":[{"id":"ref-for-dom-document-interestcohort\u2461"}],"title":"7.1.3. Private browsing / Incognito mode"},{"refs":[{"id":"ref-for-dom-document-interestcohort\u2462"}],"title":"7.3. Tracking people via their interest cohort"}],"url":"#dom-document-interestcohort"},
"dom-interestcohort-id": {"dfnID":"dom-interestcohort-id","dfnText":"id","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-interestcohort-id"}],"title":"3. The API"}],"url":"#dom-interestcohort-id"},
"dom-interestcohort-version": {"dfnID":"dom-interestcohort-version","dfnText":"version","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-interestcohort-version"}],"title":"3. The API"}],"url":"#dom-interestcohort-version"},
"e99bd18e": {"dfnID":"e99bd18e","dfnText":"relevant global object","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-relevant-global"},{"id":"ref-for-concept-relevant-global\u2460"}],"title":"3. The API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"interest-cohort": {"dfnID":"interest-cohort","dfnText":"interest cohort","external":false,"refSections":[{"refs":[{"id":"ref-for-interest-cohort"}],"title":"4. Interpretation"},{"refs":[{"id":"ref-for-interest-cohort\u2460"}],"title":"7.1.2. Permission to access the interest cohort"},{"refs":[{"id":"ref-for-interest-cohort\u2461"}],"title":"7.2. Sensitive information"},{"refs":[{"id":"ref-for-interest-cohort\u2462"},{"id":"ref-for-interest-cohort\u2463"},{"id":"ref-for-interest-cohort\u2464"},{"id":"ref-for-interest-cohort\u2465"}],"title":"7.3. Tracking people via their interest cohort"},{"refs":[{"id":"ref-for-interest-cohort\u2466"},{"id":"ref-for-interest-cohort\u2467"},{"id":"ref-for-interest-cohort\u2468"},{"id":"ref-for-interest-cohort\u2460\u24ea"},{"id":"ref-for-interest-cohort\u2460\u2460"},{"id":"ref-for-interest-cohort\u2460\u2461"},{"id":"ref-for-interest-cohort\u2460\u2462"},{"id":"ref-for-interest-cohort\u2460\u2463"},{"id":"ref-for-interest-cohort\u2460\u2464"},{"id":"ref-for-interest-cohort\u2460\u2465"}],"title":"7.4. Recovering the browsing history from cohorts"}],"url":"#interest-cohort"},
"interest-cohort-id": {"dfnID":"interest-cohort-id","dfnText":"interest cohort id","external":false,"refSections":[{"refs":[{"id":"ref-for-interest-cohort-id"},{"id":"ref-for-interest-cohort-id\u2460"},{"id":"ref-for-interest-cohort-id\u2461"},{"id":"ref-for-interest-cohort-id\u2462"}],"title":"2. Interest cohort"},{"refs":[{"id":"ref-for-interest-cohort-id\u2463"}],"title":"3. The API"},{"refs":[{"id":"ref-for-interest-cohort-id\u2464"}],"title":"4. Interpretation"},{"refs":[{"id":"ref-for-interest-cohort-id\u2465"}],"title":"5. Cohort assignment algorithm"},{"refs":[{"id":"ref-for-interest-cohort-id\u2466"}],"title":"5.1. Input and output"},{"refs":[{"id":"ref-for-interest-cohort-id\u2467"}],"title":"5.2. Caching the result"},{"refs":[{"id":"ref-for-interest-cohort-id\u2468"}],"title":"5.3. Privacy guarantees"},{"refs":[{"id":"ref-for-interest-cohort-id\u2460\u24ea"},{"id":"ref-for-interest-cohort-id\u2460\u2460"},{"id":"ref-for-interest-cohort-id\u2460\u2461"}],"title":"5.3.1. Anonymity"},{"refs":[{"id":"ref-for-interest-cohort-id\u2460\u2462"}],"title":"5.3.2. No browsing history recovering from cohorts"},{"refs":[{"id":"ref-for-interest-cohort-id\u2460\u2463"}],"title":"5.3.3. No sensitive cohorts"}],"url":"#interest-cohort-id"},
"interest-cohort-policy-controlled-feature": {"dfnID":"interest-cohort-policy-controlled-feature","dfnText":"interest-cohort","external":false,"refSections":[{"refs":[{"id":"ref-for-interest-cohort-policy-controlled-feature"}],"title":"3. The API"},{"refs":[{"id":"ref-for-interest-cohort-policy-controlled-feature"}],"title":"7.1.1. Eligibility for a page to be included in the interest cohort computation"},{"refs":[{"id":"ref-for-interest-cohort-policy-controlled-feature"}],"title":"7.1.2. Permission to access the interest cohort"}],"url":"#interest-cohort-policy-controlled-feature"},
"interest-cohort-task-source": {"dfnID":"interest-cohort-task-source","dfnText":"interest cohort task source","external":false,"refSections":[{"refs":[{"id":"ref-for-interest-cohort-task-source"}],"title":"3. The API"}],"url":"#interest-cohort-task-source"},
"interest-cohort-version": {"dfnID":"interest-cohort-version","dfnText":"interest cohort version","external":false,"refSections":[{"refs":[{"id":"ref-for-interest-cohort-version"}],"title":"2. Interest cohort"},{"refs":[{"id":"ref-for-interest-cohort-version\u2460"}],"title":"3. The API"},{"refs":[{"id":"ref-for-interest-cohort-version\u2461"}],"title":"4. Interpretation"}],"url":"#interest-cohort-version"},
"string-representation-of-the-interest-cohort-id": {"dfnID":"string-representation-of-the-interest-cohort-id","dfnText":"string representation of the interest cohort id","external":false,"refSections":[{"refs":[{"id":"ref-for-string-representation-of-the-interest-cohort-id"}],"title":"2. Interest cohort"},{"refs":[{"id":"ref-for-string-representation-of-the-interest-cohort-id"}],"title":"3. The API"}],"url":"#string-representation-of-the-interest-cohort-id"},
"string-representation-of-the-interest-cohort-version": {"dfnID":"string-representation-of-the-interest-cohort-version","dfnText":"string representation of the interest cohort version","external":false,"refSections":[{"refs":[{"id":"ref-for-string-representation-of-the-interest-cohort-version"}],"title":"2. Interest cohort"},{"refs":[{"id":"ref-for-string-representation-of-the-interest-cohort-version"}],"title":"3. The API"}],"url":"#string-representation-of-the-interest-cohort-version"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#dictdef-interestcohort": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"InterestCohort","type":"dictionary","url":"#dictdef-interestcohort"},
"#dom-document-interestcohort": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"interestCohort()","type":"method","url":"#dom-document-interestcohort"},
"#dom-interestcohort-id": {"export":true,"for_":["InterestCohort"],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"id","type":"dict-member","url":"#dom-interestcohort-id"},
"#dom-interestcohort-version": {"export":true,"for_":["InterestCohort"],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"version","type":"dict-member","url":"#dom-interestcohort-version"},
"#interest-cohort": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"interest cohort","type":"dfn","url":"#interest-cohort"},
"#interest-cohort-id": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"interest cohort id","type":"dfn","url":"#interest-cohort-id"},
"#interest-cohort-task-source": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"interest cohort task source","type":"dfn","url":"#interest-cohort-task-source"},
"#interest-cohort-version": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"interest cohort version","type":"dfn","url":"#interest-cohort-version"},
"#string-representation-of-the-interest-cohort-id": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"string representation of the interest cohort id","type":"dfn","url":"#string-representation-of-the-interest-cohort-id"},
"#string-representation-of-the-interest-cohort-version": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"floc","spec":"floc-1","status":"local","text":"string representation of the interest cohort version","type":"dfn","url":"#string-representation-of-the-interest-cohort-version"},
"https://dom.spec.whatwg.org/#document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"allowed to use","type":"dfn","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"in parallel","type":"dfn","url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant global object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"queue a global task","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"secure context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context"},
"https://infra.spec.whatwg.org/#implementation-defined": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"implementation-defined","type":"dfn","url":"https://infra.spec.whatwg.org/#implementation-defined"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"policy-controlled feature","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist": {"export":true,"for_":["policy-controlled feature"],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"default allowlist","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"https://webidl.spec.whatwg.org/#a-new-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"a new promise","type":"dfn","url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"https://webidl.spec.whatwg.org/#idl-DOMException": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMException","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"https://webidl.spec.whatwg.org/#idl-DOMString": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"https://webidl.spec.whatwg.org/#idl-promise": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Promise","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-promise"},
"https://webidl.spec.whatwg.org/#notallowederror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"NotAllowedError","type":"exception","url":"https://webidl.spec.whatwg.org/#notallowederror"},
"https://webidl.spec.whatwg.org/#reject": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"reject","type":"dfn","url":"https://webidl.spec.whatwg.org/#reject"},
"https://webidl.spec.whatwg.org/#resolve": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"resolve","type":"dfn","url":"https://webidl.spec.whatwg.org/#resolve"},
"https://webidl.spec.whatwg.org/#this": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"this","type":"dfn","url":"https://webidl.spec.whatwg.org/#this"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>