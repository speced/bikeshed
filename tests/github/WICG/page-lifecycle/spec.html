<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Page Lifecycle</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/page-lifecycle/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Page Lifecycle</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/page-lifecycle/">https://wicg.github.io/page-lifecycle/</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:panicker@google.com">Shubhie Panicker</a> (<a class="p-org org" href="https://google.com">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:d@domenic.me">Domenic Denicola</a> (<a class="p-org org" href="https://google.com">Google</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 1970 the Contributors to the Page Lifecycle Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document defines an API that supports browsers' ability to manage lifecycle of web pages.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#sec-lifecycle-states"><span class="secno">2</span> <span class="content">Page Lifecycle States</span></a>
    <li>
     <a href="#sec-api"><span class="secno">3</span> <span class="content">API</span></a>
     <ol class="toc">
      <li><a href="#example"><span class="secno">3.1</span> <span class="content">Usage example</span></a>
     </ol>
    <li><a href="#feature-policies"><span class="secno">4</span> <span class="content">Feature Policies</span></a>
    <li>
     <a href="#sec-processing-model"><span class="secno">5</span> <span class="content">Processing model</span></a>
     <ol class="toc">
      <li><a href="#worklets-workers"><span class="secno">5.1</span> <span class="content">Modifications to worklet and worker behavior</span></a>
      <li>
       <a href="#mod"><span class="secno">5.2</span> <span class="content">Modifications to the HTML Standard</span></a>
       <ol class="toc">
        <li><a href="#html-bfcache-dfn"><span class="secno">5.2.1</span> <span class="content"><span>Unloading documents</span> and <span>history traversal</span></span></a>
        <li><a href="#html-html-event-loop-definitions"><span class="secno">5.2.2</span> <span class="content"><span>Event loop: definitions</span></span></a>
        <li><a href="#html-event-loop"><span class="secno">5.2.3</span> <span class="content"><span>Event loop: processing model</span></span></a>
        <li><a href="#html-discarding"><span class="secno">5.2.4</span> <span class="content"><span>Discarding browsing contexts</span></span></a>
        <li><a href="#html-initialize-doc"><span class="secno">5.2.5</span> <span class="content"><span>Initialize the document</span></span></a>
        <li><a href="#html-iframe-load"><span class="secno">5.2.6</span> <span class="content"><span>iframe load event steps</span></span></a>
        <li><a href="#html-media-elements"><span class="secno">5.2.7</span> <span class="content"><code class="idl"><span>HTMLMediaElement</span></code></span></a>
        <li><a href="#html-post-message"><span class="secno">5.2.8</span> <span class="content"><span>Posting messages</span></span></a>
       </ol>
      <li>
       <a href="#serviceworker-mod"><span class="secno">5.3</span> <span class="content">Modifications to the Service Worker Standard</span></a>
       <ol class="toc">
        <li>
         <a href="#serviceworker-client-dfn"><span class="secno">5.3.1</span> <span class="content"><span><code>Client</code></span></span></a>
         <ol class="toc">
          <li><a href="#service-worker-client-lifecycle-state"><span class="secno">5.3.1.1</span> <span class="content"><code class="idl"><span>lifecycleState</span></code></span></a>
          <li><a href="#serviceworker-matchall-dfn"><span class="secno">5.3.1.2</span> <span class="content"><span><code>matchAll(options)</code></span></span></a>
          <li><a href="#serviceworker-openwindow-dfn"><span class="secno">5.3.1.3</span> <span class="content"><span><code>openWindow(url)</code></span></span></a>
         </ol>
        <li>
         <a href="#serviceworker-algorithms-dfn"><span class="secno">5.3.2</span> <span class="content"><span>Algorithms</span></span></a>
         <ol class="toc">
          <li><a href="#get-client-lifecycle-state-algorithm"><span class="secno">5.3.2.1</span> <span class="content"><span>Get Client Lifecycle State</span></span></a>
          <li><a href="#serviceworker-createclient-dfn"><span class="secno">5.3.2.2</span> <span class="content"><span>Create Client</span></span></a>
          <li><a href="#serviceworker-createwindowclient-dfn"><span class="secno">5.3.2.3</span> <span class="content"><span>Create Window Client</span></span></a>
         </ol>
       </ol>
      <li>
       <a href="#page-lifecycle"><span class="secno">5.4</span> <span class="content">Page lifecycle processing model</span></a>
       <ol class="toc">
        <li><a href="#frozenness-state"><span class="secno">5.4.1</span> <span class="content">FROZENNESS state</span></a>
        <li><a href="#changing-frozenness"><span class="secno">5.4.2</span> <span class="content">Changing the frozenness of documents</span></a>
        <li><a href="#discarding"><span class="secno">5.4.3</span> <span class="content">Discarding</span></a>
       </ol>
     </ol>
    <li><a href="#acknowledgements"><span class="secno">6</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    With large numbers of web apps (and tabs) running, critical resources such as memory, CPU, battery, network, etc. easily get oversubscribed, leading to a bad end-user experience. Application lifecycle is a key way that modern OSs manage resources. 
   <p>For a platform to support application lifecycle, it needs to:</p>
   <ul>
    <li data-md>
     <p>provide developers with signals about transitions between the lifecycle states</p>
    <li data-md>
     <p>provide lifecycle-compatible APIs that allow key capabilities to work even when the app is backgrounded or stopped.</p>
   </ul>
   <p>This proposal attempts to define what the lifecycle of a web page is and add needed extensions to enable web applications to respond to two important lifecycle events commonly performed by user agents:</p>
   <ul>
    <li data-md>
     <p>Tab discarding (for memory saving)</p>
    <li data-md>
     <p>CPU suspension (for battery, data, CPU saving)</p>
   </ul>
   <h2 class="heading settled" data-level="2" id="sec-lifecycle-states"><span class="secno">2. </span><span class="content">Page Lifecycle States</span><a class="self-link" href="#sec-lifecycle-states"></a></h2>
   <p>This spec defines what the lifecycle of a web page is and adds extensions to enable web applications to respond to two important lifecycle events commonly performed by user agents:</p>
   <ul>
    <li data-md>
     <p>CPU suspension (for conserving battery, data, CPU)</p>
    <li data-md>
     <p>Tab discarding (for memory saving)</p>
   </ul>
   <p>This spec formalizes two new lifecycle states to support the above:</p>
   <ul>
    <li data-md>
     <p>Frozen: lifecycle state for CPU suspension. This means that the <a data-link-type="dfn" href="#freeze-steps" id="ref-for-freeze-steps">freeze steps</a> algorithm was called on the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc" id="ref-for-concept-document-bc">browsing context</a>. Normally HIDDEN pages will be <a data-link-type="dfn" href="#frozen" id="ref-for-frozen">frozen</a> to conserve resources.</p>
    <li data-md>
     <p>Discarded: means that the <a data-link-type="dfn" href="#discarded" id="ref-for-discarded">discard</a> algorithm was called on the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc" id="ref-for-concept-document-bc①">browsing context</a>. Normally <a data-link-type="dfn" href="#frozen" id="ref-for-frozen①">frozen</a> frames will be moved to the discarded state to conserve resources.</p>
   </ul>
   <p>TODO(panicker): Insert diagram</p>
   <h2 class="heading settled" data-level="3" id="sec-api"><span class="secno">3. </span><span class="content">API</span><a class="self-link" href="#sec-api"></a></h2>
   <p>Page Lifecycle involves the following additions:</p>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②"><c- g>Document</c-></a> {
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler" id="ref-for-eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-document-onfreeze" id="ref-for-dom-document-onfreeze"><c- g>onfreeze</c-></a>;
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler" id="ref-for-eventhandler①"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-document-onresume" id="ref-for-dom-document-onresume"><c- g>onresume</c-></a>;
    <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="boolean" href="#dom-document-wasdiscarded" id="ref-for-dom-document-wasdiscarded"><c- g>wasDiscarded</c-></a>;
};
</pre>
   <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export id="dom-document-onfreeze"><code>onfreeze</code></dfn> and <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export id="dom-document-onresume"><code>onresume</code></dfn> attributes are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes" id="ref-for-event-handler-idl-attributes">event handler IDL attributes</a> for the <code>freeze</code> and <code>resume</code> events, respectively.</p>
   <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export id="dom-document-wasdiscarded"><code>wasDiscarded</code></dfn> attribute’s getter must return the value of this <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code>'s <a data-link-type="dfn" href="#document-discarded" id="ref-for-document-discarded">discarded</a> boolean.</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> these APIs are added on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code>, instead of on <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window">Window</a></code>, for consistency with the Page Visibility API; we expect these APIs to be used in tandem with that existing one. <a data-link-type="biblio" href="#biblio-page-visibility" title="Page Visibility (Second Edition)">[PAGE-VISIBILITY]</a></p>
   <p class="note" role="note"><span class="marker">NOTE:</span> In addition <a href="https://github.com/whatwg/html/issues/3378"><code>clientId</code> and <code>discardedClientId</code></a> will be added to <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window①">Window</a></code>, to support restoring view state when user revisits a discarded page, causing a reload. We expect those to be used by code that reacts to these events.</p>
   <h3 class="heading settled" data-level="3.1" id="example"><span class="secno">3.1. </span><span class="content">Usage example</span><a class="self-link" href="#example"></a></h3>
   <p>Example of handling freeze and resume:</p>
<pre class="example highlight" id="example-edb6c132"><a class="self-link" href="#example-edb6c132"></a><c- a>const</c-> prepareForFreeze <c- o>=</c-> <c- p>()</c-> <c- p>=></c-> <c- p>{</c->
  <c- c1>// Close any open IndexedDB connections.</c->
  <c- c1>// Release any web locks.</c->
  <c- c1>// Stop timers or polling.</c->
<c- p>};</c->

<c- a>const</c-> reInitializeApp <c- o>=</c-> <c- p>()</c-> <c- p>=></c-> <c- p>{</c->
  <c- c1>// Restore IndexedDB connections.</c->
  <c- c1>// Re-acquire any needed web locks.</c->
  <c- c1>// Restart timers or polling.</c->
<c- p>};</c->

document<c- p>.</c->addEventListener<c- p>(</c-><c- t>'freeze'</c-><c- p>,</c-> prepareForFreeze<c- p>);</c->
document<c- p>.</c->addEventListener<c- p>(</c-><c- t>'resume'</c-><c- p>,</c-> reInitializeApp<c- p>);</c->
</pre>
   <p>Example of restoring view state after discard:
A user could have multiple tabs open for the same app &amp; URL. If they are both in the background and are both discarded, then the app would need to distinguish between the two tabs to restore the correct state. clientId and lastClientId on the Window can be used for this purpose.</p>
<pre class="example highlight" id="example-e35b9ec1"><a class="self-link" href="#example-e35b9ec1"></a><c- c1>// Persists state to IndexedDB, making sure to set the current value of</c->
<c- c1>// </c-><code class="highlight"><c- c1>self<c- p>.</c->clientId</c-></code><c- c1> on the record, so it can be retrieved later using</c->
<c- c1>// </c-><code class="highlight"><c- c1>getPersistedState<c- p>()</c-></c-></code><c- c1> (if the tab has to be reloaded after a discard).</c->
<c- a>const</c-> persistState <c- o>=</c-> <c- k>async</c-> <c- p>(</c->state<c- p>)</c-> <c- p>=></c-> <c- p>{</c->
  <c- a>const</c-> record <c- o>=</c-> <c- p>{...</c->state<c- p>,</c-> cliendId<c- o>:</c-> self<c- p>.</c->clientId<c- p>};</c->

  <c- c1>// Persist record to IndexedDB or SessionStorage....</c->
<c- p>}</c->

<c- c1>// Retrieves the state record from IndexedDB based on the passed client ID.</c->
<c- a>const</c-> getPersistedState <c- o>=</c-> <c- k>async</c-> <c- p>(</c->clientId<c- p>)</c-> <c- p>=></c-> <c- p>{</c->
  <c- c1>// Lookup record in IndexedDB...</c->
<c- p>};</c->

<c- c1>// If the tab was previously discarded, get the persisted state for the</c->
<c- c1>// client ID of the discarded tab via </c-><code class="highlight"><c- c1>self<c- p>.</c->lastClientId</c-></code><c- c1>.</c->
<c- k>if</c-> <c- p>(</c->document<c- p>.</c->wasDiscarded<c- p>)</c-> <c- p>{</c->
  getPersistedState<c- p>(</c->self<c- p>.</c->lastClientId<c- p>);</c->
<c- p>}</c->
</pre>
   <h2 class="heading settled" data-level="4" id="feature-policies"><span class="secno">4. </span><span class="content">Feature Policies</span><a class="self-link" href="#feature-policies"></a></h2>
    Controlling the execution state of <a data-link-type="dfn">nested browsing contexts</a> is desirable from a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc" id="ref-for-concept-document-bc②">browsing context</a> in order to control
the user experience. An application may desire that when a document is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/rendering.html#being-rendered" id="ref-for-being-rendered">being rendered</a> or does not intersect the <a data-link-type="dfn" href="https://www.w3.org/TR/CSS2/visuren.html#viewport" id="ref-for-viewport">viewport</a> that all execution stops in the <a data-link-type="dfn">nested browsing context</a> (including currently playing video, audio). Stopping all execution
can lead to an improvement in CPU utilization. To meet these needs, two feature policies are defined: 
   <ul>
    <li data-md>
     <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="execution-while-not-rendered"><code>execution-while-not-rendered</code></dfn>", which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist">default allowlist</a> of <code>*</code></p>
    <li data-md>
     <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="execution-while-out-of-viewport"><code>execution-while-out-of-viewport</code></dfn>", which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①">default allowlist</a> of <code>*</code></p>
   </ul>
   <p>The "<a data-link-type="dfn" href="#execution-while-not-rendered" id="ref-for-execution-while-not-rendered"><code>execution-while-not-rendered</code></a>" policy controls whether
tasks should execute for <a data-link-type="dfn">nested browsing contexts</a> whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container" id="ref-for-browsing-context-container">browsing context container</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/rendering.html#being-rendered" id="ref-for-being-rendered①">being rendered</a>.</p>
   <p>The "<a data-link-type="dfn" href="#execution-while-out-of-viewport" id="ref-for-execution-while-out-of-viewport"><code>execution-while-out-of-viewport</code></a>" policy controls whether
tasks should execute for <a data-link-type="dfn">nested browsing contexts</a> whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container" id="ref-for-browsing-context-container①">browsing context container</a> does not intersect the <a data-link-type="dfn" href="https://www.w3.org/TR/CSS2/visuren.html#viewport" id="ref-for-viewport①">viewport</a> according
to <a data-link-type="dfn" href="https://w3c.github.io/IntersectionObserver/#calculate-intersection-rect-algo" id="ref-for-calculate-intersection-rect-algo">compute the intersection of a target element and the root</a>.</p>
   <p><a href="#mod">§ 5.2 Modifications to the HTML Standard</a> accomplishes this by placing the document (and its decendants) in a <a data-link-type="dfn" href="#frozen" id="ref-for-frozen②">frozen</a> state when the following
conditions have been met:</p>
   <ul>
    <li data-md>
     <p>the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#iframe-load-event-steps" id="ref-for-iframe-load-event-steps">iframe load event steps</a> have been run;</p>
    <li data-md>
     <p>the policy is disabled for the document; and</p>
    <li data-md>
     <p>the relevant policy condition applies (not rendered or scrolled out of view).</p>
   </ul>
   <p>If these conditions aren’t met, the document will be in the <a data-link-type="dfn" href="#unfrozen" id="ref-for-unfrozen">unfrozen</a> state.</p>
<pre class="example highlight" id="example-fa17f32b"><a class="self-link" href="#example-fa17f32b"></a><c- d>&lt;!-- The iframe will be frozen immediately after it is loaded. --></c->

<c- p>&lt;</c-><c- f>iframe</c-> <c- e>allow</c-><c- o>=</c-><c- s>"execution-while-not-rendered 'none'"</c->
  <c- e>src</c-><c- o>=</c-><c- s>"subframe.html"</c-> <c- e>style</c-><c- o>=</c-><c- s>"display:none"</c-><c- p>>&lt;/</c-><c- f>iframe</c-><c- p>></c->
</pre>
   <div class="algorithm" data-algorithm="update document frozenness steps">
     To run the <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="update-document-frozenness-steps">update document frozenness steps</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code> <var>document</var>: 
    <ol>
     <li data-md>
      <p>If <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc" id="ref-for-concept-document-bc③">browsing context</a> is not a <a data-link-type="dfn">nested browsing context</a>, then return.</p>
     <li data-md>
      <p>If <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness" id="ref-for-current-document-readiness">readiness</a> is not "<code>complete</code>", then return.</p>
     <li data-md>
      <p>Let <var>element</var> be <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc" id="ref-for-concept-document-bc④">browsing context</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container" id="ref-for-browsing-context-container②">browsing context container</a>.</p>
     <li data-md>
      <p>Let <var>frozenness</var> be false.</p>
     <li data-md>
      <p>Let <var>auto resume media</var> be false.</p>
     <li data-md>
      <p>If <var>document</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use">allowed to use</a> the "<a data-link-type="dfn" href="#execution-while-not-rendered" id="ref-for-execution-while-not-rendered①"><code>execution-while-not-rendered</code></a>" feature, then:</p>
      <ol>
       <li data-md>
        <p>If <var>element</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/rendering.html#being-rendered" id="ref-for-being-rendered②">being rendered</a>,  set <var>frozenness</var> to true.</p>
      </ol>
     <li data-md>
      <p>Otherwise if <var>document</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use①">allowed to use</a> the "<a data-link-type="dfn" href="#execution-while-out-of-viewport" id="ref-for-execution-while-out-of-viewport①"><code>execution-while-out-of-viewport</code></a>" feature, then:</p>
      <ol>
       <li data-md>
        <p>If <var>element</var> does not intersect the <a data-link-type="dfn" href="https://www.w3.org/TR/CSS2/visuren.html#viewport" id="ref-for-viewport②">viewport</a> according to <a data-link-type="dfn" href="https://w3c.github.io/IntersectionObserver/#calculate-intersection-rect-algo" id="ref-for-calculate-intersection-rect-algo①">compute the intersection of a target element and the root</a>, set <var>frozenness</var> to true and set <var>auto resume media</var> to true.</p>
      </ol>
     <li data-md>
      <p>If <var>frozenness</var> does not equal <var>document</var>’s <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness">frozenness</a> state, <a data-link-type="dfn" href="#change-the-frozenness-of-a-document" id="ref-for-change-the-frozenness-of-a-document">change the frozenness of a document</a> given <var>document</var>, <var>frozenness</var>, and <var>auto resume media</var>.</p>
    </ol>
   </div>
   <h2 class="heading settled" data-level="5" id="sec-processing-model"><span class="secno">5. </span><span class="content">Processing model</span><a class="self-link" href="#sec-processing-model"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="worklets-workers"><span class="secno">5.1. </span><span class="content">Modifications to worklet and worker behavior</span><a class="self-link" href="#worklets-workers"></a></h3>
   <p>Any <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#worklet-agent" id="ref-for-worklet-agent">worklet agent</a> whose single <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-code-realms" id="ref-for-sec-code-realms">realm</a>'s <a data-link-type="dfn">global object</a>'s <a data-link-type="dfn" href="https://drafts.css-houdini.org/worklets#workletglobalscope-owner-document" id="ref-for-workletglobalscope-owner-document">owning document</a> is <a data-link-type="dfn" href="#frozen" id="ref-for-frozen③">frozen</a> must become <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-forward-progress" id="ref-for-sec-forward-progress">blocked</a>.
Any <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#dedicated-worker-agent" id="ref-for-dedicated-worker-agent">dedicated worker agent</a> whose single <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-code-realms" id="ref-for-sec-code-realms①">realm</a>'s <a data-link-type="dfn">global object</a>'s <a data-link-type="dfn" href="#dedicatedworkerglobalscope-owning-document" id="ref-for-dedicatedworkerglobalscope-owning-document">owning document</a> is non-null and <a data-link-type="dfn" href="#frozen" id="ref-for-frozen④">frozen</a> must become <a data-link-type="dfn" href="https://tc39.github.io/ecma262/#sec-forward-progress" id="ref-for-sec-forward-progress①">blocked</a>.</p>
   <div class="algorithm" data-algorithm="owning document" data-algorithm-for="DedicatedWorkerGlobalScope">
     To determine the <dfn class="dfn-paneled" data-dfn-for="DedicatedWorkerGlobalScope" data-dfn-type="dfn" data-export id="dedicatedworkerglobalscope-owning-document">owning document</dfn> for a <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope" id="ref-for-dedicatedworkerglobalscope">DedicatedWorkerGlobalScope</a></code> <var>workerGlobalScope</var>: 
    <ol>
     <li data-md>
      <p>If <var>workerGlobalScope</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set" id="ref-for-concept-WorkerGlobalScope-owner-set">owner set</a> consists of a single <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑥">Document</a></code> <var>document</var>, then return <var>document</var>.</p>
     <li data-md>
      <p>If <var>workerGlobalScope</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set" id="ref-for-concept-WorkerGlobalScope-owner-set①">owner set</a> consists of a single <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope" id="ref-for-dedicatedworkerglobalscope①">DedicatedWorkerGlobalScope</a></code> <var>parentWorkerGlobalScope</var>, then return <var>parentWorkerGlobalScope</var>’s <a data-link-type="dfn" href="#dedicatedworkerglobalscope-owning-document" id="ref-for-dedicatedworkerglobalscope-owning-document①">owning document</a>.</p>
     <li data-md>
      <p>Return null.</p>
    </ol>
    <p class="note" role="note"><span class="marker">NOTE:</span> A <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope" id="ref-for-dedicatedworkerglobalscope②">DedicatedWorkerGlobalScope</a></code>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set" id="ref-for-concept-WorkerGlobalScope-owner-set②">owner set</a> will always have exactly one item.</p>
   </div>
   <h3 class="heading settled" data-level="5.2" id="mod"><span class="secno">5.2. </span><span class="content">Modifications to the HTML Standard</span><a class="self-link" href="#mod"></a></h3>
   <h4 class="heading settled" data-level="5.2.1" id="html-bfcache-dfn"><span class="secno">5.2.1. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#unloading-documents">Unloading documents</a> and <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#history-traversal">history traversal</a></span><a class="self-link" href="#html-bfcache-dfn"></a></h4>
   <p>When documents move into and out of <a href="https://webkit.org/blog/427/webkit-page-cache-i-the-basics/">bfcache (back forward cache)</a> they will transition its <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness①">frozenness</a> state to true and false respectively.</p>
   <ul>
    <li data-md>
     <p>In the <a data-link-type="dfn">unload a document</a> algorithm, after Step #5, if the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#dom-pagetransitionevent-persisted" id="ref-for-dom-pagetransitionevent-persisted">persisted</a></code> attribute is true (i.e. we are moving to bfcache), <a data-link-type="dfn" href="#change-the-frozenness-of-a-document" id="ref-for-change-the-frozenness-of-a-document①">change the frozenness of a document</a>, given <var>document</var> and true.</p>
    <li data-md>
     <p>In the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#traverse-the-history" id="ref-for-traverse-the-history">traverse the history</a> algorithm, before Step #4.6.4, if the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#dom-pagetransitionevent-persisted" id="ref-for-dom-pagetransitionevent-persisted①">persisted</a></code> attribute is true (i.e. we are moving out of bfcache), <a data-link-type="dfn" href="#change-the-frozenness-of-a-document" id="ref-for-change-the-frozenness-of-a-document②">change the frozenness of a document</a>, given <var>document</var> and false.</p>
   </ul>
   <h4 class="heading settled" data-level="5.2.2" id="html-html-event-loop-definitions"><span class="secno">5.2.2. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/webappapis.html#definitions-3">Event loop: definitions</a></span><a class="self-link" href="#html-html-event-loop-definitions"></a></h4>
   <p>Replace: A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task" id="ref-for-concept-task">task</a> is runnable if its <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">document</a> if either null or <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active">fully active</a>.</p>
   <p>With: A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-task" id="ref-for-concept-task①">task</a> is runnable if its <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①">document</a> is either null or <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①">fully active</a>, and is also <a data-link-type="dfn" href="#unfrozen" id="ref-for-unfrozen①">unfrozen</a>.</p>
   <h4 class="heading settled" data-level="5.2.3" id="html-event-loop"><span class="secno">5.2.3. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model">Event loop: processing model</a></span><a class="self-link" href="#html-event-loop"></a></h4>
   <p>After Step #11 during the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#update-the-rendering" id="ref-for-update-the-rendering">Update the rendering</a> add the following step.</p>
   <p>For each <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active②">fully active</a> <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑦">Document</a></code> <var>doc</var> in <var>docs</var>, run the <a data-link-type="dfn" href="#update-document-frozenness-steps" id="ref-for-update-document-frozenness-steps">update document frozenness steps</a> given <var>doc</var>.</p>
   <h4 class="heading settled" data-level="5.2.4" id="html-discarding"><span class="secno">5.2.4. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded">Discarding browsing contexts</a></span><a class="self-link" href="#html-discarding"></a></h4>
   <p>Rename the "<a href="https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded">discard</a>" concept, for both browsing contexts and documents, to "destroy". This allows us to use the "discarded" terminology for the user-facing <code class="idl"><a data-link-type="idl" href="#dom-document-wasdiscarded" id="ref-for-dom-document-wasdiscarded①">wasDiscarded</a></code> attribute.</p>
   <h4 class="heading settled" data-level="5.2.5" id="html-initialize-doc"><span class="secno">5.2.5. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#initialise-the-document-object">Initialize the document</a></span><a class="self-link" href="#html-initialize-doc"></a></h4>
   <p>Before Step #3 add following:</p>
   <p>If the browsing context was previously <a data-link-type="dfn" href="#discarded" id="ref-for-discarded①">discarded</a>, then set the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑧">Document</a></code>'s <a data-link-type="dfn" href="#document-discarded" id="ref-for-document-discarded①">discarded</a> boolean to true.</p>
   <h4 class="heading settled" data-level="5.2.6" id="html-iframe-load"><span class="secno">5.2.6. </span><span class="content"><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#iframe-load-event-steps" id="ref-for-iframe-load-event-steps①">iframe load event steps</a></span><a class="self-link" href="#html-iframe-load"></a></h4>
   <p>After Step #5 add following:</p>
   <p>Run the <a data-link-type="dfn" href="#update-document-frozenness-steps" id="ref-for-update-document-frozenness-steps①">update document frozenness steps</a> given <var>child document</var>.</p>
   <h4 class="heading settled" data-level="5.2.7" id="html-media-elements"><span class="secno">5.2.7. </span><span class="content"><code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlmediaelement" id="ref-for-htmlmediaelement">HTMLMediaElement</a></code></span><a class="self-link" href="#html-media-elements"></a></h4>
   <p>Each <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlmediaelement" id="ref-for-htmlmediaelement①">HTMLMediaElement</a></code> has a <dfn class="dfn-paneled" data-dfn-for="HTMLMediaElement" data-dfn-type="dfn" data-noexport id="htmlmediaelement-resume-frozen-flag">resume frozen flag</dfn>, which is initially set to false.</p>
   <h4 class="heading settled" data-level="5.2.8" id="html-post-message"><span class="secno">5.2.8. </span><span class="content"><a href="https://html.spec.whatwg.org/multipage/web-messaging.html#posting-messages">Posting messages</a></span><a class="self-link" href="#html-post-message"></a></h4>
   <p>Add a note:</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> When posting a message to a <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window②">Window</a></code> that is <a data-link-type="dfn" href="#frozen" id="ref-for-frozen⑤">frozen</a>, events that are queued on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/web-messaging.html#posted-message-task-source" id="ref-for-posted-message-task-source">posted message task source</a> will not run until the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window③">Window</a></code> is <a data-link-type="dfn" href="#unfrozen" id="ref-for-unfrozen②">unfrozen</a>. If too many events are queued, the user agent might <a data-link-type="dfn" href="#discarded" id="ref-for-discarded②">discard</a> the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window④">Window</a></code>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc" id="ref-for-window-bc">browsing context</a> (as part of the general allowance for discarding under resource pressure).</p>
   <h3 class="heading settled" data-level="5.3" id="serviceworker-mod"><span class="secno">5.3. </span><span class="content">Modifications to the Service Worker Standard</span><a class="self-link" href="#serviceworker-mod"></a></h3>
   <h4 class="heading settled" data-level="5.3.1" id="serviceworker-client-dfn"><span class="secno">5.3.1. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#client-interface"><code>Client</code></a></span><a class="self-link" href="#serviceworker-client-dfn"></a></h4>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://w3c.github.io/ServiceWorker/#client" id="ref-for-client"><c- g>Client</c-></a> {
    <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-clientlifecyclestate" id="ref-for-enumdef-clientlifecyclestate"><c- n>ClientLifecycleState</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="Client" data-dfn-type="attribute" data-export data-readonly data-type="ClientLifecycleState" id="dom-client-lifecyclestate"><code><c- g>lifecycleState</c-></code></dfn>;
};

<c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-clientlifecyclestate"><code><c- g>ClientLifecycleState</c-></code></dfn> {
    <dfn class="dfn-paneled idl-code" data-dfn-for="ClientLifecycleState" data-dfn-type="enum-value" data-export id="dom-clientlifecyclestate-active"><code><c- s>"active"</c-></code></dfn>,
    <dfn class="dfn-paneled idl-code" data-dfn-for="ClientLifecycleState" data-dfn-type="enum-value" data-export id="dom-clientlifecyclestate-frozen"><code><c- s>"frozen"</c-></code></dfn>
};
</pre>
   <p>A <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/ServiceWorker/#client" id="ref-for-client①">Client</a></code> object has an associated <dfn class="dfn-paneled" data-dfn-for="Client" data-dfn-type="dfn" data-noexport id="dfn-service-worker-client-lifecycle-state">lifecycle state</dfn>, which is one of the <code class="idl"><a data-link-type="idl" href="#enumdef-clientlifecyclestate" id="ref-for-enumdef-clientlifecyclestate①">ClientLifecycleState</a></code> enumeration values.</p>
   <h5 class="heading settled" data-level="5.3.1.1" id="service-worker-client-lifecycle-state"><span class="secno">5.3.1.1. </span><span class="content"><code class="idl"><a data-link-type="idl" href="#dom-serviceworkerclient-lifecyclestate" id="ref-for-dom-serviceworkerclient-lifecyclestate">lifecycleState</a></code></span><a class="self-link" href="#service-worker-client-lifecycle-state"></a></h5>
   <p>The <dfn class="dfn-paneled idl-code" data-dfn-for="ServiceWorkerClient" data-dfn-type="attribute" data-export id="dom-serviceworkerclient-lifecyclestate"><code>lifecycleState</code></dfn> attribute <em>must</em> return the <a data-link-type="dfn">context object</a>'s <a data-link-type="dfn" href="#dfn-service-worker-client-lifecycle-state" id="ref-for-dfn-service-worker-client-lifecycle-state">lifecycle state</a>.</p>
   <h5 class="heading settled" data-level="5.3.1.2" id="serviceworker-matchall-dfn"><span class="secno">5.3.1.2. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#clients-matchall"><code>matchAll(options)</code></a></span><a class="self-link" href="#serviceworker-matchall-dfn"></a></h5>
   <p>Rename variable in Step #4.</p>
   <ol>
    <li data-md>
     <p>Let <var>matchedClientData</var> be a new <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a>.</p>
   </ol>
   <p>Before Step #2.5.1 insert</p>
   <ol>
    <li data-md>
     <p>Let <var>lifecycleState</var> be the result of running <a data-link-type="dfn" href="#get-client-lifecycle-state" id="ref-for-get-client-lifecycle-state">Get Client Lifecycle State</a> with <var>client</var>.</p>
   </ol>
   <p>Append lifecycleState to list in Step #5.3.1</p>
   <ol>
    <li data-md>
     <p>Let <var>windowData</var> be «[ "client" → <var>client</var>, "ancestorOriginsList" → a new <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a>, "lifecycleState" → <var>lifecycleState</var> ]».</p>
   </ol>
   <p>Append lifecycleState to matchedClientData in Step #5.4</p>
   <ol>
    <li data-md>
     <p>Add «[ "client" → <var>client</var>, "lifecycleState" → <var>lifecycleState</var> ]» to <var>matchedClientData</var>.</p>
   </ol>
   <p>Pass windowData lifecycleState into Create Window Client algorithm in Step #6.2</p>
   <ol>
    <li data-md>
     <p>Let <var>windowClient</var> be the result of running <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm" id="ref-for-create-windowclient-algorithm">Create Window Client</a> algorithm with <var>windowData</var>["<code>client</code>"], <var>windowData</var>["<code>frameType</code>"], <var>windowData</var>["<code>visibilityState</code>"], <var>windowData</var>["<code>focusState</code>"], <var>windowData</var>["<code>ancestorOriginsList</code>"], and <var>windowData</var>["<code>lifecycleState</code>"] as the arguments.</p>
   </ol>
   <p>Adjust Step #6.3</p>
   <ol>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>clientData</var> in <var>matchedClientData</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>clientObject</var> be the result of running <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#create-client-algorithm" id="ref-for-create-client-algorithm">Create Client</a> algorithm with <var>clientData</var>["<code>client</code>"], and <var>clientData</var>["<code>lifecycleState</code>"] as the arguments.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append">Append</a> <var>clientObject</var> to <var>clientObjects</var>.</p>
     </ol>
   </ol>
   <h5 class="heading settled" data-level="5.3.1.3" id="serviceworker-openwindow-dfn"><span class="secno">5.3.1.3. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#dom-clients-openwindow"><code>openWindow(url)</code></a></span><a class="self-link" href="#serviceworker-openwindow-dfn"></a></h5>
   <p>Before Step #7.5 insert</p>
   <ol>
    <li data-md>
     <p>Let <var>lifecycleState</var> be the result of running <a data-link-type="dfn" href="#get-client-lifecycle-state" id="ref-for-get-client-lifecycle-state①">Get Client Lifecycle State</a> with <a data-link-type="dfn">context object</a>'s associated <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#dfn-service-worker-client" id="ref-for-dfn-service-worker-client">service worker client</a>.</p>
   </ol>
   <p>Adjust Step #7.8.2 to provide lifecycleState</p>
   <ol>
    <li data-md>
     <p>Let <var>client</var> be the result of running <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm" id="ref-for-create-windowclient-algorithm①">Create Window Client</a> with <var>newContext</var>’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window⑤">Window</a></code> object’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a>, <var>frameType</var>, <var>visibilityState</var>, <var>focusState</var>, <var>ancestorOriginsList</var>, and <var>lifecycleState</var> as the arguments.</p>
   </ol>
   <h4 class="heading settled" data-level="5.3.2" id="serviceworker-algorithms-dfn"><span class="secno">5.3.2. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#algorithms">Algorithms</a></span><a class="self-link" href="#serviceworker-algorithms-dfn"></a></h4>
   <section class="algorithm" data-algorithm="Get Client Lifecycle State">
    <h5 class="heading settled" data-level="5.3.2.1" id="get-client-lifecycle-state-algorithm"><span class="secno">5.3.2.1. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="get-client-lifecycle-state">Get Client Lifecycle State</dfn></span><a class="self-link" href="#get-client-lifecycle-state-algorithm"></a></h5>
    <p>Append the following algorithm:</p>
    <dl>
     <dt data-md>Input
     <dd data-md>
      <p><var>client</var>, a <a data-link-type="dfn" href="https://w3c.github.io/ServiceWorker/#dfn-service-worker-client" id="ref-for-dfn-service-worker-client①">service worker client</a></p>
     <dt data-md>Output
     <dd data-md>
      <p><var>state</var>, a string</p>
    </dl>
    <ol>
     <li data-md>
      <p>Let <var>state</var> be <code class="idl"><a data-link-type="idl" href="#dom-clientlifecyclestate-active" id="ref-for-dom-clientlifecyclestate-active">"active"</a></code>.</p>
     <li data-md>
      <p>If <var>client</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global" id="ref-for-concept-settings-object-global">global object</a>'s <a data-link-type="dfn" href="#dedicatedworkerglobalscope-owning-document" id="ref-for-dedicatedworkerglobalscope-owning-document②">owning document</a> is <a data-link-type="dfn" href="#frozen" id="ref-for-frozen⑥">frozen</a>, set <var>state</var> to be <code class="idl"><a data-link-type="idl" href="#dom-clientlifecyclestate-frozen" id="ref-for-dom-clientlifecyclestate-frozen">"frozen"</a></code></p>
     <li data-md>
      <p>Return <var>state</var>.</p>
    </ol>
   </section>
   <section class="algorithm" data-algorithm="create-client-monkeypatch">
    <h5 class="heading settled" data-level="5.3.2.2" id="serviceworker-createclient-dfn"><span class="secno">5.3.2.2. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#create-client-algorithm" id="a1dc1b890">Create Client</a></span><a class="self-link" href="#serviceworker-createclient-dfn"></a></h5>
    <p>To Input append <var>lifecycleState</var>, a string</p>
    <p>After Step #2 in Output append</p>
    <ol>
     <li data-md>
      <p>Set <var>clientObject</var>’s <a data-link-type="dfn" href="#dfn-service-worker-client-lifecycle-state" id="ref-for-dfn-service-worker-client-lifecycle-state①">lifecycle state</a> to <var>lifecycleState</var>.</p>
    </ol>
   </section>
   <section class="algorithm" data-algorithm="create-window-client-monkeypatch">
    <h5 class="heading settled" data-level="5.3.2.3" id="serviceworker-createwindowclient-dfn"><span class="secno">5.3.2.3. </span><span class="content"><a href="https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm" id="26c302460">Create Window Client</a></span><a class="self-link" href="#serviceworker-createwindowclient-dfn"></a></h5>
    <p>To Input append <var>lifecycleState</var>, a string</p>
    <p>After Step #5 in Output append</p>
    <ol>
     <li data-md>
      <p>Set <var>windowClient</var>’s <a data-link-type="dfn" href="#dfn-service-worker-client-lifecycle-state" id="ref-for-dfn-service-worker-client-lifecycle-state②">lifecycle state</a> to <var>lifecycleState</var>.</p>
    </ol>
   </section>
   <h3 class="heading settled" data-level="5.4" id="page-lifecycle"><span class="secno">5.4. </span><span class="content">Page lifecycle processing model</span><a class="self-link" href="#page-lifecycle"></a></h3>
   <h4 class="heading settled" data-level="5.4.1" id="frozenness-state"><span class="secno">5.4.1. </span><span class="content">FROZENNESS state</span><a class="self-link" href="#frozenness-state"></a></h4>
    A document can be in one of the following <dfn class="dfn-paneled" data-dfn-for="Document" data-dfn-type="dfn" data-noexport id="document-frozenness">FROZENNESS</dfn> states: 
   <ul>
    <li data-md>
     <p>true: the document is <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="frozen">frozen</dfn>, any tasks associated with the document will not run</p>
    <li data-md>
     <p>false: the document is <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="unfrozen">unfrozen</dfn>, tasks associated with the document will run as usual</p>
     <p class="note" role="note"><span class="marker">NOTE:</span> Per the <a data-link-type="dfn" href="#change-the-frozenness-of-a-top-level-document" id="ref-for-change-the-frozenness-of-a-top-level-document">change the frozenness of a top-level document</a> algorithm, when the Document of the top level browsing context changes its <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness②">frozenness</a> state then all documents of descendant browsing contexts will also change <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness③">frozenness</a> to the same value (and be consistent with the Document of the top level browsing context).</p>
   </ul>
   <p>The UA may choose to execute <a data-link-type="dfn" href="#change-the-frozenness-of-a-top-level-document" id="ref-for-change-the-frozenness-of-a-top-level-document①">change the frozenness of a top-level document</a> algorithm with true in certain situations.
For instance, if a top level browsing context is in the background or hidden, and a grace period has elapsed the UA could execute <a data-link-type="dfn" href="#change-the-frozenness-of-a-top-level-document" id="ref-for-change-the-frozenness-of-a-top-level-document②">change the frozenness of a top-level document</a> with true to conserve resources and maintain the quality of the (foreground) user experience.
Specific examples:</p>
   <ul>
    <li data-md>
     <p>In mobile Chrome, tabs that have been in background for (at least) 5 minutes, may be <a data-link-type="dfn" href="#frozen" id="ref-for-frozen⑦">frozen</a>, to conserve battery and data.</p>
    <li data-md>
     <p>In desktop Chrome, background tabs that are not important to the user (not used in some time) may be <a data-link-type="dfn" href="#discarded" id="ref-for-discarded③">discarded</a>, to conserve memory</p>
     <p class="note" role="note"><span class="marker">NOTE:</span> background tabs that are actively doing work on behalf of the user (eg. playing audio) are generally not <a data-link-type="dfn" href="#frozen" id="ref-for-frozen⑧">frozen</a> or <a data-link-type="dfn" href="#discarded" id="ref-for-discarded④">discarded</a>.</p>
     <p class="note" role="note"><span class="marker">NOTE:</span> For a detailed list of heuristics &amp; exclusions used by Chrome, see <a href="https://docs.google.com/document/d/1QJpuBTdllLVflMJSov0tlFX3e3yfSfd_-al2IBavbQM/edit">this doc</a>.</p>
   </ul>
   <p>The UA will typically execute <a data-link-type="dfn" href="#change-the-frozenness-of-a-top-level-document" id="ref-for-change-the-frozenness-of-a-top-level-document③">change the frozenness of a top-level document</a> with false when the user revisits that browsing context. In addition, the UA may choose to periodically execute <a data-link-type="dfn" href="#change-the-frozenness-of-a-top-level-document" id="ref-for-change-the-frozenness-of-a-top-level-document④">change the frozenness of a top-level document</a> with false in the background, if plentiful resources are available.</p>
   <h4 class="heading settled" data-level="5.4.2" id="changing-frozenness"><span class="secno">5.4.2. </span><span class="content">Changing the frozenness of documents</span><a class="self-link" href="#changing-frozenness"></a></h4>
   <div class="algorithm" data-algorithm="change the frozenness of a top-level document">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="change-the-frozenness-of-a-top-level-document">change the frozenness of a top-level document</dfn>, given a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑨">Document</a></code> <var>topLevelDoc</var> and boolean <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness④">frozenness</a> state <var>frozenness</var>: 
    <ol>
     <li data-md>
      <p class="assertion">Assert: <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc⑤">browsing context</a> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context">top-level browsing context</a>.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="#change-the-frozenness-of-a-document" id="ref-for-change-the-frozenness-of-a-document③">Change the frozenness of a document</a> given <var>topLevelDoc</var>, <var>frozenness</var>, and false.</p>
     <li data-md>
      <p>Let <var>descendants</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#list-of-the-descendant-browsing-contexts" id="ref-for-list-of-the-descendant-browsing-contexts">list of the descendant browsing contexts</a> of <var>doc</var>.</p>
     <li data-md>
      <p>For each <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context">browsing context</a> <var>b</var> in <var>descendants</var>:</p>
      <ol>
       <li data-md>
        <p>Let <var>descendantDocument</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document">active document</a> of <var>b</var>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="#change-the-frozenness-of-a-document" id="ref-for-change-the-frozenness-of-a-document④">Change the frozenness of a document</a> given <var>descendantDocument</var>, <var>frozenness</var>, and false.</p>
      </ol>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="change the frozenness of a document">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="change-the-frozenness-of-a-document">change the frozenness of a document</dfn>, given a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⓪">Document</a></code> <var>doc</var>, a boolean <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness⑤">frozenness</a> state <var>frozenness</var>, and a boolean <var>auto resume frozen media</var>: 
    <ol>
     <li data-md>
      <p>If <var>frozenness</var> is true, run the <a data-link-type="dfn" href="#freeze-steps" id="ref-for-freeze-steps①">freeze steps</a> for <var>doc</var> given <var>auto resume frozen media</var>.</p>
     <li data-md>
      <p>Otherwise, run the <a data-link-type="dfn" href="#resume-steps" id="ref-for-resume-steps">resume steps</a> given <var>doc</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="freeze steps">
     To run the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="freeze-steps">freeze steps</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①①">Document</a></code> <var>doc</var>, given a boolean <var>auto resume frozen media</var>: 
    <ol>
     <li data-md>
      <p>Set <var>doc</var>’s <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness⑥">frozenness</a> state to true.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire">Fire an event</a> named <code>freeze</code> at <var>doc</var>.</p>
     <li data-md>
      <p>Let <var>elements</var> be all <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/media.html#media-element" id="ref-for-media-element">media elements</a> that are <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant" id="ref-for-concept-shadow-including-descendant">shadow-including descendants</a> of <var>doc</var>, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order">shadow-including tree order</a>.</p>
     <li data-md>
      <p>For each <var>element</var> in <var>elements</var>:</p>
      <ol>
       <li data-md>
        <p>If <var>element</var>’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#dom-media-paused" id="ref-for-dom-media-paused">paused</a></code> is false, then:</p>
        <ol>
         <li data-md>
          <p>Set <var>element</var>’s <a data-link-type="dfn" href="#htmlmediaelement-resume-frozen-flag" id="ref-for-htmlmediaelement-resume-frozen-flag">resume frozen flag</a> to <var>auto resume frozen media</var>.</p>
         <li data-md>
          <p>Execute <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/media.html#internal-pause-steps" id="ref-for-internal-pause-steps">media pause</a> on <var>element</var>.</p>
        </ol>
      </ol>
      <p class="note" role="note"><span class="marker">NOTE:</span> it is intentional that the ordering between the assignment of the of frozneness state
occurs first before event firing.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="resume steps">
     To run the <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="resume-steps">resume steps</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①②">Document</a></code> <var>doc</var>: 
    <ol>
     <li data-md>
      <p>Let <var>elements</var> be all <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/media.html#media-element" id="ref-for-media-element①">media elements</a> that are <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant" id="ref-for-concept-shadow-including-descendant①">shadow-including descendants</a> of <var>doc</var>, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order①">shadow-including tree order</a>.</p>
      <ol>
       <li data-md>
        <p>For each <var>element</var> in <var>elements</var>:</p>
        <ol>
         <li data-md>
          <p>If <var>elements</var>’s <a data-link-type="dfn" href="#htmlmediaelement-resume-frozen-flag" id="ref-for-htmlmediaelement-resume-frozen-flag①">resume frozen flag</a> is true.</p>
          <ol>
           <li data-md>
            <p>Set <var>elements</var>’s <a data-link-type="dfn" href="#htmlmediaelement-resume-frozen-flag" id="ref-for-htmlmediaelement-resume-frozen-flag②">resume frozen flag</a> to false.</p>
           <li data-md>
            <p>Execute <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/media.html#internal-play-steps" id="ref-for-internal-play-steps">media play</a> on <var>element</var>.</p>
          </ol>
        </ol>
      </ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-event-fire" id="ref-for-concept-event-fire①">Fire an event</a> named <code>resume</code> at <var>doc</var>.</p>
     <li data-md>
      <p>Set <var>doc</var>’s <a data-link-type="dfn" href="#document-frozenness" id="ref-for-document-frozenness⑦">frozenness</a> state to false.</p>
      <p class="note" role="note"><span class="marker">NOTE:</span> it is intentional that the ordering between the assignment of the of frozneness state
comes last after event firing.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="5.4.3" id="discarding"><span class="secno">5.4.3. </span><span class="content">Discarding</span><a class="self-link" href="#discarding"></a></h4>
    Each Document has a <dfn class="dfn-paneled" data-dfn-for="Document" data-dfn-type="dfn" data-noexport id="document-discarded">discarded</dfn> boolean, which is initially false. 
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="discarded|discard" id="discarded">discard</dfn> a browsing context, <a href="https://html.spec.whatwg.org/multipage/window-object.html#a-browsing-context-is-discarded">destroy the browsing context</a>, and make note of the fact that the reason it and any descendant browsing contents were destroyed was because of discarding.</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> <a data-link-type="dfn" href="#discarded" id="ref-for-discarded⑤">Discard</a> is typically done to reclaim system memory, when memory and other resources are running low. On the other hand destroying a browser context is the normal teardown due to user leaving the page etc.</p>
   <p>Browsing contexts -- that are in the background and have their documents in <a href="https://www.w3.org/TR/page-visibility-2/#visibility-states-and-the-visibilitystate-enum">VisibilityState hidden</a> -- can be <a data-link-type="dfn" href="#discarded" id="ref-for-discarded⑥">discarded</a>, under resource pressure (eg. low memory). Specific example:</p>
   <ul>
    <li data-md>
     <p>In desktop Chrome, background tabs that are not important to the user (not used in some time) may be <a data-link-type="dfn" href="#discarded" id="ref-for-discarded⑦">discarded</a>, to conserve memory</p>
     <p class="note" role="note"><span class="marker">NOTE:</span> background tabs that are actively doing work on behalf of the user (eg. playing audio) are generally not <a data-link-type="dfn" href="#discarded" id="ref-for-discarded⑧">discarded</a>.</p>
     <p class="note" role="note"><span class="marker">NOTE:</span> For a detailed list of heuristics &amp; exclusions used by Chrome, see <a href="https://docs.google.com/document/d/1QJpuBTdllLVflMJSov0tlFX3e3yfSfd_-al2IBavbQM/edit">this doc</a>.</p>
   </ul>
   <p>When a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context①">top-level browsing context</a> (tab in the browser) is <a data-link-type="dfn" href="#discarded" id="ref-for-discarded⑨">discarded</a> due to resource pressure (or unexpected events eg. process crash), and later the user revisits the tab in the browser, then the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①③">Document</a></code>'s <a data-link-type="dfn" href="#document-discarded" id="ref-for-document-discarded②">discarded</a> boolean will be true due to <a href="#html-initialize-doc">§ 5.2.5 Initialize the document</a>.</p>
   <h2 class="heading settled" data-level="6" id="acknowledgements"><span class="secno">6. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p>Special thanks to
Dave Tapuska,
Fadi Meawad,
Ojan Vafai,
Olli Pettay,
Philip Walton, and
Todd Reifsteck
for their technical input and suggestions that led to improvements to this specification.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
   <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
   <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#dom-clientlifecyclestate-active">"active"</a><span>, in § 5.3.1</span>
   <li><a href="#change-the-frozenness-of-a-document">change the frozenness of a document</a><span>, in § 5.4.2</span>
   <li><a href="#change-the-frozenness-of-a-top-level-document">change the frozenness of a top-level document</a><span>, in § 5.4.2</span>
   <li><a href="#enumdef-clientlifecyclestate">ClientLifecycleState</a><span>, in § 5.3.1</span>
   <li><a href="#discarded">discard</a><span>, in § 5.4.3</span>
   <li>
    discarded
    <ul>
     <li><a href="#discarded">definition of</a><span>, in § 5.4.3</span>
     <li><a href="#document-discarded">dfn for Document</a><span>, in § 5.4.3</span>
    </ul>
   <li><a href="#execution-while-not-rendered">execution-while-not-rendered</a><span>, in § 4</span>
   <li><a href="#execution-while-out-of-viewport">execution-while-out-of-viewport</a><span>, in § 4</span>
   <li><a href="#freeze-steps">freeze steps</a><span>, in § 5.4.2</span>
   <li><a href="#dom-clientlifecyclestate-frozen">"frozen"</a><span>, in § 5.3.1</span>
   <li><a href="#frozen">frozen</a><span>, in § 5.4.1</span>
   <li><a href="#document-frozenness">FROZENNESS</a><span>, in § 5.4.1</span>
   <li><a href="#get-client-lifecycle-state">Get Client Lifecycle State</a><span>, in § 5.3.2.1</span>
   <li><a href="#dfn-service-worker-client-lifecycle-state">lifecycle state</a><span>, in § 5.3.1</span>
   <li>
    lifecycleState
    <ul>
     <li><a href="#dom-client-lifecyclestate">attribute for Client</a><span>, in § 5.3.1</span>
     <li><a href="#dom-serviceworkerclient-lifecyclestate">attribute for ServiceWorkerClient</a><span>, in § 5.3.1.1</span>
    </ul>
   <li><a href="#dom-document-onfreeze">onfreeze</a><span>, in § 3</span>
   <li><a href="#dom-document-onresume">onresume</a><span>, in § 3</span>
   <li><a href="#dedicatedworkerglobalscope-owning-document">owning document</a><span>, in § 5.1</span>
   <li><a href="#htmlmediaelement-resume-frozen-flag">resume frozen flag</a><span>, in § 5.2.7</span>
   <li><a href="#resume-steps">resume steps</a><span>, in § 5.4.2</span>
   <li><a href="#unfrozen">unfrozen</a><span>, in § 5.4.1</span>
   <li><a href="#update-document-frozenness-steps">update document frozenness steps</a><span>, in § 4</span>
   <li><a href="#dom-document-wasdiscarded">wasDiscarded</a><span>, in § 3</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSS-HOUDINI]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="84dda3ef">owning document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS21]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="7ed32311">viewport</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
     <li><span class="dfn-paneled" id="5fd23811">fire an event</span>
     <li><span class="dfn-paneled" id="fd32e3c9">shadow-including descendant</span>
     <li><span class="dfn-paneled" id="fefa5851">shadow-including tree order</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ECMA262]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e4f5ffc9">blocked</span>
     <li><span class="dfn-paneled" id="a262536f">realm</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b8308563">DedicatedWorkerGlobalScope</span>
     <li><span class="dfn-paneled" id="f0951476">EventHandler</span>
     <li><span class="dfn-paneled" id="1076ec40">HTMLMediaElement</span>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="35972864">active document</span>
     <li><span class="dfn-paneled" id="3610bd67">allowed to use</span>
     <li><span class="dfn-paneled" id="f8434dee">being rendered</span>
     <li><span class="dfn-paneled" id="0d0390b4">browsing context</span>
     <li><span class="dfn-paneled" id="3b2ff63e">browsing context <small>(for Document)</small></span>
     <li><span class="dfn-paneled" id="6d88ab2e">browsing context <small>(for Window)</small></span>
     <li><span class="dfn-paneled" id="e0ab744a">browsing context <small>(for document)</small></span>
     <li><span class="dfn-paneled" id="7939ecaf">browsing context container</span>
     <li><span class="dfn-paneled" id="5e00dfbe">dedicated worker agent</span>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="03675365">event handler idl attribute</span>
     <li><span class="dfn-paneled" id="0e3ba9f8">fully active</span>
     <li><span class="dfn-paneled" id="8a30477b">global object</span>
     <li><span class="dfn-paneled" id="de8e3970">iframe load event steps</span>
     <li><span class="dfn-paneled" id="10e56401">list of the descendant browsing contexts</span>
     <li><span class="dfn-paneled" id="c0e5df6d">media elements</span>
     <li><span class="dfn-paneled" id="45ff3c03">media pause</span>
     <li><span class="dfn-paneled" id="9b3a0a68">media play</span>
     <li><span class="dfn-paneled" id="dc248371">owner set</span>
     <li><span class="dfn-paneled" id="eb577fbe">paused</span>
     <li><span class="dfn-paneled" id="a4e9d351">persisted</span>
     <li><span class="dfn-paneled" id="472bdad1">posted message task source</span>
     <li><span class="dfn-paneled" id="18001985">readiness</span>
     <li><span class="dfn-paneled" id="e270bd2a">task</span>
     <li><span class="dfn-paneled" id="ae2a6342">top-level browsing context</span>
     <li><span class="dfn-paneled" id="67e013c1">traverse the history</span>
     <li><span class="dfn-paneled" id="b815f411">update the rendering</span>
     <li><span class="dfn-paneled" id="80c628f6">worklet agent</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="53275e46">append</span>
     <li><span class="dfn-paneled" id="16d07e10">for each</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INTERSECTIONOBSERVER]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="842ca567">compute the intersection of a target element and the root</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1570624a">default allowlist</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SERVICE-WORKERS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3b7e827f">Client</span>
     <li><span class="dfn-paneled" id="fd83f0b6">service worker client</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SERVICEWORKER]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="84b84a54">create client</span>
     <li><span class="dfn-paneled" id="f7b5fd7e">create window client</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css21">[CSS21]
   <dd>Bert Bos; et al. <a href="https://drafts.csswg.org/css2/"><cite>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</cite></a>. URL: <a href="https://drafts.csswg.org/css2/">https://drafts.csswg.org/css2/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions-policy-1">[PERMISSIONS-POLICY-1]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-service-workers">[SERVICE-WORKERS]
   <dd>Jake Archibald; Marijn Kruisselbrink. <a href="https://w3c.github.io/ServiceWorker/"><cite>Service Workers</cite></a>. URL: <a href="https://w3c.github.io/ServiceWorker/">https://w3c.github.io/ServiceWorker/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-page-visibility">[PAGE-VISIBILITY]
   <dd>Jatinder Mann; Arvind Jain. <a href="https://www.w3.org/TR/page-visibility/"><cite>Page Visibility (Second Edition)</cite></a>. 29 October 2013. REC. URL: <a href="https://www.w3.org/TR/page-visibility/">https://www.w3.org/TR/page-visibility/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-document-onfreeze"><c- g>onfreeze</c-></a>;
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"><c- n>EventHandler</c-></a> <a class="idl-code" data-link-type="attribute" data-type="EventHandler" href="#dom-document-onresume"><c- g>onresume</c-></a>;
    <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="boolean" href="#dom-document-wasdiscarded"><c- g>wasDiscarded</c-></a>;
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://w3c.github.io/ServiceWorker/#client"><c- g>Client</c-></a> {
    <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-clientlifecyclestate"><c- n>ClientLifecycleState</c-></a> <a data-readonly data-type="ClientLifecycleState" href="#dom-client-lifecyclestate"><code><c- g>lifecycleState</c-></code></a>;
};

<c- b>enum</c-> <a href="#enumdef-clientlifecyclestate"><code><c- g>ClientLifecycleState</c-></code></a> {
    <a href="#dom-clientlifecyclestate-active"><code><c- s>"active"</c-></code></a>,
    <a href="#dom-clientlifecyclestate-frozen"><code><c- s>"frozen"</c-></code></a>
};

</pre>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"03675365": {"dfnID":"03675365","dfnText":"event handler idl attribute","external":true,"refSections":[{"refs":[{"id":"ref-for-event-handler-idl-attributes"}],"title":"3. API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes"},
"0d0390b4": {"dfnID":"0d0390b4","dfnText":"browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-browsing-context"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context"},
"0e3ba9f8": {"dfnID":"0e3ba9f8","dfnText":"fully active","external":true,"refSections":[{"refs":[{"id":"ref-for-fully-active"},{"id":"ref-for-fully-active\u2460"}],"title":"5.2.2. Event loop: definitions"},{"refs":[{"id":"ref-for-fully-active\u2461"}],"title":"5.2.3. Event loop: processing model"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"},
"1076ec40": {"dfnID":"1076ec40","dfnText":"HTMLMediaElement","external":true,"refSections":[{"refs":[{"id":"ref-for-htmlmediaelement"},{"id":"ref-for-htmlmediaelement\u2460"}],"title":"5.2.7. HTMLMediaElement"}],"url":"https://html.spec.whatwg.org/multipage/media.html#htmlmediaelement"},
"10e56401": {"dfnID":"10e56401","dfnText":"list of the descendant browsing contexts","external":true,"refSections":[{"refs":[{"id":"ref-for-list-of-the-descendant-browsing-contexts"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#list-of-the-descendant-browsing-contexts"},
"1570624a": {"dfnID":"1570624a","dfnText":"default allowlist","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature-default-allowlist"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460"}],"title":"4. Feature Policies"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"16d07e10": {"dfnID":"16d07e10","dfnText":"for each","external":true,"refSections":[{"refs":[{"id":"ref-for-list-iterate"}],"title":"5.3.1.2. matchAll(options)"}],"url":"https://infra.spec.whatwg.org/#list-iterate"},
"18001985": {"dfnID":"18001985","dfnText":"readiness","external":true,"refSections":[{"refs":[{"id":"ref-for-current-document-readiness"}],"title":"4. Feature Policies"}],"url":"https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness"},
"35972864": {"dfnID":"35972864","dfnText":"active document","external":true,"refSections":[{"refs":[{"id":"ref-for-nav-document"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"3610bd67": {"dfnID":"3610bd67","dfnText":"allowed to use","external":true,"refSections":[{"refs":[{"id":"ref-for-allowed-to-use"},{"id":"ref-for-allowed-to-use\u2460"}],"title":"4. Feature Policies"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"3b2ff63e": {"dfnID":"3b2ff63e","dfnText":"browsing context (for Document)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-bc\u2464"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"3b7e827f": {"dfnID":"3b7e827f","dfnText":"Client","external":true,"refSections":[{"refs":[{"id":"ref-for-client"},{"id":"ref-for-client\u2460"}],"title":"5.3.1. Client"}],"url":"https://w3c.github.io/ServiceWorker/#client"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"5.3.1.3. openWindow(url)"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"45ff3c03": {"dfnID":"45ff3c03","dfnText":"media pause","external":true,"refSections":[{"refs":[{"id":"ref-for-internal-pause-steps"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/media.html#internal-pause-steps"},
"472bdad1": {"dfnID":"472bdad1","dfnText":"posted message task source","external":true,"refSections":[{"refs":[{"id":"ref-for-posted-message-task-source"}],"title":"5.2.8. Posting messages"}],"url":"https://html.spec.whatwg.org/multipage/web-messaging.html#posted-message-task-source"},
"53275e46": {"dfnID":"53275e46","dfnText":"append","external":true,"refSections":[{"refs":[{"id":"ref-for-list-append"}],"title":"5.3.1.2. matchAll(options)"}],"url":"https://infra.spec.whatwg.org/#list-append"},
"5372cca8": {"dfnID":"5372cca8","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-boolean"}],"title":"3. API"}],"url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"},{"id":"ref-for-window\u2460"}],"title":"3. API"},{"refs":[{"id":"ref-for-window\u2461"},{"id":"ref-for-window\u2462"},{"id":"ref-for-window\u2463"}],"title":"5.2.8. Posting messages"},{"refs":[{"id":"ref-for-window\u2464"}],"title":"5.3.1.3. openWindow(url)"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"5e00dfbe": {"dfnID":"5e00dfbe","dfnText":"dedicated worker agent","external":true,"refSections":[{"refs":[{"id":"ref-for-dedicated-worker-agent"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#dedicated-worker-agent"},
"5fd23811": {"dfnID":"5fd23811","dfnText":"fire an event","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-event-fire"},{"id":"ref-for-concept-event-fire\u2460"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://dom.spec.whatwg.org/#concept-event-fire"},
"649608b9": {"dfnID":"649608b9","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-list"},{"id":"ref-for-list\u2460"}],"title":"5.3.1.2. matchAll(options)"}],"url":"https://infra.spec.whatwg.org/#list"},
"67e013c1": {"dfnID":"67e013c1","dfnText":"traverse the history","external":true,"refSections":[{"refs":[{"id":"ref-for-traverse-the-history"}],"title":"5.2.1. Unloading documents and history traversal"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#traverse-the-history"},
"6d88ab2e": {"dfnID":"6d88ab2e","dfnText":"browsing context (for Window)","external":true,"refSections":[{"refs":[{"id":"ref-for-window-bc"}],"title":"5.2.8. Posting messages"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc"},
"7939ecaf": {"dfnID":"7939ecaf","dfnText":"browsing context container","external":true,"refSections":[{"refs":[{"id":"ref-for-browsing-context-container"},{"id":"ref-for-browsing-context-container\u2460"},{"id":"ref-for-browsing-context-container\u2461"}],"title":"4. Feature Policies"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container"},
"7ed32311": {"dfnID":"7ed32311","dfnText":"viewport","external":true,"refSections":[{"refs":[{"id":"ref-for-viewport"},{"id":"ref-for-viewport\u2460"},{"id":"ref-for-viewport\u2461"}],"title":"4. Feature Policies"}],"url":"https://www.w3.org/TR/CSS2/visuren.html#viewport"},
"80c628f6": {"dfnID":"80c628f6","dfnText":"worklet agent","external":true,"refSections":[{"refs":[{"id":"ref-for-worklet-agent"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#worklet-agent"},
"842ca567": {"dfnID":"842ca567","dfnText":"compute the intersection of a target element and the root","external":true,"refSections":[{"refs":[{"id":"ref-for-calculate-intersection-rect-algo"},{"id":"ref-for-calculate-intersection-rect-algo\u2460"}],"title":"4. Feature Policies"}],"url":"https://w3c.github.io/IntersectionObserver/#calculate-intersection-rect-algo"},
"84b84a54": {"dfnID":"84b84a54","dfnText":"create client","external":true,"refSections":[{"refs":[{"id":"ref-for-create-client-algorithm"}],"title":"5.3.1.2. matchAll(options)"},{"refs":[{"id":"a1dc1b890"}],"title":"5.3.2.2. Create Client"}],"url":"https://w3c.github.io/ServiceWorker/#create-client-algorithm"},
"84dda3ef": {"dfnID":"84dda3ef","dfnText":"owning document","external":true,"refSections":[{"refs":[{"id":"ref-for-workletglobalscope-owner-document"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://drafts.css-houdini.org/worklets#workletglobalscope-owner-document"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"},{"id":"ref-for-document\u2460"}],"title":"2. Page Lifecycle States"},{"refs":[{"id":"ref-for-document\u2461"},{"id":"ref-for-document\u2462"},{"id":"ref-for-document\u2463"}],"title":"3. API"},{"refs":[{"id":"ref-for-document\u2464"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-document\u2465"}],"title":"5.1. Modifications to worklet and worker behavior"},{"refs":[{"id":"ref-for-document\u2466"}],"title":"5.2.3. Event loop: processing model"},{"refs":[{"id":"ref-for-document\u2467"}],"title":"5.2.5. Initialize the document"},{"refs":[{"id":"ref-for-document\u2468"},{"id":"ref-for-document\u2460\u24ea"},{"id":"ref-for-document\u2460\u2460"},{"id":"ref-for-document\u2460\u2461"}],"title":"5.4.2. Changing the frozenness of documents"},{"refs":[{"id":"ref-for-document\u2460\u2462"}],"title":"5.4.3. Discarding"}],"url":"https://dom.spec.whatwg.org/#document"},
"8a30477b": {"dfnID":"8a30477b","dfnText":"global object","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-global"}],"title":"5.3.2.1. Get Client Lifecycle State"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global"},
"9b3a0a68": {"dfnID":"9b3a0a68","dfnText":"media play","external":true,"refSections":[{"refs":[{"id":"ref-for-internal-play-steps"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/media.html#internal-play-steps"},
"a262536f": {"dfnID":"a262536f","dfnText":"realm","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-code-realms"},{"id":"ref-for-sec-code-realms\u2460"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://tc39.github.io/ecma262/#sec-code-realms"},
"a4e9d351": {"dfnID":"a4e9d351","dfnText":"persisted","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-pagetransitionevent-persisted"},{"id":"ref-for-dom-pagetransitionevent-persisted\u2460"}],"title":"5.2.1. Unloading documents and history traversal"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#dom-pagetransitionevent-persisted"},
"a973e0fe": {"dfnID":"a973e0fe","dfnText":"document","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document"},{"id":"ref-for-concept-document\u2460"}],"title":"5.2.2. Event loop: definitions"}],"url":"https://dom.spec.whatwg.org/#concept-document"},
"ae2a6342": {"dfnID":"ae2a6342","dfnText":"top-level browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-top-level-browsing-context"}],"title":"5.4.2. Changing the frozenness of documents"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2460"}],"title":"5.4.3. Discarding"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"b815f411": {"dfnID":"b815f411","dfnText":"update the rendering","external":true,"refSections":[{"refs":[{"id":"ref-for-update-the-rendering"}],"title":"5.2.3. Event loop: processing model"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#update-the-rendering"},
"b8308563": {"dfnID":"b8308563","dfnText":"DedicatedWorkerGlobalScope","external":true,"refSections":[{"refs":[{"id":"ref-for-dedicatedworkerglobalscope"},{"id":"ref-for-dedicatedworkerglobalscope\u2460"},{"id":"ref-for-dedicatedworkerglobalscope\u2461"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope"},
"c0e5df6d": {"dfnID":"c0e5df6d","dfnText":"media elements","external":true,"refSections":[{"refs":[{"id":"ref-for-media-element"},{"id":"ref-for-media-element\u2460"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/media.html#media-element"},
"change-the-frozenness-of-a-document": {"dfnID":"change-the-frozenness-of-a-document","dfnText":"change the frozenness of a document","external":false,"refSections":[{"refs":[{"id":"ref-for-change-the-frozenness-of-a-document"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-change-the-frozenness-of-a-document\u2460"},{"id":"ref-for-change-the-frozenness-of-a-document\u2461"}],"title":"5.2.1. Unloading documents and history traversal"},{"refs":[{"id":"ref-for-change-the-frozenness-of-a-document\u2462"},{"id":"ref-for-change-the-frozenness-of-a-document\u2463"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"#change-the-frozenness-of-a-document"},
"change-the-frozenness-of-a-top-level-document": {"dfnID":"change-the-frozenness-of-a-top-level-document","dfnText":"change the frozenness of a top-level document","external":false,"refSections":[{"refs":[{"id":"ref-for-change-the-frozenness-of-a-top-level-document"},{"id":"ref-for-change-the-frozenness-of-a-top-level-document\u2460"},{"id":"ref-for-change-the-frozenness-of-a-top-level-document\u2461"},{"id":"ref-for-change-the-frozenness-of-a-top-level-document\u2462"},{"id":"ref-for-change-the-frozenness-of-a-top-level-document\u2463"}],"title":"5.4.1. FROZENNESS state"}],"url":"#change-the-frozenness-of-a-top-level-document"},
"dc248371": {"dfnID":"dc248371","dfnText":"owner set","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-WorkerGlobalScope-owner-set"},{"id":"ref-for-concept-WorkerGlobalScope-owner-set\u2460"},{"id":"ref-for-concept-WorkerGlobalScope-owner-set\u2461"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set"},
"de8e3970": {"dfnID":"de8e3970","dfnText":"iframe load event steps","external":true,"refSections":[{"refs":[{"id":"ref-for-iframe-load-event-steps"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-iframe-load-event-steps\u2460"}],"title":"5.2.6. iframe load event steps"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#iframe-load-event-steps"},
"dedicatedworkerglobalscope-owning-document": {"dfnID":"dedicatedworkerglobalscope-owning-document","dfnText":"owning document","external":false,"refSections":[{"refs":[{"id":"ref-for-dedicatedworkerglobalscope-owning-document"},{"id":"ref-for-dedicatedworkerglobalscope-owning-document\u2460"}],"title":"5.1. Modifications to worklet and worker behavior"},{"refs":[{"id":"ref-for-dedicatedworkerglobalscope-owning-document\u2461"}],"title":"5.3.2.1. Get Client Lifecycle State"}],"url":"#dedicatedworkerglobalscope-owning-document"},
"dfn-service-worker-client-lifecycle-state": {"dfnID":"dfn-service-worker-client-lifecycle-state","dfnText":"lifecycle state","external":false,"refSections":[{"refs":[{"id":"ref-for-dfn-service-worker-client-lifecycle-state"}],"title":"5.3.1.1. lifecycleState"},{"refs":[{"id":"ref-for-dfn-service-worker-client-lifecycle-state\u2460"}],"title":"5.3.2.2. Create Client"},{"refs":[{"id":"ref-for-dfn-service-worker-client-lifecycle-state\u2461"}],"title":"5.3.2.3. Create Window Client"}],"url":"#dfn-service-worker-client-lifecycle-state"},
"discarded": {"dfnID":"discarded","dfnText":"discard","external":false,"refSections":[{"refs":[{"id":"ref-for-discarded"}],"title":"2. Page Lifecycle States"},{"refs":[{"id":"ref-for-discarded\u2460"}],"title":"5.2.5. Initialize the document"},{"refs":[{"id":"ref-for-discarded\u2461"}],"title":"5.2.8. Posting messages"},{"refs":[{"id":"ref-for-discarded\u2462"},{"id":"ref-for-discarded\u2463"}],"title":"5.4.1. FROZENNESS state"},{"refs":[{"id":"ref-for-discarded\u2464"},{"id":"ref-for-discarded\u2465"},{"id":"ref-for-discarded\u2466"},{"id":"ref-for-discarded\u2467"},{"id":"ref-for-discarded\u2468"}],"title":"5.4.3. Discarding"}],"url":"#discarded"},
"document-discarded": {"dfnID":"document-discarded","dfnText":"discarded","external":false,"refSections":[{"refs":[{"id":"ref-for-document-discarded"}],"title":"3. API"},{"refs":[{"id":"ref-for-document-discarded\u2460"}],"title":"5.2.5. Initialize the document"},{"refs":[{"id":"ref-for-document-discarded\u2461"}],"title":"5.4.3. Discarding"}],"url":"#document-discarded"},
"document-frozenness": {"dfnID":"document-frozenness","dfnText":"FROZENNESS","external":false,"refSections":[{"refs":[{"id":"ref-for-document-frozenness"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-document-frozenness\u2460"}],"title":"5.2.1. Unloading documents and history traversal"},{"refs":[{"id":"ref-for-document-frozenness\u2461"},{"id":"ref-for-document-frozenness\u2462"}],"title":"5.4.1. FROZENNESS state"},{"refs":[{"id":"ref-for-document-frozenness\u2463"},{"id":"ref-for-document-frozenness\u2464"},{"id":"ref-for-document-frozenness\u2465"},{"id":"ref-for-document-frozenness\u2466"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"#document-frozenness"},
"dom-client-lifecyclestate": {"dfnID":"dom-client-lifecyclestate","dfnText":"lifecycleState","external":false,"refSections":[],"url":"#dom-client-lifecyclestate"},
"dom-clientlifecyclestate-active": {"dfnID":"dom-clientlifecyclestate-active","dfnText":"\"active\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-clientlifecyclestate-active"}],"title":"5.3.2.1. Get Client Lifecycle State"}],"url":"#dom-clientlifecyclestate-active"},
"dom-clientlifecyclestate-frozen": {"dfnID":"dom-clientlifecyclestate-frozen","dfnText":"\"frozen\"","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-clientlifecyclestate-frozen"}],"title":"5.3.2.1. Get Client Lifecycle State"}],"url":"#dom-clientlifecyclestate-frozen"},
"dom-document-onfreeze": {"dfnID":"dom-document-onfreeze","dfnText":"onfreeze","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-onfreeze"}],"title":"3. API"}],"url":"#dom-document-onfreeze"},
"dom-document-onresume": {"dfnID":"dom-document-onresume","dfnText":"onresume","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-onresume"}],"title":"3. API"}],"url":"#dom-document-onresume"},
"dom-document-wasdiscarded": {"dfnID":"dom-document-wasdiscarded","dfnText":"wasDiscarded","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-wasdiscarded"}],"title":"3. API"},{"refs":[{"id":"ref-for-dom-document-wasdiscarded\u2460"}],"title":"5.2.4. Discarding browsing contexts"}],"url":"#dom-document-wasdiscarded"},
"dom-serviceworkerclient-lifecyclestate": {"dfnID":"dom-serviceworkerclient-lifecyclestate","dfnText":"lifecycleState","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-serviceworkerclient-lifecyclestate"}],"title":"5.3.1.1. lifecycleState"}],"url":"#dom-serviceworkerclient-lifecyclestate"},
"e0ab744a": {"dfnID":"e0ab744a","dfnText":"browsing context (for document)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-bc"},{"id":"ref-for-concept-document-bc\u2460"}],"title":"2. Page Lifecycle States"},{"refs":[{"id":"ref-for-concept-document-bc\u2461"},{"id":"ref-for-concept-document-bc\u2462"},{"id":"ref-for-concept-document-bc\u2463"}],"title":"4. Feature Policies"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc"},
"e270bd2a": {"dfnID":"e270bd2a","dfnText":"task","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-task"},{"id":"ref-for-concept-task\u2460"}],"title":"5.2.2. Event loop: definitions"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task"},
"e4f5ffc9": {"dfnID":"e4f5ffc9","dfnText":"blocked","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-forward-progress"},{"id":"ref-for-sec-forward-progress\u2460"}],"title":"5.1. Modifications to worklet and worker behavior"}],"url":"https://tc39.github.io/ecma262/#sec-forward-progress"},
"eb577fbe": {"dfnID":"eb577fbe","dfnText":"paused","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-media-paused"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://html.spec.whatwg.org/multipage/media.html#dom-media-paused"},
"enumdef-clientlifecyclestate": {"dfnID":"enumdef-clientlifecyclestate","dfnText":"ClientLifecycleState","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-clientlifecyclestate"},{"id":"ref-for-enumdef-clientlifecyclestate\u2460"}],"title":"5.3.1. Client"}],"url":"#enumdef-clientlifecyclestate"},
"execution-while-not-rendered": {"dfnID":"execution-while-not-rendered","dfnText":"execution-while-not-rendered","external":false,"refSections":[{"refs":[{"id":"ref-for-execution-while-not-rendered"},{"id":"ref-for-execution-while-not-rendered\u2460"}],"title":"4. Feature Policies"}],"url":"#execution-while-not-rendered"},
"execution-while-out-of-viewport": {"dfnID":"execution-while-out-of-viewport","dfnText":"execution-while-out-of-viewport","external":false,"refSections":[{"refs":[{"id":"ref-for-execution-while-out-of-viewport"},{"id":"ref-for-execution-while-out-of-viewport\u2460"}],"title":"4. Feature Policies"}],"url":"#execution-while-out-of-viewport"},
"f0951476": {"dfnID":"f0951476","dfnText":"EventHandler","external":true,"refSections":[{"refs":[{"id":"ref-for-eventhandler"},{"id":"ref-for-eventhandler\u2460"}],"title":"3. API"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"},
"f7b5fd7e": {"dfnID":"f7b5fd7e","dfnText":"create window client","external":true,"refSections":[{"refs":[{"id":"ref-for-create-windowclient-algorithm"}],"title":"5.3.1.2. matchAll(options)"},{"refs":[{"id":"ref-for-create-windowclient-algorithm\u2460"}],"title":"5.3.1.3. openWindow(url)"},{"refs":[{"id":"26c302460"}],"title":"5.3.2.3. Create Window Client"}],"url":"https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm"},
"f8434dee": {"dfnID":"f8434dee","dfnText":"being rendered","external":true,"refSections":[{"refs":[{"id":"ref-for-being-rendered"},{"id":"ref-for-being-rendered\u2460"},{"id":"ref-for-being-rendered\u2461"}],"title":"4. Feature Policies"}],"url":"https://html.spec.whatwg.org/multipage/rendering.html#being-rendered"},
"fd32e3c9": {"dfnID":"fd32e3c9","dfnText":"shadow-including descendant","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-shadow-including-descendant"},{"id":"ref-for-concept-shadow-including-descendant\u2460"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://dom.spec.whatwg.org/#concept-shadow-including-descendant"},
"fd83f0b6": {"dfnID":"fd83f0b6","dfnText":"service worker client","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-service-worker-client"}],"title":"5.3.1.3. openWindow(url)"},{"refs":[{"id":"ref-for-dfn-service-worker-client\u2460"}],"title":"5.3.2.1. Get Client Lifecycle State"}],"url":"https://w3c.github.io/ServiceWorker/#dfn-service-worker-client"},
"fefa5851": {"dfnID":"fefa5851","dfnText":"shadow-including tree order","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-shadow-including-tree-order"},{"id":"ref-for-concept-shadow-including-tree-order\u2460"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"https://dom.spec.whatwg.org/#concept-shadow-including-tree-order"},
"freeze-steps": {"dfnID":"freeze-steps","dfnText":"freeze steps","external":false,"refSections":[{"refs":[{"id":"ref-for-freeze-steps"}],"title":"2. Page Lifecycle States"},{"refs":[{"id":"ref-for-freeze-steps\u2460"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"#freeze-steps"},
"frozen": {"dfnID":"frozen","dfnText":"frozen","external":false,"refSections":[{"refs":[{"id":"ref-for-frozen"},{"id":"ref-for-frozen\u2460"}],"title":"2. Page Lifecycle States"},{"refs":[{"id":"ref-for-frozen\u2461"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-frozen\u2462"},{"id":"ref-for-frozen\u2463"}],"title":"5.1. Modifications to worklet and worker behavior"},{"refs":[{"id":"ref-for-frozen\u2464"}],"title":"5.2.8. Posting messages"},{"refs":[{"id":"ref-for-frozen\u2465"}],"title":"5.3.2.1. Get Client Lifecycle State"},{"refs":[{"id":"ref-for-frozen\u2466"},{"id":"ref-for-frozen\u2467"}],"title":"5.4.1. FROZENNESS state"}],"url":"#frozen"},
"get-client-lifecycle-state": {"dfnID":"get-client-lifecycle-state","dfnText":"Get Client Lifecycle State","external":false,"refSections":[{"refs":[{"id":"ref-for-get-client-lifecycle-state"}],"title":"5.3.1.2. matchAll(options)"},{"refs":[{"id":"ref-for-get-client-lifecycle-state\u2460"}],"title":"5.3.1.3. openWindow(url)"}],"url":"#get-client-lifecycle-state"},
"htmlmediaelement-resume-frozen-flag": {"dfnID":"htmlmediaelement-resume-frozen-flag","dfnText":"resume frozen flag","external":false,"refSections":[{"refs":[{"id":"ref-for-htmlmediaelement-resume-frozen-flag"},{"id":"ref-for-htmlmediaelement-resume-frozen-flag\u2460"},{"id":"ref-for-htmlmediaelement-resume-frozen-flag\u2461"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"#htmlmediaelement-resume-frozen-flag"},
"resume-steps": {"dfnID":"resume-steps","dfnText":"resume steps","external":false,"refSections":[{"refs":[{"id":"ref-for-resume-steps"}],"title":"5.4.2. Changing the frozenness of documents"}],"url":"#resume-steps"},
"unfrozen": {"dfnID":"unfrozen","dfnText":"unfrozen","external":false,"refSections":[{"refs":[{"id":"ref-for-unfrozen"}],"title":"4. Feature Policies"},{"refs":[{"id":"ref-for-unfrozen\u2460"}],"title":"5.2.2. Event loop: definitions"},{"refs":[{"id":"ref-for-unfrozen\u2461"}],"title":"5.2.8. Posting messages"}],"url":"#unfrozen"},
"update-document-frozenness-steps": {"dfnID":"update-document-frozenness-steps","dfnText":"update document frozenness steps","external":false,"refSections":[{"refs":[{"id":"ref-for-update-document-frozenness-steps"}],"title":"5.2.3. Event loop: processing model"},{"refs":[{"id":"ref-for-update-document-frozenness-steps\u2460"}],"title":"5.2.6. iframe load event steps"}],"url":"#update-document-frozenness-steps"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#change-the-frozenness-of-a-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"change the frozenness of a document","type":"dfn","url":"#change-the-frozenness-of-a-document"},
"#change-the-frozenness-of-a-top-level-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"change the frozenness of a top-level document","type":"dfn","url":"#change-the-frozenness-of-a-top-level-document"},
"#dedicatedworkerglobalscope-owning-document": {"export":true,"for_":["DedicatedWorkerGlobalScope"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"owning document","type":"dfn","url":"#dedicatedworkerglobalscope-owning-document"},
"#dfn-service-worker-client-lifecycle-state": {"export":true,"for_":["Client"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"lifecycle state","type":"dfn","url":"#dfn-service-worker-client-lifecycle-state"},
"#discarded": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"discard","type":"dfn","url":"#discarded"},
"#document-discarded": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"discarded","type":"dfn","url":"#document-discarded"},
"#document-frozenness": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"frozenness","type":"dfn","url":"#document-frozenness"},
"#dom-clientlifecyclestate-active": {"export":true,"for_":["ClientLifecycleState"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"\"active\"","type":"enum-value","url":"#dom-clientlifecyclestate-active"},
"#dom-clientlifecyclestate-frozen": {"export":true,"for_":["ClientLifecycleState"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"\"frozen\"","type":"enum-value","url":"#dom-clientlifecyclestate-frozen"},
"#dom-document-onfreeze": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"onfreeze","type":"attribute","url":"#dom-document-onfreeze"},
"#dom-document-onresume": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"onresume","type":"attribute","url":"#dom-document-onresume"},
"#dom-document-wasdiscarded": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"wasDiscarded","type":"attribute","url":"#dom-document-wasdiscarded"},
"#dom-serviceworkerclient-lifecyclestate": {"export":true,"for_":["ServiceWorkerClient"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"lifecycleState","type":"attribute","url":"#dom-serviceworkerclient-lifecyclestate"},
"#enumdef-clientlifecyclestate": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"ClientLifecycleState","type":"enum","url":"#enumdef-clientlifecyclestate"},
"#execution-while-not-rendered": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"execution-while-not-rendered","type":"dfn","url":"#execution-while-not-rendered"},
"#execution-while-out-of-viewport": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"execution-while-out-of-viewport","type":"dfn","url":"#execution-while-out-of-viewport"},
"#freeze-steps": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"freeze steps","type":"dfn","url":"#freeze-steps"},
"#frozen": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"frozen","type":"dfn","url":"#frozen"},
"#get-client-lifecycle-state": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"get client lifecycle state","type":"dfn","url":"#get-client-lifecycle-state"},
"#htmlmediaelement-resume-frozen-flag": {"export":true,"for_":["HTMLMediaElement"],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"resume frozen flag","type":"dfn","url":"#htmlmediaelement-resume-frozen-flag"},
"#resume-steps": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"resume steps","type":"dfn","url":"#resume-steps"},
"#unfrozen": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"unfrozen","type":"dfn","url":"#unfrozen"},
"#update-document-frozenness-steps": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"page-lifecycle","spec":"page-lifecycle-1","status":"local","text":"update document frozenness steps","type":"dfn","url":"#update-document-frozenness-steps"},
"https://dom.spec.whatwg.org/#concept-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"document","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document"},
"https://dom.spec.whatwg.org/#concept-event-fire": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"fire an event","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-event-fire"},
"https://dom.spec.whatwg.org/#concept-shadow-including-descendant": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"shadow-including descendant","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-shadow-including-descendant"},
"https://dom.spec.whatwg.org/#concept-shadow-including-tree-order": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"shadow-including tree order","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-shadow-including-tree-order"},
"https://dom.spec.whatwg.org/#document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://drafts.css-houdini.org/worklets#workletglobalscope-owner-document": {"export":true,"for_":["worklet"],"level":"","normative":true,"shortname":"css-houdini","spec":"css-houdini","status":"anchor-block","text":"owning document","type":"dfn","url":"https://drafts.css-houdini.org/worklets#workletglobalscope-owner-document"},
"https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"browsing context container","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#browsing-context-container"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc": {"export":true,"for_":["document"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-document-bc"},
"https://html.spec.whatwg.org/multipage/browsers.html#list-of-the-descendant-browsing-contexts": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"list of the descendant browsing contexts","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#list-of-the-descendant-browsing-contexts"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#dom-pagetransitionevent-persisted": {"export":true,"for_":["PageTransitionEvent"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"persisted","type":"attribute","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#dom-pagetransitionevent-persisted"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#traverse-the-history": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"traverse the history","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#traverse-the-history"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"fully active","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document": {"export":true,"for_":["navigable"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active document","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness": {"export":true,"for_":["document"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"readiness","type":"dfn","url":"https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"allowed to use","type":"dfn","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#iframe-load-event-steps": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"iframe load event steps","type":"dfn","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#iframe-load-event-steps"},
"https://html.spec.whatwg.org/multipage/media.html#dom-media-paused": {"export":true,"for_":["HTMLMediaElement"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"paused","type":"attribute","url":"https://html.spec.whatwg.org/multipage/media.html#dom-media-paused"},
"https://html.spec.whatwg.org/multipage/media.html#htmlmediaelement": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"HTMLMediaElement","type":"interface","url":"https://html.spec.whatwg.org/multipage/media.html#htmlmediaelement"},
"https://html.spec.whatwg.org/multipage/media.html#internal-pause-steps": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"media pause","type":"dfn","url":"https://html.spec.whatwg.org/multipage/media.html#internal-pause-steps"},
"https://html.spec.whatwg.org/multipage/media.html#internal-play-steps": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"media play","type":"dfn","url":"https://html.spec.whatwg.org/multipage/media.html#internal-play-steps"},
"https://html.spec.whatwg.org/multipage/media.html#media-element": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"media elements","type":"dfn","url":"https://html.spec.whatwg.org/multipage/media.html#media-element"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc": {"export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc"},
"https://html.spec.whatwg.org/multipage/rendering.html#being-rendered": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"being rendered","type":"dfn","url":"https://html.spec.whatwg.org/multipage/rendering.html#being-rendered"},
"https://html.spec.whatwg.org/multipage/web-messaging.html#posted-message-task-source": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"posted message task source","type":"dfn","url":"https://html.spec.whatwg.org/multipage/web-messaging.html#posted-message-task-source"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global": {"export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"global object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"task","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task"},
"https://html.spec.whatwg.org/multipage/webappapis.html#dedicated-worker-agent": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"dedicated worker agent","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#dedicated-worker-agent"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"event handler idl attribute","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#event-handler-idl-attributes"},
"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"EventHandler","type":"typedef","url":"https://html.spec.whatwg.org/multipage/webappapis.html#eventhandler"},
"https://html.spec.whatwg.org/multipage/webappapis.html#update-the-rendering": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"update the rendering","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#update-the-rendering"},
"https://html.spec.whatwg.org/multipage/webappapis.html#worklet-agent": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"worklet agent","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#worklet-agent"},
"https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set": {"export":true,"for_":["WorkerGlobalScope"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"owner set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/workers.html#concept-WorkerGlobalScope-owner-set"},
"https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"DedicatedWorkerGlobalScope","type":"interface","url":"https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope"},
"https://infra.spec.whatwg.org/#list": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"list","type":"dfn","url":"https://infra.spec.whatwg.org/#list"},
"https://infra.spec.whatwg.org/#list-append": {"export":true,"for_":["list"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"append","type":"dfn","url":"https://infra.spec.whatwg.org/#list-append"},
"https://infra.spec.whatwg.org/#list-iterate": {"export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"for each","type":"dfn","url":"https://infra.spec.whatwg.org/#list-iterate"},
"https://tc39.github.io/ecma262/#sec-code-realms": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ecma262","spec":"ecma262","status":"anchor-block","text":"realm","type":"dfn","url":"https://tc39.github.io/ecma262/#sec-code-realms"},
"https://tc39.github.io/ecma262/#sec-forward-progress": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ecma262","spec":"ecma262","status":"anchor-block","text":"blocked","type":"dfn","url":"https://tc39.github.io/ecma262/#sec-forward-progress"},
"https://w3c.github.io/IntersectionObserver/#calculate-intersection-rect-algo": {"export":true,"for_":[],"level":"","normative":true,"shortname":"intersectionobserver","spec":"intersectionobserver","status":"anchor-block","text":"compute the intersection of a target element and the root","type":"dfn","url":"https://w3c.github.io/IntersectionObserver/#calculate-intersection-rect-algo"},
"https://w3c.github.io/ServiceWorker/#client": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"service-workers","spec":"service-workers","status":"current","text":"Client","type":"interface","url":"https://w3c.github.io/ServiceWorker/#client"},
"https://w3c.github.io/ServiceWorker/#create-client-algorithm": {"export":true,"for_":[],"level":"","normative":true,"shortname":"serviceworker","spec":"serviceworker","status":"anchor-block","text":"create client","type":"dfn","url":"https://w3c.github.io/ServiceWorker/#create-client-algorithm"},
"https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm": {"export":true,"for_":[],"level":"","normative":true,"shortname":"serviceworker","spec":"serviceworker","status":"anchor-block","text":"create window client","type":"dfn","url":"https://w3c.github.io/ServiceWorker/#create-windowclient-algorithm"},
"https://w3c.github.io/ServiceWorker/#dfn-service-worker-client": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"service-workers","spec":"service-workers","status":"current","text":"service worker client","type":"dfn","url":"https://w3c.github.io/ServiceWorker/#dfn-service-worker-client"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist": {"export":true,"for_":["policy-controlled feature"],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"default allowlist","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"https://webidl.spec.whatwg.org/#idl-boolean": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"boolean","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"https://www.w3.org/TR/CSS2/visuren.html#viewport": {"export":true,"for_":[],"level":"","normative":true,"shortname":"css2","spec":"css2","status":"anchor-block","text":"viewport","type":"dfn","url":"https://www.w3.org/TR/CSS2/visuren.html#viewport"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>