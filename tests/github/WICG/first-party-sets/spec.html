<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>User Agent Interaction with First-Party Sets</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/first-party-sets/" rel="canonical">
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-dfn-panel */

:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-issues */

a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* style-darkmode */

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}

@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">User Agent Interaction with First-Party Sets</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/first-party-sets/">https://wicg.github.io/first-party-sets/</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:johannhof@google.com">Johann Hofmann</a> (<a class="p-org org" href="https://google.com">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:kaustubhag@google.com">Kaustubha Govind</a> (<a class="p-org org" href="https://google.com">Google</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 1970 the Contributors to the User Agent Interaction with First-Party Sets Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>How user agents should integrate with First-Party Sets, a mechanism to declare a collection of related domains as being in a First-Party Set.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#infra"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
    <li><a href="#list-consumption"><span class="secno">3</span> <span class="content">List consumption</span></a>
    <li><a href="#data-structures"><span class="secno">4</span> <span class="content">Data Structures</span></a>
    <li><a href="#validating-inclusion"><span class="secno">5</span> <span class="content">Validating first-party set inclusion</span></a>
    <li><a href="#storage-access-integration"><span class="secno">6</span> <span class="content">Integration with the Storage Access API</span></a>
    <li><a href="#handling-changes"><span class="secno">7</span> <span class="content">Handling first-party set changes</span></a>
    <li>
     <a href="#privacy-consideration"><span class="secno">8</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#provide-transparency"><span class="secno">8.1</span> <span class="content">Provide user transparency and control</span></a>
      <li><a href="#ensure-compatibility"><span class="secno">8.2</span> <span class="content">Ensure compatibility with non-FPS environments</span></a>
      <li><a href="#prevent-leaks"><span class="secno">8.3</span> <span class="content">Prevent privacy leaks from list changes</span></a>
     </ol>
    <li>
     <a href="#security-considerations"><span class="secno">9</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#avoid-weakening-boundaries"><span class="secno">9.1</span> <span class="content">Avoid weakening new and existing security boundaries</span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno"></span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is non-normative.</em></p>
   <p>First-Party Sets (“FPS”) provides a framework for developers to declare relationships among sites, to enable limited cross-site cookie access for specific, user-facing purposes. This is facilitated through the use of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>.</p>
   <p>This document defines how user agents should integrate with the <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/first_party_sets.JSON"><cite>First-Party Sets list</cite></a>. For a canonical reference of the structure of the FPS list and technical validations that are run at time of submission, please see the <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md"><cite>First-Party Sets Submission Guidelines</cite></a>.</p>
   <h2 class="heading settled" data-level="2" id="infra"><span class="secno">2. </span><span class="content">Infrastructure</span><a class="self-link" href="#infra"></a></h2>
   <p>This specification depends on the Infra standard. <a data-biblio-display="index" data-link-type="biblio" href="#biblio-infra" title="Infra Standard">[INFRA]</a></p>
   <h2 class="heading settled" data-level="3" id="list-consumption"><span class="secno">3. </span><span class="content">List consumption</span><a class="self-link" href="#list-consumption"></a></h2>
   <p>User agents should consume the canonical <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/first_party_sets.JSON"><cite>First-Party Sets list</cite></a> on a regular basis (e.g., every 2 weeks) and ship it to individual clients (e.g. a browser application) as an updateable component.</p>
   <p class="issue" id="issue-2f53edbf"><a class="self-link" href="#issue-2f53edbf"></a> Can we make a recommendation for an update interval here? <a href="https://github.com/wicg/first-party-sets/issues/122">[Issue #wicg/first-party-sets#122]</a></p>
   <p>Individual clients must <a data-link-type="dfn" href="#build-the-list-of-first-party-sets" id="ref-for-build-the-list-of-first-party-sets">build the list of first-party sets</a> on restart, or on start-up, if newly downloaded. Clients must not re-build the list at any other point in time.</p>
   <p>The FPS list is a <a data-link-type="dfn" href="https://encoding.spec.whatwg.org/#utf-8" id="ref-for-utf-8">UTF-8</a> encoded file containing contents parseable as a JSON object, conforming to the <a data-biblio-display="index" data-link-type="biblio" href="#biblio-json-schema" title="JSON Schema: A Media Type for Describing JSON Documents">[JSON-SCHEMA]</a> described in the <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md"><cite>First-Party Sets Submission Guidelines</cite></a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Conformance to the schema is validated at submission time. Hence, it is not required for the user agent to validate conformance again on the client. The algorithms in this specification describe how user agents should parse the FPS list, and when a particular set should be considered valid from the client’s perspective.</p>
   <p class="issue" id="issue-bb862ccb"><a class="self-link" href="#issue-bb862ccb"></a> Client-side validation may be needed in cases where the <a data-link-type="biblio" href="#biblio-psl"><cite>Public Suffix List</cite></a> version differs between the server and client. <a href="https://github.com/wicg/first-party-sets/issues/125">[Issue #wicg/first-party-sets#125]</a></p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="build-the-list-of-first-party-sets">build the list of first-party sets</dfn> from a JSON <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence">byte sequence</a> <var>bytes</var>, the user agent should run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>json</var> be the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value" id="ref-for-parse-json-bytes-to-an-infra-value">parsing JSON bytes to an infra value</a> with <var>bytes</var>.</p>
    <li data-md>
     <p>If <var>json</var> is a parsing exception, or if <var>json</var> is not an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">ordered map</a>, or if <var>json</var>[“sets”] does not exist, return and optionally retry fetching the list, or perform other error recovery tasks.</p>
    <li data-md>
     <p>For each <var>entry</var> of <var>json</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>set</var> be a <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set">first-party set</a>.</p>
      <li data-md>
       <p>If <var>entry</var>[“primary”] does not exist, continue.</p>
     </ol>
   </ol>
   <p class="issue" id="issue-f434ab32"><a class="self-link" href="#issue-f434ab32"></a> The specification currently suggests skipping invalid sets (missing primary entries) instead of rejecting the entire list. However, there may be benefit in a full rejection given that the server is expected to hold valid information at all times. <a href="https://github.com/wicg/first-party-sets/issues/126">[Issue #wicg/first-party-sets#126]</a></p>
   <ol start="3">
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-primary" id="ref-for-first-party-set-primary">primary</a> to <var>entry</var>[“primary”].</p>
    <li data-md>
     <p>Let <var>ccTLDs</var> be the result of <a data-link-type="dfn" href="#parse-an-equivalence-map" id="ref-for-parse-an-equivalence-map">parsing an equivalence map</a> from <var>entry</var>[“ccTLDs”]. If <var>ccTLDs</var> is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s ccTLDs to <var>ccTLDs</var>.</p>
    <li data-md>
     <p>Let <var>serviceSites</var> be the result of <a data-link-type="dfn" href="#parse-a-subset" id="ref-for-parse-a-subset">parsing a subset</a> from <var>entry</var>[“serviceSites”]. If the result is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-servicesites" id="ref-for-first-party-set-servicesites">serviceSites</a> to <var>serviceSites</var>.</p>
    <li data-md>
     <p>Let <var>associatedSites</var> be the result of <a data-link-type="dfn" href="#parse-a-subset" id="ref-for-parse-a-subset①">parsing a subset</a> from <var>entry</var>[“associatedSites”]. If the result is failure, continue.</p>
    <li data-md>
     <p>Set <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-associatedsites" id="ref-for-first-party-set-associatedsites">associatedSites</a> to <var>associatedSites</var>.</p>
    <li data-md>
     <p>Add <var>set</var> to the user agent’s <a data-link-type="dfn" href="#list-of-first-party-sets" id="ref-for-list-of-first-party-sets">list of first-party sets</a>.</p>
   </ol>
   <p>User agents may opt to pre-process the list into a different format before delivery to the client, e.g. for optimization reasons, as long as they ensure that the client will eventually hold a valid <a data-link-type="dfn" href="#list-of-first-party-sets" id="ref-for-list-of-first-party-sets①">list of first-party sets</a> as defined in this specification.</p>
   <h2 class="heading settled" data-level="4" id="data-structures"><span class="secno">4. </span><span class="content">Data Structures</span><a class="self-link" href="#data-structures"></a></h2>
   <p>The user agent maintains a global <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="list-of-first-party-sets">list of first-party sets</dfn>, which is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set①">first-party sets</a>.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="first-party-set">first-party set</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> with the following items:</p>
   <p><dfn class="dfn-paneled" data-dfn-for="first-party set" data-dfn-type="dfn" data-noexport id="first-party-set-primary">primary</dfn>: A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site">site</a> that represents the set’s primary domain.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="first-party set" data-dfn-type="dfn" data-noexport id="first-party-set-cctlds">ccTLDs</dfn>: An <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map">equivalence map</a>, representing the set’s equivalent country-code top level domains that were specified by the submitter.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="first-party set" data-dfn-type="dfn" data-noexport id="first-party-set-associatedsites">associatedSites</dfn>: A <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①">sites</a> in the associated subset.</p>
   <p><dfn class="dfn-paneled" data-dfn-for="first-party set" data-dfn-type="dfn" data-noexport id="first-party-set-servicesites">serviceSites</dfn>: A <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site②">sites</a> in the service subset.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For additional context on the meaning of these fields please refer to the <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md"><cite>First-Party Sets Submission Guidelines</cite></a>.</p>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="equivalence-map">equivalence map</dfn> is an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map①">ordered map</a> from <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site③">sites</a> to <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">lists</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site④">sites</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-and-validate-a-site">parse and validate a site</dfn> from a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a> <var>input</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>url</var> be the result of <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-basic-url-parser" id="ref-for-concept-basic-url-parser">basic URL parsing</a> <var>input</var>. If the result is failure, return failure.</p>
    <li data-md>
     <p>If <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a> is not "<code>https</code>", return failure.</p>
    <li data-md>
     <p>Let <var>site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site">obtaining a site</a> from <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a>.</p>
    <li data-md>
     <p>Return <var>site</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-a-subset">parse a subset</dfn> from a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a> <var>input</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>list</var> be an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">list</a>.</p>
    <li data-md>
     <p>For each <var>item</var> of <var>input</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>site</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site">parsing and validating a site</a> from <var>item</var>.</p>
      <li data-md>
       <p>If <var>site</var> is failure, return failure.</p>
      <li data-md>
       <p>Add <var>site</var> to <var>list</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>list</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-an-equivalence-map">parse an equivalence map</dfn> from an ordered map <var>input</var>, run the following steps:</p>
   <ol start="4">
    <li data-md>
     <p>Let <var>map</var> be an empty <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map①">equivalence map</a>.</p>
    <li data-md>
     <p>For each <var>key</var> → <var>value</var> of <var>input</var>:</p>
     <ol start="4">
      <li data-md>
       <p>Let <var>keySite</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site①">parsing and validating a site</a> from <var>key</var>. If the result is failure, return failure.</p>
      <li data-md>
       <p>Let <var>equivalents</var> be an empty list.</p>
      <li data-md>
       <p>For each <var>equivalent</var> in <var>value</var>:</p>
       <ol>
        <li data-md>
         <p>Let <var>equivalentSite</var> be the result of <a data-link-type="dfn" href="#parse-and-validate-a-site" id="ref-for-parse-and-validate-a-site②">parsing and validating a site</a> from <var>equivalent</var>. If the result is failure, return failure.</p>
        <li data-md>
         <p>Add <var>equivalentSite</var> to <var>equivalents</var>.</p>
       </ol>
      <li data-md>
       <p>Set <var>map</var>[<var>keySite</var>] to <var>equivalents</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>map</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="5" id="validating-inclusion"><span class="secno">5. </span><span class="content">Validating first-party set inclusion</span><a class="self-link" href="#validating-inclusion"></a></h2>
   <p>Under FPS, a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑤">site</a> <var>site1</var> is considered <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="equivalent-to">equivalent to</dfn> another <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑥">site</a> <var>site2</var> given an <a data-link-type="dfn" href="#equivalence-map" id="ref-for-equivalence-map②">equivalence map</a> <var>equivalents</var>, if <var>equivalents</var>[<var>site1</var>] contains <var>site2</var> or <var>equivalents</var>[<var>site2</var>] contains <var>site1</var>.</p>
   <p class="issue" id="issue-7a693f54"><a class="self-link" href="#issue-7a693f54"></a> Should this be renamed to avoid being confused with a mathematical equivalence relation? <a href="https://github.com/wicg/first-party-sets/issues/123">[Issue #wicg/first-party-sets#123]</a></p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="determine-the-member-type">determine the member type</dfn> of a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑦">site</a> <var>site</var> in a given <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set②">first-party set</a> <var>set</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to">equivalent to</a> <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-primary" id="ref-for-first-party-set-primary①">primary</a> given <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-cctlds" id="ref-for-first-party-set-cctlds">ccTLDs</a>, return “primary”.</p>
    <li data-md>
     <p>For each <var>associatedSite</var> of <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-associatedsites" id="ref-for-first-party-set-associatedsites①">associatedSites</a>:</p>
     <ol>
      <li data-md>
       <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to①">equivalent to</a> <var>associatedSite</var> given <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-cctlds" id="ref-for-first-party-set-cctlds①">ccTLDs</a>, return “associated”.</p>
     </ol>
    <li data-md>
     <p>For each <var>serviceSite</var> of <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-servicesites" id="ref-for-first-party-set-servicesites①">serviceSites</a>:</p>
     <ol start="2">
      <li data-md>
       <p>If <var>site</var> is <a data-link-type="dfn" href="#equivalent-to" id="ref-for-equivalent-to②">equivalent to</a> <var>serviceSite</var> given <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-cctlds" id="ref-for-first-party-set-cctlds②">ccTLDs</a>, return “service”.</p>
     </ol>
    <li data-md>
     <p>Return “none”.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="find-a-first-party-set">find a first-party set</dfn> for a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑧">site</a> <var>site</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>For each <var>set</var> of the user agent’s <a data-link-type="dfn" href="#list-of-first-party-sets" id="ref-for-list-of-first-party-sets②">list of first-party sets</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>type</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type">member type</a> of <var>site</var> in <var>set</var>.</p>
      <li data-md>
       <p>If <var>type</var> is not “none”, return <var>set</var>.</p>
     </ol>
    <li data-md>
     <p>Return null.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> The <a data-link-type="biblio" href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md"><cite>First-Party Sets Submission Guidelines</cite></a> require that each site can only appear in at most one First-Party set, which is validated at submission time. For this reason, user agents do not need to be concerned with the order of the list of first-party sets when performing these steps.</p>
   <h2 class="heading settled" data-level="6" id="storage-access-integration"><span class="secno">6. </span><span class="content">Integration with the Storage Access API</span><a class="self-link" href="#storage-access-integration"></a></h2>
   <p>Define the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="limit-for-associated-sites">limit for associated sites</dfn> within a single <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set③">first-party set</a> to be an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> value, which is recommended to be 3.</p>
   <p class="note" role="note"><span class="marker">Note:</span> This limit is used when <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site">determining eligibility for an associated site</a> to only consider the sites listed at the top of the associated subset. It is meant to discourage abuse and help users and user agents understand why a particular first-party set needs to exist. User agents may choose a different number based on this goal.</p>
   <p>Modify the <a data-link-type="dfn" href="determine-the-storage-access-policy" id="termref-for-">determine the storage access policy</a> step to insert the following steps before step 3 (running <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined①">implementation-defined</a> steps):</p>
   <ol>
    <li data-md>
     <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site①">obtaining a site</a> from key’s embedded origin.</p>
    <li data-md>
     <p>Let <var>sameSet</var> be true if <var>embeddedSite</var> is <a data-link-type="dfn" href="#eligible-for-same-party-membership-when-embedded-within" id="ref-for-eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</a> <var>topLevelSite</var>.</p>
    <li data-md>
     <p>Optionally set implicitly granted or implicitly denied based on the value of <var>sameSet</var>. This step is <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined②">implementation-defined</a>.</p>
   </ol>
   <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑨">site</a> <var>embeddedSite</var> is <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</dfn> a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①⓪">site</a> <var>topLevelSite</var>, if the following steps return true:</p>
   <ol>
    <li data-md>
     <p>Let <var>set</var> be the result of <a data-link-type="dfn" href="#find-a-first-party-set" id="ref-for-find-a-first-party-set">finding a first-party set</a> for <var>topLevelSite</var>.</p>
    <li data-md>
     <p>If <var>set</var> is null, return false.</p>
    <li data-md>
     <p>Let <var>topLevelType</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type①">member type</a> of <var>topLevelSite</var> in <var>set</var>.</p>
    <li data-md>
     <p>If <var>topLevelType</var> is “associated” and the result of <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site①">determining eligibility for an associated site</a> given <var>topLevelSite</var> and <var>set</var> is false, return false.</p>
    <li data-md>
     <p>If <var>topLevelType</var> is “service”, return false.</p>
    <li data-md>
     <p>Let <var>type</var> be the <a data-link-type="dfn" href="#determine-the-member-type" id="ref-for-determine-the-member-type②">member type</a> of <var>embeddedSite</var> in <var>set</var>.</p>
    <li data-md>
     <p>If <var>type</var> is “none”, return false.</p>
    <li data-md>
     <p>If <var>type</var> is “associated”, return the result of <a data-link-type="dfn" href="#determine-eligibility-for-an-associated-site" id="ref-for-determine-eligibility-for-an-associated-site②">determining eligibility for an associated site</a> given <var>embeddedSite</var> and <var>set</var>.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-eligibility-for-an-associated-site">determine eligibility for an associated site</dfn> given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①①">site</a> <var>site</var> and a <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set④">first-party set</a> <var>set</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-associatedsites" id="ref-for-first-party-set-associatedsites②">associatedSites</a> does not contain <var>site</var>, return false.</p>
    <li data-md>
     <p>Let <var>index</var> be the index of <var>site</var> in <var>set</var>’s <a data-link-type="dfn" href="#first-party-set-associatedsites" id="ref-for-first-party-set-associatedsites③">associatedSites</a>.</p>
    <li data-md>
     <p>If <var>index</var> is greater than or equal to the <a data-link-type="dfn" href="#limit-for-associated-sites" id="ref-for-limit-for-associated-sites">limit for associated sites</a>, return false.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <h2 class="heading settled" data-level="7" id="handling-changes"><span class="secno">7. </span><span class="content">Handling first-party set changes</span><a class="self-link" href="#handling-changes"></a></h2>
   <p>When a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①②">site</a> <var>site</var> leaves a <a data-link-type="dfn" href="#first-party-set" id="ref-for-first-party-set⑤">first-party set</a> as the result of building a new <a data-link-type="dfn" href="#list-of-first-party-sets" id="ref-for-list-of-first-party-sets③">list of first-party sets</a>, user agents must ensure that it does not retain any access to data or shared identifiers held by other sites in the first-party set by running the following steps:</p>
   <ol>
    <li data-md>
     <p>Assert that <var>site</var> is not an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>.</p>
    <li data-md>
     <p>Let <var>domain</var> be site’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host">host</a>.</p>
    <li data-md>
     <p>For each <var>origin</var> known to the user agent whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host①">host</a>'s <a data-link-type="dfn" href="https://publicsuffix.org/list/#" id="termref-for-①">registered domain</a> is <var>domain</var>:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin" id="ref-for-abstract-opdef-clear-cache-for-origin">Clear cache for origin</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin" id="ref-for-abstract-opdef-clear-cookies-for-origin">Clear cookies for origin</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin" id="ref-for-abstract-opdef-clear-dom-accessible-storage-for-origin">Clear DOM-accessible storage for origin</a>.</p>
      <li data-md>
       <p>Let <var>descriptor</var> be a newly-created <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissiondescriptor" id="ref-for-dom-permissiondescriptor">PermissionDescriptor</a></code> with <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissiondescriptor-name" id="ref-for-dom-permissiondescriptor-name">name</a></code> initialized to “storage-access”.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry" id="ref-for-dfn-remove-a-permission-store-entry">Remove all permission store entries</a> for <var>descriptor</var>, where key[0] is <var>site</var> or key[1] is <var>origin</var>.</p>
      <li data-md>
       <p>Run additional <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined③">implementation-defined</a> steps to ensure that any web-accessible storage is removed from <var>origin</var>.</p>
     </ol>
   </ol>
   <p class="issue" id="issue-084bef24"><a class="self-link" href="#issue-084bef24"></a> This section should provide more details on how user agents can figure out when a site leaves an FPS. <a href="https://github.com/wicg/first-party-sets/issues/124">[Issue #wicg/first-party-sets#124]</a></p>
   <h2 class="heading settled" data-level="8" id="privacy-consideration"><span class="secno">8. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy-consideration"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="provide-transparency"><span class="secno">8.1. </span><span class="content">Provide user transparency and control</span><a class="self-link" href="#provide-transparency"></a></h3>
   <p>A user agent that uses FPS to infer the relationship between two sites should ensure that its users are informed about this user agent choice and give users the opportunity to view and control choices made by the user agent.</p>
   <h3 class="heading settled" data-level="8.2" id="ensure-compatibility"><span class="secno">8.2. </span><span class="content">Ensure compatibility with non-FPS environments</span><a class="self-link" href="#ensure-compatibility"></a></h3>
   <p>Some user agents may choose not to support FPS in specific environments (such as Private Browsing Modes), or at all. All user agents and specifications should be mindful of this in their own API integrations and aim to gracefully fall back to a working solution for users and developers.</p>
   <p>For providing access to cross-site cookies, this specification aims to ensure compatibility with non-FPS environments through usage of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>, which provides developers an interface to handle rejections to the request and gives user agents flexibility to employ mechanisms such as prompts or heuristics as an alternative to FPS.</p>
   <h3 class="heading settled" data-level="8.3" id="prevent-leaks"><span class="secno">8.3. </span><span class="content">Prevent privacy leaks from list changes</span><a class="self-link" href="#prevent-leaks"></a></h3>
   <p>Developers may submit changes to their sets to add or remove sites. Since membership in a set could provide access to cross-site cookies via automatic grants of the <a data-link-type="biblio" href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>, we need to pay attention to these transitions so that they don’t link user identities across all the FPSs they’ve historically been in. In particular, we must ensure that a domain cannot transfer a user identifier from one First-Party Set to another when it changes its set membership. While a set member may not always request and be granted access to cross-site cookies, for the sake of simplicity of handling set transitions, we propose to treat such access as always granted.</p>
   <p>For this reason, this specification requires user agents to clear any site data and storage-access permissions of a given site when a site is removed from a set.</p>
   <h2 class="heading settled" data-level="9" id="security-considerations"><span class="secno">9. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
   <h3 class="heading settled" data-level="9.1" id="avoid-weakening-boundaries"><span class="secno">9.1. </span><span class="content">Avoid weakening new and existing security boundaries</span><a class="self-link" href="#avoid-weakening-boundaries"></a></h3>
   <p>Changes to the web platform that tighten boundaries for increased privacy often have positive effects on security as well. For example, cache partitioning restricts <a data-link-type="biblio" href="https://xsleaks.dev/docs/attacks/cache-probing/"><cite>Cache Probing</cite></a> attacks and third-party cookie blocking makes it much harder to perform <a data-link-type="biblio" href="https://owasp.org/www-community/attacks/csrf"><cite>Cross Site Request Forgery (CSRF)</cite></a> by default. Where user agents intend to use First-Party Sets to replace or extend existing boundaries based on site or origin on the web, it is important to consider not only the effects on privacy, but also on security.</p>
   <p>Sites in a common FPS may have greatly varying security requirements, for example, a set could contain a site storing user credentials and another hosting untrusted user data. Even within the same set, sites still rely on cross-site and cross-origin restrictions to stay in control of data exposure. Within reason, it should not be possible for a compromised site in an FPS to affect the integrity of other sites in the set.</p>
   <p>This consideration will always involve a necessary trade-off between gains like performance or interoperability and risks for users and sites. User agents should facilitate additional mechanisms such as a per-origin opt-in or opt-out to manage this trade-off.</p>
   <h2 class="no-num heading settled" id="acknowledgements"><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p>Other members of the W3C Privacy Community Group had previously suggested the use of Storage Access API, or an equivalent API; in place of SameParty cookies. Thanks to @jdcauley (<a href="https://github.com/WICG/first-party-sets/issues/14#issuecomment-785144990">1</a>), @arthuredelstein (<a href="https://github.com/WICG/first-party-sets/issues/42">2</a>), and @johnwilander (<a href="https://lists.w3.org/Archives/Public/public-privacycg/2022Jun/0001.html">3</a>).</p>
   <p>Browser vendors, web developers, and members of the web community provided valuable feedback during this proposal’s incubation in the W3C Privacy Community Group.</p>
   <p>This proposal includes significant contributions from previous co-editors, David Benjamin, and Harneet Sidhana.</p>
   <p>We are also grateful for contributions from Chris Fredrickson and Shuran Huang.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
   <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
   <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
  </div>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#first-party-set-associatedsites">associatedSites</a><span>, in § 4</span>
   <li><a href="#build-the-list-of-first-party-sets">build the list of first-party sets</a><span>, in § 3</span>
   <li><a href="#first-party-set-cctlds">ccTLDs</a><span>, in § 4</span>
   <li><a href="#determine-eligibility-for-an-associated-site">determine eligibility for an associated site</a><span>, in § 6</span>
   <li><a href="#determine-the-member-type">determine the member type</a><span>, in § 5</span>
   <li><a href="#eligible-for-same-party-membership-when-embedded-within">eligible for same-party membership when embedded within</a><span>, in § 6</span>
   <li><a href="#equivalence-map">equivalence map</a><span>, in § 4</span>
   <li><a href="#equivalent-to">equivalent to</a><span>, in § 5</span>
   <li><a href="#find-a-first-party-set">find a first-party set</a><span>, in § 5</span>
   <li><a href="#first-party-set">first-party set</a><span>, in § 4</span>
   <li><a href="#limit-for-associated-sites">limit for associated sites</a><span>, in § 6</span>
   <li><a href="#list-of-first-party-sets">list of first-party sets</a><span>, in § 4</span>
   <li><a href="#parse-and-validate-a-site">parse and validate a site</a><span>, in § 4</span>
   <li><a href="#parse-an-equivalence-map">parse an equivalence map</a><span>, in § 4</span>
   <li><a href="#parse-a-subset">parse a subset</a><span>, in § 4</span>
   <li><a href="#first-party-set-primary">primary</a><span>, in § 4</span>
   <li><a href="#first-party-set-servicesites">serviceSites</a><span>, in § 4</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-abstract-opdef-clear-cache-for-origin">
   <a href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin">https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cache-for-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-clear-cache-for-origin">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-abstract-opdef-clear-cookies-for-origin">
   <a href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin">https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-cookies-for-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-clear-cookies-for-origin">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-abstract-opdef-clear-dom-accessible-storage-for-origin">
   <a href="https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin">https://www.w3.org/TR/clear-site-data/#abstract-opdef-clear-dom-accessible-storage-for-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-abstract-opdef-clear-dom-accessible-storage-for-origin">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-utf-8">
   <a href="https://encoding.spec.whatwg.org/#utf-8">https://encoding.spec.whatwg.org/#utf-8</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-utf-8">3. List consumption</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-origin-host">
   <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host">https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-origin-host">7. Handling first-party set changes</a> <a href="#ref-for-concept-origin-host①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-obtain-a-site">
   <a href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site">https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-obtain-a-site">4. Data Structures</a>
    <li><a href="#ref-for-obtain-a-site①">6. Integration with the Storage Access API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-origin-opaque">
   <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque">https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-origin-opaque">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-site">
   <a href="https://html.spec.whatwg.org/multipage/browsers.html#site">https://html.spec.whatwg.org/multipage/browsers.html#site</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-site">4. Data Structures</a> <a href="#ref-for-site①">(2)</a> <a href="#ref-for-site②">(3)</a> <a href="#ref-for-site③">(4)</a> <a href="#ref-for-site④">(5)</a>
    <li><a href="#ref-for-site⑤">5. Validating first-party set inclusion</a> <a href="#ref-for-site⑥">(2)</a> <a href="#ref-for-site⑦">(3)</a> <a href="#ref-for-site⑧">(4)</a>
    <li><a href="#ref-for-site⑨">6. Integration with the Storage Access API</a> <a href="#ref-for-site①⓪">(2)</a> <a href="#ref-for-site①①">(3)</a>
    <li><a href="#ref-for-site①②">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-byte-sequence">
   <a href="https://infra.spec.whatwg.org/#byte-sequence">https://infra.spec.whatwg.org/#byte-sequence</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-byte-sequence">3. List consumption</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-implementation-defined">
   <a href="https://infra.spec.whatwg.org/#implementation-defined">https://infra.spec.whatwg.org/#implementation-defined</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-implementation-defined">6. Integration with the Storage Access API</a> <a href="#ref-for-implementation-defined①">(2)</a> <a href="#ref-for-implementation-defined②">(3)</a>
    <li><a href="#ref-for-implementation-defined③">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-list">
   <a href="https://infra.spec.whatwg.org/#list">https://infra.spec.whatwg.org/#list</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list">4. Data Structures</a> <a href="#ref-for-list①">(2)</a> <a href="#ref-for-list②">(3)</a> <a href="#ref-for-list③">(4)</a> <a href="#ref-for-list④">(5)</a> <a href="#ref-for-list⑤">(6)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-ordered-map">
   <a href="https://infra.spec.whatwg.org/#ordered-map">https://infra.spec.whatwg.org/#ordered-map</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-ordered-map">3. List consumption</a>
    <li><a href="#ref-for-ordered-map①">4. Data Structures</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-parse-json-bytes-to-an-infra-value">
   <a href="https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value">https://infra.spec.whatwg.org/#parse-json-bytes-to-an-infra-value</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-parse-json-bytes-to-an-infra-value">3. List consumption</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-string">
   <a href="https://infra.spec.whatwg.org/#string">https://infra.spec.whatwg.org/#string</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-string">4. Data Structures</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-struct">
   <a href="https://infra.spec.whatwg.org/#struct">https://infra.spec.whatwg.org/#struct</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-struct">4. Data Structures</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-permissiondescriptor">
   <a href="https://w3c.github.io/permissions/#dom-permissiondescriptor">https://w3c.github.io/permissions/#dom-permissiondescriptor</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-permissiondescriptor">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-permissiondescriptor-name">
   <a href="https://w3c.github.io/permissions/#dom-permissiondescriptor-name">https://w3c.github.io/permissions/#dom-permissiondescriptor-name</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-permissiondescriptor-name">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dfn-remove-a-permission-store-entry">
   <a href="https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry">https://w3c.github.io/permissions/#dfn-remove-a-permission-store-entry</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dfn-remove-a-permission-store-entry">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-">
   <a href="https://publicsuffix.org/list/#">https://publicsuffix.org/list/#</a><b>Referenced in:</b>
   <ul>
    <li><a href="#termref-for-">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-">
   <a href="determine-the-storage-access-policy">determine-the-storage-access-policy</a><b>Referenced in:</b>
   <ul>
    <li><a href="#termref-for-">6. Integration with the Storage Access API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-basic-url-parser">
   <a href="https://url.spec.whatwg.org/#concept-basic-url-parser">https://url.spec.whatwg.org/#concept-basic-url-parser</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-basic-url-parser">4. Data Structures</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-origin">
   <a href="https://url.spec.whatwg.org/#concept-url-origin">https://url.spec.whatwg.org/#concept-url-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-origin">4. Data Structures</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-scheme">
   <a href="https://url.spec.whatwg.org/#concept-url-scheme">https://url.spec.whatwg.org/#concept-url-scheme</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-scheme">4. Data Structures</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CLEAR-SITE-DATA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-abstract-opdef-clear-cache-for-origin">clear cache for origin</span>
     <li><span class="dfn-paneled" id="term-for-abstract-opdef-clear-cookies-for-origin">clear cookies for origin</span>
     <li><span class="dfn-paneled" id="term-for-abstract-opdef-clear-dom-accessible-storage-for-origin">clear dom-accessible storage for origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ENCODING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-utf-8">utf-8</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-concept-origin-host">host</span>
     <li><span class="dfn-paneled" id="term-for-obtain-a-site">obtain a site</span>
     <li><span class="dfn-paneled" id="term-for-concept-origin-opaque">opaque origin</span>
     <li><span class="dfn-paneled" id="term-for-site">site</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-byte-sequence">byte sequence</span>
     <li><span class="dfn-paneled" id="term-for-implementation-defined">implementation-defined</span>
     <li><span class="dfn-paneled" id="term-for-list">list</span>
     <li><span class="dfn-paneled" id="term-for-ordered-map">ordered map</span>
     <li><span class="dfn-paneled" id="term-for-parse-json-bytes-to-an-infra-value">parse json bytes to an infra value</span>
     <li><span class="dfn-paneled" id="term-for-string">string</span>
     <li><span class="dfn-paneled" id="term-for-struct">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-dom-permissiondescriptor">PermissionDescriptor</span>
     <li><span class="dfn-paneled" id="term-for-dom-permissiondescriptor-name">name</span>
     <li><span class="dfn-paneled" id="term-for-dfn-remove-a-permission-store-entry">remove a permission store entry</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PSL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-">registered domain</span>
    </ul>
   <li>
    <a data-link-type="biblio">[STORAGE-ACCESS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-①">determine the storage access policy</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-concept-basic-url-parser">basic url parser</span>
     <li><span class="dfn-paneled" id="term-for-concept-url-origin">origin</span>
     <li><span class="dfn-paneled" id="term-for-concept-url-scheme">scheme</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-clear-site-data">[CLEAR-SITE-DATA]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec-clear-site-data/"><cite>Clear Site Data</cite></a>. URL: <a href="https://w3c.github.io/webappsec-clear-site-data/">https://w3c.github.io/webappsec-clear-site-data/</a>
   <dt id="biblio-encoding">[ENCODING]
   <dd>Anne van Kesteren. <a href="https://encoding.spec.whatwg.org/"><cite>Encoding Standard</cite></a>. Living Standard. URL: <a href="https://encoding.spec.whatwg.org/">https://encoding.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions">[PERMISSIONS]
   <dd>Marcos Caceres; Mike Taylor. <a href="https://w3c.github.io/permissions/"><cite>Permissions</cite></a>. URL: <a href="https://w3c.github.io/permissions/">https://w3c.github.io/permissions/</a>
   <dt id="biblio-psl">[PSL]
   <dd><cite><a href="https://publicsuffix.org/">Public Suffix List</a></cite>.    Mozilla Foundation.
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-storage-access">[STORAGE-ACCESS]
   <dd><a href="https://privacycg.github.io/storage-access/"><cite>Storage Access API</cite></a>. CG Draft. URL: <a href="https://privacycg.github.io/storage-access/">https://privacycg.github.io/storage-access/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-cache-probing">[CACHE-PROBING]
   <dd><a href="https://xsleaks.dev/docs/attacks/cache-probing/"><cite>Cache Probing</cite></a>. URL: <a href="https://xsleaks.dev/docs/attacks/cache-probing/">https://xsleaks.dev/docs/attacks/cache-probing/</a>
   <dt id="biblio-csrf">[CSRF]
   <dd><a href="https://owasp.org/www-community/attacks/csrf"><cite>Cross Site Request Forgery (CSRF)</cite></a>. URL: <a href="https://owasp.org/www-community/attacks/csrf">https://owasp.org/www-community/attacks/csrf</a>
   <dt id="biblio-fps-list">[FPS-LIST]
   <dd><a href="https://github.com/GoogleChrome/first-party-sets/blob/main/first_party_sets.JSON"><cite>First-Party Sets list</cite></a>. URL: <a href="https://github.com/GoogleChrome/first-party-sets/blob/main/first_party_sets.JSON">https://github.com/GoogleChrome/first-party-sets/blob/main/first_party_sets.JSON</a>
   <dt id="biblio-json-schema">[JSON-SCHEMA]
   <dd>Austin Wright; et al. <a href="https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema"><cite>JSON Schema: A Media Type for Describing JSON Documents</cite></a>. 8 December 2020. Internet-Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema">https://datatracker.ietf.org/doc/html/draft-bhutton-json-schema</a>
   <dt id="biblio-submission-guidelines">[SUBMISSION-GUIDELINES]
   <dd><a href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md"><cite>First-Party Sets Submission Guidelines</cite></a>. URL: <a href="https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md">https://github.com/GoogleChrome/first-party-sets/blob/main/FPS-Submission_Guidelines.md</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Can we make a recommendation for an update interval here? <a href="https://github.com/wicg/first-party-sets/issues/122">[Issue #wicg/first-party-sets#122]</a> <a class="issue-return" href="#issue-2f53edbf" title="Jump to section">↵</a></div>
   <div class="issue"> Client-side validation may be needed in cases where the <a data-link-type="biblio" href="#biblio-psl"><cite>Public Suffix List</cite></a> version differs between the server and client. <a href="https://github.com/wicg/first-party-sets/issues/125">[Issue #wicg/first-party-sets#125]</a> <a class="issue-return" href="#issue-bb862ccb" title="Jump to section">↵</a></div>
   <div class="issue"> The specification currently suggests skipping invalid sets (missing primary entries) instead of rejecting the entire list. However, there may be benefit in a full rejection given that the server is expected to hold valid information at all times. <a href="https://github.com/wicg/first-party-sets/issues/126">[Issue #wicg/first-party-sets#126]</a> <a class="issue-return" href="#issue-f434ab32" title="Jump to section">↵</a></div>
   <div class="issue"> Should this be renamed to avoid being confused with a mathematical equivalence relation? <a href="https://github.com/wicg/first-party-sets/issues/123">[Issue #wicg/first-party-sets#123]</a> <a class="issue-return" href="#issue-7a693f54" title="Jump to section">↵</a></div>
   <div class="issue"> This section should provide more details on how user agents can figure out when a site leaves an FPS. <a href="https://github.com/wicg/first-party-sets/issues/124">[Issue #wicg/first-party-sets#124]</a> <a class="issue-return" href="#issue-084bef24" title="Jump to section">↵</a></div>
  </div>
  <aside class="dfn-panel" data-for="build-the-list-of-first-party-sets">
   <b><a href="#build-the-list-of-first-party-sets">#build-the-list-of-first-party-sets</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-build-the-list-of-first-party-sets">3. List consumption</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="list-of-first-party-sets">
   <b><a href="#list-of-first-party-sets">#list-of-first-party-sets</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list-of-first-party-sets">3. List consumption</a> <a href="#ref-for-list-of-first-party-sets①">(2)</a>
    <li><a href="#ref-for-list-of-first-party-sets②">5. Validating first-party set inclusion</a>
    <li><a href="#ref-for-list-of-first-party-sets③">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="first-party-set">
   <b><a href="#first-party-set">#first-party-set</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-first-party-set">3. List consumption</a>
    <li><a href="#ref-for-first-party-set①">4. Data Structures</a>
    <li><a href="#ref-for-first-party-set②">5. Validating first-party set inclusion</a>
    <li><a href="#ref-for-first-party-set③">6. Integration with the Storage Access API</a> <a href="#ref-for-first-party-set④">(2)</a>
    <li><a href="#ref-for-first-party-set⑤">7. Handling first-party set changes</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="first-party-set-primary">
   <b><a href="#first-party-set-primary">#first-party-set-primary</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-first-party-set-primary">3. List consumption</a>
    <li><a href="#ref-for-first-party-set-primary①">5. Validating first-party set inclusion</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="first-party-set-cctlds">
   <b><a href="#first-party-set-cctlds">#first-party-set-cctlds</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-first-party-set-cctlds">5. Validating first-party set inclusion</a> <a href="#ref-for-first-party-set-cctlds①">(2)</a> <a href="#ref-for-first-party-set-cctlds②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="first-party-set-associatedsites">
   <b><a href="#first-party-set-associatedsites">#first-party-set-associatedsites</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-first-party-set-associatedsites">3. List consumption</a>
    <li><a href="#ref-for-first-party-set-associatedsites①">5. Validating first-party set inclusion</a>
    <li><a href="#ref-for-first-party-set-associatedsites②">6. Integration with the Storage Access API</a> <a href="#ref-for-first-party-set-associatedsites③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="first-party-set-servicesites">
   <b><a href="#first-party-set-servicesites">#first-party-set-servicesites</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-first-party-set-servicesites">3. List consumption</a>
    <li><a href="#ref-for-first-party-set-servicesites①">5. Validating first-party set inclusion</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="equivalence-map">
   <b><a href="#equivalence-map">#equivalence-map</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-equivalence-map">4. Data Structures</a> <a href="#ref-for-equivalence-map①">(2)</a>
    <li><a href="#ref-for-equivalence-map②">5. Validating first-party set inclusion</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="parse-and-validate-a-site">
   <b><a href="#parse-and-validate-a-site">#parse-and-validate-a-site</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-parse-and-validate-a-site">4. Data Structures</a> <a href="#ref-for-parse-and-validate-a-site①">(2)</a> <a href="#ref-for-parse-and-validate-a-site②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="parse-a-subset">
   <b><a href="#parse-a-subset">#parse-a-subset</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-parse-a-subset">3. List consumption</a> <a href="#ref-for-parse-a-subset①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="parse-an-equivalence-map">
   <b><a href="#parse-an-equivalence-map">#parse-an-equivalence-map</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-parse-an-equivalence-map">3. List consumption</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="equivalent-to">
   <b><a href="#equivalent-to">#equivalent-to</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-equivalent-to">5. Validating first-party set inclusion</a> <a href="#ref-for-equivalent-to①">(2)</a> <a href="#ref-for-equivalent-to②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="determine-the-member-type">
   <b><a href="#determine-the-member-type">#determine-the-member-type</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-determine-the-member-type">5. Validating first-party set inclusion</a>
    <li><a href="#ref-for-determine-the-member-type①">6. Integration with the Storage Access API</a> <a href="#ref-for-determine-the-member-type②">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="find-a-first-party-set">
   <b><a href="#find-a-first-party-set">#find-a-first-party-set</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-find-a-first-party-set">6. Integration with the Storage Access API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="limit-for-associated-sites">
   <b><a href="#limit-for-associated-sites">#limit-for-associated-sites</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-limit-for-associated-sites">6. Integration with the Storage Access API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="eligible-for-same-party-membership-when-embedded-within">
   <b><a href="#eligible-for-same-party-membership-when-embedded-within">#eligible-for-same-party-membership-when-embedded-within</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-eligible-for-same-party-membership-when-embedded-within">6. Integration with the Storage Access API</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="determine-eligibility-for-an-associated-site">
   <b><a href="#determine-eligibility-for-an-associated-site">#determine-eligibility-for-an-associated-site</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-determine-eligibility-for-an-associated-site">6. Integration with the Storage Access API</a> <a href="#ref-for-determine-eligibility-for-an-associated-site①">(2)</a> <a href="#ref-for-determine-eligibility-for-an-associated-site②">(3)</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>