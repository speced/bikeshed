<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Document Policy</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/document-policy/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Document Policy</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/document-policy/">https://wicg.github.io/document-policy/</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:iclelland@google.com">Ian Clelland</a> (<span class="p-org org">Google</span>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 1970 the Contributors to the Document Policy Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification defines a mechanism that allows developers to ...</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#examples"><span class="secno">2</span> <span class="content">Examples #</span></a>
    <li>
     <a href="#other-and-related-mechanisms"><span class="secno">3</span> <span class="content">Other and related mechanisms</span></a>
     <ol class="toc">
      <li><a href="#relation-to-feature-policy"><span class="secno">3.1</span> <span class="content">Relation to Feature Policy</span></a>
      <li><a href="#relation-to-csp"><span class="secno">3.2</span> <span class="content">Relation to Content Security Policy</span></a>
      <li><a href="#relation-to-sandboxing"><span class="secno">3.3</span> <span class="content">Relation to Sandboxing</span></a>
     </ol>
    <li>
     <a href="#framework"><span class="secno">4</span> <span class="content">Framework</span></a>
     <ol class="toc">
      <li><a href="#configuration-points"><span class="secno">4.1</span> <span class="content">Configuration Points</span></a>
      <li><a href="#policies"><span class="secno">4.2</span> <span class="content">Policies</span></a>
     </ol>
    <li><a href="#serialization"><span class="secno">5</span> <span class="content">Required Policy Serialization</span></a>
    <li>
     <a href="#reporting"><span class="secno">6</span> <span class="content">Reporting</span></a>
     <ol class="toc">
      <li>
       <a href="#configure-reporting"><span class="secno">6.1</span> <span class="content">Configuring in-document reporting</span></a>
       <ol class="toc">
        <li><a href="#report-to-parameter"><span class="secno">6.1.1</span> <span class="content">The "report-to" parameter</span></a>
        <li><a href="#reporting-default"><span class="secno">6.1.2</span> <span class="content">Setting the default reporting endpoint</span></a>
        <li><a href="#reporting-disable"><span class="secno">6.1.3</span> <span class="content">Disabling reporting for a feature</span></a>
       </ol>
      <li><a href="#report-only"><span class="secno">6.2</span> <span class="content">Report-only mode</span></a>
     </ol>
    <li>
     <a href="#delivery"><span class="secno">7</span> <span class="content">Delivery</span></a>
     <ol class="toc">
      <li>
       <a href="#policies-as-structured-headers"><span class="secno">7.1</span> <span class="content">Policies as Structured Headers</span></a>
       <ol class="toc">
        <li><a href="#document-policy-directive-parameters"><span class="secno">7.1.1</span> <span class="content">Parameters</span></a>
       </ol>
      <li>
       <a href="#http-headers"><span class="secno">7.2</span> <span class="content">HTTP Headers</span></a>
       <ol class="toc">
        <li><a href="#document-policy-http-header"><span class="secno">7.2.1</span> <span class="content">Document-Policy</span></a>
        <li><a href="#document-policy-report-only-http-header"><span class="secno">7.2.2</span> <span class="content">Document-Policy-Report-Only</span></a>
        <li><a href="#require-document-policy-http-header"><span class="secno">7.2.3</span> <span class="content">Require-Document-Policy</span></a>
        <li><a href="#sec-required-document-policy-http-header"><span class="secno">7.2.4</span> <span class="content">Sec-Required-Document-Policy</span></a>
       </ol>
      <li><a href="#iframe-policy-attribute"><span class="secno">7.3</span> <span class="content">The <code>policy</code> attribute of the <code>iframe</code> element</span></a>
     </ol>
    <li>
     <a href="#integrations"><span class="secno">8</span> <span class="content">Integrations</span></a>
     <ol class="toc">
      <li><a href="#integration-with-html"><span class="secno">8.1</span> <span class="content">Integration with HTML</span></a>
      <li><a href="#integration-with-fetch"><span class="secno">8.2</span> <span class="content">Integration with Fetch</span></a>
     </ol>
    <li>
     <a href="#algorithms"><span class="secno">9</span> <span class="content">Algorithms</span></a>
     <ol class="toc">
      <li><a href="#algo-is-policy-compatible"><span class="secno">9.1</span> <span class="content"><span>Is policy compatible</span>?</span></a>
      <li><a href="#algo-process-response-policy"><span class="secno">9.2</span> <span class="content"><span>Process response policy</span></span></a>
      <li><a href="#algo-parse-document-policy"><span class="secno">9.3</span> <span class="content"><span>Parse document policy</span></span></a>
      <li><a href="#algo-serialize-required-policy"><span class="secno">9.4</span> <span class="content"><span>Serialize required policy</span></span></a>
      <li><a href="#algo-create-for-browsingcontext"><span class="secno">9.5</span> <span class="content"><span>Create a required policy for a browsing context</span></span></a>
      <li><a href="#algo-create-document-policy"><span class="secno">9.6</span> <span class="content"><span>Create a document Policy for a browsing context from response</span></span></a>
      <li><a href="#algo-should-reponse-to-request-be-blocked"><span class="secno">9.7</span> <span class="content"><span>Should response to request be blocked due to document policy</span>?</span></a>
      <li><a href="#algo-get-policy-value"><span class="secno">9.8</span> <span class="content"><span>Get policy value for feature in document</span></span></a>
      <li><a href="#algo-determine-compatibility"><span class="secno">9.9</span> <span class="content"><span>Determine compatibility of value with policy for feature</span></span></a>
      <li><a href="#algo-is-value-compatible-or-report"><span class="secno">9.10</span> <span class="content"><span>Determine if value is compatible with policy for feature or report</span></span></a>
      <li><a href="#algo-is-value-compatible"><span class="secno">9.11</span> <span class="content"><span>Determine if value is compatible with policy for feature</span></span></a>
     </ol>
    <li><a href="#iana-considerations"><span class="secno">10</span> <span class="content">IANA Considerations</span></a>
    <li>
     <a href="#privacy-and-security"><span class="secno">11</span> <span class="content">Privacy and Security</span></a>
     <ol class="toc">
      <li><a href="#exposure-of-cross-origin-behavior"><span class="secno">11.1</span> <span class="content">Exposure of cross-origin behavior</span></a>
      <li><a href="#advertisement-of-required-policy"><span class="secno">11.2</span> <span class="content">Advertisement of required policy</span></a>
      <li><a href="#blind-acceptance-of-policy"><span class="secno">11.3</span> <span class="content">Blind acceptance of required policy</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
    <p>This document defines <em>Document Policy</em>, which is a framework for
  designing configurable features as part of the web platform, and for allowing
  web developers to configure those features as part of their site deployment.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="examples"><span class="secno">2. </span><span class="content">Examples #</span><a class="self-link" href="#examples"></a></h2>
    <p>Needs new examples. For now, see explainer.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="other-and-related-mechanisms"><span class="secno">3. </span><span class="content">Other and related mechanisms</span><a class="self-link" href="#other-and-related-mechanisms"></a></h2>
    <p>Document Policy is similar in scope to some existing mechanisms for document
  configuration, though there are significant differences from each.</p>
    <section>
     <h3 class="heading settled" data-level="3.1" id="relation-to-feature-policy"><span class="secno">3.1. </span><span class="content">Relation to Feature Policy</span><a class="self-link" href="#relation-to-feature-policy"></a></h3>
     <p>Feature Policy <a data-link-type="biblio" href="#biblio-feature-policy" title="Permissions Policy">[FEATURE-POLICY]</a> is another mechanism which allows authors
    to configure features in documents, and is similar in scope, though it uses
    a different inheritance mechanism, which makes it more suitable for certain
    types of features, separate from those which are suitable for control by
    document policy.</p>
     <p>Historically, document policy was created as a response to a number of
    proposed feature additions to feature policy, which either didn’t quite fit
    the existing 'feature' model, or required significant additional complexity
    to be added to the feature policy spec. This included features with
    parameters, features with optional inheritance into subframes, and features
    which would inherit differently in popups than in other top-level browsing
    contexts.</p>
     <p>Those features are now proposed to be covered by document policy, and
    feature policy is used for features where delegation is the primary concern.
    Feature policy features are boolean-valued (either enabled or disabled), can
    never be re-enabled in a child frame if disabled in parent, and generally
    follow the model of "available in top-level browsing contexts and their
    same-origin children; must be delegated to cross-origin frames."</p>
     <p>In contrast, features controlled by document policy may take parameters, and
    those parameters may have unrelated values in different frames (constraining
    a feature in a parent frame does not necessarily constrain its child
    frames.)</p>
    </section>
    <section>
     <h3 class="heading settled" data-level="3.2" id="relation-to-csp"><span class="secno">3.2. </span><span class="content">Relation to Content Security Policy</span><a class="self-link" href="#relation-to-csp"></a></h3>
     <p>Content-Security-Policy <a data-link-type="biblio" href="#biblio-csp" title="Content Security Policy Level 3">[CSP]</a> also configures 'features' in documents,
    although it is primarily concerned with the origin of resources in a page,
    rather than controlling what those resources can do once loaded.</p>
     <p>CSP also provides a different mechanism for setting sandbox flags on a
    document, through the <em>sandbox</em> directive. If sandbox flags are moved
    to document policy, then this may be redundant, as the two headers may
    encode identical information.</p>
     <p>CSP-Embedded-Enforcement introduced a model for forcing a policy to be
    adhered to by child documents, and for rejecting non-conforming documents as
    network errors during Fetch. This model is adopted by document policy for
    the required policy mechanism.</p>
    </section>
    <section>
     <h3 class="heading settled" data-level="3.3" id="relation-to-sandboxing"><span class="secno">3.3. </span><span class="content">Relation to Sandboxing</span><a class="self-link" href="#relation-to-sandboxing"></a></h3>
     <p>Iframe sandboxing is another mechanism for controlling features in
    documents, and behaves in a very similar manner to document policy’s
    required policies: disabling a feature is something that can be imposed on
    a frame, and affects all content loaded into that frame.</p>
     <p>The features which are controlled by the iframe sandbox attribute could be
    expressed very naturally with document policy.</p>
     <p>One key difference between iframe sandboxing and document policy is that all
    sandbox features are applied by default when the 'sandbox' attribute is used
    on a frame, and must be re-enabled one-by-one. This makes it very difficult
    to extend the sandboxing model with new features, as any additions will
    immediately affect all existing sandboxed content. Additionally, there is no
    mechanism for the origin server to know that its content will be sandboxed,
    so it is difficult to add new sandbox features which could potentially alter
    control flow in a sandboxed document, as this could introduce new security
    vulnerabilities in existing content.</p>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="4" id="framework"><span class="secno">4. </span><span class="content">Framework</span><a class="self-link" href="#framework"></a></h2>
    <section>
     <h3 class="heading settled" data-level="4.1" id="configuration-points"><span class="secno">4.1. </span><span class="content">Configuration Points</span><a class="self-link" href="#configuration-points"></a></h3>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="configuration-point">configuration point</dfn> is a Web Platform API or behavior
    which can be enabled, diabled, or configured through Document Policy.
    Configuration points should be defined in the specification which describes
    the underlying API or behavior, although there is a registry of defined
    configuration points in use attached to this document.</p>
     <p>A <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point">configuration point</a> has a <dfn class="dfn-paneled" data-dfn-for="configuration point" data-dfn-type="dfn" data-noexport id="configuration-point-name">name</dfn>, which is a token.</p>
     <p>A <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①">configuration point</a> has a <dfn class="dfn-paneled" data-dfn-for="configuration point" data-dfn-type="dfn" data-noexport id="configuration-point-type">type</dfn>, which is one of:</p>
     <ul>
      <li data-md>
       <p><code>boolean</code>,</p>
      <li data-md>
       <p><code>integer</code>,</p>
      <li data-md>
       <p><code>float</code>, or</p>
      <li data-md>
       <p><code>enum</code>.</p>
     </ul>
     <p>A <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point②">configuration point</a> has a <dfn class="dfn-paneled" data-dfn-for="configuration point" data-dfn-type="dfn" data-noexport id="configuration-point-range">range</dfn>, which is a subset of all values for
    its <a data-link-type="dfn" href="#configuration-point-type" id="ref-for-configuration-point-type">type</a>.</p>
     <p>A <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point③">configuration point</a> has a <dfn class="dfn-paneled" data-dfn-for="configuration point" data-dfn-type="dfn" data-noexport id="configuration-point-default-value">default value</dfn>, which is an element of its <a data-link-type="dfn" href="#configuration-point-range" id="ref-for-configuration-point-range">range</a>.</p>
     <div class="issue" id="issue-91264ad1"><a class="self-link" href="#issue-91264ad1"></a>Should configuration points be allowed to have multiple
    parameters? Perhaps parameters should be defined separately, with names,
    types, and ranges.</div>
     <div class="informative"> When introducing a new configuration point, the <a data-link-type="dfn" href="#configuration-point-default-value" id="ref-for-configuration-point-default-value">default value</a> should be chosen carefully, with
    highest consideration given to web compatibility. When no explicit policy
    has been declared for a document, the default value will be in effect. </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="4.2" id="policies"><span class="secno">4.2. </span><span class="content">Policies</span><a class="self-link" href="#policies"></a></h3>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="document-policy">document policy</dfn> is an ordered map from <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point④">configuration
    points</a> to <a data-link-type="dfn" href="#policy-configuration" id="ref-for-policy-configuration">policy configurations</a></p>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="policy-configuration">policy configuration</dfn> is a tuple consisting of a <dfn class="dfn-paneled" data-dfn-for="policy configuration" data-dfn-type="dfn" data-noexport id="policy-configuration-value">value</dfn>, which is an element of the <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point⑤">configuration point</a>’s <a data-link-type="dfn" href="#configuration-point-range" id="ref-for-configuration-point-range①">range</a>, and a <dfn class="dfn-paneled" data-dfn-for="policy configuration" data-dfn-type="dfn" data-noexport id="policy-configuration-reporting-endpoint">reporting endpoint</dfn>, which is a string,
    and which may be null.</p>
     <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context">browsing context</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="required-document-policy">required document policy</dfn>, which
    is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy">document policy</a>. A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context①">browsing context</a> with a null <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context" id="ref-for-opener-browsing-context">opener
    browsing context</a> has an empty <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy">required document policy</a>.</p>
     <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context②">browsing context</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="nested context required document policy" data-noexport id="nested-context-required-document-policy">nested context required document
    policy</dfn>, which is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①">document policy</a>.</p>
     <p>A <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">Document</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="declared-document-policy">declared document policy</dfn>, which is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy②">document policy</a>.</p>
     <p>A <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①">Document</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="report-only-document-policy">report-only document policy</dfn>, which is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy③">document policy</a>.</p>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="5" id="serialization"><span class="secno">5. </span><span class="content">Required Policy Serialization</span><a class="self-link" href="#serialization"></a></h2>
    <section>
     <ul>
      <li data-md>
       <p>Explain here how required policies are <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="serialized document policy" data-noexport id="serialized-document-policy">serialized</dfn> as structured
headers.</p>
      <li data-md>
       <p>Ensure that there is a canonical form (for compat testing).</p>
     </ul>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="6" id="reporting"><span class="secno">6. </span><span class="content">Reporting</span><a class="self-link" href="#reporting"></a></h2>
    <p>A site deploying a document policy may want to know if any of the policies
  which are set on its pages are violated. For instance, a site which sets a
  policy requiring all images to be match the size of their containers may want
  to be alerted if a new developer or CMS inserts oversized images into content.
  Similarly, a site which deploys a policy which restricts the use of the <code>document.write</code> API may want to receive reports if a script is ever imported
  which uses it.</p>
    <p>This section defines a mechanism for reporting such violations using the
  Reporting API. <a data-link-type="biblio" href="#biblio-reporting" title="Reporting API">[REPORTING]</a></p>
    <p>A site may also want to test out a policy in real-world situations before
  enforcing it. This section also defines a "Report-only" mode, where the user
  agent can watch for situations which would be policy violations and report on
  them, without enforcing the policy. This allows site owners to work to drive
  the real-world violation count down to an acceptable level before actually
  deploying the policy.</p>
    <p>Reporting is only possible from the page which configures the policy. It is
  not possible to receive reports from a nested page which violates a required
  policy.</p>
    <p>"Violation" is defined per-feature, but should always reflect an action of the
  web developer, rather than the user directly.</p>
    <p>This implies that not all policies can be reported on. There is a class of
  feature whose settings cannot be said to be "violated" in any meaningful way
  by markup, or by script actions. A hypothetical feature which disabled text
  entry in form fields, for instance, could be enforced by the user agent, but
  if a user were to try to type in those fields, causing enforcement to be
  required, that would not represent a violation of the policy, and should not
  be reported.</p>
    <section>
     <h3 class="heading settled" data-level="6.1" id="configure-reporting"><span class="secno">6.1. </span><span class="content">Configuring in-document reporting</span><a class="self-link" href="#configure-reporting"></a></h3>
     <h4 class="heading settled" data-level="6.1.1" id="report-to-parameter"><span class="secno">6.1.1. </span><span class="content">The "report-to" parameter</span><a class="self-link" href="#report-to-parameter"></a></h4>
     <p>Any directive can include a parameter named <code>report-to</code>, which names a
    reporting <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint">endpoint</a> to which violation reports for that feature will
    be sent.</p>
     <p>Example:</p>
<pre>Document-Policy: something=1.0;report-to=endpoint1, something-else=?0;report-to=endpoint2
</pre>
     <h4 class="heading settled" data-level="6.1.2" id="reporting-default"><span class="secno">6.1.2. </span><span class="content">Setting the default reporting endpoint</span><a class="self-link" href="#reporting-default"></a></h4>
     <p>If violations for many or all features should be sent to the same endpoint,
    then it may be easier to define a single default <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint①">endpoint</a>. This can
    be defined by a parameter on the special token <code>*</code>. If a default <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint②">endpoint</a> is provided, then unless otherwise specified, all violation
    reports will be sent to that named endpoint. If a feature also specifies its
    own endpoint, with the <code>report-to</code> parameter, then reports will go to that
    endpoint instead. (Reports are not sent to both endpoints.)</p>
     <p>Example:</p>
<pre>Document-Policy: something=1.0, something-else=?0, *;report-to=endpoint
</pre>
     <h4 class="heading settled" data-level="6.1.3" id="reporting-disable"><span class="secno">6.1.3. </span><span class="content">Disabling reporting for a feature</span><a class="self-link" href="#reporting-disable"></a></h4>
     <p>If a default endpoint has been specified, then it may be necessary to
    disable reporting for specific features. This can be done by specifying the
    special endpoint name <code>none</code> as the value for the <code>report-to</code> parameter.
    This will override the default endpoint and disable reporting for that
    feature.</p>
     <p>Example:</p>
<pre>Document-Policy: something=1.0;report-to=none, something-else=?0,
                 *;report-to=endpoiont
</pre>
    </section>
    <section>
     <h3 class="heading settled" data-level="6.2" id="report-only"><span class="secno">6.2. </span><span class="content">Report-only mode</span><a class="self-link" href="#report-only"></a></h3>
     <p>A document policy can be a "report-only" policy. Report-only policies are
    specified with a <code>Document-Policy-Report-Only</code> header. Violations of a
    report-only policy will cause a report to be generated, as the enforcing
    policy would, but they do not cause any other action to be taken by the user
    agent.</p>
     <p>Document-Policy-Report-Only</p>
     <p>The <code>report-to</code> directive parameter should be used with directives in this
    header, or else they will have no effect at all.</p>
     <p>Example:</p>
<pre>Document-Policy-Report-Only: something=1.0;report-to=endpoint,
                             something-else=?0;report-to=endpoint2
</pre>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="7" id="delivery"><span class="secno">7. </span><span class="content">Delivery</span><a class="self-link" href="#delivery"></a></h2>
    <section>
     <h3 class="heading settled" data-level="7.1" id="policies-as-structured-headers"><span class="secno">7.1. </span><span class="content">Policies as Structured Headers</span><a class="self-link" href="#policies-as-structured-headers"></a></h3>
     <p>Policies are represented in HTTP headers and in HTML attributes as the
    serialization of an sh-dictionary structure. Each dictionary member is a <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive">document policy directive</a>.</p>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="document-policy-directive">document policy directive</dfn> is an element of a <a data-link-type="dfn" href="#serialized-document-policy" id="ref-for-serialized-document-policy">serialized document policy</a>, and consists of a <a data-link-type="dfn" href="#directive-name" id="ref-for-directive-name">directive name</a>,
    which is an sh-token, and associated <a data-link-type="dfn">parameters</a>.</p>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="directive-name">directive name</dfn> may be one of:</p>
     <ul>
      <li data-md>
       <p>The <a data-link-type="dfn" href="#configuration-point-name" id="ref-for-configuration-point-name">name</a> of a <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point⑥">configuration point</a></p>
      <li data-md>
       <p>The Token "<code>*</code>".</p>
     </ul>
     <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="policy-value">policy value</dfn> is an element of the <a data-link-type="dfn" href="#configuration-point-range" id="ref-for-configuration-point-range②">range</a> for the named <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point⑦">configuration point</a>.</p>
    </section>
    <h4 class="heading settled" data-level="7.1.1" id="document-policy-directive-parameters"><span class="secno">7.1.1. </span><span class="content">Parameters</span><a class="self-link" href="#document-policy-directive-parameters"></a></h4>
    <p>Any <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive①">document policy directive</a> may include a parameter named <code>report-to</code>, whose value must be a string.</p>
    <p>A <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive②">document policy directive</a> whose <a data-link-type="dfn" href="#directive-name" id="ref-for-directive-name①">directive name</a> names a <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point⑧">configuration point</a> with <a data-link-type="dfn">type</a> <code>boolean</code> has no required
    parameters.</p>
    <p>A <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive③">document policy directive</a> whose <a data-link-type="dfn" href="#directive-name" id="ref-for-directive-name②">directive name</a> names a <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point⑨">configuration point</a> with <a data-link-type="dfn">type</a> <code>integer</code> has a required
    parameter, whose value must be an integer in the <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①⓪">configuration
    point</a>’s <a data-link-type="dfn">range</a>.</p>
    <p>A <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive④">document policy directive</a> whose <a data-link-type="dfn" href="#directive-name" id="ref-for-directive-name③">directive name</a> names a <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①①">Configuration point</a> with <a data-link-type="dfn">type</a> <code>float</code> has a required
    parameter, whose value must be an decimal in the <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①②">configuration
    point</a>’s <a data-link-type="dfn">range</a>.</p>
    <p>A <a data-link-type="dfn" href="#document-policy-directive" id="ref-for-document-policy-directive⑤">document policy directive</a> whose <a data-link-type="dfn" href="#directive-name" id="ref-for-directive-name④">directive name</a> names a <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①③">configuration point</a> with <a data-link-type="dfn">type</a> <code>enum</code> has a required parameter,
    whose value must be 'true', and whose name must be a token in the <a data-link-type="dfn" href="#configuration-point" id="ref-for-configuration-point①④">configuration point</a>’s <a data-link-type="dfn">range</a>.</p>
    <p>Examples:</p>
    <ul>
     <li data-md>
      <p><code>boolean-feature</code></p>
     <li data-md>
      <p><code>boolean-feature=?0</code></p>
     <li data-md>
      <p><code>integer-feature=2</code></p>
     <li data-md>
      <p><code>float-feature=-0.2</code></p>
     <li data-md>
      <p><code>enum-feature=state</code></p>
    </ul>
   </section>
   <section>
    <h3 class="heading settled" data-level="7.2" id="http-headers"><span class="secno">7.2. </span><span class="content">HTTP Headers</span><a class="self-link" href="#http-headers"></a></h3>
    <section>
     <h4 class="heading settled" data-level="7.2.1" id="document-policy-http-header"><span class="secno">7.2.1. </span><span class="content">Document-Policy</span><a class="self-link" href="#document-policy-http-header"></a></h4>
     <p>The `<dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="document-policy-header"><code>Document-Policy</code></dfn>` HTTP
    header can be used in the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-response" id="ref-for-concept-response-response">response</a> (server to client) to communicate the <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy④">document policy</a> that should be enforced by the client.</p>
     <p>The <code>Document-Policy</code> header is a Structured Header. Its value
    must be a dictionary. Its ABNF is:</p>
     <p>Document-Policy = sh-dictionary</p>
     <p>If any dictionary member name does not name a supported configuration point
    or the special value "*", then the dictionary memver will be ignored by the
    processing steps.</p>
    </section>
    <section>
     <h4 class="heading settled" data-level="7.2.2" id="document-policy-report-only-http-header"><span class="secno">7.2.2. </span><span class="content">Document-Policy-Report-Only</span><a class="self-link" href="#document-policy-report-only-http-header"></a></h4>
     <p>The `<dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="document-policy-report-only-header"><code>Document-Policy-Report-Only</code></dfn>`
    HTTP header can be used in the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-response" id="ref-for-concept-response-response①">response</a> (server to client) to configure
    the <a data-link-type="dfn" href="#report-only-document-policy" id="ref-for-report-only-document-policy">report-only document policy</a> for the document.</p>
     <p>The <code>Document-Policy-Report-Only</code> header is a Structured Header.
    Its value must be a dictionary. It has exactly the same syntax as the <code>Document-Policy</code> header.</p>
    </section>
    <section>
     <h4 class="heading settled" data-level="7.2.3" id="require-document-policy-http-header"><span class="secno">7.2.3. </span><span class="content">Require-Document-Policy</span><a class="self-link" href="#require-document-policy-http-header"></a></h4>
     <p>The `<dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="require-document-policy-header"><code>Require-Document-Policy</code></dfn>`
    HTTP header field is a response header which is used to communicate to the
    client the minimum <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy①">required document policy</a> to apply to all nested
    content.</p>
     <p>The <code>Require-Document-Policy</code> header is a Structured Header dictionary, with
    exactly the same syntax as the <code>Document-Policy</code> header.</p>
    </section>
    <section>
     <h4 class="heading settled" data-level="7.2.4" id="sec-required-document-policy-http-header"><span class="secno">7.2.4. </span><span class="content">Sec-Required-Document-Policy</span><a class="self-link" href="#sec-required-document-policy-http-header"></a></h4>
     <p>The `<dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="sec-required-document-policy-header"><code>Sec-Required-Document-Policy</code></dfn>`
    HTTP header field is a request header which is used to communicate to the
    server the <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy⑤">document policy</a> which must be sent with the document
    returned with the request.</p>
     <p>The header’s value is the <a href="#serialization">§ 5 Required Policy Serialization</a> of one or more <a data-link-type="dfn">policy directive</a>s</p>
    </section>
   </section>
   <section>
    <h3 class="heading settled" data-level="7.3" id="iframe-policy-attribute"><span class="secno">7.3. </span><span class="content">The <code>policy</code> attribute of the <code>iframe</code> element</span><a class="self-link" href="#iframe-policy-attribute"></a></h3>
    <p><code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element">iframe</a></code> elements have a "<code>policy</code>" attribute, which contains a required
    policy directive (SH format).</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="8" id="integrations"><span class="secno">8. </span><span class="content">Integrations</span><a class="self-link" href="#integrations"></a></h2>
    <p>If a frame has a required policy, then that policy must be advertised in the
  request header for any outgoing document requests, to inform the server of the
  policy which will be applied to the document by the user agent. This allows
  the server to alter the representation which is returned, to conform to that
  policy.</p>
    <p>In the case where a required policy request header is present, the response
  must contain a compatible document policy header, or the fetch will fail.</p>
    <section>
     <h3 class="heading settled" data-level="8.1" id="integration-with-html"><span class="secno">8.1. </span><span class="content">Integration with HTML</span><a class="self-link" href="#integration-with-html"></a></h3>
     <p>The following changes should be incorporated into <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</p>
     <ul>
      <li data-md>
       <p><code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element①">iframe</a></code> elements should have the following IDL added:</p>
     </ul>
<pre>[CEReactions] attribute DOMString policy;
</pre>
     <ul>
      <li data-md>
       <p>The iframe policy attribute should be defined as follows:</p>
       <ul>
        <li data-md>
         <p>The <code>policy</code> attribute, when specified, adds a <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy②">required document
policy</a> to the <code>iframe</code>’s <a data-link-type="dfn">nested browsing context</a>, when it is
initialized. Its value must be a <a data-link-type="dfn" href="#serialized-document-policy" id="ref-for-serialized-document-policy①">serialized document policy</a>.</p>
       </ul>
      <li data-md>
       <p>In <a href="https://html.spec.whatwg.org/multipage/dom.html#the-document-object"><cite>HTML</cite> § 3.1.1 The Document object</a>, add the following line:</p>
       <ul>
        <li data-md>
         <p>The <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document②">Document</a> has a <b>document policy</b>, which is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy⑥">document
policy</a>, which is initially empty.</p>
       </ul>
      <li data-md>
       <p>In the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-browsing-context" id="ref-for-creating-a-new-browsing-context">creating a new browsing context</a> algorithm:</p>
       <ul>
        <li data-md>
         <p>Add the following step after step 5:</p>
         <ol start="6">
          <li data-md>
           <p>Set <var>browsingContext</var>’s <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy③">required document
policy</a> to the result of <a data-link-type="dfn" href="#create-for-browsingcontext" id="ref-for-create-for-browsingcontext">creating a required policy for a
browsing context</a> <var>browsingContext</var>.</p>
         </ol>
        <li data-md>
         <p>Change step 9 (renumbered now to 10) to read:</p>
         <ol start="10">
          <li data-md>
           <p>Let <var>document</var> be a new <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document③">Document</a>, marked as
an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#html-document" id="ref-for-html-document">HTML document</a> in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-quirks" id="ref-for-concept-document-quirks">quirks mode</a>, whose <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-content-type" id="ref-for-concept-document-content-type">content
type</a> is <code>"text/html"</code>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a> is <var>origin</var>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set" id="ref-for-active-sandboxing-flag-set">active sandboxing flag set</a> is <var>sandboxFlags</var>, <a data-link-type="dfn">feature policy</a> is <var>feature policy</var>, document
policy is identical to <var>browsingContext</var>’s <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy④">required
document policy</a>, and which is both ready for post-load tasks and
completely loaded immediately.</p>
         </ol>
       </ul>
      <li data-md>
       <p>In the <a data-link-type="dfn">process a navigate fetch</a> algorithm:</p>
       <ul>
        <li data-md>
         <p>Add the following step after step 5:</p>
         <ol start="6">
          <li data-md>
           <p>Set <var>request</var>’s <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy⑤">required document policy</a> to <var>browsingContext</var>’s <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy⑥">required document policy</a>.</p>
         </ol>
       </ul>
      <li data-md>
       <p>In the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#initialise-the-document-object" id="ref-for-initialise-the-document-object">initialise the document object</a> algorithm:</p>
       <ul>
        <li data-md>
         <p>Add the following step after step 3:</p>
         <ol start="4">
          <li data-md>
           <p>Let <var>documentPolicy</var> be the result of <a data-link-type="dfn" href="#create-document-policy" id="ref-for-create-document-policy">creating a document policy</a> for <var>browsingContext</var> from <var>response</var>.</p>
         </ol>
        <li data-md>
         <p>Change step 6 (renumbered now to 7) to read:</p>
         <ol start="7">
          <li data-md>
           <p>Let <var>document</var> be a new Document, whose type is <var>type</var>, content type is <var>contentType</var>,
origin is <var>origin</var>, feature policy is <var>featurePolicy</var>, active sandboxing flag set is <var>finalSandboxFlags</var>, and document policy is <var>documentPolicy</var>.</p>
         </ol>
       </ul>
     </ul>
    </section>
    <section>
     <h3 class="heading settled" data-level="8.2" id="integration-with-fetch"><span class="secno">8.2. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#integration-with-fetch"></a></h3>
     <p>The following changes should be incorporated into <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a>:</p>
     <ul>
      <li data-md>
       <p>In <a href="https://fetch.spec.whatwg.org/#requests"><cite>Fetch</cite> § 2.2.5 Requests</a>, add the following:</p>
       <ul>
        <li data-md>
         <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-request" id="ref-for-concept-request-request">request</a> has an associated <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="request-required-document-policy" data-noexport id="request-required-document-policy">required document
policy</dfn>, which is a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy⑦">document policy</a>. Unless otherwise
stated, it is null.</p>
       </ul>
      <li data-md>
       <p>In <a href="https://fetch.spec.whatwg.org/#http-network-or-cache-fetch"><cite>Fetch</cite> § 4.5 HTTP-network-or-cache fetch</a>, after step 15, insert the
following:</p>
       <ol>
        <li data-md>
         <p>If <var>httpRequest</var> has a <a data-link-type="dfn" href="#request-required-document-policy" id="ref-for-request-required-document-policy">required document policy</a>,
then</p>
         <ol>
          <li data-md>
           <p>Let <var>serializedRequiredPolicy</var> be the result of calling <a data-link-type="dfn" href="#serialize-required-policy" id="ref-for-serialize-required-policy">Serialize
 Required Policy</a> on <var>httpRequest</var>’s <a data-link-type="dfn" href="#request-required-document-policy" id="ref-for-request-required-document-policy①">required document
 policy</a>.</p>
          <li data-md>
           <p>Append <code>Sec-Required-Document-Policy</code>/<var>serializedRequiredPolicy</var> to <var>httpRequest</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list">header list</a>.</p>
         </ol>
       </ol>
      <li data-md>
       <p>In <a href="https://fetch.spec.whatwg.org/#main-fetch"><cite>Fetch</cite> § 4.1 Main fetch</a>, add the following algorithm to the list of
algorithms in step 11:</p>
       <ul>
        <li data-md>
         <p><a data-link-type="dfn" href="#should-response-to-request-be-blocked-due-to-document-policy" id="ref-for-should-response-to-request-be-blocked-due-to-document-policy">should <var>internalResponse</var> to <var>request</var> be
blocked due to document policy</a></p>
       </ul>
      <li data-md>
       <p>Add the following algorithm to <a href="https://fetch.spec.whatwg.org/#terminology-headers"><cite>Fetch</cite> § 2.2.2 Headers</a>:</p>
       <ul>
        <li data-md>
         <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="get-and-parse-a-structured-header">get and parse a structured header</dfn> <var>name</var> as <var>type</var> from <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-headers-header-list" id="ref-for-concept-headers-header-list">header list</a> <var>list</var>, run these steps:</p>
         <ol>
          <li data-md>
           <p>Let <var>input</var> be the result of getting <var>name</var> from <var>list</var>.</p>
          <li data-md>
           <p>If <var>input</var> is null, then return null.</p>
          <li data-md>
           <p>Let <var>value</var> be the result of running the <a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure-14#section-4.2">Parsing
 Header Fields into Structured Headers</a> algorithm with <var>input</var> as <var>input_string</var> and <var>type</var> as <var>header_type</var>. <a data-link-type="biblio" href="#biblio-header-structure" title="Structured Headers for HTTP">[HEADER-STRUCTURE]</a></p>
          <li data-md>
           <p>If the previous step fails, return null.</p>
          <li data-md>
           <p>Return <var>value</var>.</p>
         </ol>
       </ul>
     </ul>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="9" id="algorithms"><span class="secno">9. </span><span class="content">Algorithms</span><a class="self-link" href="#algorithms"></a></h2>
    <section>
     <h3 class="heading settled" data-level="9.1" id="algo-is-policy-compatible"><span class="secno">9.1. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="is-policy-compatible">Is policy compatible</dfn>?</span><a class="self-link" href="#algo-is-policy-compatible"></a></h3>
     <div class="algorithm" data-algorithm="is-policy-compatible">
       Given a <a data-link-type="dfn" href="#required-document-policy" id="ref-for-required-document-policy⑦">required document policy</a> <var>requiredPolicy</var> and a <a data-link-type="dfn" href="#declared-document-policy" id="ref-for-declared-document-policy">declared
    document policy</a> <var>declaredPolicy</var>, this algorithm returns true if <var>declaredPolicy</var> is compatible with <var>requiredPolicy</var>, or false otherwise. 
      <ol>
       <li data-md>
        <p>For each <var>configuration point</var> → <var>value</var> in <var>requiredPolicy</var>:</p>
        <ol>
         <li data-md>
          <p>If <var>declaredPolicy</var>[<var>configuration point</var>] does not exist, then
  return false.</p>
         <li data-md>
          <p>If <var>value</var> is stricter than <var>declaredPolicy</var>[<var>configuration point</var>],
  then return false.</p>
        </ol>
       <li data-md>
        <p>Return true.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.2" id="algo-process-response-policy"><span class="secno">9.2. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="process-response-policy">Process response policy</dfn></span><a class="self-link" href="#algo-process-response-policy"></a></h3>
     <div class="algorithm" data-algorithm="process-response-policy">
       Given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-response" id="ref-for-concept-response-response②">response</a> (<var>response</var>), this algorithm returns a <a data-link-type="dfn" href="#declared-document-policy" id="ref-for-declared-document-policy①">declared
    document policy</a>. 
      <ol>
       <li data-md>
        <p>Abort these steps if <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a> does
  not contain a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header">header</a> whose <a data-link-type="dfn" href="#configuration-point-name" id="ref-for-configuration-point-name①">name</a> is
  "<code>Document-Policy</code>".</p>
       <li data-md>
        <p>Let <var>header</var> be the concatenation of the <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value">value</a>s of all <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header①">header</a> fields in <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list①">header list</a> whose name is
  "<code>Document-Policy</code>", separated by U+002C (,) (according to
  [RFC7230, 3.2.2]).</p>
       <li data-md>
        <p>Let <var>document policy</var> be the result of executing <a data-link-type="dfn" href="#parse-document-policy" id="ref-for-parse-document-policy">Parse document
  policy</a> on <var>header</var>.</p>
       <li data-md>
        <p>Return <var>document policy</var>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.3" id="algo-parse-document-policy"><span class="secno">9.3. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="parse-document-policy">Parse document policy</dfn></span><a class="self-link" href="#algo-parse-document-policy"></a></h3>
     <div class="algorithm" data-algorithm="parse-document-policy">
       Given a string (<var>policyString</var>), this algorithm returns a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy⑧">document
    policy</a>, if it can be parsed as one, or else fails. 
      <ol>
       <li data-md>
        <p>Let <var>policy</var> be a new ordered map.</p>
       <li data-md>
        <p>Let <var>defaultEndpoint</var> be a new string, set to null.</p>
       <li data-md>
        <p>Let <var>dict</var> be the result of parsing <var>policyString</var> as a dictionary.</p>
       <li data-md>
        <p>If parsing fails, then fail.</p>
       <li data-md>
        <p>For each <var>name</var>->(<var>value</var>,<var>parameters</var>) in <var>dict</var>,</p>
        <ol>
         <li data-md>
          <p>Let <var>currentEndpoint</var> be a new string, set to null.</p>
         <li data-md>
          <p>If <var>parameters</var>["report-to"] exists, and is a string, then:</p>
          <ol>
           <li data-md>
            <p>Set <var>currentEndpoint</var> to the value of <var>parameters</var>["report-to"].</p>
          </ol>
         <li data-md>
          <p>If <var>name</var> is the string "<code>*</code>", then:</p>
          <ol>
           <li data-md>
            <p>Set <var>defaultEndpoint</var> to <var>currentEndpoint</var>.</p>
          </ol>
         <li data-md>
          <p>Otherwise, if <var>name</var> is the name of a supported configuration point,
then:</p>
          <ol>
           <li data-md>
            <p>Let <var>configuration point</var> be the supported configuration point
with name <var>name</var>.</p>
           <li data-md>
            <p>If <var>policy</var>[<var>configuration point</var>] exists, then continue with the
next <var>element</var>.</p>
           <li data-md>
            <p>If <var>configuration point</var>’s type is boolean, then:</p>
            <ol>
             <li data-md>
              <p>If <var>value</var> is not a Boolean, then fail.</p>
             <li data-md>
              <p>Set <var>policy</var>[<var>configuration point</var>] to a new boolean <a data-link-type="dfn" href="#policy-configuration" id="ref-for-policy-configuration①">policy configuration</a> with <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value①">value</a> <var>value</var>, and <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint">reporting endpoint</a> <var>currentEndpoint</var>.</p>
             <li data-md>
              <p>Continue with the next <var>element</var>.</p>
            </ol>
           <li data-md>
            <p>If <var>configuration point</var>’s type is enum, then:</p>
            <ol>
             <li data-md>
              <p>If <var>value</var> is not a Token, then fail.</p>
             <li data-md>
              <p>If <var>value</var> is not the name of one of <var>configuration point</var>s
allowed enum values, then fail.</p>
             <li data-md>
              <p>Set <var>policy</var>[<var>configuration point</var>] to a new enum <a data-link-type="dfn" href="#policy-configuration" id="ref-for-policy-configuration②">policy
configuration</a> with <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value②">value</a> <var>value</var>, and <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint①">reporting endpoint</a> <var>currentEndpoint</var>.</p>
             <li data-md>
              <p>Continue with the next <var>element</var>.</p>
            </ol>
           <li data-md>
            <p>If <var>configuration point</var>’s type is integer, then:</p>
            <ol>
             <li data-md>
              <p>If <var>value</var> is not an Integer, then fail.</p>
             <li data-md>
              <p>If <var>value</var> is not in <var>configuration point</var>’s range, then
fail.</p>
             <li data-md>
              <p>Set <var>policy</var>[<var>configuration point</var>] to a new integer <a data-link-type="dfn" href="#policy-configuration" id="ref-for-policy-configuration③">policy configuration</a> with <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value③">value</a> <var>value</var>, and <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint②">reporting endpoint</a> <var>currentEndpoint</var>.</p>
             <li data-md>
              <p>Continue with the next <var>element</var>.</p>
            </ol>
           <li data-md>
            <p>If <var>configuration point</var>’s type is float, then:</p>
            <ol>
             <li data-md>
              <p>If <var>value</var> is not a Decimal, then fail.</p>
             <li data-md>
              <p>If <var>value</var> is not in <var>configuration point</var>’s range, then
fail.</p>
             <li data-md>
              <p>Set <var>policy</var>[<var>configuration point</var>] to a new float <a data-link-type="dfn" href="#policy-configuration" id="ref-for-policy-configuration④">policy
configuration</a> with <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value④">value</a> <var>value</var>, and <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint③">reporting endpoint</a> <var>currentEndpoint</var>.</p>
             <li data-md>
              <p>Continue with the next <var>element</var>.</p>
            </ol>
          </ol>
        </ol>
       <li data-md>
        <p>For each <var>configuration point</var> → <var>config</var> in <var>policy</var>,</p>
        <ol>
         <li data-md>
          <p>If <var>config</var> does not have a <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint④">reporting
endpoint</a>, set <var>config</var>’s <a data-link-type="dfn" href="#policy-configuration-reporting-endpoint" id="ref-for-policy-configuration-reporting-endpoint⑤">reporting endpoint</a> to <var>defaultEndpoint</var>.</p>
        </ol>
       <li data-md>
        <p>Return <var>policy</var>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.4" id="algo-serialize-required-policy"><span class="secno">9.4. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="serialize-required-policy">Serialize required policy</dfn></span><a class="self-link" href="#algo-serialize-required-policy"></a></h3>
     <div class="algorithm" data-algorithm="serialize-required-policy">
       Given a <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy⑨">document policy</a> (<var>requiredPolicy</var>), this algorithm returns a
    string which represents the canonical serialization of the policy. 
      <ol>
       <li data-md>
        <p>Let <var>dict</var> be a new ordered map.</p>
       <li data-md>
        <p>Let <var>features</var> be the keys of <var>requiredPolicy</var>.</p>
       <li data-md>
        <p>Sort <var>features</var> by the name of each element, in ASCII order.</p>
       <li data-md>
        <p>For each <var>feature</var> in <var>features</var>:</p>
        <ol>
         <li data-md>
          <p>Let <var>value</var> be <var>requiredPolicy</var>[<var>feature</var>].</p>
         <li data-md>
          <p>Set <var>dict</var>[<var>feature</var>] to <var>value</var>.</p>
        </ol>
       <li data-md>
        <p>Return the serialization of <var>dict</var>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.5" id="algo-create-for-browsingcontext"><span class="secno">9.5. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="create-for-browsingcontext" id="create-for-browsingcontext">Create a required policy for a browsing context</dfn></span><a class="self-link" href="#algo-create-for-browsingcontext"></a></h3>
     <div class="algorithm" data-algorithm="create-for-browsingcontext">
       Given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context③">browsing context</a> (<var>browsingContext</var>), this algorithm returns
    a new <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①⓪">Document Policy</a>. 
      <ol>
       <li data-md>
        <p>If <var>browsingContext</var> is a <a data-link-type="dfn">nested browsing context</a>, then</p>
        <ol>
         <li data-md>
          <p>Let <var>requiredPolicy</var> be a clone of <var>browsingContext</var>’s <a data-link-type="dfn">browsing
  context container</a>’s <a data-link-type="dfn" href="#nested-context-required-document-policy" id="ref-for-nested-context-required-document-policy">nested context required document
  policy</a>.</p>
         <li data-md>
          <p>If <var>browsingContext</var>’s <a data-link-type="dfn">browsing context container</a> has a
  "policy" attribute, then</p>
          <ol>
           <li data-md>
            <p>Let <var>containerPolicy</var> be the result of parsing the attribute</p>
           <li data-md>
            <p>For each <var>feature</var> -> <var>value</var> in <var>containerPolicy</var>:</p>
            <ol>
             <li data-md>
              <p>If <var>requiredPolicy</var>[<var>feature</var>] does not exist, or if <var>value</var> is stricter than <var>requiredPolicy</var>[<var>feature</var>], then set <var>requiredPolicy</var>[<var>feature</var>] to <var>value</var>.</p>
            </ol>
          </ol>
        </ol>
       <li data-md>
        <p>Otherwise, let <var>requiredPolicy</var> be a new ordered map.</p>
       <li data-md>
        <p>return <var>requiredPolicy</var>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.6" id="algo-create-document-policy"><span class="secno">9.6. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="create-document-policy" id="create-document-policy">Create a document Policy for a browsing context from response</dfn></span><a class="self-link" href="#algo-create-document-policy"></a></h3>
     <div class="algorithm" data-algorithm="create-document-policy">
       Given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" id="ref-for-browsing-context④">browsing context</a> (<var>browsingContext</var>) and a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-response" id="ref-for-concept-response-response③">response</a> (<var>response</var>), this algorithm returns a new <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①①">Document Policy</a>. 
      <ol>
       <li data-md>
        <p>Let <var>requiredPolicy</var> be the result of running <a data-link-type="dfn" href="#create-for-browsingcontext" id="ref-for-create-for-browsingcontext①">Create a required policy for a
  browsing context</a> given <var>browsingContext</var>.</p>
       <li data-md>
        <p>Let <var>declaredPolicy</var> be the result of running <a data-link-type="dfn" href="#process-response-policy" id="ref-for-process-response-policy">Process response
  policy</a> on <var>response</var>.</p>
       <li data-md>
        <p>If <var>declaredPolicy</var> is <a href="#is-policy-compatible" id="ref-for-is-policy-compatible">compatible</a> with <var>requiredPolicy</var>, then return <var>declaredPolicy</var>.</p>
       <li data-md>
        <p>Throw an exception.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.7" id="algo-should-reponse-to-request-be-blocked"><span class="secno">9.7. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="should-response-to-request-be-blocked-due-to-document-policy">Should response to request be blocked due to document policy</dfn>?</span><a class="self-link" href="#algo-should-reponse-to-request-be-blocked"></a></h3>
     <div class="algorithm" data-algorithm="should-response-to-request-be-blocked">
       Given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-request" id="ref-for-concept-request-request①">request</a> (<var>request</var>) and a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-response" id="ref-for-concept-response-response④">response</a> (<var>response</var>) to
       that request, this algorithm returns "blocked" if the response is not
       compatible with the request’s required policy, or "valid" otherwise. 
      <ol>
       <li data-md>
        <p>If <var>request</var> has a <a data-link-type="dfn" href="#request-required-document-policy" id="ref-for-request-required-document-policy②">required document
 policy</a>, then</p>
        <ol>
         <li data-md>
          <p>Let <var>documentPolicy</var> be the result of getting and parsing the
 structured header <code>Document-Policy</code> as "list" from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list②">header list</a>.</p>
         <li data-md>
          <p>If <var>documentPolicy</var> is not <a data-link-type="dfn" href="#is-policy-compatible" id="ref-for-is-policy-compatible①">compatible</a> with <var>request</var>’s <a data-link-type="dfn" href="#request-required-document-policy" id="ref-for-request-required-document-policy③">required document
 policy</a>, return "blocked".</p>
         <li data-md>
          <p>Return "valid".</p>
        </ol>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.8" id="algo-get-policy-value"><span class="secno">9.8. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="get-policy-value" id="get-policy-value">Get policy value for feature in document</dfn></span><a class="self-link" href="#algo-get-policy-value"></a></h3>
     <div class="algorithm" data-algorithm="get-policy-value">
       Given a feature (<var>feature</var>) and a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> object (<var>document</var>), this
    algorithm returns the value for <var>feature</var> in <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①②">document
    policy</a>. 
      <ol>
       <li data-md>
        <p>Let <var>policy</var> be <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①③">Document Policy</a>.</p>
       <li data-md>
        <p>If <var>policy</var>[<var>feature</var>] exists, return its <a data-link-type="dfn" href="#policy-configuration-value" id="ref-for-policy-configuration-value⑤">value</a>.</p>
       <li data-md>
        <p>Return <var>feature</var>’s <a data-link-type="dfn" href="#configuration-point-default-value" id="ref-for-configuration-point-default-value①">default value</a>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.9" id="algo-determine-compatibility"><span class="secno">9.9. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="determine-compatibility" data-noexport id="determine-compatibility">Determine compatibility of value with policy for feature</dfn></span><a class="self-link" href="#algo-determine-compatibility"></a></h3>
     <div class="algorithm" data-algorithm="determine-compatibility">
       Given a value (<var>value</var>), a feature (<var>feature</var>) and a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> object
    (<var>document</var>), this algorithm returns a tuple consisting of: 
      <ul>
       <li data-md>
        <p>An action, which is either "compatible" or "incompatible", depending on
whether <var>value</var> is compatible with <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①④">document policy</a>,</p>
       <li data-md>
        <p>A reporting endpoint name, which will be null if <var>value</var> is compatible
with both <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①⑤">document policy</a> and its <a data-link-type="dfn" href="#report-only-document-policy" id="ref-for-report-only-document-policy①">report-only
document policy</a>, or if reporting is not configured for <var>feature</var>, or
else will be the name of the <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint③">reporting endpoint</a> to
which a violation report should be sent.</p>
      </ul>
      <p>Note that if the enforcing policy is stricter than the report-only policy,
    then the report-only policy will not be checked.</p>
      <ol>
       <li data-md>
        <p>Let <var>policy</var> be <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①⑥">Document Policy</a>.</p>
       <li data-md>
        <p>Let <var>policyConfig</var> be <var>policy</var>[<var>feature</var>], if it exists, or a tuple
consisting of <var>feature</var>’s <a data-link-type="dfn" href="#configuration-point-default-value" id="ref-for-configuration-point-default-value②">default value</a> and null, otherwise.</p>
       <li data-md>
        <p>Let <var>policyValue</var> and <var>reporting endpoint</var> be the elements of <var>policyConfig</var></p>
       <li data-md>
        <p>If <var>policyValue</var> is stricter than <var>value</var>, then return a tuple
consisting of "incompatible" and <var>reporting endpoint</var>.</p>
       <li data-md>
        <p>Let <var>report-only policy</var> be <var>document</var>’s <a data-link-type="dfn" href="#report-only-document-policy" id="ref-for-report-only-document-policy②">report-only document
policy</a>,</p>
       <li data-md>
        <p>Let <var>report-only policyConfig</var> be <var>report-only policy</var>[<var>feature</var>], if
it exists, or a tuple consisting of <var>feature</var>’s <a data-link-type="dfn" href="#configuration-point-default-value" id="ref-for-configuration-point-default-value③">default value</a> and
null, otherwise.</p>
       <li data-md>
        <p>Set <var>policyValue</var> and <var>reporting endpoint</var> to the elements of <var>report-only policyConfig</var></p>
       <li data-md>
        <p>If <var>policyValue</var> is stricter than <var>value</var>, then return a tuple
consisting of "compatible" and <var>reporting endpoint</var>.</p>
       <li data-md>
        <p>Return ("compatible", null).</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.10" id="algo-is-value-compatible-or-report"><span class="secno">9.10. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="is-value-compatible-or-report" id="is-value-compatible-or-report">Determine if value is compatible with policy for feature or report</dfn></span><a class="self-link" href="#algo-is-value-compatible-or-report"></a></h3>
     <div class="algorithm" data-algorithm="is-value-compatible-or-report">
       Given a value (<var>value</var>), a feature (<var>feature</var>) and a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> object
    (<var>document</var>), this algorithm returns "compatible" if <var>value</var> is compatible
    with <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①⑦">document policy</a>, or else "incompatible". It will
    also queue a report if reporting has been configured. 
      <ol>
       <li data-md>
        <p>Let (<var>action</var>, <var>reporting endpoint</var>) be the result of calling <a data-link-type="dfn" href="#determine-compatibility" id="ref-for-determine-compatibility">determine-compatibility</a> with <var>value</var>, <var>feature</var> and <var>document</var>.</p>
       <li data-md>
        <p>If <var>reporting endpoint</var> is not null,</p>
        <ol>
         <li data-md>
          <p>Let <var>body</var> be a new ECMAScript object with the following properties: <a data-link-type="biblio" href="#biblio-ecma-262" title="ECMAScript Language Specification">[ECMA-262]</a></p>
          <dl>
           <dt data-md>featureId
           <dd data-md>
            <p>feature’s string representation.</p>
           <dt data-md>sourceFile
           <dd data-md>
            <p>null</p>
           <dt data-md>lineNumber
           <dd data-md>
            <p>null</p>
           <dt data-md>columnNumber
           <dd data-md>
            <p>null</p>
           <dt data-md>disposition
           <dd data-md>
            <p>"enforce", if <var>action</var> is "incompatible", or else "report".</p>
          </dl>
         <li data-md>
          <p>If the user agent is currently executing script, and can extract the
source file’s URL, line number, and column number from settings, then
set <var>body</var>’s sourceFile, lineNumber, and columnNumber accordingly.</p>
         <li data-md>
          <p>Let <var>settings</var> be <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a>.</p>
         <li data-md>
          <p>Execute <a href="https://w3c.github.io/reporting/#queue-report"><cite>Reporting API</cite> § 2.3 Queue data as type for destination</a> with <var>body</var>, "document-policy-violation", <var>reporting endpoint</var> and <var>settings</var>.</p>
        </ol>
       <li data-md>
        <p>Return <var>action</var>.</p>
      </ol>
     </div>
    </section>
    <section>
     <h3 class="heading settled" data-level="9.11" id="algo-is-value-compatible"><span class="secno">9.11. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="is-value-compatible" id="is-value-compatible">Determine if value is compatible with policy for feature</dfn></span><a class="self-link" href="#algo-is-value-compatible"></a></h3>
     <div class="algorithm" data-algorithm="is-value-compatible">
       Given a value (<var>value</var>), a feature (<var>feature</var>) and a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> object
    (<var>document</var>), this algorithm returns "compatible" if <var>value</var> is compatible
    with <var>document</var>’s <a data-link-type="dfn" href="#document-policy" id="ref-for-document-policy①⑧">document policy</a>, or else "incompatible". 
      <ol>
       <li data-md>
        <p>Let (<var>action</var>, <var>reporting endpoint</var>) be the result of
calling <a data-link-type="dfn" href="#determine-compatibility" id="ref-for-determine-compatibility①">determine-compatibility</a> with <var>value</var>, <var>feature</var> and <var>document</var>.</p>
       <li data-md>
        <p>Return <var>action</var>.</p>
      </ol>
     </div>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="10" id="iana-considerations"><span class="secno">10. </span><span class="content">IANA Considerations</span><a class="self-link" href="#iana-considerations"></a></h2>
    <p>The permanent message header field registry should be updated with the
  following registrations <a data-link-type="biblio" href="#biblio-rfc3864" title="Registration Procedures for Message Header Fields">[RFC3864]</a>:</p>
    <dl>
     <dt>Header field name
     <dd>Document-Policy
     <dt>Applicable protocol
     <dd>http
     <dt>Status
     <dd>standard
     <dt>Author/Change controller
     <dd>W3C
     <dt>Specification document
     <dd> <a href>Document Policy API</a> 
    </dl>
    <dl>
     <dt>Header field name
     <dd>Require-Document-Policy
     <dt>Applicable protocol
     <dd>http
     <dt>Status
     <dd>standard
     <dt>Author/Change controller
     <dd>W3C
     <dt>Specification document
     <dd> <a href>Document Policy API</a> 
    </dl>
    <dl>
     <dt>Header field name
     <dd>Sec-Required-Document-Policy
     <dt>Applicable protocol
     <dd>http
     <dt>Status
     <dd>standard
     <dt>Author/Change controller
     <dd>W3C
     <dt>Specification document
     <dd> <a href>Document Policy API</a> 
    </dl>
   </section>
   <section class="informative" id="privacy">
    <h2 class="heading settled" data-level="11" id="privacy-and-security"><span class="secno">11. </span><span class="content">Privacy and Security</span><a class="self-link" href="#privacy-and-security"></a></h2>
    <p>This specification standardizes a mechanism for an embedding page to set a
  policy which will be enforced on an embedded page. Explicit acknowledgment of
  a required policy is required, however, unlike existing the existing iframe <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox" id="ref-for-attr-iframe-sandbox">sandbox</a></code>, mechanism. This means that behaviors of existing features
  cannot be changed in published web sites, without the cooperation of those
  sites.</p>
    <p>There are some privacy and security considerations to keep in mind with this
  model:</p>
    <ul>
     <li data-md>
      <p>Exposure of behavior in a cross-origin subframe to its embedder.</p>
     <li data-md>
      <p>Exposure of embedder state to the embedded document thorough policy.</p>
     <li data-md>
      <p>Unanticipated behavior change by blindly accepting a required policy.</p>
    </ul>
    <p>To a degree, these concerns are already present in the web platform, and this
  specification attempts to at least not make them needlessly worse.</p>
    <p>Security and privacy issues may also be caused by the design of individual
  configuration points, so care must be taken when integrating with this
  specification. This section attempts to provide some guidance as to what kinds
  of behaviors could cause such issues.</p>
    <h3 class="heading settled" data-level="11.1" id="exposure-of-cross-origin-behavior"><span class="secno">11.1. </span><span class="content">Exposure of cross-origin behavior</span><a class="self-link" href="#exposure-of-cross-origin-behavior"></a></h3>
    <p>Configuraton points should be designed such that a violation of the policy in
  a framed document is not observable by documents in other frames. For
  instance, a hypothetical feature which caused a event to be fired in the
  embedding document if it is used while disabled by policy, could be used to
  extract information about the state of an embedded document. If the feature is
  known only to be used while a user is logged in to the site, for instance,
  then the embedder could disable that feature for the frame, and then listen
  for the resulting events to determine whether or not the user is logged in.</p>
    <p>Additionally, care must be taken so that information about the contents of
  cross-origin resources (which is not normally available to a document) is not
  made visible by a policy. Image contents, for instance, may contain private
  information, and a fine-grained policy may allow an attacker to infer
  something about the contents of the image by carefully tuning the policy’s
  configuration parameter. Policies which act on the contents of subresources
  should either exclude non-readable resources, or take steps to limit the
  amount of information which can be inferred about the resource.</p>
    <h3 class="heading settled" data-level="11.2" id="advertisement-of-required-policy"><span class="secno">11.2. </span><span class="content">Advertisement of required policy</span><a class="self-link" href="#advertisement-of-required-policy"></a></h3>
    <p>As a mitigation to the behavior change problem discussed above, requests for
  embedded content in a frame with a required policy will be sent with an HTTP
  header detailing the policy requirements. This header is visible to origin
  servers, and its contents may reveal details about the embedder page.
  Embedders should be aware of this when choosing to require a policy on their
  embedded content.</p>
    <h3 class="heading settled" data-level="11.3" id="blind-acceptance-of-policy"><span class="secno">11.3. </span><span class="content">Blind acceptance of required policy</span><a class="self-link" href="#blind-acceptance-of-policy"></a></h3>
    <p>Since adhering to the embedder-required policy is necessary in order to be
  loaded, site owners may be tempted to configure web servers to simply echo the <code>Sec-Required-Document-Policy</code> request header in the response’s <code>Document-Policy</code> header. While this will ensure that the document’s policy is
  always compatible with the request, it may open up the embedded document to
  the risk that the embedder can alter control flow within it, by disabling or
  changing the behavior of existing APIs. This is especially true as new
  configuration points are added to the document policy model after the content
  is written. It is difficult to future-proof a document against all possible
  new behavior changes.</p>
    <p>Sites which expect to be embedded in a context with a required document policy
  can mitigate this by setting their policy to the actual strictest policy that
  they know they can support, or by echoing the incoming policy for only the
  configuration points which they are aware of, and understand the potential
  scope of behavior changes.</p>
   </section>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
   <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
   <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#configuration-point">configuration point</a><span>, in § 4.1</span>
   <li><a href="#create-document-policy">create-document-policy</a><span>, in § 9.6</span>
   <li><a href="#create-for-browsingcontext">create-for-browsingcontext</a><span>, in § 9.5</span>
   <li><a href="#declared-document-policy">declared document policy</a><span>, in § 4.2</span>
   <li><a href="#configuration-point-default-value">default value</a><span>, in § 4.1</span>
   <li><a href="#determine-compatibility">determine-compatibility</a><span>, in § 9.9</span>
   <li><a href="#directive-name">directive name</a><span>, in § 7.1</span>
   <li><a href="#document-policy">document policy</a><span>, in § 4.2</span>
   <li><a href="#document-policy-header">Document-Policy</a><span>, in § 7.2.1</span>
   <li><a href="#document-policy-directive">document policy directive</a><span>, in § 7.1</span>
   <li><a href="#document-policy-report-only-header">Document-Policy-Report-Only</a><span>, in § 7.2.2</span>
   <li><a href="#get-and-parse-a-structured-header">get and parse a structured header</a><span>, in § 8.2</span>
   <li><a href="#get-policy-value">get-policy-value</a><span>, in § 9.8</span>
   <li><a href="#is-policy-compatible">Is policy compatible</a><span>, in § 9.1</span>
   <li><a href="#is-value-compatible">is-value-compatible</a><span>, in § 9.11</span>
   <li><a href="#is-value-compatible-or-report">is-value-compatible-or-report</a><span>, in § 9.10</span>
   <li><a href="#configuration-point-name">name</a><span>, in § 4.1</span>
   <li><a href="#nested-context-required-document-policy">nested context required document policy</a><span>, in § 4.2</span>
   <li><a href="#parse-document-policy">Parse document policy</a><span>, in § 9.3</span>
   <li><a href="#policy-configuration">policy configuration</a><span>, in § 4.2</span>
   <li><a href="#policy-value">policy value</a><span>, in § 7.1</span>
   <li><a href="#process-response-policy">Process response policy</a><span>, in § 9.2</span>
   <li><a href="#configuration-point-range">range</a><span>, in § 4.1</span>
   <li><a href="#policy-configuration-reporting-endpoint">reporting endpoint</a><span>, in § 4.2</span>
   <li><a href="#report-only-document-policy">report-only document policy</a><span>, in § 4.2</span>
   <li><a href="#request-required-document-policy">request-required-document-policy</a><span>, in § 8.2</span>
   <li><a href="#required-document-policy">required document policy</a><span>, in § 4.2</span>
   <li><a href="#require-document-policy-header">Require-Document-Policy</a><span>, in § 7.2.3</span>
   <li><a href="#sec-required-document-policy-header">Sec-Required-Document-Policy</a><span>, in § 7.2.4</span>
   <li><a href="#serialized-document-policy">serialized document policy</a><span>, in § 5</span>
   <li><a href="#serialize-required-policy">Serialize required policy</a><span>, in § 9.4</span>
   <li><a href="#should-response-to-request-be-blocked-due-to-document-policy">Should response to request be blocked due to document policy</a><span>, in § 9.7</span>
   <li><a href="#configuration-point-type">type</a><span>, in § 4.1</span>
   <li><a href="#policy-configuration-value">value</a><span>, in § 4.2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="3f23ec71">content type</span>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
     <li><span class="dfn-paneled" id="2d7f82f5">html document</span>
     <li><span class="dfn-paneled" id="fd11cdcd">quirks mode</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c9e7c11a">header</span>
     <li><span class="dfn-paneled" id="0298c08c">header list <small>(for Headers)</small></span>
     <li><span class="dfn-paneled" id="6ee0eab1">header list <small>(for request)</small></span>
     <li><span class="dfn-paneled" id="f7b00a8b">header list <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="162d2b51">request</span>
     <li><span class="dfn-paneled" id="e3201629">response</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="27e10eaf">active sandboxing flag set</span>
     <li><span class="dfn-paneled" id="0d0390b4">browsing context</span>
     <li><span class="dfn-paneled" id="aa0ee8c8">creating a new browsing context</span>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="87fcd40c">iframe</span>
     <li><span class="dfn-paneled" id="241984e3">initialise the document object</span>
     <li><span class="dfn-paneled" id="78787bc5">opener browsing context</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="5c35dd47">sandbox</span>
    </ul>
   <li>
    <a data-link-type="biblio">[REPORTING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9239678f">endpoint</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-header-structure">[HEADER-STRUCTURE]
   <dd>Mark Nottingham; Poul-Henning Kamp. <a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure-14"><cite>Structured Headers for HTTP</cite></a>. Draft. URL: <a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure-14">https://tools.ietf.org/html/draft-ietf-httpbis-header-structure-14</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-reporting">[REPORTING]
   <dd>Douglas Creager; Ian Clelland; Mike West. <a href="https://w3c.github.io/reporting/"><cite>Reporting API</cite></a>. URL: <a href="https://w3c.github.io/reporting/">https://w3c.github.io/reporting/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc3864">[RFC3864]
   <dd>G. Klyne; M. Nottingham; J. Mogul. <a href="https://www.rfc-editor.org/rfc/rfc3864"><cite>Registration Procedures for Message Header Fields</cite></a>. September 2004. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc3864">https://www.rfc-editor.org/rfc/rfc3864</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-csp">[CSP]
   <dd>Mike West; Antonio Sartori. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 3</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-ecma-262">[ECMA-262]
   <dd><a href="https://tc39.es/ecma262/multipage/"><cite>ECMAScript Language Specification</cite></a>. URL: <a href="https://tc39.es/ecma262/multipage/">https://tc39.es/ecma262/multipage/</a>
   <dt id="biblio-feature-policy">[FEATURE-POLICY]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue">Should configuration points be allowed to have multiple
    parameters? Perhaps parameters should be defined separately, with names,
    types, and ranges. <a class="issue-return" href="#issue-91264ad1" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0298c08c": {"dfnID":"0298c08c","dfnText":"header list (for Headers)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-headers-header-list"}],"title":"8.2. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-headers-header-list"},
"086e3aff": {"dfnID":"086e3aff","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"8.1. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"0d0390b4": {"dfnID":"0d0390b4","dfnText":"browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-browsing-context"},{"id":"ref-for-browsing-context\u2460"},{"id":"ref-for-browsing-context\u2461"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-browsing-context\u2462"}],"title":"9.5. Create a required policy for a browsing context"},{"refs":[{"id":"ref-for-browsing-context\u2463"}],"title":"9.6. Create a document Policy for a browsing context from response"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context"},
"162d2b51": {"dfnID":"162d2b51","dfnText":"request","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-request"}],"title":"8.2. Integration with Fetch"},{"refs":[{"id":"ref-for-concept-request-request\u2460"}],"title":"9.7. Should response to request be blocked due to document policy?"}],"url":"https://fetch.spec.whatwg.org/#concept-request-request"},
"241984e3": {"dfnID":"241984e3","dfnText":"initialise the document object","external":true,"refSections":[{"refs":[{"id":"ref-for-initialise-the-document-object"}],"title":"8.1. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#initialise-the-document-object"},
"27e10eaf": {"dfnID":"27e10eaf","dfnText":"active sandboxing flag set","external":true,"refSections":[{"refs":[{"id":"ref-for-active-sandboxing-flag-set"}],"title":"8.1. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"2d7f82f5": {"dfnID":"2d7f82f5","dfnText":"html document","external":true,"refSections":[{"refs":[{"id":"ref-for-html-document"}],"title":"8.1. Integration with HTML"}],"url":"https://dom.spec.whatwg.org/#html-document"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"9.10. Determine if value is compatible with policy for feature or report"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"3f23ec71": {"dfnID":"3f23ec71","dfnText":"content type","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-content-type"}],"title":"8.1. Integration with HTML"}],"url":"https://dom.spec.whatwg.org/#concept-document-content-type"},
"5c35dd47": {"dfnID":"5c35dd47","dfnText":"sandbox","external":true,"refSections":[{"refs":[{"id":"ref-for-attr-iframe-sandbox"}],"title":"11. Privacy and Security"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox"},
"6ee0eab1": {"dfnID":"6ee0eab1","dfnText":"header list (for request)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-header-list"}],"title":"8.2. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-request-header-list"},
"78787bc5": {"dfnID":"78787bc5","dfnText":"opener browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-opener-browsing-context"}],"title":"4.2. Policies"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"}],"title":"9.8. Get policy value for feature in document"},{"refs":[{"id":"ref-for-document\u2460"}],"title":"9.9. Determine compatibility of value with policy for feature"},{"refs":[{"id":"ref-for-document\u2461"}],"title":"9.10. Determine if value is compatible with policy for feature or report"},{"refs":[{"id":"ref-for-document\u2462"}],"title":"9.11. Determine if value is compatible with policy for feature"}],"url":"https://dom.spec.whatwg.org/#document"},
"87fcd40c": {"dfnID":"87fcd40c","dfnText":"iframe","external":true,"refSections":[{"refs":[{"id":"ref-for-the-iframe-element"}],"title":"7.3. The policy attribute of the iframe element"},{"refs":[{"id":"ref-for-the-iframe-element\u2460"}],"title":"8.1. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"9239678f": {"dfnID":"9239678f","dfnText":"endpoint","external":true,"refSections":[{"refs":[{"id":"ref-for-endpoint"}],"title":"6.1.1. The \"report-to\" parameter"},{"refs":[{"id":"ref-for-endpoint\u2460"},{"id":"ref-for-endpoint\u2461"}],"title":"6.1.2. Setting the default reporting endpoint"},{"refs":[{"id":"ref-for-endpoint\u2462"}],"title":"9.9. Determine compatibility of value with policy for feature"}],"url":"https://w3c.github.io/reporting/#endpoint"},
"a973e0fe": {"dfnID":"a973e0fe","dfnText":"document","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document"},{"id":"ref-for-concept-document\u2460"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-concept-document\u2461"},{"id":"ref-for-concept-document\u2462"}],"title":"8.1. Integration with HTML"}],"url":"https://dom.spec.whatwg.org/#concept-document"},
"aa0ee8c8": {"dfnID":"aa0ee8c8","dfnText":"creating a new browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-creating-a-new-browsing-context"}],"title":"8.1. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-browsing-context"},
"c9e7c11a": {"dfnID":"c9e7c11a","dfnText":"header","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header"},{"id":"ref-for-concept-header\u2460"}],"title":"9.2. Process response policy"}],"url":"https://fetch.spec.whatwg.org/#concept-header"},
"configuration-point": {"dfnID":"configuration-point","dfnText":"configuration point","external":false,"refSections":[{"refs":[{"id":"ref-for-configuration-point"},{"id":"ref-for-configuration-point\u2460"},{"id":"ref-for-configuration-point\u2461"},{"id":"ref-for-configuration-point\u2462"}],"title":"4.1. Configuration Points"},{"refs":[{"id":"ref-for-configuration-point\u2463"},{"id":"ref-for-configuration-point\u2464"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-configuration-point\u2465"},{"id":"ref-for-configuration-point\u2466"}],"title":"7.1. Policies as Structured Headers"},{"refs":[{"id":"ref-for-configuration-point\u2467"},{"id":"ref-for-configuration-point\u2468"},{"id":"ref-for-configuration-point\u2460\u24ea"},{"id":"ref-for-configuration-point\u2460\u2460"},{"id":"ref-for-configuration-point\u2460\u2461"},{"id":"ref-for-configuration-point\u2460\u2462"},{"id":"ref-for-configuration-point\u2460\u2463"}],"title":"7.1.1. Parameters"}],"url":"#configuration-point"},
"configuration-point-default-value": {"dfnID":"configuration-point-default-value","dfnText":"default value","external":false,"refSections":[{"refs":[{"id":"ref-for-configuration-point-default-value"}],"title":"4.1. Configuration Points"},{"refs":[{"id":"ref-for-configuration-point-default-value\u2460"}],"title":"9.8. Get policy value for feature in document"},{"refs":[{"id":"ref-for-configuration-point-default-value\u2461"},{"id":"ref-for-configuration-point-default-value\u2462"}],"title":"9.9. Determine compatibility of value with policy for feature"}],"url":"#configuration-point-default-value"},
"configuration-point-name": {"dfnID":"configuration-point-name","dfnText":"name","external":false,"refSections":[{"refs":[{"id":"ref-for-configuration-point-name"}],"title":"7.1. Policies as Structured Headers"},{"refs":[{"id":"ref-for-configuration-point-name\u2460"}],"title":"9.2. Process response policy"}],"url":"#configuration-point-name"},
"configuration-point-range": {"dfnID":"configuration-point-range","dfnText":"range","external":false,"refSections":[{"refs":[{"id":"ref-for-configuration-point-range"}],"title":"4.1. Configuration Points"},{"refs":[{"id":"ref-for-configuration-point-range\u2460"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-configuration-point-range\u2461"}],"title":"7.1. Policies as Structured Headers"}],"url":"#configuration-point-range"},
"configuration-point-type": {"dfnID":"configuration-point-type","dfnText":"type","external":false,"refSections":[{"refs":[{"id":"ref-for-configuration-point-type"}],"title":"4.1. Configuration Points"}],"url":"#configuration-point-type"},
"create-document-policy": {"dfnID":"create-document-policy","dfnText":"Create a document Policy for a browsing context from response","external":false,"refSections":[{"refs":[{"id":"ref-for-create-document-policy"}],"title":"8.1. Integration with HTML"}],"url":"#create-document-policy"},
"create-for-browsingcontext": {"dfnID":"create-for-browsingcontext","dfnText":"Create a required policy for a browsing context","external":false,"refSections":[{"refs":[{"id":"ref-for-create-for-browsingcontext"}],"title":"8.1. Integration with HTML"},{"refs":[{"id":"ref-for-create-for-browsingcontext\u2460"}],"title":"9.6. Create a document Policy for a browsing context from response"}],"url":"#create-for-browsingcontext"},
"declared-document-policy": {"dfnID":"declared-document-policy","dfnText":"declared document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-declared-document-policy"}],"title":"9.1. Is policy compatible?"},{"refs":[{"id":"ref-for-declared-document-policy\u2460"}],"title":"9.2. Process response policy"}],"url":"#declared-document-policy"},
"determine-compatibility": {"dfnID":"determine-compatibility","dfnText":"Determine compatibility of value with policy for feature","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-compatibility"}],"title":"9.10. Determine if value is compatible with policy for feature or report"},{"refs":[{"id":"ref-for-determine-compatibility\u2460"}],"title":"9.11. Determine if value is compatible with policy for feature"}],"url":"#determine-compatibility"},
"directive-name": {"dfnID":"directive-name","dfnText":"directive name","external":false,"refSections":[{"refs":[{"id":"ref-for-directive-name"}],"title":"7.1. Policies as Structured Headers"},{"refs":[{"id":"ref-for-directive-name\u2460"},{"id":"ref-for-directive-name\u2461"},{"id":"ref-for-directive-name\u2462"},{"id":"ref-for-directive-name\u2463"}],"title":"7.1.1. Parameters"}],"url":"#directive-name"},
"document-policy": {"dfnID":"document-policy","dfnText":"document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-document-policy"},{"id":"ref-for-document-policy\u2460"},{"id":"ref-for-document-policy\u2461"},{"id":"ref-for-document-policy\u2462"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-document-policy\u2463"}],"title":"7.2.1. Document-Policy"},{"refs":[{"id":"ref-for-document-policy\u2464"}],"title":"7.2.4. Sec-Required-Document-Policy"},{"refs":[{"id":"ref-for-document-policy\u2465"}],"title":"8.1. Integration with HTML"},{"refs":[{"id":"ref-for-document-policy\u2466"}],"title":"8.2. Integration with Fetch"},{"refs":[{"id":"ref-for-document-policy\u2467"}],"title":"9.3. Parse document policy"},{"refs":[{"id":"ref-for-document-policy\u2468"}],"title":"9.4. Serialize required policy"},{"refs":[{"id":"ref-for-document-policy\u2460\u24ea"}],"title":"9.5. Create a required policy for a browsing context"},{"refs":[{"id":"ref-for-document-policy\u2460\u2460"}],"title":"9.6. Create a document Policy for a browsing context from response"},{"refs":[{"id":"ref-for-document-policy\u2460\u2461"},{"id":"ref-for-document-policy\u2460\u2462"}],"title":"9.8. Get policy value for feature in document"},{"refs":[{"id":"ref-for-document-policy\u2460\u2463"},{"id":"ref-for-document-policy\u2460\u2464"},{"id":"ref-for-document-policy\u2460\u2465"}],"title":"9.9. Determine compatibility of value with policy for feature"},{"refs":[{"id":"ref-for-document-policy\u2460\u2466"}],"title":"9.10. Determine if value is compatible with policy for feature or report"},{"refs":[{"id":"ref-for-document-policy\u2460\u2467"}],"title":"9.11. Determine if value is compatible with policy for feature"}],"url":"#document-policy"},
"document-policy-directive": {"dfnID":"document-policy-directive","dfnText":"document policy directive","external":false,"refSections":[{"refs":[{"id":"ref-for-document-policy-directive"}],"title":"7.1. Policies as Structured Headers"},{"refs":[{"id":"ref-for-document-policy-directive\u2460"},{"id":"ref-for-document-policy-directive\u2461"},{"id":"ref-for-document-policy-directive\u2462"},{"id":"ref-for-document-policy-directive\u2463"},{"id":"ref-for-document-policy-directive\u2464"}],"title":"7.1.1. Parameters"}],"url":"#document-policy-directive"},
"document-policy-header": {"dfnID":"document-policy-header","dfnText":"Document-Policy","external":false,"refSections":[],"url":"#document-policy-header"},
"document-policy-report-only-header": {"dfnID":"document-policy-report-only-header","dfnText":"Document-Policy-Report-Only","external":false,"refSections":[],"url":"#document-policy-report-only-header"},
"e3201629": {"dfnID":"e3201629","dfnText":"response","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-response"}],"title":"7.2.1. Document-Policy"},{"refs":[{"id":"ref-for-concept-response-response\u2460"}],"title":"7.2.2. Document-Policy-Report-Only"},{"refs":[{"id":"ref-for-concept-response-response\u2461"}],"title":"9.2. Process response policy"},{"refs":[{"id":"ref-for-concept-response-response\u2462"}],"title":"9.6. Create a document Policy for a browsing context from response"},{"refs":[{"id":"ref-for-concept-response-response\u2463"}],"title":"9.7. Should response to request be blocked due to document policy?"}],"url":"https://fetch.spec.whatwg.org/#concept-response-response"},
"f7b00a8b": {"dfnID":"f7b00a8b","dfnText":"header list (for response)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-header-list"},{"id":"ref-for-concept-response-header-list\u2460"}],"title":"9.2. Process response policy"},{"refs":[{"id":"ref-for-concept-response-header-list\u2461"}],"title":"9.7. Should response to request be blocked due to document policy?"}],"url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"fd11cdcd": {"dfnID":"fd11cdcd","dfnText":"quirks mode","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-quirks"}],"title":"8.1. Integration with HTML"}],"url":"https://dom.spec.whatwg.org/#concept-document-quirks"},
"get-and-parse-a-structured-header": {"dfnID":"get-and-parse-a-structured-header","dfnText":"get and parse a structured header","external":false,"refSections":[],"url":"#get-and-parse-a-structured-header"},
"get-policy-value": {"dfnID":"get-policy-value","dfnText":"Get policy value for feature in document","external":false,"refSections":[],"url":"#get-policy-value"},
"is-policy-compatible": {"dfnID":"is-policy-compatible","dfnText":"Is policy compatible","external":false,"refSections":[{"refs":[{"id":"ref-for-is-policy-compatible"}],"title":"9.6. Create a document Policy for a browsing context from response"},{"refs":[{"id":"ref-for-is-policy-compatible"}],"title":"9.7. Should response to request be blocked due to document policy?"}],"url":"#is-policy-compatible"},
"is-value-compatible": {"dfnID":"is-value-compatible","dfnText":"Determine if value is compatible with policy for feature","external":false,"refSections":[],"url":"#is-value-compatible"},
"is-value-compatible-or-report": {"dfnID":"is-value-compatible-or-report","dfnText":"Determine if value is compatible with policy for feature or report","external":false,"refSections":[],"url":"#is-value-compatible-or-report"},
"nested-context-required-document-policy": {"dfnID":"nested-context-required-document-policy","dfnText":"nested context required document\n    policy","external":false,"refSections":[{"refs":[{"id":"ref-for-nested-context-required-document-policy"}],"title":"9.5. Create a required policy for a browsing context"}],"url":"#nested-context-required-document-policy"},
"parse-document-policy": {"dfnID":"parse-document-policy","dfnText":"Parse document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-parse-document-policy"}],"title":"9.2. Process response policy"}],"url":"#parse-document-policy"},
"policy-configuration": {"dfnID":"policy-configuration","dfnText":"policy configuration","external":false,"refSections":[{"refs":[{"id":"ref-for-policy-configuration"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-policy-configuration\u2460"},{"id":"ref-for-policy-configuration\u2461"},{"id":"ref-for-policy-configuration\u2462"},{"id":"ref-for-policy-configuration\u2463"}],"title":"9.3. Parse document policy"}],"url":"#policy-configuration"},
"policy-configuration-reporting-endpoint": {"dfnID":"policy-configuration-reporting-endpoint","dfnText":"reporting endpoint","external":false,"refSections":[{"refs":[{"id":"ref-for-policy-configuration-reporting-endpoint"},{"id":"ref-for-policy-configuration-reporting-endpoint\u2460"},{"id":"ref-for-policy-configuration-reporting-endpoint\u2461"},{"id":"ref-for-policy-configuration-reporting-endpoint\u2462"},{"id":"ref-for-policy-configuration-reporting-endpoint\u2463"},{"id":"ref-for-policy-configuration-reporting-endpoint\u2464"}],"title":"9.3. Parse document policy"}],"url":"#policy-configuration-reporting-endpoint"},
"policy-configuration-value": {"dfnID":"policy-configuration-value","dfnText":"value","external":false,"refSections":[{"refs":[{"id":"ref-for-policy-configuration-value"}],"title":"9.2. Process response policy"},{"refs":[{"id":"ref-for-policy-configuration-value\u2460"},{"id":"ref-for-policy-configuration-value\u2461"},{"id":"ref-for-policy-configuration-value\u2462"},{"id":"ref-for-policy-configuration-value\u2463"}],"title":"9.3. Parse document policy"},{"refs":[{"id":"ref-for-policy-configuration-value\u2464"}],"title":"9.8. Get policy value for feature in document"}],"url":"#policy-configuration-value"},
"policy-value": {"dfnID":"policy-value","dfnText":"policy value","external":false,"refSections":[],"url":"#policy-value"},
"process-response-policy": {"dfnID":"process-response-policy","dfnText":"Process response policy","external":false,"refSections":[{"refs":[{"id":"ref-for-process-response-policy"}],"title":"9.6. Create a document Policy for a browsing context from response"}],"url":"#process-response-policy"},
"report-only-document-policy": {"dfnID":"report-only-document-policy","dfnText":"report-only document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-report-only-document-policy"}],"title":"7.2.2. Document-Policy-Report-Only"},{"refs":[{"id":"ref-for-report-only-document-policy\u2460"},{"id":"ref-for-report-only-document-policy\u2461"}],"title":"9.9. Determine compatibility of value with policy for feature"}],"url":"#report-only-document-policy"},
"request-required-document-policy": {"dfnID":"request-required-document-policy","dfnText":"required document\npolicy","external":false,"refSections":[{"refs":[{"id":"ref-for-request-required-document-policy"},{"id":"ref-for-request-required-document-policy\u2460"}],"title":"8.2. Integration with Fetch"},{"refs":[{"id":"ref-for-request-required-document-policy\u2461"},{"id":"ref-for-request-required-document-policy\u2462"}],"title":"9.7. Should response to request be blocked due to document policy?"}],"url":"#request-required-document-policy"},
"require-document-policy-header": {"dfnID":"require-document-policy-header","dfnText":"Require-Document-Policy","external":false,"refSections":[],"url":"#require-document-policy-header"},
"required-document-policy": {"dfnID":"required-document-policy","dfnText":"required document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-required-document-policy"}],"title":"4.2. Policies"},{"refs":[{"id":"ref-for-required-document-policy\u2460"}],"title":"7.2.3. Require-Document-Policy"},{"refs":[{"id":"ref-for-required-document-policy\u2461"},{"id":"ref-for-required-document-policy\u2462"},{"id":"ref-for-required-document-policy\u2463"},{"id":"ref-for-required-document-policy\u2464"},{"id":"ref-for-required-document-policy\u2465"}],"title":"8.1. Integration with HTML"},{"refs":[{"id":"ref-for-required-document-policy\u2466"}],"title":"9.1. Is policy compatible?"}],"url":"#required-document-policy"},
"sec-required-document-policy-header": {"dfnID":"sec-required-document-policy-header","dfnText":"Sec-Required-Document-Policy","external":false,"refSections":[],"url":"#sec-required-document-policy-header"},
"serialize-required-policy": {"dfnID":"serialize-required-policy","dfnText":"Serialize required policy","external":false,"refSections":[{"refs":[{"id":"ref-for-serialize-required-policy"}],"title":"8.2. Integration with Fetch"}],"url":"#serialize-required-policy"},
"serialized-document-policy": {"dfnID":"serialized-document-policy","dfnText":"serialized","external":false,"refSections":[{"refs":[{"id":"ref-for-serialized-document-policy"}],"title":"7.1. Policies as Structured Headers"},{"refs":[{"id":"ref-for-serialized-document-policy\u2460"}],"title":"8.1. Integration with HTML"}],"url":"#serialized-document-policy"},
"should-response-to-request-be-blocked-due-to-document-policy": {"dfnID":"should-response-to-request-be-blocked-due-to-document-policy","dfnText":"Should response to request be blocked due to document policy","external":false,"refSections":[{"refs":[{"id":"ref-for-should-response-to-request-be-blocked-due-to-document-policy"}],"title":"8.2. Integration with Fetch"}],"url":"#should-response-to-request-be-blocked-due-to-document-policy"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#configuration-point": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"configuration point","type":"dfn","url":"#configuration-point"},
"#configuration-point-default-value": {"export":true,"for_":["configuration point"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"default value","type":"dfn","url":"#configuration-point-default-value"},
"#configuration-point-name": {"export":true,"for_":["configuration point"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"name","type":"dfn","url":"#configuration-point-name"},
"#configuration-point-range": {"export":true,"for_":["configuration point"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"range","type":"dfn","url":"#configuration-point-range"},
"#configuration-point-type": {"export":true,"for_":["configuration point"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"type","type":"dfn","url":"#configuration-point-type"},
"#create-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"create-document-policy","type":"dfn","url":"#create-document-policy"},
"#create-for-browsingcontext": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"create-for-browsingcontext","type":"dfn","url":"#create-for-browsingcontext"},
"#declared-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"declared document policy","type":"dfn","url":"#declared-document-policy"},
"#determine-compatibility": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"determine-compatibility","type":"dfn","url":"#determine-compatibility"},
"#directive-name": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"directive name","type":"dfn","url":"#directive-name"},
"#document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"document policy","type":"dfn","url":"#document-policy"},
"#document-policy-directive": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"document policy directive","type":"dfn","url":"#document-policy-directive"},
"#is-policy-compatible": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"is policy compatible","type":"dfn","url":"#is-policy-compatible"},
"#nested-context-required-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"nested context required document policy","type":"dfn","url":"#nested-context-required-document-policy"},
"#parse-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"parse document policy","type":"dfn","url":"#parse-document-policy"},
"#policy-configuration": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"policy configuration","type":"dfn","url":"#policy-configuration"},
"#policy-configuration-reporting-endpoint": {"export":true,"for_":["policy configuration"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"reporting endpoint","type":"dfn","url":"#policy-configuration-reporting-endpoint"},
"#policy-configuration-value": {"export":true,"for_":["policy configuration"],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"value","type":"dfn","url":"#policy-configuration-value"},
"#process-response-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"process response policy","type":"dfn","url":"#process-response-policy"},
"#report-only-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"report-only document policy","type":"dfn","url":"#report-only-document-policy"},
"#request-required-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"request-required-document-policy","type":"dfn","url":"#request-required-document-policy"},
"#required-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"required document policy","type":"dfn","url":"#required-document-policy"},
"#serialize-required-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"serialize required policy","type":"dfn","url":"#serialize-required-policy"},
"#serialized-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"serialized document policy","type":"dfn","url":"#serialized-document-policy"},
"#should-response-to-request-be-blocked-due-to-document-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"document-policy","spec":"document-policy-1","status":"local","text":"should response to request be blocked due to document policy","type":"dfn","url":"#should-response-to-request-be-blocked-due-to-document-policy"},
"https://dom.spec.whatwg.org/#concept-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"document","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document"},
"https://dom.spec.whatwg.org/#concept-document-content-type": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"content type","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document-content-type"},
"https://dom.spec.whatwg.org/#concept-document-quirks": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"quirks mode","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document-quirks"},
"https://dom.spec.whatwg.org/#document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://dom.spec.whatwg.org/#html-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"html document","type":"dfn","url":"https://dom.spec.whatwg.org/#html-document"},
"https://fetch.spec.whatwg.org/#concept-header": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header"},
"https://fetch.spec.whatwg.org/#concept-headers-header-list": {"export":true,"for_":["Headers"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-headers-header-list"},
"https://fetch.spec.whatwg.org/#concept-request-header-list": {"export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-header-list"},
"https://fetch.spec.whatwg.org/#concept-request-request": {"export":true,"for_":["Request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"request","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-request"},
"https://fetch.spec.whatwg.org/#concept-response-header-list": {"export":true,"for_":["response"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"https://fetch.spec.whatwg.org/#concept-response-response": {"export":true,"for_":["Response"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"response","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response-response"},
"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set": {"export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active sandboxing flag set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-browsing-context": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"creating a new browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-browsing-context"},
"https://html.spec.whatwg.org/multipage/browsers.html#initialise-the-document-object": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"initialise the document object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#initialise-the-document-object"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opener browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#opener-browsing-context"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox": {"export":true,"for_":["iframe"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"sandbox","type":"element-attr","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"iframe","type":"element","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://w3c.github.io/reporting/#endpoint": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"endpoint","type":"dfn","url":"https://w3c.github.io/reporting/#endpoint"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>