<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Client Hints Infrastructure</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <link href="https://wicg.github.io/client-hints-infrastructure" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
table, th, td { border: 1px black solid; }
thead {background-color: yellow; }
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Client Hints Infrastructure</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/client-hints-infrastructure">https://wicg.github.io/client-hints-infrastructure</a>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://blog.yoav.ws">Yoav Weiss</a> (<span class="p-org org">Google</span>) <a class="u-email email" href="mailto:yoav@yoav.ws">yoav@yoav.ws</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 the Contributors to the Client Hints Infrastructure Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Specification of the Client Hints infrastructure and its integration with Fetch and HTML</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#definition"><span class="secno">2</span> <span class="content">Infrastructure definition</span></a>
    <li>
     <a href="#environment-settings-object-processing"><span class="secno">3</span> <span class="content">Environment settings object processing</span></a>
     <ol class="toc">
      <li><a href="#concept-client-hints-set"><span class="secno">3.1</span> <span class="content">Client hints set</span></a>
      <li><a href="#accept-ch-cache-definition"><span class="secno">3.2</span> <span class="content">Accept-CH cache</span></a>
      <li><a href="#initialize-ch-set"><span class="secno">3.3</span> <span class="content">Initialize Client Hints set</span></a>
      <li><a href="#accept-ch-state-algo"><span class="secno">3.4</span> <span class="content"><span>Accept-CH state</span> (<code>http-equiv="accept-ch"</code>)</span></a>
     </ol>
    <li>
     <a href="#html"><span class="secno">4</span> <span class="content">Integration with HTML</span></a>
     <ol class="toc">
      <li><a href="#document-init"><span class="secno">4.1</span> <span class="content">Document object initialization</span></a>
      <li><a href="#worker-init"><span class="secno">4.2</span> <span class="content">Worker initialization</span></a>
      <li><a href="#http-equiv-attributes"><span class="secno">4.3</span> <span class="content">http-equiv attributes</span></a>
      <li><a href="#pragma-directives"><span class="secno">4.4</span> <span class="content">Pragma directives</span></a>
      <li><a href="#extending-environment-settings-object"><span class="secno">4.5</span> <span class="content">Extending environment settings object</span></a>
     </ol>
    <li><a href="#request-processing"><span class="secno">5</span> <span class="content">Request processing</span></a>
    <li><a href="#fetch"><span class="secno">6</span> <span class="content">Integration with Fetch</span></a>
    <li>
     <a href="#registry"><span class="secno">7</span> <span class="content">Feature Registry</span></a>
     <ol class="toc">
      <li><a href="#client-hints-token-definition"><span class="secno">7.1</span> <span class="content">Client hints token</span></a>
      <li><a href="#policy-controlled-features"><span class="secno">7.2</span> <span class="content">Policy-controlled features</span></a>
      <li><a href="#low-entropy-table"><span class="secno">7.3</span> <span class="content">Low entropy hint table</span></a>
      <li><a href="#find-client-hint-value-section"><span class="secno">7.4</span> <span class="content">Find client hint value</span></a>
     </ol>
    <li><a href="#privacy"><span class="secno">8</span> <span class="content">Security and Privacy considerations</span></a>
    <li><a href="#terms"><span class="secno">9</span> <span class="content">Terms</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>Client Hints is collection of HTTP and user-agent features that enables
privacy-preserving, proactive content negotiation with an explicit third-party
delegation mechanism:</p>
   <ul>
    <li data-md>
     <p>Proactive content negotiation at the HTTP layer enables servers to request
delivery of specific hints, in order to enable optimized and automated
selection of resources based on a user’s device, conditions and preferences,
and lets clients decide which hint requests they want to grant, with
per-hint and per-origin granularity.</p>
    <li data-md>
     <p>Integration of said mechanism with web concepts, defined in this document,
enables browsers to benefit from content adaptation, and have it play nicely with
current web restrictions (e.g. same-origin policy).</p>
    <li data-md>
     <p>The opt-in nature of the mechanism enables browsers to advertise requested
hint data (e.g. user agent and device characteristics) selectively to
secure-transport origins, instead of appending such data on every outgoing
request.</p>
    <li data-md>
     <p>Origin opt-in applies to same-origin assets only and delivery to third-party
origins is subject to explicit first party delegation via Permissions Policy,
enabling tight control over which third party origins can access requested
hint data.</p>
   </ul>
   <p>The goal of Client Hints is to <strong>reduce passive fingerprinting</strong> on the web
while <strong>enabling scalable and privacy preserving content adaptation</strong> between
client and server, via a standardized set of content negotiation primitives at
the HTTP and user agent levels.</p>
   <h2 class="heading settled" data-level="2" id="definition"><span class="secno">2. </span><span class="content">Infrastructure definition</span><a class="self-link" href="#definition"></a></h2>
   <p>The specification of the Client Hints <strong>infrastructure</strong> is divided between the
following specifications and proposals:</p>
   <ul>
    <li data-md>
     <p>IETF <a data-link-type="biblio" href="#biblio-rfc8942" title="HTTP Client Hints">[RFC8942]</a></p>
     <ul>
      <li data-md>
       <p>Provides the motivation for Client Hints.</p>
      <li data-md>
       <p>Defines the fundamental Client Hints infrastructure:</p>
       <ul>
        <li data-md>
         <p>The <code>Accept-CH</code> response header, which servers may use to advertise
support for certain Client Hints.</p>
       </ul>
      <li data-md>
       <p>Provides both general guidelines, and formal requirements, about Client
 Hints’ impact on caching, security, and privacy.</p>
      <li data-md>
       <p>Does <em>not</em> define any actual, particular hints – or say anything about how
 Client Hints works in web contexts.</p>
     </ul>
    <li data-md>
     <p>Client Hints infrastructure - this document</p>
     <ul>
      <li data-md>
       <p>Defines how web clients should process the <code>Accept-CH</code> headers sent by servers.</p>
      <li data-md>
       <p>Defines the environment settings object state related to <code>Accept-CH</code>,
 which stores information about which servers should get which hints.</p>
      <li data-md>
       <p>Defines how, and when, web clients should actually go about sending hints,
 based on the state of their environment settings object.</p>
       <ul>
        <li data-md>
         <p>More specifically, it integrates the HTML web concepts with Fetch’s
algorithms to make sure that opted-in hints are added to requests for
same-origin or delegated-to cross-origin requests. It also makes sure
hints are removed from not delegated-to cross-origin requests after
redirections.</p>
       </ul>
      <li data-md>
       <p>Integrates those concepts with the <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> and <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> specifications,
  by patching various concepts there.</p>
     </ul>
    <li data-md>
     <p>W3C Permissions Policy specification (<a href="https://w3c.github.io/webappsec-permissions-policy/#should-request-be-allowed-to-use-feature">relevant section</a>)</p>
     <ul>
      <li data-md>
       <p>In order to perform third party Client Hint delegation, Permissions Policy has
 been extended to control features within fetch requests (rather than just Documents).</p>
     </ul>
   </ul>
   <h2 class="heading settled" data-level="3" id="environment-settings-object-processing"><span class="secno">3. </span><span class="content">Environment settings object processing</span><a class="self-link" href="#environment-settings-object-processing"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="concept-client-hints-set"><span class="secno">3.1. </span><span class="content">Client hints set</span><a class="self-link" href="#concept-client-hints-set"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="client-hints-set">client hints set</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-set" id="ref-for-ordered-set">set</a> of <a data-link-type="dfn" href="#client-hints-token" id="ref-for-client-hints-token">client hints token</a>s. </p>
   <h3 class="heading settled" data-level="3.2" id="accept-ch-cache-definition"><span class="secno">3.2. </span><span class="content">Accept-CH cache</span><a class="self-link" href="#accept-ch-cache-definition"></a></h3>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="accept-ch-cache">Accept-CH cache</dfn> is owned by the user agent and is an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">ordered map</a>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-key" id="ref-for-map-key">keyed</a> on <dfn class="dfn-paneled" data-dfn-for="accept-ch-cache" data-dfn-type="dfn" data-noexport id="accept-ch-cache-origin">origin</dfn> (an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a>),
  with a value of <dfn class="dfn-paneled" data-dfn-for="accept-ch-cache" data-dfn-type="dfn" data-noexport id="accept-ch-cache-client-hints-set">client hints set</dfn> (a <a data-link-type="dfn" href="#client-hints-set" id="ref-for-client-hints-set">client hints set</a>).</p>
   <p>The Accept-CH cache can effectively act as an alternative cookie store,
since sites can use each of the hints as a bit set on the client, and that information will be
communicated to them on every request. As such, a user agent MUST evict that
cache whenever the user clears their cookies or when session cookies expire.</p>
   <p class="note" role="note"><span class="marker">Note:</span> A site can clear the browser’s <code>Accept-CH</code> cache for its origin by sending an empty <code>Accept-CH</code> header in a response. This sets the origin’s <var>client hints set</var> to an empty set.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="add-a-new-accept-ch-cache-entry">add a new Accept-CH cache entry</dfn> to the <a data-link-type="dfn" href="#accept-ch-cache" id="ref-for-accept-ch-cache">Accept-CH cache</a>,
given an <a data-link-type="dfn" href="#accept-ch-cache-origin" id="ref-for-accept-ch-cache-origin">origin</a> <var>origin</var> and a <a data-link-type="dfn" href="#client-hints-set" id="ref-for-client-hints-set①">client hints set</a> <var>client hints set</var>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set">set</a> <a data-link-type="dfn" href="#accept-ch-cache" id="ref-for-accept-ch-cache①">Accept-CH cache</a>[<var>origin</var>] to <var>client hints set</var>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="retrieve-the-client-hints-set">retrieve the client hints set</dfn> given an <var>origin</var>:</p>
   <ol>
    <li data-md>
     <p>Let <var>clientHintsSet</var> be an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-set" id="ref-for-ordered-set①">ordered set</a>.</p>
    <li data-md>
     <p>Let <var>originMatchingEntries</var> be the entries in the <a data-link-type="dfn" href="#accept-ch-cache" id="ref-for-accept-ch-cache②">Accept-CH cache</a> whose <a data-link-type="dfn" href="#accept-ch-cache-origin" id="ref-for-accept-ch-cache-origin①">origin</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin">same origin</a> with <var>origin</var>.</p>
    <li data-md>
     <p>For each entry in <var>originMatchingEntries</var>, for each token in its <a data-link-type="dfn" href="#accept-ch-cache-client-hints-set" id="ref-for-accept-ch-cache-client-hints-set">client hints set</a>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#set-append" id="ref-for-set-append">append</a> the token to <var>clientHintsSet</var>.</p>
    <li data-md>
     <p>Return <var>clientHintsSet</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="3.3" id="initialize-ch-set"><span class="secno">3.3. </span><span class="content">Initialize Client Hints set</span><a class="self-link" href="#initialize-ch-set"></a></h3>
    When asked to <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-initialize-the-client-hints-set">initialize the Client Hints set</dfn> with <var>settingsObject</var> and <var>response</var> as inputs, run the following steps: 
   <ol>
    <li data-md>
     <p>Let <var>clientHintsSet</var> be the result of running <a data-link-type="dfn" href="#retrieve-the-client-hints-set" id="ref-for-retrieve-the-client-hints-set">retrieve the client hints set</a> with <var>settingsObject</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin">origin</a>.</p>
    <li data-md>
     <p>For each <var>hint</var> in <var>clientHintsSet</var>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#set-append" id="ref-for-set-append①">append</a> <var>hint</var> to <var>settingsObject</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set">client hints set</a>.</p>
    <li data-md>
     <p>If the result of executing <a data-link-type="abstract-op">Is an environment settings object contextually secure?</a> on <var>settingsObject</var> is <code>"Not Secure"</code>, abort these steps.</p>
    <li data-md>
     <p>Let <var>browsingContext</var> be <var>settingsObject</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global" id="ref-for-concept-settings-object-global">global object</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc" id="ref-for-window-bc">browsing context</a>.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context">top-level browsing context</a> does not equal <var>browsingContext</var>, abort these steps.</p>
    <li data-md>
     <p>If <var>response</var>’s <code>Accept-CH</code> header is present, parse the header field value according to the <code>Accept-CH</code> header parsing rules, as a <a data-link-type="dfn" href="#field-name" id="ref-for-field-name">field-name</a>. Add each parsed <a data-link-type="dfn" href="#client-hints-token" id="ref-for-client-hints-token①">client hints token</a> to <var>settingsObject</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set①">client hints set</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#add-a-new-accept-ch-cache-entry" id="ref-for-add-a-new-accept-ch-cache-entry">Add a new Accept-CH cache entry</a> with <var>response</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①">origin</a> and <var>settingsObject</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set②">client hints set</a> as inputs.</p>
   </ol>
   <div class="note" role="note">
     Note, the above algorithm: 
    <ul>
     <li data-md>
      <p>Initializes client hints set on the environment settings object based on its origin.</p>
     <li data-md>
      <p>If we are in a secure context and the navigation is a top-level navigation,
it parses <code>Accept-CH</code> and adds the results to the environment setting object’s client hints set as well as the Accept-CH cache.</p>
    </ul>
   </div>
   <h3 class="heading settled" data-level="3.4" id="accept-ch-state-algo"><span class="secno">3.4. </span><span class="content"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="accept-ch-state">Accept-CH state</dfn> (<code>http-equiv="accept-ch"</code>)</span><a class="self-link" href="#accept-ch-state-algo"></a></h3>
   <p class="note" role="note"><span class="marker">Note:</span> This pragma <em>appends</em> <a data-link-type="dfn" href="#client-hints-token" id="ref-for-client-hints-token②">client hints token</a>s to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a>'s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set③">client hints set</a>. It <em>does not</em> add those hints to the <a data-link-type="dfn" href="#accept-ch-cache" id="ref-for-accept-ch-cache③">Accept-CH cache</a>.</p>
   <ol>
    <li data-md>
     <p>If the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#meta" id="ref-for-meta">meta</a></code> element is not a child of a <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#the-head-element" id="ref-for-the-head-element">head</a></code> element, then return.</p>
    <li data-md>
     <p>If the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#meta" id="ref-for-meta①">meta</a></code> element has no <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/semantics.html#attr-meta-content" id="ref-for-attr-meta-content">content</a></code> attribute, or if that attribute’s value is the empty string, then return.</p>
    <li data-md>
     <p>Let <var>settingsObject</var> be the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#meta" id="ref-for-meta②">meta</a></code> element’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a>.</p>
    <li data-md>
     <p>If the result of executing <a data-link-type="abstract-op">Is an environment settings object contextually secure?</a> on <var>settingsObject</var> is <code>"Not Secure"</code>, then return.</p>
    <li data-md>
     <p>Let <var>browsingContext</var> be <var>settingsObject</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global" id="ref-for-concept-settings-object-global①">global object</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc" id="ref-for-window-bc①">browsing context</a>.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context①">top-level browsing context</a> does not equal <var>browsingContext</var>, abort these steps.</p>
    <li data-md>
     <p>Let <var>acceptCHValue</var> be the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/semantics.html#meta" id="ref-for-meta③">meta</a></code> element’s <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/semantics.html#attr-meta-content" id="ref-for-attr-meta-content①">content</a></code> attribute’s value.</p>
    <li data-md>
     <p>Parse <var>acceptCHValue</var> according to the <a data-link-type="dfn" href="#accept-ch" id="ref-for-accept-ch">Accept-CH</a> header parsing rules, as a <a data-link-type="dfn" href="#field-name" id="ref-for-field-name①">field-name</a>. <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#set-append" id="ref-for-set-append②">Append</a> each parsed <a data-link-type="dfn" href="#client-hints-token" id="ref-for-client-hints-token③">client hints token</a> to <var>settingsObject</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set④">client hints set</a>.</p>
   </ol>
   <h2 class="heading settled" data-level="4" id="html"><span class="secno">4. </span><span class="content">Integration with HTML</span><a class="self-link" href="#html"></a></h2>
   <p>This specification integrates with the <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> specification by patching the algorithms below:</p>
   <h3 class="heading settled" data-level="4.1" id="document-init"><span class="secno">4.1. </span><span class="content">Document object initialization</span><a class="self-link" href="#document-init"></a></h3>
   <p>At <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#initialise-the-document-object">Create and initialize a Document object</a>,
after step 11, starting with "Initialize a Document’s CSP list",
call <a data-link-type="abstract-op" href="#abstract-opdef-initialize-the-client-hints-set" id="ref-for-abstract-opdef-initialize-the-client-hints-set">initialize the Client Hints set</a> with <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object①">relevant settings object</a> and <var>response</var> as inputs.</p>
   <h3 class="heading settled" data-level="4.2" id="worker-init"><span class="secno">4.2. </span><span class="content">Worker initialization</span><a class="self-link" href="#worker-init"></a></h3>
    At <a href="https://html.spec.whatwg.org/multipage/workers.html#set-up-a-worker-environment-settings-object">set up a worker environment settings object</a>,
after step 6, add the following step: 
   <ol>
    <li data-md>
     <p>Set <var>settingsObject</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set⑤">client hints set</a> to be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-clone" id="ref-for-list-clone">clone</a> of <var>outside settings</var>’ <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set⑥">client hints set</a>.</p>
   </ol>
   <h3 class="heading settled" data-level="4.3" id="http-equiv-attributes"><span class="secno">4.3. </span><span class="content">http-equiv attributes</span><a class="self-link" href="#http-equiv-attributes"></a></h3>
   <div class="non-normative">
     <em>This section is non-normative.</em> 
    <p>In the table on <a href="https://html.spec.whatwg.org/multipage/#attributes-3">attributes</a>, add "accept-ch" in the line which attribute is "http-equiv".</p>
   </div>
   <h3 class="heading settled" data-level="4.4" id="pragma-directives"><span class="secno">4.4. </span><span class="content">Pragma directives</span><a class="self-link" href="#pragma-directives"></a></h3>
    For the table in <a href="https://html.spec.whatwg.org/multipage/#pragma-directives">pragma directives</a>,
add a line with a "State" value of <a data-link-type="dfn" href="#accept-ch-state" id="ref-for-accept-ch-state">Accept-CH</a> and a "Keyword" value of <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="accept-ch">accept-ch</dfn>. 
   <h3 class="heading settled" data-level="4.5" id="extending-environment-settings-object"><span class="secno">4.5. </span><span class="content">Extending environment settings object</span><a class="self-link" href="#extending-environment-settings-object"></a></h3>
   <p>An <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object①">environment settings object</a> has a <dfn class="dfn-paneled" data-dfn-for="environment settings object" data-dfn-type="dfn" data-noexport id="environment-settings-object-client-hints-set">client hints set</dfn>: a <a data-link-type="dfn" href="#client-hints-set" id="ref-for-client-hints-set②">client hints set</a>, initially the empty set, used for <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch">fetches</a> performed using the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object②">environment settings object</a> as a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-request" id="ref-for-concept-request-request">request</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a>.</p>
   <h2 class="heading settled" data-level="5" id="request-processing"><span class="secno">5. </span><span class="content">Request processing</span><a class="self-link" href="#request-processing"></a></h2>
   <p>When asked to <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-append-client-hints-to-request">append client hints to request</dfn> with <var>request</var> as input, run the following steps:</p>
   <p>For each <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header">header</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-name" id="ref-for-concept-header-name">name</a> (<var>hintName</var>) in the registry’s <a data-link-type="dfn" href="#low-entropy-hint-table" id="ref-for-low-entropy-hint-table">low entropy hint table</a>,
if <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains">does not contain</a> <var>hintName</var>, then <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-append" id="ref-for-concept-header-list-append">append</a> <var>hintName</var>/the corresponding value to <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list①">header list</a>. </p>
   <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client①">client</a> is not null,
  then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">for each</a> <a data-link-type="dfn" href="#client-hints-token" id="ref-for-client-hints-token④">client hints token</a> <var>hintName</var> of <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client②">client</a>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set⑦">client hints set</a>: </p>
   <ol>
    <li>
     <p>Let <var>value</var> be the return value of running <a data-link-type="dfn" href="#find-client-hint-value" id="ref-for-find-client-hint-value">find client hint value</a>, given <var>hintName</var> as input. </p>
    <li>
     <p>If <var>request</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#subresource-request" id="ref-for-subresource-request">subresource request</a> and the result of running <a href="https://w3c.github.io/webappsec-permissions-policy/#algo-should-request-be-allowed-to-use-feature">Should request be allowed to use feature?</a>,
   given <var>request</var> and <var>hintName</var>’s <a href="#policy-controlled-features">associated policy-controlled feature</a>, returns <code>false</code>, then skip the next steps and continue to the next <var>hintName</var>. <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a> </p>
    <li>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list②">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains①">does not
  contain</a> <var>hintName</var>, a user agent should <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-append" id="ref-for-concept-header-list-append①">append</a> <var>hintName</var>/<var>value</var> to <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list③">header list</a>. </p>
   </ol>
   <p>When asked to <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-remove-client-hints-from-redirect-if-needed">remove client hints from redirect if needed</dfn> with <var>request</var> as input, run the following steps:</p>
   <ol>
    <li>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client③">client</a> is null, then abort these steps. 
    <li>Let <var>clientHintsSet</var> be <var>request</var>’s <var>client</var>’s <a data-link-type="dfn" href="#environment-settings-object-client-hints-set" id="ref-for-environment-settings-object-client-hints-set⑧">client hints set</a>. 
    <li>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate①">For each</a> <var>hintName</var> of <var>clientHintsSet</var>: </p>
     <ol>
      <li>
       <p>Set <var>hintName</var> to "Sec-" concatenated with <var>hintName</var>. </p>
      <li>
       <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list④">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains②">contains</a> <var>hintName</var> and if the result of running <a href="https://w3c.github.io/webappsec-permissions-policy/#algo-should-request-be-allowed-to-use-feature">Should
  request be allowed to use feature?</a>, given <var>request</var> and <var>hintName</var>’s <a href="#policy-controlled-features">associated
  policy-controlled feature</a>, returns <code>false</code>, then remove <var>hintName</var> from <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list⑤">header list</a>. <a data-link-type="biblio" href="#biblio-permissions-policy" title="Permissions Policy">[PERMISSIONS-POLICY]</a> </p>
     </ol>
   </ol>
   <h2 class="heading settled" data-level="6" id="fetch"><span class="secno">6. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#fetch"></a></h2>
   <p>This specification integrates with the <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> specification by patching the algorithms below:</p>
   <p>In <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch①">Fetching</a>, after step 1.6, run <a data-link-type="abstract-op" href="#abstract-opdef-append-client-hints-to-request" id="ref-for-abstract-opdef-append-client-hints-to-request">append client hints to request</a> with <var>request</var> as input.</p>
   <p>In <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-redirect-fetch" id="ref-for-concept-http-redirect-fetch">HTTP-redirect fetch</a>, after step 7, run <a data-link-type="abstract-op" href="#abstract-opdef-remove-client-hints-from-redirect-if-needed" id="ref-for-abstract-opdef-remove-client-hints-from-redirect-if-needed">remove client hints from redirect if needed</a> with <var>request</var> as input.</p>
   <h2 class="heading settled" data-level="7" id="registry"><span class="secno">7. </span><span class="content">Feature Registry</span><a class="self-link" href="#registry"></a></h2>
   <p class="note" role="note"><span class="marker">Note:</span> This section contains feature-specific definitions.
  New features that rely on the Client Hints infrastructure need to add their respective definitions to this registry.
  User Agents can implement some of those features without implementing others.</p>
   <h3 class="heading settled" data-level="7.1" id="client-hints-token-definition"><span class="secno">7.1. </span><span class="content">Client hints token</span><a class="self-link" href="#client-hints-token-definition"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="client-hints-token">client hints token</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-lowercase" id="ref-for-byte-lowercase">byte-lowercase</a> representation of one of <code>Save-Data</code>, <code>DPR</code>, <code>Width</code>, <code>Viewport-Width</code>, <code>Viewport-Height</code>, <code>Device-Memory</code>, <code>RTT</code>, <code>Downlink</code>, <code>ECT</code>, <code>Sec-CH-UA-Arch</code>, <code>Sec-CH-UA-Bitness</code>, <code>Sec-CH-UA-Model</code>, <code>Sec-CH-UA-Platform</code>, <code>Sec-CH-UA-Platform-Version</code>, <code>Sec-CH-UA</code> or <code>Sec-CH-UA-Mobile</code>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> A client hints token will also match the request header sent by the user agent when
appropriate (as determined by the <a href="#request-processing">request processing algorithm</a>).</p>
   <h3 class="heading settled" data-level="7.2" id="policy-controlled-features"><span class="secno">7.2. </span><span class="content">Policy-controlled features</span><a class="self-link" href="#policy-controlled-features"></a></h3>
   <p>This document defines <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="policy-controlled-client-hints-features">policy-controlled client hints features</dfn>,
the following <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature">policy-controlled features</a>:</p>
   <ul>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-save-data">ch-save-data</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist">default allowlist</a> of <code>'*'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-dpr">ch-dpr</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-width">ch-width</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist②">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-viewport-width">ch-viewport-width</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist③">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-viewport-height">ch-viewport-height</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist④">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-device-memory">ch-device-memory</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist⑤">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-rtt">ch-rtt</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist⑥">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-downlink">ch-downlink</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist⑦">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ect">ch-ect</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist⑧">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-arch">ch-ua-arch</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist⑨">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-bitness">ch-ua-bitness</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①⓪">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-model">ch-ua-model</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①①">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-platform">ch-ua-platform</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①②">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-platform-version">ch-ua-platform-version</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①③">default allowlist</a> of <code>'self'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua">ch-ua</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①④">default allowlist</a> of <code>'*'</code></p>
    <li data-md>
     <p><code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="ch-ua-mobile">ch-ua-mobile</dfn></code> which has a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist①⑤">default allowlist</a> of <code>'*'</code></p>
   </ul>
   <p class="issue" id="issue-0277eb34"><a class="self-link" href="#issue-0277eb34"></a> Should we tie low-entropy-ness to allowlists, generally?</p>
   <h3 class="heading settled" data-level="7.3" id="low-entropy-table"><span class="secno">7.3. </span><span class="content">Low entropy hint table</span><a class="self-link" href="#low-entropy-table"></a></h3>
    The <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="low-entropy-hint-table">low entropy hint table</dfn> below defines hints that are only exposing low amounts of entropy. 
   <table>
    <thead>
     <tr>
      <th><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-name" id="ref-for-concept-header-name①">Name</a> 
      <th><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-value" id="ref-for-concept-header-value">Value</a> 
    <tbody>
     <tr>
      <td><code>Save-Data</code> 
      <td>a suitable <a href="https://wicg.github.io/savedata/#save-data-request-header-field">Save-Data value</a> 
     <tr>
      <td><code>Sec-CH-UA</code> 
      <td>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua">UA value</a> 
     <tr>
      <td><code>Sec-CH-UA-Mobile</code> 
      <td>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-mobile">Mobile value</a> 
     <tr>
      <td><code>Sec-CH-UA-Platform</code> 
      <td>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-platform">Platform value</a> 
   </table>
   <h3 class="heading settled" data-level="7.4" id="find-client-hint-value-section"><span class="secno">7.4. </span><span class="content">Find client hint value</span><a class="self-link" href="#find-client-hint-value-section"></a></h3>
   <p>When asked to <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="find-client-hint-value">find client hint value</dfn>, given <var>hint</var> as input, switch on <var>hint</var> and return the result:</p>
   <dl class="switch">
    <dt><code>Save-Data</code> 
    <dd>a suitable <a href="https://wicg.github.io/savedata/#save-data-request-header-field">Save-Data value</a> 
    <dt><code>DPR</code> 
    <dd>a suitable <a href>DPR value</a> 
    <dt><code>Viewport-Width</code> 
    <dd>a suitable <a href>Viewport-Width value</a> 
    <dt><code>Viewport-Height</code> 
    <dd>a suitable <a href>Viewport-Height value</a> 
    <dt><code>Width</code> 
    <dd>a suitable <a href>Width value</a> 
    <dt><code>Device-Memory</code> 
    <dd>a suitable <a href="https://w3c.github.io/device-memory/#sec-device-memory-client-hint-header">Device-Memory value</a> 
    <dt><code>RTT</code> 
    <dd>a suitable <a href="https://wicg.github.io/netinfo/#rtt-request-header-field">RTT value</a> 
    <dt><code>Downlink</code> 
    <dd>a suitable <a href="https://wicg.github.io/netinfo/#downlink-request-header-field">Downlink value</a> 
    <dt><code>ECT</code> 
    <dd>a suitable <a href="https://wicg.github.io/netinfo/#ect-request-header-field">ECT value</a> 
    <dt><code>UA-Arch</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-arch">Arch value</a> 
    <dt><code>UA-Bitness</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-bitness">Bitness value</a> 
    <dt><code>UA-Model</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-model">Model value</a> 
    <dt><code>UA-Platform</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-platform">Platform value</a> 
    <dt><code>UA-Platform Version</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-platform-version">Platform-Version value</a> 
    <dt><code>UA</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua">UA value</a> 
    <dt><code>UA-Mobile</code> 
    <dd>a suitable <a href="https://wicg.github.io/ua-client-hints/#sec-ch-ua-mobile">Mobile value</a> 
   </dl>
   <p class="issue" id="issue-707decdc"><a class="self-link" href="#issue-707decdc"></a> Links for image features are broken, need to actually define that and link to them.</p>
   <h2 class="heading settled" data-level="8" id="privacy"><span class="secno">8. </span><span class="content">Security and Privacy considerations</span><a class="self-link" href="#privacy"></a></h2>
    See <a data-link-type="biblio" href="#biblio-rfc8942" title="HTTP Client Hints">[RFC8942]</a>. 
   <h2 class="heading settled" data-level="9" id="terms"><span class="secno">9. </span><span class="content">Terms</span><a class="self-link" href="#terms"></a></h2>
   <p>The following terms are defined in the HTTP specifications: <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport href="https://tools.ietf.org/html/rfc7230#section-3.2" id="field-name">field-name</dfn></p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#accept-ch">accept-ch</a><span>, in § 4.4</span>
   <li><a href="#accept-ch-cache">Accept-CH cache</a><span>, in § 3.2</span>
   <li><a href="#accept-ch-state">Accept-CH state</a><span>, in § 3.4</span>
   <li><a href="#add-a-new-accept-ch-cache-entry">add a new Accept-CH cache entry</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-append-client-hints-to-request">append client hints to request</a><span>, in § 5</span>
   <li><a href="#ch-device-memory">ch-device-memory</a><span>, in § 7.2</span>
   <li><a href="#ch-downlink">ch-downlink</a><span>, in § 7.2</span>
   <li><a href="#ch-dpr">ch-dpr</a><span>, in § 7.2</span>
   <li><a href="#ch-ect">ch-ect</a><span>, in § 7.2</span>
   <li><a href="#ch-rtt">ch-rtt</a><span>, in § 7.2</span>
   <li><a href="#ch-save-data">ch-save-data</a><span>, in § 7.2</span>
   <li><a href="#ch-ua">ch-ua</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-arch">ch-ua-arch</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-bitness">ch-ua-bitness</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-mobile">ch-ua-mobile</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-model">ch-ua-model</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-platform">ch-ua-platform</a><span>, in § 7.2</span>
   <li><a href="#ch-ua-platform-version">ch-ua-platform-version</a><span>, in § 7.2</span>
   <li><a href="#ch-viewport-height">ch-viewport-height</a><span>, in § 7.2</span>
   <li><a href="#ch-viewport-width">ch-viewport-width</a><span>, in § 7.2</span>
   <li><a href="#ch-width">ch-width</a><span>, in § 7.2</span>
   <li>
    client hints set
    <ul>
     <li><a href="#client-hints-set">definition of</a><span>, in § 3.1</span>
     <li><a href="#accept-ch-cache-client-hints-set">dfn for accept-ch-cache</a><span>, in § 3.2</span>
     <li><a href="#environment-settings-object-client-hints-set">dfn for environment settings object</a><span>, in § 4.5</span>
    </ul>
   <li><a href="#client-hints-token">client hints token</a><span>, in § 7.1</span>
   <li><a href="#field-name">field-name</a><span>, in § 9</span>
   <li><a href="#find-client-hint-value">find client hint value</a><span>, in § 7.4</span>
   <li><a href="#abstract-opdef-initialize-the-client-hints-set">initialize the Client Hints set</a><span>, in § 3.3</span>
   <li><a href="#low-entropy-hint-table">low entropy hint table</a><span>, in § 7.3</span>
   <li><a href="#accept-ch-cache-origin">origin</a><span>, in § 3.2</span>
   <li><a href="#policy-controlled-client-hints-features">policy-controlled client hints features</a><span>, in § 7.2</span>
   <li><a href="#abstract-opdef-remove-client-hints-from-redirect-if-needed">remove client hints from redirect if needed</a><span>, in § 5</span>
   <li><a href="#retrieve-the-client-hints-set">retrieve the client hints set</a><span>, in § 3.2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a6a8ec88">append</span>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="d5434eef">contains</span>
     <li><span class="dfn-paneled" id="1ca75be9">does not contain</span>
     <li><span class="dfn-paneled" id="a33db89a">fetch</span>
     <li><span class="dfn-paneled" id="c9e7c11a">header</span>
     <li><span class="dfn-paneled" id="6ee0eab1">header list</span>
     <li><span class="dfn-paneled" id="8acee9c8">http-redirect fetch</span>
     <li><span class="dfn-paneled" id="4b84a0bc">name</span>
     <li><span class="dfn-paneled" id="162d2b51">request</span>
     <li><span class="dfn-paneled" id="839611db">subresource request</span>
     <li><span class="dfn-paneled" id="8a608b90">value</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="6d88ab2e">browsing context</span>
     <li><span class="dfn-paneled" id="5a88c1c3">content</span>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="8a30477b">global object</span>
     <li><span class="dfn-paneled" id="273ad187">head</span>
     <li><span class="dfn-paneled" id="64b89595">meta</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="43ac8374">origin <small>(for environment settings object)</small></span>
     <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="ae2a6342">top-level browsing context</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a3b18719">append</span>
     <li><span class="dfn-paneled" id="7838e1c1">byte-lowercase</span>
     <li><span class="dfn-paneled" id="027e3e49">clone</span>
     <li><span class="dfn-paneled" id="16d07e10">for each</span>
     <li><span class="dfn-paneled" id="d14a6f26">key</span>
     <li><span class="dfn-paneled" id="84b454ff">ordered map</span>
     <li><span class="dfn-paneled" id="692595fe">ordered set</span>
     <li><span class="dfn-paneled" id="15e48c39">set</span>
     <li><span class="dfn-paneled" id="0e6b2056">set <small>(for map)</small></span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1570624a">default allowlist</span>
     <li><span class="dfn-paneled" id="cc890cc1">policy-controlled feature</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions-policy">[PERMISSIONS-POLICY]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-permissions-policy-1">[PERMISSIONS-POLICY-1]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc8942">[RFC8942]
   <dd>I. Grigorik; Y. Weiss. <a href="https://www.rfc-editor.org/rfc/rfc8942"><cite>HTTP Client Hints</cite></a>. February 2021. Experimental. URL: <a href="https://www.rfc-editor.org/rfc/rfc8942">https://www.rfc-editor.org/rfc/rfc8942</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Should we tie low-entropy-ness to allowlists, generally? <a class="issue-return" href="#issue-0277eb34" title="Jump to section">↵</a></div>
   <div class="issue"> Links for image features are broken, need to actually define that and link to them. <a class="issue-return" href="#issue-707decdc" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"027e3e49": {"dfnID":"027e3e49","dfnText":"clone","external":true,"refSections":[{"refs":[{"id":"ref-for-list-clone"}],"title":"4.2. Worker initialization"}],"url":"https://infra.spec.whatwg.org/#list-clone"},
"086e3aff": {"dfnID":"086e3aff","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"3.2. Accept-CH cache"},{"refs":[{"id":"ref-for-concept-origin\u2460"}],"title":"3.3. Initialize Client Hints set"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"0e6b2056": {"dfnID":"0e6b2056","dfnText":"set (for map)","external":true,"refSections":[{"refs":[{"id":"ref-for-map-set"}],"title":"3.2. Accept-CH cache"}],"url":"https://infra.spec.whatwg.org/#map-set"},
"1570624a": {"dfnID":"1570624a","dfnText":"default allowlist","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature-default-allowlist"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2461"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2462"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2463"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2464"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2465"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2466"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2467"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2468"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u24ea"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u2460"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u2461"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u2462"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u2463"},{"id":"ref-for-policy-controlled-feature-default-allowlist\u2460\u2464"}],"title":"7.2. Policy-controlled features"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"15e48c39": {"dfnID":"15e48c39","dfnText":"set","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-set"}],"title":"3.1. Client hints set"},{"refs":[{"id":"ref-for-ordered-set\u2460"}],"title":"3.2. Accept-CH cache"}],"url":"https://infra.spec.whatwg.org/#ordered-set"},
"162d2b51": {"dfnID":"162d2b51","dfnText":"request","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-request"}],"title":"4.5. Extending environment settings object"}],"url":"https://fetch.spec.whatwg.org/#concept-request-request"},
"16d07e10": {"dfnID":"16d07e10","dfnText":"for each","external":true,"refSections":[{"refs":[{"id":"ref-for-list-iterate"},{"id":"ref-for-list-iterate\u2460"}],"title":"5. Request processing"}],"url":"https://infra.spec.whatwg.org/#list-iterate"},
"1ca75be9": {"dfnID":"1ca75be9","dfnText":"does not contain","external":true,"refSections":[{"refs":[{"id":"ref-for-header-list-contains"},{"id":"ref-for-header-list-contains\u2460"},{"id":"ref-for-header-list-contains\u2461"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#header-list-contains"},
"273ad187": {"dfnID":"273ad187","dfnText":"head","external":true,"refSections":[{"refs":[{"id":"ref-for-the-head-element"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/semantics.html#the-head-element"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"},{"refs":[{"id":"ref-for-environment-settings-object\u2460"},{"id":"ref-for-environment-settings-object\u2461"}],"title":"4.5. Extending environment settings object"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"43ac8374": {"dfnID":"43ac8374","dfnText":"origin (for environment settings object)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-origin"}],"title":"3.3. Initialize Client Hints set"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"4b84a0bc": {"dfnID":"4b84a0bc","dfnText":"name","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header-name"}],"title":"5. Request processing"},{"refs":[{"id":"ref-for-concept-header-name\u2460"}],"title":"7.3. Low entropy hint table"}],"url":"https://fetch.spec.whatwg.org/#concept-header-name"},
"5a88c1c3": {"dfnID":"5a88c1c3","dfnText":"content","external":true,"refSections":[{"refs":[{"id":"ref-for-attr-meta-content"},{"id":"ref-for-attr-meta-content\u2460"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/semantics.html#attr-meta-content"},
"64b89595": {"dfnID":"64b89595","dfnText":"meta","external":true,"refSections":[{"refs":[{"id":"ref-for-meta"},{"id":"ref-for-meta\u2460"},{"id":"ref-for-meta\u2461"},{"id":"ref-for-meta\u2462"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/semantics.html#meta"},
"692595fe": {"dfnID":"692595fe","dfnText":"ordered set","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-set"}],"title":"3.1. Client hints set"},{"refs":[{"id":"ref-for-ordered-set\u2460"}],"title":"3.2. Accept-CH cache"}],"url":"https://infra.spec.whatwg.org/#ordered-set"},
"6d88ab2e": {"dfnID":"6d88ab2e","dfnText":"browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-window-bc"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-window-bc\u2460"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc"},
"6ee0eab1": {"dfnID":"6ee0eab1","dfnText":"header list","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-header-list"},{"id":"ref-for-concept-request-header-list\u2460"},{"id":"ref-for-concept-request-header-list\u2461"},{"id":"ref-for-concept-request-header-list\u2462"},{"id":"ref-for-concept-request-header-list\u2463"},{"id":"ref-for-concept-request-header-list\u2464"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#concept-request-header-list"},
"7393da89": {"dfnID":"7393da89","dfnText":"same origin","external":true,"refSections":[{"refs":[{"id":"ref-for-same-origin"}],"title":"3.2. Accept-CH cache"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"7838e1c1": {"dfnID":"7838e1c1","dfnText":"byte-lowercase","external":true,"refSections":[{"refs":[{"id":"ref-for-byte-lowercase"}],"title":"7.1. Client hints token"}],"url":"https://infra.spec.whatwg.org/#byte-lowercase"},
"839611db": {"dfnID":"839611db","dfnText":"subresource request","external":true,"refSections":[{"refs":[{"id":"ref-for-subresource-request"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#subresource-request"},
"84b454ff": {"dfnID":"84b454ff","dfnText":"ordered map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"3.2. Accept-CH cache"}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"857d5516": {"dfnID":"857d5516","dfnText":"client","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-client"}],"title":"4.5. Extending environment settings object"},{"refs":[{"id":"ref-for-concept-request-client\u2460"},{"id":"ref-for-concept-request-client\u2461"},{"id":"ref-for-concept-request-client\u2462"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"8a30477b": {"dfnID":"8a30477b","dfnText":"global object","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-global"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-concept-settings-object-global\u2460"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global"},
"8a608b90": {"dfnID":"8a608b90","dfnText":"value","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header-value"}],"title":"7.3. Low entropy hint table"}],"url":"https://fetch.spec.whatwg.org/#concept-header-value"},
"8acee9c8": {"dfnID":"8acee9c8","dfnText":"http-redirect fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-http-redirect-fetch"}],"title":"6. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch"},
"9c4c1e66": {"dfnID":"9c4c1e66","dfnText":"relevant settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-relevant-settings-object"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"},{"refs":[{"id":"ref-for-relevant-settings-object\u2460"}],"title":"4.1. Document object initialization"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"a33db89a": {"dfnID":"a33db89a","dfnText":"fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-fetch"}],"title":"4.5. Extending environment settings object"},{"refs":[{"id":"ref-for-concept-fetch\u2460"}],"title":"6. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"a3b18719": {"dfnID":"a3b18719","dfnText":"append","external":true,"refSections":[{"refs":[{"id":"ref-for-set-append"}],"title":"3.2. Accept-CH cache"},{"refs":[{"id":"ref-for-set-append\u2460"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-set-append\u2461"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://infra.spec.whatwg.org/#set-append"},
"a6a8ec88": {"dfnID":"a6a8ec88","dfnText":"append","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header-list-append"},{"id":"ref-for-concept-header-list-append\u2460"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#concept-header-list-append"},
"abstract-opdef-append-client-hints-to-request": {"dfnID":"abstract-opdef-append-client-hints-to-request","dfnText":"append client hints to request","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-append-client-hints-to-request"}],"title":"6. Integration with Fetch"}],"url":"#abstract-opdef-append-client-hints-to-request"},
"abstract-opdef-initialize-the-client-hints-set": {"dfnID":"abstract-opdef-initialize-the-client-hints-set","dfnText":"initialize the Client Hints set","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-initialize-the-client-hints-set"}],"title":"4.1. Document object initialization"}],"url":"#abstract-opdef-initialize-the-client-hints-set"},
"abstract-opdef-remove-client-hints-from-redirect-if-needed": {"dfnID":"abstract-opdef-remove-client-hints-from-redirect-if-needed","dfnText":"remove client hints from redirect if needed","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-remove-client-hints-from-redirect-if-needed"}],"title":"6. Integration with Fetch"}],"url":"#abstract-opdef-remove-client-hints-from-redirect-if-needed"},
"accept-ch": {"dfnID":"accept-ch","dfnText":"accept-ch","external":false,"refSections":[{"refs":[{"id":"ref-for-accept-ch"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"#accept-ch"},
"accept-ch-cache": {"dfnID":"accept-ch-cache","dfnText":"Accept-CH cache","external":false,"refSections":[{"refs":[{"id":"ref-for-accept-ch-cache"},{"id":"ref-for-accept-ch-cache\u2460"},{"id":"ref-for-accept-ch-cache\u2461"}],"title":"3.2. Accept-CH cache"},{"refs":[{"id":"ref-for-accept-ch-cache\u2462"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"#accept-ch-cache"},
"accept-ch-cache-client-hints-set": {"dfnID":"accept-ch-cache-client-hints-set","dfnText":"client hints set","external":false,"refSections":[{"refs":[{"id":"ref-for-accept-ch-cache-client-hints-set"}],"title":"3.2. Accept-CH cache"}],"url":"#accept-ch-cache-client-hints-set"},
"accept-ch-cache-origin": {"dfnID":"accept-ch-cache-origin","dfnText":"origin","external":false,"refSections":[{"refs":[{"id":"ref-for-accept-ch-cache-origin"},{"id":"ref-for-accept-ch-cache-origin\u2460"}],"title":"3.2. Accept-CH cache"}],"url":"#accept-ch-cache-origin"},
"accept-ch-state": {"dfnID":"accept-ch-state","dfnText":"Accept-CH state","external":false,"refSections":[{"refs":[{"id":"ref-for-accept-ch-state"}],"title":"4.4. Pragma directives"}],"url":"#accept-ch-state"},
"add-a-new-accept-ch-cache-entry": {"dfnID":"add-a-new-accept-ch-cache-entry","dfnText":"add a new Accept-CH cache entry","external":false,"refSections":[{"refs":[{"id":"ref-for-add-a-new-accept-ch-cache-entry"}],"title":"3.3. Initialize Client Hints set"}],"url":"#add-a-new-accept-ch-cache-entry"},
"ae2a6342": {"dfnID":"ae2a6342","dfnText":"top-level browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-top-level-browsing-context"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2460"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"c9e7c11a": {"dfnID":"c9e7c11a","dfnText":"header","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#concept-header"},
"cc890cc1": {"dfnID":"cc890cc1","dfnText":"policy-controlled feature","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature"}],"title":"7.2. Policy-controlled features"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"ch-device-memory": {"dfnID":"ch-device-memory","dfnText":"ch-device-memory","external":false,"refSections":[],"url":"#ch-device-memory"},
"ch-downlink": {"dfnID":"ch-downlink","dfnText":"ch-downlink","external":false,"refSections":[],"url":"#ch-downlink"},
"ch-dpr": {"dfnID":"ch-dpr","dfnText":"ch-dpr","external":false,"refSections":[],"url":"#ch-dpr"},
"ch-ect": {"dfnID":"ch-ect","dfnText":"ch-ect","external":false,"refSections":[],"url":"#ch-ect"},
"ch-rtt": {"dfnID":"ch-rtt","dfnText":"ch-rtt","external":false,"refSections":[],"url":"#ch-rtt"},
"ch-save-data": {"dfnID":"ch-save-data","dfnText":"ch-save-data","external":false,"refSections":[],"url":"#ch-save-data"},
"ch-ua": {"dfnID":"ch-ua","dfnText":"ch-ua","external":false,"refSections":[],"url":"#ch-ua"},
"ch-ua-arch": {"dfnID":"ch-ua-arch","dfnText":"ch-ua-arch","external":false,"refSections":[],"url":"#ch-ua-arch"},
"ch-ua-bitness": {"dfnID":"ch-ua-bitness","dfnText":"ch-ua-bitness","external":false,"refSections":[],"url":"#ch-ua-bitness"},
"ch-ua-mobile": {"dfnID":"ch-ua-mobile","dfnText":"ch-ua-mobile","external":false,"refSections":[],"url":"#ch-ua-mobile"},
"ch-ua-model": {"dfnID":"ch-ua-model","dfnText":"ch-ua-model","external":false,"refSections":[],"url":"#ch-ua-model"},
"ch-ua-platform": {"dfnID":"ch-ua-platform","dfnText":"ch-ua-platform","external":false,"refSections":[],"url":"#ch-ua-platform"},
"ch-ua-platform-version": {"dfnID":"ch-ua-platform-version","dfnText":"ch-ua-platform-version","external":false,"refSections":[],"url":"#ch-ua-platform-version"},
"ch-viewport-height": {"dfnID":"ch-viewport-height","dfnText":"ch-viewport-height","external":false,"refSections":[],"url":"#ch-viewport-height"},
"ch-viewport-width": {"dfnID":"ch-viewport-width","dfnText":"ch-viewport-width","external":false,"refSections":[],"url":"#ch-viewport-width"},
"ch-width": {"dfnID":"ch-width","dfnText":"ch-width","external":false,"refSections":[],"url":"#ch-width"},
"client-hints-set": {"dfnID":"client-hints-set","dfnText":"client hints set","external":false,"refSections":[{"refs":[{"id":"ref-for-client-hints-set"},{"id":"ref-for-client-hints-set\u2460"}],"title":"3.2. Accept-CH cache"},{"refs":[{"id":"ref-for-client-hints-set\u2461"}],"title":"4.5. Extending environment settings object"}],"url":"#client-hints-set"},
"client-hints-token": {"dfnID":"client-hints-token","dfnText":"client hints token","external":false,"refSections":[{"refs":[{"id":"ref-for-client-hints-token"}],"title":"3.1. Client hints set"},{"refs":[{"id":"ref-for-client-hints-token\u2460"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-client-hints-token\u2461"},{"id":"ref-for-client-hints-token\u2462"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"},{"refs":[{"id":"ref-for-client-hints-token\u2463"}],"title":"5. Request processing"}],"url":"#client-hints-token"},
"d14a6f26": {"dfnID":"d14a6f26","dfnText":"key","external":true,"refSections":[{"refs":[{"id":"ref-for-map-key"}],"title":"3.2. Accept-CH cache"}],"url":"https://infra.spec.whatwg.org/#map-key"},
"d5434eef": {"dfnID":"d5434eef","dfnText":"contains","external":true,"refSections":[{"refs":[{"id":"ref-for-header-list-contains"},{"id":"ref-for-header-list-contains\u2460"},{"id":"ref-for-header-list-contains\u2461"}],"title":"5. Request processing"}],"url":"https://fetch.spec.whatwg.org/#header-list-contains"},
"environment-settings-object-client-hints-set": {"dfnID":"environment-settings-object-client-hints-set","dfnText":"client hints set","external":false,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object-client-hints-set"},{"id":"ref-for-environment-settings-object-client-hints-set\u2460"},{"id":"ref-for-environment-settings-object-client-hints-set\u2461"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-environment-settings-object-client-hints-set\u2462"},{"id":"ref-for-environment-settings-object-client-hints-set\u2463"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"},{"refs":[{"id":"ref-for-environment-settings-object-client-hints-set\u2464"},{"id":"ref-for-environment-settings-object-client-hints-set\u2465"}],"title":"4.2. Worker initialization"},{"refs":[{"id":"ref-for-environment-settings-object-client-hints-set\u2466"},{"id":"ref-for-environment-settings-object-client-hints-set\u2467"}],"title":"5. Request processing"}],"url":"#environment-settings-object-client-hints-set"},
"field-name": {"dfnID":"field-name","dfnText":"field-name","external":false,"refSections":[{"refs":[{"id":"ref-for-field-name"}],"title":"3.3. Initialize Client Hints set"},{"refs":[{"id":"ref-for-field-name\u2460"}],"title":"3.4. Accept-CH state (http-equiv=\"accept-ch\")"}],"url":"#field-name"},
"find-client-hint-value": {"dfnID":"find-client-hint-value","dfnText":"find client hint value","external":false,"refSections":[{"refs":[{"id":"ref-for-find-client-hint-value"}],"title":"5. Request processing"}],"url":"#find-client-hint-value"},
"low-entropy-hint-table": {"dfnID":"low-entropy-hint-table","dfnText":"low entropy hint table","external":false,"refSections":[{"refs":[{"id":"ref-for-low-entropy-hint-table"}],"title":"5. Request processing"}],"url":"#low-entropy-hint-table"},
"policy-controlled-client-hints-features": {"dfnID":"policy-controlled-client-hints-features","dfnText":"policy-controlled client hints features","external":false,"refSections":[],"url":"#policy-controlled-client-hints-features"},
"retrieve-the-client-hints-set": {"dfnID":"retrieve-the-client-hints-set","dfnText":"retrieve the client hints set","external":false,"refSections":[{"refs":[{"id":"ref-for-retrieve-the-client-hints-set"}],"title":"3.3. Initialize Client Hints set"}],"url":"#retrieve-the-client-hints-set"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#abstract-opdef-append-client-hints-to-request": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"append client hints to request","type":"abstract-op","url":"#abstract-opdef-append-client-hints-to-request"},
"#abstract-opdef-initialize-the-client-hints-set": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"initialize the Client Hints set","type":"abstract-op","url":"#abstract-opdef-initialize-the-client-hints-set"},
"#abstract-opdef-remove-client-hints-from-redirect-if-needed": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"remove client hints from redirect if needed","type":"abstract-op","url":"#abstract-opdef-remove-client-hints-from-redirect-if-needed"},
"#accept-ch": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"accept-ch","type":"dfn","url":"#accept-ch"},
"#accept-ch-cache": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"accept-ch cache","type":"dfn","url":"#accept-ch-cache"},
"#accept-ch-cache-client-hints-set": {"export":true,"for_":["accept-ch-cache"],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"client hints set","type":"dfn","url":"#accept-ch-cache-client-hints-set"},
"#accept-ch-cache-origin": {"export":true,"for_":["accept-ch-cache"],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"origin","type":"dfn","url":"#accept-ch-cache-origin"},
"#accept-ch-state": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"accept-ch state","type":"dfn","url":"#accept-ch-state"},
"#add-a-new-accept-ch-cache-entry": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"add a new accept-ch cache entry","type":"dfn","url":"#add-a-new-accept-ch-cache-entry"},
"#client-hints-set": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"client hints set","type":"dfn","url":"#client-hints-set"},
"#client-hints-token": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"client hints token","type":"dfn","url":"#client-hints-token"},
"#environment-settings-object-client-hints-set": {"export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"client hints set","type":"dfn","url":"#environment-settings-object-client-hints-set"},
"#field-name": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"field-name","type":"dfn","url":"#field-name"},
"#find-client-hint-value": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"find client hint value","type":"dfn","url":"#find-client-hint-value"},
"#low-entropy-hint-table": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"low entropy hint table","type":"dfn","url":"#low-entropy-hint-table"},
"#retrieve-the-client-hints-set": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"clienthintsinfra","spec":"clienthintsinfra-1","status":"local","text":"retrieve the client hints set","type":"dfn","url":"#retrieve-the-client-hints-set"},
"https://fetch.spec.whatwg.org/#concept-fetch": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"https://fetch.spec.whatwg.org/#concept-header": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header"},
"https://fetch.spec.whatwg.org/#concept-header-list-append": {"export":true,"for_":["header list"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"append","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header-list-append"},
"https://fetch.spec.whatwg.org/#concept-header-name": {"export":true,"for_":["header"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"name","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header-name"},
"https://fetch.spec.whatwg.org/#concept-header-value": {"export":true,"for_":["header"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"value","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header-value"},
"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"http-redirect fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch"},
"https://fetch.spec.whatwg.org/#concept-request-client": {"export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"client","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"https://fetch.spec.whatwg.org/#concept-request-header-list": {"export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-header-list"},
"https://fetch.spec.whatwg.org/#concept-request-request": {"export":true,"for_":["Request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"request","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-request"},
"https://fetch.spec.whatwg.org/#header-list-contains": {"export":true,"for_":["header list"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"does not contain","type":"dfn","url":"https://fetch.spec.whatwg.org/#header-list-contains"},
"https://fetch.spec.whatwg.org/#subresource-request": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"subresource request","type":"dfn","url":"https://fetch.spec.whatwg.org/#subresource-request"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#same-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc": {"export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc"},
"https://html.spec.whatwg.org/multipage/semantics.html#attr-meta-content": {"export":true,"for_":["meta"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"content","type":"element-attr","url":"https://html.spec.whatwg.org/multipage/semantics.html#attr-meta-content"},
"https://html.spec.whatwg.org/multipage/semantics.html#meta": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"meta","type":"element","url":"https://html.spec.whatwg.org/multipage/semantics.html#meta"},
"https://html.spec.whatwg.org/multipage/semantics.html#the-head-element": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"head","type":"element","url":"https://html.spec.whatwg.org/multipage/semantics.html#the-head-element"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global": {"export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"global object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin": {"export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"https://infra.spec.whatwg.org/#byte-lowercase": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"byte-lowercase","type":"dfn","url":"https://infra.spec.whatwg.org/#byte-lowercase"},
"https://infra.spec.whatwg.org/#list-clone": {"export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"clone","type":"dfn","url":"https://infra.spec.whatwg.org/#list-clone"},
"https://infra.spec.whatwg.org/#list-iterate": {"export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"for each","type":"dfn","url":"https://infra.spec.whatwg.org/#list-iterate"},
"https://infra.spec.whatwg.org/#map-key": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"key","type":"dfn","url":"https://infra.spec.whatwg.org/#map-key"},
"https://infra.spec.whatwg.org/#map-set": {"export":true,"for_":["map"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"set","type":"dfn","url":"https://infra.spec.whatwg.org/#map-set"},
"https://infra.spec.whatwg.org/#ordered-map": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"ordered map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://infra.spec.whatwg.org/#ordered-set": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"set","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-set"},
"https://infra.spec.whatwg.org/#set-append": {"export":true,"for_":["set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"append","type":"dfn","url":"https://infra.spec.whatwg.org/#set-append"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"policy-controlled feature","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist": {"export":true,"for_":["policy-controlled feature"],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"default allowlist","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>