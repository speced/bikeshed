<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Writing Promise-Using Specifications</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
<style data-fill-with="stylesheet">/******************************************************************************
 *                   Style sheet for the W3C specifications                   *
 *
 * Special classes handled by this style sheet include:
 *
 * Indices
 *   - .toc for the Table of Contents (<ol class="toc">)
 *     + <span class="secno"> for the section numbers
 *   - #toc for the Table of Contents (<nav id="toc">)
 *   - ul.index for Indices (<a href="#ref">term</a><span>, in §N.M</span>)
 *   - table.index for Index Tables (e.g. for properties or elements)
 *
 * Structural Markup
 *   - table.data for general data tables
 *     -> use 'scope' attribute, <colgroup>, <thead>, and <tbody> for best results !
 *     -> use <table class='complex data'> for extra-complex tables
 *     -> use <td class='long'> for paragraph-length cell content
 *     -> use <td class='pre'> when manual line breaks/indentation would help readability
 *   - dl.switch for switch statements
 *   - ol.algorithm for algorithms (helps to visualize nesting)
 *   - .figure and .caption (HTML4) and figure and figcaption (HTML5)
 *     -> .sidefigure for right-floated figures
 *   - ins/del
 *
 * Code
 *   - pre and code
 *
 * Special Sections
 *   - .note       for informative notes             (div, p, span, aside, details)
 *   - .example    for informative examples          (div, p, pre, span)
 *   - .issue      for issues                        (div, p, span)
 *   - .assertion  for assertions                    (div, p, span)
 *   - .advisement for loud normative statements     (div, p, strong)
 *   - .annoying-warning for spec obsoletion notices (div, aside, details)
 *
 * Definition Boxes
 *   - pre.def   for WebIDL definitions
 *   - table.def for tables that define other entities (e.g. CSS properties)
 *   - dl.def    for definition lists that define other entitles (e.g. HTML elements)
 *
 * Numbering
 *   - .secno for section numbers in .toc and headings (<span class='secno'>3.2</span>)
 *   - .marker for source-inserted example/figure/issue numbers (<span class='marker'>Issue 4</span>)
 *   - ::before styled for CSS-generated issue/example/figure numbers:
 *     -> Documents wishing to use this only need to add
 *        figcaption::before,
 *        .caption::before { content: "Figure "  counter(figure) " ";  }
 *        .example::before { content: "Example " counter(example) " "; }
 *        .issue::before   { content: "Issue "   counter(issue) " ";   }
 *
 * Header Stuff (ignore, just don't conflict with these classes)
 *   - .head for the header
 *   - .copyright for the copyright
 *
 * Miscellaneous
 *   - .overlarge for things that should be as wide as possible, even if
 *     that overflows the body text area. This can be used on an item or
 *     on its container, depending on the effect desired.
 *     Note that this styling basically doesn't help at all when printing,
 *     since A4 paper isn't much wider than the max-width here.
 *     It's better to design things to fit into a narrower measure if possible.
 *   - js-added ToC jump links (see fixup.js)
 *
 ******************************************************************************/

/******************************************************************************/
/*                                   Body                                     */
/******************************************************************************/

	body {
		counter-reset: example figure issue;

		/* Layout */
		max-width: 50em;               /* limit line length to 50em for readability   */
		margin: 0 auto;                /* center text within page                     */
		padding: 1.6em 1.5em 2em 50px; /* assume 16px font size for downlevel clients */
		padding: 1.6em 1.5em 2em calc(26px + 1.5em); /* leave space for status flag     */

		/* Typography */
		line-height: 1.5;
		font-family: sans-serif;
		widows: 2;
		orphans: 2;
		word-wrap: break-word;
		overflow-wrap: break-word;
		hyphens: auto;

		/* Colors */
		color: black;
		background: white top left fixed no-repeat;
		background-size: 25px auto;
	}


/******************************************************************************/
/*                         Front Matter & Navigation                          */
/******************************************************************************/

/** Header ********************************************************************/

	div.head { margin-bottom: 1em }
	div.head hr { border-style: solid; }

	div.head h1 {
		font-weight: bold;
		margin: 0 0 .1em;
		font-size: 220%;
	}

	div.head h2 { margin-bottom: 1.5em;}

/** W3C Logo ******************************************************************/

	.head .logo {
		float: right;
		margin: 0.4rem 0 0.2rem .4rem;
	}

	.head img[src*="logos/W3C"] {
		display: block;
		border: solid #1a5e9a;
		border-width: .65rem .7rem .6rem;
		border-radius: .4rem;
		background: #1a5e9a;
		color: white;
		font-weight: bold;
	}

	.head a:hover > img[src*="logos/W3C"],
	.head a:focus > img[src*="logos/W3C"] {
		opacity: .8;
	}

	.head a:active > img[src*="logos/W3C"] {
		background: #c00;
		border-color: #c00;
	}

	/* see also additional rules in Link Styling section */

/** Copyright *****************************************************************/

	p.copyright,
	p.copyright small { font-size: small }

/** Back to Top / ToC Toggle **************************************************/

	@media print {
		#toc-nav {
			display: none;
		}
	}
	@media not print {
		#toc-nav {
			position: fixed;
			z-index: 2;
			bottom: 0; left: 0;
			margin: 0;
			min-width: 1.33em;
			border-top-right-radius: 2rem;
			box-shadow: 0 0 2px;
			font-size: 1.5em;
			color: black;
		}
		#toc-nav > a {
			display: block;
			white-space: nowrap;

			height: 1.33em;
			padding: .1em 0.3em;
			margin: 0;

			background: white;
			box-shadow: 0 0 2px;
			border: none;
			border-top-right-radius: 1.33em;
			background: white;
		}
		#toc-nav > #toc-jump {
			padding-bottom: 2em;
			margin-bottom: -1.9em;
		}

		#toc-nav > a:hover,
		#toc-nav > a:focus {
			background: #f8f8f8;
		}
		#toc-nav > a:not(:hover):not(:focus) {
			color: #707070;
		}

		/* statusbar gets in the way on keyboard focus; remove once browsers fix */
		#toc-nav > a[href="#toc"]:not(:hover):focus:last-child {
			padding-bottom: 1.5rem;
		}

		#toc-nav:not(:hover) > a:not(:focus) > span + span {
			/* Ideally this uses :focus-within on #toc-nav */
			display: none;
		}
		#toc-nav > a > span + span {
			padding-right: 0.2em;
		}

		#toc-toggle-inline {
			vertical-align: 0.05em;
			font-size: 80%;
			color: gray;
			color: hsla(203,20%,40%,.7);
			border-style: none;
			background: transparent;
			position: relative;
		}
		#toc-toggle-inline:hover:not(:active),
		#toc-toggle-inline:focus:not(:active) {
			text-shadow: 1px 1px silver;
			top: -1px;
			left: -1px;
		}

		#toc-nav :active {
			color: #C00;
		}
	}

/** ToC Sidebar ***************************************************************/

	/* Floating sidebar */
	@media screen {
		body.toc-sidebar #toc {
			position: fixed;
			top: 0; bottom: 0;
			left: 0;
			width: 23.5em;
			max-width: 80%;
			max-width: calc(100% - 2em - 26px);
			overflow: auto;
			padding: 0 1em;
			padding-left: 42px;
			padding-left: calc(1em + 26px);
			background: inherit;
			background-color: #f7f8f9;
			z-index: 1;
			box-shadow: -.1em 0 .25em rgba(0,0,0,.1) inset;
		}
		body.toc-sidebar #toc h2 {
			margin-top: .8rem;
			font-variant: small-caps;
			font-variant: all-small-caps;
			text-transform: lowercase;
			font-weight: bold;
			color: gray;
			color: hsla(203,20%,40%,.7);
		}
		body.toc-sidebar #toc-jump:not(:focus) {
			width: 0;
			height: 0;
			padding: 0;
			position: absolute;
			overflow: hidden;
		}
	}
	/* Hide main scroller when only the ToC is visible anyway */
	@media screen and (max-width: 28em) {
		body.toc-sidebar {
			overflow: hidden;
		}
	}

	/* Sidebar with its own space */
	@media screen and (min-width: 78em) {
		body:not(.toc-inline) #toc {
			position: fixed;
			top: 0; bottom: 0;
			left: 0;
			width: 23.5em;
			overflow: auto;
			padding: 0 1em;
			padding-left: 42px;
			padding-left: calc(1em + 26px);
			background: inherit;
			background-color: #f7f8f9;
			z-index: 1;
			box-shadow: -.1em 0 .25em rgba(0,0,0,.1) inset;
		}
		body:not(.toc-inline) #toc h2 {
			margin-top: .8rem;
			font-variant: small-caps;
			font-variant: all-small-caps;
			text-transform: lowercase;
			font-weight: bold;
			color: gray;
			color: hsla(203,20%,40%,.7);
		}

		body:not(.toc-inline) {
			padding-left: 29em;
		}
		/* See also Overflow section at the bottom */

		body:not(.toc-inline) #toc-jump:not(:focus) {
			width: 0;
			height: 0;
			padding: 0;
			position: absolute;
			overflow: hidden;
		}
	}
	@media screen and (min-width: 90em) {
		body:not(.toc-inline) {
			margin: 0 4em;
		}
	}

/******************************************************************************/
/*                                Sectioning                                  */
/******************************************************************************/

/** Headings ******************************************************************/

	h1, h2, h3, h4, h5, h6, dt {
		page-break-after: avoid;
		page-break-inside: avoid;
		font: 100% sans-serif;   /* Reset all font styling to clear out UA styles */
		font-family: inherit;    /* Inherit the font family. */
		line-height: 1.2;        /* Keep wrapped headings compact */
		hyphens: manual;         /* Hyphenated headings look weird */
	}

	h2, h3, h4, h5, h6 {
		margin-top: 3rem;
	}

	h1, h2, h3 {
		color: #005A9C;
		background: transparent;
	}

	h1 { font-size: 170%; }
	h2 { font-size: 140%; }
	h3 { font-size: 120%; }
	h4 { font-weight: bold; }
	h5 { font-style: italic; }
	h6 { font-variant: small-caps; }
	dt { font-weight: bold; }

/** Subheadings ***************************************************************/

	h1 + h2,
	#subtitle {
		/* #subtitle is a subtitle in an H2 under the H1 */
		margin-top: 0;
	}
	h2 + h3,
	h3 + h4,
	h4 + h5,
	h5 + h6 {
		margin-top: 1.2em; /* = 1 x line-height */
	}

/** Section divider ***********************************************************/

	:not(.head) > hr {
		font-size: 1.5em;
		text-align: center;
		margin: 1em auto;
		height: auto;
		border: transparent solid 0;
		background: transparent;
	}
	:not(.head) > hr::before {
		content: "\2727\2003\2003\2727\2003\2003\2727";
	}

/******************************************************************************/
/*                            Paragraphs and Lists                            */
/******************************************************************************/

	p {
		margin: 1em 0;
	}

	dd > p:first-child,
	li > p:first-child {
		margin-top: 0;
	}

	ul, ol {
		margin-left: 0;
		padding-left: 2em;
	}

	li {
		margin: 0.25em 0 0.5em;
		padding: 0;
	}

	dl dd {
		margin: 0 0 .5em 2em;
	}

	.head dd + dd { /* compact for header */
		margin-top: -.5em;
	}

	/* Style for algorithms */
	ol.algorithm ol:not(.algorithm),
	.algorithm > ol ol:not(.algorithm) {
	 border-left: 0.5em solid #DEF;
	}

	/* Put nice boxes around each algorithm. */
	[data-algorithm]:not(.heading) {
	  padding: .5em;
	  border: thin solid #ddd; border-radius: .5em;
	  margin: .5em calc(-0.5em - 1px);
	}
	[data-algorithm]:not(.heading) > :first-child {
	  margin-top: 0;
	}
	[data-algorithm]:not(.heading) > :last-child {
	  margin-bottom: 0;
	}

	/* Style for switch/case <dl>s */
	dl.switch > dd > ol.only,
	dl.switch > dd > .only > ol {
	 margin-left: 0;
	}
	dl.switch > dd > ol.algorithm,
	dl.switch > dd > .algorithm > ol {
	 margin-left: -2em;
	}
	dl.switch {
	 padding-left: 2em;
	}
	dl.switch > dt {
	 text-indent: -1.5em;
	 margin-top: 1em;
	}
	dl.switch > dt + dt {
	 margin-top: 0;
	}
	dl.switch > dt::before {
	 content: '\21AA';
	 padding: 0 0.5em 0 0;
	 display: inline-block;
	 width: 1em;
	 text-align: right;
	 line-height: 0.5em;
	}

/** Terminology Markup ********************************************************/


/******************************************************************************/
/*                                 Inline Markup                              */
/******************************************************************************/

/** Terminology Markup ********************************************************/
	dfn   { /* Defining instance */
		font-weight: bolder;
	}
	a > i { /* Instance of term */
		font-style: normal;
	}
	dt dfn code, code.idl {
		font-size: medium;
	}
	dfn var {
		font-style: normal;
	}

/** Change Marking ************************************************************/

	del { color: red;  text-decoration: line-through; }
	ins { color: #080; text-decoration: underline;    }

/** Miscellaneous improvements to inline formatting ***************************/

	sup {
		vertical-align: super;
		font-size: 80%
	}

/******************************************************************************/
/*                                    Code                                    */
/******************************************************************************/

/** General monospace/pre rules ***********************************************/

	pre, code, samp {
		font-family: Menlo, Consolas, "DejaVu Sans Mono", Monaco, monospace;
		font-size: .9em;
		page-break-inside: avoid;
		hyphens: none;
		text-transform: none;
	}
	pre code,
	code code {
		font-size: 100%;
	}

	pre {
		margin-top: 1em;
		margin-bottom: 1em;
		overflow: auto;
	}

/** Inline Code fragments *****************************************************/

  /* Do something nice. */

/******************************************************************************/
/*                                    Links                                   */
/******************************************************************************/

/** General Hyperlinks ********************************************************/

	/* We hyperlink a lot, so make it less intrusive */
	a[href] {
		color: #034575;
		text-decoration: none;
		border-bottom: 1px solid #707070;
		/* Need a bit of extending for it to look okay */
		padding: 0 1px 0;
		margin: 0 -1px 0;
	}
	a:visited {
		border-bottom-color: #BBB;
	}

	/* Use distinguishing colors when user is interacting with the link */
	a[href]:focus,
	a[href]:hover {
		background: #f8f8f8;
		background: rgba(75%, 75%, 75%, .25);
		border-bottom-width: 3px;
		margin-bottom: -2px;
	}
	a[href]:active {
		color: #C00;
		border-color: #C00;
	}

	/* Backout above styling for W3C logo */
	.head .logo,
	.head .logo a {
		border: none;
		text-decoration: none;
		background: transparent;
	}

/******************************************************************************/
/*                                    Images                                  */
/******************************************************************************/

	img {
		border-style: none;
	}

	/* For autogen numbers, add
	   .caption::before, figcaption::before { content: "Figure " counter(figure) ". "; }
	*/

	figure, .figure, .sidefigure {
		page-break-inside: avoid;
		text-align: center;
		margin: 2.5em 0;
	}
	.figure img,    .sidefigure img,    figure img,
	.figure object, .sidefigure object, figure object {
		max-width: 100%;
		margin: auto;
	}
	.figure pre, .sidefigure pre, figure pre {
		text-align: left;
		display: table;
		margin: 1em auto;
	}
	.figure table, figure table {
		margin: auto;
	}
	@media screen and (min-width: 20em) {
		.sidefigure {
			float: right;
			width: 50%;
			margin: 0 0 0.5em 0.5em
		}
	}
	.caption, figcaption, caption {
		font-style: italic;
		font-size: 90%;
	}
	.caption::before, figcaption::before, figcaption > .marker {
		font-weight: bold;
	}
	.caption, figcaption {
		counter-increment: figure;
	}

	/* DL list is indented 2em, but figure inside it is not */
	dd > .figure, dd > figure { margin-left: -2em }

/******************************************************************************/
/*                             Colored Boxes                                  */
/******************************************************************************/

	.issue, .note, .example, .assertion, .advisement, blockquote {
		padding: .5em;
		border: .5em;
		border-left-style: solid;
		page-break-inside: avoid;
	}
	span.issue, span.note {
		padding: .1em .5em .15em;
		border-right-style: solid;
	}

	.issue,
	.note,
	.example,
	.advisement,
	.assertion,
	blockquote {
		margin: 1em auto;
	}
	.note  > p:first-child,
	.issue > p:first-child,
	blockquote > :first-child {
		margin-top: 0;
	}
	blockquote > :last-child {
		margin-bottom: 0;
	}

/** Blockquotes ***************************************************************/

	blockquote {
		border-color: silver;
	}

/** Open issue ****************************************************************/

	.issue {
		border-color: #E05252;
		background: #FBE9E9;
		counter-increment: issue;
		overflow: auto;
	}
	.issue::before, .issue > .marker {
		text-transform: uppercase;
		color: #AE1E1E;
		padding-right: 1em;
		text-transform: uppercase;
	}
	/* Add .issue::before { content: "Issue " counter(issue) " "; } for autogen numbers,
	   or use class="marker" to mark up the issue number in source. */

/** Example *******************************************************************/

	.example {
		border-color: #E0CB52;
		background: #FCFAEE;
		counter-increment: example;
		overflow: auto;
		clear: both;
	}
	.example::before, .example > .marker {
		text-transform: uppercase;
		color: #827017;
		min-width: 7.5em;
		display: block;
	}
	/* Add .example::before { content: "Example " counter(example) " "; } for autogen numbers,
	   or use class="marker" to mark up the example number in source. */

/** Non-normative Note ********************************************************/

	.note {
		border-color: #52E052;
		background: #E9FBE9;
		overflow: auto;
	}

	.note::before, .note > .marker,
	details.note > summary::before,
	details.note > summary > .marker {
		text-transform: uppercase;
		display: block;
		color: hsl(120, 70%, 30%);
	}
	/* Add .note::before { content: "Note"; } for autogen label,
	   or use class="marker" to mark up the label in source. */

	details.note > summary {
		display: block;
		color: hsl(120, 70%, 30%);
	}
	details.note[open] > summary {
		border-bottom: 1px silver solid;
	}

/** Assertion Box *************************************************************/
	/*  for assertions in algorithms */

	.assertion {
		border-color: #AAA;
		background: #EEE;
	}

/** Advisement Box ************************************************************/
	/*  for attention-grabbing normative statements */

	.advisement {
		border-color: orange;
		border-style: none solid;
		background: #FFEECC;
	}
	strong.advisement {
		display: block;
		text-align: center;
	}
	.advisement > .marker {
		color: #B35F00;
	}

/** Spec Obsoletion Notice ****************************************************/
	/* obnoxious obsoletion notice for older/abandoned specs. */

	details {
		display: block;
	}
	summary {
		font-weight: bolder;
	}

	.annoying-warning:not(details),
	details.annoying-warning:not([open]) > summary,
	details.annoying-warning[open] {
		background: #fdd;
		color: red;
		font-weight: bold;
		padding: .75em 1em;
		border: thick red;
		border-style: solid;
		border-radius: 1em;
	}
	.annoying-warning :last-child {
		margin-bottom: 0;
	}

@media not print {
	details.annoying-warning[open] {
		position: fixed;
		left: 1em;
		right: 1em;
		bottom: 1em;
		z-index: 1000;
	}
}

	details.annoying-warning:not([open]) > summary {
		text-align: center;
	}

/** Entity Definition Boxes ***************************************************/

	.def {
		padding: .5em 1em;
		background: #DEF;
		margin: 1.2em 0;
		border-left: 0.5em solid #8CCBF2;
	}

/******************************************************************************/
/*                                    Tables                                  */
/******************************************************************************/

	th, td {
		text-align: left;
		text-align: start;
	}

/** Property/Descriptor Definition Tables *************************************/

	table.def {
		/* inherits .def box styling, see above */
		width: 100%;
		border-spacing: 0;
	}

	table.def td,
	table.def th {
		padding: 0.5em;
		vertical-align: baseline;
		border-bottom: 1px solid #bbd7e9;
	}

	table.def > tbody > tr:last-child th,
	table.def > tbody > tr:last-child td {
		border-bottom: 0;
	}

	table.def th {
		font-style: italic;
		font-weight: normal;
		padding-left: 1em;
		width: 3em;
	}

	/* For when values are extra-complex and need formatting for readability */
	table td.pre {
		white-space: pre-wrap;
	}

	/* A footnote at the bottom of a def table */
	table.def           td.footnote {
		padding-top: 0.6em;
	}
	table.def           td.footnote::before {
		content: " ";
		display: block;
		height: 0.6em;
		width: 4em;
		border-top: thin solid;
	}

/** Data tables (and properly marked-up index tables) *************************/
	/*
		 <table class="data"> highlights structural relationships in a table
		 when correct markup is used (e.g. thead/tbody, th vs. td, scope attribute)

		 Use class="complex data" for particularly complicated tables --
		 (This will draw more lines: busier, but clearer.)

		 Use class="long" on table cells with paragraph-like contents
		 (This will adjust text alignment accordingly.)
		 Alternately use class="longlastcol" on tables, to have the last column assume "long".
	*/

	table {
		word-wrap: normal;
		overflow-wrap: normal;
		hyphens: manual;
	}

	table.data,
	table.index {
		margin: 1em auto;
		border-collapse: collapse;
		border: hidden;
		width: 100%;
	}
	table.data caption,
	table.index caption {
		max-width: 50em;
		margin: 0 auto 1em;
	}

	table.data td,  table.data th,
	table.index td, table.index th {
		padding: 0.5em 1em;
		border-width: 1px;
		border-color: silver;
		border-top-style: solid;
	}

	table.data thead td:empty {
		padding: 0;
		border: 0;
	}

	table.data  thead,
	table.index thead,
	table.data  tbody,
	table.index tbody {
		border-bottom: 2px solid;
	}

	table.data colgroup,
	table.index colgroup {
		border-left: 2px solid;
	}

	table.data  tbody th:first-child,
	table.index tbody th:first-child  {
		border-right: 2px solid;
		border-top: 1px solid silver;
		padding-right: 1em;
	}

	table.data th[colspan],
	table.data td[colspan] {
		text-align: center;
	}

	table.complex.data th,
	table.complex.data td {
		border: 1px solid silver;
		text-align: center;
	}

	table.data.longlastcol td:last-child,
	table.data td.long {
	 vertical-align: baseline;
	 text-align: left;
	}

	table.data img {
		vertical-align: middle;
	}


/*
Alternate table alignment rules

	table.data,
	table.index {
		text-align: center;
	}

	table.data  thead th[scope="row"],
	table.index thead th[scope="row"] {
		text-align: right;
	}

	table.data  tbody th:first-child,
	table.index tbody th:first-child  {
		text-align: right;
	}

Possible extra rowspan handling

	table.data  tbody th[rowspan]:not([rowspan='1']),
	table.index tbody th[rowspan]:not([rowspan='1']),
	table.data  tbody td[rowspan]:not([rowspan='1']),
	table.index tbody td[rowspan]:not([rowspan='1']) {
		border-left: 1px solid silver;
	}

	table.data  tbody th[rowspan]:first-child,
	table.index tbody th[rowspan]:first-child,
	table.data  tbody td[rowspan]:first-child,
	table.index tbody td[rowspan]:first-child{
		border-left: 0;
		border-right: 1px solid silver;
	}
*/

/******************************************************************************/
/*                                  Indices                                   */
/******************************************************************************/


/** Table of Contents *********************************************************/

	.toc a {
		/* More spacing; use padding to make it part of the click target. */
		padding-top: 0.1rem;
		/* Larger, more consistently-sized click target */
		display: block;
		/* Reverse color scheme */
		color: black;
		border-color: #3980B5;
		border-bottom-width: 3px !important;
		margin-bottom: 0px !important;
	}
	.toc a:visited {
		border-color: #054572;
	}
	.toc a:not(:focus):not(:hover) {
		/* Allow colors to cascade through from link styling */
		border-bottom-color: transparent;
	}

	.toc, .toc ol, .toc ul, .toc li {
		list-style: none; /* Numbers must be inlined into source */
		/* because generated content isn't search/selectable and markers can't do multilevel yet */
		margin:  0;
		padding: 0;
		line-height: 1.1rem; /* consistent spacing */
	}

	/* ToC not indented until third level, but font style & margins show hierarchy */
	.toc > li             { font-weight: bold;   }
	.toc > li li          { font-weight: normal; }
	.toc > li li li       { font-size:   95%;    }
	.toc > li li li li    { font-size:   90%;    }
	.toc > li li li li .secno { font-size: 85%; }
	.toc > li li li li li { font-size:   85%;    }
	.toc > li li li li li .secno { font-size: 100%; }

	/* @supports not (display:grid) { */
		.toc > li             { margin: 1.5rem 0;    }
		.toc > li li          { margin: 0.3rem 0;    }
		.toc > li li li       { margin-left: 2rem;   }

		/* Section numbers in a column of their own */
		.toc .secno {
			float: left;
			width: 4rem;
			white-space: nowrap;
		}

		.toc li {
			clear: both;
		}

		:not(li) > .toc              { margin-left:  5rem; }
		.toc .secno                  { margin-left: -5rem; }
		.toc > li li li .secno       { margin-left: -7rem; }
		.toc > li li li li .secno    { margin-left: -9rem; }
		.toc > li li li li li .secno { margin-left: -11rem; }

		/* Tighten up indentation in narrow ToCs */
		@media (max-width: 30em) {
			:not(li) > .toc              { margin-left:  4rem; }
			.toc .secno                  { margin-left: -4rem; }
			.toc > li li li              { margin-left:  1rem; }
			.toc > li li li .secno       { margin-left: -5rem; }
			.toc > li li li li .secno    { margin-left: -6rem; }
			.toc > li li li li li .secno { margin-left: -7rem; }
		}
	/* } */

	@supports (display:grid) and (display:contents) {
		/* Use #toc over .toc to override non-@supports rules. */
		#toc {
			display: grid;
			align-content: start;
			grid-template-columns: auto 1fr;
			grid-column-gap: 1rem;
			column-gap: 1rem;
			grid-row-gap: .6rem;
			row-gap: .6rem;
		}
		#toc h2 {
			grid-column: 1 / -1;
			margin-bottom: 0;
		}
		#toc ol,
		#toc li,
		#toc a {
			display: contents;
			/* Switch <a> to subgrid when supported */
		}
		#toc span {
			margin: 0;
		}
		#toc > .toc > li > a > span {
			/* The spans of the top-level list,
			   comprising the first items of each top-level section. */
			margin-top: 1.1rem;
		}
		#toc#toc .secno { /* Ugh, need more specificity to override base.css */
			grid-column: 1;
			width: auto;
			margin-left: 0;
		}
		#toc .content {
			grid-column: 2;
			width: auto;
			margin-right: 1rem;
		}
		#toc .content:hover {
			background: rgba(75%, 75%, 75%, .25);
			border-bottom: 3px solid #054572;
			margin-bottom: -3px;
		}
		#toc li li li .content {
			margin-left: 1rem;
		}
		#toc li li li li .content {
			margin-left: 2rem;
		}
	}


/** Index *********************************************************************/

	/* Index Lists: Layout */
	ul.index       { margin-left: 0; columns: 15em; text-indent: 1em hanging; }
	ul.index li    { margin-left: 0; list-style: none; break-inside: avoid; }
	ul.index li li { margin-left: 1em }
	ul.index dl    { margin-top: 0; }
	ul.index dt    { margin: .2em 0 .2em 20px;}
	ul.index dd    { margin: .2em 0 .2em 40px;}
	/* Index Lists: Typography */
	ul.index ul,
	ul.index dl { font-size: smaller; }
	@media not print {
		ul.index li span {
			white-space: nowrap;
			color: transparent; }
		ul.index li a:hover + span,
		ul.index li a:focus + span {
			color: #707070;
		}
	}

/** Index Tables *****************************************************/
	/* See also the data table styling section, which this effectively subclasses */

	table.index {
		font-size: small;
		border-collapse: collapse;
		border-spacing: 0;
		text-align: left;
		margin: 1em 0;
	}

	table.index td,
	table.index th {
		padding: 0.4em;
	}

	table.index tr:hover td:not([rowspan]),
	table.index tr:hover th:not([rowspan]) {
		background: #f7f8f9;
	}

	/* The link in the first column in the property table (formerly a TD) */
	table.index th:first-child a {
		font-weight: bold;
	}

/******************************************************************************/
/*                                    Print                                   */
/******************************************************************************/

	@media print {
		/* Pages have their own margins. */
		html {
			margin: 0;
		}
		/* Serif for print. */
		body {
			font-family: serif;
		}
	}
	@page {
		margin: 1.5cm 1.1cm;
	}

/******************************************************************************/
/*                                    Legacy                                  */
/******************************************************************************/

	/* This rule is inherited from past style sheets. No idea what it's for. */
	.hide { display: none }



/******************************************************************************/
/*                             Overflow Control                               */
/******************************************************************************/

	.figure .caption, .sidefigure .caption, figcaption {
		/* in case figure is overlarge, limit caption to 50em */
		max-width: 50rem;
		margin-left: auto;
		margin-right: auto;
	}
	.overlarge > table {
		/* limit preferred width of table */
		max-width: 50em;
		margin-left: auto;
		margin-right: auto;
	}

	@media (min-width: 55em) {
		.overlarge {
			margin-left: calc(13px + 26.5rem - 50vw);
			margin-right: calc(13px + 26.5rem - 50vw);
			max-width: none;
		}
	}
	@media screen and (min-width: 78em) {
		body:not(.toc-inline) .overlarge {
			/* 30.5em body padding 50em content area */
			margin-left: calc(40em - 50vw) !important;
			margin-right: calc(40em - 50vw) !important;
		}
	}
	@media screen and (min-width: 90em) {
		body:not(.toc-inline) .overlarge {
			/* 4em html margin 30.5em body padding 50em content area */
			margin-left: 0 !important;
			margin-right: calc(84.5em - 100vw) !important;
		}
	}

	@media not print {
		.overlarge {
			overflow-x: auto;
			/* See Lea Verou's explanation background-attachment:
			 * http://lea.verou.me/2012/04/background-attachment-local/
			 *
			background: top left  / 4em 100% linear-gradient(to right,  #ffffff, rgba(255, 255, 255, 0)) local,
			            top right / 4em 100% linear-gradient(to left, #ffffff, rgba(255, 255, 255, 0)) local,
			            top left  / 1em 100% linear-gradient(to right,  #c3c3c5, rgba(195, 195, 197, 0)) scroll,
			            top right / 1em 100% linear-gradient(to left, #c3c3c5, rgba(195, 195, 197, 0)) scroll,
			            white;
			background-repeat: no-repeat;
			*/
		}
	}
</style>
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: gray;
    color: white;
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: black;
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: #005a9c;
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-dfn-panel */

.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: #DDDDDD;
    color: black;
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: black; }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-syntax-highlighting */

.highlight:not(.idl) { background: hsl(24, 20%, 95%); }
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"></p>
   <h1 class="p-name no-ref" id="title">Writing Promise-Using Specifications</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="subtitle"><span class="content">Finding of the W3C TAG, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://domenic.me/">Domenic Denicola</a> (<a class="p-org org" href="https://www.google.com/">Google</a>) <a class="u-email email" href="mailto:d@domenic.me">d@domenic.me</a>
     <dt>Participate:
     <dd><a href="https://github.com/w3ctag/promises-guide">GitHub w3ctag/promises-guide</a> (<a href="https://github.com/w3ctag/promises-guide/issues/new">file an issue</a>; <a href="https://github.com/w3ctag/promises-guide/issues?state=open">open issues</a>)
     <dd>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://creativecommons.org/publicdomain/zero/1.0/" rel="license"><img alt="CC0" src="https://licensebuttons.net/p/zero/1.0/80x15.png"></a> To the extent possible under law, the editors have waived all copyright
and related or neighboring rights to this work.
In addition, as of 1 January 1970,
the editors have made this specification available under the <a href="http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0" rel="license">Open Web Foundation Agreement Version 1.0</a>,
which is available at http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0.
Parts of this work may be from another specification document.  If so, those parts are instead covered by the license of that specification document. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document gives guidance on how to write specifications that create, accept, or manipulate promises.

It also includes a series of prose shorthands you can use in your specification to work with promises.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#when-to-use"><span class="secno">2</span> <span class="content">When to Use Promises</span></a>
     <ol class="toc">
      <li><a href="#one-and-done"><span class="secno">2.1</span> <span class="content">One-and-Done Operations</span></a>
      <li><a href="#one-time-events"><span class="secno">2.2</span> <span class="content">One-Time "Events"</span></a>
      <li><a href="#state-transitions"><span class="secno">2.3</span> <span class="content">More General State Transitions</span></a>
     </ol>
    <li>
     <a href="#when-not-to-use"><span class="secno">3</span> <span class="content">When Not to Use Promises</span></a>
     <ol class="toc">
      <li><a href="#recurring-events"><span class="secno">3.1</span> <span class="content">Recurring Events</span></a>
      <li><a href="#streaming-data"><span class="secno">3.2</span> <span class="content">Streaming Data</span></a>
     </ol>
    <li>
     <a href="#api-design-guidance"><span class="secno">4</span> <span class="content">API Design Guidance</span></a>
     <ol class="toc">
      <li>
       <a href="#errors"><span class="secno">4.1</span> <span class="content">Errors</span></a>
       <ol class="toc">
        <li><a href="#always-return-promises"><span class="secno">4.1.1</span> <span class="content">Promise-Returning Functions Should Always Return Promises</span></a>
        <li><a href="#reasons-should-be-errors"><span class="secno">4.1.2</span> <span class="content">Rejection Reasons Should Be <code>Error</code>s</span></a>
        <li><a href="#rejections-should-be-exceptional"><span class="secno">4.1.3</span> <span class="content">Rejections Should Be Used for Exceptional Situations</span></a>
       </ol>
      <li>
       <a href="#async-algorithms"><span class="secno">4.2</span> <span class="content">Asynchronous Algorithms</span></a>
       <ol class="toc">
        <li><a href="#simply-resolve-or-reject"><span class="secno">4.2.1</span> <span class="content">Simply Resolve or Reject the Promise</span></a>
        <li><a href="#explicit-async-steps"><span class="secno">4.2.2</span> <span class="content">Note Parallel Steps Explicitly</span></a>
        <li><a href="#queue-tasks"><span class="secno">4.2.3</span> <span class="content">Queue Tasks to Invoke Developer Code</span></a>
       </ol>
      <li>
       <a href="#accepting-promises"><span class="secno">4.3</span> <span class="content">Accepting Promises</span></a>
       <ol class="toc">
        <li><a href="#resolve-arguments"><span class="secno">4.3.1</span> <span class="content">Promise Arguments Should Be Resolved</span></a>
        <li><a href="#should-promise-call"><span class="secno">4.3.2</span> <span class="content">Developer-Supplied Promise-Returning Functions Should Be "Promise-Called"</span></a>
       </ol>
     </ol>
    <li>
     <a href="#shorthand-phrases"><span class="secno">5</span> <span class="content">Shorthand Phrases</span></a>
     <ol class="toc">
      <li><a href="#shorthand-creating"><span class="secno">5.1</span> <span class="content">Creating Promises</span></a>
      <li><a href="#shorthand-manipulating"><span class="secno">5.2</span> <span class="content">Manipulating Promises</span></a>
      <li><a href="#shorthand-reacting"><span class="secno">5.3</span> <span class="content">Reacting to Promises</span></a>
      <li><a href="#aggregating-promises"><span class="secno">5.4</span> <span class="content">Aggregating Promises</span></a>
      <li><a href="#shorthand-promise-calling"><span class="secno">5.5</span> <span class="content">Promise-Calling</span></a>
      <li><a href="#shorthand-note-onrealms"><span class="secno">5.6</span> <span class="content">A Note on Realms</span></a>
     </ol>
    <li>
     <a href="#examples"><span class="secno">6</span> <span class="content">Examples</span></a>
     <ol class="toc">
      <li><a href="#example-delay"><span class="secno">6.1</span> <span class="content">delay(<var>ms</var>)</span></a>
      <li><a href="#example-validated-delay"><span class="secno">6.2</span> <span class="content">validatedDelay(<var>ms</var>)</span></a>
      <li><a href="#example-add-delay"><span class="secno">6.3</span> <span class="content">addDelay(<var>promise</var>, <var>ms</var>)</span></a>
      <li><a href="#example-resource-open"><span class="secno">6.4</span> <span class="content">resource.open(<var>resourcePath</var>, <var>openingOperation</var>)</span></a>
      <li><a href="#example-environment-ready"><span class="secno">6.5</span> <span class="content">environment.ready</span></a>
      <li><a href="#example-add-bookmark"><span class="secno">6.6</span> <span class="content">addBookmark()</span></a>
      <li><a href="#example-batch-request"><span class="secno">6.7</span> <span class="content">batchRequest(<var>urls</var>)</span></a>
     </ol>
    <li>
     <a href="#webidl"><span class="secno">7</span> <span class="content">WebIDL and Promises</span></a>
     <ol class="toc">
      <li><a href="#webidl-promise-return-values"><span class="secno">7.1</span> <span class="content"><code>Promise&lt;T></code> Return Values</span></a>
      <li><a href="#webidl-promise-parameters"><span class="secno">7.2</span> <span class="content"><code>Promise&lt;T></code> Parameters</span></a>
      <li><a href="#webidl-developer-functions-returning-promises"><span class="secno">7.3</span> <span class="content">Developer Functions Returning Promises</span></a>
      <li><a href="#webidl-examples"><span class="secno">7.4</span> <span class="content">Examples</span></a>
     </ol>
    <li><a href="#legacy"><span class="secno"></span> <span class="content">Appendix: Legacy APIs for Asynchronicity</span></a>
    <li><a href="#conformance"><span class="secno"></span> <span class="content"> Conformance</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>A <em>promise</em> is an object that represents the eventual result of a single asynchronous operation. They can be returned from asynchronous functions, thus allowing consumers to not only queue up callbacks to be called when the operation succeeds or fails, but also to manipulate the returned promise object, opening up a variety of possibilities.</p>
   <p>Promises have been battle-tested in many JavaScript libraries, including as part of popular frameworks like Dojo, jQuery, YUI, Ember, Angular, WinJS, Q, and others. This culminated in the <a href="https://promisesaplus.com/">Promises/A+ community specification</a> which most libraries conformed to. Now, a standard <code>Promise</code> class is included <a href="https://tc39.github.io/ecma262/#sec-promise-objects">in the ECMAScript Language Specification</a> <a data-link-type="biblio" href="#biblio-ecmascript">[ECMASCRIPT]</a>, allowing web platform APIs to return promises for their asynchronous operations.</p>
   <p>Promises are now the web platform’s paradigm for all "one and done" asynchronous operations. Previously, specifications used a variety of mismatched mechanisms for such operations. Going forward, all asynchronous operations of this type should be specified to instead return promises, giving our platform a unified primitive for asynchronicity.</p>
   <div class="note" role="note">Although the primary audience of this document is specification writers, it is also useful for JavaScript developers who want to write libraries or applications using promises. We will call out sections that are spec-writer specific so developers can skip them more easily.</div>
   <h2 class="heading settled" data-level="2" id="when-to-use"><span class="secno">2. </span><span class="content">When to Use Promises</span><a class="self-link" href="#when-to-use"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="one-and-done"><span class="secno">2.1. </span><span class="content">One-and-Done Operations</span><a class="self-link" href="#one-and-done"></a></h3>
   <p>The primary use case for promises is returning them from a method that kicks off a single asynchronous operation. One should think of promise-returning functions as asynchronous functions, in contrast to normal synchronous functions; there is a very strong analogy here, and keeping it in mind makes such functions easier to write and reason about.</p>
   <p>For example, normal synchronous functions can either return a value or throw an exception. Asynchronous functions will, analogously, return a promise, which can either be fulfilled with a value, or rejected with a reason. Just like a synchronous function that returns "nothing" (i.e. <code>undefined</code>), promises returned by asynchronous functions can be fulfilled with nothing (<code>undefined</code>); in this case the promise fulfillment simply signals completion of the asynchronous operation.</p>
   <p>Examples of such asynchronous operations abound throughout web specifications:</p>
   <ul>
    <li data-md>
     <p>Asynchronous I/O operations: methods to read or write from a storage API could return a promise.</p>
    <li data-md>
     <p>Asynchronous network operations: methods to send or receive data over the network could return a promise.</p>
    <li data-md>
     <p>Long-running computations: methods that take a while to compute something could do the work on another thread, returning a promise for the result.</p>
    <li data-md>
     <p>User interface prompts: methods that ask the user for an answer could return a promise.</p>
   </ul>
   <p>Previously, web specifications used a large variety of differing patterns for asynchronous operations. We’ve documented these in an appendix below, so you can get an idea of what is now considered legacy. Now that we have promises as a platform primitive, such approaches are no longer necessary.</p>
   <h3 class="heading settled" data-level="2.2" id="one-time-events"><span class="secno">2.2. </span><span class="content">One-Time "Events"</span><a class="self-link" href="#one-time-events"></a></h3>
   <p>Because promises can be subscribed to even after they’ve already been fulfilled or rejected, they can be very useful for a certain class of "event." When something only happens once, and authors often want to observe the status of it after it’s already occurred, providing a promise that becomes fulfilled when that eventuality comes to pass gives a very convenient API.</p>
   <p>The prototypical example of such an "event" is a loaded indicator: a resource such as an image, font, or even document, could provide a <code>loaded</code> property that is a promise that becomes fulfilled only when the resource has fully loaded (or becomes rejected if there’s an error loading the resource). Then, authors can always queue up actions to be executed once the resource is ready by doing <code>resource.loaded.then(onLoaded, onFailure)</code>. This will work even if the resource was loaded already, queueing a microtask to execute <code>onLoaded</code>. This is in contrast to an event model, where if the author is not subscribed at the time the event fires, that information is lost.</p>
   <h3 class="heading settled" data-level="2.3" id="state-transitions"><span class="secno">2.3. </span><span class="content">More General State Transitions</span><a class="self-link" href="#state-transitions"></a></h3>
   <p>In certain cases, promises can be useful as a general mechanism for signaling state transitions. This usage is subtle, but can provide a very nice API for consumers when done correctly.</p>
   <p>One can think of this pattern as a generalization of the one-time "events" use case. For example, take <code>&lt;img></code> elements. By resetting their <code>src</code> property, they can be re-loaded; that is, they can transition back from a loaded state to an unloaded state. Thus becoming loaded is not a one-time occasion: instead, the image actually consists of a state machine that moves back and forth between loaded and unloaded states. In such a scenario, it is still useful to give images a promise-returning <code>loaded</code> property, which will signal the next state transition to a loaded state (or be already fulfilled if the image is already in a loaded state). This property should return the same promise every time it is retrieved, until the image moves backward from the loaded state into the unloaded state. Once that occurs, a new promise is created, representing the <em>next</em> transition to loaded.</p>
   <p>There are many places in the platform where this can be useful, not only for resources which can transition to loaded, but e.g. for animations that can transition to finished, or expensive resources that can transition to disposed, or caches that can become unloaded.</p>
   <p>A slight variant of this pattern occurs when your class contains a method that causes a state transition, and you want to indicate when that state transition completes. In that case you can return a promise from the method, instead of keeping it as a property on your object. The <a href="https://github.com/whatwg/streams/">streams API</a> uses this variant for its <code>wait()</code> and <code>close()</code> methods. In general, methods should be used for actions, and properties for informational state transitions.</p>
   <p>To close, we must caution against over-using this pattern. Not every state transition needs a corresponding promise-property. Indicators that it might be useful include:</p>
   <ul>
    <li data-md>
     <p>Authors are almost always interested in the <em>next</em> instance of that state transition, and rarely need recurring notification every time it occurs. For example, rarely do authors care to know every time an image element is reloaded; usually they simply care about the initial load of the image, or possibly the next one that occurs after resetting its <code>src</code>.</p>
    <li data-md>
     <p>Authors are often interested in reacting to transitions that have already occurred. For example, authors often want to run some code once an image is loaded; if the image is already loaded, they want to run the code as soon as possible.</p>
   </ul>
   <h2 class="heading settled" data-level="3" id="when-not-to-use"><span class="secno">3. </span><span class="content">When Not to Use Promises</span><a class="self-link" href="#when-not-to-use"></a></h2>
   <p>Although promises are widely applicable to asynchronous operations of many sorts, there are still situations where they are not appropriate, even for asynchronicity.</p>
   <h3 class="heading settled" data-level="3.1" id="recurring-events"><span class="secno">3.1. </span><span class="content">Recurring Events</span><a class="self-link" href="#recurring-events"></a></h3>
   <p>Any event that can occur more than once is not a good candidate for the "one and done" model of promises. There is no single asynchronous operation for the promise to represent, but instead a series of events. Conventional <code>EventTarget</code> usage is just fine here.</p>
   <h3 class="heading settled" data-level="3.2" id="streaming-data"><span class="secno">3.2. </span><span class="content">Streaming Data</span><a class="self-link" href="#streaming-data"></a></h3>
   <p>If the amount of data involved is potentially large, and could be produced incrementally, promises are probably not the right solution. Instead, you’ll want to use the under-development <a href="https://github.com/whatwg/streams">streams API</a>, which allows authors to process and compose data streams incrementally, without buffering the entire contents of the stream into memory.</p>
   <p>Note that in some cases, you could provide a promise API alongside a streaming API, as a convenience for those cases when buffering all the data into memory is not a concern. But this would be a supporting, not primary, role.</p>
   <h2 class="heading settled" data-level="4" id="api-design-guidance"><span class="secno">4. </span><span class="content">API Design Guidance</span><a class="self-link" href="#api-design-guidance"></a></h2>
   <p>There are a few subtle aspects of using or accepting promises in your API. Here we attempt to address commonly-encountered questions and situations.</p>
   <h3 class="heading settled" data-level="4.1" id="errors"><span class="secno">4.1. </span><span class="content">Errors</span><a class="self-link" href="#errors"></a></h3>
   <h4 class="heading settled" data-level="4.1.1" id="always-return-promises"><span class="secno">4.1.1. </span><span class="content">Promise-Returning Functions Should Always Return Promises</span><a class="self-link" href="#always-return-promises"></a></h4>
   <p>Promise-returning functions should always return a promise, under all circumstances. Even if the result is available synchronously, or the inputs can be detected as invalid synchronously, this information needs to be communicated through a uniform channel so that a developer can be sure that by doing</p>
<pre><code class="lang-javascript highlight">promiseFunction<c- p>()</c->
  <c- p>.</c->then<c- p>(</c->onSuccess<c- p>)</c->
  <c- p>.</c-><c- k>catch</c-><c- p>(</c->onFailure<c- p>);</c->
</code></pre>
   <p>they are handling all successes and all errors.</p>
   <p>In particular, promise-returning functions should never synchronously throw errors, since that would force duplicate error-handling logic on the consumer: once in a <code>catch (e) { ... }</code> block, and once in a <code>.catch(e => { ... })</code> block. Even argument validation errors are not OK. Instead, all errors should be signaled by returning rejected promises.</p>
   <p>For WebIDL-based specs, this is taken care of automatically <a href="https://heycam.github.io/webidl/#es-operations">by the WebIDL specification</a>: any exceptions thrown by WebIDL operations, or by the WebIDL overload resolution algorithm itself, are automatically converted into rejections. For an example of how to do manual validation, see the <code>validatedDelay</code> example below.</p>
   <h4 class="heading settled" data-level="4.1.2" id="reasons-should-be-errors"><span class="secno">4.1.2. </span><span class="content">Rejection Reasons Should Be <code>Error</code>s</span><a class="self-link" href="#reasons-should-be-errors"></a></h4>
   <p>Promise rejection reasons should always be instances of the ECMAScript <code>Error</code> type, just like synchronously-thrown exceptions should always be instances of <code>Error</code> as well.</p>
   <p>In particular, for DOM or other web platform specs, this means you should never use <code>DOMError</code>, but instead use <code>DOMException</code>, which <a href="https://heycam.github.io/webidl/#es-exceptions">per WebIDL</a> extends <code>Error</code>. You can of course also use one of the <a href="https://tc39.github.io/ecma262/#sec-error-objects">built-in ECMAScript error types</a>.</p>
   <h4 class="heading settled" data-level="4.1.3" id="rejections-should-be-exceptional"><span class="secno">4.1.3. </span><span class="content">Rejections Should Be Used for Exceptional Situations</span><a class="self-link" href="#rejections-should-be-exceptional"></a></h4>
   <p>What exactly you consider "exceptional" is up for debate, as always. But, you should always ask, before rejecting a promise: if this function was synchronous, would I expect a thrown exception under this circumstance? Or perhaps a failure value (like <code>null</code>, <code>false</code>, or <code>undefined</code>)? You should think about which behavior is more useful for consumers of your API. If you’re not sure, pretend your API is synchronous and then think if your developers would expect a thrown exception.</p>
   <p>Good cases for rejections include:</p>
   <ul>
    <li data-md>
     <p>A failed I/O operation, like writing to storage or reading from the network.</p>
    <li data-md>
     <p>When it will be impossible to complete the requested task: for example if the operation is <code>accessUsersContacts()</code> and the user denies permission, then it should return a rejected promise.</p>
    <li data-md>
     <p>Any situation where something is internally broken while attempting an asynchronous operation: for example if the developer passes in invalid data, or the environment is in an invalid state for this operation.</p>
   </ul>
   <p>Bad uses of rejections include:</p>
   <ul>
    <li data-md>
     <p>When a value is asked for asynchronously and is not found: for example <code>asyncMap.get("key")</code> should return a promise for <code>undefined</code> when there is no entry for <code>"key"</code>, and similarly <code>asyncMap.has("key")</code> should return a promise for <code>false</code>. The absence of <code>"key"</code> would be unexceptional, and so a rejected promise would be a poor choice.</p>
    <li data-md>
     <p>When the operation is phrased as a question, and the answer is negative: for example if the operation is <code>hasPermissionToAccessUsersContacts()</code> and the user has denied permission, then it should return a promise fulfilled with <code>false</code>; it should not reject.</p>
   </ul>
   <p>Cases where a judgement call will be necessary include:</p>
   <ul>
    <li data-md>
     <p>APIs that are more ambiguous about being a question versus a demand: for example <code>requestUsersContacts()</code> could return a promise fulfilled with <code>null</code> if the user denies permission, or it could return a promise rejected with an error stating that the user denied permission.</p>
   </ul>
   <h3 class="heading settled" data-level="4.2" id="async-algorithms"><span class="secno">4.2. </span><span class="content">Asynchronous Algorithms</span><a class="self-link" href="#async-algorithms"></a></h3>
   <div class="note" role="note">This section is primarily for spec writers, dealing with the vagaries of clearly manifesting asynchronous algorithm flow in prose. For more background on this subject, see <a href="https://annevankesteren.nl/2014/08/asynchronicity">Anne’s blog post on asynchronicity</a>.</div>
   <h4 class="heading settled" data-level="4.2.1" id="simply-resolve-or-reject"><span class="secno">4.2.1. </span><span class="content">Simply Resolve or Reject the Promise</span><a class="self-link" href="#simply-resolve-or-reject"></a></h4>
   <p>Unlike in the old world of callbacks, there’s no need to create separate callback types (e.g. in WebIDL) for your success and error cases. Instead, just resolve or reject your promise.</p>
   <h4 class="heading settled" data-level="4.2.2" id="explicit-async-steps"><span class="secno">4.2.2. </span><span class="content">Note Parallel Steps Explicitly</span><a class="self-link" href="#explicit-async-steps"></a></h4>
   <p>It is important to note which steps in your algorithms will be run in parallel with the author’s JavaScript code, i.e. without blocking script execution. This instructs implementers as to which operations will need to use e.g. a background thread or asychronous I/O calls. And it helps authors to know the expected sequencing of <em>their</em> operations with respect to those of your algorithm. To do this, use the phrase <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">in parallel</a> from <a data-link-type="biblio" href="#biblio-html">[HTML]</a>.</p>
   <p>As an example, the following steps will give a promise that is resolved after <var>ms</var> milliseconds:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise">a new promise</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel①">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise">Resolve</a> <var>p</var> with <b>undefined</b>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p>If we had omitted the "Run the following steps in parallel" heading, then the algorithm would have instructed implementers to block the main thread for <var>ms</var> milliseconds, which is very bad! Whereas as written, this algorithm correctly describes a non-blocking wait.</p>
   <h4 class="heading settled" data-level="4.2.3" id="queue-tasks"><span class="secno">4.2.3. </span><span class="content">Queue Tasks to Invoke Developer Code</span><a class="self-link" href="#queue-tasks"></a></h4>
   <p>Promises abstract away many of the details regarding notifying the developer about async operations. For example, you can say "<a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise①">resolve</a> <var>p</var> with <var>x</var>" instead of e.g. "<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task" id="ref-for-queue-a-task">queue a task</a> to call the callback <var>cb</var> with <var>x</var>," and it’s understood that this will use the normal promise mechanisms. (Namely, the developer can wait for fulfillment or rejection by passing callbacks to the promise’s <code>then</code> method, which will call those callbacks in the next microtask.) So in most cases, you will not need to explicitly queue tasks inside your promise-based asynchronous algorithms.</p>
   <p>However, in cases where you need to interface with developer code in more ways than can be mediated via the promise, you’ll still need to queue a task. For example, you may want to fire an event, which can call into developer event handlers. Or you may need to perform a structured clone operation, which <a href="http://lists.w3.org/Archives/Public/public-webcrypto/2014Mar/0141.html">can trigger getters</a>. If these things must be done inside the asynchronous portion of your algorithm, you need to specify that they are done via a queued task, and with a specific task queue. This nails down the exact time such developer-observable operations happen both in relation to other queued tasks, and to the microtask queue used by promises.</p>
   <p>As an example, the following steps will return a promise resolved after <var>ms</var> milliseconds, but also fire an event named <code>timerfinished</code> on an object <var>object</var>:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise①">a new promise</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel②">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise②">Resolve</a> <var>p</var> with <b>undefined</b>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task" id="ref-for-queue-a-task①">Queue a task</a> to <a href="https://html.spec.whatwg.org/multipage/webappapis.html#fire-a-simple-event">fire a simple event</a> named <code>timerfinished</code> at the <var>object</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="4.3" id="accepting-promises"><span class="secno">4.3. </span><span class="content">Accepting Promises</span><a class="self-link" href="#accepting-promises"></a></h3>
   <h4 class="heading settled" data-level="4.3.1" id="resolve-arguments"><span class="secno">4.3.1. </span><span class="content">Promise Arguments Should Be Resolved</span><a class="self-link" href="#resolve-arguments"></a></h4>
   <p>In general, when an argument is expected to be a promise, you should also allow thenables and non-promise values by <em>resolving</em> the argument to a promise before using it. You should <em>never</em> do a type-detection on the incoming value, or overload between promises and other values, or put promises in a union type.</p>
   <p>In WebIDL-using specs, this is automatically taken care of by the <a href="https://heycam.github.io/webidl/#es-promise">WebIDL promise type</a>. To see what it means in JavaScript, consider the following function, which adds a delay of <var>ms</var> milliseconds to a promise:</p>
   <div class="example" id="example-b33c14b3">
    <a class="self-link" href="#example-b33c14b3"></a> 
<pre><code class="lang-javascript highlight"><c- a>function</c-> addDelay<c- p>(</c->promise<c- p>,</c-> ms<c- p>)</c-> <c- p>{</c->
    <c- k>return</c-> Promise<c- p>.</c->resolve<c- p>(</c->promise<c- p>).</c->then<c- p>(</c->v <c- p>=></c->
        <c- k>new</c-> Promise<c- p>(</c->resolve <c- p>=></c->
            setTimeout<c- p>(()</c-> <c- p>=></c-> resolve<c- p>(</c->v<c- p>),</c-> ms<c- p>);</c->
        <c- p>)</c->
    <c- p>);</c->
<c- p>}</c->

<c- a>var</c-> p1 <c- o>=</c-> addDelay<c- p>(</c->doAsyncOperation<c- p>(),</c-> <c- mi>500</c-><c- p>);</c->
<c- a>var</c-> p2 <c- o>=</c-> addDelay<c- p>(</c-><c- u>"value"</c-><c- p>,</c-> <c- mi>1000</c-><c- p>);</c->
</code></pre>
   </div>
   <p>In this example, <code>p1</code> will be fulfilled 500 ms after the promise returned by <code>doAsyncOperation()</code> fulfills, with that operation’s value. (Or <code>p1</code> will reject as soon as that promise rejects.) And, since we resolve the incoming argument to a promise, the function can also work when you pass it the string <code>"value"</code>: <code>p2</code> will be fulfilled with <code>"value"</code> after 1000 ms. In this way, we essentially treat it as an immediately-fulfilled promise for that value.</p>
   <h4 class="heading settled" data-level="4.3.2" id="should-promise-call"><span class="secno">4.3.2. </span><span class="content">Developer-Supplied Promise-Returning Functions Should Be "Promise-Called"</span><a class="self-link" href="#should-promise-call"></a></h4>
   <p>If the developer supplies you with a function that you expect to return a promise, you should also allow it to return a thenable or non-promise value, or even throw an exception, and treat all these cases as if they had returned an analogous promise. We can encapsulate this process in an operation called <a href="#promise-calling" id="ref-for-promise-calling">promise-calling</a> the supplied function. This allows us to have the same reaction to synchronous forms of success and failure that we would to asynchronous forms.</p>
   <p>See the <a href="#example-resource-open"><code>resource.open</code> example</a> below for further discussion of how and why this should be used.</p>
   <h2 class="heading settled" data-level="5" id="shorthand-phrases"><span class="secno">5. </span><span class="content">Shorthand Phrases</span><a class="self-link" href="#shorthand-phrases"></a></h2>
   <div class="note" role="note">This section is primarily for spec writers, dealing with ways of performing common promise operations in prose.</div>
   <div class="note" role="note">This section should eventually move to WebIDL, where it belongs. See <a href="https://github.com/w3ctag/promises-guide/issues/27">#27</a>.</div>
   <p>When writing such specifications, it’s convenient to be able to refer to common promise operations concisely. We define here a set of shorthands that allow you to do so.</p>
   <h3 class="heading settled" data-level="5.1" id="shorthand-creating"><span class="secno">5.1. </span><span class="content">Creating Promises</span><a class="self-link" href="#shorthand-creating"></a></h3>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="a-new-promise">A new promise</dfn>" gives a new, initialized-but-unresolved promise object to manipulate further. It is equivalent to calling <code>new Promise((resolve, reject) => { ... })</code>, using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise-constructor">the <code>Promise</code> constructor</a>. Here <code>...</code> stands in for code that saves the value of <code>resolve</code> and <code>reject</code> for later use by the shorthands under <a href="#shorthand-manipulating">§ 5.2 Manipulating Promises</a>.</p>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="a-promise-resolved-with">A promise resolved with</dfn> <var>x</var>" or "<var>x</var> <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="resolved-as-a-promise">resolved as a promise</dfn>" is shorthand for the result of <code>Promise.resolve(x)</code>, using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise.resolve"><code>Promise.resolve</code></a>.</p>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="a-promise-rejected-with">A promise rejected with</dfn> <var>r</var>" is shorthand for the result of <code>Promise.reject(r)</code>, using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise.reject"><code>Promise.reject</code></a>.</p>
   <h3 class="heading settled" data-level="5.2" id="shorthand-manipulating"><span class="secno">5.2. </span><span class="content">Manipulating Promises</span><a class="self-link" href="#shorthand-manipulating"></a></h3>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="resolve-promise">Resolve</dfn> <var>p</var> with <var>x</var>" is shorthand for calling a previously-stored <a href="https://tc39.github.io/ecma262/#sec-promise-resolve-functions"><code>resolve</code> function</a> from creating <code>p</code>, with argument <code>x</code>.</p>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="reject-promise">Reject</dfn> <var>p</var> with <var>r</var>" is shorthand for calling a previously-stored <a href="https://tc39.github.io/ecma262/#sec-promise-reject-functions"><code>reject</code> function</a> from creating <code>p</code>, with argument <code>r</code>.</p>
   <p>If the algorithm using these shorthands is running <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel③">in parallel</a>, the shorthands <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task" id="ref-for-queue-a-task②">queue a task</a> on <var>p</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop" id="ref-for-responsible-event-loop">responsible event loop</a> to call the stored function.</p>
   <h3 class="heading settled" data-level="5.3" id="shorthand-reacting"><span class="secno">5.3. </span><span class="content">Reacting to Promises</span><a class="self-link" href="#shorthand-reacting"></a></h3>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="upon-fulfillment">Upon fulfillment</dfn> of <var>p</var> with value <var>v</var>" is shorthand for calling <code>p.then(onFulfilled)</code>, with the successive nested steps comprising the <code>onFulfilled</code> function, and using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise.prototype.then"><code>Promise.prototype.then</code></a>. The steps then have access to <code>onFulfilled</code>’s argument as <var>v</var>.</p>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="upon-rejection">Upon rejection</dfn> of <var>p</var> with reason <var>r</var>" is shorthand for calling <code>p.then(undefined, onRejected)</code>, with the successive nested steps comprising the <code>onRejected</code> function, and using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise.prototype.then"><code>Promise.prototype.then</code></a>. The steps then have access to <code>onRejected</code>’s argument as <var>r</var>.</p>
   <p>"<dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="transforming-by">Transforming</dfn> <var>p</var> with a fulfillment and/or rejection handler" is shorthand for calling <code>p.then(fulfillmentHandler, rejectionHandler)</code>, using the initial value of <a href="https://tc39.github.io/ecma262/#sec-promise.prototype.then"><code>Promise.prototype.then</code></a>.</p>
   <div class="example" id="example-199490f9">
    <a class="self-link" href="#example-199490f9"></a> Some examples of the latter phrase would be 
    <ol>
     <li data-md>
      <p>Return the result of <a data-link-type="dfn" href="#transforming-by" id="ref-for-transforming-by">transforming</a> <var>p</var> with a fulfillment handler that returns <b>undefined</b>.</p>
    </ol>
    <p>or</p>
    <ol>
     <li data-md>
      <p>Return the result of <a data-link-type="dfn" href="#transforming-by" id="ref-for-transforming-by①">transforming</a> <var>p</var> with a fulfillment handler that returns twice its first argument.</p>
    </ol>
    <p>These correspond to</p>
<pre><code class="lang-javascript highlight"><c- k>return</c-> p<c- p>.</c->then<c- p>(()</c-> <c- p>=></c-> <c- kc>undefined</c-><c- p>);</c->
</code></pre>
    <p>and</p>
<pre><code class="lang-javascript highlight"><c- k>return</c-> p<c- p>.</c->then<c- p>(</c->x <c- p>=></c-> <c- mi>2</c-> <c- o>*</c-> x<c- p>);</c->
</code></pre>
    <p>respectively. (More complicated transforms are of course possible as well, as shown in the <a href="#example-resource-open"><code>resource.open</code> example</a> below.)</p>
   </div>
   <h3 class="heading settled" data-level="5.4" id="aggregating-promises"><span class="secno">5.4. </span><span class="content">Aggregating Promises</span><a class="self-link" href="#aggregating-promises"></a></h3>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="wait for all|waiting for all" id="waiting-for-all">wait for all</dfn> of a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of promises <var>promises</var>, with success steps <var>successSteps</var> that take a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a> of JavaScript values and failure steps <var>failureSteps</var> that take a rejection reason JavaScript value, perform the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>fullfilledCount</var> be 0.</p>
    <li data-md>
     <p>Let <var>rejected</var> be false.</p>
    <li data-md>
     <p>Let <var>rejectionHandler</var> be a built-in function that takes an argument <var>arg</var> and performs the following steps:</p>
     <ol>
      <li data-md>
       <p>If <var>rejected</var> is true, abort these steps.</p>
      <li data-md>
       <p>Set <var>rejected</var> to true.</p>
      <li data-md>
       <p>Perform <var>failureSteps</var> given <var>arg</var>.</p>
     </ol>
    <li data-md>
     <p>Let <var>index</var> be 0.</p>
    <li data-md>
     <p>Let <var>total</var> be <var>promises</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size">size</a>.</p>
    <li data-md>
     <p>Let <var>result</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> containing <var>total</var> null values.</p>
    <li data-md>
     <p>If <var>total</var> is 0, then:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask" id="ref-for-queue-a-microtask">Queue a microtask</a> to perform <var>successSteps</var> given <var>result</var>.</p>
      <li data-md>
       <p>Return.</p>
     </ol>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>promise</var> of <var>promises</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>promiseIndex</var> be <var>index</var>.</p>
      <li data-md>
       <p>Let <var>fulfillmentHandler</var> be a built-in function that takes an argument <var>arg</var> performs the following steps:</p>
       <ol>
        <li data-md>
         <p>Set <var>result</var>[<var>promiseIndex</var>] to <var>arg</var>.</p>
        <li data-md>
         <p>Set <var>fullfilledCount</var> to <var>fullfilledCount</var> + 1.</p>
        <li data-md>
         <p>If <var>fullfilledCount</var> equals <var>total</var>, then perform <var>successSteps</var> given <var>result</var>.</p>
       </ol>
      <li data-md>
       <p>Perform <a data-link-type="abstract-op" href="https://tc39.github.io/ecma262/#sec-performpromisethen" id="ref-for-sec-performpromisethen">PerformPromiseThen</a>(<var>promise</var>, <var>fulfillmentHandler</var>, <var>rejectionHandler</var>).</p>
      <li data-md>
       <p>Set <var>index</var> to <var>index</var> + 1.</p>
     </ol>
   </ol>
   <p>This phrase is useful when you wish to aggregate the result of multiple promises, and react to them all together, in the same way that <code class="idl"><a data-link-type="idl" href="https://tc39.github.io/ecma262/#sec-promise.all" id="ref-for-sec-promise.all">Promise.all()</a></code> functions for JavaScript code.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-lt="get a promise to wait for all|getting a promise to wait for all" id="waiting-for-all-promise">get a promise for waiting for all</dfn> of a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">list</a> of promises <var>promises</var>, with success steps <var>successSteps</var> that take a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a> of JavaScript values and optional failure steps <var>failureSteps</var> that take a rejection reason JavaScript value, perform the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>promise</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise②">a new promise</a>.</p>
    <li data-md>
     <p>If <var>failureSteps</var> were not given, let them be steps taking an argument <var>arg</var> that throw <var>arg</var>.</p>
    <li data-md>
     <p>Let <var>successStepsWrapper</var> be the following steps, given <var>results</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>stepsResult</var> be the result of performing <var>successSteps</var> given <var>results</var>. If these steps threw an exception, <a data-link-type="dfn" href="#reject-promise" id="ref-for-reject-promise">reject</a> <var>promise</var> with that exception.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise③">Resolve</a> <var>promise</var> with <var>stepsResult</var>.</p>
     </ol>
    <li data-md>
     <p>Let <var>failureStepsWrapper</var> be the following steps, given <var>reason</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>stepsResult</var> be the result of performing <var>failureSteps</var> given <var>reason</var>. If these steps threw an exception, <a data-link-type="dfn" href="#reject-promise" id="ref-for-reject-promise①">reject</a> <var>promise</var> with that exception.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise④">Resolve</a> <var>promise</var> with <var>stepsResult</var>.</p>
     </ol>
    <li data-md>
     <p><a data-link-type="dfn" href="#waiting-for-all" id="ref-for-waiting-for-all">Wait for all</a> of <var>promises</var>, given <var>successStepsWrapper</var> and <var>failureStepsWrapper</var>.</p>
    <li data-md>
     <p>Return <var>promise</var>.</p>
   </ol>
   <p>This phrase is useful when you wish to aggregate the results of multiple promises, and then produce another promise from them.</p>
   <p>An example usage of this phrase is found in <a href="#example-batch-request">§ 6.7 batchRequest(urls)</a>.</p>
   <h3 class="heading settled" data-level="5.5" id="shorthand-promise-calling"><span class="secno">5.5. </span><span class="content">Promise-Calling</span><a class="self-link" href="#shorthand-promise-calling"></a></h3>
   <p>The result of <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="promise-calling">promise-calling</dfn> <var>f</var>(...<var>args</var>) is:</p>
   <ul>
    <li data-md>
     <p>If the call returns a value <var>v</var>, the result of <a href="#resolved-as-a-promise" id="ref-for-resolved-as-a-promise">resolving</a> <var>v</var> as a promise.</p>
    <li data-md>
     <p>If the call throws an exception <var>e</var>, a promise <a href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with">rejected with</a> <var>e</var>.</p>
   </ul>
   <div class="note" id="promise-call-in-js" role="note">
    <a class="self-link" href="#promise-call-in-js"></a> In JavaScript, you might express promise-calling this way: 
<pre><code class="lang-javascript highlight"><c- a>function</c-> promiseCall<c- p>(</c->f<c- p>,</c-> <c- p>...</c->args<c- p>)</c-> <c- p>{</c->
    <c- k>try</c-> <c- p>{</c->
        <c- k>return</c-> Promise<c- p>.</c->resolve<c- p>(</c->f<c- p>(...</c->args<c- p>));</c->
    <c- p>}</c-> <c- k>catch</c-> <c- p>(</c->e<c- p>)</c-> <c- p>{</c->
        <c- k>return</c-> Promise<c- p>.</c->reject<c- p>(</c->e<c- p>);</c->
    <c- p>}</c->
<c- p>}</c->
</code></pre>
   </div>
   <h3 class="heading settled" data-level="5.6" id="shorthand-note-onrealms"><span class="secno">5.6. </span><span class="content">A Note on Realms</span><a class="self-link" href="#shorthand-note-onrealms"></a></h3>
   <p>In all cases, when we use phrases like "the initial value of <code>Promise.resolve</code>," we mean the initial value within the <a href="https://tc39.github.io/ecma262/#sec-code-realms">realm</a> associated to the function being specified. So for example, if <code>window.f()</code> is specified to return "<a data-link-type="dfn" href="#a-promise-resolved-with" id="ref-for-a-promise-resolved-with">a promise resolved with</a> <b>1</b>," then:</p>
<pre><code class="lang-javascript highlight">assert<c- p>(</c->windowA<c- p>.</c->f<c- p>().</c->constructor <c- o>===</c-> windowA<c- p>.</c->Promise<c- p>);</c->
assert<c- p>(</c->windowB<c- p>.</c->f<c- p>().</c->constructor <c- o>===</c-> windowB<c- p>.</c->Promise<c- p>);</c->

<c- c1>// The realm of the object the function is being invoked on has no effect;</c->
<c- c1>// the function’s realm is all that matters.</c->
assert<c- p>(</c->windowA<c- p>.</c->f<c- p>.</c->call<c- p>(</c->windowB<c- p>).</c->constructor <c- o>===</c-> windowA<c- p>.</c->Promise<c- p>);</c->

<c- c1>// This means mutations to the Promise constructor also propagate.</c->
windowA<c- p>.</c->Promise<c- p>.</c->prototype<c- p>.</c->foo <c- o>=</c-> <c- u>"bar"</c-><c- p>;</c->
assert<c- p>(</c->windowA<c- p>.</c->f<c- p>().</c->foo <c- o>===</c-> <c- u>"bar"</c-><c- p>);</c->
assert<c- p>(</c->windowB<c- p>.</c->f<c- p>().</c->foo <c- o>===</c-> <c- kc>undefined</c-><c- p>);</c->

<c- c1>// But since the algorithm for Promise.resolve uses the un-modifiable %Promise%</c->
<c- c1>// intrinsic, instead of consulting the global, modifying the global property named</c->
<c- c1>// "Promise" does not impact the return value.</c->
<c- kr>const</c-> oldPromise <c- o>=</c-> windowA<c- p>.</c->Promise<c- p>;</c->
windowA<c- p>.</c->Promise <c- o>=</c-> <c- p>()</c-> <c- p>=></c-> <c- k>throw</c-> <c- k>new</c-> Error<c- p>(</c-><c- u>"I break developer code, but not platform code!"</c-><c- p>);</c->
assert<c- p>(</c->windowA<c- p>.</c->f<c- p>().</c->constructor <c- o>!==</c-> windowA<c- p>.</c->Promise<c- p>);</c->
assert<c- p>(</c->windowA<c- p>.</c->f<c- p>().</c->constructor <c- o>===</c-> oldPromise<c- p>);</c->
</code></pre>
   <p>For more information, see <a href="http://lists.w3.org/Archives/Public/www-tag/2014Jan/0108.html">this www-tag thread</a>, especially the replies.</p>
   <h2 class="heading settled" data-level="6" id="examples"><span class="secno">6. </span><span class="content">Examples</span><a class="self-link" href="#examples"></a></h2>
   <div class="note" role="note">This section is mostly for spec writers, although it does give examples of the spec prose translated into JavaScript.</div>
   <h3 class="heading settled" data-level="6.1" id="example-delay"><span class="secno">6.1. </span><span class="content">delay(<var>ms</var>)</span><a class="self-link" href="#example-delay"></a></h3>
   <p><code>delay</code> is a function that returns a promise that will be fulfilled in <var>ms</var> milliseconds. It illustrates how simply you can resolve a promise, with one line of prose.</p>
   <ol>
    <li data-md>
     <p>Let <var>ms</var> be ToNumber(<var>ms</var>).</p>
    <li data-md>
     <p>If <var>ms</var> is <b>NaN</b>, let <var>ms</var> be <b>+0</b>; otherwise let <var>ms</var> be the maximum of <var>ms</var> and <b>+0</b>.</p>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise③">a new promise</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel④">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise⑤">Resolve</a> <var>p</var> with <b>undefined</b>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p>The equivalent function in JavaScript would be</p>
<pre><code class="lang-javascript highlight"><c- a>function</c-> delay<c- p>(</c->ms<c- p>)</c-> <c- p>{</c->
    ms <c- o>=</c-> Number<c- p>(</c->ms<c- p>);</c->
    ms <c- o>=</c-> Number<c- p>.</c->isNaN<c- p>(</c->ms<c- p>)</c-> <c- o>?</c-> <c- o>+</c-><c- mi>0</c-> <c- o>:</c-> Math<c- p>.</c->max<c- p>(</c->ms<c- p>,</c-> <c- o>+</c-><c- mi>0</c-><c- p>);</c->
    <c- k>return</c-> <c- k>new</c-> Promise<c- p>(</c->resolve <c- p>=></c-> setTimeout<c- p>(</c->resolve<c- p>,</c-> ms<c- p>));</c->
<c- p>}</c->
</code></pre>
   <p>or, in a more one-to-one correspondence with the specified steps,</p>
<pre><code class="lang-javascript highlight"><c- a>function</c-> delay<c- p>(</c->ms<c- p>)</c-> <c- p>{</c->
    <c- c1>// Steps 1, 2</c->
    ms <c- o>=</c-> Number<c- p>(</c->ms<c- p>);</c->
    ms <c- o>=</c-> Number<c- p>.</c->isNaN<c- p>(</c->ms<c- p>)</c-> <c- o>?</c-> <c- o>+</c-><c- mi>0</c-> <c- o>:</c-> Math<c- p>.</c->max<c- p>(</c->ms<c- p>,</c-> <c- o>+</c-><c- mi>0</c-><c- p>);</c->

    <c- c1>// Step 3</c->
    <c- a>let</c-> resolve<c- p>;</c->
    <c- kr>const</c-> p <c- o>=</c-> <c- k>new</c-> Promise<c- p>(</c->r <c- p>=></c-> <c- p>{</c-> resolve <c- o>=</c-> r<c- p>;</c-> <c- p>});</c->

    <c- c1>// Step 4</c->
    setTimeout<c- p>(()</c-> <c- p>=></c-> resolve<c- p>(</c-><c- kc>undefined</c-><c- p>),</c-> ms<c- p>);</c->

    <c- c1>// Step 5</c->
    <c- k>return</c-> p<c- p>;</c->
<c- p>}</c->
</code></pre>
   <h3 class="heading settled" data-level="6.2" id="example-validated-delay"><span class="secno">6.2. </span><span class="content">validatedDelay(<var>ms</var>)</span><a class="self-link" href="#example-validated-delay"></a></h3>
   <p>The <code>validatedDelay</code> function is much like <a href="#example-delay">the <code>delay</code> function</a>, except it will validate its arguments. This shows how to use rejected promises to signal immediate failure before even starting any asynchronous operations.</p>
   <ol>
    <li data-md>
     <p>Let <var>ms</var> be ToNumber(<var>ms</var>).</p>
    <li data-md>
     <p>If <var>ms</var> is <b>NaN</b>, return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with⑥">a promise rejected with</a> a <b>TypeError</b>.</p>
    <li data-md>
     <p>If <var>ms</var> is less than zero, return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with①">a promise rejected with</a> a <b>RangeError</b>.</p>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise④">a new promise</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel⑤">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise⑥">Resolve</a> <var>p</var> with <b>undefined</b>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p>The equivalent function in JavaScript would be</p>
<pre><code class="lang-javascript highlight"><c- a>function</c-> delay<c- p>(</c->ms<c- p>)</c-> <c- p>{</c->
    ms <c- o>=</c-> Number<c- p>(</c->ms<c- p>);</c->

    <c- k>if</c-> <c- p>(</c->Number<c- p>.</c->isNaN<c- p>(</c->ms<c- p>))</c-> <c- p>{</c->
        <c- k>return</c-> Promise<c- p>.</c->reject<c- p>(</c-><c- k>new</c-> TypeError<c- p>(</c-><c- u>"Not a number."</c-><c- p>));</c->
    <c- p>}</c->
    <c- k>if</c-> <c- p>(</c->ms <c- o>&lt;</c-> <c- mi>0</c-><c- p>)</c-> <c- p>{</c->
        <c- k>return</c-> Promise<c- p>.</c->reject<c- p>(</c-><c- k>new</c-> RangeError<c- p>(</c-><c- u>"ms must be at least zero."</c-><c- p>));</c->
    <c- p>}</c->

    <c- k>return</c-> <c- k>new</c-> Promise<c- p>(</c->resolve <c- p>=></c-> setTimeout<c- p>(</c->resolve<c- p>,</c-> ms<c- p>));</c->
<c- p>}</c->
</code></pre>
   <h3 class="heading settled" data-level="6.3" id="example-add-delay"><span class="secno">6.3. </span><span class="content">addDelay(<var>promise</var>, <var>ms</var>)</span><a class="self-link" href="#example-add-delay"></a></h3>
   <p><code>addDelay</code> is a function that adds an extra <var>ms</var> milliseconds of delay between <var>promise</var> settling and the returned promise settling. Notice how it resolves the incoming argument to a promise, so that you could pass it a non-promise value or a thenable.</p>
   <ol>
    <li data-md>
     <p>Let <var>ms</var> be ToNumber(<var>ms</var>).</p>
    <li data-md>
     <p>If <var>ms</var> is <b>NaN</b>, let <var>ms</var> be <b>+0</b>; otherwise let <var>ms</var> be the maximum of <var>ms</var> and <b>+0</b>.</p>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise⑤">a new promise</a>.</p>
    <li data-md>
     <p>Let <var>resolvedToPromise</var> be the result of resolving <var>promise</var> to a promise.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#upon-fulfillment" id="ref-for-upon-fulfillment">Upon fulfillment</a> of <var>resolvedToPromise</var> with value <var>v</var>, perform the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel⑥">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise⑦">Resolve</a> <var>p</var> with <var>v</var>.</p>
     </ol>
    <li data-md>
     <p><a data-link-type="dfn" href="#upon-rejection" id="ref-for-upon-rejection">Upon rejection</a> of <var>resolvedToPromise</var> with reason <var>r</var>, perform the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel⑦">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Wait <var>ms</var> milliseconds.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#reject-promise" id="ref-for-reject-promise②">Reject</a> <var>p</var> with <var>r</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p>The equivalent function in JavaScript would be</p>
<pre><code class="lang-javascript highlight"><c- a>function</c-> addDelay<c- p>(</c->promise<c- p>,</c-> ms<c- p>)</c-> <c- p>{</c->
    ms <c- o>=</c-> Number<c- p>(</c->ms<c- p>);</c->
    ms <c- o>=</c-> Number<c- p>.</c->isNaN<c- p>(</c->ms<c- p>)</c-> <c- o>?</c-> <c- o>+</c-><c- mi>0</c-> <c- o>:</c-> Math<c- p>.</c->max<c- p>(</c->ms<c- p>,</c-> <c- o>+</c-><c- mi>0</c-><c- p>);</c->

    <c- a>let</c-> resolve<c- p>,</c-> reject<c- p>;</c->
    <c- kr>const</c-> p <c- o>=</c-> <c- k>new</c-> Promise<c- p>((</c->r<c- p>,</c-> rr<c- p>)</c-> <c- p>=></c-> <c- p>{</c-> resolve <c- o>=</c-> r<c- p>;</c-> reject <c- o>=</c-> rr<c- p>;</c-> <c- p>});</c->

    <c- kr>const</c-> resolvedToPromise <c- o>=</c-> Promise<c- p>.</c->resolve<c- p>(</c->promise<c- p>);</c->
    resolvedToPromise<c- p>.</c->then<c- p>(</c->
        v <c- p>=></c-> setTimeout<c- p>(()</c-> <c- p>=></c-> resolve<c- p>(</c->v<c- p>),</c-> ms<c- p>),</c->
        r <c- p>=></c-> setTimeout<c- p>(()</c-> <c- p>=></c-> reject<c- p>(</c->r<c- p>),</c-> ms<c- p>)</c->
    <c- p>);</c->

    <c- k>return</c-> p<c- p>;</c->
<c- p>}</c->
</code></pre>
   <h3 class="heading settled" data-level="6.4" id="example-resource-open"><span class="secno">6.4. </span><span class="content">resource.open(<var>resourcePath</var>, <var>openingOperation</var>)</span><a class="self-link" href="#example-resource-open"></a></h3>
   <p><code>resource.open</code> is a method that executes the passed function <var>openingOperation</var> to do most of its work, but then updates the <code>resource</code>’s properties to reflect the result of this operation. It is a simplified version of some of the techniques used in the streams specification. The method is meant to illustrate how and why you might <a href="#promise-calling" id="ref-for-promise-calling①">promise-call</a> another function.</p>
   <ol>
    <li data-md>
     <p>Let <var>resourcePath</var> be ToString(<var>resourcePath</var>).</p>
    <li data-md>
     <p>Let <var>openingPromise</var> be the result of <a href="#promise-calling" id="ref-for-promise-calling②">promise-calling</a> <var>openingOperation</var>(<var>resourcePath</var>).</p>
    <li data-md>
     <p>Return the result of <a data-link-type="dfn" href="#transforming-by" id="ref-for-transforming-by②">transforming</a> <var>openingPromise</var> with:</p>
     <ol>
      <li data-md>
       <p>A fulfillment handler that sets <code>this.status</code> to <code>"opened"</code>.</p>
      <li data-md>
       <p>
        A rejection handler that, when called with argument <var>r</var>, set <code>this.status</code> to 
        <cod>"errored" and <code>this.error</code> to <var>r</var>.</cod>
       </p>
     </ol>
   </ol>
   <p>The equivalent function in JavaScript would be</p>
<pre><code class="lang-javascript highlight">resource<c- p>.</c->open <c- o>=</c-> <c- a>function</c-> <c- p>(</c->resourcePath<c- p>,</c-> openingOperation<c- p>)</c-> <c- p>{</c->
    resourcePath <c- o>=</c-> String<c- p>(</c->resourcePath<c- p>);</c->

    <c- k>return</c-> promiseCall<c- p>(</c->openingOperation<c- p>,</c-> resourcePath<c- p>).</c->then<c- p>(</c->
        v <c- p>=></c-> <c- p>{</c->
            <c- k>this</c-><c- p>.</c->status <c- o>=</c-> <c- u>"opened"</c-><c- p>;</c->
        <c- p>},</c->
        r <c- p>=></c-> <c- p>{</c->
            <c- k>this</c-><c- p>.</c->status <c- o>=</c-> <c- u>"errored"</c-><c- p>;</c->
            <c- k>this</c-><c- p>.</c->error <c- o>=</c-> r<c- p>;</c->
        <c- p>}</c->
    <c- p>);</c->
<c- p>};</c->
</code></pre>
   <p>using <a href="#promise-call-in-js">the <code>promiseCall</code> function defined above</a>.</p>
   <div class="note" role="note">
     Note how if we had instead just called <code>openingOperation</code>, i.e. done <code>openingOperation(resourcePath)</code> directly, then code like 
<pre><code class="lang-javascript highlight">resource<c- p>.</c->open<c- p>(</c->synchronouslyOpenTheResource<c- p>).</c->then<c- p>(</c->doSomethingElse<c- p>);</c->
</code></pre>
    <p>would fail. It would not return a promise, so calling <code>then</code> on the return value would fail. Even if we accounted for that, what if <code>synchronouslyOpenTheResource</code> threw an error? We would want that to result in an <code>"errored"</code> status, but without promise-calling, that would not be the case: the error would simply cause <code>resource.open</code> to exit. So you can see that promise-calling is quite helpful here.</p>
   </div>
   <h3 class="heading settled" data-level="6.5" id="example-environment-ready"><span class="secno">6.5. </span><span class="content">environment.ready</span><a class="self-link" href="#example-environment-ready"></a></h3>
   <p><code>environment.ready</code> is a property that signals when some part of some environment becomes "ready," e.g. a DOM document. It illustrates how to encode environmental asynchronicity.</p>
   <p>Let every <code>Environment</code> object have a [[ready]] internal slot, initialized with <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise⑥">a new promise</a>. When the getter for <code>environment.ready</code> is called, return the value of this <code>Environment</code> object’s [[ready]] internal slot.</p>
   <p>The following steps might be inserted toward the end of some algorithm for readying <code>Environment</code> objects:</p>
   <ol>
    <li data-md>
     <p>If the environment becomes ready successfully, <a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise⑧">resolve</a> this <code>Environment</code> object’s [[ready]] promise with <b>undefined</b>.</p>
    <li data-md>
     <p>If the environment fails to become ready, <a data-link-type="dfn" href="#reject-promise" id="ref-for-reject-promise③">reject</a> this <code>Environment</code> object’s [[ready]] promise with an <b>Error</b> instance explaining the load failure.</p>
   </ol>
   <h3 class="heading settled" data-level="6.6" id="example-add-bookmark"><span class="secno">6.6. </span><span class="content">addBookmark()</span><a class="self-link" href="#example-add-bookmark"></a></h3>
   <p><code>addBookmark</code> is a function that requests that the user add the current web page as a bookmark. It’s drawn from <a href="https://github.com/domenic/promises-unwrapping/issues/85">some iterative design work</a> and illustrates a more real-world scenario of appealing to environmental asynchrony, as well as immediate rejections.</p>
   <ol>
    <li data-md>
     <p>If this method was not invoked as a result of explicit user action, return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with②">a promise rejected with</a> a new <code>DOMException</code> whose name is <code>"SecurityError"</code>.</p>
    <li data-md>
     <p>If the document’s mode of operation is standalone, return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with③">a promise rejected with</a> a new <code>DOMException</code> whose name is <code>"NotSupported"</code>.</p>
    <li data-md>
     <p>Let <var>promise</var> be <a data-link-type="dfn" href="#a-new-promise" id="ref-for-a-new-promise⑦">a new promise</a>.</p>
    <li data-md>
     <p>Let <var>info</var> be the result of getting a web application’s metadata.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel⑧">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Using <var>info</var>, and in a manner that is user-agent specific, allow the end user to make a choice as to whether they want to add the bookmark.</p>
       <ol>
        <li data-md>
         <p>If the end-user aborts the request to add the bookmark (e.g., they hit escape, or press a "cancel" button), <a data-link-type="dfn" href="#reject-promise" id="ref-for-reject-promise④">reject</a> <var>promise</var> with a new <code>DOMException</code> whose name is <code>"AbortError"</code>.</p>
        <li data-md>
         <p>Otherwise, <a data-link-type="dfn" href="#resolve-promise" id="ref-for-resolve-promise⑨">resolve</a> <var>promise</var> with <b>undefined</b>.</p>
       </ol>
     </ol>
    <li data-md>
     <p>Return <var>promise</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="6.7" id="example-batch-request"><span class="secno">6.7. </span><span class="content">batchRequest(<var>urls</var>)</span><a class="self-link" href="#example-batch-request"></a></h3>
   <p>Several places in <a data-link-type="biblio" href="#biblio-service-workers">[SERVICE-WORKERS]</a> use <a data-link-type="dfn" href="#waiting-for-all-promise" id="ref-for-waiting-for-all-promise">get a promise to wait for all</a>. <code>batchRequest</code> illustrates a simplified version of one of their uses. It takes as input a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">list</a> of URLs, and returns a promise for an array of <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#response" id="ref-for-response">Response</a></code> objects created by fetching the corresponding URL. If any of the fetches fail, it will return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with④">a promise rejected with</a> that failure.</p>
   <ol>
    <li data-md>
     <p>Let <var>responsePromises</var> be a new empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑥">list</a>.</p>
    <li data-md>
     <p>For each value <var>url</var> of <var>urls</var>,</p>
     <ol>
      <li data-md>
       <p>Let <var>url</var> be the result of converting <var>url</var> to a <code class="idl"><a data-link-type="idl" href="https://heycam.github.io/webidl/#idl-USVString" id="ref-for-idl-USVString">USVString</a></code>.</p>
      <li data-md>
       <p>Let <var>req</var> be the result of creating a new <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#request" id="ref-for-request">Request</a></code> passing <var>url</var> to the constructor.</p>
      <li data-md>
       <p>Let <var>p</var> be the result of calling <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#dom-global-fetch" id="ref-for-dom-global-fetch">fetch()</a></code> with <var>req</var>.</p>
      <li data-md>
       <p>Add <var>p</var> to <var>responsePromises</var>.</p>
     </ol>
    <li data-md>
     <p>Return the result of <a data-link-type="dfn" href="#waiting-for-all-promise" id="ref-for-waiting-for-all-promise①">getting a promise to wait for all</a> of <var>responsePromises</var>, given success steps that take <var>results</var> and returns the result of converting that <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑦">list</a> into a JavaScript Array.</p>
   </ol>
   <h2 class="heading settled" data-level="7" id="webidl"><span class="secno">7. </span><span class="content">WebIDL and Promises</span><a class="self-link" href="#webidl"></a></h2>
   <div class="note" role="note">This section is primarily for spec writers, dealing with how promises integrate with an interface definition language often used in web specs.</div>
   <p><a data-link-type="biblio" href="#biblio-webidl">[WEBIDL]</a> provides a <a href="https://heycam.github.io/webidl/#es-promise"><code>Promise&lt;T></code></a> type which can be used when writing specifications that expose their API through WebIDL. We summarize the impact of <code>Promise&lt;T></code> here for easy reference.</p>
   <h3 class="heading settled" data-level="7.1" id="webidl-promise-return-values"><span class="secno">7.1. </span><span class="content"><code>Promise&lt;T></code> Return Values</span><a class="self-link" href="#webidl-promise-return-values"></a></h3>
   <p>Like all WebIDL return values, declaring a return value of type <code>Promise&lt;T></code> has no impact on the algorithm’s actual return steps. It is simply a form of documentation, and if you return something that is not a promise or is a promise with a fulfillment value that is not of WebIDL-type <code>T</code>, then you have written incorrect documentation into your spec.</p>
   <p>However, declaring that your method or accessor returns a promise does have one important impact: it ensures that any exceptions that it would otherwise throw, e.g. as a result of failed type conversions, are caught and turned into rejected promises. (See the <a href="https://heycam.github.io/webidl/#es-operations">"Operations" section</a>, "If <var>O</var> has a return type that is a promise type …", and similar phrases scattered throughout the document.) This automatically takes care of the advice in <a href="#always-return-promises">§ 4.1.1 Promise-Returning Functions Should Always Return Promises</a>, at least for exceptions.</p>
   <h3 class="heading settled" data-level="7.2" id="webidl-promise-parameters"><span class="secno">7.2. </span><span class="content"><code>Promise&lt;T></code> Parameters</span><a class="self-link" href="#webidl-promise-parameters"></a></h3>
   <p>When a parameter of a WebIDL method is declared as <code>Promise&lt;T></code>, it will automatically resolve any arguments passed in that position. This will take care of the "Promise Arguments Should Be Resolved" advice above.</p>
   <p>If you have a WebIDL <code>Promise&lt;T></code> argument, you can use the WebIDL <a href="https://heycam.github.io/webidl/#dfn-perform-steps-once-promise-is-settled">perform some steps once a promise is settled</a> algorithm. This is much like our <a href="#upon-fulfillment" id="ref-for-upon-fulfillment①">upon fulfillment …</a> and <a href="#upon-rejection" id="ref-for-upon-rejection①">upon rejection …</a> shorthand phrases above, but it will add an additional step of converting the promise’s fulfillment value to the WebIDL type <code>T</code> before running any upon-fulfillment steps. Additionally it causes your algorithm to return a promise derived from running those steps. If the type conversion fails, your algorithm will return <a data-link-type="dfn" href="#a-promise-rejected-with" id="ref-for-a-promise-rejected-with⑤">a promise rejected with</a> the error causing that failure.</p>
   <p>Note that the <code>T</code> here refers to a WebIDL type <em>for the fulfillment value</em>. Furthermore, it only has impact if you use the WebIDL "perform some steps …" algorithm, and not if you use the promise in other ways (such as passing it along to another function). If that is not relevant, we advise using <code>Promise&lt;any></code> for parameters.</p>
   <div class="note" role="note">
     As a consequence of the resolution behavior, <code>Promise&lt;T></code> parameters cannot be overloaded with any other parameters. For example, you cannot do: 
<pre>// INVALID WEBIDL
void f(Promise&lt;DOMString> x);
void f(DOMString y);
</pre>
   </div>
   <p><span id="webidl-user-functions-returning-promises"></span></p>
   <h3 class="heading settled" data-level="7.3" id="webidl-developer-functions-returning-promises"><span class="secno">7.3. </span><span class="content">Developer Functions Returning Promises</span><a class="self-link" href="#webidl-developer-functions-returning-promises"></a></h3>
   <p>In WebIDL, you consume JavaScript functions by declaring them as WebIDL <a href="https://heycam.github.io/webidl/#dfn-callback-function">callback functions</a> (or, in rare cases, via <a href="https://heycam.github.io/webidl/#dfn-callback-interface">callback interfaces</a>) and later <a href="https://heycam.github.io/webidl/#es-invoking-callback-functions">invoking them</a> with a list of WebIDL values.</p>
   <p>If you use WebIDL’s mechanisms for calling JavaScript functions, the invocation algorithm will automatically resolve return values and convert thrown exceptions into rejected promises. This automatically takes care of the advice in <a href="#should-promise-call">§ 4.3.2 Developer-Supplied Promise-Returning Functions Should Be "Promise-Called"</a>.</p>
   <h3 class="heading settled" data-level="7.4" id="webidl-examples"><span class="secno">7.4. </span><span class="content">Examples</span><a class="self-link" href="#webidl-examples"></a></h3>
   <div class="example" id="example-a2c3786e">
    <a class="self-link" href="#example-a2c3786e"></a> Promise-returning methods: 
<pre>interface ProtectedResource {
  Promise&lt;void> requestAccess();
  // ...
};

interface Quoter {
  Promise&lt;DOMString> getInterestingQuote();
};
</pre>
   </div>
   <div class="example" id="example-4b005cc9">
    <a class="self-link" href="#example-4b005cc9"></a> Promise-returning properties 
<pre>interface StateMachine {
  readonly attribute Promise&lt;void> loaded;

  Promise&lt;void> load();
};
</pre>
   </div>
   <div class="example" id="example-369ec4f6">
    <a class="self-link" href="#example-369ec4f6"></a> Promise-accepting methods 
<pre>interface Waiter {
  void waitUntil(Promise&lt;any> promise);
};
</pre>
   </div>
   <div class="example" id="example-2dc9049b">
    <a class="self-link" href="#example-2dc9049b"></a> Promise-returning developer functions 
<pre>callback Promise&lt;DOMString> ResourceLoader();

interface ResourceConsumer {
  void loadAndConsumeResource(ResourceLoader loader);
};
</pre>
   </div>
   <h2 class="no-num heading settled" id="legacy"><span class="content">Appendix: Legacy APIs for Asynchronicity</span><a class="self-link" href="#legacy"></a></h2>
   <p>Many web platform APIs were written before the advent of promises, and thus came up with their own ad-hoc ways of signaling asynchronous operation completion or failure. These include:</p>
   <ul>
    <li data-md>
     <p>IndexedDB returning <a href="http://www.w3.org/TR/IndexedDB/#request-api"><code>IDBRequest</code></a> objects, with their <code>onsuccess</code> and <code>onerror</code> events</p>
    <li data-md>
     <p>The File API’s <a href="http://www.w3.org/TR/file-system-api/#methods"><code>methods</code></a> taking various <code>successCallback</code> and <code>errorCallback</code> parameters</p>
    <li data-md>
     <p>The Notifications API’s <a href="https://notifications.spec.whatwg.org/#dom-notification-requestpermission"><code>requestPermission</code></a> method, which calls its callback with <code>"granted"</code> or <code>"denied"</code></p>
    <li data-md>
     <p>The Fullscreen API’s <a href="https://fullscreen.spec.whatwg.org/#dom-element-requestfullscreen"><code>requestFullscreen</code></a> method, which triggers <code>onfullscreenchange</code> or <code>onfullscreenerror</code> events on the nearby <code>document</code> object that must be listened to in order to detect success or failure</p>
    <li data-md>
     <p>XMLHttpRequest’s <a href="https://xhr.spec.whatwg.org/#the-send%28%29-method"><code>send</code></a> method, which triggers <code>onreadystatechange</code> multiple times and updates properties of the object with status information which must be consulted in order to accurately detect success or failure of the ultimate state transition</p>
   </ul>
   <p>If you find yourself doing something even remotely similar to these, stop, and instead use promises.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="conformance"><span class="content"> Conformance</span><a class="self-link" href="#conformance"></a></h2>
   <p> Conformance requirements are expressed with a combination of descriptive assertions and RFC 2119 terminology.
            The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
            in the normative parts of this document
            are to be interpreted as described in RFC 2119.
            However, for readability,
            these words do not appear in all uppercase letters in this specification. </p>
   <p> All of the text of this specification is normative
            except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119">[RFC2119]</a> </p>
   <p> Examples in this specification are introduced with the words “for example”
            or are set apart from the normative text with <code>class="example"</code>, like this: </p>
   <div class="example" id="example-example"><a class="self-link" href="#example-example"></a> This is an example of an informative example. </div>
   <p> Informative notes begin with the word “Note”
            and are set apart from the normative text with <code>class="note"</code>, like this: </p>
   <p class="note" role="note"> Note, this is an informative note. </p>
  </div>
<script>
(function() {
  "use strict";
  var collapseSidebarText = '<span aria-hidden="true">←</span> '
                          + '<span>Collapse Sidebar</span>';
  var expandSidebarText   = '<span aria-hidden="true">→</span> '
                          + '<span>Pop Out Sidebar</span>';
  var tocJumpText         = '<span aria-hidden="true">↑</span> '
                          + '<span>Jump to Table of Contents</span>';

  var sidebarMedia = window.matchMedia('screen and (min-width: 78em)');
  var autoToggle   = function(e){ toggleSidebar(e.matches) };
  if(sidebarMedia.addListener) {
    sidebarMedia.addListener(autoToggle);
  }

  function toggleSidebar(on) {
    if (on == undefined) {
      on = !document.body.classList.contains('toc-sidebar');
    }

    /* Don’t scroll to compensate for the ToC if we’re above it already. */
    var headY = 0;
    var head = document.querySelector('.head');
    if (head) {
      // terrible approx of "top of ToC"
      headY += head.offsetTop + head.offsetHeight;
    }
    var skipScroll = window.scrollY < headY;

    var toggle = document.getElementById('toc-toggle');
    var tocNav = document.getElementById('toc');
    if (on) {
      var tocHeight = tocNav.offsetHeight;
      document.body.classList.add('toc-sidebar');
      document.body.classList.remove('toc-inline');
      toggle.innerHTML = collapseSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, 0 - tocHeight);
      }
      tocNav.focus();
      sidebarMedia.addListener(autoToggle); // auto-collapse when out of room
    }
    else {
      document.body.classList.add('toc-inline');
      document.body.classList.remove('toc-sidebar');
      toggle.innerHTML = expandSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, tocNav.offsetHeight);
      }
      if (toggle.matches(':hover')) {
        /* Unfocus button when not using keyboard navigation,
           because I don’t know where else to send the focus. */
        toggle.blur();
      }
    }
  }

  function createSidebarToggle() {
    /* Create the sidebar toggle in JS; it shouldn’t exist when JS is off. */
    var toggle = document.createElement('a');
      /* This should probably be a button, but appearance isn’t standards-track.*/
    toggle.id = 'toc-toggle';
    toggle.class = 'toc-toggle';
    toggle.href = '#toc';
    toggle.innerHTML = collapseSidebarText;

    sidebarMedia.addListener(autoToggle);
    var toggler = function(e) {
      e.preventDefault();
      sidebarMedia.removeListener(autoToggle); // persist explicit off states
      toggleSidebar();
      return false;
    }
    toggle.addEventListener('click', toggler, false);


    /* Get <nav id=toc-nav>, or make it if we don’t have one. */
    var tocNav = document.getElementById('toc-nav');
    if (!tocNav) {
      tocNav = document.createElement('p');
      tocNav.id = 'toc-nav';
      /* Prepend for better keyboard navigation */
      document.body.insertBefore(tocNav, document.body.firstChild);
    }
    /* While we’re at it, make sure we have a Jump to Toc link. */
    var tocJump = document.getElementById('toc-jump');
    if (!tocJump) {
      tocJump = document.createElement('a');
      tocJump.id = 'toc-jump';
      tocJump.href = '#toc';
      tocJump.innerHTML = tocJumpText;
      tocNav.appendChild(tocJump);
    }

    tocNav.appendChild(toggle);
  }

  var toc = document.getElementById('toc');
  if (toc) {
    createSidebarToggle();
    toggleSidebar(sidebarMedia.matches);

    /* If the sidebar has been manually opened and is currently overlaying the text
       (window too small for the MQ to add the margin to body),
       then auto-close the sidebar once you click on something in there. */
    toc.addEventListener('click', function(e) {
      if(e.target.tagName.toLowerCase() == "a" && document.body.classList.contains('toc-sidebar') && !sidebarMedia.matches) {
        toggleSidebar(false);
      }
    }, false);
  }
  else {
    console.warn("Can’t find Table of Contents. Please use <nav id='toc'> around the ToC.");
  }

  /* Wrap tables in case they overflow */
  var tables = document.querySelectorAll(':not(.overlarge) > table.data, :not(.overlarge) > table.index');
  var numTables = tables.length;
  for (var i = 0; i < numTables; i++) {
    var table = tables[i];
    var wrapper = document.createElement('div');
    wrapper.className = 'overlarge';
    table.parentNode.insertBefore(wrapper, table);
    wrapper.appendChild(table);
  }

})();
</script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#a-new-promise">A new promise</a><span>, in §5.1</span>
   <li><a href="#a-promise-rejected-with">A promise rejected with</a><span>, in §5.1</span>
   <li><a href="#a-promise-resolved-with">A promise resolved with</a><span>, in §5.1</span>
   <li><a href="#waiting-for-all-promise">get a promise to wait for all</a><span>, in §5.4</span>
   <li><a href="#waiting-for-all-promise">getting a promise to wait for all</a><span>, in §5.4</span>
   <li><a href="#promise-calling">promise-calling</a><span>, in §5.5</span>
   <li><a href="#reject-promise">Reject</a><span>, in §5.2</span>
   <li><a href="#resolve-promise">Resolve</a><span>, in §5.2</span>
   <li><a href="#resolved-as-a-promise">resolved as a promise</a><span>, in §5.1</span>
   <li><a href="#transforming-by">Transforming</a><span>, in §5.3</span>
   <li><a href="#upon-fulfillment">Upon fulfillment</a><span>, in §5.3</span>
   <li><a href="#upon-rejection">Upon rejection</a><span>, in §5.3</span>
   <li><a href="#waiting-for-all">wait for all</a><span>, in §5.4</span>
   <li><a href="#waiting-for-all">waiting for all</a><span>, in §5.4</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-sec-performpromisethen">
   <a href="https://tc39.github.io/ecma262/#sec-performpromisethen">https://tc39.github.io/ecma262/#sec-performpromisethen</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-sec-performpromisethen">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-sec-promise.all">
   <a href="https://tc39.github.io/ecma262/#sec-promise.all">https://tc39.github.io/ecma262/#sec-promise.all</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-sec-promise.all">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-request">
   <a href="https://fetch.spec.whatwg.org/#request">https://fetch.spec.whatwg.org/#request</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-request">6.7. batchRequest(urls)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-response">
   <a href="https://fetch.spec.whatwg.org/#response">https://fetch.spec.whatwg.org/#response</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-response">6.7. batchRequest(urls)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-dom-global-fetch">
   <a href="https://fetch.spec.whatwg.org/#dom-global-fetch">https://fetch.spec.whatwg.org/#dom-global-fetch</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-dom-global-fetch">6.7. batchRequest(urls)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-in-parallel">
   <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel">https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-in-parallel">4.2.2. Note Parallel Steps Explicitly</a> <a href="#ref-for-in-parallel①">(2)</a>
    <li><a href="#ref-for-in-parallel②">4.2.3. Queue Tasks to Invoke Developer Code</a>
    <li><a href="#ref-for-in-parallel③">5.2. Manipulating Promises</a>
    <li><a href="#ref-for-in-parallel④">6.1. delay(ms)</a>
    <li><a href="#ref-for-in-parallel⑤">6.2. validatedDelay(ms)</a>
    <li><a href="#ref-for-in-parallel⑥">6.3. addDelay(promise, ms)</a> <a href="#ref-for-in-parallel⑦">(2)</a>
    <li><a href="#ref-for-in-parallel⑧">6.6. addBookmark()</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-queue-a-microtask">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask">https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-queue-a-microtask">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-queue-a-task">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task">https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-queue-a-task">4.2.3. Queue Tasks to Invoke Developer Code</a> <a href="#ref-for-queue-a-task①">(2)</a>
    <li><a href="#ref-for-queue-a-task②">5.2. Manipulating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-relevant-settings-object">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object">https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-relevant-settings-object">5.2. Manipulating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-responsible-event-loop">
   <a href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop">https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-responsible-event-loop">5.2. Manipulating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-list-iterate">
   <a href="https://infra.spec.whatwg.org/#list-iterate">https://infra.spec.whatwg.org/#list-iterate</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list-iterate">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-list">
   <a href="https://infra.spec.whatwg.org/#list">https://infra.spec.whatwg.org/#list</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list">5.4. Aggregating Promises</a> <a href="#ref-for-list①">(2)</a> <a href="#ref-for-list②">(3)</a> <a href="#ref-for-list③">(4)</a> <a href="#ref-for-list④">(5)</a>
    <li><a href="#ref-for-list⑤">6.7. batchRequest(urls)</a> <a href="#ref-for-list⑥">(2)</a> <a href="#ref-for-list⑦">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-list-size">
   <a href="https://infra.spec.whatwg.org/#list-size">https://infra.spec.whatwg.org/#list-size</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-list-size">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-idl-USVString">
   <a href="https://heycam.github.io/webidl/#idl-USVString">https://heycam.github.io/webidl/#idl-USVString</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-idl-USVString">6.7. batchRequest(urls)</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[ECMASCRIPT]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-sec-performpromisethen" style="color:initial">PerformPromiseThen</span>
     <li><span class="dfn-paneled" id="term-for-sec-promise.all" style="color:initial">all()</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-request" style="color:initial">Request</span>
     <li><span class="dfn-paneled" id="term-for-response" style="color:initial">Response</span>
     <li><span class="dfn-paneled" id="term-for-dom-global-fetch" style="color:initial">fetch(input)</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-in-parallel" style="color:initial">in parallel</span>
     <li><span class="dfn-paneled" id="term-for-queue-a-microtask" style="color:initial">queue a microtask</span>
     <li><span class="dfn-paneled" id="term-for-queue-a-task" style="color:initial">queue a task</span>
     <li><span class="dfn-paneled" id="term-for-relevant-settings-object" style="color:initial">relevant settings object</span>
     <li><span class="dfn-paneled" id="term-for-responsible-event-loop" style="color:initial">responsible event loop</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-list-iterate" style="color:initial">for each</span>
     <li><span class="dfn-paneled" id="term-for-list" style="color:initial">list</span>
     <li><span class="dfn-paneled" id="term-for-list-size" style="color:initial">size</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-idl-USVString" style="color:initial">USVString</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-ecmascript">[ECMASCRIPT]
   <dd><a href="https://tc39.github.io/ecma262/">ECMAScript Language Specification</a>. URL: <a href="https://tc39.github.io/ecma262/">https://tc39.github.io/ecma262/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/">Fetch Standard</a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/">HTML Standard</a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/">Infra Standard</a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>. March 1997. Best Current Practice. URL: <a href="https://tools.ietf.org/html/rfc2119">https://tools.ietf.org/html/rfc2119</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Boris Zbarsky. <a href="https://heycam.github.io/webidl/">Web IDL</a>. URL: <a href="https://heycam.github.io/webidl/">https://heycam.github.io/webidl/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-service-workers">[SERVICE-WORKERS]
   <dd>Alex Russell; et al. <a href="https://w3c.github.io/ServiceWorker/">Service Workers 1</a>. URL: <a href="https://w3c.github.io/ServiceWorker/">https://w3c.github.io/ServiceWorker/</a>
  </dl>
  <aside class="dfn-panel" data-for="a-new-promise">
   <b><a href="#a-new-promise">#a-new-promise</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-a-new-promise">4.2.2. Note Parallel Steps Explicitly</a>
    <li><a href="#ref-for-a-new-promise①">4.2.3. Queue Tasks to Invoke Developer Code</a>
    <li><a href="#ref-for-a-new-promise②">5.4. Aggregating Promises</a>
    <li><a href="#ref-for-a-new-promise③">6.1. delay(ms)</a>
    <li><a href="#ref-for-a-new-promise④">6.2. validatedDelay(ms)</a>
    <li><a href="#ref-for-a-new-promise⑤">6.3. addDelay(promise, ms)</a>
    <li><a href="#ref-for-a-new-promise⑥">6.5. environment.ready</a>
    <li><a href="#ref-for-a-new-promise⑦">6.6. addBookmark()</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="a-promise-resolved-with">
   <b><a href="#a-promise-resolved-with">#a-promise-resolved-with</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-a-promise-resolved-with">5.6. A Note on Realms</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="resolved-as-a-promise">
   <b><a href="#resolved-as-a-promise">#resolved-as-a-promise</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-resolved-as-a-promise">5.5. Promise-Calling</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="a-promise-rejected-with">
   <b><a href="#a-promise-rejected-with">#a-promise-rejected-with</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-a-promise-rejected-with">5.5. Promise-Calling</a>
    <li><a href="#ref-for-a-promise-rejected-with">6.2. validatedDelay(ms)</a> <a href="#ref-for-a-promise-rejected-with①">(2)</a>
    <li><a href="#ref-for-a-promise-rejected-with②">6.6. addBookmark()</a> <a href="#ref-for-a-promise-rejected-with③">(2)</a>
    <li><a href="#ref-for-a-promise-rejected-with④">6.7. batchRequest(urls)</a>
    <li><a href="#ref-for-a-promise-rejected-with⑤">7.2. Promise&lt;T> Parameters</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="resolve-promise">
   <b><a href="#resolve-promise">#resolve-promise</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-resolve-promise">4.2.2. Note Parallel Steps Explicitly</a>
    <li><a href="#ref-for-resolve-promise①">4.2.3. Queue Tasks to Invoke Developer Code</a> <a href="#ref-for-resolve-promise②">(2)</a>
    <li><a href="#ref-for-resolve-promise③">5.4. Aggregating Promises</a> <a href="#ref-for-resolve-promise④">(2)</a>
    <li><a href="#ref-for-resolve-promise⑤">6.1. delay(ms)</a>
    <li><a href="#ref-for-resolve-promise⑥">6.2. validatedDelay(ms)</a>
    <li><a href="#ref-for-resolve-promise⑦">6.3. addDelay(promise, ms)</a>
    <li><a href="#ref-for-resolve-promise⑧">6.5. environment.ready</a>
    <li><a href="#ref-for-resolve-promise⑨">6.6. addBookmark()</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="reject-promise">
   <b><a href="#reject-promise">#reject-promise</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-reject-promise">5.4. Aggregating Promises</a> <a href="#ref-for-reject-promise①">(2)</a>
    <li><a href="#ref-for-reject-promise②">6.3. addDelay(promise, ms)</a>
    <li><a href="#ref-for-reject-promise③">6.5. environment.ready</a>
    <li><a href="#ref-for-reject-promise④">6.6. addBookmark()</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="upon-fulfillment">
   <b><a href="#upon-fulfillment">#upon-fulfillment</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-upon-fulfillment">6.3. addDelay(promise, ms)</a>
    <li><a href="#ref-for-upon-fulfillment">7.2. Promise&lt;T> Parameters</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="upon-rejection">
   <b><a href="#upon-rejection">#upon-rejection</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-upon-rejection">6.3. addDelay(promise, ms)</a>
    <li><a href="#ref-for-upon-rejection">7.2. Promise&lt;T> Parameters</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="transforming-by">
   <b><a href="#transforming-by">#transforming-by</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-transforming-by">5.3. Reacting to Promises</a> <a href="#ref-for-transforming-by①">(2)</a>
    <li><a href="#ref-for-transforming-by②">6.4. resource.open(resourcePath, openingOperation)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="waiting-for-all">
   <b><a href="#waiting-for-all">#waiting-for-all</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-waiting-for-all">5.4. Aggregating Promises</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="waiting-for-all-promise">
   <b><a href="#waiting-for-all-promise">#waiting-for-all-promise</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-waiting-for-all-promise">6.7. batchRequest(urls)</a> <a href="#ref-for-waiting-for-all-promise①">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="promise-calling">
   <b><a href="#promise-calling">#promise-calling</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-promise-calling">4.3.2. Developer-Supplied Promise-Returning Functions Should Be "Promise-Called"</a>
    <li><a href="#ref-for-promise-calling">6.4. resource.open(resourcePath, openingOperation)</a> <a href="#ref-for-promise-calling">(2)</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>