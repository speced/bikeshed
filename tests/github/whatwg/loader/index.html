<!doctype html><html lang="en">
 <head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <meta content="#3c790a" name="theme-color">
  <meta content="light dark" name="color-scheme">
  <title>Loader</title>
  <link crossorigin href="https://resources.whatwg.org/standard-shared-with-dev.css" rel="stylesheet">
  <link crossorigin href="https://resources.whatwg.org/standard.css" rel="stylesheet">
  <link crossorigin href="https://resources.whatwg.org/spec.css" rel="stylesheet">
  <link crossorigin href="https://resources.whatwg.org/logo-javascript.svg" rel="icon">
  <script crossorigin defer src="https://resources.whatwg.org/commit-snapshot-shortcut-key.js"></script>
  <link crossorigin href="https://whatwg.github.io/loader" rel="canonical">
<style>
  .note + .example, .note + .note { margin-top: 1em; }

  emu-val { font-weight: bold; }
  emu-alg > ol, emu-alg > ol ol ol ol { list-style-type: decimal; }
  emu-alg > ol ol, emu-alg > ol ol ol ol ol { list-style-type: lower-alpha; }
  emu-alg > ol ol ol, emu-alg > ol ol ol ol ol ol { list-style-type: lower-roman; }
  emu-alg li { margin: 0; }
  emu-note { display: block; margin: 1em 0 1em 6em; color: #666; }
  emu-note::before { content: "Note"; text-transform: uppercase; margin-left: -6em; display: block; float: left; }
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
 <body class="h-entry status-DREAM">
  <div class="head">
    <a class="logo" href="https://whatwg.org/"> <img alt="WHATWG" class="darkmode-aware" crossorigin height="100" src="https://resources.whatwg.org/logo-javascript.svg"> </a> 
   <hgroup>
    <h1 class="p-name no-ref" id="title">Loader</h1>
    <p id="subtitle">A Collection of Interesting Ideas — Last Updated <time class="dt-updated" datetime="1970-01-01">1 January 1970</time> </p>
   </hgroup>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>Participate:
     <dd><a href="https://github.com/whatwg/loader">GitHub whatwg/loader</a> (<a href="https://github.com/whatwg/loader/issues/new/choose">new issue</a>, <a href="https://github.com/whatwg/loader/issues">open issues</a>)
     <dd><a href="https://whatwg.org/chat">Chat on Matrix</a>
     <dd><a href="https://github.com/whatwg/loader/issues/new">File an issue</a> (<a href="https://github.com/whatwg/loader/issues?state=open">open issues</a>)
     <dt>Commits:
     <dd><a href="https://github.com/whatwg/loader/commits">GitHub whatwg/loader/commits</a>
     <dd><a href="/commit-snapshots/[COMMIT-SHA]/" id="commit-snapshot-link">Snapshot as of this commit</a>
     <dd><a href="https://twitter.com/[TWITTER]">@[TWITTER]</a>
     <dt>Tests:
     <dd><a href="https://github.com/web-platform-tests/wpt/tree/master/loader">web-platform-tests loader/</a> (<a href="https://github.com/web-platform-tests/wpt/labels/loader">ongoing work</a>)
     <dt>This version:
     <dd><a class="u-url" href="https://whatwg.github.io/loader">https://whatwg.github.io/loader</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://github.com/ericf">Eric Ferraiuolo</a> (<a class="p-org org" href="https://yahoo.com">Yahoo</a>) <a class="u-email email" href="mailto:edf@ericf.me">edf@ericf.me</a>
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="http://calculist.org">Dave Herman</a> (<a class="p-org org" href="https://mozilla.org">Mozilla</a>) <a class="u-email email" href="mailto:dherman@mozilla.com">dherman@mozilla.com</a>
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="http://yehudakatz.com">Yehuda Katz</a> (<a class="p-org org" href="https://jquery.org">jQuery Foundation</a>) <a class="u-email email" href="mailto:wycats@gmail.com">wycats@gmail.com</a>
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="http://caridy.name">Caridy Patiño</a> (<a class="p-org org" href="https://yahoo.com">Yahoo</a>) <a class="u-email email" href="mailto:caridy@gmail.com">caridy@gmail.com</a>
     <dt>Version History:
     <dd><a href="https://github.com/whatwg/loader/commits">https://github.com/whatwg/loader/commits</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification describes the behavior of loading JavaScript modules from a
JavaScript host environment. It also provides APIs for intercepting the module
loading process and customizing loading behavior.</p>
  </div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#module-loading"><span class="secno">1</span> <span class="content">Module Loading</span></a>
     <ol class="toc">
      <li><a href="#intro"><span class="secno">1.1</span> <span class="content">Introduction</span></a>
      <li><a href="#pipeline"><span class="secno">1.2</span> <span class="content">Loader Pipeline</span></a>
     </ol>
    <li>
     <a href="#conventions"><span class="secno">2</span> <span class="content">Conventions</span></a>
     <ol class="toc">
      <li><a href="#well-known-symbols"><span class="secno">2.1</span> <span class="content">Well-Known Symbols</span></a>
      <li><a href="#well-known-intrinsic-objects"><span class="secno">2.2</span> <span class="content">Well-Known Intrinsic Objects</span></a>
      <li>
       <a href="#promises"><span class="secno">2.3</span> <span class="content">Promises</span></a>
       <ol class="toc">
        <li><a href="#reacting-to-promises"><span class="secno">2.3.1</span> <span class="content">Reacting to Promises</span></a>
       </ol>
      <li>
       <a href="#shorthand-phrases"><span class="secno">2.4</span> <span class="content">Shorthand Phrases</span></a>
       <ol class="toc">
        <li><a href="#reject-if-abrupt"><span class="secno">2.4.1</span> <span class="content">RejectIfAbrupt(x)</span></a>
       </ol>
      <li>
       <a href="#common-operations"><span class="secno">2.5</span> <span class="content">Common Operations</span></a>
       <ol class="toc">
        <li><a href="#create-object"><span class="secno">2.5.1</span> <span class="content">CreateObject()</span></a>
        <li><a href="#simple-define"><span class="secno">2.5.2</span> <span class="content">SimpleDefine(obj, name, value)</span></a>
       </ol>
      <li><a href="#common-operations①"><span class="secno">2.6</span> <span class="content">Built-in Function Objects</span></a>
     </ol>
    <li>
     <a href="#loader-objects"><span class="secno">3</span> <span class="content">Loader Objects</span></a>
     <ol class="toc">
      <li>
       <a href="#loader-constructor"><span class="secno">3.1</span> <span class="content">The Loader Constructor</span></a>
       <ol class="toc">
        <li><a href="#new-loader"><span class="secno">3.1.1</span> <span class="content">Loader()</span></a>
       </ol>
      <li>
       <a href="#properties-of-the-loader-constructor"><span class="secno">3.2</span> <span class="content">Properties of the Loader Constructor</span></a>
       <ol class="toc">
        <li><a href="#loader-prototype"><span class="secno">3.2.1</span> <span class="content">Loader.prototype</span></a>
       </ol>
      <li>
       <a href="#sec-properties-of-the-loader-prototype-object"><span class="secno">3.3</span> <span class="content">Properties of the Loader Prototype Object</span></a>
       <ol class="toc">
        <li><a href="#Loader.prototype.constructor"><span class="secno">3.3.1</span> <span class="content">Loader.prototype.constructor</span></a>
        <li><a href="#loader-import"><span class="secno">3.3.2</span> <span class="content">Loader.prototype.import(name[, referrer])</span></a>
        <li><a href="#loader-load-resolve"><span class="secno">3.3.3</span> <span class="content">Loader.prototype.resolve(name[, referrer])</span></a>
        <li><a href="#loader-load"><span class="secno">3.3.4</span> <span class="content">Loader.prototype.load(name[, referrer[, stage]])</span></a>
        <li><a href="#loader-registry"><span class="secno">3.3.5</span> <span class="content">get Loader.prototype.registry</span></a>
        <li><a href="#loader-@@tostringtag"><span class="secno">3.3.6</span> <span class="content">Loader.prototype [ @@toStringTag ]</span></a>
       </ol>
      <li><a href="#loader-internal-slots"><span class="secno">3.4</span> <span class="content">Properties of Loader Instances</span></a>
     </ol>
    <li>
     <a href="#registry"><span class="secno">4</span> <span class="content">Registry Objects</span></a>
     <ol class="toc">
      <li>
       <a href="#registry-abstract-operations"><span class="secno">4.1</span> <span class="content">Abstract Operations for Registry Objects</span></a>
       <ol class="toc">
        <li><a href="#registry-CreateRegistry"><span class="secno">4.1.1</span> <span class="content">CreateRegistry()</span></a>
       </ol>
      <li><a href="#registry-constructor"><span class="secno">4.2</span> <span class="content">The Registry Constructor</span></a>
      <li>
       <a href="#properties-of-the-registry-constructor"><span class="secno">4.3</span> <span class="content">Properties of the Registry Constructor</span></a>
       <ol class="toc">
        <li><a href="#registry-prototype"><span class="secno">4.3.1</span> <span class="content">Registry.prototype</span></a>
       </ol>
      <li>
       <a href="#registry-prototype-object"><span class="secno">4.4</span> <span class="content">Properties of the Registry Prototype Object</span></a>
       <ol class="toc">
        <li><a href="#registry-prototype-constructor"><span class="secno">4.4.1</span> <span class="content">Registry.prototype.constructor</span></a>
        <li><a href="#registry-prototype-@@iterator"><span class="secno">4.4.2</span> <span class="content">Registry.prototype[ @@iterator ]()</span></a>
        <li><a href="#registry-prototype-entries"><span class="secno">4.4.3</span> <span class="content">Registry.prototype.entries()</span></a>
        <li><a href="#registry-prototype-keys"><span class="secno">4.4.4</span> <span class="content">Registry.prototype.keys()</span></a>
        <li><a href="#registry-prototype-values"><span class="secno">4.4.5</span> <span class="content">Registry.prototype.values()</span></a>
        <li><a href="#registry-prototype-get"><span class="secno">4.4.6</span> <span class="content">Registry.prototype.get(key)</span></a>
        <li><a href="#registry-prototype-set"><span class="secno">4.4.7</span> <span class="content">Registry.prototype.set(key, entry)</span></a>
        <li><a href="#registry-prototype-has"><span class="secno">4.4.8</span> <span class="content">Registry.prototype.has(key)</span></a>
        <li><a href="#registry-prototype-delete"><span class="secno">4.4.9</span> <span class="content">Registry.prototype.delete(key)</span></a>
       </ol>
      <li><a href="#registry-internal-slots"><span class="secno">4.5</span> <span class="content">Properties of Registry Instances</span></a>
     </ol>
    <li>
     <a href="#module-status"><span class="secno">5</span> <span class="content">ModuleStatus Objects</span></a>
     <ol class="toc">
      <li>
       <a href="#module-status-abstract-operations"><span class="secno">5.1</span> <span class="content">Abstract Operations for ModuleStatus Objects</span></a>
       <ol class="toc">
        <li><a href="#module-status-GetCurrentStage"><span class="secno">5.1.1</span> <span class="content">GetCurrentStage(entry)</span></a>
        <li><a href="#module-status-IsValidStageValue"><span class="secno">5.1.2</span> <span class="content">IsValidStageValue(stage)</span></a>
        <li><a href="#module-status-GetStage"><span class="secno">5.1.3</span> <span class="content">GetStage(entry, stage)</span></a>
        <li><a href="#module-status-LoadModule"><span class="secno">5.1.4</span> <span class="content">LoadModule(entry, stage)</span></a>
        <li><a href="#module-status-UpgradeToStage"><span class="secno">5.1.5</span> <span class="content">UpgradeToStage(entry, stage)</span></a>
       </ol>
      <li>
       <a href="#module-status-constructor"><span class="secno">5.2</span> <span class="content">The ModuleStatus Constructor</span></a>
       <ol class="toc">
        <li><a href="#new-module-status"><span class="secno">5.2.1</span> <span class="content">ModuleStatus(loader, key, ns)</span></a>
       </ol>
      <li>
       <a href="#properties-of-the-module-status-constructor"><span class="secno">5.3</span> <span class="content">Properties of the ModuleStatus Constructor</span></a>
       <ol class="toc">
        <li><a href="#module-status-prototype"><span class="secno">5.3.1</span> <span class="content">ModuleStatus.prototype</span></a>
       </ol>
      <li>
       <a href="#module-status-prototype-object"><span class="secno">5.4</span> <span class="content">Properties of the ModuleStatus Prototype Object</span></a>
       <ol class="toc">
        <li><a href="#module-status-prototype-constructor"><span class="secno">5.4.1</span> <span class="content">ModuleStatus.prototype.constructor</span></a>
        <li><a href="#module-status-stage"><span class="secno">5.4.2</span> <span class="content">get ModuleStatus.prototype.stage</span></a>
        <li><a href="#module-status-module"><span class="secno">5.4.3</span> <span class="content">get ModuleStatus.prototype.originalKey</span></a>
        <li><a href="#module-status-module①"><span class="secno">5.4.4</span> <span class="content">get ModuleStatus.prototype.module</span></a>
        <li><a href="#module-status-error"><span class="secno">5.4.5</span> <span class="content">get ModuleStatus.prototype.error</span></a>
        <li><a href="#module-status-error①"><span class="secno">5.4.6</span> <span class="content">get ModuleStatus.prototype.dependencies</span></a>
        <li><a href="#module-status-prototype-load"><span class="secno">5.4.7</span> <span class="content">ModuleStatus.prototype.load(stage)</span></a>
        <li><a href="#module-status-prototype-result"><span class="secno">5.4.8</span> <span class="content">ModuleStatus.prototype.result(stage)</span></a>
        <li><a href="#module-status-prototype-resolve"><span class="secno">5.4.9</span> <span class="content">ModuleStatus.prototype.resolve(stage, result)</span></a>
        <li><a href="#module-status-prototype-reject"><span class="secno">5.4.10</span> <span class="content">ModuleStatus.prototype.reject(stage, error)</span></a>
       </ol>
      <li><a href="#module-status-internal-slots"><span class="secno">5.5</span> <span class="content">Properties of ModuleStatus Instances</span></a>
     </ol>
    <li>
     <a href="#pipeline-semantics"><span class="secno">6</span> <span class="content">Loading Semantics</span></a>
     <ol class="toc">
      <li>
       <a href="#auxiliary-operations"><span class="secno">6.1</span> <span class="content">Auxiliary Operations</span></a>
       <ol class="toc">
        <li><a href="#ensure-registered"><span class="secno">6.1.1</span> <span class="content">EnsureRegistered(loader, key)</span></a>
        <li><a href="#resolve"><span class="secno">6.1.2</span> <span class="content">Resolve(loader, name, referrer)</span></a>
        <li><a href="#extract-dependencies"><span class="secno">6.1.3</span> <span class="content">ExtractDependencies(entry, instance)</span></a>
        <li><a href="#instantiation"><span class="secno">6.1.4</span> <span class="content">Instantiation(loader, optionalInstance, source)</span></a>
       </ol>
      <li>
       <a href="#loading-operations"><span class="secno">6.2</span> <span class="content">Loading Operations</span></a>
       <ol class="toc">
        <li><a href="#request-fetch"><span class="secno">6.2.1</span> <span class="content">RequestFetch(entry)</span></a>
        <li><a href="#request-translate"><span class="secno">6.2.2</span> <span class="content">RequestTranslate(entry)</span></a>
        <li><a href="#request-instantiate"><span class="secno">6.2.3</span> <span class="content">RequestInstantiate(entry, instantiateSet)</span></a>
        <li><a href="#satisfy-instance"><span class="secno">6.2.4</span> <span class="content">SatisfyInstance(entry, optionalInstance, source, instantiateSet)</span></a>
       </ol>
     </ol>
    <li>
     <a href="#linking-semantics"><span class="secno">7</span> <span class="content">Linking Semantics</span></a>
     <ol class="toc">
      <li>
       <a href="#resolving-dependencies"><span class="secno">7.1</span> <span class="content">Resolving Dependencies</span></a>
       <ol class="toc">
        <li><a href="#host-resolve-imported-module"><span class="secno">7.1.1</span> <span class="content">HostResolveImportedModule(module, requestName)</span></a>
       </ol>
      <li>
       <a href="#linking"><span class="secno">7.2</span> <span class="content">Linking</span></a>
       <ol class="toc">
        <li><a href="#dependency-graph"><span class="secno">7.2.1</span> <span class="content">DependencyGraph(root)</span></a>
        <li><a href="#compute-dependency-graph"><span class="secno">7.2.2</span> <span class="content">ComputeDependencyGraph(entry, result)</span></a>
        <li><a href="#ensure-linked"><span class="secno">7.2.3</span> <span class="content">EnsureLinked(entry)</span></a>
        <li><a href="#ensure-evaluated"><span class="secno">7.2.4</span> <span class="content">EnsureEvaluated(entry)</span></a>
       </ol>
     </ol>
    <li>
     <a href="#module-objects"><span class="secno">8</span> <span class="content">Module Objects</span></a>
     <ol class="toc">
      <li><a href="#reflective-module-record"><span class="secno">8.1</span> <span class="content">Reflective Module Records</span></a>
      <li>
       <a href="#module-abstract-operations"><span class="secno">8.2</span> <span class="content">Abstract Operations for Module Objects</span></a>
       <ol class="toc">
        <li><a href="#parse-exports-descriptors"><span class="secno">8.2.1</span> <span class="content">ParseExportsDescriptors(obj)</span></a>
        <li><a href="#create-module-mutator"><span class="secno">8.2.2</span> <span class="content">CreateModuleMutator(module)</span></a>
        <li><a href="#get-export-names"><span class="secno">8.2.3</span> <span class="content">GetExportNames(exportStarStack)</span></a>
        <li><a href="#resolve-export"><span class="secno">8.2.4</span> <span class="content">ResolveExport(exportName, resolveStack, exportStarStack)</span></a>
        <li><a href="#module-declaration-instantiation"><span class="secno">8.2.5</span> <span class="content">ModuleDeclarationInstantiation()</span></a>
        <li><a href="#module-evaluation"><span class="secno">8.2.6</span> <span class="content">ModuleEvaluation()</span></a>
       </ol>
      <li>
       <a href="#module-constructor"><span class="secno">8.3</span> <span class="content">The Module Constructor</span></a>
       <ol class="toc">
        <li><a href="#new-module"><span class="secno">8.3.1</span> <span class="content">Module(descriptors[, executor[, evaluate]])</span></a>
       </ol>
      <li>
       <a href="#properties-of-the-module-constructor"><span class="secno">8.4</span> <span class="content">Properties of the Module Constructor</span></a>
       <ol class="toc">
        <li><a href="#Module.evaluate"><span class="secno">8.4.1</span> <span class="content">Module.evaluate(ns)</span></a>
        <li><a href="#Module.prototype"><span class="secno">8.4.2</span> <span class="content">Module.prototype</span></a>
       </ol>
      <li><a href="#module-internal-slots"><span class="secno">8.5</span> <span class="content">Properties of Module Instances</span></a>
     </ol>
    <li><a href="#local"><span class="secno">9</span> <span class="content">Local Loading</span></a>
    <li>
     <a href="#browser"><span class="secno">10</span> <span class="content">Browser Loader</span></a>
     <ol class="toc">
      <li><a href="#system-loader-instance"><span class="secno">10.1</span> <span class="content">System.loader Object</span></a>
     </ol>
    <li>
     <a href="#browser-loader"><span class="secno">11</span> <span class="content">BrowserLoader Objects</span></a>
     <ol class="toc">
      <li><a href="#browser-loader-constructor"><span class="secno">11.1</span> <span class="content">The BrowserLoader Constructor</span></a>
      <li>
       <a href="#properties-of-the-browser-loader-constructor"><span class="secno">11.2</span> <span class="content">Properties of the BrowserLoader Constructor</span></a>
       <ol class="toc">
        <li><a href="#browser-loader-prototype"><span class="secno">11.2.1</span> <span class="content">BrowserLoader.prototype</span></a>
       </ol>
      <li>
       <a href="#properties-of-the-browser-loader-prototype"><span class="secno">11.3</span> <span class="content">Properties of the BrowserLoader Prototype</span></a>
       <ol class="toc">
        <li><a href="#browser-loader-prototype-@@resolve"><span class="secno">11.3.1</span> <span class="content">BrowserLoader.prototype[ @@resolve ](name, referrer)</span></a>
        <li><a href="#browser-loader-prototype-@@fetch"><span class="secno">11.3.2</span> <span class="content">BrowserLoader.prototype[ @@fetch ](entry, key)</span></a>
        <li><a href="#browser-loader-prototype-@@translate"><span class="secno">11.3.3</span> <span class="content">BrowserLoader.prototype[ @@translate ](entry, payload)</span></a>
        <li><a href="#browser-loader-prototype-@@instantiate"><span class="secno">11.3.4</span> <span class="content">BrowserLoader.prototype[ @@instantiate ](entry, source)</span></a>
       </ol>
     </ol>
    <li>
     <a href="#annexes"><span class="secno"></span> <span class="content">Annexes</span></a>
     <ol class="toc">
      <li><a href="#list-of-well-known-intrinsic-objects"><span class="secno"></span> <span class="content">List of Well-Known Intrinsic Objects</span></a>
     </ol>
    <li><a href="#ipr"><span class="secno"></span> <span class="content">Intellectual property rights</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <script async crossorigin src="https://resources.whatwg.org/file-issue.js"></script>
   <h2 class="no-num no-toc heading settled" id="status"><span class="content">Status</span></h2>
   <p>This document is a work in progress and dreams of becoming a living standard.</p>
   <h2 class="heading settled" data-level="1" id="module-loading"><span class="secno">1. </span><span class="content">Module Loading</span><a class="self-link" href="#module-loading"></a></h2>
   <p><i>This section is non-normative.</i></p>
   <h3 class="heading settled" data-level="1.1" id="intro"><span class="secno">1.1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h3>
   <p>Throughout their development, JavaScript modules have been divided into two general areas:</p>
   <ul>
    <li>The <b>authoring format</b>, which defines the importing and exporting syntax, as well as the semantics for variable bindings and cycles. 
    <li>The <b>JavaScript Loader</b>, which provides a pipeline for on-demand, asynchronous loading of JavaScript modules. 
   </ul>
   <p>The authoring format was carefully designed to support pre-compilation (like Browserify) and on-demand asynchronous loading (like AMD). It defines the minimal syntax necessary to allow people to write portable modules that can work across different platforms, most notably Node.js and web browsers.</p>
   <p>The JavaScript Loader allows host environments, like Node.js and browsers, to fetch and load modules on demand. It provides a hookable pipeline, to allow front-end packaging solutions like Browserify, WebPack and jspm to hook into the loading process.</p>
   <p>This division provides a single format that developers can use in all JavaScript environments, and a separate loading mechanism for each environment. For example, a Node Loader would load its modules from the file system, using its own module lookup algorithm, while a Browser Loader would fetch modules and use browser-supplied packaging formats.</p>
   <p>JavaScript itself, in ECMAScript 2015, defines the module syntax and the "linking semantics" between modules. When a module is requested, it delegates responsibility for loading the module to the host environment. The Loader defines how host environments can allow JavaScript code to configure that process.</p>
   <p>The primary goal is to make as much of this process as possible consistent between Node and Browser environments. For example, if a JavaScript program wants to translate <code>.coffee</code> files to JavaScript on the fly, the Loader defines a "translate" hook that can be used. This allows programs to participate in the loading process, even though some details (specifically, the process of getting a particular module from its host-defined storage) will be different between environments.</p>
   <h3 class="heading settled" data-level="1.2" id="pipeline"><span class="secno">1.2. </span><span class="content">Loader Pipeline</span><a class="self-link" href="#pipeline"></a></h3>
   <p><b>TODO:</b> include pipeline diagram</p>
   <h2 class="heading settled" data-level="2" id="conventions"><span class="secno">2. </span><span class="content">Conventions</span><a class="self-link" href="#conventions"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="well-known-symbols"><span class="secno">2.1. </span><span class="content">Well-Known Symbols</span><a class="self-link" href="#well-known-symbols"></a></h3>
   <p>Well-known symbols are built-in Symbol values that are explicitly referenced by algorithms of this specification. They are typically used as the keys of properties whose values serve as extension points of a specification algorithm.</p>
   <p>Within this specification a well-known symbol is referred to by using a notation of the form @@<i>name</i>, where "<i>name</i>" is one of the values listed in table below:</p>
   <table>
    <thead>
     <tr>
      <th>Specification Name
      <th>[[Description]]
      <th>Value and Purpose
    <tbody>
     <tr>
      <td>@@resolve
      <td>"Reflect.Loader.resolve"
      <td>A function valued property that is the resolve hook function of loader’s instances.
     <tr>
      <td>@@fetch
      <td>"Reflect.Loader.fetch"
      <td>A function valued property that is the fetch hook function of loader’s instances.
     <tr>
      <td>@@translate
      <td>"Reflect.Loader.translate"
      <td>A function valued property that is the translate hook function of loader’s instances.
     <tr>
      <td>@@instantiate
      <td>"Reflect.Loader.instantiate"
      <td>A function valued property that is the instantiate hook function of loader’s instances.
   </table>
   <h3 class="heading settled" data-level="2.2" id="well-known-intrinsic-objects"><span class="secno">2.2. </span><span class="content">Well-Known Intrinsic Objects</span><a class="self-link" href="#well-known-intrinsic-objects"></a></h3>
   <p>Well-known intrinsics are built-in objects that are explicitly referenced by the algorithms of this specification and which usually have realm-specific identities. Unless otherwise specified each intrinsic object actually corresponds to a set of similar objects, one per realm.</p>
   <p>Within this specification a reference such as %<i>name</i>% means the intrinsic object, associated with the current realm, corresponding to the <i>name</i>. Determination of the current realm and its intrinsics is described in ES2015, 8.3.</p>
   <h3 class="heading settled" data-level="2.3" id="promises"><span class="secno">2.3. </span><span class="content">Promises</span><a class="self-link" href="#promises"></a></h3>
   <p>This spec makes heavy use of promises, and adopts the notational conventions established in the promises guide.</p>
   <h4 class="heading settled" data-level="2.3.1" id="reacting-to-promises"><span class="secno">2.3.1. </span><span class="content">Reacting to Promises</span><a class="self-link" href="#reacting-to-promises"></a></h4>
   <p><b><i>Transforming</i> p <i>with a new pass-through promise</i></b> is a shorthand for wrapping the promise to avoid exposing the original promise. It represents the following step:</p>
    <emu-alg>
1. Transforming _p_ with a fulfillment handler that, when called with argument _value_, returns _value_.
</emu-alg> 
   <h3 class="heading settled" data-level="2.4" id="shorthand-phrases"><span class="secno">2.4. </span><span class="content">Shorthand Phrases</span><a class="self-link" href="#shorthand-phrases"></a></h3>
   <h4 aoid="RejectIfAbrupt" class="heading settled" data-level="2.4.1" id="reject-if-abrupt"><span class="secno">2.4.1. </span><span class="content">RejectIfAbrupt(x)</span><a class="self-link" href="#reject-if-abrupt"></a></h4>
   <p>Algorithm steps that say</p>
    <emu-alg>
1. RejectIfAbrupt(_x_).
</emu-alg> 
   <p>mean the same thing as:</p>
    <emu-alg>
1. If _x_ is an abrupt completion, return a promise rejected with _x_.[[Value]].
1. Else if _x_ is a Completion Record, then let _x_ be _x_.[[Value]].
</emu-alg> 
   <h3 class="heading settled" data-level="2.5" id="common-operations"><span class="secno">2.5. </span><span class="content">Common Operations</span><a class="self-link" href="#common-operations"></a></h3>
   <h4 aoid="CreateObject" class="heading settled" data-level="2.5.1" id="create-object"><span class="secno">2.5.1. </span><span class="content">CreateObject()</span><a class="self-link" href="#create-object"></a></h4>
    <emu-alg>
1. Let _obj_ be ObjectCreate(%ObjectPrototype%).
1. Return _obj_.
</emu-alg> 
   <h4 aoid="SimpleDefine" class="heading settled" data-level="2.5.2" id="simple-define"><span class="secno">2.5.2. </span><span class="content">SimpleDefine(obj, name, value)</span><a class="self-link" href="#simple-define"></a></h4>
    <emu-alg>
1. Let _desc_ be a new PropertyDescriptor record {[[Value]]: _value_, [[Writable]]: *true*, [[Enumerable]]: *true*, [[Configurable]]: *true*}.
1. Return ? OrdinaryDefineOwnProperty(_obj_, _name_, _desc_).
</emu-alg> 
   <h3 class="heading settled" data-level="2.6" id="common-operations①"><span class="secno">2.6. </span><span class="content">Built-in Function Objects</span><a class="self-link" href="#common-operations①"></a></h3>
   <p>We follow the ECMA-262 <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-built-in-function-objects">convention for built-in function objects</a> in which the value of NewTarget in each function argument is <b>**undefined**</b> for [[Call]] and the <i>newTarget</i> parameter for [[Construct]].</p>
   <h2 class="heading settled" data-level="3" id="loader-objects"><span class="secno">3. </span><span class="content">Loader Objects</span><a class="self-link" href="#loader-objects"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="loader-constructor"><span class="secno">3.1. </span><span class="content">The Loader Constructor</span><a class="self-link" href="#loader-constructor"></a></h3>
   <p>The Loader constructor is the %Loader% intrinsic object and the initial value of the <b>Loader</b> property of the Reflect object. When called as a constructor it creates and initializes a new Loader object. When <b>Loader</b> is called as a function rather than as a constructor, it throws an exception.</p>
   <p>The <b>Loader</b> constructor is designed to be subclassable. It may be used as the value of an <b>extends</b> clause of a class definition. Subclass constructors that intend to inherit the specified <b>Loader</b> behaviour must include a <b>super</b> call to the <b>Loader</b> constructor to create and initialize the subclass instance with the corresponding internal slots.</p>
   <h4 class="heading settled" data-level="3.1.1" id="new-loader"><span class="secno">3.1.1. </span><span class="content">Loader()</span><a class="self-link" href="#new-loader"></a></h4>
   <p>When Loader is called with no arguments, the following steps are taken:</p>
    <emu-alg>
1. If NewTarget is *undefined*, then throw a *TypeError* exception.
1. Let _O_ be ? OrdinaryCreateFromConstructor(NewTarget, "%LoaderPrototype%", «[[Realm]], [[Registry]]»).
1. Set _O_’s [[Realm]] internal slot to current Realm Record.
1. Set _O_’s [[Registry]] internal slot to CreateRegistry().
1. Return _O_.
</emu-alg> 
   <h3 class="heading settled" data-level="3.2" id="properties-of-the-loader-constructor"><span class="secno">3.2. </span><span class="content">Properties of the Loader Constructor</span><a class="self-link" href="#properties-of-the-loader-constructor"></a></h3>
   <p>The value of the [[Prototype]] internal slot of the Loader constructor is the intrinsic object %FunctionPrototype%.</p>
   <p>The Loader constructor has the following properties:</p>
   <h4 class="heading settled" data-level="3.2.1" id="loader-prototype"><span class="secno">3.2.1. </span><span class="content">Loader.prototype</span><a class="self-link" href="#loader-prototype"></a></h4>
   <p>The initial value of Loader.prototype is the intrinsic object %LoaderPrototype%.</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
   <h3 class="heading settled" data-level="3.3" id="sec-properties-of-the-loader-prototype-object"><span class="secno">3.3. </span><span class="content">Properties of the Loader Prototype Object</span><a class="self-link" href="#sec-properties-of-the-loader-prototype-object"></a></h3>
   <h4 class="heading settled" data-level="3.3.1" id="Loader.prototype.constructor"><span class="secno">3.3.1. </span><span class="content">Loader.prototype.constructor</span><a class="self-link" href="#Loader.prototype.constructor"></a></h4>
   <p>The initial value of Loader.prototype.constructor is the intrinsic object %Loader%.</p>
   <h4 class="heading settled" data-level="3.3.2" id="loader-import"><span class="secno">3.3.2. </span><span class="content">Loader.prototype.import(name[, referrer])</span><a class="self-link" href="#loader-import"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _loader_ be *this* value.
1. If Type(_loader_) is not Object, throw a *TypeError* exception.
1. If _loader_ does not have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>), throw a *TypeError* exception.
1. Return the result of transforming Resolve(_loader_, _name_, _referrer_) with a fulfillment handler that, when called with argument _key_, runs the following steps:
  1. Let _entry_ be EnsureRegistered(_loader_, _key_).
  1. Return the result of transforming LoadModule(_entry_, "instantiate") with a fulfillment handler that, when called, runs the following steps:
    1. Return EnsureEvaluated(_entry_).
</emu-alg> 
   <h4 class="heading settled" data-level="3.3.3" id="loader-load-resolve"><span class="secno">3.3.3. </span><span class="content">Loader.prototype.resolve(name[, referrer])</span><a class="self-link" href="#loader-load-resolve"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _loader_ be *this* value.
1. If Type(_loader_) is not Object, throw a *TypeError* exception.
1. If _loader_ does not have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>), throw a *TypeError* exception.
1. Return the result of transforming Resolve(_loader_, _name_, _referrer_) with a new pass-through promise.
</emu-alg> 
   <h4 class="heading settled" data-level="3.3.4" id="loader-load"><span class="secno">3.3.4. </span><span class="content">Loader.prototype.load(name[, referrer[, stage]])</span><a class="self-link" href="#loader-load"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _loader_ be *this* value.
1. If Type(_loader_) is not Object, throw a *TypeError* exception.
1. If _loader_ does not have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>), throw a *TypeError* exception.
1. If _stage_ is *undefined* then let _stageValue_ be "instantiate".
1. Else let _stageValue_ be ToString(_stage_).
1. RejectIfAbrupt(_stageValue_).
1. If IsValidStageValue(_stageValue_) is *false*, return a promise rejected with a new *RangeError* exception.
1. Return the result of transforming Resolve(_loader_, _name_, _referrer_) with a fulfillment handler that, when called with argument _key_, runs the following steps:
  1. Let _entry_ be EnsureRegistered(_loader_, _key_).
  1. Return LoadModule(_entry_, _stageValue_).
</emu-alg> 
   <h4 class="heading settled" data-level="3.3.5" id="loader-registry"><span class="secno">3.3.5. </span><span class="content">get Loader.prototype.registry</span><a class="self-link" href="#loader-registry"></a></h4>
   <p><code>Loader.prototype.registry</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _loader_ be *this* value.
1. If Type(_loader_) is not Object, throw a *TypeError* exception.
1. If _loader_ does not have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>), throw a *TypeError* exception.
1. Return _loader_.[[Registry]].
</emu-alg> 
   <h4 class="heading settled" data-level="3.3.6" id="loader-@@tostringtag"><span class="secno">3.3.6. </span><span class="content">Loader.prototype [ @@toStringTag ]</span><a class="self-link" href="#loader-@@tostringtag"></a></h4>
   <p>The initial value of the @@toStringTag property is the String value "Object".</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: true }.</p>
   <h3 class="heading settled" data-level="3.4" id="loader-internal-slots"><span class="secno">3.4. </span><span class="content">Properties of Loader Instances</span><a class="self-link" href="#loader-internal-slots"></a></h3>
   <p>Loader instances are ordinary objects that inherit properties from the *Loader.prototype*.</p>
   <p>Loader instances are initially created with the internal slots described in the following table:</p>
   <table>
    <thead>
     <tr>
      <th>Internal Slot
      <th>Value Type (<em>non-normative</em>)
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>[[Realm]]
      <td>Realm Record
      <td>The realm this loader belongs to.
     <tr>
      <td>[[Registry]]
      <td>An object
      <td>An instance of <a href="#registry">Registry</a>.
   </table>
   <h2 class="heading settled" data-level="4" id="registry"><span class="secno">4. </span><span class="content">Registry Objects</span><a class="self-link" href="#registry"></a></h2>
   <h3 class="heading settled" data-level="4.1" id="registry-abstract-operations"><span class="secno">4.1. </span><span class="content">Abstract Operations for Registry Objects</span><a class="self-link" href="#registry-abstract-operations"></a></h3>
   <h4 aoid="CreateRegistry" class="heading settled" data-level="4.1.1" id="registry-CreateRegistry"><span class="secno">4.1.1. </span><span class="content">CreateRegistry()</span><a class="self-link" href="#registry-CreateRegistry"></a></h4>
   <p>The abstract operation CreateRegistry with no arguments performs the following steps:</p>
    <emu-alg>
1. Let _O_ be ? OrdinaryCreateFromConstructor(Registry, "%RegistryPrototype%", «[[RegistryMap]]» ).
1. Let _M_ be ObjectCreate(%MapIteratorPrototype%, «[[Map]], [[MapNextIndex]], [[MapIterationKind]]»).
1. Set _O_’s [[RegistryMap]] internal slot to _M_.
1. Return _O_.
</emu-alg> 
   <h3 class="heading settled" data-level="4.2" id="registry-constructor"><span class="secno">4.2. </span><span class="content">The Registry Constructor</span><a class="self-link" href="#registry-constructor"></a></h3>
   <p>The Registry constructor is the %Registry% intrinsic object. It is not intended to be called as a function or as a constructor and will always throw an exception.</p>
   <h3 class="heading settled" data-level="4.3" id="properties-of-the-registry-constructor"><span class="secno">4.3. </span><span class="content">Properties of the Registry Constructor</span><a class="self-link" href="#properties-of-the-registry-constructor"></a></h3>
   <p>The value of the [[Prototype]] internal slot of the Registry constructor is the intrinsic object %FunctionPrototype%.</p>
   <p>The Registry constructor has the following properties:</p>
   <h4 class="heading settled" data-level="4.3.1" id="registry-prototype"><span class="secno">4.3.1. </span><span class="content">Registry.prototype</span><a class="self-link" href="#registry-prototype"></a></h4>
   <p>The initial value of Registry.prototype is %RegistryPrototype%.</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
   <h3 class="heading settled" data-level="4.4" id="registry-prototype-object"><span class="secno">4.4. </span><span class="content">Properties of the Registry Prototype Object</span><a class="self-link" href="#registry-prototype-object"></a></h3>
   <h4 class="heading settled" data-level="4.4.1" id="registry-prototype-constructor"><span class="secno">4.4.1. </span><span class="content">Registry.prototype.constructor</span><a class="self-link" href="#registry-prototype-constructor"></a></h4>
   <p>The initial value of the constructor property of the %RegistryPrototype% object is the %Registry% object.</p>
    <emu-note>
Always throws to prevent the creation of new registry objects in user-land.
</emu-note> 
   <h4 class="heading settled" data-level="4.4.2" id="registry-prototype-@@iterator"><span class="secno">4.4.2. </span><span class="content">Registry.prototype[ @@iterator ]()</span><a class="self-link" href="#registry-prototype-@@iterator"></a></h4>
   <p>The initial value of the @@iterator property is the same function object as the initial value of the entries property.</p>
   <p>The value of the name property of this function is "[Symbol.iterator]".</p>
   <h4 class="heading settled" data-level="4.4.3" id="registry-prototype-entries"><span class="secno">4.4.3. </span><span class="content">Registry.prototype.entries()</span><a class="self-link" href="#registry-prototype-entries"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Return CreateMapIterator(_M_, "key+value").
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.4" id="registry-prototype-keys"><span class="secno">4.4.4. </span><span class="content">Registry.prototype.keys()</span><a class="self-link" href="#registry-prototype-keys"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Return CreateMapIterator(_M_, "key").
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.5" id="registry-prototype-values"><span class="secno">4.4.5. </span><span class="content">Registry.prototype.values()</span><a class="self-link" href="#registry-prototype-values"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Return CreateMapIterator(_M_, "value").
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.6" id="registry-prototype-get"><span class="secno">4.4.6. </span><span class="content">Registry.prototype.get(key)</span><a class="self-link" href="#registry-prototype-get"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Let _entries_ be the List that is the value of _M_’s [[MapData]] internal slot.
1. Repeat for each Record {[[key]], [[value]]} _p_ that is an element of _entries_,
  1. If _p_.[[key]] is not empty and SameValueZero(_p_.[[key]], _key_) is *true*, return _p_.[[value]].
1. Return *undefined*.
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.7" id="registry-prototype-set"><span class="secno">4.4.7. </span><span class="content">Registry.prototype.set(key, entry)</span><a class="self-link" href="#registry-prototype-set"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Let _entries_ be the List that is the value of _M_’s [[MapData]] internal slot.
1. Repeat for each Record {[[key]], [[value]]} _p_ that is an element of _entries_,
  1. If _p_.[[key]] is not empty and SameValueZero(_p_.[[key]], _key_) is *true*, then
    1. Set _p_.[[value]] to _entry_.
    1. Return _registry_.
1. Let _p_ be the Record {[[key]]: _key_, [[value]]: _entry_}.
1. Append _p_ as the last element of _entries_.
1. Return _registry_.
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.8" id="registry-prototype-has"><span class="secno">4.4.8. </span><span class="content">Registry.prototype.has(key)</span><a class="self-link" href="#registry-prototype-has"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Let _entries_ be the List that is the value of _M_’s [[MapData]] internal slot.
1. Repeat for each Record {[[key]], [[value]]} _p_ that is an element of _entries_,
  1. If _p_.[[key]] is not empty and SameValueZero(_p_.[[key]], _key_) is *true*, then, return *true*.
1. Return *false*.
</emu-alg> 
   <h4 class="heading settled" data-level="4.4.9" id="registry-prototype-delete"><span class="secno">4.4.9. </span><span class="content">Registry.prototype.delete(key)</span><a class="self-link" href="#registry-prototype-delete"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _registry_ be *this* value.
1. If Type(_registry_) is not Object, throw a *TypeError* exception.
1. If _registry_ does not have all of the internal slots of a Registry Instance (<a href="#registry-internal-slots">4.4</a>), throw a *TypeError* exception.
1. Let _M_ be _registry_.[[RegistryMap]].
1. Let _entries_ be the List that is the value of _M_’s [[MapData]] internal slot.
1. Repeat for each Record {[[key]], [[value]]} _p_ that is an element of _entries_,
  1. If _p_.[[key]] is not empty and SameValueZero(_p_.[[key]], _key_) is *true*, then
    1. Set _p_.[[key]] to empty.
    1. Set _p_.[[value]] to empty.
    1. Return *true*.
1. Return *false*.
</emu-alg> <emu-note>
  The value empty is used as a specification device to indicate that an entry has been deleted. Actual implementations may take other actions such as physically removing the entry from internal data structures.
</emu-note> 
   <h3 class="heading settled" data-level="4.5" id="registry-internal-slots"><span class="secno">4.5. </span><span class="content">Properties of Registry Instances</span><a class="self-link" href="#registry-internal-slots"></a></h3>
   <p>Registry instances are ordinary objects that inherit properties from the %RegistryPrototype%.</p>
   <p>Registry instances are initially created with the internal slots described in the following table:</p>
   <table>
    <thead>
     <tr>
      <th>Internal Slot
      <th>Value Type (<em>non-normative</em>)
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>[[RegistryMap]]
      <td>The Map object of pairs of String and <a href="#module-status">module status</a>.
      <td>The registry of installed modules.
   </table>
   <h2 class="heading settled" data-level="5" id="module-status"><span class="secno">5. </span><span class="content">ModuleStatus Objects</span><a class="self-link" href="#module-status"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="module-status-abstract-operations"><span class="secno">5.1. </span><span class="content">Abstract Operations for ModuleStatus Objects</span><a class="self-link" href="#module-status-abstract-operations"></a></h3>
   <h4 aoid="GetCurrentStage" class="heading settled" data-level="5.1.1" id="module-status-GetCurrentStage"><span class="secno">5.1.1. </span><span class="content">GetCurrentStage(entry)</span><a class="self-link" href="#module-status-GetCurrentStage"></a></h4>
   <p>The abstract operation GetCurrentStage with argument <i>entry</i> performs the following steps:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _stages_ be _entry_.[[Pipeline]].
1. Return the first element of _stages_.
</emu-alg> 
   <h4 aoid="GetCurrentStage" class="heading settled" data-level="5.1.2" id="module-status-IsValidStageValue"><span class="secno">5.1.2. </span><span class="content">IsValidStageValue(stage)</span><a class="self-link" href="#module-status-IsValidStageValue"></a></h4>
   <p>The abstract operation IsValidStageValue with argument <i>stage</i> performs the following steps:</p>
    <emu-alg>
1. Assert: Type(_stage_) is String.
1. If _stage_ is "fetch", "translate" or "instantiate", return *true*.
1. Else return *false*.
</emu-alg> 
   <h4 aoid="GetStage" class="heading settled" data-level="5.1.3" id="module-status-GetStage"><span class="secno">5.1.3. </span><span class="content">GetStage(entry, stage)</span><a class="self-link" href="#module-status-GetStage"></a></h4>
   <p>The abstract operation GetStage with arguments <i>entry</i> and <i>stage</i> performs the following steps:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Assert: Type(_stage_) is String.
1. Let _stages_ be _entry_.[[Pipeline]].
1. For each element _stageEntry_ of _stages_, do
  1. If _stageEntry_.[[Stage]] is equal to _stage_, return _stageEntry_.
1. Return *undefined*.
</emu-alg> 
   <h4 aoid="LoadModule" class="heading settled" data-level="5.1.4" id="module-status-LoadModule"><span class="secno">5.1.4. </span><span class="content">LoadModule(entry, stage)</span><a class="self-link" href="#module-status-LoadModule"></a></h4>
   <p>The abstract operation LoadModule with arguments <i>entry</i> and <i>stage</i> performs the following steps:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Assert: Type(_stage_) is String.
1. Assert: _stage_ is a valid stage value.
1. If _stage_ is "fetch", then:
  1. Return the result of transforming RequestFetch(_entry_) with a new pass-through promise.
1. If _stage_ is "translate", then:
  1. Return the result of transforming RequestTranslate(_entry_) with a new pass-through promise.
1. If _stage_ is "instantiate", then:
  1. Return the result of transforming RequestInstantiate(_entry_) with a new pass-through promise.
1. Return a promise rejected with a new *RangeError* exception.
</emu-alg> 
   <h4 aoid="UpgradeToStage" class="heading settled" data-level="5.1.5" id="module-status-UpgradeToStage"><span class="secno">5.1.5. </span><span class="content">UpgradeToStage(entry, stage)</span><a class="self-link" href="#module-status-UpgradeToStage"></a></h4>
   <p>The abstract operation UpgradeToStage with arguments <i>entry</i> and <i>stage</i> performs the following steps:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Assert: Type(_stage_) is String.
1. Let _pipeline_ be _entry_.[[Pipeline]].
1. Let _stageEntry_ be GetStage(_entry_, _stage_).
1. If _stageEntry_ is not *undefined*, then
  1. Repeat while the first element of _pipeline_ is not equal to _stageEntry_
    1. Remove first element from _pipeline_.
</emu-alg> <emu-note>
  The internal slot [[Pipeline]] of an entry can never be empty.
</emu-note> <emu-note>
  Alternative, this algo can be implemented using functional programming techniques or a reverse cycle to avoid walking the entries twice.
</emu-note> 
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="stage-entry">stage</dfn> is a record with the following fields:</p>
   <table>
    <thead>
     <tr>
      <th>Internal Slot
      <th>Value Type (<em>non-normative</em>)
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>[[Stage]]
      <td><code>"fetch"</code>, <code>"translate"</code>, <code>"instantiate"</code>
      <td>A constant value to indicating which phase the entry is at.
     <tr>
      <td>[[Result]]
      <td>Promise or <code>undefined</code>
      <td>A promise for the stage entry.
   </table>
   <p>Each [[Stage]] value indicates the currently pending operation. If the [[Result]] field is *undefined*, the operation has not been initiated; if the [[Result]] field is a promise, the operation has been initiated but not completed. Once a stage completes, its Stage Entry is removed from the pipeline. The following table describes the intended purpose of each stage of the pipeline:</p>
   <table>
    <thead>
     <tr>
      <th>Value
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td><code>"fetch"</code>
      <td>fetching the requested module (e.g. from a filesystem or network)
     <tr>
      <td><code>"translate"</code>
      <td>translating the fetched source (as via a preprocessor or compiler)
     <tr>
      <td><code>"instantiate"</code>
      <td>instantiating the translated source as a Module Record
   </table>
   <h3 class="heading settled" data-level="5.2" id="module-status-constructor"><span class="secno">5.2. </span><span class="content">The ModuleStatus Constructor</span><a class="self-link" href="#module-status-constructor"></a></h3>
   <p>The ModuleStatus constructor is the %ModuleStatus% intrinsic object and the initial value of the <b>Status</b> property of the Reflect.Module object. When called as a constructor it creates and initializes a new ModuleStatus object. When <b>ModuleStatus</b> is called as a function rather than as a constructor, it throws an exception.</p>
   <p>The <b>ModuleStatus</b> constructor is designed to be subclassable. It may be used as the value of an <b>extends</b> clause of a class definition. Subclass constructors that intend to inherit the specified <b>ModuleStatus</b> behaviour must include a <b>super</b> call to the <b>ModuleStatus</b> constructor to create and initialize the subclass instance with the corresponding internal slots.</p>
   <h4 aoid="ModuleStatus" class="heading settled" data-level="5.2.1" id="new-module-status"><span class="secno">5.2.1. </span><span class="content">ModuleStatus(loader, key, ns)</span><a class="self-link" href="#new-module-status"></a></h4>
   <p>When ModuleStatus is called with arguments <i>loader</i>, <i>key</i> and <i>ns</i>, the following steps are taken:</p>
    <emu-alg>
1. If NewTarget is *undefined*, then throw a *TypeError* exception.
1. If Type(_loader_) is not Object, throw a *TypeError* exception.
1. If _loader_ does not have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>), throw a *TypeError* exception.
1. Let _keyString_ be ? ToString(_key_).
1. Let _O_ be ? OrdinaryCreateFromConstructor(NewTarget, "%ModuleStatusPrototype%", «[[Loader]], [[Pipeline]], [[Key]], [[Module]], [[Metadata]], [[Dependencies]], [[Error]]» ).
1. Let _pipeline_ be a new List.
1. If _ns_ is *undefined*, then:
  1. Let _module_ be *undefined*.
  1. Let _deps_ be *undefined*.
  1. Add new stage entry record { [[Stage]]: "fetch", [[Result]]: *undefined* } as a new element of the list _pipeline_.
  1. Add new stage entry record { [[Stage]]: "translate", [[Result]]: *undefined* } as a new element of the list _pipeline_.
  1. Add new stage entry record { [[Stage]]: "instantiate", [[Result]]: *undefined* } as a new element of the list _pipeline_.
1. Else,
  1. If _ns_ is not a module namespace exotic object, throw a *TypeError* exception.
  1. Let _module_ be _ns_.[[Module]].
  1. Let _deps_ be a new empty List.
  1. Assert: _module_ is a Module Record.
  1. Assert: All [[RequestedModule]] of _module_ are safistied.
  1. Let _result_ be a promise resolved with _ns_.
  1. Add new stage entry record { [[Stage]]: "instantiate", [[Result]]: _result_ } as a new element of the list _pipeline_.
1. Set _O_’s [[Loader]] internal slot to _loader_.
1. Set _O_’s [[Pipeline]] internal slot to _pipeline_.
1. Set _O_’s [[Key]] internal slot to _keyString_.
1. Set _O_’s [[Module]] internal slot to _module_.
1. Set _O_’s [[Metadata]] internal slot to *undefined*.
1. Set _O_’s [[Dependencies]] internal slot to _deps_.
1. Set _O_’s [[Error]] internal slot to *false*.
1. Return _O_.
</emu-alg> <emu-note>
  A module status is associated to a loader instance at the time of its creation, the [[Loader]] backpointer reflects that.
</emu-note> <emu-note>
  The optional third argument ns allows to create a module status in a way that synchronously circumvents the asynchronous loading process.
</emu-note> <emu-note>
  A module status can be set into multiple Registry instances.
</emu-note> 
   <h3 class="heading settled" data-level="5.3" id="properties-of-the-module-status-constructor"><span class="secno">5.3. </span><span class="content">Properties of the ModuleStatus Constructor</span><a class="self-link" href="#properties-of-the-module-status-constructor"></a></h3>
   <p>The value of the [[Prototype]] internal slot of the Registry constructor is the intrinsic object %FunctionPrototype%.</p>
   <p>The ModuleStatus constructor has the following properties:</p>
   <h4 class="heading settled" data-level="5.3.1" id="module-status-prototype"><span class="secno">5.3.1. </span><span class="content">ModuleStatus.prototype</span><a class="self-link" href="#module-status-prototype"></a></h4>
   <p>The initial value of ModuleStatus.prototype is the intrinsic object %ModuleStatusPrototype%.</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
   <h3 class="heading settled" data-level="5.4" id="module-status-prototype-object"><span class="secno">5.4. </span><span class="content">Properties of the ModuleStatus Prototype Object</span><a class="self-link" href="#module-status-prototype-object"></a></h3>
   <h4 class="heading settled" data-level="5.4.1" id="module-status-prototype-constructor"><span class="secno">5.4.1. </span><span class="content">ModuleStatus.prototype.constructor</span><a class="self-link" href="#module-status-prototype-constructor"></a></h4>
   <p>The initial value of ModuleStatus.prototype.constructor is the intrinsic object %ModuleStatus%.</p>
   <h4 class="heading settled" data-level="5.4.2" id="module-status-stage"><span class="secno">5.4.2. </span><span class="content">get ModuleStatus.prototype.stage</span><a class="self-link" href="#module-status-stage"></a></h4>
   <p><code>ModuleStatus.prototype.stage</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Let _stageEntry_ be GetCurrentStage(_entry_).
1. Return _stageEntry_.[[Stage]].
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.3" id="module-status-module"><span class="secno">5.4.3. </span><span class="content">get ModuleStatus.prototype.originalKey</span><a class="self-link" href="#module-status-module"></a></h4>
   <p><code>ModuleStatus.prototype.originalKey</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Return _entry_.[[Key]].
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.4" id="module-status-module①"><span class="secno">5.4.4. </span><span class="content">get ModuleStatus.prototype.module</span><a class="self-link" href="#module-status-module①"></a></h4>
   <p><code>ModuleStatus.prototype.module</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Let _module_ be _entry_.[[Module]].
1. If _module_ is a Module Record, return GetModuleNamespace(_module_).
1. Return *undefined*.
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.5" id="module-status-error"><span class="secno">5.4.5. </span><span class="content">get ModuleStatus.prototype.error</span><a class="self-link" href="#module-status-error"></a></h4>
   <p><code>ModuleStatus.prototype.error</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Return _entry_.[[Error]].
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.6" id="module-status-error①"><span class="secno">5.4.6. </span><span class="content">get ModuleStatus.prototype.dependencies</span><a class="self-link" href="#module-status-error①"></a></h4>
   <p><code>ModuleStatus.prototype.dependencies</code> is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, throw a *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), throw a *TypeError* exception.
1. Let _array_ be ArrayCreate(0).
1. Let _n_ be 0.
1. For each _pair_ in _entry_.[[Dependencies]], do:
  1. Let _O_ be ObjectCreate(%ObjectPrototype%).
  1. Let _requestNameDesc_ be the PropertyDescriptor{[[Value]]: _pair_.[[RequestName]], [[Writable]]: *false*, [[Enumerable]]: *true*, [[Configurable]]: *false*}.
  1. Perform ? DefinePropertyOrThrow(_O_, "requestName", _requestNameDesc_).
  1. Let _moduleStatusDesc_ be the PropertyDescriptor{[[Value]]: _pair_.[[ModuleStatus]], [[Writable]]: *false*, [[Enumerable]]: *true*, [[Configurable]]: *false*}.
  1. Perform ? DefinePropertyOrThrow(_O_, "entry", _moduleStatusDesc_).
  1. Perform ? CreateDataProperty(_array_, ? ToString(_n_), _O_).
  1. Increment _n_ by 1.
1. Return _array_.
</emu-alg> <emu-note>
  The dependencies accessor provides access to the dependency graph, exposing each dependency’s requestName, key and entry reference.
</emu-note> 
   <h4 class="heading settled" data-level="5.4.7" id="module-status-prototype-load"><span class="secno">5.4.7. </span><span class="content">ModuleStatus.prototype.load(stage)</span><a class="self-link" href="#module-status-prototype-load"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, return a promise rejected with a new *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), return a promise rejected with a new *TypeError* exception.
1. If _stage_ is *undefined*, let _stageValue_ be "fetch"; otherwise, let _stageValue_ be ToString(_stage_).
1. RejectIfAbrupt(_stageValue_).
1. If IsValidStageValue(_stageValue_) is *false*, return a promise rejected with a new *RangeError* exception.
1. Return LoadModule(_entry_, _stageValue_).
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.8" id="module-status-prototype-result"><span class="secno">5.4.8. </span><span class="content">ModuleStatus.prototype.result(stage)</span><a class="self-link" href="#module-status-prototype-result"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, return a promise rejected with a new *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), return a promise rejected with a new *TypeError* exception.
1. Let _stageValue_ be ToString(_stage_).
1. RejectIfAbrupt(_stageValue_).
1. If IsValidStageValue(_stageValue_) is *false*, return a promise rejected with a new *RangeError* exception.
1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
1. If _stageEntry_ is *undefined*, return a promise resolved with *undefined*.
1. If _stageEntry_.[[Result]] is *undefined*, return a promise resolved with *undefined*.
1. Return the result of transforming _stageEntry_.[[Result]] with a new pass-through promise.
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.9" id="module-status-prototype-resolve"><span class="secno">5.4.9. </span><span class="content">ModuleStatus.prototype.resolve(stage, result)</span><a class="self-link" href="#module-status-prototype-resolve"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, return a promise rejected with a new *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), return a promise rejected with a new *TypeError* exception.
1. Let _stageValue_ be ToString(_stage_).
1. RejectIfAbrupt(_stageValue_).
1. If IsValidStageValue(_stageValue_) is *false*, return a promise rejected with a new *RangeError* exception.
1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
1. If _stageEntry_ is *undefined*, return a promise rejected with a new *TypeError* exception.
1. Perform UpgradeToStage(_entry_, _stageValue_).
1. Let _p0_ be the result of transforming _result_ with a new pass-through promise.
1. Let _p1_ be the result of transforming _p0_ with a fulfillment handler that, when called with argument _value_, runs the following steps:
  1. If _stageValue_ is "instantiate", then:
    1. Return the result of transforming SatisfyInstance(_entry_, _value_, *undefined*, *undefined*) with a fulfillment handler that, when called with value _instance_, runs the following steps:
      1. Set _entry_.[[Module]] to _instance_.
      1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
      1. Assert: _stageEntry_ is not *undefined*.
      1. Fulfill _stageEntry_.[[Result]] with _value_.
  1. Else,
    1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
    1. If _stageEntry_ is *undefined*, throw a new *TypeError*.
    1. Fulfill _stageEntry_.[[Result]] with _value_.
1. Let _pCatch_ be the result of transforming _p1_ with a rejection handler that, when called, runs the following steps:
  1. Set _entry_.[[Error]] to *true*.
1. If _stageEntry_.[[Result]] is *undefined*, set _stageEntry_.[[Result]] to _p1_.
1. Return _p1_.
</emu-alg> 
   <h4 class="heading settled" data-level="5.4.10" id="module-status-prototype-reject"><span class="secno">5.4.10. </span><span class="content">ModuleStatus.prototype.reject(stage, error)</span><a class="self-link" href="#module-status-prototype-reject"></a></h4>
   <p>The following steps are taken:</p>
    <emu-alg>
1. Let _entry_ be *this* value.
1. If Type(_entry_) is not Object, return a promise rejected with a new *TypeError* exception.
1. If _entry_ does not have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>), return a promise rejected with a new *TypeError* exception.
1. Let _stageValue_ be ToString(_stage_).
1. RejectIfAbrupt(_stageValue_).
1. If IsValidStageValue(_stageValue_) is *false*, return a promise rejected with a new *RangeError* exception.
1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
1. If _stageEntry_ is *undefined*, return a promise rejected with a new *TypeError* exception.
1. Perform UpgradeToStage(_entry_, _stageValue_).
1. Let _p0_ be the result of transforming _error_ with a new pass-through promise.
1. Let _p1_ be the result of transforming _p0_ with a fulfillment handler that, when called with argument _value_, runs the following steps:
  1. Let _stageEntry_ be GetStage(_entry_, _stageValue_).
  1. If _stageEntry_ is *undefined*, throw a new *TypeError*.
  1. Reject _stageEntry_.[[Result]] with _value_.
1. Let _pCatch_ be the result of transforming _p1_ with a rejection handler that, when called, runs the following steps:
  1. Set _entry_.[[Error]] to *true*.
1. If _stageEntry_.[[Result]] is *undefined*, set _stageEntry_.[[Result]] to _p1_.
1. Return _p1_.
</emu-alg> 
   <h3 class="heading settled" data-level="5.5" id="module-status-internal-slots"><span class="secno">5.5. </span><span class="content">Properties of ModuleStatus Instances</span><a class="self-link" href="#module-status-internal-slots"></a></h3>
   <p>ModuleStatus instances are ordinary objects that inherit properties from the %ModuleStatusPrototype%.</p>
   <p>ModuleStatus instances are initially created with the internal slots described in the following table:</p>
   <table>
    <thead>
     <tr>
      <th>Internal Slot
      <th>Value Type (<em>non-normative</em>)
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>[[Loader]]
      <td>An object
      <td>The loader this module status belongs to.
     <tr>
      <td>[[Pipeline]]
      <td>A List
      <td>A list whose elements are stage records.
     <tr>
      <td>[[Key]]
      <td>A String
      <td>A value that identifies what key was used to create the module status instance.
     <tr>
      <td>[[Metadata]]
      <td>Object or <code>undefined</code>
      <td>The metadata object passed through the pipeline.
     <tr>
      <td>[[Dependencies]]
      <td>List of Records of the form {[[RequestName]]: String, [[ModuleStatus]]: Module Status} .
      <td>Table mapping unresolved names to their resolved key and module status entries.
     <tr>
      <td>[[Module]]
      <td>Module Record or Function object or <code>undefined</code>
      <td>The Module Record or a thunk after the module has been satisfied; otherwise <code>undefined</code>.
     <tr>
      <td>[[Error]]
      <td>A Boolean
      <td>A boolean valued that if <b>true</b> indicates that an error that was encountered during one of the phases of the loading pipeline; <b>false</b> if no error has been encountered.
   </table>
   <h2 class="heading settled" data-level="6" id="pipeline-semantics"><span class="secno">6. </span><span class="content">Loading Semantics</span><a class="self-link" href="#pipeline-semantics"></a></h2>
   <h3 class="heading settled" data-level="6.1" id="auxiliary-operations"><span class="secno">6.1. </span><span class="content">Auxiliary Operations</span><a class="self-link" href="#auxiliary-operations"></a></h3>
   <h4 aoid="EnsureRegistered" class="heading settled" data-level="6.1.1" id="ensure-registered"><span class="secno">6.1.1. </span><span class="content">EnsureRegistered(loader, key)</span><a class="self-link" href="#ensure-registered"></a></h4>
   <p>When the abstract operation EnsureRegistered is called with arguments <i>loader</i> and <i>key</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _loader_ must have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>).
1. Assert: Type(_key_) is String.
1. Let _registry_ be _loader_.[[Registry]].
1. Let _M_ be registry.[[RegistryMap]].
1. Let _entries_ be the List that is the value of _M_’s [[MapData]] internal slot.
1. Let _pair_ be the entry in _entries_ such that _pair_.[[key]] is equal to _key_.
1. If _pair_ exists, then:
  1. Let _entry_ be _pair_.[[value]].
1. Else,
  1. Let _entry_ be a new ModuleStatus(_loader_, _key_).
  1. Let _p_ be the Record {[[key]]: key, [[value]]: entry}.
  1. Append _p_ as the last element of _entries_.
1. Return _entry_.
</emu-alg> 
   <h4 aoid="Resolve" class="heading settled" data-level="6.1.2" id="resolve"><span class="secno">6.1.2. </span><span class="content">Resolve(loader, name, referrer)</span><a class="self-link" href="#resolve"></a></h4>
   <p>When the abstract operation Resolve is called with arguments <i>loader</i>, <i>name</i> and <i>referrer</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _loader_ must have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>).
1. Assert: Type(_name_) is String.
1. Assert: Type(_referrer_) is String.
1. Let _hook_ be GetMethod(_loader_, @@resolve).
1. Return the result of promise-calling _hook_(_name_, _referrer_).
</emu-alg> 
   <h4 aoid="ExtractDependencies" class="heading settled" data-level="6.1.3" id="extract-dependencies"><span class="secno">6.1.3. </span><span class="content">ExtractDependencies(entry, instance)</span><a class="self-link" href="#extract-dependencies"></a></h4>
   <p>When the abstract operation ExtractDependencies is called with arguments <i>entry</i> and <i>instance</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _deps_ be a new empty List.
1. If _instance_ is a Source Text Module Record, then:
  1. For each _dep_ in _instance_.[[RequestedModules]], do:
    1. Append the record { [[RequestName]]: _dep_, [[ModuleStatus]]: *undefined* } to _deps_.
1. Set _entry_.[[Dependencies]] to _deps_.
</emu-alg> <emu-note>
  [[Key]] will identify the dependency module status in the entry’s corresponding loader.
</emu-note> 
   <h4 aoid="Instantiation" class="heading settled" data-level="6.1.4" id="instantiation"><span class="secno">6.1.4. </span><span class="content">Instantiation(loader, optionalInstance, source)</span><a class="self-link" href="#instantiation"></a></h4>
   <p>When the abstract operation Instantiation is called with arguments <i>loader</i>, <i>optionalInstance</i> and <i>source</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _loader_ must have all of the internal slots of a Loader Instance (<a href="#loader-internal-slots">3.4</a>).
1. If _optionalInstance_ is *undefined*, then:
  1. If _source_ is not a ECMAScript source text, throw new *TypeError*.
  1. Let _realm_ be _loader_.[[Realm]].
  1. Return ? ParseModule(_source_, _realm_, *undefined*).
1. If _optionalInstance_ is a namespace exotic object, return _optionalInstance_.[[Module]].
1. If IsCallable(_optionalInstance_) is *false* then throw a new *TypeError*.
1. Return _optionalInstance_.
</emu-alg> 
   <h3 class="heading settled" data-level="6.2" id="loading-operations"><span class="secno">6.2. </span><span class="content">Loading Operations</span><a class="self-link" href="#loading-operations"></a></h3>
   <h4 aoid="RequestFetch" class="heading settled" data-level="6.2.1" id="request-fetch"><span class="secno">6.2.1. </span><span class="content">RequestFetch(entry)</span><a class="self-link" href="#request-fetch"></a></h4>
   <p>When the abstract operation RequestFetch is called with argument <i>entry</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _fetchStageEntry_ be GetStage(_entry_, "fetch").
1. If _fetchStageEntry_ is *undefined*, return a promise resolved with *undefined*.
1. If _fetchStageEntry_.[[Result]] is not *undefined*, return _fetchStageEntry_.[[Result]].
1. Let _hook_ be GetMethod(_entry_.[[Loader]], @@fetch).
1. Let _hookResult_ be the result of promise-calling _hook_(_entry_, _entry_.[[Key]]).
1. Let _p_ be the result of transforming _hookResult_ with a fulfillment handler that, when called with argument _payload_, runs the following steps:
  1. Perform UpgradeToStage(_entry_, "translate").
  1. Return _payload_.
1. Let _pCatch_ be the result of transforming _p_ with a rejection handler that, when called, runs the following steps:
  1. Set _entry_.[[Error]] to *true*.
1. Set _fetchStageEntry_.[[Result]] to _p_.
1. Return _p_.
</emu-alg> 
   <h4 aoid="RequestTranslate" class="heading settled" data-level="6.2.2" id="request-translate"><span class="secno">6.2.2. </span><span class="content">RequestTranslate(entry)</span><a class="self-link" href="#request-translate"></a></h4>
   <p>When the abstract operation RequestTranslate is called with argument <i>entry</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _translateStageEntry_ be GetStage(_entry_, "translate").
1. If _translateStageEntry_ is *undefined*, return a promise resolved with *undefined*.
1. If _translateStageEntry_.[[Result]] is not *undefined*, return _translateStageEntry_.[[Result]].
1. Let _p_ be the result of transforming RequestFetch(_entry_) with a fulfillment handler that, when called with argument _payload_, runs the following steps:
  1. Let _hook_ be GetMethod(_entry_.[[Loader]], @@translate).
  1. Let _hookResult_ be the result of promise-calling _hook_(_entry_, _payload_).
  1. Return the result of transforming _hookResult_ with a fulfillment handler that, when called with argument _source_, runs the following steps:
    1. Perform UpgradeToStage(_entry_, "instantiate").
    1. Return _source_.
1. Let _pCatch_ be the result of transforming _p_ with a rejection handler that, when called, runs the following steps:
  1. Set _entry_.[[Error]] to *true*.
1. Set _translateStageEntry_.[[Result]] to _p_.
1. Return _p_.
</emu-alg> 
   <h4 aoid="RequestInstantiate" class="heading settled" data-level="6.2.3" id="request-instantiate"><span class="secno">6.2.3. </span><span class="content">RequestInstantiate(entry, instantiateSet)</span><a class="self-link" href="#request-instantiate"></a></h4>
   <p>When the abstract operation RequestInstantiate is called with arguments <i>entry</i> and <i>instantiateSet</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _instantiateStageEntry_ be GetStage(_entry_, "instantiate").
1. If _instantiateStageEntry_ is *undefined*, return a promise resolved with *undefined*.
1. If _instantiateStageEntry_.[[Result]] is not *undefined*, return _instantiateStageEntry_.[[Result]].
1. Let _p_ be the result of transforming RequestTranslate(_entry_) with a fulfillment handler that, when called with argument _source_, runs the following steps:
  1. Let _hook_ be GetMethod(_entry_.[[Loader]], @@instantiate).
  1. Let _hookResult_ be the result of promise-calling _hook_(_entry_, _source_).
  1. Return the result of transforming _hookResult_ with a fulfillment handler that, when called with argument _optionalInstance_, runs the following steps:
    1. Return the result of transforming SatisfyInstance(_entry_, _optionalInstance_, _source_, _instantiateSet_) with a fulfillment handler that, when called with value _instance_, runs the following steps:
      1. Set _entry_.[[Module]] to _instance_.
      1. Return _optionalInstance_.
1. Let _pCatch_ be the result of transforming _p_ with a rejection handler that, when called, runs the following steps:
  1. Set _entry_.[[Error]] to *true*.
1. Set _instantiateStageEntry_.[[Result]] to _p_.
1. Return _p_.
</emu-alg> 
   <h4 aoid="SatisfyInstance" class="heading settled" data-level="6.2.4" id="satisfy-instance"><span class="secno">6.2.4. </span><span class="content">SatisfyInstance(entry, optionalInstance, source, instantiateSet)</span><a class="self-link" href="#satisfy-instance"></a></h4>
   <p>When the abstract operation SatisfyInstance is called with arguments <i>entry</i>, <i>optionalInstance</i>, <i>source</i> and <i>instantiateSet</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. If _instantiateSet_ is *undefined*, Set _instantiateSet_ to a new empty List.
1. If _entry_ is already in _instantiateSet_, return *undefined*.
1. Append _entry_ to _instantiateSet_.
1. Let _loader_ be _entry_.[[Loader]].
1. Let _instance_ be ? Instantiation(_loader_, _optionalInstance_, _source_).
1. If _instance_ is a Module Record, then:
  1. Set _instance_.[[ModuleStatus]] to _entry_.
1. Perform ? ExtractDependencies(_entry_, _instance_).
1. Let _list_ be a new empty List.
1. For each _pair_ in _entry_.[[Dependencies]], do:
  1. Let _p_ be the result of transforming Resolve(_loader_, _pair_.[[RequestName]], _entry_.[[Key]]) with a fulfillment handler that, when called with value _depKey_, runs the following steps:
    1. Let _depEntry_ be EnsureRegistered(_loader_, _depKey_).
    1. If _depEntry_ is already in _instantiateSet_, return *undefined*.
    1. Set _pair_.[[ModuleStatus]] to _depEntry_.
    1. Return RequestInstantiate(_depEntry_, _instantiateSet_).
  1. Append _p_ to _list_.
1. Return the result of waiting for all _list_ with a fulfillment handler that, when called, return _instance_.
</emu-alg> <emu-note>
  This abstract operation guarantees that all [[Dependencies]] are instantiated and ready to be linked and evaluated.
</emu-note> 
   <h2 class="heading settled" data-level="7" id="linking-semantics"><span class="secno">7. </span><span class="content">Linking Semantics</span><a class="self-link" href="#linking-semantics"></a></h2>
   <h3 class="heading settled" data-level="7.1" id="resolving-dependencies"><span class="secno">7.1. </span><span class="content">Resolving Dependencies</span><a class="self-link" href="#resolving-dependencies"></a></h3>
   <h4 aoid="HostResolveImportedModule" class="heading settled" data-level="7.1.1" id="host-resolve-imported-module"><span class="secno">7.1.1. </span><span class="content">HostResolveImportedModule(module, requestName)</span><a class="self-link" href="#host-resolve-imported-module"></a></h4>
   <p>The modules spec should only invoke this abstract operation from methods of Source Text Module Records, and this spec does not invoke the operation at all.</p>
   <p>When the abstract operation HostResolveImportedModule is called with arguments <i>module</i> and <i>requestName</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _module_ is a Source Text Module Record.
1. Assert: Type(_requestName_) is String.
1. Let _entry_ be _module_.[[ModuleStatus]].
1. Let _currentStageEntry_ be GetCurrentStage(_entry_).
1. Assert: _currentStageEntry_.[[Stage]] is "instantiate" and _currentStageEntry_.[[Result]] is a resolved promise.
1. Let _pair_ be the pair in _entry_.[[Dependencies]] such that _pair_.[[RequestName]] is equal to _requestName_.
1. Assert: _pair_ is defined.
1. Let _depEntry_ be _pair_.[[ModuleStatus]].
1. Let _depStageEntry_ be GetCurrentStage(_depEntry_).
1. Assert: _depStageEntry_.[[Stage]] is "instantiate" and _depStageEntry_.[[Result]] is a resolved promise.
1. Return _depEntry_.[[Module]].
</emu-alg> 
   <h3 class="heading settled" data-level="7.2" id="linking"><span class="secno">7.2. </span><span class="content">Linking</span><a class="self-link" href="#linking"></a></h3>
   <h4 aoid="DependencyGraph" class="heading settled" data-level="7.2.1" id="dependency-graph"><span class="secno">7.2.1. </span><span class="content">DependencyGraph(root)</span><a class="self-link" href="#dependency-graph"></a></h4>
   <p>When the abstract operation DependencyGraph is called with argument <i>root</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _root_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _result_ be a new empty List.
1. Call ComputeDependencyGraph(_root_, _result_).
1. Return _result_.
</emu-alg> 
   <h4 aoid="ComputeDependencyGraph" class="heading settled" data-level="7.2.2" id="compute-dependency-graph"><span class="secno">7.2.2. </span><span class="content">ComputeDependencyGraph(entry, result)</span><a class="self-link" href="#compute-dependency-graph"></a></h4>
   <p>When the abstract operation ComputeDependencyGraph is called with arguments <i>entry</i> and <i>result</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Assert: _result_ must be a List.
1. If _entry_ is already in _result_, return *undefined*.
1. Insert _entry_ as the first element of _result_.
1. For each _pair_ in _entry_.[[Dependencies]], do:
  1. Assert: _pair_.[[ModuleStatus]] is defined.
  1. Call ComputeDependencyGraph(_pair_.[[ModuleStatus]], _result_).
1. Return *undefined*.
</emu-alg> 
   <h4 aoid="EnsureLinked" class="heading settled" data-level="7.2.3" id="ensure-linked"><span class="secno">7.2.3. </span><span class="content">EnsureLinked(entry)</span><a class="self-link" href="#ensure-linked"></a></h4>
   <p>When the abstract operation EnsureLinked is called with argument <i>entry</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _deps_ be DependencyGraph(_entry_).
1. For each _dep_ in _deps_, do:
  1. Let _depStageEntry_ be GetCurrentStage(_dep_).
  1. Assert: _depStageEntry_.[[Stage]] is "instantiate" and _depStageEntry_.[[Result]] is a resolved promise.
  1. If _dep_.[[Module]] is a Function object, then:
    1. Let _func_ be _dep_.[[Module]].
    1. Let _argList_ be a new empty List.
    1. Let _ns_ be ? Call(_func_, *undefined*, _argList_).
    1. If _ns_ is not a module namespace exotic object, throw a *TypeError* exception.
    1. Set _dep_.[[Module]] to _ns_.[[Module]].
1. Assert: the following sequence is guaranteed not to run any user code.
1. For each _dep_ in _deps_, do:
  1. Let _module_ be _dep_.[[Module]].
  1. Assert: _module_ is a Module Record.
  1. Perform ? _module_.ModuleDeclarationInstantiation().
</emu-alg> 
   <h4 aoid="EnsureEvaluated" class="heading settled" data-level="7.2.4" id="ensure-evaluated"><span class="secno">7.2.4. </span><span class="content">EnsureEvaluated(entry)</span><a class="self-link" href="#ensure-evaluated"></a></h4>
   <p>When the abstract operation EnsureEvaluated is called with argument <i>entry</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _entry_ must have all of the internal slots of a ModuleStatus Instance (<a href="#module-status-internal-slots">5.5</a>).
1. Let _stageEntry_ be GetCurrentStage(_entry_).
1. Assert: _stageEntry_.[[Stage]] is "instantiate" and _stageEntry_.[[Result]] is a resolved promise.
1. Let _module_ be _entry_.[[Module]].
1. If _module_.[[Evaluated]] is *false*, then:
  1. Perform ? EnsureLinked(entry).
  1. Perform ? _module_.ModuleEvaluation().
1. Return ? GetModuleNamespace(_module_).
</emu-alg> 
   <h2 class="heading settled" data-level="8" id="module-objects"><span class="secno">8. </span><span class="content">Module Objects</span><a class="self-link" href="#module-objects"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="reflective-module-record"><span class="secno">8.1. </span><span class="content">Reflective Module Records</span><a class="self-link" href="#reflective-module-record"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="reflective-module-record①">reflective module record</dfn> is a kind of module record. In addition to the fields defined in ES2016 Table 37, Reflective Module Records have the additional fields listed below. Each of these fields initially has the value <b>undefined</b>.</p>
   <table>
    <thead>
     <tr>
      <th>Internal Slot
      <th>Value Type (<em>non-normative</em>)
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>[[LocalExports]]
      <td>A List of Strings
      <td>The set of exported names stored in this module’s environment.
     <tr>
      <td>[[IndirectExports]]
      <td>A List of pairs of String and {[[module]]: Module Record, [[bindingName]]: String}.
      <td>The set of re-exported bindings. This ensures that ResolveExport can fully resolve re-exports.
     <tr>
      <td>[[Evaluate]]
      <td>A function object or <code>undefined</code>
      <td>A thunk to call when the module is evaluated, or <code>undefined</code> if the module is already evaluated.
   </table>
   <p>-</p>
   <h3 class="heading settled" data-level="8.2" id="module-abstract-operations"><span class="secno">8.2. </span><span class="content">Abstract Operations for Module Objects</span><a class="self-link" href="#module-abstract-operations"></a></h3>
   <p></p>
   <h4 aoid="ParseExportsDescriptors" class="heading settled" data-level="8.2.1" id="parse-exports-descriptors"><span class="secno">8.2.1. </span><span class="content">ParseExportsDescriptors(obj)</span><a class="self-link" href="#parse-exports-descriptors"></a></h4>
   <p>When the abstract operation ParseExportsDescriptors is called with argument <i>obj</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: Type(_obj_) is an Object.
1. Let _props_ be ? ToObject(Obj).
1. Let _keys_ be ? _props_.[[OwnPropertyKeys]]().
1. Let _descriptors_ be an empty List.
1. Repeat for each element _nextKey_ of _keys_ in List order,
  1. Let _propDesc_ be ? props.[[GetOwnProperty]](_nextKey_).
  1. If _propDesc_ is not *undefined* and _propDesc_.[[Enumerable]] is *true*, then
    1. Let _descObj_ be ? Get(_props_, _nextKey_).
    1. Let _hasModule_ be ? HasProperty(_descObj_, "module").
    1. If _hasModule_ is *true*, then
      1. Let _ns_ be ? Get(_descObj_, "module").
      1. If _ns_ is not a module namespace exotic object, throw a *TypeError* exception.
      1. Let _import_ be ToString(? Get(_descObj_, "import")).
      1. Let _desc_ be a new Indirect Export Descriptor Record {[[Name]]: _nextKey_, [[Module]]: _ns_.[[Module]], [[Import]]: _import_}.
    1. Else,
      1. Let _hasValue_ be ? HasProperty(_descObj_, "value").
      1. If _hasValue_ is *true*, let _value_ be ? Get(_descObj_, "value").
      1. Let _hasConst_ be ? HasProperty(_descObj_, "const").
      1. If _hasConst_ is *true*, let _isConst_ be ToBoolean(? Get(_descObj_, "const")).
      1. If _isConst_ is *true*, then
        1. If _hasValue_ is *true*, then
          1. Let _desc_ be a new Immutable Export Descriptor Record {[[Name]]: _nextKey_, [[Value]]: _value_, [[Initialized]]: *true*}.
        1. Else,
          1. Let _desc_ be a new Immutable Export Descriptor Record {[[Name]]: _nextKey_, [[Value]]: *undefined*, [[Initialized]]: *false*}.
      1. Else,
        1. If _hasValue_ is *true*, then
          1. Let _desc_ be a new Mutable Export Descriptor Record {[[Name]]: _nextKey_, [[Value]]: _value_, [[Initialized]]: *true*}.
        1. Else,
          1. Let _desc_ be a new Mutable Export Descriptor Record {[[Name]]: _nextKey_, [[Value]]: *undefined*, [[Initialized]]: *false*}.
    1. Append _desc_ to the end of _descriptors_.
1. Return _descriptors_.
</emu-alg> <emu-note>
  Parse as in <a href="https://gist.github.com/dherman/fbf3077a2781df74b6d8">these examples</a>
  <ul>
    <li>uninitialized, mutable: <code>{ }</code>
    </li><li>uninitialized, immutable: <code>{ const: true }</code>
    </li><li>initialized, mutable: <code>{ value: 42 }</code>
    </li><li>initialized, immutable: <code>{ value: 42, const: true }</code>
    </li><li>re-export (immutable): <code>{ module: m, import: "foo" }</code>
  </li></ul>
</emu-note> 
   <h4 aoid="CreateModuleMutator" class="heading settled" data-level="8.2.2" id="create-module-mutator"><span class="secno">8.2.2. </span><span class="content">CreateModuleMutator(module)</span><a class="self-link" href="#create-module-mutator"></a></h4>
   <p>When the abstract operation CreateModuleMutator is called with argument <i>module</i>, the following steps are taken:</p>
    <emu-alg>
1. Assert: _module_ is a Reflective Module Records.
1. Let _mutator_ be ObjectCreate(%ObjectPrototype%).
1. Let _env_ be _module_.[[Environment]].
1. Let _envRec_ be env’s environment record.
1. For each _name_ in _module_.[[LocalExports]], do:
  1. Assert: _mutator_ does not already have a binding for _name_.
  1. Let _p_ be MakeArgSetter(_name_, _envRec_).
  1. Let _localExportDesc_ be the PropertyDescriptor{[[Get]]: %ThrowTypeError%, [[Set]]: _p_, [[Enumerable]]: true, [[Configurable]]: false}.
  1. Perform ? DefinePropertyOrThrow(_mutator_, _name_, _localExportDesc_).
1. Return _mutator_.
</emu-alg> 
   <h4 aoid="GetExportNames" class="heading settled" data-level="8.2.3" id="get-export-names"><span class="secno">8.2.3. </span><span class="content">GetExportNames(exportStarStack)</span><a class="self-link" href="#get-export-names"></a></h4>
   <p>When the abstract operation GetExportNames is called with argument <i>exportStarStack</i>, the following steps are taken:</p>
    <emu-alg>
1. Let _module_ be this Reflective Module Record.
1. Let _exports_ be a new empty List.
1. For each _name_ in _module_.[[LocalExports]], do:
  1. Append _name_ to _exports_.
1. For each _pair_ in _module_.[[IndirectExports]], do:
  1. Append _pair_.[[Key]] to _exports_.
1. Return _exports_.
</emu-alg> 
   <h4 aoid="ResolveExport" class="heading settled" data-level="8.2.4" id="resolve-export"><span class="secno">8.2.4. </span><span class="content">ResolveExport(exportName, resolveStack, exportStarStack)</span><a class="self-link" href="#resolve-export"></a></h4>
   <p>When the abstract operation ResolveExport is called with arguments <i>exportName</i>, <i>resolveStack</i> and <i>exportStarStack</i>, the following steps are taken:</p>
    <emu-alg>
1. Let _module_ be this Reflective Module Record.
1. If _resolveStack_ contains a record _r_ such that _r_.[[module]] is equal to _module_ and _r_.[[exportName]] is equal to _exportName_, then
  1. Assert: this is a circular import request.
  1. Throw a *SyntaxError* exception.
1. Append the record {[[module]]: _module_, [[exportName]]: _exportName_} to _resolveStack_.
1. Let _localExports_ be _module_.[[LocalExports]].
1. If _exportName_ is in _localExports_, then:
  1. Return the Record { [[module]]: _module_, [[bindingName]]: _exportName_ }.
1. Let _indirectExports_ be _module_.[[IndirectExports]].
1. Let _pair_ be the pair in _indirectExports_ such that _pair_.[[Key]] is equal to _exportName_.
1. If _pair_ is defined, return _pair_.[[Value]].
1. Return *null*.
</emu-alg> 
   <h4 aoid="ModuleDeclarationInstantiation" class="heading settled" data-level="8.2.5" id="module-declaration-instantiation"><span class="secno">8.2.5. </span><span class="content">ModuleDeclarationInstantiation()</span><a class="self-link" href="#module-declaration-instantiation"></a></h4>
   <p>When the abstract operation ModuleDeclarationInstantiation is called with no arguments, the following steps are taken:</p>
    <emu-alg>
1. Return *undefined*.
</emu-alg> <emu-note>
Reflective modules are always already instantiated.
</emu-note> 
   <h4 aoid="ModuleEvaluation" class="heading settled" data-level="8.2.6" id="module-evaluation"><span class="secno">8.2.6. </span><span class="content">ModuleEvaluation()</span><a class="self-link" href="#module-evaluation"></a></h4>
   <p>When the abstract operation ModuleEvaluation is called with no arguments, the following steps are taken:</p>
    <emu-alg>
1. Let _module_ be this Reflective Module Record.
1. If _module_.[[Evaluated]] is *true*, return *undefined*.
1. Let _func_ be _module_.[[Evaluate]].
1. Set _module_.[[Evaluated]] to *true*.
1. Set _module_.[[Evaluate]] to *undefined*.
1. For each _pair_ in _module_.[[IndirectExports]], do:
  1. Let _requiredModule_ be _pair_.[[Value]].[[module]].
  1. Assert: _requiredModule_ is a Module Record.
  1. Perform ? _requiredModule_.ModuleEvaluation().
1. If IsCallable(_func_) is *true*, then:
  1. Let _argList_ be a new empty List.
  1. Perform ? Call(func, *undefined*, argList).
1. Return *undefined*.
</emu-alg> 
   <h3 class="heading settled" data-level="8.3" id="module-constructor"><span class="secno">8.3. </span><span class="content">The Module Constructor</span><a class="self-link" href="#module-constructor"></a></h3>
   <p>The Module constructor is the initial value of the Module property of the Reflect object. When called as a constructor it creates and initializes a new Module object. Module is not intended to be called as a function and will throw an exception when called in that manner.</p>
   <p>The Module constructor is designed to be subclassable. It may be used as the value in an extends clause of a class definition. Subclass constructors that intend to inherit the specified Module behaviour must include a super call to the Module constructor to create and initialize the subclass instance with the internal stage necessary to integrate with loaders.</p>
   <h4 class="heading settled" data-level="8.3.1" id="new-module"><span class="secno">8.3.1. </span><span class="content">Module(descriptors[, executor[, evaluate]])</span><a class="self-link" href="#new-module"></a></h4>
   <p>When Module is called with arguments <i>descriptors</i>, <i>executor</i>, and <i>evaluate</i>, the following steps are taken:</p>
    <emu-alg>
1. Let _realm_ be the current Realm Record.
1. Let _env_ be NewModuleEnvironment(_realm_.[[globalEnv]]).
1. If Type(_descriptors_) is not Object, throw a *TypeError* exception.
1. Let _exportDescriptors_ be ParseExportsDescriptors(_descriptors_). // TODO: interleave the subsequent loop with parsing?
1. Let _localExports_ be a new empty List.
1. Let _indirectExports_ be a new empty List.
1. Let _exportNames_ be a new empty List.
1. Let _envRec_ be _env_’s environment record.
1. For each _desc_ in _exportDescriptors_, do:
  1. Let _exportName_ be _desc_.[[Name]].
  1. Append _exportName_ to _exportNames_.
  1. If _desc_ is an Indirect Export Descriptor, then:
    1. Let _otherMod_ be _desc_.[[Module]].
    1. Let _resolution_ be ? _otherMod_.ResolveExport(_desc_.[[Import]], « »).
    1. If _resolution_ is *null*, then throw a *SyntaxError* exception.
    1. Append the record {[[Key]]: _exportName_, [[Value]]: _resolution_} to _indirectExports_.
  1. Else,
    1. Append _exportName_ to _localExports_.
    1. If _desc_ is an Immutable Export Descriptor, then:
      1. Perform ? _envRec_.CreateImmutableBinding(_exportName_, *true*).
    1. Else,
      1. Assert: _desc_ is a Mutable Export Descriptor.
      1. Perform ? _envRec_.CreateMutableBinding(_exportName_, *false*).
    1. If _desc_.[[Initialized]] is *true*, then:
      1. Call _envRec_.InitializeBinding(_exportName_, _desc_.[[Value]]).
1. If _evaluate_ is not *undefined*, then
  1. If IsCallable(_evaluate_) is *false*, throw a new *TypeError* exception.
1. Let _mod_ be a new Reflective Module Record {[[Realm]]: _realm_, [[Environment]]: _env_, [[Namespace]]: *undefined*, [[LocalExports]]: _localExports_, [[IndirectExports]]: _indirectExports_, [[Evaluated]]: *false*, [[Evaluate]]: _evaluate_, [[HostDefined]]: *undefined*}.
1. Let _ns_ be ModuleNamespaceCreate(_mod_, _exportNames_).
1. If _executor_ is not *undefined*, then
  1. If IsCallable(_executor_) is *false*, throw a new *TypeError* exception.
  1. Let _mutator_ be CreateModuleMutator(_mod_).
  1. Perform ? _executor_(_mutator_, _ns_).
1. Return _ns_.
</emu-alg> 
   <h3 class="heading settled" data-level="8.4" id="properties-of-the-module-constructor"><span class="secno">8.4. </span><span class="content">Properties of the Module Constructor</span><a class="self-link" href="#properties-of-the-module-constructor"></a></h3>
   <p>The value of the [[Prototype]] internal slot of the Module constructor is the intrinsic object %FunctionPrototype%.</p>
   <p>The Loader constructor has the following properties:</p>
   <h4 class="heading settled" data-level="8.4.1" id="Module.evaluate"><span class="secno">8.4.1. </span><span class="content">Module.evaluate(ns)</span><a class="self-link" href="#Module.evaluate"></a></h4>
   <p>When Module.evaluate is called with argument <i>ns</i>, the following steps are taken:</p>
    <emu-alg>
1. If _ns_ is not a module namespace exotic object, throw a *TypeError* exception.
1. Let _module_ be _ns_.[[Module]].
1. Let _entry_ be _module_.[[Entry]].
1. Let _status_ be EnsureEvaluated(_entry_).
1. RejectIfAbrupt(_status_);
1. Return a promise resolved with *undefined*.
</emu-alg> 
   <h4 class="heading settled" data-level="8.4.2" id="Module.prototype"><span class="secno">8.4.2. </span><span class="content">Module.prototype</span><a class="self-link" href="#Module.prototype"></a></h4>
   <p>The value of Module.prototype is an ordinary object with a null [[Prototype]].</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
   <h3 class="heading settled" data-level="8.5" id="module-internal-slots"><span class="secno">8.5. </span><span class="content">Properties of Module Instances</span><a class="self-link" href="#module-internal-slots"></a></h3>
   <p>Module instances are module namespace exotic objects.</p>
   <h2 class="heading settled" data-level="9" id="local"><span class="secno">9. </span><span class="content">Local Loading</span><a class="self-link" href="#local"></a></h2>
   <p><b>TODO:</b></p>
   <ul>
    <li>syntax for accessing module local information: <code>import local from this;</code> 
    <li>dynamic import: <code>local.import()</code> 
    <li>extending the hooks to handle <code>this</code> 
    <li>debugging info 
    <li>room for host environment-specific data 
   </ul>
   <h2 class="heading settled" data-level="10" id="browser"><span class="secno">10. </span><span class="content">Browser Loader</span><a class="self-link" href="#browser"></a></h2>
   <p>Every host environment must implement a default loader object as the initial value of the loader property of the System object.</p>
   <h3 class="heading settled" data-level="10.1" id="system-loader-instance"><span class="secno">10.1. </span><span class="content">System.loader Object</span><a class="self-link" href="#system-loader-instance"></a></h3>
   <p>The Default Browser Loader Object is an %BrowserLoader% instance, whose internal slots are set as if it had been constructed by the expression Construct(%BrowserLoader%).</p>
   <h2 class="heading settled" data-level="11" id="browser-loader"><span class="secno">11. </span><span class="content">BrowserLoader Objects</span><a class="self-link" href="#browser-loader"></a></h2>
   <h3 class="heading settled" data-level="11.1" id="browser-loader-constructor"><span class="secno">11.1. </span><span class="content">The BrowserLoader Constructor</span><a class="self-link" href="#browser-loader-constructor"></a></h3>
   <p>The BrowserLoader constructor is the %BrowserLoader% intrinsic object. When called as a constructor it creates and initializes a new BrowserLoader object. When <b>BrowserLoader</b> is called as a function rather than as a constructor, it throws an exception.</p>
   <h3 class="heading settled" data-level="11.2" id="properties-of-the-browser-loader-constructor"><span class="secno">11.2. </span><span class="content">Properties of the BrowserLoader Constructor</span><a class="self-link" href="#properties-of-the-browser-loader-constructor"></a></h3>
   <p>The value of the [[Prototype]] internal slot of the BrowserLoader constructor is the intrinsic object %FunctionPrototype%.</p>
   <p>The BrowserLoader constructor has the following properties:</p>
   <h4 class="heading settled" data-level="11.2.1" id="browser-loader-prototype"><span class="secno">11.2.1. </span><span class="content">BrowserLoader.prototype</span><a class="self-link" href="#browser-loader-prototype"></a></h4>
   <p>The initial value of BrowserLoader.prototype is the intrinsic object %BrowserLoaderPrototype%.</p>
   <p>This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
   <h3 class="heading settled" data-level="11.3" id="properties-of-the-browser-loader-prototype"><span class="secno">11.3. </span><span class="content">Properties of the BrowserLoader Prototype</span><a class="self-link" href="#properties-of-the-browser-loader-prototype"></a></h3>
   <h4 class="heading settled" data-level="11.3.1" id="browser-loader-prototype-@@resolve"><span class="secno">11.3.1. </span><span class="content">BrowserLoader.prototype[ @@resolve ](name, referrer)</span><a class="self-link" href="#browser-loader-prototype-@@resolve"></a></h4>
   <p>When the @@resolve method is called, the following steps are taken:</p>
   <p><b>TODO:</b> name resolution policy</p>
   <ul>
    <li>relative and site-relative URLs: <code>"./utils.js"</code>, <code>"/scripts/utils.js"</code> 
    <li>JS standard modules: <code>"std/math"</code>, <code>"std/json"</code>, <code>"std/reflect"</code> 
    <li>Web standard modules: <code>"web/worker"</code>, <code>"web/audio"</code> 
    <li>absolute URLs: <code>"https://cdn.example.com/jquery/v/2.0"</code> 
   </ul>
   <p>The value of the name property of this function is "[Reflect.Loader.resolve]".</p>
   <h4 class="heading settled" data-level="11.3.2" id="browser-loader-prototype-@@fetch"><span class="secno">11.3.2. </span><span class="content">BrowserLoader.prototype[ @@fetch ](entry, key)</span><a class="self-link" href="#browser-loader-prototype-@@fetch"></a></h4>
   <p>When the @@fetch method is called, the following steps are taken:</p>
   <p><b>TODO:</b></p>
   <ul>
    <li>reference fetch standard 
    <li>cross-origin produces an opaque object as in ServiceWorker 
    <li>CORS, CSP 
    <li>other kinds of web assets 
   </ul>
   <p>The value of the name property of this function is "[Reflect.Loader.fetch]".</p>
   <h4 class="heading settled" data-level="11.3.3" id="browser-loader-prototype-@@translate"><span class="secno">11.3.3. </span><span class="content">BrowserLoader.prototype[ @@translate ](entry, payload)</span><a class="self-link" href="#browser-loader-prototype-@@translate"></a></h4>
   <p>When the @@translate method is called, the following steps are taken:</p>
   <p><b>TODO:</b> no-op.</p>
   <p>The value of the name property of this function is "[Reflect.Loader.translate]".</p>
   <h4 class="heading settled" data-level="11.3.4" id="browser-loader-prototype-@@instantiate"><span class="secno">11.3.4. </span><span class="content">BrowserLoader.prototype[ @@instantiate ](entry, source)</span><a class="self-link" href="#browser-loader-prototype-@@instantiate"></a></h4>
   <p>When the @@instantiate method is called, the following steps are taken:</p>
   <p><b>TODO:</b></p>
   <ul>
    <li>basically a no-op. 
    <li>but also needs to re-absorb opaque responses. 
   </ul>
   <p>The value of the name property of this function is "[Reflect.Loader.instantiate]".</p>
   <h2 class="no-num heading settled" id="annexes"><span class="content">Annexes</span><a class="self-link" href="#annexes"></a></h2>
   <h3 class="heading settled" id="list-of-well-known-intrinsic-objects"><span class="content">List of Well-Known Intrinsic Objects</span><a class="self-link" href="#list-of-well-known-intrinsic-objects"></a></h3>
   <p>The intrinsics are listed in table below:</p>
   <table>
    <thead>
     <tr>
      <th>Intrinsic Name
      <th>Description (<em>non-normative</em>)
    <tbody>
     <tr>
      <td>%Loader%
      <td>The loader constructor (<a href="#loader-constructor">3.1</a>)
     <tr>
      <td>%LoaderPrototype%
      <td>The initial value of the *prototype* data property of %Loader% (<a href="#loader-prototype">3.2.1</a>)
     <tr>
      <td>%BrowserLoader%
      <td>The browser loader constructor (<a href="#browser-loader-constructor">11.1</a>)
     <tr>
      <td>%BrowserLoaderPrototype%
      <td>The initial value of the *prototype* data property of %BrowserLoader% (<a href="#browser-loader-prototype">11.2.1</a>)
     <tr>
      <td>%Registry%
      <td>The registry constructor (<a href="#registry-constructor">4.2</a>)
     <tr>
      <td>%RegistryPrototype%
      <td>The initial value of the *prototype* data property of %Registry% (<a href="#registry-prototype">4.3.1</a>)
     <tr>
      <td>%ModuleStatus%
      <td>The module status constructor (<a href="#module-status-constructor">5.2</a>)
     <tr>
      <td>%ModuleStatusPrototype%
      <td>The initial value of the *prototype* data property of %ModuleStatus% (<a href="#module-status-prototype">5.3.1</a>)
   </table>
   <h2 class="no-num heading settled" id="ipr"><span class="content">Intellectual property rights</span><a class="self-link" href="#ipr"></a></h2>
   <p>Copyright © WHATWG (Apple, Google, Mozilla, Microsoft). This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0
International License</a>. To the extent portions of it are incorporated into source code, such
portions in the source code are licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause" rel="license">BSD 3-Clause License</a> instead.</p>
  </main>
<script>
"use strict";
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js");
}
</script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#reflective-module-record①">reflective module record</a><span>, in § 8.1</span>
   <li><a href="#stage-entry">stage</a><span>, in § 5.1.5</span>
  </ul>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"reflective-module-record①": {"dfnID":"reflective-module-record\u2460","dfnText":"reflective module record","external":false,"refSections":[],"url":"#reflective-module-record\u2460"},
"stage-entry": {"dfnID":"stage-entry","dfnText":"stage","external":false,"refSections":[],"url":"#stage-entry"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>