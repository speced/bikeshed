<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>P0528R1: The Curious Case of Padding Bits, Featuring Atomic Compare-and-Exchange</title>
<style data-fill-with="stylesheet">
  </style>
<style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      vertical-align: top;
    }
    th, td {
      border-left: none;
      border-right: none;
      padding: 0px 10px;
    }
    th {
      text-align: center;
    }

    del { background: #fcc; color: #000; text-decoration: line-through; }
    ins { background: #cfc; color: #000; }
    blockquote .highlight:not(.idl) { background: initial; margin: initial; padding: 0.5em }
    blockquote ul { background: inherit; }
    blockquote code.highlight:not(.idl) { padding: initial; }
    blockquote c-[a] { color: inherit; } /* Keyword.Declaration */
    blockquote c-[b] { color: inherit; } /* Keyword.Type */
    blockquote c-[c] { color: inherit; } /* Comment */
    blockquote c-[d] { color: inherit; } /* Comment.Multiline */
    blockquote c-[e] { color: inherit; } /* Name.Attribute */
    blockquote c-[f] { color: inherit; } /* Name.Tag */
    blockquote c-[g] { color: inherit; } /* Name.Variable */
    blockquote c-[k] { color: inherit; } /* Keyword */
    blockquote c-[l] { color: inherit; } /* Literal */
    blockquote c-[m] { color: inherit; } /* Literal.Number */
    blockquote c-[n] { color: inherit; } /* Name */
    blockquote c-[o] { color: inherit; } /* Operator */
    blockquote c-[p] { color: inherit; } /* Punctuation */
    blockquote c-[s] { color: inherit; } /* Literal.String */
    blockquote c-[t] { color: inherit; } /* Literal.String.Single */
    blockquote c-[u] { color: inherit; } /* Literal.String.Double */
    blockquote c-[cp] { color: inherit; } /* Comment.Preproc */
    blockquote c-[c1] { color: inherit; } /* Comment.Single */
    blockquote c-[cs] { color: inherit; } /* Comment.Special */
    blockquote c-[kc] { color: inherit; } /* Keyword.Constant */
    blockquote c-[kn] { color: inherit; } /* Keyword.Namespace */
    blockquote c-[kp] { color: inherit; } /* Keyword.Pseudo */
    blockquote c-[kr] { color: inherit; } /* Keyword.Reserved */
    blockquote c-[ld] { color: inherit; } /* Literal.Date */
    blockquote c-[nc] { color: inherit; } /* Name.Class */
    blockquote c-[no] { color: inherit; } /* Name.Constant */
    blockquote c-[nd] { color: inherit; } /* Name.Decorator */
    blockquote c-[ni] { color: inherit; } /* Name.Entity */
    blockquote c-[ne] { color: inherit; } /* Name.Exception */
    blockquote c-[nf] { color: inherit; } /* Name.Function */
    blockquote c-[nl] { color: inherit; } /* Name.Label */
    blockquote c-[nn] { color: inherit; } /* Name.Namespace */
    blockquote c-[py] { color: inherit; } /* Name.Property */
    blockquote c-[ow] { color: inherit; } /* Operator.Word */
    blockquote c-[mb] { color: inherit; } /* Literal.Number.Bin */
    blockquote c-[mf] { color: inherit; } /* Literal.Number.Float */
    blockquote c-[mh] { color: inherit; } /* Literal.Number.Hex */
    blockquote c-[mi] { color: inherit; } /* Literal.Number.Integer */
    blockquote c-[mo] { color: inherit; } /* Literal.Number.Oct */
    blockquote c-[sb] { color: inherit; } /* Literal.String.Backtick */
    blockquote c-[sc] { color: inherit; } /* Literal.String.Char */
    blockquote c-[sd] { color: inherit; } /* Literal.String.Doc */
    blockquote c-[se] { color: inherit; } /* Literal.String.Escape */
    blockquote c-[sh] { color: inherit; } /* Literal.String.Heredoc */
    blockquote c-[si] { color: inherit; } /* Literal.String.Interpol */
    blockquote c-[sx] { color: inherit; } /* Literal.String.Other */
    blockquote c-[sr] { color: inherit; } /* Literal.String.Regex */
    blockquote c-[ss] { color: inherit; } /* Literal.String.Symbol */
    blockquote c-[vc] { color: inherit; } /* Name.Variable.Class */
    blockquote c-[vg] { color: inherit; } /* Name.Variable.Global */
    blockquote c-[vi] { color: inherit; } /* Name.Variable.Instance */
    blockquote c-[il] { color: inherit; } /* Literal.Number.Integer.Long */
  </style>
  <link href="http://wg21.link/P0528r1" rel="canonical">
  <link href="https://isocpp.org/favicon.ico" rel="icon">
  <meta content="dark light" name="color-scheme">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"></p>
   <h1 class="p-name no-ref" id="title">P0528R1<br>The Curious Case of Padding Bits, Featuring Atomic Compare-and-Exchange</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="profile-and-date"><span class="content">Published Proposal, <time class="dt-updated" datetime="1970-01-01">1970-01-01</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="http://wg21.link/P0528r1">http://wg21.link/P0528r1</a>
     <dt class="editor">Authors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:jfbastien@apple.com">JF Bastien</a> (<span class="p-org org">Apple</span>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:bigcheesegs@gmail.com">Michael Spencer</a> (<span class="p-org org">Sony Playstation</span>)
     <dt>Audience:
     <dd>SG1, EWG, CWG
     <dt>Project:
     <dd>ISO/IEC 14882 Programming Languages — C++, ISO/IEC JTC1/SC22/WG21
     <dt>Source:
     <dd><a href="https://github.com/jfbastien/papers/blob/master/source/P0528r1.bs">github.com/jfbastien/papers/blob/master/source/P0528r1.bs</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span><a class="self-link" href="#abstract"></a></h2>
   <p>Compare-and-exchange on a struct with padding bits should Just Work.</p>
  </div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref heading settled" id="contents"><span class="content">Table of Contents</span></h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#edit"><span class="secno">1</span> <span class="content">Edit History</span></a>
     <ol class="toc">
      <li><a href="#r0r1"><span class="secno">1.1</span> <span class="content">r0 → r1</span></a>
     </ol>
    <li><a href="#word"><span class="secno">2</span> <span class="content">Proposed Wording</span></a>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
   </ol>
  </nav>
  <main>
   <p>This issue has been discussed by the authors at every recent Standards meetings,
yet a full solution has been elusive despite helpful proposals. We believe that
this proposal can fix this oft-encountered problem once and for all.</p>
   <p><a data-link-type="biblio" href="#biblio-p0528r0" title="The Curious Case of Padding Bits, Featuring Atomic Compare-and-Exchange">[P0528r0]</a> details extensive background on this problem (not repeated here),
and proposed standardizing a trait, <code class="highlight"><c- n>has_padding_bits</c-></code>, and using it on <code class="highlight"><c- n>compare_and_exchange_</c-><c- o>*</c-></code>. This paper applies EWG guidance and simply adds a
note.</p>
   <h2 class="heading settled" data-level="1" id="edit"><span class="secno">1. </span><span class="content">Edit History</span><a class="self-link" href="#edit"></a></h2>
   <h3 class="heading settled" data-level="1.1" id="r0r1"><span class="secno">1.1. </span><span class="content">r0 → r1</span><a class="self-link" href="#r0r1"></a></h3>
   <p>In Albuquerque, EWG voted to make the padding bits of <code class="highlight"><c- n>atomic</c-></code> and the incoming
value of <code class="highlight"><c- n>T</c-></code> have a consistent value for the purposes of read/modify/write
atomic operations?</p>
   <p>Purposefully not addressed in this paper:</p>
   <ul>
    <li data-md>
     <p><code class="highlight"><c- k>union</c-></code> with padding bits</p>
    <li data-md>
     <p>Types with trap representations</p>
   </ul>
   <h2 class="heading settled" data-level="2" id="word"><span class="secno">2. </span><span class="content">Proposed Wording</span><a class="self-link" href="#word"></a></h2>
   <p>In Operations on atomic types [<strong>atomics.types.operations</strong>], insert a new
paragraph after the note in ❡1:</p>
   <blockquote>
    <p>[<em>Note:</em> Many operations are volatile-qualified. The "volatile as device
register" semantics have not changed in the standard. This qualification means
that volatility is preserved when applying these operations to volatile objects.
It does not mean that operations on non-volatile objects become volatile. —<em>end
note</em>]</p>
    <ins>
     <p>Atomic operations, both through <code class="highlight"><c- n>atomic</c-><c- o>&lt;</c-><c- n>T</c-><c- o>></c-></code> and free-functions, can be performed
on types <code class="highlight"><c- n>T</c-></code> which contain bits that never participate in the object’s
representation. In such cases an implementation shall ensure that
initialization, assignment, store, exchange, and read-modify-write operations
replace bits which never participate in the object’s representation with an
implementation-defined value. A compatible implementation-defined value shall be
used for compare-and-exchange operations' copy of the <code class="highlight"><c- n>expected</c-></code> value.</p>
     <p>As a consequence, the following code is guaranteed to avoid spurious failure:</p>
<pre class="highlight">
<c- k>struct</c-> <c- nc>padded</c-> <c- p>{</c->
  <c- b>char</c-> <c- n>c</c-> <c- o>=</c-> <c- mh>0x42</c-><c- p>;</c->
  <c- c1>// Padding here.</c->
  <c- b>unsigned</c-> <c- n>i</c-> <c- o>=</c-> <c- mh>0xC0DEFEFE</c-><c- p>;</c->
<c- p>};</c->
<c- n>atomic</c-><c- o>&lt;</c-><c- n>padded</c-><c- o>></c-> <c- n>pad</c-> <c- o>=</c-> <c- n>ATOMIC_VAR_INIT</c-><c- p>({});</c->

<c- b>bool</c-> <c- nf>success</c-><c- p>()</c-> <c- p>{</c->
  <c- n>padded</c-> <c- n>expected</c-><c- p>,</c-> <c- n>desired</c-> <c- p>{</c-> <c- mi>0</c-><c- p>,</c-> <c- mi>0</c-> <c- p>};</c->
  <c- k>return</c-> <c- n>pad</c-><c- p>.</c-><c- n>compare_exchange_strong</c-><c- p>(</c-><c- n>expected</c-><c- p>,</c-> <c- n>desired</c-><c- p>);</c->
<c- p>}</c->

</pre>
     <p>[<em>Note:</em></p>
     <p>Types which contain bits that sometimes participate in the object’s
  representation, such as a <code class="highlight"><c- k>union</c-></code> containing a type with padding bits and a
  type without, may always fail compare-and-exchange when these bits are not
  participating in the object’s representation because they have an
  indeterminate value. Such a program is ill-formed, no diagnostic required.</p>
     <p>—<em>end note</em>]</p>
    </ins>
   </blockquote>
   <p>Edit ❡17 and onwards as follows:</p>
   <blockquote>
    <p><em>Requires:</em> The <code class="highlight"><c- n>failure</c-></code> argument shall not be <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>release</c-></code> nor <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>acq_rel</c-></code>.</p>
    <p>
     <em>Effects:</em> Retrieves the value in <code class="highlight"><c- n>expected</c-></code>. 
     <ins>Bits in the retrieved value
which never participate in the object’s representation are set to a value
compatible to that previously stored in the atomic object.</ins>
      It then
atomically compares the contents of the memory pointed to by <code class="highlight"><c- k>this</c-></code> for equality
with that previously retrieved from <code class="highlight"><c- n>expected</c-></code>, and if true, replaces the
contents of the memory pointed to by <code class="highlight"><c- k>this</c-></code> with that in <code class="highlight"><c- n>desired</c-></code>. If and only
if the comparison is true, memory is affected according to the value of <code class="highlight"><c- n>success</c-></code>, and if the comparison is false, memory is affected according to the
value of <code class="highlight"><c- n>failure</c-></code>. When only one <code class="highlight"><c- n>memory_order</c-></code> argument is supplied, the value
of <code class="highlight"><c- n>success</c-></code> is <code class="highlight"><c- n>order</c-></code>, and the value of <code class="highlight"><c- n>failure</c-></code> is <code class="highlight"><c- n>order</c-></code> except that a
value of <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>acq_rel</c-></code> shall be replaced by the value <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>acquire</c-></code> and a value of <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>release</c-></code> shall be replaced
by the value <code class="highlight"><c- n>memory_order</c-><c- o>::</c-><c- n>relaxed</c-></code>. If and only if the comparison is false
then, after the atomic operation, the contents of the memory in <code class="highlight"><c- n>expected</c-></code> are
replaced by the value read from the memory pointed to by <code class="highlight"><c- k>this</c-></code> during the
atomic comparison. If the operation returns <code class="highlight">true</code>, these operations are atomic
read-modify-write operations on the memory pointed to by <code class="highlight"><c- k>this</c-></code>. Otherwise,
these operations are atomic load operations on that memory.
    </p>
    <p><em>Returns:</em> The result of the comparison.</p>
    <p>[<em>Note:</em></p>
    <p>For example, the effect of <code class="highlight"><c- n>compare_exchange_strong</c-></code> is</p>
<pre class="highlight">  
<c- k>if</c-> <c- p>(</c-><c- n>memcmp</c-><c- p>(</c-><c- k>this</c-><c- p>,</c-> <c- o>&amp;</c-><c- n>expected</c-><c- p>,</c-> <c- k>sizeof</c-><c- p>(</c-><c- o>*</c-><c- k>this</c-><c- p>))</c-> <c- o>==</c-> <c- mi>0</c-><c- p>)</c->
  <c- n>memcpy</c-><c- p>(</c-><c- k>this</c-><c- p>,</c-> <c- o>&amp;</c-><c- n>desired</c-><c- p>,</c-> <c- k>sizeof</c-><c- p>(</c-><c- o>*</c-><c- k>this</c-><c- p>));</c->
<c- k>else</c->
   <c- n>memcpy</c-><c- p>(</c-><c- n>expected</c-><c- p>,</c-> <c- k>this</c-><c- p>,</c-> <c- k>sizeof</c-><c- p>(</c-><c- o>*</c-><c- k>this</c-><c- p>));</c->

</pre>
    <p>—<em>end note</em>]</p>
    <p>[<em>Example:</em></p>
    <p>The expected use of the compare-and-exchange operations is as follows. The
  compare-and-exchange operations will update <code class="highlight"><c- n>expected</c-></code> when another iteration
  of the loop is needed.</p>
<pre class="highlight">
<c- n>expected</c-> <c- o>=</c-> <c- n>current</c-><c- p>.</c-><c- n>load</c-><c- p>();</c->
<c- k>do</c-> <c- p>{</c->
  <c- n>desired</c-> <c- o>=</c-> <c- n>function</c-><c- p>(</c-><c- n>expected</c-><c- p>);</c->
<c- p>}</c-> <c- k>while</c-> <c- p>(</c-><c- o>!</c-><c- n>current</c-><c- p>.</c-><c- n>compare_exchange_weak</c-><c- p>(</c-><c- n>expected</c-><c- p>,</c-> <c- n>desired</c-><c- p>));</c->

</pre>
    <p>—<em>end example</em>]</p>
    <p>[<em>Example:</em></p>
    <p>Because the expected value is updated only on failure, code releasing the
  memory containing the <code class="highlight"><c- n>expected</c-></code> value on success will work. E.g. list head
  insertion will act atomically and would not introduce a data race in the
  following code:</p>
<pre class="highlight">
<c- k>do</c-> <c- p>{</c->
  <c- n>p</c-><c- o>-></c-><c- n>next</c-> <c- o>=</c-> <c- n>head</c-><c- p>;</c-> <c- c1>// make new list node point to the current head</c->
<c- p>}</c-> <c- k>while</c-> <c- p>(</c-><c- o>!</c-><c- n>head</c-><c- p>.</c-><c- n>compare_exchange_weak</c-><c- p>(</c-><c- n>p</c-><c- o>-></c-><c- n>next</c-><c- p>,</c-> <c- n>p</c-><c- p>));</c-> <c- c1>// try to insert</c->

</pre>
    <p>—<em>end example</em>]</p>
    <p>Implementations should ensure that weak compare-and-exchange operations do not
consistently return <code class="highlight">false</code> unless either the atomic object has value different
from <code class="highlight"><c- n>expected</c-></code> or there are concurrent modifications to the atomic object.</p>
    <p><em>Remarks:</em> A weak compare-and-exchange operation may fail spuriously. That is,
even when the contents of memory referred to by <code class="highlight"><c- n>expected</c-></code> and <code class="highlight"><c- k>this</c-></code> are equal,
it may return <code class="highlight">false</code> and store back to <code class="highlight"><c- n>expected</c-></code> the same memory contents that
were originally there.</p>
    <p>[<em>Note:</em></p>
    <p>This spurious failure enables implementation of compare-and-exchange on a
  broader class of machines, e.g., load-locked store-conditional machines. A
  consequence of spurious failure is that nearly all uses of weak
  compare-and-exchange will be in a loop. When a compare-and-exchange is in a
  loop, the weak version will yield better performance on some platforms. When a
  weak compare-and-exchange would require a loop and a strong one would not, the
  strong one is preferable.</p>
    <p>—<em>end note</em>]</p>
    <p>[<em>Note:</em></p>
    <p>
     The <code class="highlight"><c- n>memcpy</c-></code> and <code class="highlight"><c- n>memcmp</c-></code> semantics of the compare-and-exchange operations may
  result in failed comparisons for values that compare equal with <code class="highlight"><c- k>operator</c-><c- o>==</c-></code> if the underlying type has padding bits
     <ins> which sometimes participate in
  the object’s representation</ins>
     , trap bits, or alternate representations of
  the same value
     <ins> other than those caused by padding bits which never
  participate in the object’s representation</ins>
     .
    </p>
    <p>—<em>end note</em>]</p>
   </blockquote>
  </main>
<script>
(function() {
  "use strict";
  var collapseSidebarText = '<span aria-hidden="true">←</span> '
                          + '<span>Collapse Sidebar</span>';
  var expandSidebarText   = '<span aria-hidden="true">→</span> '
                          + '<span>Pop Out Sidebar</span>';
  var tocJumpText         = '<span aria-hidden="true">↑</span> '
                          + '<span>Jump to Table of Contents</span>';

  var sidebarMedia = window.matchMedia('screen and (min-width: 78em)');
  var autoToggle   = function(e){ toggleSidebar(e.matches) };
  if(sidebarMedia.addListener) {
    sidebarMedia.addListener(autoToggle);
  }

  function toggleSidebar(on) {
    if (on == undefined) {
      on = !document.body.classList.contains('toc-sidebar');
    }

    /* Don't scroll to compensate for the ToC if we're above it already. */
    var headY = 0;
    var head = document.querySelector('.head');
    if (head) {
      // terrible approx of "top of ToC"
      headY += head.offsetTop + head.offsetHeight;
    }
    var skipScroll = window.scrollY < headY;

    var toggle = document.getElementById('toc-toggle');
    var tocNav = document.getElementById('toc');
    if (on) {
      var tocHeight = tocNav.offsetHeight;
      document.body.classList.add('toc-sidebar');
      document.body.classList.remove('toc-inline');
      toggle.innerHTML = collapseSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, 0 - tocHeight);
      }
      tocNav.focus();
      sidebarMedia.addListener(autoToggle); // auto-collapse when out of room
    }
    else {
      document.body.classList.add('toc-inline');
      document.body.classList.remove('toc-sidebar');
      toggle.innerHTML = expandSidebarText;
      if (!skipScroll) {
        window.scrollBy(0, tocNav.offsetHeight);
      }
      if (toggle.matches(':hover')) {
        /* Unfocus button when not using keyboard navigation,
           because I don't know where else to send the focus. */
        toggle.blur();
      }
    }
  }

  function createSidebarToggle() {
    /* Create the sidebar toggle in JS; it shouldn't exist when JS is off. */
    var toggle = document.createElement('a');
      /* This should probably be a button, but appearance isn't standards-track.*/
    toggle.id = 'toc-toggle';
    toggle.class = 'toc-toggle';
    toggle.href = '#toc';
    toggle.innerHTML = collapseSidebarText;

    sidebarMedia.addListener(autoToggle);
    var toggler = function(e) {
      e.preventDefault();
      sidebarMedia.removeListener(autoToggle); // persist explicit off states
      toggleSidebar();
      return false;
    }
    toggle.addEventListener('click', toggler, false);


    /* Get <nav id=toc-nav>, or make it if we don't have one. */
    var tocNav = document.getElementById('toc-nav');
    if (!tocNav) {
      tocNav = document.createElement('p');
      tocNav.id = 'toc-nav';
      /* Prepend for better keyboard navigation */
      document.body.insertBefore(tocNav, document.body.firstChild);
    }
    /* While we're at it, make sure we have a Jump to Toc link. */
    var tocJump = document.getElementById('toc-jump');
    if (!tocJump) {
      tocJump = document.createElement('a');
      tocJump.id = 'toc-jump';
      tocJump.href = '#toc';
      tocJump.innerHTML = tocJumpText;
      tocNav.appendChild(tocJump);
    }

    tocNav.appendChild(toggle);
  }

  var toc = document.getElementById('toc');
  if (toc) {
    createSidebarToggle();
    toggleSidebar(sidebarMedia.matches);

    /* If the sidebar has been manually opened and is currently overlaying the text
       (window too small for the MQ to add the margin to body),
       then auto-close the sidebar once you click on something in there. */
    toc.addEventListener('click', function(e) {
      if(e.target.tagName.toLowerCase() == "a" && document.body.classList.contains('toc-sidebar') && !sidebarMedia.matches) {
        toggleSidebar(false);
      }
    }, false);
  }
  else {
    console.warn("Can't find Table of Contents. Please use <nav id='toc'> around the ToC.");
  }

  /* Wrap tables in case they overflow */
  var tables = document.querySelectorAll(':not(.overlarge) > table.data, :not(.overlarge) > table.index');
  var numTables = tables.length;
  for (var i = 0; i < numTables; i++) {
    var table = tables[i];
    var wrapper = document.createElement('div');
    wrapper.className = 'overlarge';
    table.parentNode.insertBefore(wrapper, table);
    wrapper.appendChild(table);
  }

})();
</script>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-p0528r0">[P0528r0]
   <dd>JF Bastien, Michael Spencer. <a href="https://wg21.link/p0528r0"><cite>The Curious Case of Padding Bits, Featuring Atomic Compare-and-Exchange</cite></a>. 12 November 2016. URL: <a href="https://wg21.link/p0528r0">https://wg21.link/p0528r0</a>
  </dl>