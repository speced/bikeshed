<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Content Security Policy: Cookie Controls</title>
  <meta content="NOTE" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-NOTE" rel="stylesheet">
  <link href="http://www.w3.org/TR/csp-cookies/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1>Content Security Policy: Cookie Controls</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#NOTE">W3C Group Note</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://www.w3.org/TR/1970/NOTE-csp-cookies-1-19700101/">https://www.w3.org/TR/1970/NOTE-csp-cookies-1-19700101/</a>
      <dt>Latest published version:
      <dd><a href="http://www.w3.org/TR/csp-cookies/">http://www.w3.org/TR/csp-cookies/</a>
      <dt>Editor's Draft:
      <dd><a href="https://w3c.github.io/webappsec-csp/cookies/">https://w3c.github.io/webappsec-csp/cookies/</a>
      <dt>History:
      <dd><a class="u-url" href="https://www.w3.org/standards/history/csp-cookies-1/">https://www.w3.org/standards/history/csp-cookies-1/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webappsec@w3.org?subject=%5Bcsp-cookies%5D%20YOUR%20TOPIC%20HERE">public-webappsec@w3.org</a> with subject line “<kbd>[csp-cookies] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webappsec/" rel="discussion">archives</a>)</span>
      <dt class="editor">Editor:
      <dd class="editor p-author h-card vcard" data-editor-id="56384"><a class="p-name fn u-email email" href="mailto:mkwst@google.com">Mike West</a> (<span class="p-org org">Google Inc.</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning">
    <details class="annoying-warning" open>
     <summary>Obsoletion Notice</summary>
     <p> This specification is not being actively maintained,
  	and should not be used as a guide for implementations.
  	It may be revived in the future,
  	but for now should be considered obsolete. </p>
     <p> If you have questions or comments on this specification,
  	please send an email to the editors. </p>
    </details>
   </div>
   <p class="copyright" data-fill-with="copyright">©2015 Google, Inc.</p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This Note provides a historical reference for a proposed set of mechanisms
by which web developers can limit the ways
in which cookies may be set in the context of their sites and applications.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status"> <strong> Work on this document has been discontinued and it should not be
		referenced or used as a basis for implementation. </strong> </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#examples"><span class="secno">1.1</span> <span class="content">Examples</span></a>
     </ol>
    <li>
     <a href="#cookie-scope-directive"><span class="secno">2</span> <span class="content">The <code>cookie-scope</code> directive</span></a>
     <ol class="toc">
      <li><a href="#monkey-patching-rfc6264"><span class="secno">2.1</span> <span class="content">Processing Model</span></a>
     </ol>
    <li>
     <a href="#algorithms"><span class="secno">3</span> <span class="content">Algorithms</span></a>
     <ol class="toc">
      <li><a href="#block-cookie"><span class="secno">3.1</span> <span class="content"> Is <var>cookie</var> blocked for <var>settings</var>? </span></a>
      <li><a href="#violates"><span class="secno">3.2</span> <span class="content"> Does <var>cookie</var> violate <var>policy</var>? </span></a>
      <li><a href="#parse"><span class="secno">3.3</span> <span class="content"> Parse <var>string</var> as a <code>cookie-scope</code> value </span></a>
     </ol>
    <li>
     <a href="#security-considerations"><span class="secno">4</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#existing"><span class="secno">4.1</span> <span class="content">Existing Cookies</span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno">5</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is not normative.</em></p>
    <p>Cookies are an HTTP state management mechanism that web developers rely on
  heavily for important things like authentication. They are also quite fragile,
  and have scoping rules that don’t mesh well with the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2">origin</a> model that
  developers are familiar with. Cookies flow freely between <a class="idl-code" data-link-type="attribute" href="http://www.w3.org/TR/url/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a>s by default, can be set from subdomains or
  limited to paths, and ignore <a class="idl-code" data-link-type="attribute" href="http://www.w3.org/TR/url/#concept-url-port" id="ref-for-concept-url-port">port</a>s entirely. The
  disconnect between cookies and other types of storage opens up a number of
  risks that are difficult to fully mitigate. See <a data-link-type="biblio" href="#biblio-yummy-cookies" title="Yummy cookies across domains">[YUMMY-COOKIES]</a> for some
  real-world examples of problems that have cropped up in the past.</p>
    <p>This document defines mechanisms which allow developers to limit the ways in
  which cookies can be set for a given <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#protected-resource" id="ref-for-protected-resource">protected resource</a>.</p>
    <h3 class="heading settled" data-level="1.1" id="examples"><span class="secno">1.1. </span><span class="content">Examples</span><a class="self-link" href="#examples"></a></h3>
    <div class="example" id="example-e5e9860d">
     <a class="self-link" href="#example-e5e9860d"></a> MegaCorp Inc. hosts a number of pages which have no real need to write
    cookies. Following the principle of least privilege, the clever developers
    responsible for those pages send the following headers along with every HTTP
    response, ensuring that no cookies can be set via <code>Set-Cookie</code> or <code>document.cookie</code>: 
<pre><a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy" id="ref-for-content_security_policy">Content-Security-Policy</a>: <a data-link-type="dfn" href="#cookie-scope" id="ref-for-cookie-scope">cookie-scope</a> <a data-link-type="grammar" href="#grammardef-none" id="ref-for-grammardef-none">none</a>
</pre>
    </div>
    <div class="example" id="example-183786b5">
     <a class="self-link" href="#example-183786b5"></a> MegaCorp Inc. hosts a number of pages on <code>http://non-secure.example.com</code> which need to write cookies, but don’t need those cookies to span
    subdomains. The following header ensures that cookies can only be set via <code>Set-Cookie</code> or <code>document.cookie</code> if those cookies are "host only" (e.g. the
    cookie’s <code>domain</code> attribute is empty): 
<pre><a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy" id="ref-for-content_security_policy①">Content-Security-Policy</a>: <a data-link-type="dfn" href="#cookie-scope" id="ref-for-cookie-scope①">cookie-scope</a> <a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host">host</a>
</pre>
     <p>That is, the following code would set a cookie:</p>
<pre>document.cookie = "key=value";
</pre>
     <p>And the following would not:</p>
<pre>document.cookie = "key=value; domain=example.com";
</pre>
    </div>
    <div class="example" id="example-a0bac37b">
     <a class="self-link" href="#example-a0bac37b"></a> MegaCorp Inc. hosts a number of pages on <code>https://secure.example.com</code> which need to write cookies, but don’t need those cookies to span
    subdomains. They’ll certainly set the <a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host①">host</a> property, just
    like the previous example, but since this is a secure site, they also wish
    to ensure that any cookies they set also contain the <code>secure</code> attribute.
    They can do so with the following header: 
<pre><a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy" id="ref-for-content_security_policy②">Content-Security-Policy</a>: <a data-link-type="dfn" href="#cookie-scope" id="ref-for-cookie-scope②">cookie-scope</a> <a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host②">host</a> <a data-link-type="grammar" href="#grammardef-secure" id="ref-for-grammardef-secure">secure</a>
</pre>
     <p>That is, the following code would set a cookie:</p>
<pre>document.cookie = "key=value; secure";
</pre>
     <p>And the following would not:</p>
<pre>document.cookie = "key=value";
document.cookie = "key=value; domain=example.com; secure";
</pre>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="cookie-scope-directive"><span class="secno">2. </span><span class="content">The <code>cookie-scope</code> directive</span><a class="self-link" href="#cookie-scope-directive"></a></h2>
    <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="cookie-scope"><code>cookie-scope</code></dfn> is a Content Security Policy <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#directive" id="ref-for-directive">directive</a> <a data-link-type="biblio" href="#biblio-csp" title="Content Security Policy Level 3">[CSP]</a> which restricts the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-1" id="ref-for-section-1">cookies</a> <a data-link-type="biblio" href="#biblio-rfc6265" title="HTTP State Management Mechanism">[RFC6265]</a> which can be set in a particular context. The syntax is described by the
  following ABNF grammar <a data-link-type="biblio" href="#biblio-rfc5234" title="Augmented BNF for Syntax Specifications: ABNF">[RFC5234]</a> (including the <a data-link-type="grammar" href="https://tools.ietf.org/html/rfc7230#section-3.2.3" id="ref-for-section-3.2.3">RWS</a> rule
  from <a data-link-type="biblio" href="#biblio-rfc7230" title="HTTP/1.1">[RFC7230]</a>):</p>
<pre>directive-name = "cookie-scope"
directive-value = <a data-link-type="grammar" href="#grammardef-scoping-rules" id="ref-for-grammardef-scoping-rules">scoping-rules</a> *( <a data-link-type="grammar" href="https://tools.ietf.org/html/rfc7230#section-3.2.3" id="ref-for-section-3.2.3①">RWS</a> <a data-link-type="grammar" href="#grammardef-scoping-rules" id="ref-for-grammardef-scoping-rules①">scoping-rules</a> )
<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-scoping-rules">scoping-rules</dfn> = "<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-host">host</dfn>" / "<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-http">http</dfn>" / "<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-none">none</dfn>" / "<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-secure">secure</dfn>"
</pre>
    <p>The directive has one of four values:</p>
    <ol>
     <li data-md>
      <p>"<a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host③">host</a>" allows "host only" cookies to be set, but will block
  setting cookies which set a <code>domain</code> attribute.</p>
     <li data-md>
      <p>"<a data-link-type="grammar" href="#grammardef-http" id="ref-for-grammardef-http">http</a>" allows cookies to be set via the <code>Set-Cookie</code> HTTP
  header, but not via <code>document.cookie</code>.</p>
     <li data-md>
      <p>"<a data-link-type="grammar" href="#grammardef-none" id="ref-for-grammardef-none①">none</a>" blocks all cookies.</p>
     <li data-md>
      <p>"<a data-link-type="grammar" href="#grammardef-secure" id="ref-for-grammardef-secure①">secure</a>" allows cookies to be set with a <code>secure</code> attribute, and will block setting any non-secure cookies.</p>
    </ol>
    <p>These values MAY be combined in order to tighten the restrictions on a cookie.
  That is, if both "<a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host④">host</a>" and "<a data-link-type="grammar" href="#grammardef-secure" id="ref-for-grammardef-secure②">secure</a>" are
  present, then cookies may only be set which are both secure and host-only.
  If "<a data-link-type="grammar" href="#grammardef-none" id="ref-for-grammardef-none②">none</a>" is present with any combination of the other values,
  no cookies may be set.</p>
    <p class="issue" id="issue-230617d6"><a class="self-link" href="#issue-230617d6"></a> Erik Nygren <a href="https://lists.w3.org/Archives/Public/public-webappsec/2013Sep/0046.html">proposed</a> adding <code>path</code> restrictions as well. Is that worthwhile?</p>
    <h3 class="heading settled" data-level="2.1" id="monkey-patching-rfc6264"><span class="secno">2.1. </span><span class="content">Processing Model</span><a class="self-link" href="#monkey-patching-rfc6264"></a></h3>
    <p>After step 10 of <a href="https://tools.ietf.org/html/rfc6265#section-5.3" id="7b0843440">the
  storage algorithm in Section 5.3 of RFC 6265</a>, a cookie object has been
  built. Insert the following validation step before proceeding to the current
  step 11:</p>
    <ol start="11">
     <li> If <a href="#block-cookie">§ 3.1 Is cookie blocked for settings?</a> returns "<code>Blocked</code>" when executed upon <var>cookie</var> and the <a data-link-type="dfn" href="http://www.w3.org/TR/html5/webappapis.html#incumbent-settings-object" id="ref-for-incumbent-settings-object">incumbent settings object</a>,
      abort these steps without modifying the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-5.3" id="ref-for-section-5.3">cookie store</a>. 
    </ol>
    <p class="issue" id="issue-56f7d322"><a class="self-link" href="#issue-56f7d322"></a> Monkey patching! Hey, maybe it’s time to reopen that cookie RFC after
  all, eh @mnot? :)</p>
    <p class="issue" id="issue-324fe3fa"><a class="self-link" href="#issue-324fe3fa"></a> We’ll need a mechanism to restrict reading from <code>document.cookie</code>, but I’d like something less specific than <code>cookie-scope   disable-dom-access</code> or something similar. The linked GitHub bug is a proposal
  that’s a bit more general and widely applicable. <a href="https://github.com/w3c/webappsec-csp/issues/42">[Issue #w3c/webappsec-csp#42]</a></p>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="algorithms"><span class="secno">3. </span><span class="content">Algorithms</span><a class="self-link" href="#algorithms"></a></h2>
    <h3 class="heading settled" data-level="3.1" id="block-cookie"><span class="secno">3.1. </span><span class="content"> Is <var>cookie</var> blocked for <var>settings</var>? </span><a class="self-link" href="#block-cookie"></a></h3>
    <p>Given a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-1" id="ref-for-section-1①">cookie</a> (<var>cookie</var>), and an <a data-link-type="dfn" href="http://www.w3.org/TR/html5/webappapis.html#settings-object" id="ref-for-settings-object">environment settings
  object</a> (<var>settings</var>), this algorithm returns "<code>Allowed</code>" if <var>cookie</var> can be written, and "<code>Blocked</code>" if it violates one or
  more of <var>settings</var>’s enforced Content Security Policies:</p>
    <ol>
     <li data-md>
      <p>Let <var>status</var> be "<code>Allowed</code>".</p>
     <li data-md>
      <p>For each <var>policy</var> in <var>settings</var>’s <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#monitored-content-security-policies" id="ref-for-monitored-content-security-policies">monitored Content
  Security Policies</a>:</p>
      <ol>
       <li data-md>
        <p>If <a href="#violates">§ 3.2 Does cookie violate policy?</a> returns "<code>Violates</code>" when executed upon the cookie
  and <var>policy</var>, <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#report-a-violation" id="ref-for-report-a-violation">report a violation</a>.</p>
        <p class="note" role="note"><span class="marker">Note:</span> We do <em>not</em> touch <var>status</var> here, as we’re
  only evaluating the monitored policies.</p>
      </ol>
     <li data-md>
      <p>For each <var>policy</var> in <var>settings</var>’s <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#enforced-content-security-policies" id="ref-for-enforced-content-security-policies">enforced Content
  Security Policies</a>:</p>
      <ol>
       <li data-md>
        <p>If <a href="#violates">§ 3.2 Does cookie violate policy?</a> returns "<code>Violates</code>" when executed upon the cookie
  and <var>policy</var>, <a data-link-type="dfn" href="https://mikewest.github.io/webappsec/specs/content-security-policy/#report-a-violation" id="ref-for-report-a-violation①">report a violation</a>, and set <var>status</var> to "<code>Blocked</code>":</p>
      </ol>
     <li data-md>
      <p>Return <var>status</var>.</p>
    </ol>
    <h3 class="heading settled" data-level="3.2" id="violates"><span class="secno">3.2. </span><span class="content"> Does <var>cookie</var> violate <var>policy</var>? </span><a class="self-link" href="#violates"></a></h3>
    <ol>
     <li data-md>
      <p>Let <var>scope</var> be the result of executing <a href="#parse">§ 3.3 Parse string as a cookie-scope value</a> on <var>policy</var>’s <a data-link-type="dfn" href="#cookie-scope" id="ref-for-cookie-scope③">cookie-scope</a> directive.</p>
     <li data-md>
      <p>If any of the following conditions are met, return "<code>Violates</code>":</p>
      <ol>
       <li data-md>
        <p><var>scope</var> contains "<a data-link-type="grammar" href="#grammardef-host" id="ref-for-grammardef-host⑤">host</a>", and the cookie’s <code>host-only-flag</code> is <code>false</code>.</p>
       <li data-md>
        <p><var>scope</var> contains "<a data-link-type="grammar" href="#grammardef-http" id="ref-for-grammardef-http①">http</a>", and the cookie
  was received from a "non-HTTP" API.</p>
       <li data-md>
        <p><var>scope</var> contains "<a data-link-type="grammar" href="#grammardef-none" id="ref-for-grammardef-none③">none</a>".</p>
       <li data-md>
        <p><var>scope</var> contains "<a data-link-type="grammar" href="#grammardef-secure" id="ref-for-grammardef-secure③">secure</a>", and the
  cookie’s <code>secure-only-flag</code> is <code>false</code>.</p>
      </ol>
     <li data-md>
      <p>Return "<code>Does not violate</code>".</p>
    </ol>
    <h3 class="heading settled" data-level="3.3" id="parse"><span class="secno">3.3. </span><span class="content"> Parse <var>string</var> as a <code>cookie-scope</code> value </span><a class="self-link" href="#parse"></a></h3>
    <p>Given a string (<var>string</var>), this algorithm returns a set of the valid <a data-link-type="dfn" href="#cookie-scope" id="ref-for-cookie-scope④"><code>cookie-scope</code></a> values the string represents. Invalid values are
  ignored:</p>
    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="http://www.w3.org/TR/html5/infrastructure.html#strip-leading-and-trailing-whitespace" id="ref-for-strip-leading-and-trailing-whitespace">Strip leading and trailing whitespace</a> from <var>string</var>.</p>
     <li data-md>
      <p>Let <var>values</var> be an empty set.</p>
     <li data-md>
      <p>For each <var>token</var> in the list generated by <a data-link-type="dfn" href="http://www.w3.org/TR/html5/infrastructure.html#split-a-string-on-spaces" id="ref-for-split-a-string-on-spaces">splitting <var>string</var> on
  spaces</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>token</var> matches the grammar for <a data-link-type="grammar" href="#grammardef-scoping-rules" id="ref-for-grammardef-scoping-rules②">scoping-rules</a>, insert <var>token</var> into <var>values</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>values</var>.</p>
    </ol>
   </section>
   <section>
    <h2 class="heading settled" data-level="4" id="security-considerations"><span class="secno">4. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
    <h3 class="heading settled" data-level="4.1" id="existing"><span class="secno">4.1. </span><span class="content">Existing Cookies</span><a class="self-link" href="#existing"></a></h3>
    <p>Note that the mechanisms defined here do not protect against cookies that
  already exist in a user’s <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-5.3" id="ref-for-section-5.3①">cookie store</a>. Those cookies are delivered
  along with the HTTP request, before Content Security Policy can be delivered
  and applied. It is possible that future work like <a data-link-type="biblio" href="#biblio-csp-pinning" title="Content Security Policy: Pinning">[CSP-PINNING]</a> might
  enable these kinds of <i lang="la">a priori</i> restrictions, but, even then,
  CSP should be seen as a mitigation strategy, layered on top of filters and
  sanity checks for incoming data.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="5" id="acknowledgements"><span class="secno">5. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
    <p>Mark Nottingham proposed this directive several years ago. Sorry it took so
  long, Mark!</p>
   </section>
  </main>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#cookie-scope">cookie-scope</a><span>, in § 2</span>
   <li><a href="#grammardef-host">host</a><span>, in § 2</span>
   <li><a href="#grammardef-http">http</a><span>, in § 2</span>
   <li><a href="#grammardef-none">none</a><span>, in § 2</span>
   <li><a href="#grammardef-scoping-rules">scoping-rules</a><span>, in § 2</span>
   <li><a href="#grammardef-secure">secure</a><span>, in § 2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e3b5fbd4">content-security-policy</span>
     <li><span class="dfn-paneled" id="7cc511b5">directive</span>
     <li><span class="dfn-paneled" id="36e44a52">enforced content security policies</span>
     <li><span class="dfn-paneled" id="b63d92d2">monitored content security policies</span>
     <li><span class="dfn-paneled" id="642c3d99">protected resource</span>
     <li><span class="dfn-paneled" id="4efcb7f7">report a violation</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML5]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8cef3259">environment settings object</span>
     <li><span class="dfn-paneled" id="483076e1">incumbent settings object</span>
     <li><span class="dfn-paneled" id="866fd3bd">split a string on spaces</span>
     <li><span class="dfn-paneled" id="2280b762">strip leading and trailing whitespace</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6265]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b9793e1e">cookie</span>
     <li><span class="dfn-paneled" id="19353784">cookie store</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6454]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c99fa6fa">origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC7230]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="32f92e64">rws</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="98b9d39f">port</span>
     <li><span class="dfn-paneled" id="1b0577a6">scheme</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-csp">[CSP]
   <dd>Mike West; Antonio Sartori. <a href="https://www.w3.org/TR/CSP3/"><cite>Content Security Policy Level 3</cite></a>. 18 June 2024. WD. URL: <a href="https://www.w3.org/TR/CSP3/">https://www.w3.org/TR/CSP3/</a>
   <dt id="biblio-html5">[HTML5]
   <dd>Ian Hickson; et al. <a href="https://www.w3.org/TR/html5/"><cite>HTML5</cite></a>. 27 March 2018. REC. URL: <a href="https://www.w3.org/TR/html5/">https://www.w3.org/TR/html5/</a>
   <dt id="biblio-rfc5234">[RFC5234]
   <dd>D. Crocker, Ed.; P. Overell. <a href="https://www.rfc-editor.org/rfc/rfc5234"><cite>Augmented BNF for Syntax Specifications: ABNF</cite></a>. January 2008. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5234">https://www.rfc-editor.org/rfc/rfc5234</a>
   <dt id="biblio-rfc6265">[RFC6265]
   <dd>A. Barth. <a href="https://httpwg.org/specs/rfc6265.html"><cite>HTTP State Management Mechanism</cite></a>. April 2011. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc6265.html">https://httpwg.org/specs/rfc6265.html</a>
   <dt id="biblio-rfc6454">[RFC6454]
   <dd>A. Barth. <a href="https://www.rfc-editor.org/rfc/rfc6454"><cite>The Web Origin Concept</cite></a>. December 2011. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6454">https://www.rfc-editor.org/rfc/rfc6454</a>
   <dt id="biblio-rfc7230">[RFC7230]
   <dd>R. Fielding, Ed.; J. Reschke, Ed.. <a href="https://httpwg.org/specs/rfc7230.html"><cite>Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</cite></a>. June 2014. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc7230.html">https://httpwg.org/specs/rfc7230.html</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-csp-pinning">[CSP-PINNING]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec/specs/csp-pinning/"><cite>Content Security Policy: Pinning</cite></a>. FPWD. URL: <a href="https://w3c.github.io/webappsec/specs/csp-pinning/">https://w3c.github.io/webappsec/specs/csp-pinning/</a>
   <dt id="biblio-yummy-cookies">[YUMMY-COOKIES]
   <dd>Vincent Marti. <a href="https://github.com/blog/1466-yummy-cookies-across-domains"><cite>Yummy cookies across domains</cite></a>. URL: <a href="https://github.com/blog/1466-yummy-cookies-across-domains">https://github.com/blog/1466-yummy-cookies-across-domains</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Erik Nygren <a href="https://lists.w3.org/Archives/Public/public-webappsec/2013Sep/0046.html">proposed</a> adding <code>path</code> restrictions as well. Is that worthwhile? <a class="issue-return" href="#issue-230617d6" title="Jump to section">↵</a></div>
   <div class="issue"> Monkey patching! Hey, maybe it’s time to reopen that cookie RFC after
  all, eh @mnot? :) <a class="issue-return" href="#issue-56f7d322" title="Jump to section">↵</a></div>
   <div class="issue"> We’ll need a mechanism to restrict reading from <code>document.cookie</code>, but I’d like something less specific than <code>cookie-scope   disable-dom-access</code> or something similar. The linked GitHub bug is a proposal
  that’s a bit more general and widely applicable. <a href="https://github.com/w3c/webappsec-csp/issues/42">[Issue #w3c/webappsec-csp#42]</a> <a class="issue-return" href="#issue-324fe3fa" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"19353784": {"dfnID":"19353784","dfnText":"cookie store","external":true,"refSections":[{"refs":[{"id":"7b0843440"},{"id":"ref-for-section-5.3"}],"title":"2.1. Processing Model"},{"refs":[{"id":"ref-for-section-5.3\u2460"}],"title":"4.1. Existing Cookies"}],"url":"https://tools.ietf.org/html/rfc6265#section-5.3"},
"1b0577a6": {"dfnID":"1b0577a6","dfnText":"scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-scheme"}],"title":"1. Introduction"}],"url":"http://www.w3.org/TR/url/#concept-url-scheme"},
"2280b762": {"dfnID":"2280b762","dfnText":"strip leading and trailing whitespace","external":true,"refSections":[{"refs":[{"id":"ref-for-strip-leading-and-trailing-whitespace"}],"title":"3.3. \n    Parse string as a cookie-scope value\n  "}],"url":"http://www.w3.org/TR/html5/infrastructure.html#strip-leading-and-trailing-whitespace"},
"32f92e64": {"dfnID":"32f92e64","dfnText":"rws","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.2.3"},{"id":"ref-for-section-3.2.3\u2460"}],"title":"2. The cookie-scope directive"}],"url":"https://tools.ietf.org/html/rfc7230#section-3.2.3"},
"36e44a52": {"dfnID":"36e44a52","dfnText":"enforced content security policies","external":true,"refSections":[{"refs":[{"id":"ref-for-enforced-content-security-policies"}],"title":"3.1. \n    Is cookie blocked for settings?\n  "}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#enforced-content-security-policies"},
"483076e1": {"dfnID":"483076e1","dfnText":"incumbent settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-incumbent-settings-object"}],"title":"2.1. Processing Model"}],"url":"http://www.w3.org/TR/html5/webappapis.html#incumbent-settings-object"},
"4efcb7f7": {"dfnID":"4efcb7f7","dfnText":"report a violation","external":true,"refSections":[{"refs":[{"id":"ref-for-report-a-violation"},{"id":"ref-for-report-a-violation\u2460"}],"title":"3.1. \n    Is cookie blocked for settings?\n  "}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#report-a-violation"},
"642c3d99": {"dfnID":"642c3d99","dfnText":"protected resource","external":true,"refSections":[{"refs":[{"id":"ref-for-protected-resource"}],"title":"1. Introduction"}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#protected-resource"},
"7cc511b5": {"dfnID":"7cc511b5","dfnText":"directive","external":true,"refSections":[{"refs":[{"id":"ref-for-directive"}],"title":"2. The cookie-scope directive"}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#directive"},
"866fd3bd": {"dfnID":"866fd3bd","dfnText":"split a string on spaces","external":true,"refSections":[{"refs":[{"id":"ref-for-split-a-string-on-spaces"}],"title":"3.3. \n    Parse string as a cookie-scope value\n  "}],"url":"http://www.w3.org/TR/html5/infrastructure.html#split-a-string-on-spaces"},
"8cef3259": {"dfnID":"8cef3259","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-settings-object"}],"title":"3.1. \n    Is cookie blocked for settings?\n  "}],"url":"http://www.w3.org/TR/html5/webappapis.html#settings-object"},
"98b9d39f": {"dfnID":"98b9d39f","dfnText":"port","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-port"}],"title":"1. Introduction"}],"url":"http://www.w3.org/TR/url/#concept-url-port"},
"b63d92d2": {"dfnID":"b63d92d2","dfnText":"monitored content security policies","external":true,"refSections":[{"refs":[{"id":"ref-for-monitored-content-security-policies"}],"title":"3.1. \n    Is cookie blocked for settings?\n  "}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#monitored-content-security-policies"},
"b9793e1e": {"dfnID":"b9793e1e","dfnText":"cookie","external":true,"refSections":[{"refs":[{"id":"ref-for-section-1"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-section-1\u2460"}],"title":"3.1. \n    Is cookie blocked for settings?\n  "}],"url":"https://tools.ietf.org/html/rfc6265#section-1"},
"c99fa6fa": {"dfnID":"c99fa6fa","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.2"}],"title":"1. Introduction"}],"url":"https://tools.ietf.org/html/rfc6454#section-3.2"},
"cookie-scope": {"dfnID":"cookie-scope","dfnText":"cookie-scope","external":false,"refSections":[{"refs":[{"id":"ref-for-cookie-scope"},{"id":"ref-for-cookie-scope\u2460"},{"id":"ref-for-cookie-scope\u2461"}],"title":"1.1. Examples"},{"refs":[{"id":"ref-for-cookie-scope\u2462"}],"title":"3.2. \n    Does cookie violate policy?\n  "},{"refs":[{"id":"ref-for-cookie-scope\u2463"}],"title":"3.3. \n    Parse string as a cookie-scope value\n  "}],"url":"#cookie-scope"},
"e3b5fbd4": {"dfnID":"e3b5fbd4","dfnText":"content-security-policy","external":true,"refSections":[{"refs":[{"id":"ref-for-content_security_policy"},{"id":"ref-for-content_security_policy\u2460"},{"id":"ref-for-content_security_policy\u2461"}],"title":"1.1. Examples"}],"url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy"},
"grammardef-host": {"dfnID":"grammardef-host","dfnText":"host","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-host"},{"id":"ref-for-grammardef-host\u2460"},{"id":"ref-for-grammardef-host\u2461"}],"title":"1.1. Examples"},{"refs":[{"id":"ref-for-grammardef-host\u2462"},{"id":"ref-for-grammardef-host\u2463"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-grammardef-host\u2464"}],"title":"3.2. \n    Does cookie violate policy?\n  "}],"url":"#grammardef-host"},
"grammardef-http": {"dfnID":"grammardef-http","dfnText":"http","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-http"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-grammardef-http\u2460"}],"title":"3.2. \n    Does cookie violate policy?\n  "}],"url":"#grammardef-http"},
"grammardef-none": {"dfnID":"grammardef-none","dfnText":"none","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-none"}],"title":"1.1. Examples"},{"refs":[{"id":"ref-for-grammardef-none\u2460"},{"id":"ref-for-grammardef-none\u2461"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-grammardef-none\u2462"}],"title":"3.2. \n    Does cookie violate policy?\n  "}],"url":"#grammardef-none"},
"grammardef-scoping-rules": {"dfnID":"grammardef-scoping-rules","dfnText":"scoping-rules","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-scoping-rules"},{"id":"ref-for-grammardef-scoping-rules\u2460"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-grammardef-scoping-rules\u2461"}],"title":"3.3. \n    Parse string as a cookie-scope value\n  "}],"url":"#grammardef-scoping-rules"},
"grammardef-secure": {"dfnID":"grammardef-secure","dfnText":"secure","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-secure"}],"title":"1.1. Examples"},{"refs":[{"id":"ref-for-grammardef-secure\u2460"},{"id":"ref-for-grammardef-secure\u2461"}],"title":"2. The cookie-scope directive"},{"refs":[{"id":"ref-for-grammardef-secure\u2462"}],"title":"3.2. \n    Does cookie violate policy?\n  "}],"url":"#grammardef-secure"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#cookie-scope": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"cookie-scope","type":"dfn","url":"#cookie-scope"},
"#grammardef-host": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"host","type":"grammar","url":"#grammardef-host"},
"#grammardef-http": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"http","type":"grammar","url":"#grammardef-http"},
"#grammardef-none": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"none","type":"grammar","url":"#grammardef-none"},
"#grammardef-scoping-rules": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"scoping-rules","type":"grammar","url":"#grammardef-scoping-rules"},
"#grammardef-secure": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"csp-cookies","spec":"csp-cookies-1","status":"local","text":"secure","type":"grammar","url":"#grammardef-secure"},
"http://www.w3.org/TR/html5/infrastructure.html#split-a-string-on-spaces": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html5","spec":"html5","status":"anchor-block","text":"split a string on spaces","type":"dfn","url":"http://www.w3.org/TR/html5/infrastructure.html#split-a-string-on-spaces"},
"http://www.w3.org/TR/html5/infrastructure.html#strip-leading-and-trailing-whitespace": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html5","spec":"html5","status":"anchor-block","text":"strip leading and trailing whitespace","type":"dfn","url":"http://www.w3.org/TR/html5/infrastructure.html#strip-leading-and-trailing-whitespace"},
"http://www.w3.org/TR/html5/webappapis.html#incumbent-settings-object": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html5","spec":"html5","status":"anchor-block","text":"incumbent settings object","type":"dfn","url":"http://www.w3.org/TR/html5/webappapis.html#incumbent-settings-object"},
"http://www.w3.org/TR/html5/webappapis.html#settings-object": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html5","spec":"html5","status":"anchor-block","text":"environment settings object","type":"dfn","url":"http://www.w3.org/TR/html5/webappapis.html#settings-object"},
"http://www.w3.org/TR/url/#concept-url-port": {"export":true,"for_":["URL"],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"port","type":"attribute","url":"http://www.w3.org/TR/url/#concept-url-port"},
"http://www.w3.org/TR/url/#concept-url-scheme": {"export":true,"for_":["URL"],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"scheme","type":"attribute","url":"http://www.w3.org/TR/url/#concept-url-scheme"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"content-security-policy","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#content_security_policy"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#directive": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"directive","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#directive"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#enforced-content-security-policies": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"enforced content security policies","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#enforced-content-security-policies"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#monitored-content-security-policies": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"monitored content security policies","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#monitored-content-security-policies"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#protected-resource": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"protected resource","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#protected-resource"},
"https://mikewest.github.io/webappsec/specs/content-security-policy/#report-a-violation": {"export":true,"for_":[],"level":"","normative":true,"shortname":"csp3","spec":"csp3","status":"anchor-block","text":"report a violation","type":"dfn","url":"https://mikewest.github.io/webappsec/specs/content-security-policy/#report-a-violation"},
"https://tools.ietf.org/html/rfc6265#section-1": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6265","spec":"rfc6265","status":"anchor-block","text":"cookie","type":"dfn","url":"https://tools.ietf.org/html/rfc6265#section-1"},
"https://tools.ietf.org/html/rfc6265#section-5.3": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6265","spec":"rfc6265","status":"anchor-block","text":"cookie store","type":"dfn","url":"https://tools.ietf.org/html/rfc6265#section-5.3"},
"https://tools.ietf.org/html/rfc6454#section-3.2": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6454","spec":"rfc6454","status":"anchor-block","text":"origin","type":"dfn","url":"https://tools.ietf.org/html/rfc6454#section-3.2"},
"https://tools.ietf.org/html/rfc7230#section-3.2.3": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc7230","spec":"rfc7230","status":"anchor-block","text":"rws","type":"grammar","url":"https://tools.ietf.org/html/rfc7230#section-3.2.3"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>