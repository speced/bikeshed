<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Content Security Policy Pinning</title>
  <meta content="NOTE" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2016/W3C-NOTE" rel="stylesheet" type="text/css">
  <link href="http://www.w3.org/TR/csp-pinning/" rel="canonical">
<style>/* style-autolinks */

.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}</style>
<style>/* style-counters */

body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}</style>
<style>/* style-dfn-panel */

:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    height: auto;
    width: -webkit-fit-content;
    width: fit-content;
    max-width: 300px;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0; }
.dfn-panel li { list-style: inside; }
.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled { cursor: pointer; }
</style>
<style>/* style-md-lists */

/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}</style>
<style>/* style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" width="72"> </a> </p>
   <h1>Content Security Policy Pinning</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="profile-and-date"><span class="content">W3C Note, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://www.w3.org/TR/1970/NOTE-csp-pinning-1-19700101/">https://www.w3.org/TR/1970/NOTE-csp-pinning-1-19700101/</a>
     <dt>Latest published version:
     <dd><a href="http://www.w3.org/TR/csp-pinning/">http://www.w3.org/TR/csp-pinning/</a>
     <dt>Editor's Draft:
     <dd><a href="https://w3c.github.io/webappsec-csp/pinning/">https://w3c.github.io/webappsec-csp/pinning/</a>
     <dt>Version History:
     <dd><a href="https://github.com/w3c/webappsec-csp/commits/master/pinning/index.src.html">https://github.com/w3c/webappsec-csp/commits/master/pinning/index.src.html</a>
     <dt>Feedback:
     <dd><span><a href="mailto:public-webappsec@w3.org?subject=%5Bcsp-pinning%5D%20YOUR%20TOPIC%20HERE">public-webappsec@w3.org</a> with subject line “<kbd>[csp-pinning] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webappsec/" rel="discussion">archives</a>)</span>
     <dt class="editor">Editor:
     <dd class="editor p-author h-card vcard" data-editor-id="56384"><a class="p-name fn u-email email" href="mailto:mkwst@google.com">Mike West</a> (<span class="p-org org">Google Inc.</span>)
     <dt>Participate:
     <dd><a href="https://github.com/w3c/webappsec-csp/issues/new?title=PINNING:%20">File an issue</a> (<a href="https://github.com/w3c/webappsec-csp/issues">open issues</a>)
    </dl>
   </div>
   <div data-fill-with="warning">
    <details class="annoying-warning" open>
     <summary>Obsoletion Notice</summary>
     <p> This specification is not being actively maintained,
  	and should not be used as a guide for implementations.
  	It may be revived in the future,
  	but for now should be considered obsolete. </p>
     <p> If you have questions or comments on this specification,
  	please send an email to the editors. </p>
    </details>
   </div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 1970 <a href="https://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="https://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="https://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="https://www.keio.ac.jp/">Keio</a>, <a href="https://ev.buaa.edu.cn/">Beihang</a>). W3C <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This Note provides a historical reference for a proposed mechanism to

	allow authors to instruct user agents to remember ("pin") and
	enforce a Content Security Policy for a set of hosts for a period of time.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status"> <strong> Work on this document has been discontinued and it should not be
		referenced or used as a basis for implementation. </strong> </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#use-cases"><span class="secno">1.1</span> <span class="content">Use Cases</span></a>
     </ol>
    <li>
     <a href="#key-concepts"><span class="secno">2</span> <span class="content">Key Concepts and Terminology</span></a>
     <ol class="toc">
      <li><a href="#terms-defined-here"><span class="secno">2.1</span> <span class="content">Terms defined by this specification</span></a>
     </ol>
    <li>
     <a href="#policy-delivery"><span class="secno">3</span> <span class="content">Pinned Policy Delivery</span></a>
     <ol class="toc">
      <li><a href="#content-security-policy-pin-header-field"><span class="secno">3.1</span> <span class="content"> <code>Content-Security-Policy-Pin</code> Header Field </span></a>
      <li><a href="#content-security-policy-report-only-pin-header-field"><span class="secno">3.2</span> <span class="content"> <code>Content-Security-Policy-Report-Only-Pin</code> Header Field </span></a>
      <li>
       <a href="#csp-pins-syntax"><span class="secno">3.3</span> <span class="content">Pinned Policy Syntax</span></a>
       <ol class="toc">
        <li><a href="#max-age-directive"><span class="secno">3.3.1</span> <span class="content">The <code>max-age</code> directive</span></a>
        <li><a href="#includesubdomains-directive"><span class="secno">3.3.2</span> <span class="content"> The <code>includeSubDomains</code> directive </span></a>
       </ol>
     </ol>
    <li>
     <a href="#policy-processing"><span class="secno">4</span> <span class="content">Pinned Policy Processing</span></a>
     <ol class="toc">
      <li>
       <a href="#fetching-algorithms"><span class="secno">4.1</span> <span class="content">Fetching Algorithms</span></a>
       <ol class="toc">
        <li><a href="#discover-pinned-policy"><span class="secno">4.1.1</span> <span class="content"> Discover pinned policies for <var>response</var> </span></a>
        <li><a href="#pin-policy"><span class="secno">4.1.2</span> <span class="content"> Pin <var>policy</var> for <var>origin</var> in <var>mode</var> </span></a>
        <li><a href="#apply-pinned-policy"><span class="secno">4.1.3</span> <span class="content"> Pin a policy to <var>response</var> </span></a>
       </ol>
      <li>
       <a href="#cache-algorithms"><span class="secno">4.2</span> <span class="content"> Pinned Policy Cache Algorithms </span></a>
       <ol class="toc">
        <li><a href="#pinned-policy-for-host"><span class="secno">4.2.1</span> <span class="content"> Get the <var>mode</var> pinned policy for <var>host</var> </span></a>
        <li><a href="#expire-pinned-policies"><span class="secno">4.2.2</span> <span class="content"> Remove expired pinned policies from the cache </span></a>
       </ol>
     </ol>
    <li>
     <a href="#security-considerations"><span class="secno">5</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#hostile-pinning"><span class="secno">5.1</span> <span class="content">Hostile Pinning</span></a>
     </ol>
    <li>
     <a href="#privacy-considerations"><span class="secno">6</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#fingerprinting"><span class="secno">6.1</span> <span class="content">Fingerprinting</span></a>
     </ol>
    <li>
     <a href="#authoring-considerations"><span class="secno">7</span> <span class="content">Authoring Considerations</span></a>
     <ol class="toc">
      <li><a href="#pins-as-defaults"><span class="secno">7.1</span> <span class="content">Pins as a default</span></a>
      <li><a href="#pins-override-meta"><span class="secno">7.2</span> <span class="content">Pins override <code>&lt;meta></code></span></a>
     </ol>
    <li>
     <a href="#iana-considerations"><span class="secno">8</span> <span class="content">IANA Considerations</span></a>
     <ol class="toc">
      <li><a href="#iana-content-security-policy-pin"><span class="secno">8.1</span> <span class="content"> Content-Security-Policy-Pin </span></a>
      <li><a href="#iana-content-security-policy-report-only-pin"><span class="secno">8.2</span> <span class="content"> Content-Security-Policy-Report-Only-Pin </span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno">9</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is not normative.</em></p>
    <p>Content Security Policy <a data-link-type="biblio" href="#biblio-csp">[CSP]</a> defines a mechanism through which authors
  can manipulate the security properties of a given resource, providing the
  ability to mitigate the risk of a broad class of content-injection attacks.
  CSP, however, can only protect pages for which it is explicitly defined,
  which means that authors need to ensure that they’re delivering a reasonable
  policy for <em>every</em> page on their origin in order to have confidence
  that a particular set of restrictions will be consistently applied.</p>
    <p>For example, it’s often the case that generic error-handling pages are
  constructed differently than "real" application pages. They’re easy to forget
  when auditing the security headers set for an origin, and can offer attackers
  a foot in the door if they contain injection vectors.</p>
    <p>CSP Pinning attempts to address this concern by allowing authors to "pin" a
  baseline policy to an application’s host. Conceptually, this is quite similar
  to the approach taken by Strict Transport Security <a data-link-type="biblio" href="#biblio-rfc6797">[RFC6797]</a> and Public Key
  Pinning <a data-link-type="biblio" href="#biblio-pkp">[PKP]</a>: we define a new header, <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin">Content-Security-Policy-Pin</a></code> which instructs a user agent
  to remember a baseline policy that will be enforced for any document and
  worker delivered by an application that doesn’t come with its own <code>Content-Security-Policy</code> header.</p>
    <h3 class="heading settled" data-level="1.1" id="use-cases"><span class="secno">1.1. </span><span class="content">Use Cases</span><a class="self-link" href="#use-cases"></a></h3>
    <p><code>example.com</code> has a number of applications running on the same
  origin; each has a specific set of resources it needs to load, so a single
  Content Security Policy would become unwieldy for the whole set of resources.
  Moreover, the admins aren’t exactly sure they have a clear understanding of
  all the applications running on subdomains; the marketing department went a
  bit wild with branded partnerships a year or two back.</p>
    <p>After doing an audit of existing code, they have a good feel for the needs
  of individual applications, and give each a suitable policy. They decide to
  err on the side of caution, and pin a restrictive policy for pages they didn’t
  catch:</p>
    <div class="example" id="example-6b3d5af4">
     <a class="self-link" href="#example-6b3d5af4"></a> <code>https://example.com/application1/</code> delivers the following HTTP
    response headers: 
<pre>Content-Security-Policy-Pin: <a data-link-type="dfn" href="#max-age" id="ref-for-max-age">max-age</a>: 10886400;
                             <a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains">includeSubDomains</a>;
                             default-src https:;
                             form-action 'none';
                             frame-ancestors 'none';
                             referrer no-referrer;
                             report-uri /csp-endpoint/pinned
Content-Security-Policy: script-src https://application1.cdn.com;
                         style-src https://application1.cdn.com;
                         connect-src 'self';
                         form-action 'self'
</pre>
     <p>While <code>https://example.com/application2/</code> delivers the following
    HTTP response headers:</p>
<pre>Content-Security-Policy-Pin: <a data-link-type="dfn" href="#max-age" id="ref-for-max-age①">max-age</a>: 10886400;
                             <a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains①">includeSubDomains</a>;
                             default-src https:;
                             form-action 'none';
                             frame-ancestors 'none';
                             referrer no-referrer;
                             report-uri /csp-endpoint/pinned
Content-Security-Policy: script-src https://application2.cdn.com;
                         style-src https://application2.cdn.com;
</pre>
     <p>Meanwhile, they’ve forgotten about the coincidentally well-named <code>https://forgotten-partnership.example.com/</code>. It doesn’t send
    any CSP headers at all, and yet, it is still protected by the pinned policy
    for any users who have visited either Application 1 or Application 2.</p>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="key-concepts"><span class="secno">2. </span><span class="content">Key Concepts and Terminology</span><a class="self-link" href="#key-concepts"></a></h2>
    <h3 class="heading settled" data-level="2.1" id="terms-defined-here"><span class="secno">2.1. </span><span class="content">Terms defined by this specification</span><a class="self-link" href="#terms-defined-here"></a></h3>
    <dl>
     <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-export data-local-lt="pinned policy" data-lt="pinned security policy" id="pinned-security-policy"> pinned security policy </dfn> 
     <dd> A <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy">security policy</a> that is enforced for resources
      delivered from a <a data-link-type="dfn" href="#protected-host" id="ref-for-protected-host">protected host</a> without their own policy.
      The pinned policy’s properties are defined in <a href="#policy-delivery">§ 3 Pinned Policy Delivery</a>. 
     <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="pinned-policy-cache">pinned policy cache</dfn>
     <dd>
       In order to persistently <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce">enforce</a> policy for an origin, the user
      agent caches the following details about each <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy">pinned policy</a>: 
      <ol>
       <li> The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="protected-host">protected host</dfn>: a hostname to which the policy applies
          (e.g. <code>example.com</code>) 
       <li> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="subdomains-included">subdomains included</dfn>: <code>true</code> if <code><a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains②">includeSubDomains</a></code> is asserted, <code>false</code> otherwise. 
       <li> The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="policy-expiration-date">policy expiration date</dfn>: the moment at which a pinned
          policy is no longer applicable 
       <li> The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="policy-directive-set">policy directive set</dfn>: a set of Content Security Policy
          directives <a data-link-type="biblio" href="#biblio-csp">[CSP]</a> that the user agent MUST apply, according to its <a data-link-type="dfn" href="#mode" id="ref-for-mode">mode</a>, for each <code class="idl"><a data-link-type="idl" href="http://www.w3.org/TR/dom/#interface-document" id="ref-for-interface-document">Document</a></code> and <code class="idl"><a data-link-type="idl" href="http://www.w3.org/TR/workers/#worker" id="ref-for-worker">Worker</a></code> served from <a data-link-type="dfn" href="#protected-host" id="ref-for-protected-host①">protected host</a>, (and, potentially, its subdomains)
          that does not provide its own policy. 
       <li> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mode">mode</dfn>: <code>monitor</code> if the <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set">policy directive
          set</a> is to be <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor" id="ref-for-monitor">monitored</a>, <code>enforce</code> if the <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set①">policy directive set</a> is to be <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce①">enforced</a>. 
      </ol>
    </dl>
    <p>The Augmented Backus-Naur Form (ABNF) notation used in <a href="#policy-delivery">§ 3 Pinned Policy Delivery</a> is specified in RFC5234. <a data-link-type="biblio" href="#biblio-abnf">[ABNF]</a></p>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="policy-delivery"><span class="secno">3. </span><span class="content">Pinned Policy Delivery</span><a class="self-link" href="#policy-delivery"></a></h2>
    <p>A server MAY instruct a user agent to pin a single <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy①">security policy</a> by
  sending either a <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin①">Content-Security-Policy-Pin</a></code> or <code><a data-link-type="dfn" href="#content-security-policy-report-only-pin" id="ref-for-content-security-policy-report-only-pin">Content-Security-Policy-Report-Only-Pin</a></code> HTTP response
  header field along with a resource. <a href="#policy-processing">§ 4 Pinned Policy Processing</a> defines the user
  agent’s behavior when it receives such a response.</p>
    <p>Once a policy is pinned, it will be either <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce②">enforced</a> or <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor" id="ref-for-monitor①">monitored</a> as specified for any resource that doesn’t <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce③">enforce</a> or <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor" id="ref-for-monitor②">monitor</a> its own policy.</p>
    <p class="note" role="note"><span>Note:</span> Pinned policies are delivered <em>only</em> via HTTP header fields; no <a data-link-type="element" href="http://www.w3.org/TR/html5/document-metadata.html#the-meta-element" id="ref-for-the-meta-element">meta</a> element delivery mechanism is defined. Moreover, pinned
  policies override policies delivered via <a data-link-type="element" href="http://www.w3.org/TR/html5/document-metadata.html#the-meta-element" id="ref-for-the-meta-element①">meta</a> elements. See <a href="#pins-override-meta">§ 7.2 Pins override &lt;meta></a> for authoring guidelines.</p>
    <section>
     <h3 class="heading settled" data-level="3.1" id="content-security-policy-pin-header-field"><span class="secno">3.1. </span><span class="content"> <code>Content-Security-Policy-Pin</code> Header Field </span><a class="self-link" href="#content-security-policy-pin-header-field"></a></h3>
     <p>The <code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="content-security-policy-pin">Content-Security-Policy-Pin</dfn></code> header field
    is the mechanism for delivering a pinned policy that the user agent MUST <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce④">enforce</a> for any resource which is not delivered with a <code>Content-Security-Policy</code> header (as described in the <a href="#apply-pinned-policy">§ 4.1.3 Pin a policy to response</a> algorithm).</p>
     <p>The ABNF grammar is as follows:</p>
<pre>"Content-Security-Policy-Pin:" 1#&lt;<a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#policy_token" id="ref-for-policy_token">policy-token production from CSP, Section 4.1</a>>
</pre>
     <p>Pinning a <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy②">security policy</a> is a somewhat dangerous operation, and
    requires some reasonable expectation that the pinning is in fact desired by
    a particular <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2">origin</a>’s owner. To that end, a server MUST NOT send a <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin②">Content-Security-Policy-Pin</a></code> header with a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-2" id="ref-for-section-2">resource</a> delivered from an <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-url" id="ref-for-a-priori-insecure-url"><i lang="la">a priori</i> insecure
    URL</a>. The threat is discussed in more detail in <a href="#hostile-pinning">§ 5.1 Hostile Pinning</a>.</p>
     <p class="note" role="note"><span>Note:</span> This means that pinning is only practically available over HTTPS.
    This is intentional, as pinning is a powerful feature that ought to be
    limited to secure contexts <a data-link-type="biblio" href="#biblio-secure-contexts">[SECURE-CONTEXTS]</a>.</p>
     <p>A server MUST NOT send more than one HTTP header field named <code>Content-Security-Policy-Pin</code> with a given <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3">resource
    representation</a>.</p>
     <p>A server SHOULD send a <code>Content-Security-Policy-Pin</code> with every <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3①">resource representation</a> in order to ensure that pinning takes place
    for a given user agent no matter how it accesses a site. The value of the
    header SHOULD be the same for every <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3②">resource representation</a>, as the
    goal is to enforce a consistent baseline policy for an entire set of hosts.</p>
    </section>
    <section>
     <h3 class="heading settled" data-level="3.2" id="content-security-policy-report-only-pin-header-field"><span class="secno">3.2. </span><span class="content"> <code>Content-Security-Policy-Report-Only-Pin</code> Header Field </span><a class="self-link" href="#content-security-policy-report-only-pin-header-field"></a></h3>
     <p>The <code><dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="content-security-policy-report-only-pin">Content-Security-Policy-Report-Only-Pin</dfn></code> header field is the mechanism for delivering a pinned policy that the user
    agent MUST <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor" id="ref-for-monitor③">monitor</a> for any resource which is not delivered with a <code>Content-Security-Policy-Report-Only</code> header (as described in the <a href="#apply-pinned-policy">§ 4.1.3 Pin a policy to response</a> algorithm).</p>
     <p>The ABNF grammar is as follows:</p>
<pre>"Content-Security-Policy-Report-Only-Pin:" 1#&lt;<a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#policy_token" id="ref-for-policy_token①">policy-token production from CSP, Section 4.1</a>>
</pre>
     <p>As with <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin③">Content-Security-Policy-Pin</a></code>, a server MUST NOT
    send a <code><a data-link-type="dfn" href="#content-security-policy-report-only-pin" id="ref-for-content-security-policy-report-only-pin①">Content-Security-Policy-Report-Only-Pin</a></code> header
    with a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-2" id="ref-for-section-2①">resource</a> delivered from an <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-url" id="ref-for-a-priori-insecure-url①"><i lang="la">a priori</i> insecure URL</a>. The threat is discussed in more detail in <a href="#hostile-pinning">§ 5.1 Hostile Pinning</a>.</p>
     <p class="note" role="note"><span>Note:</span> This means that pin-reporting is only practically available over HTTPS.
    This is intentional, as pinning is a powerful feature that ought to be
    limited to secure contexts <a data-link-type="biblio" href="#biblio-secure-contexts">[SECURE-CONTEXTS]</a>.</p>
     <p>A server MUST NOT send more than one HTTP header field named <code>Content-Security-Policy-Report-Only-Pin</code> with a given <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3③">resource representation</a>.</p>
     <p>A server SHOULD send a <code>Content-Security-Policy-Report-Only-Pin</code> with every <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3④">resource representation</a> in order to ensure that pinning
    takes place for a given user agent no matter how they access a site. The
    value of the header SHOULD be the same for every <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3⑤">resource
    representation</a>, as the goal is to monitor a consistent baseline policy
    for an entire set of hosts.</p>
     <p class="issue" id="issue-475ca4fb"><a class="self-link" href="#issue-475ca4fb"></a> What’s the impact of reporting? If headers can be injected into <code>appspot.com</code> or <code>newyorktimes.com</code>, can attackers use
    reporting to determine what apps you’re using, or what articles you’re
    reading? Brian <a href="https://lists.w3.org/Archives/Public/public-webappsec/2015Feb/0164.html">has
    explored this space a bit</a>. Perhaps dropping reporting from pinned
    policies would be reasonable. The main use-case I see would be discovering
    pieces of your site that you haven’t covered with a policy (e.g. where did
    the pin decrease attack surface?). It’s not clear we can even do that
    without the implications Brian suggests.</p>
    </section>
    <section>
     <h3 class="heading settled" data-level="3.3" id="csp-pins-syntax"><span class="secno">3.3. </span><span class="content">Pinned Policy Syntax</span><a class="self-link" href="#csp-pins-syntax"></a></h3>
     <p>The grammar for a pinned policy is the same as the grammar for the <code><a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#content_security_policy" id="ref-for-content_security_policy">Content-Security-Policy</a></code> header, defined in <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#policy-syntax" id="ref-for-policy-syntax">Section 4.1 of the Content Security Policy
    specification</a>.</p>
     <p>A pinned policy’s value MUST contain a <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age②">max-age</a></code> directive, and MAY contain an <code><a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains③">includeSubDomains</a></code> directive.</p>
     <section>
      <h4 class="heading settled" data-level="3.3.1" id="max-age-directive"><span class="secno">3.3.1. </span><span class="content">The <code>max-age</code> directive</span><a class="self-link" href="#max-age-directive"></a></h4>
      <p>The <code><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="max-age">max-age</dfn></code> directive specifies the number of
      seconds after the reception of the <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin④">Content-Security-Policy-Pin</a></code> HTTP response header
      field during which the UA SHOULD <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce" id="ref-for-enforce⑤">enforce</a> the <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy①">pinned policy</a>.</p>
      <p>The directive is defined via the following ABNF grammar:</p>
<pre>directive-name  = "max-age"
directive-value = 1*DIGIT
</pre>
      <p>The <code>max-age</code> directive MUST be present within the <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin⑤">Content-Security-Policy-Pin</a></code> header field. If it is not
      present, the header field will be ignored (see <a href="#policy-processing">§ 4 Pinned Policy Processing</a> for
      user agent requirements).</p>
     </section>
     <section>
      <h4 class="heading settled" data-level="3.3.2" id="includesubdomains-directive"><span class="secno">3.3.2. </span><span class="content"> The <code>includeSubDomains</code> directive </span><a class="self-link" href="#includesubdomains-directive"></a></h4>
      <p>The <code><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="includesubdomains">includeSubDomains</dfn></code> directive signals to
      the user agent that the <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy②">pinned policy</a> defined in the <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin⑥">Content-Security-Policy-Pin</a></code> header field applies not
      only to the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2①">origin</a> that served the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3⑥">resource representation</a>,
      but also to any <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2②">origin</a> whose <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-host" id="ref-for-concept-url-host">host</a> component is a subdomain
      of the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-host" id="ref-for-concept-url-host①">host</a> component of the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc7231#section-3" id="ref-for-section-3⑦">resource representation</a>’s <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2③">origin</a> (see <a href="#policy-processing">§ 4 Pinned Policy Processing</a> for user agent requirements).</p>
     </section>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="4" id="policy-processing"><span class="secno">4. </span><span class="content">Pinned Policy Processing</span><a class="self-link" href="#policy-processing"></a></h2>
    <p>The user agent discovers and processes pinned policies during <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetching" id="ref-for-fetching">fetching</a>.
  Upon receiving a response, the user agent will:</p>
    <ol>
     <li data-md>
      <p>Sift through the HTTP headers according to the <a href="#discover-pinned-policy">§ 4.1.1 Discover pinned policies for response</a> algorithm to determine if the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache">pinned policy cache</a> for the response’s
 host needs to be updated.</p>
     <li data-md>
      <p>Update the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache①">pinned policy cache</a>, according to the <a href="#pin-policy">§ 4.1.2 Pin policy for origin in mode</a> algorithm.</p>
     <li data-md>
      <p>Update the response’s headers to ensure that any relevant <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy③">pinned
 policies</a> are applied, according to the <a href="#apply-pinned-policy">§ 4.1.3 Pin a policy to response</a> algorithm.</p>
    </ol>
    <p class="issue" id="issue-ff5918de"><a class="self-link" href="#issue-ff5918de"></a> We probably need a hook in <a data-link-type="biblio" href="#biblio-fetch">[Fetch]</a>. In
  particular, we need to ensure that we detect and pin a policy early enough
  for <code>frame-ancestors</code> and <code>referrer</code> to handle blocking
  and redirects.</p>
    <p>Periodically, the user agent will run through the <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy④">pinned policies</a> it
  has stored in the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache②">pinned policy cache</a>, and remove those that have
  expired, according to the <a href="#expire-pinned-policies">§ 4.2.2 Remove expired pinned policies from the cache</a> algorithm.</p>
    <h3 class="heading settled" data-level="4.1" id="fetching-algorithms"><span class="secno">4.1. </span><span class="content">Fetching Algorithms</span><a class="self-link" href="#fetching-algorithms"></a></h3>
    <h4 class="heading settled" data-level="4.1.1" id="discover-pinned-policy"><span class="secno">4.1.1. </span><span class="content"> Discover pinned policies for <var>response</var> </span><a class="self-link" href="#discover-pinned-policy"></a></h4>
    <p>Upon receiving a <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#response" id="ref-for-response">Response</a></code> <var>response</var> containing at least one <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin⑦">Content-Security-Policy-Pin</a></code> header field, the user agent
  MUST peform the following steps:</p>
    <ol>
     <li> Let <var>origin</var> be the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a> of <var>response</var>’s URL. 
     <li> Let <var>value</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-parse" id="ref-for-concept-header-parse">parsing</a> <code>Content-Security-Policy-Pin</code> in <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a>. 
     <li> If <var>value</var> is not <code>null</code>, then execute the <a href="#pin-policy">§ 4.1.2 Pin policy for origin in mode</a> algorithm, passing in <var>value</var>, the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin①">origin</a> of <var>response</var>’s URL,
      and <code>enforce</code>. 
     <li> Let <var>value</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-parse" id="ref-for-concept-header-parse①">parsing</a> <code>Content-Security-Policy-Report-Only-Pin</code> in <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list①">header list</a>. 
     <li> If <var>value</var> is not <code>null</code>, then execute the <a href="#pin-policy">§ 4.1.2 Pin policy for origin in mode</a> algorithm, passing in <var>value</var>, the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin②">origin</a> of <var>response</var>’s URL,
      and <code>monitor</code>. 
    </ol>
    <h4 class="heading settled" data-level="4.1.2" id="pin-policy"><span class="secno">4.1.2. </span><span class="content"> Pin <var>policy</var> for <var>origin</var> in <var>mode</var> </span><a class="self-link" href="#pin-policy"></a></h4>
    <p>Given an <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6454#section-3.2" id="ref-for-section-3.2④">Origin</a> <var>origin</var>, a parsed set of directives <var>policy</var>, and a <var>mode</var> (either <code>enforce</code> or <code>monitor</code>), this algorithm defines the user agent behavior that
  results in a <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy⑤">pinned policy</a> for <var>origin</var>.</p>
    <ol>
     <li> If <var>origin</var> is an <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-origin" id="ref-for-a-priori-insecure-origin"><i lang="la">a priori</i> insecure
      origin</a>, output a developer-friendly warning, and abort these steps. 
     <li> Let <var>host</var> be the host component of <var>origin</var>. 
     <li> If <var>host</var> is an IPv4 or IPv6 address, output a developer-friendly
      warning, and abort these steps. 
     <li> Let <var>policy</var> be the result of executing the <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#parse-the-policy" id="ref-for-parse-the-policy">parse the
      policy</a> algorithm on <var>directives</var>. 
     <li> If <var>policy</var> does <strong>not</strong> contain a <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age③">max-age</a></code> directive, then output a developer-friendly
      warning, and abort these steps. 
     <li> Let <var>subdomains</var> be <code>true</code> if an <code><a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains④">includeSubDomains</a></code> is present in <var>policy</var>,
      and <code>false</code> otherwise. 
     <li> Let <var>TTL</var> be the number of seconds specified in <var>policy</var>’s <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age④">max-age</a></code> directive. If more than
      one such directive is present, let <var>TTL</var> be the largest value
      specified. 
     <li> Let <var>expiration</var> be the current time, plus <var>TTL</var>. 
     <li> Remove any <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age⑤">max-age</a></code> and <code><a data-link-type="dfn" href="#includesubdomains" id="ref-for-includesubdomains⑤">includeSubDomains</a></code> directives from <var>policy</var>. 
     <li> Let <var>pinned</var> be the result of executing <a href="#pinned-policy-for-host">§ 4.2.1 Get the mode pinned policy for host</a> for <var>mode</var> and <var>host</var>. 
     <li>
       If <var>pinned</var> is not <code>null</code>, then update the <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy⑥">pinned
      policy</a> <var>pinned</var> as follows: 
      <ol>
       <li> If <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age⑥">max-age</a></code> is <code>0</code>, then remove <var>pinned</var> from the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache③">pinned policy cache</a> and abort these
          steps. 
       <li>
         Otherwise: 
        <ol>
         <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#policy-expiration-date" id="ref-for-policy-expiration-date">policy expiration date</a> to <var>expiration</var>. 
         <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#subdomains-included" id="ref-for-subdomains-included">subdomains included</a> to <var>subdomains</var>. 
         <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set②">policy directive set</a> to <var>policy</var>. 
        </ol>
      </ol>
     <li>
       Otherwise, <var>host</var> is not a <a data-link-type="dfn" href="#protected-host" id="ref-for-protected-host②">protected host</a>. If <var>TTL</var> is not <code>0</code>, then: 
      <ol>
       <li> Let <var>pinned</var> be a new <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy⑦">pinned policy</a>. 
       <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#protected-host" id="ref-for-protected-host③">protected host</a> to <var>host</var>. 
       <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#policy-expiration-date" id="ref-for-policy-expiration-date①">policy expiration date</a> to <var>expiration</var>. 
       <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#subdomains-included" id="ref-for-subdomains-included①">subdomains included</a> to <var>subdomains</var>. 
       <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set③">policy directive set</a> to <var>policy</var>. 
       <li> Set <var>pinned</var>’s <a data-link-type="dfn" href="#mode" id="ref-for-mode①">mode</a> to <var>mode</var>. 
       <li> Add <var>pinned</var> to the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache④">pinned policy cache</a>. 
      </ol>
    </ol>
    <h4 class="heading settled" data-level="4.1.3" id="apply-pinned-policy"><span class="secno">4.1.3. </span><span class="content"> Pin a policy to <var>response</var> </span><a class="self-link" href="#apply-pinned-policy"></a></h4>
    <p>Upon receiving a <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#response" id="ref-for-response①">Response</a></code> <var>response</var>, ensure that it contains
  appropriate <code>Content-Security-Policy</code> headers by performing the
  following steps:</p>
    <ol>
     <li> Let <var>host</var> be the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-host" id="ref-for-concept-url-host②">host</a> component of <var>response</var>’s
      URL’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin③">origin</a>. 
     <li> Let <var>pinned</var> be the result of executing <a href="#pinned-policy-for-host">§ 4.2.1 Get the mode pinned policy for host</a> for <code>enforce</code> and <var>host</var>. 
     <li>
       If <var>pinned</var> is not <code>null</code>: 
      <ol>
       <li> Let <var>value</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-parse" id="ref-for-concept-header-parse②">parsing</a> <code>Content-Security-Policy</code> in <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list②">header list</a>. 
       <li>
         If <var>value</var> is <code>null</code>: 
        <ol>
         <li> Append a header named <code>Content-Security-Policy</code> with a
              value of <var>pinned</var>’s <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set④">policy directive set</a> to <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list③">header list</a>. 
        </ol>
      </ol>
     <li> Let <var>pinned</var> be the result of executing <a href="#pinned-policy-for-host">§ 4.2.1 Get the mode pinned policy for host</a> for <code>monitor</code> and <var>host</var>. 
     <li>
       If <var>pinned</var> is not <code>null</code>: 
      <ol>
       <li> Let <var>value</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-parse" id="ref-for-concept-header-parse③">parsing</a> <code>Content-Security-Policy-Report-Only</code> in <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list④">header list</a>. 
       <li>
         If <var>value</var> is <code>null</code>: 
        <ol>
         <li> Append a header named <code>Content-Security-Policy-Report-Only</code> with a value of <var>pinned</var>’s <a data-link-type="dfn" href="#policy-directive-set" id="ref-for-policy-directive-set⑤">policy directive set</a> to <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list⑤">header list</a>. 
        </ol>
      </ol>
    </ol>
    <h3 class="heading settled" data-level="4.2" id="cache-algorithms"><span class="secno">4.2. </span><span class="content"> Pinned Policy Cache Algorithms </span><a class="self-link" href="#cache-algorithms"></a></h3>
    <h4 class="heading settled" data-level="4.2.1" id="pinned-policy-for-host"><span class="secno">4.2.1. </span><span class="content"> Get the <var>mode</var> pinned policy for <var>host</var> </span><a class="self-link" href="#pinned-policy-for-host"></a></h4>
    <p>Given a <var>host</var>, and a <a data-link-type="dfn" href="#mode" id="ref-for-mode②">mode</a> <var>mode</var>, this algorithm
  walks through the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache⑤">pinned policy cache</a>, and returns the first matching
  policy. If no policies match, this algorithm returns <code>null</code>.</p>
    <p class="note" role="note"><span>Note:</span> There ought to be at most one policy that matches, given the constraints
  in <a href="#pin-policy">§ 4.1.2 Pin policy for origin in mode</a>.</p>
    <ol>
     <li>
       For each <var>policy</var> in the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache⑥">pinned policy cache</a>: 
      <ol>
       <li> If <var>policy</var>’s <a data-link-type="dfn" href="#mode" id="ref-for-mode③">mode</a> is not <var>mode</var>, skip to the
          next policy in the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache⑦">pinned policy cache</a>. 
       <li> Let <var>match type</var> be the result of applying the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6797#section-8.2" id="ref-for-section-8.2">Known HSTS
          Host domain name matching</a> algorithm specified in <a data-link-type="biblio" href="#biblio-rfc6797">[RFC6797]</a> to <var>host</var> and <var>policy</var>’s <a data-link-type="dfn" href="#protected-host" id="ref-for-protected-host④">protected host</a>. 
       <li> If <var>match type</var> is <code><a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6797#section-8.2" id="ref-for-section-8.2①">Superdomain Match</a></code>, and <var>policy</var>’s <a data-link-type="dfn" href="#subdomains-included" id="ref-for-subdomains-included②">subdomains included</a> is <code>true</code>,
          then return <var>policy</var>. 
       <li> If <var>match type</var> is <code><a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6797#section-8.2" id="ref-for-section-8.2②">Congruent Match</a></code>, then
          return <var>policy</var>. 
      </ol>
     <li> Return <code>null</code>. 
    </ol>
    <h4 class="heading settled" data-level="4.2.2" id="expire-pinned-policies"><span class="secno">4.2.2. </span><span class="content"> Remove expired pinned policies from the cache </span><a class="self-link" href="#expire-pinned-policies"></a></h4>
    <p>Periodically, the user agent MUST remove expired policies from the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache⑧">pinned
  policy cache</a>. Removal will have no web-visible effect, as expired policies
  will not modify <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#response" id="ref-for-response②">Response</a></code>s during <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#fetching" id="ref-for-fetching①">fetching</a>, but expired policies can
  have privacy impact if they aren’t removed completely (as they offer evidence
  that a particular user visited a particular host at some point in the past).</p>
    <p>Expired entries can be removed via the following steps:</p>
    <ol>
     <li>
       For each <var>policy</var> in the list of <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy⑧">pinned policies</a> contained
      in the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache⑨">pinned policy cache</a>: 
      <ol>
       <li> If <var>policy</var>’s <a data-link-type="dfn" href="#policy-expiration-date" id="ref-for-policy-expiration-date②">policy expiration date</a> is prior to the
          current time, remove <var>policy</var> from the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache①⓪">pinned policy
          cache</a>. 
      </ol>
    </ol>
   </section>
   <section>
    <h2 class="heading settled" data-level="5" id="security-considerations"><span class="secno">5. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
    <h3 class="heading settled" data-level="5.1" id="hostile-pinning"><span class="secno">5.1. </span><span class="content">Hostile Pinning</span><a class="self-link" href="#hostile-pinning"></a></h3>
    <p>An active network attacker who is able to inject headers into a site’s
  responses may attempt to maliciously pin a <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy③">security policy</a> for a host
  and its subdomains. Pinning <code>default-src 'none'</code> on a page that
  wasn’t built to work under such restrictions could deny service for an
  entire application.</p>
    <p>Unlike public key pinning <a data-link-type="biblio" href="#biblio-pkp">[PKP]</a>, however, pinning a security policy cannot
  completely deny access to a site. This means that maliciously (or
  accidentally) pinned policies can be easily overridden in two ways:</p>
    <ol>
     <li>
       Authors SHOULD send a valid <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy④">security policy</a> down with each HTTP
      response, and use the pin only as a backup (see <a href="#pins-as-defaults">§ 7.1 Pins as a default</a>). 
      <p class="note" role="note"><span>Note:</span> A future version of this specification may add a directive which
      prevents overriding the pinned policy (<code>no-override</code>?). This
      would allow authors to choose a stricter deployment model, but would
      remove this override possibility.</p>
     <li> Authors may also rescind a pinned policy by sending a new <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin⑧">Content-Security-Policy-Pin</a></code> header with a <code><a data-link-type="dfn" href="#max-age" id="ref-for-max-age⑦">max-age</a></code> of <code>0</code>. 
    </ol>
    <p>Moreover, the risk of malicious injection is mitigated by the fact that we
  only accept pins over secure and authenticated connections.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="6" id="privacy-considerations"><span class="secno">6. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy-considerations"></a></h2>
    <h3 class="heading settled" data-level="6.1" id="fingerprinting"><span class="secno">6.1. </span><span class="content">Fingerprinting</span><a class="self-link" href="#fingerprinting"></a></h3>
    <p>Similar to HSTS and HPKP, a <a data-link-type="dfn" href="#pinned-security-policy" id="ref-for-pinned-security-policy⑨">pinned security policy</a> could be used as a
  "supercookie", setting a distinct policy for each user which can be used as
  an identifier in combination with (or instead of) HTTP cookies.</p>
    <p>For example, the <code>report-uri</code> directive could contain a unique
  identifier (<code>report-uri https://example.com/endpoint?id=123</code>) which
  could identify a user based on correlating violation reports with user
  activity.</p>
    <p>To mitigate this risk, user agents MUST:</p>
    <ol>
     <li> Clear the <a data-link-type="dfn" href="#pinned-policy-cache" id="ref-for-pinned-policy-cache①①">pinned policy cache</a> when the user clears her browsing
      data (cookies, site data, history, etc). 
     <li> Refuse to process <code>Set-Cookie</code> response headers during the <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#send-violation-reports" id="ref-for-send-violation-reports">send violation reports</a> algorithm. 
    </ol>
    <p class="issue" id="issue-aa0896fd"><a class="self-link" href="#issue-aa0896fd"></a> Can we assume that subdomains are really owned by the owner of the
  root domain?</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="7" id="authoring-considerations"><span class="secno">7. </span><span class="content">Authoring Considerations</span><a class="self-link" href="#authoring-considerations"></a></h2>
    <h3 class="heading settled" data-level="7.1" id="pins-as-defaults"><span class="secno">7.1. </span><span class="content">Pins as a default</span><a class="self-link" href="#pins-as-defaults"></a></h3>
    <p class="issue" id="issue-4273d051"><a class="self-link" href="#issue-4273d051"></a> Explain something about the theory; pins act as a baseline for
  resources that don’t otherwise have a policy. Explain layering, granularity,
  etc.</p>
    <h3 class="heading settled" data-level="7.2" id="pins-override-meta"><span class="secno">7.2. </span><span class="content">Pins override <code>&lt;meta></code></span><a class="self-link" href="#pins-override-meta"></a></h3>
    <p>Pinned policies are applied before <a data-link-type="element" href="http://www.w3.org/TR/html5/document-metadata.html#the-meta-element" id="ref-for-the-meta-element②">meta</a> elements can be
  discovered. This means that a resource delivered without a header that
  specified a <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy" id="ref-for-security-policy⑤">security policy</a> will be subject to the policy pinned
  for its host, even if it then delivers a policy via the mechanisms described
  in the <a data-link-type="dfn" href="https://w3c.github.io/webappsec/specs/content-security-policy/#delivery-html-meta-element" id="ref-for-delivery-html-meta-element">HTML <code>&lt;meta></code> element</a> section of <a data-link-type="biblio" href="#biblio-csp">[CSP]</a>.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="8" id="iana-considerations"><span class="secno">8. </span><span class="content">IANA Considerations</span><a class="self-link" href="#iana-considerations"></a></h2>
    <p>The permanent message header field registry should be updated
  with the following registrations: <a data-link-type="biblio" href="#biblio-rfc3864">[RFC3864]</a></p>
    <section>
     <h3 class="heading settled" data-level="8.1" id="iana-content-security-policy-pin"><span class="secno">8.1. </span><span class="content"> Content-Security-Policy-Pin </span><a class="self-link" href="#iana-content-security-policy-pin"></a></h3>
     <dl>
      <dt>Header field name
      <dd>Content-Security-Policy-Pin
      <dt>Applicable protocol
      <dd>http
      <dt>Status
      <dd>standard
      <dt>Author/Change controller
      <dd>W3C
      <dt>Specification document
      <dd>This specification (See <code><a data-link-type="dfn" href="#content-security-policy-pin" id="ref-for-content-security-policy-pin⑨">Content-Security-Policy-Pin</a></code> Header Field)
     </dl>
    </section>
    <section>
     <h3 class="heading settled" data-level="8.2" id="iana-content-security-policy-report-only-pin"><span class="secno">8.2. </span><span class="content"> Content-Security-Policy-Report-Only-Pin </span><a class="self-link" href="#iana-content-security-policy-report-only-pin"></a></h3>
     <dl>
      <dt>Header field name
      <dd>Content-Security-Policy-Report-Only-Pin
      <dt>Applicable protocol
      <dd>http
      <dt>Status
      <dd>standard
      <dt>Author/Change controller
      <dd>W3C
      <dt>Specification document
      <dd>This specification (See <code><a data-link-type="dfn" href="#content-security-policy-report-only-pin" id="ref-for-content-security-policy-report-only-pin②">Content-Security-Policy-Report-Only-Pin</a></code> Header Field)
     </dl>
    </section>
   </section>
   <section>
    <h2 class="heading settled" data-level="9" id="acknowledgements"><span class="secno">9. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
    <p>Yan Zhu kicked my butt to get this document out the door. I stole concepts
  wholesale from both HSTS and PKP.</p>
   </section>
  </main>
  <h2 class="no-ref no-num heading settled" id="conformance"><span class="content">Conformance</span><a class="self-link" href="#conformance"></a></h2>
  <h3 class="no-ref no-num heading settled" id="conventions"><span class="content">Document conventions</span><a class="self-link" href="#conventions"></a></h3>
  <p>Conformance requirements are expressed with a combination of
    descriptive assertions and RFC 2119 terminology. The key words “MUST”,
    “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
    “RECOMMENDED”, “MAY”, and “OPTIONAL” in the normative parts of this
    document are to be interpreted as described in RFC 2119.
    However, for readability, these words do not appear in all uppercase
    letters in this specification. </p>
  <p>All of the text of this specification is normative except sections
    explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119">[RFC2119]</a></p>
  <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text with <code>class="example"</code>,
    like this: </p>
  <div class="example" id="example-ae2b6bc0">
   <a class="self-link" href="#example-ae2b6bc0"></a> 
   <p>This is an example of an informative example.</p>
  </div>
  <p>Informative notes begin with the word “Note” and are set apart from the
    normative text with <code>class="note"</code>, like this: </p>
  <p class="note" role="note">Note, this is an informative note.</p>
  <h3 class="no-ref no-num heading settled" id="conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#conformant-algorithms"></a></h3>
  <p>Requirements phrased in the imperative as part of algorithms (such as
    "strip any leading space characters" or "return false and abort these
    steps") are to be interpreted with the meaning of the key word ("must",
    "should", "may", etc) used in introducing the algorithm.</p>
  <p>Conformance requirements phrased as algorithms or specific steps can be
    implemented in any manner, so long as the end result is equivalent. In
    particular, the algorithms defined in this specification are intended to
    be easy to understand and are not intended to be performant. Implementers
    are encouraged to optimize.</p>
<script src="https://www.w3.org/scripts/TR/2016/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#content-security-policy-pin">Content-Security-Policy-Pin</a><span>, in §3.1</span>
   <li><a href="#content-security-policy-report-only-pin">Content-Security-Policy-Report-Only-Pin</a><span>, in §3.2</span>
   <li><a href="#includesubdomains">includeSubDomains</a><span>, in §3.3.2</span>
   <li><a href="#max-age">max-age</a><span>, in §3.3.1</span>
   <li><a href="#mode">mode</a><span>, in §2.1</span>
   <li><a href="#pinned-security-policy">pinned policy</a><span>, in §2.1</span>
   <li><a href="#pinned-policy-cache">pinned policy cache</a><span>, in §2.1</span>
   <li><a href="#pinned-security-policy">pinned security policy</a><span>, in §2.1</span>
   <li><a href="#policy-directive-set">policy directive set</a><span>, in §2.1</span>
   <li><a href="#policy-expiration-date">policy expiration date</a><span>, in §2.1</span>
   <li><a href="#protected-host">protected host</a><span>, in §2.1</span>
   <li><a href="#subdomains-included">subdomains included</a><span>, in §2.1</span>
  </ul>
  <aside class="dfn-panel" data-for="term-for-content_security_policy">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#content_security_policy">https://w3c.github.io/webappsec/specs/content-security-policy/#content_security_policy</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-content_security_policy">3.3. Pinned Policy Syntax</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-delivery-html-meta-element">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#delivery-html-meta-element">https://w3c.github.io/webappsec/specs/content-security-policy/#delivery-html-meta-element</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-delivery-html-meta-element">7.2. Pins override &lt;meta></a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-enforce">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce">https://w3c.github.io/webappsec/specs/content-security-policy/#enforce</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-enforce">2.1. Terms defined by this specification</a> <a href="#ref-for-enforce①">(2)</a>
    <li><a href="#ref-for-enforce②">3. Pinned Policy Delivery</a> <a href="#ref-for-enforce③">(2)</a>
    <li><a href="#ref-for-enforce④">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-enforce⑤">3.3.1. The max-age directive</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-enforce">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#enforce">https://w3c.github.io/webappsec/specs/content-security-policy/#enforce</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-enforce">2.1. Terms defined by this specification</a> <a href="#ref-for-enforce①">(2)</a>
    <li><a href="#ref-for-enforce②">3. Pinned Policy Delivery</a> <a href="#ref-for-enforce③">(2)</a>
    <li><a href="#ref-for-enforce④">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-enforce⑤">3.3.1. The max-age directive</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-monitor">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor">https://w3c.github.io/webappsec/specs/content-security-policy/#monitor</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-monitor">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-monitor①">3. Pinned Policy Delivery</a> <a href="#ref-for-monitor②">(2)</a>
    <li><a href="#ref-for-monitor③">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-monitor">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#monitor">https://w3c.github.io/webappsec/specs/content-security-policy/#monitor</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-monitor">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-monitor①">3. Pinned Policy Delivery</a> <a href="#ref-for-monitor②">(2)</a>
    <li><a href="#ref-for-monitor③">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-parse-the-policy">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#parse-the-policy">https://w3c.github.io/webappsec/specs/content-security-policy/#parse-the-policy</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-parse-the-policy">4.1.2. 
    Pin policy for origin in mode </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-policy-syntax">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#policy-syntax">https://w3c.github.io/webappsec/specs/content-security-policy/#policy-syntax</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-policy-syntax">3.3. Pinned Policy Syntax</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-policy_token">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#policy_token">https://w3c.github.io/webappsec/specs/content-security-policy/#policy_token</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-policy_token">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-policy_token①">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-security-policy">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy">https://w3c.github.io/webappsec/specs/content-security-policy/#security-policy</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-security-policy">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-security-policy①">3. Pinned Policy Delivery</a>
    <li><a href="#ref-for-security-policy②">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-security-policy③">5.1. Hostile Pinning</a> <a href="#ref-for-security-policy④">(2)</a>
    <li><a href="#ref-for-security-policy⑤">7.2. Pins override &lt;meta></a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-send-violation-reports">
   <a href="https://w3c.github.io/webappsec/specs/content-security-policy/#send-violation-reports">https://w3c.github.io/webappsec/specs/content-security-policy/#send-violation-reports</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-send-violation-reports">6.1. Fingerprinting</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-interface-document">
   <a href="http://www.w3.org/TR/dom/#interface-document">http://www.w3.org/TR/dom/#interface-document</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-interface-document">2.1. Terms defined by this specification</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-response">
   <a href="https://fetch.spec.whatwg.org/#response">https://fetch.spec.whatwg.org/#response</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-response">4.1.1. 
     Discover pinned policies for response </a>
    <li><a href="#ref-for-response①">4.1.3. 
    Pin a policy to response </a>
    <li><a href="#ref-for-response②">4.2.2. 
    Remove expired pinned policies from the cache </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-fetching">
   <a href="https://fetch.spec.whatwg.org/#fetching">https://fetch.spec.whatwg.org/#fetching</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-fetching">4. Pinned Policy Processing</a>
    <li><a href="#ref-for-fetching①">4.2.2. 
    Remove expired pinned policies from the cache </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-response-header-list">
   <a href="https://fetch.spec.whatwg.org/#concept-response-header-list">https://fetch.spec.whatwg.org/#concept-response-header-list</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-response-header-list">4.1.1. 
     Discover pinned policies for response </a> <a href="#ref-for-concept-response-header-list①">(2)</a>
    <li><a href="#ref-for-concept-response-header-list②">4.1.3. 
    Pin a policy to response </a> <a href="#ref-for-concept-response-header-list③">(2)</a> <a href="#ref-for-concept-response-header-list④">(3)</a> <a href="#ref-for-concept-response-header-list⑤">(4)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-header-parse">
   <a href="https://fetch.spec.whatwg.org/#concept-header-parse">https://fetch.spec.whatwg.org/#concept-header-parse</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-header-parse">4.1.1. 
     Discover pinned policies for response </a> <a href="#ref-for-concept-header-parse①">(2)</a>
    <li><a href="#ref-for-concept-header-parse②">4.1.3. 
    Pin a policy to response </a> <a href="#ref-for-concept-header-parse③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-the-meta-element">
   <a href="http://www.w3.org/TR/html5/document-metadata.html#the-meta-element">http://www.w3.org/TR/html5/document-metadata.html#the-meta-element</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-the-meta-element">3. Pinned Policy Delivery</a> <a href="#ref-for-the-meta-element①">(2)</a>
    <li><a href="#ref-for-the-meta-element②">7.2. Pins override &lt;meta></a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-a-priori-insecure-origin">
   <a href="https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-origin">https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-a-priori-insecure-origin">4.1.2. 
    Pin policy for origin in mode </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-a-priori-insecure-url">
   <a href="https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-url">https://w3c.github.io/webappsec/specs/mixedcontent/#a-priori-insecure-url</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-a-priori-insecure-url">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-a-priori-insecure-url①">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-3.2">
   <a href="https://tools.ietf.org/html/rfc6454#section-3.2">https://tools.ietf.org/html/rfc6454#section-3.2</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-3.2">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-section-3.2①">3.3.2. 
        The includeSubDomains directive </a> <a href="#ref-for-section-3.2②">(2)</a> <a href="#ref-for-section-3.2③">(3)</a>
    <li><a href="#ref-for-section-3.2④">4.1.2. 
    Pin policy for origin in mode </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-8.2">
   <a href="https://tools.ietf.org/html/rfc6797#section-8.2">https://tools.ietf.org/html/rfc6797#section-8.2</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-8.2">4.2.1. 
    Get the mode pinned policy for host </a> <a href="#ref-for-section-8.2①">(2)</a> <a href="#ref-for-section-8.2②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-8.2">
   <a href="https://tools.ietf.org/html/rfc6797#section-8.2">https://tools.ietf.org/html/rfc6797#section-8.2</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-8.2">4.2.1. 
    Get the mode pinned policy for host </a> <a href="#ref-for-section-8.2①">(2)</a> <a href="#ref-for-section-8.2②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-8.2">
   <a href="https://tools.ietf.org/html/rfc6797#section-8.2">https://tools.ietf.org/html/rfc6797#section-8.2</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-8.2">4.2.1. 
    Get the mode pinned policy for host </a> <a href="#ref-for-section-8.2①">(2)</a> <a href="#ref-for-section-8.2②">(3)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-2">
   <a href="https://tools.ietf.org/html/rfc7231#section-2">https://tools.ietf.org/html/rfc7231#section-2</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-2">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-section-2①">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-section-3">
   <a href="https://tools.ietf.org/html/rfc7231#section-3">https://tools.ietf.org/html/rfc7231#section-3</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-section-3">3.1. 
      Content-Security-Policy-Pin Header Field </a> <a href="#ref-for-section-3①">(2)</a> <a href="#ref-for-section-3②">(3)</a>
    <li><a href="#ref-for-section-3③">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a> <a href="#ref-for-section-3④">(2)</a> <a href="#ref-for-section-3⑤">(3)</a>
    <li><a href="#ref-for-section-3⑥">3.3.2. 
        The includeSubDomains directive </a> <a href="#ref-for-section-3⑦">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-host">
   <a href="https://url.spec.whatwg.org/#concept-url-host">https://url.spec.whatwg.org/#concept-url-host</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-host">3.3.2. 
        The includeSubDomains directive </a> <a href="#ref-for-concept-url-host①">(2)</a>
    <li><a href="#ref-for-concept-url-host②">4.1.3. 
    Pin a policy to response </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-concept-url-origin">
   <a href="https://url.spec.whatwg.org/#concept-url-origin">https://url.spec.whatwg.org/#concept-url-origin</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-concept-url-origin">4.1.1. 
     Discover pinned policies for response </a> <a href="#ref-for-concept-url-origin①">(2)</a> <a href="#ref-for-concept-url-origin②">(3)</a>
    <li><a href="#ref-for-concept-url-origin③">4.1.3. 
    Pin a policy to response </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="term-for-worker">
   <a href="http://www.w3.org/TR/workers/#worker">http://www.w3.org/TR/workers/#worker</a><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-worker">2.1. Terms defined by this specification</a>
   </ul>
  </aside>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-content_security_policy">content-security-policy</span>
     <li><span class="dfn-paneled" id="term-for-delivery-html-meta-element">delivery via meta element</span>
     <li><span class="dfn-paneled" id="term-for-enforce">enforce</span>
     <li><span class="dfn-paneled" id="term-for-enforce①">enforced</span>
     <li><span class="dfn-paneled" id="term-for-monitor">monitor</span>
     <li><span class="dfn-paneled" id="term-for-monitor①">monitored</span>
     <li><span class="dfn-paneled" id="term-for-parse-the-policy">parse the policy</span>
     <li><span class="dfn-paneled" id="term-for-policy-syntax">policy syntax</span>
     <li><span class="dfn-paneled" id="term-for-policy_token">policy-token</span>
     <li><span class="dfn-paneled" id="term-for-security-policy">security policy</span>
     <li><span class="dfn-paneled" id="term-for-send-violation-reports">send violation reports</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-interface-document">Document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[Fetch]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-response">Response</span>
     <li><span class="dfn-paneled" id="term-for-fetching">fetching</span>
     <li><span class="dfn-paneled" id="term-for-concept-response-header-list">header list</span>
     <li><span class="dfn-paneled" id="term-for-concept-header-parse">parse header</span>
    </ul>
   <li>
    <a data-link-type="biblio">[html5]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-the-meta-element">meta</span>
    </ul>
   <li>
    <a data-link-type="biblio">[mixed-content]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-a-priori-insecure-origin">a priori insecure origin</span>
     <li><span class="dfn-paneled" id="term-for-a-priori-insecure-url">a priori insecure url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[rfc6454]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-section-3.2">origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6797]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-section-8.2">congruent match</span>
     <li><span class="dfn-paneled" id="term-for-section-8.2①">known hsts host domain name matching</span>
     <li><span class="dfn-paneled" id="term-for-section-8.2②">superdomain match</span>
    </ul>
   <li>
    <a data-link-type="biblio">[rfc7231]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-section-2">resource</span>
     <li><span class="dfn-paneled" id="term-for-section-3">resource representation</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-concept-url-host">host</span>
     <li><span class="dfn-paneled" id="term-for-concept-url-origin">origin of a url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[workers]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="term-for-worker">Worker</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-abnf">[ABNF]
   <dd>D. Crocker, Ed.; P. Overell. <a href="https://datatracker.ietf.org/doc/html/rfc5234"><cite>Augmented BNF for Syntax Specifications: ABNF</cite></a>. January 2008. Internet Standard. URL: <a href="https://datatracker.ietf.org/doc/html/rfc5234">https://datatracker.ietf.org/doc/html/rfc5234</a>
   <dt id="biblio-csp">[CSP]
   <dd>Mike West; Dan Veditz. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy</cite></a>. WD. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[Fetch]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html5">[HTML5]
   <dd>Ian Hickson; et al. <a href="https://www.w3.org/TR/html5/"><cite>HTML5</cite></a>. 27 March 2018. REC. URL: <a href="https://www.w3.org/TR/html5/">https://www.w3.org/TR/html5/</a>
   <dt id="biblio-mixed-content">[MIXED-CONTENT]
   <dd>Mike West. <a href="https://www.w3.org/TR/mixed-content/"><cite>Mixed Content</cite></a>. 2 August 2016. CR. URL: <a href="https://www.w3.org/TR/mixed-content/">https://www.w3.org/TR/mixed-content/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc3864">[RFC3864]
   <dd>G. Klyne; M. Nottingham; J. Mogul. <a href="https://datatracker.ietf.org/doc/html/rfc3864"><cite>Registration Procedures for Message Header Fields</cite></a>. September 2004. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc3864">https://datatracker.ietf.org/doc/html/rfc3864</a>
   <dt id="biblio-rfc6454">[RFC6454]
   <dd>A. Barth. <a href="https://datatracker.ietf.org/doc/html/rfc6454"><cite>The Web Origin Concept</cite></a>. December 2011. Proposed Standard. URL: <a href="https://datatracker.ietf.org/doc/html/rfc6454">https://datatracker.ietf.org/doc/html/rfc6454</a>
   <dt id="biblio-rfc6797">[RFC6797]
   <dd>J. Hodges; C. Jackson; A. Barth. <a href="https://datatracker.ietf.org/doc/html/rfc6797"><cite>HTTP Strict Transport Security (HSTS)</cite></a>. November 2012. Proposed Standard. URL: <a href="https://datatracker.ietf.org/doc/html/rfc6797">https://datatracker.ietf.org/doc/html/rfc6797</a>
   <dt id="biblio-rfc7231">[RFC7231]
   <dd>R. Fielding, Ed.; J. Reschke, Ed.. <a href="https://httpwg.org/specs/rfc7231.html"><cite>Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content</cite></a>. June 2014. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc7231.html">https://httpwg.org/specs/rfc7231.html</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-workers">[WORKERS]
   <dd>Ian Hickson. <a href="https://www.w3.org/TR/workers/"><cite>Web Workers</cite></a>. 28 January 2021. NOTE. URL: <a href="https://www.w3.org/TR/workers/">https://www.w3.org/TR/workers/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-pkp">[PKP]
   <dd>Chris Evans; Chris Palmer; Ryan Sleevi. <a href="https://tools.ietf.org/html/draft-ietf-websec-key-pinning"><cite>Public Key Pinning Extension for HTTP</cite></a>. Draft. URL: <a href="https://tools.ietf.org/html/draft-ietf-websec-key-pinning">https://tools.ietf.org/html/draft-ietf-websec-key-pinning</a>
   <dt id="biblio-secure-contexts">[SECURE-CONTEXTS]
   <dd>Mike West; Yan Zhu. <a href="https://w3c.github.io/webappsec-secure-contexts/"><cite>Secure Contexts</cite></a>. URL: <a href="https://w3c.github.io/webappsec-secure-contexts/">https://w3c.github.io/webappsec-secure-contexts/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> What’s the impact of reporting? If headers can be injected into <code>appspot.com</code> or <code>newyorktimes.com</code>, can attackers use
    reporting to determine what apps you’re using, or what articles you’re
    reading? Brian <a href="https://lists.w3.org/Archives/Public/public-webappsec/2015Feb/0164.html">has
    explored this space a bit</a>. Perhaps dropping reporting from pinned
    policies would be reasonable. The main use-case I see would be discovering
    pieces of your site that you haven’t covered with a policy (e.g. where did
    the pin decrease attack surface?). It’s not clear we can even do that
    without the implications Brian suggests.<a href="#issue-475ca4fb"> ↵ </a></div>
   <div class="issue"> We probably need a hook in <a data-link-type="biblio" href="#biblio-fetch">[Fetch]</a>. In
  particular, we need to ensure that we detect and pin a policy early enough
  for <code>frame-ancestors</code> and <code>referrer</code> to handle blocking
  and redirects.<a href="#issue-ff5918de"> ↵ </a></div>
   <div class="issue"> Can we assume that subdomains are really owned by the owner of the
  root domain?<a href="#issue-aa0896fd"> ↵ </a></div>
   <div class="issue"> Explain something about the theory; pins act as a baseline for
  resources that don’t otherwise have a policy. Explain layering, granularity,
  etc.<a href="#issue-4273d051"> ↵ </a></div>
  </div>
  <aside class="dfn-panel" data-for="pinned-security-policy">
   <b><a href="#pinned-security-policy">#pinned-security-policy</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-pinned-security-policy">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-pinned-security-policy①">3.3.1. The max-age directive</a>
    <li><a href="#ref-for-pinned-security-policy②">3.3.2. 
        The includeSubDomains directive </a>
    <li><a href="#ref-for-pinned-security-policy③">4. Pinned Policy Processing</a> <a href="#ref-for-pinned-security-policy④">(2)</a>
    <li><a href="#ref-for-pinned-security-policy⑤">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-pinned-security-policy⑥">(2)</a> <a href="#ref-for-pinned-security-policy⑦">(3)</a>
    <li><a href="#ref-for-pinned-security-policy⑧">4.2.2. 
    Remove expired pinned policies from the cache </a>
    <li><a href="#ref-for-pinned-security-policy⑨">6.1. Fingerprinting</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="pinned-policy-cache">
   <b><a href="#pinned-policy-cache">#pinned-policy-cache</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-pinned-policy-cache">4. Pinned Policy Processing</a> <a href="#ref-for-pinned-policy-cache①">(2)</a> <a href="#ref-for-pinned-policy-cache②">(3)</a>
    <li><a href="#ref-for-pinned-policy-cache③">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-pinned-policy-cache④">(2)</a>
    <li><a href="#ref-for-pinned-policy-cache⑤">4.2.1. 
    Get the mode pinned policy for host </a> <a href="#ref-for-pinned-policy-cache⑥">(2)</a> <a href="#ref-for-pinned-policy-cache⑦">(3)</a>
    <li><a href="#ref-for-pinned-policy-cache⑧">4.2.2. 
    Remove expired pinned policies from the cache </a> <a href="#ref-for-pinned-policy-cache⑨">(2)</a> <a href="#ref-for-pinned-policy-cache①⓪">(3)</a>
    <li><a href="#ref-for-pinned-policy-cache①①">6.1. Fingerprinting</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="protected-host">
   <b><a href="#protected-host">#protected-host</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-protected-host">2.1. Terms defined by this specification</a> <a href="#ref-for-protected-host①">(2)</a>
    <li><a href="#ref-for-protected-host②">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-protected-host③">(2)</a>
    <li><a href="#ref-for-protected-host④">4.2.1. 
    Get the mode pinned policy for host </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="subdomains-included">
   <b><a href="#subdomains-included">#subdomains-included</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-subdomains-included">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-subdomains-included①">(2)</a>
    <li><a href="#ref-for-subdomains-included②">4.2.1. 
    Get the mode pinned policy for host </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="policy-expiration-date">
   <b><a href="#policy-expiration-date">#policy-expiration-date</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-policy-expiration-date">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-policy-expiration-date①">(2)</a>
    <li><a href="#ref-for-policy-expiration-date②">4.2.2. 
    Remove expired pinned policies from the cache </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="policy-directive-set">
   <b><a href="#policy-directive-set">#policy-directive-set</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-policy-directive-set">2.1. Terms defined by this specification</a> <a href="#ref-for-policy-directive-set①">(2)</a>
    <li><a href="#ref-for-policy-directive-set②">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-policy-directive-set③">(2)</a>
    <li><a href="#ref-for-policy-directive-set④">4.1.3. 
    Pin a policy to response </a> <a href="#ref-for-policy-directive-set⑤">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="mode">
   <b><a href="#mode">#mode</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-mode">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-mode①">4.1.2. 
    Pin policy for origin in mode </a>
    <li><a href="#ref-for-mode②">4.2.1. 
    Get the mode pinned policy for host </a> <a href="#ref-for-mode③">(2)</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="content-security-policy-pin">
   <b><a href="#content-security-policy-pin">#content-security-policy-pin</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-content-security-policy-pin">1. Introduction</a>
    <li><a href="#ref-for-content-security-policy-pin①">3. Pinned Policy Delivery</a>
    <li><a href="#ref-for-content-security-policy-pin②">3.1. 
      Content-Security-Policy-Pin Header Field </a>
    <li><a href="#ref-for-content-security-policy-pin③">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
    <li><a href="#ref-for-content-security-policy-pin④">3.3.1. The max-age directive</a> <a href="#ref-for-content-security-policy-pin⑤">(2)</a>
    <li><a href="#ref-for-content-security-policy-pin⑥">3.3.2. 
        The includeSubDomains directive </a>
    <li><a href="#ref-for-content-security-policy-pin⑦">4.1.1. 
     Discover pinned policies for response </a>
    <li><a href="#ref-for-content-security-policy-pin⑧">5.1. Hostile Pinning</a>
    <li><a href="#ref-for-content-security-policy-pin⑨">8.1. 
      Content-Security-Policy-Pin </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="content-security-policy-report-only-pin">
   <b><a href="#content-security-policy-report-only-pin">#content-security-policy-report-only-pin</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-content-security-policy-report-only-pin">3. Pinned Policy Delivery</a>
    <li><a href="#ref-for-content-security-policy-report-only-pin①">3.2. 
      Content-Security-Policy-Report-Only-Pin Header Field </a>
    <li><a href="#ref-for-content-security-policy-report-only-pin②">8.2. 
      Content-Security-Policy-Report-Only-Pin </a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="max-age">
   <b><a href="#max-age">#max-age</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-max-age">1.1. Use Cases</a> <a href="#ref-for-max-age①">(2)</a>
    <li><a href="#ref-for-max-age②">3.3. Pinned Policy Syntax</a>
    <li><a href="#ref-for-max-age③">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-max-age④">(2)</a> <a href="#ref-for-max-age⑤">(3)</a> <a href="#ref-for-max-age⑥">(4)</a>
    <li><a href="#ref-for-max-age⑦">5.1. Hostile Pinning</a>
   </ul>
  </aside>
  <aside class="dfn-panel" data-for="includesubdomains">
   <b><a href="#includesubdomains">#includesubdomains</a></b><b>Referenced in:</b>
   <ul>
    <li><a href="#ref-for-includesubdomains">1.1. Use Cases</a> <a href="#ref-for-includesubdomains①">(2)</a>
    <li><a href="#ref-for-includesubdomains②">2.1. Terms defined by this specification</a>
    <li><a href="#ref-for-includesubdomains③">3.3. Pinned Policy Syntax</a>
    <li><a href="#ref-for-includesubdomains④">4.1.2. 
    Pin policy for origin in mode </a> <a href="#ref-for-includesubdomains⑤">(2)</a>
   </ul>
  </aside>
<script>/* script-dfn-panel */

document.body.addEventListener("click", function(e) {
    var queryAll = function(sel) { return [].slice.call(document.querySelectorAll(sel)); }
    // Find the dfn element or panel, if any, that was clicked on.
    var el = e.target;
    var target;
    var hitALink = false;
    while(el.parentElement) {
        if(el.tagName == "A") {
            // Clicking on a link in a <dfn> shouldn't summon the panel
            hitALink = true;
        }
        if(el.classList.contains("dfn-paneled")) {
            target = "dfn";
            break;
        }
        if(el.classList.contains("dfn-panel")) {
            target = "dfn-panel";
            break;
        }
        el = el.parentElement;
    }
    if(target != "dfn-panel") {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(function(el){
            el.classList.remove("on");
            el.classList.remove("activated");
        });
    }
    if(target == "dfn" && !hitALink) {
        // open the panel
        var dfnPanel = document.querySelector(".dfn-panel[data-for='" + el.id + "']");
        if(dfnPanel) {
            dfnPanel.classList.add("on");
            var rect = el.getBoundingClientRect();
            dfnPanel.style.left = window.scrollX + rect.right + 5 + "px";
            dfnPanel.style.top = window.scrollY + rect.top + "px";
            var panelRect = dfnPanel.getBoundingClientRect();
            var panelWidth = panelRect.right - panelRect.left;
            if(panelRect.right > document.body.scrollWidth && (rect.left - (panelWidth + 5)) > 0) {
                // Reposition, because the panel is overflowing
                dfnPanel.style.left = window.scrollX + rect.left - (panelWidth + 5) + "px";
            }
        } else {
            console.log("Couldn't find .dfn-panel[data-for='" + el.id + "']");
        }
    } else if(target == "dfn-panel") {
        // Switch it to "activated" state, which pins it.
        el.classList.add("activated");
        el.style.left = null;
        el.style.top = null;
    }

});
</script>