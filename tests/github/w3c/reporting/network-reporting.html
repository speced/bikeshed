<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Network Reporting API</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <link href="https://w3c.github.io/reporting/network-reporting" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1>Network Reporting API</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/reporting/network-reporting">https://w3c.github.io/reporting/network-reporting</a>
      <dt>Version History:
      <dd><a href="https://github.com/w3c/reporting/commits/master/index.src.html">https://github.com/w3c/reporting/commits/master/index.src.html</a>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard" data-editor-id="103120"><a class="p-name fn u-email email" href="mailto:dcreager@dcreager.net">Douglas Creager</a> (<span class="p-org org">GitHub</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="76841"><a class="p-name fn u-email email" href="mailto:iclelland@google.com">Ian Clelland</a> (<span class="p-org org">Google Inc.</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="56384"><a class="p-name fn u-email email" href="mailto:mkwst@google.com">Mike West</a> (<span class="p-org org">Google Inc.</span>)
      <dt class="editor">Former Editors:
      <dd class="editor p-author h-card vcard" data-editor-id="56102"><a class="p-name fn u-email email" href="mailto:igrigorik@google.com">Ilya Grigorik</a> (<span class="p-org org">Google Inc.</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="99916"><a class="p-name fn u-email email" href="mailto:paulmeyer@google.com">Paul Meyer</a> (<span class="p-org org">Google Inc.</span>)
      <dt>Participate:
      <dd><a href="https://github.com/w3c/reporting/issues/new">File an issue</a> (<a href="https://github.com/w3c/reporting/issues">open issues</a>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This document extends the generic reporting framework from the Reporting API
with a mechanisms for web developers to associate groups of reporting
endpoints with origins they control, and defines how reports can reliably be
sent to those endpoints, in order to be able to report on network conditions,
or other concerns which exceed the scope of a single document, in a consistent
manner.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p><a href="https://github.com/test/test/issues">GitHub Issues</a> are preferred for discussion of this specification. </p>
   <p>This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#guarantees"><span class="secno">1.1</span> <span class="content">Guarantees</span></a>
      <li><a href="#examples"><span class="secno">1.2</span> <span class="content">Examples</span></a>
     </ol>
    <li>
     <a href="#concept"><span class="secno">2</span> <span class="content">Concepts</span></a>
     <ol class="toc">
      <li><a href="#concept-endpoint-groups"><span class="secno">2.1</span> <span class="content">Endpoint groups</span></a>
      <li><a href="#concept-network-endpoint"><span class="secno">2.2</span> <span class="content">Network reporting endpoints</span></a>
      <li><a href="#concept-client"><span class="secno">2.3</span> <span class="content">Clients</span></a>
      <li><a href="#concept-failover-load-balancing"><span class="secno">2.4</span> <span class="content">Failover and load balancing</span></a>
      <li><a href="#concept-storage"><span class="secno">2.5</span> <span class="content">Storage</span></a>
     </ol>
    <li>
     <a href="#endpoint-delivery"><span class="secno">3</span> <span class="content">Endpoint Delivery</span></a>
     <ol class="toc">
      <li>
       <a href="#network_reporting_endpoints-policy-item"><span class="secno">3.1</span> <span class="content">The
  "network_reporting_endpoints" policy item</span></a>
       <ol class="toc">
        <li><a href="#id-member"><span class="secno">3.1.1</span> <span class="content">The <code>group</code> member</span></a>
        <li><a href="#include-subdomains-member"><span class="secno">3.1.2</span> <span class="content">The <code>include_subdomains</code> member</span></a>
        <li><a href="#max-age-member"><span class="secno">3.1.3</span> <span class="content">The <code>max_age</code> member</span></a>
        <li><a href="#endpoints-member"><span class="secno">3.1.4</span> <span class="content">The <code>endpoints</code> member</span></a>
        <li><a href="#endpoints-url-member"><span class="secno">3.1.5</span> <span class="content">The <code>endpoints.url</code> member</span></a>
        <li><a href="#endpoints-priority-member"><span class="secno">3.1.6</span> <span class="content">The <code>endpoints.priority</code> member</span></a>
        <li><a href="#endpoints-weight-member"><span class="secno">3.1.7</span> <span class="content">The <code>endpoints.weight</code> member</span></a>
       </ol>
      <li><a href="#process-configuration"><span class="secno">3.2</span> <span class="content"> Process origin policy configuration </span></a>
     </ol>
    <li><a href="#report-generation"><span class="secno">4</span> <span class="content">Report Generation</span></a>
    <li>
     <a href="#report-delivery"><span class="secno">5</span> <span class="content">Report Delivery</span></a>
     <ol class="toc">
      <li><a href="#choose-endpoint"><span class="secno">5.1</span> <span class="content"> Choose an <var>endpoint</var> from a <var>group</var> </span></a>
      <li><a href="#send-reports"><span class="secno">5.2</span> <span class="content"> Send reports </span></a>
     </ol>
    <li>
     <a href="#implementation"><span class="secno">6</span> <span class="content">Implementation Considerations</span></a>
     <ol class="toc">
      <li><a href="#delivery"><span class="secno">6.1</span> <span class="content">Delivery</span></a>
      <li><a href="#gc"><span class="secno">6.2</span> <span class="content">Garbage Collection</span></a>
     </ol>
    <li><a href="#sample-reports"><span class="secno">7</span> <span class="content">Sample Reports</span></a>
    <li>
     <a href="#security"><span class="secno">8</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#capability-urls"><span class="secno">8.1</span> <span class="content">Capability URLs</span></a>
     </ol>
    <li>
     <a href="#privacy"><span class="secno">9</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#network-leakage"><span class="secno">9.1</span> <span class="content">Network Leakage</span></a>
      <li><a href="#fingerprinting-clock-skew"><span class="secno">9.2</span> <span class="content">Clock Skew</span></a>
      <li><a href="#correlation"><span class="secno">9.3</span> <span class="content">Cross-origin correlation</span></a>
      <li><a href="#subdomains"><span class="secno">9.4</span> <span class="content">Subdomains</span></a>
      <li><a href="#clear-cache"><span class="secno">9.5</span> <span class="content">Clearing the reporting cache</span></a>
      <li><a href="#disable"><span class="secno">9.6</span> <span class="content">Disabling Reporting</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p>This document extends the concepts defined in <a data-link-type="biblio" href="#biblio-reporting" title="Reporting API">[REPORTING]</a> to enable a class
  of reports which are not tied to the lifetime of any particular document. This
  enables network errors to be reported on, even (or especially) in cases where
  a document could not be loaded.</p>
    <p>Decoupling reports from documents implies two major differences from the
  document-centred reporting defined in <a data-link-type="biblio" href="#biblio-reporting" title="Reporting API">[REPORTING]</a>: First, configuration of
  reporting must be done at the origin level, rather than through document
  response headers. Second, the reports are queued and delivered by the user
  agent separately from document reports.</p>
    <h3 class="heading settled" data-level="1.1" id="guarantees"><span class="secno">1.1. </span><span class="content">Guarantees</span><a class="self-link" href="#guarantees"></a></h3>
    <p>This specification aims to provide a best-effort report delivery system that
  executes out-of-band with website activity. The user agent will be able to do
  a better job prioritizing and scheduling delivery of reports, as it has an
  overview of cross-origin activity that individual websites do not, and can
  deliver reports based on error conditions that would prevent a website from
  loading in the first place.</p>
    <p>The delivery is not, however, guaranteed in a strict sense. We spell out a
  reasonable set of retry rules in the algorithms below, but it’s quite possible
  for a report to be dropped on the floor if things go badly.</p>
    <p>Reporting can generate a good deal of traffic, so we allow developers to set
  up groups of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint">endpoints</a>, using a failover and
  load-balancing mechanism inspired by the DNS <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc2782#" id="ref-for-something">SRV record</a>.  The user
  agent will do its best to deliver a particular report to <strong>at most
  one</strong> endpoint in a group.  Endpoints can be assigned weights to
  distribute load, with each endpoint receiving a specified fraction of
  reporting traffic.  Endpoints can be assigned priorities, allowing developers
  to set up fallback collectors that are only tried when uploads to primary
  collectors fail.</p>
    <h3 class="heading settled" data-level="1.2" id="examples"><span class="secno">1.2. </span><span class="content">Examples</span><a class="self-link" href="#examples"></a></h3>
    <div class="example" id="example-8bf94a09">
     <a class="self-link" href="#example-8bf94a09"></a> MegaCorp Inc. wants to collect Network Error Log reports for its site.
    It can do so by serving an origin policy manifest with the following key,
    to define a set of reporting endpoints named "<code>endpoint-1</code>": 
<pre>{
"<a data-link-type="dfn" href="#network_reporting_endpoints" id="ref-for-network_reporting_endpoints">network_reporting_endpoints</a>": {
  "<a data-link-type="dfn" href="#network_reporting_endpoints-group" id="ref-for-network_reporting_endpoints-group">group</a>": "endpoint-1",
  "<a data-link-type="dfn" href="#network_reporting_endpoints-max_age" id="ref-for-network_reporting_endpoints-max_age">max_age</a>": 10886400,
  "<a data-link-type="dfn" href="#network_reporting_endpoints-endpoints" id="ref-for-network_reporting_endpoints-endpoints">endpoints</a>": [
    { "<a data-link-type="dfn" href="#network_reporting_endpoints-url" id="ref-for-network_reporting_endpoints-url">url</a>": "https://example.com/reports", "<a data-link-type="dfn" href="#network_reporting_endpoints-priority" id="ref-for-network_reporting_endpoints-priority">priority</a>": 1 },
    { "<a data-link-type="dfn" href="#network_reporting_endpoints-url" id="ref-for-network_reporting_endpoints-url①">url</a>": "https://backup.com/reports", "<a data-link-type="dfn" href="#network_reporting_endpoints-priority" id="ref-for-network_reporting_endpoints-priority①">priority</a>": 2 }
  ] }
}
</pre>
     <p>And the following headers, which direct NEL reports to that group:</p>
<pre>NEL: { ..., "<a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#directives-reporting" id="ref-for-directives-reporting">report-to</a>": "endpoint-1" }
</pre>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="concept"><span class="secno">2. </span><span class="content">Concepts</span><a class="self-link" href="#concept"></a></h2>
    <h3 class="heading settled" data-level="2.1" id="concept-endpoint-groups"><span class="secno">2.1. </span><span class="content">Endpoint groups</span><a class="self-link" href="#concept-endpoint-groups"></a></h3>
    <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="endpoint-group">endpoint group</dfn> is a set of <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint">network reporting endpoints</a> that will
  be used together for backup and failover purposes.</p>
    <p>Each <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group">endpoint group</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="endpoint group" data-dfn-type="attribute" data-export id="dom-endpoint-group-name"><code>name</code></dfn>, which is an ASCII
  string.</p>
    <p>Each <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①">endpoint group</a> has an <dfn class="dfn-paneled idl-code" data-dfn-for="endpoint group" data-dfn-type="attribute" data-export id="dom-endpoint-group-endpoints"><code>endpoints</code></dfn> list, which is a list of <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint①">network reporting endpoints</a>.</p>
    <p>Each <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②">endpoint group</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="endpoint group" data-dfn-type="attribute" data-export id="dom-endpoint-group-subdomains"><code>subdomains</code></dfn> flag, which is either "<code>include</code>" or
  "<code>exclude</code>".</p>
    <p>Each <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group③">endpoint group</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="endpoint group" data-dfn-type="attribute" data-export id="dom-endpoint-group-ttl"><code>ttl</code></dfn> representing the number of seconds the group
  remains valid for an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin">origin</a>.</p>
    <p>Each <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group④">endpoint group</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="endpoint group" data-dfn-type="attribute" data-export id="dom-endpoint-group-creation"><code>creation</code></dfn> which is the timestamp at which the group was
  added to an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin①">origin</a>.</p>
    <p>A <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group⑤">endpoint group</a> is <dfn class="dfn-paneled" data-dfn-for="endpoint group" data-dfn-type="dfn" data-noexport id="endpoint-group-expired">expired</dfn> if its <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-creation" id="ref-for-dom-endpoint-group-creation">creation</a></code> plus its <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-ttl" id="ref-for-dom-endpoint-group-ttl">ttl</a></code> represents a time in the past.</p>
    <h3 class="heading settled" data-level="2.2" id="concept-network-endpoint"><span class="secno">2.2. </span><span class="content">Network reporting endpoints</span><a class="self-link" href="#concept-network-endpoint"></a></h3>
    <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="network-reporting-endpoint">network reporting endpoint</dfn> is an <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint①">endpoint</a>, which
  is extended with these additional attributes:</p>
    <p>Each <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint②">network reporting endpoint</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="network reporting endpoint" data-dfn-type="attribute" data-export id="dom-network-reporting-endpoint-priority"><code>priority</code></dfn>, which is a
  non-negative integer.</p>
    <p>Each <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint③">network reporting endpoint</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="network reporting endpoint" data-dfn-type="attribute" data-export id="dom-network-reporting-endpoint-weight"><code>weight</code></dfn>, which is a
  non-negative integer.</p>
    <p>Each <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint④">network reporting endpoint</a> has a <dfn class="dfn-paneled idl-code" data-dfn-for="network reporting endpoint" data-dfn-type="attribute" data-export id="dom-network-reporting-endpoint-retry_after"><code>retry_after</code></dfn>, which is
  either <code>null</code>, or a timestamp after which delivery should be retried.</p>
    <p>An <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint⑤">network reporting endpoint</a> is <dfn class="dfn-paneled" data-dfn-for="network reporting endpoint" data-dfn-type="dfn" data-noexport id="network-reporting-endpoint-pending">pending</dfn> if its <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-retry_after" id="ref-for-dom-network-reporting-endpoint-retry_after">retry_after</a></code> is not <code>null</code>, and represents a
  time in the future.</p>
    <h3 class="heading settled" data-level="2.3" id="concept-client"><span class="secno">2.3. </span><span class="content">Clients</span><a class="self-link" href="#concept-client"></a></h3>
    <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="client">client</dfn> represents a particular origin’s relationship to
  a set of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint②">endpoints</a>.</p>
    <p>Each <a data-link-type="dfn" href="#client" id="ref-for-client">client</a> has an <dfn class="dfn-paneled idl-code" data-dfn-for="client" data-dfn-type="attribute" data-export id="dom-client-origin"><code>origin</code></dfn>,
  which is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin②">origin</a>.</p>
    <p>Each <a data-link-type="dfn" href="#client" id="ref-for-client①">client</a> has an <dfn class="dfn-paneled idl-code" data-dfn-for="client" data-dfn-type="attribute" data-export id="dom-client-endpoint-groups"><code>endpoint-groups</code></dfn> list, which is a list of <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group⑥">endpoint
  groups</a>, each of which MUST have a distinct <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name">name</a></code>.
  (The algorithm in <a href="#process-configuration">§ 3.2 Process origin policy configuration</a> guarantees this by keeping only
  the first entry in the configuration member with a particular name.)</p>
    <h3 class="heading settled" data-level="2.4" id="concept-failover-load-balancing"><span class="secno">2.4. </span><span class="content">Failover and load balancing</span><a class="self-link" href="#concept-failover-load-balancing"></a></h3>
    <p>The <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint⑥">network reporting endpoints</a> in an <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group⑦">endpoint group</a> that all
  have the same <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority">priority</a></code> form a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="failover-class">failover class</dfn>. <a data-link-type="dfn" href="#failover-class" id="ref-for-failover-class">Failover classes</a> allow the developer to
  provide backup collectors (those with higher <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority①">priority</a></code> values) that will only receive reports
  if <strong>all</strong> of the primary collectors (those with lower <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority②">priority</a></code> values) fail.</p>
    <p>Developers can assign each <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint⑦">network reporting endpoint</a> in a <a data-link-type="dfn" href="#failover-class" id="ref-for-failover-class①">failover
  class</a> a <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight">weight</a></code>, which determines how report
  traffic is balanced across the <a data-link-type="dfn" href="#failover-class" id="ref-for-failover-class②">failover class</a>.</p>
    <p>The algorithm that implements these rules is described in <a href="#choose-endpoint">§ 5.1 Choose an endpoint from a group</a>.</p>
    <p class="note" role="note"><span class="marker">Note:</span> The <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority③">priority</a></code> and <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight①">weight</a></code> fields have the same semantics as the
  corresponding fields in a DNS <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc2782#" id="ref-for-something①">SRV record</a>.</p>
    <p class="note" role="note"><span class="marker">Note:</span> Failover and load balancing is a feature that would be generally useful
  outside of Reporting.  Reporting delegates to the <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> API to actually
  upload reports once an endpoint has been selected.  If, in the future, the
  Fetch API adds native support for failover and load balancing of requests, a
  future version of this specification will be updated to use it instead of this
  bespoke mechanism.</p>
    <h3 class="heading settled" data-level="2.5" id="concept-storage"><span class="secno">2.5. </span><span class="content">Storage</span><a class="self-link" href="#concept-storage"></a></h3>
    <p>A conformant user agent MUST provide a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="reporting-cache">reporting cache</dfn>, which
  is a storage mechanism that maintains a set of <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group⑧">endpoint groups</a> that websites have instructed the user agent to associate with their <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin③">origins</a>, and a set of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports">reports</a> which are queued for
  delivery.</p>
    <p>This storage mechanism is opaque, vendor-specific, and not exposed to the
  web, but it MUST provide the following methods which will be used in the
  algorithms this document defines:</p>
    <ol>
     <li data-md>
      <p>Insert, update, and remove <a data-link-type="dfn" href="#client" id="ref-for-client②">clients</a>.</p>
     <li data-md>
      <p>Enqueue and dequeue <a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports①">reports</a> for delivery.</p>
     <li data-md>
      <p>Retrieve a list of <a data-link-type="dfn" href="#client" id="ref-for-client③">client</a> objects for an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin④">origin</a>.</p>
     <li data-md>
      <p>Retrieve a list of queued <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report">report</a> objects.</p>
     <li data-md>
      <p>Clear the cache.</p>
    </ol>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="endpoint-delivery"><span class="secno">3. </span><span class="content">Endpoint Delivery</span><a class="self-link" href="#endpoint-delivery"></a></h2>
    <p>A server MAY define a set of <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group⑨">endpoint groups</a> for an origin it controls
  through an <a data-link-type="dfn" href="https://wicg.github.io/origin-policy/#origin-policy-manifest" id="ref-for-origin-policy-manifest">origin policy manifest</a> <a data-link-type="biblio" href="#biblio-origin-policy" title="Origin Policy">[ORIGIN-POLICY]</a>.</p>
    <p><a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⓪">Endpoint groups</a> are specified with the <code>"network_reporting_endpoints"</code> member, which defines the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①①">endpoint groups</a> to be associated with that
  origin.</p>
    <p>This member is defined in <a href="#network_reporting_endpoints-policy-item">§ 3.1 The
  "network_reporting_endpoints" policy item</a>, and
  its processing in <a href="#process-configuration">§ 3.2 Process origin policy configuration</a>.</p>
    <h3 class="heading settled" data-level="3.1" id="network_reporting_endpoints-policy-item"><span class="secno">3.1. </span><span class="content">The
  "network_reporting_endpoints" policy item</span><a class="self-link" href="#network_reporting_endpoints-policy-item"></a></h3>
    <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints"><code>network_reporting_endpoints</code></dfn> member defines the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①②">endpoint
  groups</a> to be associated with the origin.</p>
    <p>If present, the member must be an array of objects.</p>
    <p>Each object in the array defines a <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①③">endpoint group</a> to which
  reports may be delivered, and will be parsed as defined in <a href="#process-configuration">§ 3.2 Process origin policy configuration</a>.</p>
    <p>The following subsections define the set of known members which may be
  specified for each object in the array.  Future versions of this document may
  define additional such members, and user agents MUST ignore unknown members
  when parsing the configuration.</p>
    <h4 class="heading settled" data-level="3.1.1" id="id-member"><span class="secno">3.1.1. </span><span class="content">The <code>group</code> member</span><a class="self-link" href="#id-member"></a></h4>
    <p>The OPTIONAL <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints-group"><code>group</code></dfn> member is a
  string that associates a <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name①">name</a></code> with the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①④">endpoint
  group</a>.</p>
    <p>If present, the member’s value MUST be a string. If not present, the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⑤">endpoint group</a> will be given the <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name②">name</a></code> "<code>default</code>".</p>
    <h4 class="heading settled" data-level="3.1.2" id="include-subdomains-member"><span class="secno">3.1.2. </span><span class="content">The <code>include_subdomains</code> member</span><a class="self-link" href="#include-subdomains-member"></a></h4>
    <p>The OPTIONAL <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints-include_subdomains"><code>include_subdomains</code></dfn> member is a boolean that enables this <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⑥">endpoint group</a> for all
  subdomains of the current <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin⑤">origin</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host">host</a>.</p>
    <h4 class="heading settled" data-level="3.1.3" id="max-age-member"><span class="secno">3.1.3. </span><span class="content">The <code>max_age</code> member</span><a class="self-link" href="#max-age-member"></a></h4>
    <p>The REQUIRED <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-export id="network_reporting_endpoints-max_age"><code>max_age</code></dfn> member defines the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⑦">endpoint group</a>’s lifetime, as a non-negative
  integer number of seconds.</p>
    <p>The member’s value MUST be a non-negative number.</p>
    <p>A value of "<code>0</code>" will cause the <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⑧">endpoint group</a> to be removed
  from the user agent’s <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache">reporting cache</a>.</p>
    <h4 class="heading settled" data-level="3.1.4" id="endpoints-member"><span class="secno">3.1.4. </span><span class="content">The <code>endpoints</code> member</span><a class="self-link" href="#endpoints-member"></a></h4>
    <p>The REQUIRED <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-export id="network_reporting_endpoints-endpoints"><code>endpoints</code></dfn> member defines the list of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint③">endpoints</a> that
  belong to this <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group①⑨">endpoint group</a>.</p>
    <p>The member’s value MUST be an array of JSON objects.</p>
    <p>The following subsections define the initial set of known members in each
  JSON object in the array. Future versions of this document may define
  additional such members, and user agents MUST ignore unknown members when
  parsing the elements of the array.</p>
    <h4 class="heading settled" data-level="3.1.5" id="endpoints-url-member"><span class="secno">3.1.5. </span><span class="content">The <code>endpoints.url</code> member</span><a class="self-link" href="#endpoints-url-member"></a></h4>
    <p>The REQUIRED <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints-url"><code>url</code></dfn> member is a
  string that defines the location of the <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint④">endpoint</a>.</p>
    <p>The member’s value MUST be a string. Moreover, the URL that the member’s value
  represents MUST be <a data-link-type="dfn" href="https://w3c.github.io/webappsec-secure-contexts/#is-origin-trustworthy" id="ref-for-is-origin-trustworthy">potentially trustworthy</a> <a data-link-type="biblio" href="#biblio-secure-contexts" title="Secure Contexts">[SECURE-CONTEXTS]</a>.
  Non-secure endpoints will be ignored.</p>
    <h4 class="heading settled" data-level="3.1.6" id="endpoints-priority-member"><span class="secno">3.1.6. </span><span class="content">The <code>endpoints.priority</code> member</span><a class="self-link" href="#endpoints-priority-member"></a></h4>
    <p>The OPTIONAL <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints-priority"><code>priority</code></dfn> member is
  a number that defines which failover class the <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint⑤">endpoint</a> belongs
  to.</p>
    <p>The member’s value, if present, MUST be a non-negative integer.</p>
    <h4 class="heading settled" data-level="3.1.7" id="endpoints-weight-member"><span class="secno">3.1.7. </span><span class="content">The <code>endpoints.weight</code> member</span><a class="self-link" href="#endpoints-weight-member"></a></h4>
    <p>The OPTIONAL <dfn class="dfn-paneled" data-dfn-for="network_reporting_endpoints" data-dfn-type="dfn" data-noexport id="network_reporting_endpoints-weight"><code>weight</code></dfn> member is a
  number that defines load balancing for the failover class that the <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint⑥">endpoint</a> belongs to.</p>
    <p>The member’s value, if present, MUST be a non-negative integer.</p>
    <h3 class="heading settled algorithm" data-algorithm="Process origin policy configuration" data-level="3.2" id="process-configuration"><span class="secno">3.2. </span><span class="content"> Process origin policy configuration </span><a class="self-link" href="#process-configuration"></a></h3>
    <p>Given a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">map</a> (<var>parsed</var>), and an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin⑥">origin</a> (<var>origin</var>),
  this algorithm extracts a list of <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint⑧">network reporting endpoints</a> and <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②⓪">endpoint groups</a> for <var>origin</var>, and updates the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache①">reporting
  cache</a> accordingly.</p>
    <p class="note" role="note"><span class="marker">Note:</span> This algorithm is called from around step 9 of <a href="https://wicg.github.io/origin-policy/#parse-a-string-into-an-origin-policy">Origin Policy § parse-a-string-into-an-origin-policy</a>, and only updates the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache②">reporting cache</a> if the <var>response</var> has been delivered securely.</p>
    <p class="issue" id="issue-0c90253d"><a class="self-link" href="#issue-0c90253d"></a> Origin Policy monkey patching. Talk to Domenic.</p>
    <ol>
     <li data-md>
      <p>Let <var>groups</var> be an empty list.</p>
     <li data-md>
      <p>If <var>parsed</var>["network_reporting_endpoints"] exists and is a list, then for
  each <var>item</var> in <var>parsed</var>["network_reporting_endpoints"]:</p>
      <ol>
       <li data-md>
        <p>If <var>item</var> has no member named "<a data-link-type="dfn" href="#network_reporting_endpoints-max_age" id="ref-for-network_reporting_endpoints-max_age①"><code>max_age</code></a>", or that member’s
  value is not a number, skip to the next <var>item</var>.</p>
       <li data-md>
        <p>If <var>item</var> has no member named "<a data-link-type="dfn" href="#network_reporting_endpoints-endpoints" id="ref-for-network_reporting_endpoints-endpoints①"><code>endpoints</code></a>", or that member’s
  value is not an array, skip to the next <var>item</var>.</p>
       <li data-md>
        <p>Let <var>name</var> be <var>item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-group" id="ref-for-network_reporting_endpoints-group①"><code>group</code></a>" member’s value if
  present, and "<code>default</code>" otherwise.</p>
       <li data-md>
        <p>If there is already a <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②①">endpoint group</a> in <var>groups</var> whose <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name③">name</a></code> is <var>name</var>, skip to the next <var>item</var>.</p>
       <li data-md>
        <p>Let <var>endpoints</var> be an empty list.</p>
       <li data-md>
        <p>For each <var>endpoint item</var> in the value of <var>item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-endpoints" id="ref-for-network_reporting_endpoints-endpoints②"><code>endpoints</code></a>" member:</p>
        <ol>
         <li data-md>
          <p>If <var>endpoint item</var> has no member named "<a data-link-type="dfn" href="#network_reporting_endpoints-url" id="ref-for-network_reporting_endpoints-url②"><code>url</code></a>", or that member’s
  value is not a string, or if that value is not an <a data-link-type="dfn" href="https://url.spec.whatwg.org/#absolute-url-string" id="ref-for-absolute-url-string">absolute-URL string</a> or a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#path-absolute-url-string" id="ref-for-path-absolute-url-string">path-absolute-URL string</a>,
  skip to the next <var>endpoint item</var>.</p>
         <li data-md>
          <p>Let <var>endpoint url</var> be the result of executing the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser">URL
  parser</a> on <var>endpoint item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-url" id="ref-for-network_reporting_endpoints-url③"><code>url</code></a>" member’s value, with <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-base-url" id="ref-for-concept-base-url">base URL</a> set to <var>response</var>’s <a class="idl-code" data-link-type="attribute" href="https://fetch.spec.whatwg.org/#concept-response-url" id="ref-for-concept-response-url">url</a>. If <var>endpoint url</var> is failure, skip to the next <var>endpoint item</var>.</p>
         <li data-md>
          <p>If <var>endpoint item</var> has a member named "<a data-link-type="dfn" href="#network_reporting_endpoints-priority" id="ref-for-network_reporting_endpoints-priority②"><code>priority</code></a>", whose value is
  not a non-negative integer, skip to the next <var>endpoint item</var>.</p>
         <li data-md>
          <p>If <var>endpoint item</var> has a member named "<a data-link-type="dfn" href="#network_reporting_endpoints-weight" id="ref-for-network_reporting_endpoints-weight"><code>weight</code></a>", whose value is
  not a non-negative integer, skip to the next <var>endpoint item</var>.</p>
         <li data-md>
          <p>Let <var>endpoint</var> be a new <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint⑨">network reporting endpoint</a> whose
  properties are set as follows:</p>
          <dl>
           <dt data-md><code class="idl"><a data-link-type="idl" href="https://w3c.github.io/reporting/#dom-endpoint-name" id="ref-for-dom-endpoint-name">name</a></code>
           <dd data-md>
            <p><code>null</code></p>
           <dt data-md><code class="idl"><a data-link-type="idl" href="https://w3c.github.io/reporting/#dom-endpoint-url" id="ref-for-dom-endpoint-url">url</a></code>
           <dd data-md>
            <p><var>endpoint url</var></p>
           <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority④">priority</a></code>
           <dd data-md>
            <p>The value of the <var>endpoint item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-priority" id="ref-for-network_reporting_endpoints-priority③"><code>priority</code></a>" member, if
  present; <code>1</code> otherwise.</p>
           <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight②">weight</a></code>
           <dd data-md>
            <p>The value of the <var>endpoint item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-weight" id="ref-for-network_reporting_endpoints-weight①"><code>weight</code></a>" member, if
  present; <code>1</code> otherwise.</p>
           <dt data-md><code class="idl"><a data-link-type="idl" href="https://w3c.github.io/reporting/#dom-endpoint-failures" id="ref-for-dom-endpoint-failures">failures</a></code>
           <dd data-md>
            <p>0</p>
           <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-retry_after" id="ref-for-dom-network-reporting-endpoint-retry_after①">retry_after</a></code>
           <dd data-md>
            <p><code>null</code></p>
          </dl>
         <li data-md>
          <p>Add <var>endpoint</var> to <var>endpoints</var>.</p>
        </ol>
       <li data-md>
        <p>Let <var>group</var> be a new <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②②">endpoint group</a> whose properties
  are set as follows:</p>
        <dl>
         <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name④">name</a></code>
         <dd data-md>
          <p><var>name</var></p>
         <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-subdomains" id="ref-for-dom-endpoint-group-subdomains">subdomains</a></code>
         <dd data-md>
          <p>"<code>include</code>" if <var>item</var> has a member named "<a data-link-type="dfn" href="#network_reporting_endpoints-include_subdomains" id="ref-for-network_reporting_endpoints-include_subdomains"><code>include_subdomains</code></a>" whose
  value is <code>true</code>, "<code>exclude</code>" otherwise.</p>
         <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-ttl" id="ref-for-dom-endpoint-group-ttl①">ttl</a></code>
         <dd data-md>
          <p><var>item</var>’s "<a data-link-type="dfn" href="#network_reporting_endpoints-max_age" id="ref-for-network_reporting_endpoints-max_age②"><code>max_age</code></a>"
  member’s value.</p>
         <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-creation" id="ref-for-dom-endpoint-group-creation①">creation</a></code>
         <dd data-md>
          <p>The current timestamp</p>
         <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-endpoints" id="ref-for-dom-endpoint-group-endpoints">endpoints</a></code>
         <dd data-md>
          <p><var>endpoints</var></p>
        </dl>
       <li data-md>
        <p>Add <var>group</var> to <var>groups</var>.</p>
      </ol>
     <li data-md>
      <p>Let <var>client</var> be a new <a data-link-type="dfn" href="#client" id="ref-for-client④">client</a> whose properties are set as follows:</p>
      <dl>
       <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-client-origin" id="ref-for-dom-client-origin">origin</a></code>
       <dd data-md>
        <p><var>origin</var></p>
       <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-client-endpoint-groups" id="ref-for-dom-client-endpoint-groups">endpoint-groups</a></code>
       <dd data-md>
        <p><var>groups</var></p>
      </dl>
     <li data-md>
      <p>If there is already an entry in the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache③">reporting cache</a> for <var>origin</var>,
  replace it with <var>client</var>.  Otherwise, insert <var>client</var> into the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache④">reporting cache</a> for <var>origin</var>.</p>
    </ol>
    <section>
     <h2 class="heading settled" data-level="4" id="report-generation"><span class="secno">4. </span><span class="content">Report Generation</span><a class="self-link" href="#report-generation"></a></h2>
     <p>Network reports can be generated with or without an active document. If a
  document is present, and can be considered the source of the report, then the
  report generated may be visible to reporting observers in that document.</p>
     <p>When a user agent is to <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="generate-a-network-report">generate a network report</dfn>, given a
  string (<var>type</var>), another string (<var>endpoint group</var>), a serializable object
  (<var>data</var>), and an optional <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">Document</a> (<var>document</var>), it must run the
  following steps:</p>
     <ol>
      <li data-md>
       <p>If <var>document</var> is given, then</p>
       <ol>
        <li data-md>
         <p>Let <var>settings</var> be <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a>.</p>
        <li data-md>
         <p>Let <var>report</var> be the result of running <a href="https://w3c.github.io/reporting/#queue-report"><cite>Reporting API</cite> § 2.3 Queue data as type for destination</a> with <var>data</var>, <var>type</var>, <var>endpoint group</var> and <var>settings</var>.</p>
       </ol>
      <li data-md>
       <p>Otherwise, let <var>report</var> be the result of running <a href="https://w3c.github.io/reporting/#queue-report"><cite>Reporting API</cite> § 2.3 Queue data as type for destination</a> with <var>data</var>, <var>type</var>, and <var>endpoint group</var>.</p>
      <li data-md>
       <p>Append <var>report</var> to the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache⑤">reporting cache</a>.</p>
     </ol>
     <h2 class="heading settled" data-level="5" id="report-delivery"><span class="secno">5. </span><span class="content">Report Delivery</span><a class="self-link" href="#report-delivery"></a></h2>
     <p>Over time, various features will queue up a list of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports②">reports</a> in the
  user agent’s <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache⑥">reporting cache</a>. The user agent will periodically grab
  the list of currently pending reports, and deliver them to the associated
  endpoints. This document does not define a schedule for the user agent to
  follow, and assumes that the user agent will have enough contextual
  information to deliver reports in a timely manner, balanced against impacting
  a user’s experience.</p>
     <p>That said, a user agent SHOULD make an effort to deliver reports as soon as
  possible after queuing, as a report’s data might be significantly more useful
  in the period directly after its generation than it would be a day or a week
  later.</p>
     <h3 class="heading settled" data-level="5.1" id="choose-endpoint"><span class="secno">5.1. </span><span class="content"> Choose an <var>endpoint</var> from a <var>group</var> </span><a class="self-link" href="#choose-endpoint"></a></h3>
     <p class="note" role="note"><span class="marker">Note:</span> This algorithm is the same as the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc2782#page-4" id="ref-for-page-4">target selection
    algorithm</a> used for DNS <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc2782#" id="ref-for-something②">SRV records</a>.</p>
     <p>Given an <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②③">endpoint group</a> (<var>group</var>), this algorithm chooses an arbitrary
  eligible <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint⑦">endpoint</a> from the group, if there is one, taking into
  account the <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority⑤">priority</a></code> and <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight③">weight</a></code> of the <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint⑧">endpoints</a>.</p>
     <ol>
      <li data-md>
       <p>Let <var>endpoints</var> be a copy of <var>group</var>’s <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-endpoints" id="ref-for-dom-endpoint-group-endpoints①">endpoints</a></code> list.</p>
      <li data-md>
       <p>Remove every <var>endpoint</var> from <var>endpoints</var> that is <a data-link-type="dfn" href="#network-reporting-endpoint-pending" id="ref-for-network-reporting-endpoint-pending">pending</a>.</p>
      <li data-md>
       <p>If <var>endpoints</var> is empty, return <code>null</code>.</p>
      <li data-md>
       <p>Let <var>priority</var> be the minimum <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority⑥">priority</a></code> value of each <var>endpoint</var> in <var>endpoints</var>.</p>
      <li data-md>
       <p>Remove every <var>endpoint</var> from <var>endpoints</var> whose <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-priority" id="ref-for-dom-network-reporting-endpoint-priority⑦">priority</a></code> value is not equal to <var>priority</var>.</p>
      <li data-md>
       <p>If <var>endpoints</var> is empty, return <code>null</code>.</p>
      <li data-md>
       <p>Let <var>total weight</var> be the sum of the <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight④">weight</a></code> value of each <var>endpoint</var> in <var>endpoints</var>.</p>
      <li data-md>
       <p>Let <var>weight</var> be a random number ≥ 0 and ≤ <var>total weight</var>.</p>
      <li data-md>
       <p>For each <var>endpoint</var> in <var>endpoints</var>:</p>
       <ol>
        <li data-md>
         <p>If <var>weight</var> is less than or equal to <var>endpoint</var>’s <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight⑤">weight</a></code>, return <var>endpoint</var>.</p>
        <li data-md>
         <p>Subtract <var>endpoint</var>’s <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-weight" id="ref-for-dom-network-reporting-endpoint-weight⑥">weight</a></code> from <var>weight</var>.</p>
       </ol>
      <li data-md>
       <p>It should not be possible to fall through to here, since the random number
  chosen earlier will be less than or equal to <var>total weight</var>.</p>
     </ol>
     <h3 class="heading settled algorithm" data-algorithm="Send reports" data-level="5.2" id="send-reports"><span class="secno">5.2. </span><span class="content"> Send reports </span><a class="self-link" href="#send-reports"></a></h3>
     <p>A user agent sends reports by executing the following steps:</p>
     <ol>
      <li data-md>
       <p>Let <var>reports</var> be a copy of the list of queued <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report①">report</a> objects in <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache⑦">reporting cache</a>.</p>
      <li data-md>
       <p>Let <var>endpoint map</var> be an empty map of <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint①⓪">network reporting endpoint</a> objects to lists of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report②">report</a> objects.</p>
      <li data-md>
       <p>For each <var>report</var> in <var>reports</var>:</p>
       <ol>
        <li data-md>
         <p>Let <var>origin</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin⑦">origin</a> of <var>report</var>’s <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-url" id="ref-for-report-url">url</a>.</p>
        <li data-md>
         <p>Let <var>client</var> be the entry in the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache⑧">reporting cache</a> for <var>origin</var>.</p>
        <li data-md>
         <p>If there exists an <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②④">endpoint group</a> (<var>group</var>) in <var>client</var>’s <code class="idl"><a data-link-type="idl" href="#dom-client-endpoint-groups" id="ref-for-dom-client-endpoint-groups①">endpoint-groups</a></code> list whose <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name⑤">name</a></code> is <var>report</var>’s <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-destination" id="ref-for-report-destination">destination</a>:</p>
         <ol>
          <li data-md>
           <p>Let <var>endpoint</var> be the result of executing <a href="#choose-endpoint">§ 5.1 Choose an endpoint from a group</a> on <var>group</var>.</p>
          <li data-md>
           <p>If <var>endpoint</var> is not <code>null</code>:</p>
           <ol>
            <li data-md>
             <p>Append <var>report</var> to <var>endpoint map</var>’s list of reports for <var>endpoint</var>.</p>
            <li data-md>
             <p>Skip to the next <var>report</var>.</p>
           </ol>
         </ol>
        <li data-md>
         <p>If <var>origin</var> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple" id="ref-for-concept-origin-tuple">tuple origin</a> whose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host①">host</a> is a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-domain" id="ref-for-concept-domain">domain</a>:</p>
         <ol>
          <li data-md>
           <p>For each <var>parent domain</var> that is a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6797#section-8.2" id="ref-for-section-8.2">superdomain match</a> for <var>origin</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host②">host</a> <a data-link-type="biblio" href="#biblio-rfc6797" title="HTTP Strict Transport Security (HSTS)">[RFC6797]</a>, considering longer
  domains first:</p>
           <ol>
            <li data-md>
             <p>Let <var>parent origin</var> be a copy of <var>origin</var>, with its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host③">host</a> replaced with <var>parent domain</var>.</p>
            <li data-md>
             <p>Let <var>client</var> be the entry in the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache⑨">reporting cache</a> for <var>parent origin</var>.</p>
            <li data-md>
             <p>If there exists an <a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②⑤">endpoint group</a> (<var>group</var>) in <var>client</var>’s <code class="idl"><a data-link-type="idl" href="#dom-client-endpoint-groups" id="ref-for-dom-client-endpoint-groups②">endpoint-groups</a></code> list whose <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-name" id="ref-for-dom-endpoint-group-name⑥">name</a></code> is <var>report</var>’s <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-destination" id="ref-for-report-destination①">destination</a> <b>and</b> whose <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-subdomains" id="ref-for-dom-endpoint-group-subdomains①">subdomains</a></code> flag is "<code>include</code>":</p>
             <ol>
              <li data-md>
               <p>Let <var>endpoint</var> be the result of executing <a href="#choose-endpoint">§ 5.1 Choose an endpoint from a group</a> on <var>group</var>.</p>
              <li data-md>
               <p>If <var>endpoint</var> is not <code>null</code>:</p>
               <ol>
                <li data-md>
                 <p>Append <var>report</var> to <var>endpoint map</var>’s list of reports
  for <var>endpoint</var>.</p>
                <li data-md>
                 <p>Skip to the next <var>report</var>.</p>
               </ol>
             </ol>
           </ol>
         </ol>
         <p class="note" role="note"><span class="marker">Note:</span> This algorithm ensures that more specific <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-subdomains" id="ref-for-dom-endpoint-group-subdomains②">subdomains</a></code> policies take precendence over less specific ones,
  and that <code class="idl"><a data-link-type="idl" href="#dom-endpoint-group-subdomains" id="ref-for-dom-endpoint-group-subdomains③">subdomains</a></code> policies are ignored for any
  non-<a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-domain" id="ref-for-concept-domain①">domain</a> origins (e.g., for a request to a raw IP address).</p>
        <li data-md>
         <p>If we reach this step, the <var>report</var> did not match any <a data-link-type="dfn" href="#network-reporting-endpoint" id="ref-for-network-reporting-endpoint①①">network
  reporting endpoint</a> and the user agent MAY remove <var>report</var> from the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache①⓪">reporting cache</a> directly. Depending on load, the user agent MAY
  instead wait for <a href="#gc">§ 6.2 Garbage Collection</a> at some point in the future.</p>
       </ol>
      <li data-md>
       <p>For each (<var>endpoint</var>, <var>reports</var>) pair in <var>endpoint map</var>:</p>
       <ol>
        <li data-md>
         <p>Let <var>origin map</var> be an empty map of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin⑧">origins</a> to
  lists of <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report③">report</a> objects.</p>
        <li data-md>
         <p>For each <var>report</var> in <var>reports</var>:</p>
         <ol>
          <li data-md>
           <p>Let <var>origin</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#origin" id="ref-for-origin⑨">origin</a> of <var>report</var>’s <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-url" id="ref-for-report-url①">url</a>.</p>
          <li data-md>
           <p>Append <var>report</var> to <var>origin map</var>’s list of reports for <var>origin</var>.</p>
         </ol>
        <li data-md>
         <p>For each (<var>origin</var>, <var>per-origin reports</var>) pair in <var>origin map</var>,
  execute the following steps asynchronously:</p>
         <ol>
          <li data-md>
           <p>Let <var>result</var> be the result of executing <a href="https://w3c.github.io/reporting/#try-delivery"><cite>Reporting API</cite> § 3.5.2 Attempt to deliver reports to endpoint</a> on <var>endpoint</var>, <var>origin</var>, and <var>per-origin reports</var>.</p>
          <li data-md>
           <p>If <var>result</var> is "<code>Success</code>":</p>
           <ol>
            <li data-md>
             <p>Set <var>endpoint</var>’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/reporting/#dom-endpoint-failures" id="ref-for-dom-endpoint-failures①">failures</a></code> to 0, and its <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-retry_after" id="ref-for-dom-network-reporting-endpoint-retry_after②">retry_after</a></code> to <code>null</code>.</p>
            <li data-md>
             <p>Remove each <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report④">report</a> in <var>reports</var> from the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache①①">reporting
  cache</a>.</p>
           </ol>
           <p>Otherwise, if <var>result</var> is "<code>Remove Endpoint</code>":</p>
           <ol>
            <li data-md>
             <p>Remove <var>endpoint</var> from the reporting cache.</p>
             <p class="note" role="note"><span class="marker">Note:</span> <var>reports</var> remain in the reporting cache for potential
  delivery to other endpoints.</p>
           </ol>
           <p>Otherwise (if <var>result</var> is "<code>Failure</code>"):</p>
           <ol>
            <li data-md>
             <p>Increment <var>endpoint</var>’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/reporting/#dom-endpoint-failures" id="ref-for-dom-endpoint-failures②">failures</a></code>.</p>
            <li data-md>
             <p>Set <var>endpoint</var>’s <code class="idl"><a data-link-type="idl" href="#dom-network-reporting-endpoint-retry_after" id="ref-for-dom-network-reporting-endpoint-retry_after③">retry_after</a></code> to
  a point in the future which the user agent chooses.</p>
             <p class="note" role="note"><span class="marker">Note:</span> We don’t specify a particular algorithm here, but user
  agents are encouraged to employ some sort of exponential
  backoff algorithm which increases the retry period with the
  number of failures, with the addition of some random jitter to
  ensure that temporary failures don’t lead to a crush of
  reports all being retried on the same schedule.</p>
             <p class="issue" id="issue-3c7e465b"><a class="self-link" href="#issue-3c7e465b"></a> Add in a reasonable reference describing a good
  algorithm.  Wikipedia, if nothing else.</p>
           </ol>
         </ol>
       </ol>
     </ol>
     <p class="note" role="note"><span class="marker">Note:</span> User agents MAY decide to attempt delivery for only a subset of the
  collected reports or endpoints (because, for example, sending all the reports
  at once would consume an unreasonable amount of bandwidth, etc). As reports
  are only removed from the cache when they’re successfully delivered, skipped
  reports will simply be delivered later.</p>
    </section>
    <section>
     <h2 class="heading settled" data-level="6" id="implementation"><span class="secno">6. </span><span class="content">Implementation Considerations</span><a class="self-link" href="#implementation"></a></h2>
     <h3 class="heading settled" data-level="6.1" id="delivery"><span class="secno">6.1. </span><span class="content">Delivery</span><a class="self-link" href="#delivery"></a></h3>
     <p>The user agent SHOULD attempt to deliver reports as soon as possible to
  provide feedback to developers as quickly as possible. However, when this
  desire is balanced against the impact on the user, the user wins. With that
  in mind, the user agent MAY delay delivery of reports based on its knowledge
  of the user’s activities and context.</p>
     <p>For instance, the user agent SHOULD prioritize the transmission of reporting
  data lower than other network traffic. The user’s explicit activities on a
  website should preempt reporting traffic.</p>
     <p>The user agent MAY choose to withhold report delivery entirely until the user
  is on a fast, cheap network in order to prevent unnecessary data cost.</p>
     <p>The user agent MAY choose to prioritize reports from particular origins over
  others (perhaps those that the user visits most often?)</p>
     <h3 class="heading settled" data-level="6.2" id="gc"><span class="secno">6.2. </span><span class="content">Garbage Collection</span><a class="self-link" href="#gc"></a></h3>
     <p>Periodically, the user agent SHOULD walk through the cached <a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports③">reports</a> and <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint⑨">endpoints</a>, and discard those that are no
  longer relevant. These include:</p>
     <ul>
      <li data-md>
       <p><a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②⑥">endpoint groups</a> which are <a data-link-type="dfn" href="#endpoint-group-expired" id="ref-for-endpoint-group-expired">expired</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#endpoint-group" id="ref-for-endpoint-group②⑦">endpoint groups</a> which have not been used in some arbitrary
  period of time (perhaps a ~week?)</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports④">reports</a> whose <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-attempts" id="ref-for-report-attempts">attempts</a> exceed
  some user-agent-defined threshold (~5 seems reasonable.)</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://w3c.github.io/reporting/#windoworworkerglobalscope-reports" id="ref-for-windoworworkerglobalscope-reports⑤">reports</a> which have not been delivered in some arbitrary period of
  time (perhaps ~2 days?)</p>
     </ul>
    </section>
    <section>
     <h2 class="heading settled" data-level="7" id="sample-reports"><span class="secno">7. </span><span class="content">Sample Reports</span><a class="self-link" href="#sample-reports"></a></h2>
     <div class="example" id="example-76ba69fd">
      <a class="self-link" href="#example-76ba69fd"></a> 
<pre>POST / HTTP/1.1
Host: example.com
...
Content-Type: application/reports+json

[{
  "type": "csp",
  "age": 10,
  "url": "https://example.com/vulnerable-page/",
  "user_agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",
  "body": {
    "blocked": "https://evil.com/evil.js",
    "directive": "script-src",
    "policy": "script-src 'self'; object-src 'none'",
    "status": 200,
    "referrer": "https://evil.com/"
  }
}, {
  "type": "hpkp",
  "age": 32,
  "url": "https://www.example.com/",
  "user_agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",
  "body": {
    "date-time": "2014-04-06T13:00:50Z",
    "hostname": "www.example.com",
    "port": 443,
    "effective-expiration-date": "2014-05-01T12:40:50Z"
    "include-subdomains": false,
    "served-certificate-chain": [
      "-----BEGIN CERTIFICATE-----\n
      MIIEBDCCAuygAwIBAgIDAjppMA0GCSqGSIb3DQEBBQUAMEIxCzAJBgNVBAYTAlVT\n
      ...
      HFa9llF7b1cq26KqltyMdMKVvvBulRP/F/A8rLIQjcxz++iPAsbw+zOzlTvjwsto\n
      WHPbqCRiOwY1nQ2pM714A5AuTHhdUDqB1O6gyHA43LL5Z/qHQF1hwFGPa4NrzQU6\n
      yuGnBXj8ytqU0CwIPX4WecigUCAkVDNx\n
      -----END CERTIFICATE-----",
      ...
    ]
  }
}, {
  "type": "nel",
  "age": 29,
  "url": "https://example.com/thing.js",
  "user_agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",
  "body": {
    "referrer": "https://www.example.com/",
    "server-ip": "234.233.232.231",
    "protocol": "",
    "status-code": 0,
    "elapsed-time": 143,
    "age": 0,
    "type": "http.dns.name_not_resolved"
  }
}]
</pre>
     </div>
    </section>
    <section>
     <h2 class="heading settled" data-level="8" id="security"><span class="secno">8. </span><span class="content">Security Considerations</span><a class="self-link" href="#security"></a></h2>
     <h3 class="heading settled" data-level="8.1" id="capability-urls"><span class="secno">8.1. </span><span class="content">Capability URLs</span><a class="self-link" href="#capability-urls"></a></h3>
     <p>Some URLs are valuable in and of themselves. To mitigate the possibility
  that such URLs will be leaked via this reporting mechanism, we strip out
  credential information and fragment data from the URL we store as a <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report" id="ref-for-report⑤">report</a>’s originator. It is still possible, however, for a feature
  to unintentionally leak such data via a report’s <a data-link-type="dfn" href="https://w3c.github.io/reporting/#report-body" id="ref-for-report-body">body</a>. Implementers
  SHOULD ensure that URLs contained in a report’s body are similarly stripped.</p>
    </section>
    <section>
     <h2 class="heading settled" data-level="9" id="privacy"><span class="secno">9. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy"></a></h2>
     <h3 class="heading settled" data-level="9.1" id="network-leakage"><span class="secno">9.1. </span><span class="content">Network Leakage</span><a class="self-link" href="#network-leakage"></a></h3>
     <p>Because this reporting mechanism is out-of-band, and doesn’t rely on a page
  being open, it’s entirely possible for a report generated while a user is on
  one network to be sent while the user is on another network, even if they
  don’t explicitly open the page from which the report was sent.</p>
     <p class="issue" id="issue-acba119f"><a class="self-link" href="#issue-acba119f"></a> Consider mitigations. For example, we could
  drop reports if we change from one network to another. <a href="https://github.com/w3c/BackgroundSync/issues/107">[Issue #w3c/BackgroundSync#107]</a></p>
     <h3 class="heading settled" data-level="9.2" id="fingerprinting-clock-skew"><span class="secno">9.2. </span><span class="content">Clock Skew</span><a class="self-link" href="#fingerprinting-clock-skew"></a></h3>
     <p>Each report is delivered along with an <code>age</code> property, rather than the
  timestamp at which it was generated. We do this because each user’s local
  clock will be skewed from the clock on the server by an arbitrary amount.
  The difference between the time the report was generated and the time it
  was sent will be stable, regardless of clock skew, and we can avoid the
  fingerprinting risk of exposing the clock skew via this API.</p>
     <h3 class="heading settled" data-level="9.3" id="correlation"><span class="secno">9.3. </span><span class="content">Cross-origin correlation</span><a class="self-link" href="#correlation"></a></h3>
     <p>If multiple origins all use the same reporting endpoint, that endpoint may
  learn that a particular user has interacted with a certain set of websites,
  as it will receive origin-tagged reports from each. This doesn’t seem worse
  than the status quo ability to track the same information from cooperative
  origins, and doesn’t grant any new tracking ability above and beyond what’s
  possible with <code>&lt;img></code> today.</p>
     <h3 class="heading settled" data-level="9.4" id="subdomains"><span class="secno">9.4. </span><span class="content">Subdomains</span><a class="self-link" href="#subdomains"></a></h3>
     <p>This specification allows any resource on a host to declare a set of reporting
  endpoints for that host and each of its subdomains. This doesn’t have privacy
  implications in and of itself (beyond those noted in <a href="#clear-cache">§ 9.5 Clearing the reporting cache</a>), as the
  reporting endpoints themselves don’t take any real action, as features will
  need to opt-into using these reporting endpoints explicitly. Those features
  certainly will have privacy implications, and should carefully consider
  whether they should be enabled across origin boundaries.</p>
     <h3 class="heading settled" data-level="9.5" id="clear-cache"><span class="secno">9.5. </span><span class="content">Clearing the reporting cache</span><a class="self-link" href="#clear-cache"></a></h3>
     <p>A user agent’s <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache①②">reporting cache</a> contains data about a user’s activity
  on the web, and user agents ought to handle this data carefully. In
  particular, if a user agent gives users the ability to clear their site data,
  browsing history, browsing cache, or similar, the user agent MUST also clear
  the <a data-link-type="dfn" href="#reporting-cache" id="ref-for-reporting-cache①③">reporting cache</a>. Note that this includes both the pending reports
  themselves, as well as the endpoints to which they would be sent. Both MUST
  be cleared.</p>
     <h3 class="heading settled" data-level="9.6" id="disable"><span class="secno">9.6. </span><span class="content">Disabling Reporting</span><a class="self-link" href="#disable"></a></h3>
     <p>Reporting is, to some extent, a question of commons. In the aggregate, it
  seems useful for everyone for reports to be delivered. There is direct benefit
  to developers, as they can fix bugs, which means there’s indirect benefit to
  users, as the sites they enjoy will be more stable and enjoyable. As a
  concrete example, Content Security Policy grants something like herd immunity
  to cross-site scripting attacks by alerting developers about potential holes
  in their sites' defenses. Fixing those bugs helps every user, even those whose
  user agents don’t support Content Security Policy.</p>
     <p>The calculus, of course, depends on the nature of data that’s being delivered,
  and the relative maliciousness of the reporting endpoints, but that’s the
  value proposition in broad strokes.</p>
     <p>That said, it can’t be the case that this general benefit be allowed to take
  priority over the ability of a user to individually opt-out of such a system.
  Sending reports costs bandwidth, and potentially could reveal some small
  amount of additional information above and beyond what a website can obtain
  in-band (<a data-link-type="biblio" href="#biblio-network-error-logging" title="Network Error Logging">[NETWORK-ERROR-LOGGING]</a>, for instance). User agents MUST allow
  users to disable reporting with some reasonable amount of granularity in order
  to maintain the priority of constituencies espoused in <a data-link-type="biblio" href="#biblio-html-design-principles" title="HTML Design Principles">[HTML-DESIGN-PRINCIPLES]</a>.</p>
    </section>
   </section>
  </main>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#client">client</a><span>, in § 2.3</span>
   <li><a href="#dom-endpoint-group-creation">creation</a><span>, in § 2.1</span>
   <li><a href="#endpoint-group">endpoint group</a><span>, in § 2.1</span>
   <li><a href="#dom-client-endpoint-groups">endpoint-groups</a><span>, in § 2.3</span>
   <li>
    endpoints
    <ul>
     <li><a href="#dom-endpoint-group-endpoints">attribute for endpoint group</a><span>, in § 2.1</span>
     <li><a href="#network_reporting_endpoints-endpoints">dfn for network_reporting_endpoints</a><span>, in § 3.1.4</span>
    </ul>
   <li><a href="#endpoint-group-expired">expired</a><span>, in § 2.1</span>
   <li><a href="#failover-class">failover class</a><span>, in § 2.4</span>
   <li><a href="#generate-a-network-report">generate a network report</a><span>, in § 4</span>
   <li><a href="#network_reporting_endpoints-group">group</a><span>, in § 3.1.1</span>
   <li><a href="#network_reporting_endpoints-include_subdomains">include_subdomains</a><span>, in § 3.1.2</span>
   <li><a href="#network_reporting_endpoints-max_age">max_age</a><span>, in § 3.1.3</span>
   <li><a href="#dom-endpoint-group-name">name</a><span>, in § 2.1</span>
   <li><a href="#network-reporting-endpoint">network reporting endpoint</a><span>, in § 2.2</span>
   <li><a href="#network_reporting_endpoints">network_reporting_endpoints</a><span>, in § 3.1</span>
   <li><a href="#dom-client-origin">origin</a><span>, in § 2.3</span>
   <li><a href="#network-reporting-endpoint-pending">pending</a><span>, in § 2.2</span>
   <li>
    priority
    <ul>
     <li><a href="#dom-network-reporting-endpoint-priority">attribute for network reporting endpoint</a><span>, in § 2.2</span>
     <li><a href="#network_reporting_endpoints-priority">dfn for network_reporting_endpoints</a><span>, in § 3.1.6</span>
    </ul>
   <li><a href="#reporting-cache">reporting cache</a><span>, in § 2.5</span>
   <li><a href="#dom-network-reporting-endpoint-retry_after">retry_after</a><span>, in § 2.2</span>
   <li><a href="#dom-endpoint-group-subdomains">subdomains</a><span>, in § 2.1</span>
   <li><a href="#dom-endpoint-group-ttl">ttl</a><span>, in § 2.1</span>
   <li><a href="#network_reporting_endpoints-url">url</a><span>, in § 3.1.5</span>
   <li>
    weight
    <ul>
     <li><a href="#dom-network-reporting-endpoint-weight">attribute for network reporting endpoint</a><span>, in § 2.2</span>
     <li><a href="#network_reporting_endpoints-weight">dfn for network_reporting_endpoints</a><span>, in § 3.1.7</span>
    </ul>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="0914e5ac">reports directive</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3268a8eb">url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="77a2ee6e">host</span>
     <li><span class="dfn-paneled" id="303ff2d7">origin</span>
     <li><span class="dfn-paneled" id="1d2aa117">tuple origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3fca5a9e">map</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ORIGIN-POLICY]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e860917e">origin policy manifest</span>
    </ul>
   <li>
    <a data-link-type="biblio">[REPORTING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="860ba67a">attempts</span>
     <li><span class="dfn-paneled" id="cf363990">body</span>
     <li><span class="dfn-paneled" id="b5014c72">destination</span>
     <li><span class="dfn-paneled" id="9239678f">endpoint</span>
     <li><span class="dfn-paneled" id="7da20734">failures</span>
     <li><span class="dfn-paneled" id="18084dbe">name</span>
     <li><span class="dfn-paneled" id="9fe8836b">report</span>
     <li><span class="dfn-paneled" id="1d3587f5">reports</span>
     <li><span class="dfn-paneled" id="e2e07307">url <small>(for endpoint)</small></span>
     <li><span class="dfn-paneled" id="d472196c">url <small>(for report)</small></span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC2782]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="ed24b09a">SRV record</span>
     <li><span class="dfn-paneled" id="c1b05845">target selection algorithm</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6797]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="87ed2210">superdomain match</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SECURE-CONTEXTS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="844c841b">potentially trustworthy</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="22ece843">absolute-URL string</span>
     <li><span class="dfn-paneled" id="b9d1df32">base URL</span>
     <li><span class="dfn-paneled" id="22477314">domain</span>
     <li><span class="dfn-paneled" id="c2d05aec">path-absolute-URL string</span>
     <li><span class="dfn-paneled" id="ca3ca4ae">URL parser</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-origin-policy">[ORIGIN-POLICY]
   <dd><a href="https://wicg.github.io/origin-policy/"><cite>Origin Policy</cite></a>. cg-draft. URL: <a href="https://wicg.github.io/origin-policy/">https://wicg.github.io/origin-policy/</a>
   <dt id="biblio-reporting">[REPORTING]
   <dd>Douglas Creager; Ian Clelland; Mike West. <a href="https://w3c.github.io/reporting/"><cite>Reporting API</cite></a>. URL: <a href="https://w3c.github.io/reporting/">https://w3c.github.io/reporting/</a>
   <dt id="biblio-rfc2782">[RFC2782]
   <dd>A. Gulbrandsen; P. Vixie; L. Esibov. <a href="https://www.rfc-editor.org/rfc/rfc2782"><cite>A DNS RR for specifying the location of services (DNS SRV)</cite></a>. February 2000. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc2782">https://www.rfc-editor.org/rfc/rfc2782</a>
   <dt id="biblio-rfc6797">[RFC6797]
   <dd>J. Hodges; C. Jackson; A. Barth. <a href="https://www.rfc-editor.org/rfc/rfc6797"><cite>HTTP Strict Transport Security (HSTS)</cite></a>. November 2012. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6797">https://www.rfc-editor.org/rfc/rfc6797</a>
   <dt id="biblio-secure-contexts">[SECURE-CONTEXTS]
   <dd>Mike West; Yan Zhu. <a href="https://w3c.github.io/webappsec-secure-contexts/"><cite>Secure Contexts</cite></a>. URL: <a href="https://w3c.github.io/webappsec-secure-contexts/">https://w3c.github.io/webappsec-secure-contexts/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-csp3">[CSP3]
   <dd>Mike West; Antonio Sartori. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 3</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-html-design-principles">[HTML-DESIGN-PRINCIPLES]
   <dd>Anne van Kesteren; Maciej Stachowiak. <a href="https://www.w3.org/TR/html-design-principles/"><cite>HTML Design Principles</cite></a>. 26 November 2007. WD. URL: <a href="https://www.w3.org/TR/html-design-principles/">https://www.w3.org/TR/html-design-principles/</a>
   <dt id="biblio-network-error-logging">[NETWORK-ERROR-LOGGING]
   <dd>Douglas Creager; Ian Clelland. <a href="https://w3c.github.io/network-error-logging/"><cite>Network Error Logging</cite></a>. URL: <a href="https://w3c.github.io/network-error-logging/">https://w3c.github.io/network-error-logging/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Origin Policy monkey patching. Talk to Domenic. <a class="issue-return" href="#issue-0c90253d" title="Jump to section">↵</a></div>
   <div class="issue"> Add in a reasonable reference describing a good
  algorithm.  Wikipedia, if nothing else. <a class="issue-return" href="#issue-3c7e465b" title="Jump to section">↵</a></div>
   <div class="issue"> Consider mitigations. For example, we could
  drop reports if we change from one network to another. <a href="https://github.com/w3c/BackgroundSync/issues/107">[Issue #w3c/BackgroundSync#107]</a> <a class="issue-return" href="#issue-acba119f" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0914e5ac": {"dfnID":"0914e5ac","dfnText":"reports directive","external":true,"refSections":[{"refs":[{"id":"ref-for-directives-reporting"}],"title":"1.2. Examples"}],"url":"https://w3c.github.io/webappsec-csp/#directives-reporting"},
"18084dbe": {"dfnID":"18084dbe","dfnText":"name","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-name"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://w3c.github.io/reporting/#dom-endpoint-name"},
"1d2aa117": {"dfnID":"1d2aa117","dfnText":"tuple origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-tuple"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple"},
"1d3587f5": {"dfnID":"1d3587f5","dfnText":"reports","external":true,"refSections":[{"refs":[{"id":"ref-for-windoworworkerglobalscope-reports"},{"id":"ref-for-windoworworkerglobalscope-reports\u2460"}],"title":"2.5. Storage"},{"refs":[{"id":"ref-for-windoworworkerglobalscope-reports\u2461"}],"title":"5. Report Delivery"},{"refs":[{"id":"ref-for-windoworworkerglobalscope-reports\u2462"},{"id":"ref-for-windoworworkerglobalscope-reports\u2463"},{"id":"ref-for-windoworworkerglobalscope-reports\u2464"}],"title":"6.2. Garbage Collection"}],"url":"https://w3c.github.io/reporting/#windoworworkerglobalscope-reports"},
"22477314": {"dfnID":"22477314","dfnText":"domain","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-domain"},{"id":"ref-for-concept-domain\u2460"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://url.spec.whatwg.org/#concept-domain"},
"22ece843": {"dfnID":"22ece843","dfnText":"absolute-URL string","external":true,"refSections":[{"refs":[{"id":"ref-for-absolute-url-string"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://url.spec.whatwg.org/#absolute-url-string"},
"303ff2d7": {"dfnID":"303ff2d7","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-origin"},{"id":"ref-for-origin\u2460"}],"title":"2.1. Endpoint groups"},{"refs":[{"id":"ref-for-origin\u2461"}],"title":"2.3. Clients"},{"refs":[{"id":"ref-for-origin\u2462"},{"id":"ref-for-origin\u2463"}],"title":"2.5. Storage"},{"refs":[{"id":"ref-for-origin\u2464"}],"title":"3.1.2. The include_subdomains member"},{"refs":[{"id":"ref-for-origin\u2465"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-origin\u2466"},{"id":"ref-for-origin\u2467"},{"id":"ref-for-origin\u2468"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#origin"},
"3268a8eb": {"dfnID":"3268a8eb","dfnText":"url","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-url"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://fetch.spec.whatwg.org/#concept-response-url"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"4. Report Generation"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"3fca5a9e": {"dfnID":"3fca5a9e","dfnText":"map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"77a2ee6e": {"dfnID":"77a2ee6e","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-host"}],"title":"3.1.2. The include_subdomains member"},{"refs":[{"id":"ref-for-concept-origin-host\u2460"},{"id":"ref-for-concept-origin-host\u2461"},{"id":"ref-for-concept-origin-host\u2462"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"7da20734": {"dfnID":"7da20734","dfnText":"failures","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-failures"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-endpoint-failures\u2460"},{"id":"ref-for-dom-endpoint-failures\u2461"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://w3c.github.io/reporting/#dom-endpoint-failures"},
"844c841b": {"dfnID":"844c841b","dfnText":"potentially trustworthy","external":true,"refSections":[{"refs":[{"id":"ref-for-is-origin-trustworthy"}],"title":"3.1.5. The endpoints.url member"}],"url":"https://w3c.github.io/webappsec-secure-contexts/#is-origin-trustworthy"},
"860ba67a": {"dfnID":"860ba67a","dfnText":"attempts","external":true,"refSections":[{"refs":[{"id":"ref-for-report-attempts"}],"title":"6.2. Garbage Collection"}],"url":"https://w3c.github.io/reporting/#report-attempts"},
"87ed2210": {"dfnID":"87ed2210","dfnText":"superdomain match","external":true,"refSections":[{"refs":[{"id":"ref-for-section-8.2"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://tools.ietf.org/html/rfc6797#section-8.2"},
"9239678f": {"dfnID":"9239678f","dfnText":"endpoint","external":true,"refSections":[{"refs":[{"id":"ref-for-endpoint"}],"title":"1.1. Guarantees"},{"refs":[{"id":"ref-for-endpoint\u2460"}],"title":"2.2. Network reporting endpoints"},{"refs":[{"id":"ref-for-endpoint\u2461"}],"title":"2.3. Clients"},{"refs":[{"id":"ref-for-endpoint\u2462"}],"title":"3.1.4. The endpoints member"},{"refs":[{"id":"ref-for-endpoint\u2463"}],"title":"3.1.5. The endpoints.url member"},{"refs":[{"id":"ref-for-endpoint\u2464"}],"title":"3.1.6. The endpoints.priority member"},{"refs":[{"id":"ref-for-endpoint\u2465"}],"title":"3.1.7. The endpoints.weight member"},{"refs":[{"id":"ref-for-endpoint\u2466"},{"id":"ref-for-endpoint\u2467"}],"title":"5.1. \n    Choose an endpoint from a group\n  "},{"refs":[{"id":"ref-for-endpoint\u2468"}],"title":"6.2. Garbage Collection"}],"url":"https://w3c.github.io/reporting/#endpoint"},
"9fe8836b": {"dfnID":"9fe8836b","dfnText":"report","external":true,"refSections":[{"refs":[{"id":"ref-for-report"}],"title":"2.5. Storage"},{"refs":[{"id":"ref-for-report\u2460"},{"id":"ref-for-report\u2461"},{"id":"ref-for-report\u2462"},{"id":"ref-for-report\u2463"}],"title":"5.2. \n    Send reports\n  "},{"refs":[{"id":"ref-for-report\u2464"}],"title":"8.1. Capability URLs"}],"url":"https://w3c.github.io/reporting/#report"},
"a973e0fe": {"dfnID":"a973e0fe","dfnText":"document","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document"}],"title":"4. Report Generation"}],"url":"https://dom.spec.whatwg.org/#concept-document"},
"b5014c72": {"dfnID":"b5014c72","dfnText":"destination","external":true,"refSections":[{"refs":[{"id":"ref-for-report-destination"},{"id":"ref-for-report-destination\u2460"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://w3c.github.io/reporting/#report-destination"},
"b9d1df32": {"dfnID":"b9d1df32","dfnText":"base URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-base-url"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://url.spec.whatwg.org/#concept-base-url"},
"c1b05845": {"dfnID":"c1b05845","dfnText":"target selection algorithm","external":true,"refSections":[{"refs":[{"id":"ref-for-page-4"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"https://tools.ietf.org/html/rfc2782#page-4"},
"c2d05aec": {"dfnID":"c2d05aec","dfnText":"path-absolute-URL string","external":true,"refSections":[{"refs":[{"id":"ref-for-path-absolute-url-string"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://url.spec.whatwg.org/#path-absolute-url-string"},
"ca3ca4ae": {"dfnID":"ca3ca4ae","dfnText":"URL parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-parser"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://url.spec.whatwg.org/#concept-url-parser"},
"cf363990": {"dfnID":"cf363990","dfnText":"body","external":true,"refSections":[{"refs":[{"id":"ref-for-report-body"}],"title":"8.1. Capability URLs"}],"url":"https://w3c.github.io/reporting/#report-body"},
"client": {"dfnID":"client","dfnText":"client","external":false,"refSections":[{"refs":[{"id":"ref-for-client"},{"id":"ref-for-client\u2460"}],"title":"2.3. Clients"},{"refs":[{"id":"ref-for-client\u2461"},{"id":"ref-for-client\u2462"}],"title":"2.5. Storage"},{"refs":[{"id":"ref-for-client\u2463"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#client"},
"d472196c": {"dfnID":"d472196c","dfnText":"url (for report)","external":true,"refSections":[{"refs":[{"id":"ref-for-report-url"},{"id":"ref-for-report-url\u2460"}],"title":"5.2. \n    Send reports\n  "}],"url":"https://w3c.github.io/reporting/#report-url"},
"dom-client-endpoint-groups": {"dfnID":"dom-client-endpoint-groups","dfnText":"endpoint-groups","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-client-endpoint-groups"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-client-endpoint-groups\u2460"},{"id":"ref-for-dom-client-endpoint-groups\u2461"}],"title":"5.2. \n    Send reports\n  "}],"url":"#dom-client-endpoint-groups"},
"dom-client-origin": {"dfnID":"dom-client-origin","dfnText":"origin","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-client-origin"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#dom-client-origin"},
"dom-endpoint-group-creation": {"dfnID":"dom-endpoint-group-creation","dfnText":"creation","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-group-creation"}],"title":"2.1. Endpoint groups"},{"refs":[{"id":"ref-for-dom-endpoint-group-creation\u2460"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#dom-endpoint-group-creation"},
"dom-endpoint-group-endpoints": {"dfnID":"dom-endpoint-group-endpoints","dfnText":"endpoints","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-group-endpoints"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-endpoint-group-endpoints\u2460"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"#dom-endpoint-group-endpoints"},
"dom-endpoint-group-name": {"dfnID":"dom-endpoint-group-name","dfnText":"name","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-group-name"}],"title":"2.3. Clients"},{"refs":[{"id":"ref-for-dom-endpoint-group-name\u2460"},{"id":"ref-for-dom-endpoint-group-name\u2461"}],"title":"3.1.1. The group member"},{"refs":[{"id":"ref-for-dom-endpoint-group-name\u2462"},{"id":"ref-for-dom-endpoint-group-name\u2463"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-endpoint-group-name\u2464"},{"id":"ref-for-dom-endpoint-group-name\u2465"}],"title":"5.2. \n    Send reports\n  "}],"url":"#dom-endpoint-group-name"},
"dom-endpoint-group-subdomains": {"dfnID":"dom-endpoint-group-subdomains","dfnText":"subdomains","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-group-subdomains"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-endpoint-group-subdomains\u2460"},{"id":"ref-for-dom-endpoint-group-subdomains\u2461"},{"id":"ref-for-dom-endpoint-group-subdomains\u2462"}],"title":"5.2. \n    Send reports\n  "}],"url":"#dom-endpoint-group-subdomains"},
"dom-endpoint-group-ttl": {"dfnID":"dom-endpoint-group-ttl","dfnText":"ttl","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-group-ttl"}],"title":"2.1. Endpoint groups"},{"refs":[{"id":"ref-for-dom-endpoint-group-ttl\u2460"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#dom-endpoint-group-ttl"},
"dom-network-reporting-endpoint-priority": {"dfnID":"dom-network-reporting-endpoint-priority","dfnText":"priority","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-priority"},{"id":"ref-for-dom-network-reporting-endpoint-priority\u2460"},{"id":"ref-for-dom-network-reporting-endpoint-priority\u2461"},{"id":"ref-for-dom-network-reporting-endpoint-priority\u2462"}],"title":"2.4. Failover and load balancing"},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-priority\u2463"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-priority\u2464"},{"id":"ref-for-dom-network-reporting-endpoint-priority\u2465"},{"id":"ref-for-dom-network-reporting-endpoint-priority\u2466"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"#dom-network-reporting-endpoint-priority"},
"dom-network-reporting-endpoint-retry_after": {"dfnID":"dom-network-reporting-endpoint-retry_after","dfnText":"retry_after","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-retry_after"}],"title":"2.2. Network reporting endpoints"},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-retry_after\u2460"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-retry_after\u2461"},{"id":"ref-for-dom-network-reporting-endpoint-retry_after\u2462"}],"title":"5.2. \n    Send reports\n  "}],"url":"#dom-network-reporting-endpoint-retry_after"},
"dom-network-reporting-endpoint-weight": {"dfnID":"dom-network-reporting-endpoint-weight","dfnText":"weight","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-weight"},{"id":"ref-for-dom-network-reporting-endpoint-weight\u2460"}],"title":"2.4. Failover and load balancing"},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-weight\u2461"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-dom-network-reporting-endpoint-weight\u2462"},{"id":"ref-for-dom-network-reporting-endpoint-weight\u2463"},{"id":"ref-for-dom-network-reporting-endpoint-weight\u2464"},{"id":"ref-for-dom-network-reporting-endpoint-weight\u2465"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"#dom-network-reporting-endpoint-weight"},
"e2e07307": {"dfnID":"e2e07307","dfnText":"url (for endpoint)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-endpoint-url"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"https://w3c.github.io/reporting/#dom-endpoint-url"},
"e860917e": {"dfnID":"e860917e","dfnText":"origin policy manifest","external":true,"refSections":[{"refs":[{"id":"ref-for-origin-policy-manifest"}],"title":"3. Endpoint Delivery"}],"url":"https://wicg.github.io/origin-policy/#origin-policy-manifest"},
"ed24b09a": {"dfnID":"ed24b09a","dfnText":"SRV record","external":true,"refSections":[{"refs":[{"id":"ref-for-something"}],"title":"1.1. Guarantees"},{"refs":[{"id":"ref-for-something\u2460"}],"title":"2.4. Failover and load balancing"},{"refs":[{"id":"ref-for-something\u2461"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"https://tools.ietf.org/html/rfc2782#"},
"endpoint-group": {"dfnID":"endpoint-group","dfnText":"endpoint group","external":false,"refSections":[{"refs":[{"id":"ref-for-endpoint-group"},{"id":"ref-for-endpoint-group\u2460"},{"id":"ref-for-endpoint-group\u2461"},{"id":"ref-for-endpoint-group\u2462"},{"id":"ref-for-endpoint-group\u2463"},{"id":"ref-for-endpoint-group\u2464"}],"title":"2.1. Endpoint groups"},{"refs":[{"id":"ref-for-endpoint-group\u2465"}],"title":"2.3. Clients"},{"refs":[{"id":"ref-for-endpoint-group\u2466"}],"title":"2.4. Failover and load balancing"},{"refs":[{"id":"ref-for-endpoint-group\u2467"}],"title":"2.5. Storage"},{"refs":[{"id":"ref-for-endpoint-group\u2468"},{"id":"ref-for-endpoint-group\u2460\u24ea"},{"id":"ref-for-endpoint-group\u2460\u2460"}],"title":"3. Endpoint Delivery"},{"refs":[{"id":"ref-for-endpoint-group\u2460\u2461"},{"id":"ref-for-endpoint-group\u2460\u2462"}],"title":"3.1. The\n  \"network_reporting_endpoints\" policy item"},{"refs":[{"id":"ref-for-endpoint-group\u2460\u2463"},{"id":"ref-for-endpoint-group\u2460\u2464"}],"title":"3.1.1. The group member"},{"refs":[{"id":"ref-for-endpoint-group\u2460\u2465"}],"title":"3.1.2. The include_subdomains member"},{"refs":[{"id":"ref-for-endpoint-group\u2460\u2466"},{"id":"ref-for-endpoint-group\u2460\u2467"}],"title":"3.1.3. The max_age member"},{"refs":[{"id":"ref-for-endpoint-group\u2460\u2468"}],"title":"3.1.4. The endpoints member"},{"refs":[{"id":"ref-for-endpoint-group\u2461\u24ea"},{"id":"ref-for-endpoint-group\u2461\u2460"},{"id":"ref-for-endpoint-group\u2461\u2461"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-endpoint-group\u2461\u2462"}],"title":"5.1. \n    Choose an endpoint from a group\n  "},{"refs":[{"id":"ref-for-endpoint-group\u2461\u2463"},{"id":"ref-for-endpoint-group\u2461\u2464"}],"title":"5.2. \n    Send reports\n  "},{"refs":[{"id":"ref-for-endpoint-group\u2461\u2465"},{"id":"ref-for-endpoint-group\u2461\u2466"}],"title":"6.2. Garbage Collection"}],"url":"#endpoint-group"},
"endpoint-group-expired": {"dfnID":"endpoint-group-expired","dfnText":"expired","external":false,"refSections":[{"refs":[{"id":"ref-for-endpoint-group-expired"}],"title":"6.2. Garbage Collection"}],"url":"#endpoint-group-expired"},
"failover-class": {"dfnID":"failover-class","dfnText":"failover class","external":false,"refSections":[{"refs":[{"id":"ref-for-failover-class"},{"id":"ref-for-failover-class\u2460"},{"id":"ref-for-failover-class\u2461"}],"title":"2.4. Failover and load balancing"}],"url":"#failover-class"},
"generate-a-network-report": {"dfnID":"generate-a-network-report","dfnText":"generate a network report","external":false,"refSections":[],"url":"#generate-a-network-report"},
"network-reporting-endpoint": {"dfnID":"network-reporting-endpoint","dfnText":"network reporting endpoint","external":false,"refSections":[{"refs":[{"id":"ref-for-network-reporting-endpoint"},{"id":"ref-for-network-reporting-endpoint\u2460"}],"title":"2.1. Endpoint groups"},{"refs":[{"id":"ref-for-network-reporting-endpoint\u2461"},{"id":"ref-for-network-reporting-endpoint\u2462"},{"id":"ref-for-network-reporting-endpoint\u2463"},{"id":"ref-for-network-reporting-endpoint\u2464"}],"title":"2.2. Network reporting endpoints"},{"refs":[{"id":"ref-for-network-reporting-endpoint\u2465"},{"id":"ref-for-network-reporting-endpoint\u2466"}],"title":"2.4. Failover and load balancing"},{"refs":[{"id":"ref-for-network-reporting-endpoint\u2467"},{"id":"ref-for-network-reporting-endpoint\u2468"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-network-reporting-endpoint\u2460\u24ea"},{"id":"ref-for-network-reporting-endpoint\u2460\u2460"}],"title":"5.2. \n    Send reports\n  "}],"url":"#network-reporting-endpoint"},
"network-reporting-endpoint-pending": {"dfnID":"network-reporting-endpoint-pending","dfnText":"pending","external":false,"refSections":[{"refs":[{"id":"ref-for-network-reporting-endpoint-pending"}],"title":"5.1. \n    Choose an endpoint from a group\n  "}],"url":"#network-reporting-endpoint-pending"},
"network_reporting_endpoints": {"dfnID":"network_reporting_endpoints","dfnText":"network_reporting_endpoints","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints"}],"title":"1.2. Examples"}],"url":"#network_reporting_endpoints"},
"network_reporting_endpoints-endpoints": {"dfnID":"network_reporting_endpoints-endpoints","dfnText":"endpoints","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-endpoints"}],"title":"1.2. Examples"},{"refs":[{"id":"ref-for-network_reporting_endpoints-endpoints\u2460"},{"id":"ref-for-network_reporting_endpoints-endpoints\u2461"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-endpoints"},
"network_reporting_endpoints-group": {"dfnID":"network_reporting_endpoints-group","dfnText":"group","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-group"}],"title":"1.2. Examples"},{"refs":[{"id":"ref-for-network_reporting_endpoints-group\u2460"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-group"},
"network_reporting_endpoints-include_subdomains": {"dfnID":"network_reporting_endpoints-include_subdomains","dfnText":"include_subdomains","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-include_subdomains"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-include_subdomains"},
"network_reporting_endpoints-max_age": {"dfnID":"network_reporting_endpoints-max_age","dfnText":"max_age","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-max_age"}],"title":"1.2. Examples"},{"refs":[{"id":"ref-for-network_reporting_endpoints-max_age\u2460"},{"id":"ref-for-network_reporting_endpoints-max_age\u2461"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-max_age"},
"network_reporting_endpoints-priority": {"dfnID":"network_reporting_endpoints-priority","dfnText":"priority","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-priority"},{"id":"ref-for-network_reporting_endpoints-priority\u2460"}],"title":"1.2. Examples"},{"refs":[{"id":"ref-for-network_reporting_endpoints-priority\u2461"},{"id":"ref-for-network_reporting_endpoints-priority\u2462"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-priority"},
"network_reporting_endpoints-url": {"dfnID":"network_reporting_endpoints-url","dfnText":"url","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-url"},{"id":"ref-for-network_reporting_endpoints-url\u2460"}],"title":"1.2. Examples"},{"refs":[{"id":"ref-for-network_reporting_endpoints-url\u2461"},{"id":"ref-for-network_reporting_endpoints-url\u2462"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-url"},
"network_reporting_endpoints-weight": {"dfnID":"network_reporting_endpoints-weight","dfnText":"weight","external":false,"refSections":[{"refs":[{"id":"ref-for-network_reporting_endpoints-weight"},{"id":"ref-for-network_reporting_endpoints-weight\u2460"}],"title":"3.2. \n    Process origin policy configuration\n  "}],"url":"#network_reporting_endpoints-weight"},
"reporting-cache": {"dfnID":"reporting-cache","dfnText":"reporting cache","external":false,"refSections":[{"refs":[{"id":"ref-for-reporting-cache"}],"title":"3.1.3. The max_age member"},{"refs":[{"id":"ref-for-reporting-cache\u2460"},{"id":"ref-for-reporting-cache\u2461"},{"id":"ref-for-reporting-cache\u2462"},{"id":"ref-for-reporting-cache\u2463"}],"title":"3.2. \n    Process origin policy configuration\n  "},{"refs":[{"id":"ref-for-reporting-cache\u2464"}],"title":"4. Report Generation"},{"refs":[{"id":"ref-for-reporting-cache\u2465"}],"title":"5. Report Delivery"},{"refs":[{"id":"ref-for-reporting-cache\u2466"},{"id":"ref-for-reporting-cache\u2467"},{"id":"ref-for-reporting-cache\u2468"},{"id":"ref-for-reporting-cache\u2460\u24ea"},{"id":"ref-for-reporting-cache\u2460\u2460"}],"title":"5.2. \n    Send reports\n  "},{"refs":[{"id":"ref-for-reporting-cache\u2460\u2461"},{"id":"ref-for-reporting-cache\u2460\u2462"}],"title":"9.5. Clearing the reporting cache"}],"url":"#reporting-cache"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#client": {"displayText":"client","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"client","type":"dfn","url":"#client"},
"#dom-client-endpoint-groups": {"displayText":"endpoint-groups","export":true,"for_":["client"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"endpoint-groups","type":"attribute","url":"#dom-client-endpoint-groups"},
"#dom-client-origin": {"displayText":"origin","export":true,"for_":["client"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"origin","type":"attribute","url":"#dom-client-origin"},
"#dom-endpoint-group-creation": {"displayText":"creation","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"creation","type":"attribute","url":"#dom-endpoint-group-creation"},
"#dom-endpoint-group-endpoints": {"displayText":"endpoints","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"endpoints","type":"attribute","url":"#dom-endpoint-group-endpoints"},
"#dom-endpoint-group-name": {"displayText":"name","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"name","type":"attribute","url":"#dom-endpoint-group-name"},
"#dom-endpoint-group-subdomains": {"displayText":"subdomains","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"subdomains","type":"attribute","url":"#dom-endpoint-group-subdomains"},
"#dom-endpoint-group-ttl": {"displayText":"ttl","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"ttl","type":"attribute","url":"#dom-endpoint-group-ttl"},
"#dom-network-reporting-endpoint-priority": {"displayText":"priority","export":true,"for_":["network reporting endpoint"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"priority","type":"attribute","url":"#dom-network-reporting-endpoint-priority"},
"#dom-network-reporting-endpoint-retry_after": {"displayText":"retry_after","export":true,"for_":["network reporting endpoint"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"retry_after","type":"attribute","url":"#dom-network-reporting-endpoint-retry_after"},
"#dom-network-reporting-endpoint-weight": {"displayText":"weight","export":true,"for_":["network reporting endpoint"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"weight","type":"attribute","url":"#dom-network-reporting-endpoint-weight"},
"#endpoint-group": {"displayText":"endpoint group","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"endpoint group","type":"dfn","url":"#endpoint-group"},
"#endpoint-group-expired": {"displayText":"expired","export":true,"for_":["endpoint group"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"expired","type":"dfn","url":"#endpoint-group-expired"},
"#failover-class": {"displayText":"failover class","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"failover class","type":"dfn","url":"#failover-class"},
"#network-reporting-endpoint": {"displayText":"network reporting endpoint","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"network reporting endpoint","type":"dfn","url":"#network-reporting-endpoint"},
"#network-reporting-endpoint-pending": {"displayText":"pending","export":true,"for_":["network reporting endpoint"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"pending","type":"dfn","url":"#network-reporting-endpoint-pending"},
"#network_reporting_endpoints": {"displayText":"network_reporting_endpoints","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"network_reporting_endpoints","type":"dfn","url":"#network_reporting_endpoints"},
"#network_reporting_endpoints-endpoints": {"displayText":"endpoints","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"endpoints","type":"dfn","url":"#network_reporting_endpoints-endpoints"},
"#network_reporting_endpoints-group": {"displayText":"group","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"group","type":"dfn","url":"#network_reporting_endpoints-group"},
"#network_reporting_endpoints-include_subdomains": {"displayText":"include_subdomains","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"include_subdomains","type":"dfn","url":"#network_reporting_endpoints-include_subdomains"},
"#network_reporting_endpoints-max_age": {"displayText":"max_age","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"max_age","type":"dfn","url":"#network_reporting_endpoints-max_age"},
"#network_reporting_endpoints-priority": {"displayText":"priority","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"priority","type":"dfn","url":"#network_reporting_endpoints-priority"},
"#network_reporting_endpoints-url": {"displayText":"url","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"url","type":"dfn","url":"#network_reporting_endpoints-url"},
"#network_reporting_endpoints-weight": {"displayText":"weight","export":true,"for_":["network_reporting_endpoints"],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"weight","type":"dfn","url":"#network_reporting_endpoints-weight"},
"#reporting-cache": {"displayText":"reporting cache","export":true,"for_":[],"level":"1","normative":true,"shortname":"network-reporting","spec":"network-reporting-1","status":"local","text":"reporting cache","type":"dfn","url":"#reporting-cache"},
"https://dom.spec.whatwg.org/#concept-document": {"displayText":"document","export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"document","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document"},
"https://fetch.spec.whatwg.org/#concept-response-url": {"displayText":"url","export":true,"for_":["response"],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"url","type":"attribute","url":"https://fetch.spec.whatwg.org/#concept-response-url"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host": {"displayText":"host","export":true,"for_":["origin"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"host","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple": {"displayText":"tuple origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"tuple origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple"},
"https://html.spec.whatwg.org/multipage/browsers.html#origin": {"displayText":"origin","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"displayText":"environment settings object","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://infra.spec.whatwg.org/#ordered-map": {"displayText":"map","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://tools.ietf.org/html/rfc2782#": {"displayText":"SRV record","export":true,"for_":["SRV"],"level":"","normative":true,"shortname":"rfc2782","spec":"rfc2782","status":"anchor-block","text":"srv record","type":"dfn","url":"https://tools.ietf.org/html/rfc2782#"},
"https://tools.ietf.org/html/rfc2782#page-4": {"displayText":"target selection algorithm","export":true,"for_":["SRV"],"level":"","normative":true,"shortname":"rfc2782","spec":"rfc2782","status":"anchor-block","text":"target selection algorithm","type":"dfn","url":"https://tools.ietf.org/html/rfc2782#page-4"},
"https://tools.ietf.org/html/rfc6797#section-8.2": {"displayText":"superdomain match","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6797","spec":"rfc6797","status":"anchor-block","text":"superdomain match","type":"dfn","url":"https://tools.ietf.org/html/rfc6797#section-8.2"},
"https://url.spec.whatwg.org/#absolute-url-string": {"displayText":"absolute-URL string","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"absolute-url string","type":"dfn","url":"https://url.spec.whatwg.org/#absolute-url-string"},
"https://url.spec.whatwg.org/#concept-base-url": {"displayText":"base URL","export":false,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"base url","type":"dfn","url":"https://url.spec.whatwg.org/#concept-base-url"},
"https://url.spec.whatwg.org/#concept-domain": {"displayText":"domain","export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"domain","type":"dfn","url":"https://url.spec.whatwg.org/#concept-domain"},
"https://url.spec.whatwg.org/#concept-url-parser": {"displayText":"URL parser","export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"url parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-parser"},
"https://url.spec.whatwg.org/#path-absolute-url-string": {"displayText":"path-absolute-URL string","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"path-absolute-url string","type":"dfn","url":"https://url.spec.whatwg.org/#path-absolute-url-string"},
"https://w3c.github.io/reporting/#dom-endpoint-failures": {"displayText":"failures","export":true,"for_":["endpoint"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"failures","type":"attribute","url":"https://w3c.github.io/reporting/#dom-endpoint-failures"},
"https://w3c.github.io/reporting/#dom-endpoint-name": {"displayText":"name","export":true,"for_":["endpoint"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"name","type":"attribute","url":"https://w3c.github.io/reporting/#dom-endpoint-name"},
"https://w3c.github.io/reporting/#dom-endpoint-url": {"displayText":"url","export":true,"for_":["endpoint"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"url","type":"attribute","url":"https://w3c.github.io/reporting/#dom-endpoint-url"},
"https://w3c.github.io/reporting/#endpoint": {"displayText":"endpoint","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"endpoint","type":"dfn","url":"https://w3c.github.io/reporting/#endpoint"},
"https://w3c.github.io/reporting/#report": {"displayText":"report","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"report","type":"dfn","url":"https://w3c.github.io/reporting/#report"},
"https://w3c.github.io/reporting/#report-attempts": {"displayText":"attempts","export":true,"for_":["report"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"attempts","type":"dfn","url":"https://w3c.github.io/reporting/#report-attempts"},
"https://w3c.github.io/reporting/#report-body": {"displayText":"body","export":true,"for_":["report"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"body","type":"dfn","url":"https://w3c.github.io/reporting/#report-body"},
"https://w3c.github.io/reporting/#report-destination": {"displayText":"destination","export":true,"for_":["report"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"destination","type":"dfn","url":"https://w3c.github.io/reporting/#report-destination"},
"https://w3c.github.io/reporting/#report-url": {"displayText":"url","export":true,"for_":["report"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"url","type":"dfn","url":"https://w3c.github.io/reporting/#report-url"},
"https://w3c.github.io/reporting/#windoworworkerglobalscope-reports": {"displayText":"reports","export":true,"for_":["WindowOrWorkerGlobalScope"],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"reports","type":"dfn","url":"https://w3c.github.io/reporting/#windoworworkerglobalscope-reports"},
"https://w3c.github.io/webappsec-csp/#directives-reporting": {"displayText":"reports directive","export":true,"for_":[],"level":"","normative":true,"shortname":"csp","spec":"csp","status":"anchor-block","text":"reports directive","type":"dfn","url":"https://w3c.github.io/webappsec-csp/#directives-reporting"},
"https://w3c.github.io/webappsec-secure-contexts/#is-origin-trustworthy": {"displayText":"potentially trustworthy","export":true,"for_":[],"level":"","normative":true,"shortname":"secure-contexts","spec":"secure-contexts","status":"anchor-block","text":"potentially trustworthy","type":"dfn","url":"https://w3c.github.io/webappsec-secure-contexts/#is-origin-trustworthy"},
"https://wicg.github.io/origin-policy/#origin-policy-manifest": {"displayText":"origin policy manifest","export":true,"for_":[],"level":"","normative":true,"shortname":"origin-policy","spec":"origin-policy","status":"anchor-block","text":"origin policy manifest","type":"dfn","url":"https://wicg.github.io/origin-policy/#origin-policy-manifest"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>