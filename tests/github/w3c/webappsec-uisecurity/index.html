<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>User Interface Security and the Visibility API</title>
  <meta content="WD" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-WD" rel="stylesheet">
  <link href="https://w3c.github.io/webappsec-uisecurity/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">User Interface Security and the Visibility API</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#WD">W3C Working Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://www.w3.org/TR/1970/WD-UI Security-1-19700101/">https://www.w3.org/TR/1970/WD-UI Security-1-19700101/</a>
      <dt>Editor's Draft:
      <dd><a href="https://w3c.github.io/webappsec-uisecurity/">https://w3c.github.io/webappsec-uisecurity/</a>
      <dt>History:
      <dd><a class="u-url" href="https://www.w3.org/standards/history/UI Security-1/">https://www.w3.org/standards/history/UI Security-1/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webappsec@w3.org?subject=%5BUI Security%5D%20YOUR%20TOPIC%20HERE">public-webappsec@w3.org</a> with subject line “<kbd>[UI Security] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webappsec/" rel="discussion">archives</a>)</span>
      <dt class="editor">Editor:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:hillbrad@fb.com">Brad Hill</a> (<span class="p-org org">Facebook</span>)
      <dt>Author:
      <dd>Dan Kaminsky, White Ops
      <dd>David Lin-Shung Huang, Carnegie Mellon University
      <dd>Giorgio Maone, Invited Expert
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>UI Security and the Visibility API defines both a
declarative and imperative means for resources
displayed in an embedded context to protect
themselves against having their content obscured,
moved, or otherwise displayed in a misleading
manner.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> <em>This section describes the status of this document at the time of
  its publication. A list of
  current W3C publications and the latest revision of this technical report
  can be found in the <a href="https://www.w3.org/TR/">W3C technical reports
  index at https://www.w3.org/TR/.</a></em> </p>
   <p> This document was published by the <a href="https://www.w3.org/groups/wg/webappsec">Web Application Security Working Group</a> as a Working Draft using the <a href="https://www.w3.org/policies/process/20231103/#recs-and-notes">Recommendation
      track</a>. This document is intended to become a W3C Recommendation. </p>
   <p> The (<a href="https://lists.w3.org/Archives/Public/public-webappsec/">archived</a>) public mailing list <a href="mailto:public-webappsec@w3.org?Subject=%5BUI Security%5D%20PUT%20SUBJECT%20HERE">public-webappsec@w3.org</a> (see <a href="https://www.w3.org/Mail/Request">instructions</a>)
	is preferred for discussion of this specification.
	When sending e-mail,
	please put the text “UI Security” in the subject,
	preferably like this:
	“[UI Security] <em>…summary of comment…</em>” </p>
   <p> Publication as a Working Draft does not imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. This is a draft document and may be updated, replaced or
  obsoleted by other documents at any time. It is inappropriate to cite this
  document as other than work in progress. </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webappsec">Web Application Security Working Group</a>. </p>
   <p> This document was produced by a group operating under
	the <a href="https://www.w3.org/policies/patent-policy/">W3C Patent Policy</a>.
	W3C maintains a <a href="https://www.w3.org/groups/wg/webappsec/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
	that page also includes instructions for disclosing a patent.
	An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/#sec-Disclosure">section 6 of the W3C Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#special-conformance"><span class="secno">2</span> <span class="content">Special Conformance Notes</span></a>
    <li>
     <a href="#visibility-observer-api"><span class="secno">3</span> <span class="content">VisibilityObserver API</span></a>
     <ol class="toc">
      <li><a href="#visibility-observer-callback"><span class="secno">3.1</span> <span class="content">The VisibilityObserverCallback</span></a>
      <li><a href="#visibility-observer-entry"><span class="secno">3.2</span> <span class="content">The VisibilityObserverEntry interface</span></a>
      <li><a href="#visibility-observer-interface"><span class="secno">3.3</span> <span class="content">The VisibilityObserver Interface</span></a>
      <li><a href="#visibility-observer-init"><span class="secno">3.4</span> <span class="content">The VisibilityObserverInit dictionary</span></a>
     </ol>
    <li>
     <a href="#csp-interface"><span class="secno">4</span> <span class="content">Content Security Policy Interface</span></a>
     <ol class="toc">
      <li>
       <a href="#input-protection-interface"><span class="secno">4.1</span> <span class="content">The <span>input-protection Directive</span></span></a>
       <ol class="toc">
        <li><a href="#directive-value"><span class="secno">4.1.1</span> <span class="content">Directive Value</span></a>
       </ol>
     </ol>
    <li>
     <a href="#processing-model"><span class="secno">5</span> <span class="content">Processing Model</span></a>
     <ol class="toc">
      <li>
       <a href="#defines"><span class="secno">5.1</span> <span class="content">Internal Slot Definitions</span></a>
       <ol class="toc">
        <li><a href="#browsing-context-slots"><span class="secno">5.1.1</span> <span class="content">Browsing Contexts</span></a>
        <li><a href="#element-private-slots"><span class="secno">5.1.2</span> <span class="content">Element</span></a>
        <li><a href="#document-private-slots"><span class="secno">5.1.3</span> <span class="content">Document</span></a>
        <li><a href="#visibility-observer-private-slots"><span class="secno">5.1.4</span> <span class="content">VisibilityObserver</span></a>
       </ol>
      <li>
       <a href="#algorithms"><span class="secno">5.2</span> <span class="content">Algorithms</span></a>
       <ol class="toc">
        <li><a href="#queue-visibility-observer-task-algo"><span class="secno">5.2.1</span> <span class="content">Queue a VisibilityObserver Task</span></a>
        <li><a href="#notify-visibility-observers-algo"><span class="secno">5.2.2</span> <span class="content">Notify VisibilityObservers</span></a>
        <li><a href="#queue-visibility-observer-entry-algo"><span class="secno">5.2.3</span> <span class="content">Queue a VisibilityObserverEntry</span></a>
        <li><a href="#promote-observed-graphicslayers-algo"><span class="secno">5.2.4</span> <span class="content">Promote Observed GraphicsLayers</span></a>
        <li><a href="#enforce-an-input-protection-directive-algo"><span class="secno">5.2.5</span> <span class="content">Enforce An input-protection Directive</span></a>
        <li><a href="#handle-a-violation-algo"><span class="secno">5.2.6</span> <span class="content">Handle a Violation</span></a>
       </ol>
      <li>
       <a href="#external-spec-integrations"><span class="secno">5.3</span> <span class="content">External Spec Integrations</span></a>
       <ol class="toc">
        <li><a href="#event-loop"><span class="secno">5.3.1</span> <span class="content">HTML Processing Model: Event Loop</span></a>
        <li><a href="#dispatching-events-algo"><span class="secno">5.3.2</span> <span class="content">DOM: Dispatching Events</span></a>
        <li><a href="#usafe-attribute"><span class="secno">5.3.3</span> <span class="content">isUnsafe Attribute</span></a>
       </ol>
     </ol>
    <li><a href="#privacy-considerations"><span class="secno">6</span> <span class="content">Privacy Considerations</span></a>
    <li><a href="#security-considerations"><span class="secno">7</span> <span class="content">Security Considerations</span></a>
    <li><a href="#accessibility-considerations"><span class="secno">8</span> <span class="content">Accessibility Considerations</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section>
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is not normative.</em></p>
    <p>Composite or "mash-up" web applications built using iframes
		are ubiquitous because they allow users to interact seamlessly and
		simultaneously with content from multiple origins while
		maintaining isolation boundaries that are essential to
		security and privacy for both users and applications.</p>
    <p>However, those boundaries are not absolute.  In particular,
		the visual and temporal integrity of embedded content is
		not protected from manipulation by the embedding resource.
		An embedding resource might constrain the viewport,
		draw over, transform, reposition, or resize the user’s
		view of a third-party resource.</p>
    <p>Collectively known as User Interface Redressing, the goal
		of such manipulations might be to entice the user to interact
		with embedded content without knowing its context, (e.g. to 
		send a payment or share content) commonly known as "clickjacking",
		or to convince paid content that it is being shown to the user
		when it is actually obscured, commonly known in the advertising
		business as "display fraud".</p>
    <p>Existing anti-clickjacking measures such as frame-busting
    scripts and headers granting origin-based embedding permissions have 
		shortcomings which prevent their application to important use-cases.
    Frame-busting scripts, for example, rely on browser behavior that has not been 
		engineered to provide a security guarantee and as a consequence,
		such scripts may be unreliable if loaded inside a sandbox
    or otherwise disabled. The X-Frame-Options header and the frame-ancestors
		Content Security Policy directive offer an all-or-none approach to
		display of embedded content that is not appropriate for content
		which may be embedded in arbitrary locations, or known locations
		which might still be adversarial.</p>
    <p>This document defines mechanisms to allow resources to
		request to be displayed free of interference by their embedding context and
		learn if the user agent was able to satisfy such a request, with 
		sufficient granularity to make decisions that can protect both users
		and content purveyors from various types of fraud.</p>
    <p>First, this document defines an imperative API, VisibilityObserver,
		by which a resource can request that a conforming user agent guarantee
		unmodified display of its viewport, and report events on the success or
		failure of meeting such guarantees.  This API should be suitable
		for e.g. paid content such as advertising to receive trustworthy
		signals about its viewability from a conforming user agent.</p>
    <p>Secondly, this specification defines a declarative mechanism
		(via a Content Security Poicy directive) to request visibility
		protection and receive notification, via event properties or
		out-of-band reporting, if certain events are delivered to
		a resource while it does not meet its requested visibility 
		contract.</p>
    <p>The declarative CSP interface does not offer the same fine-granularity control as
		the JavaScript API.  Its goal is to allow protection to be
		retrofitted to legacy applications, with no or minimal code changes, as a replacement for
		X-Frame-Options, or potentially for use with content that is sandboxed and cannot
		execute JavaScript.</p>
    <p class="issue" id="issue-b24dcbe0"><a class="self-link" href="#issue-b24dcbe0"></a> Do we need to deal with form submission / navigations that aren’t JS-event-based?</p>
    <p class="issue" id="issue-b233e40b"><a class="self-link" href="#issue-b233e40b"></a> how to interact with frame-ancestors and XFO?</p>
    <p>A notable non-goal is pixel-accurate information about what was
		actually displayed beyond its bounding rectangle, as this information
		can be quite difficult to obtain in an efficient manner, and is extremely
		difficult to accomplish without exposing timing side channels which leak
		information across the Same Origin Policy security boundary.</p>
    <div class="note" role="note">
      NOTE:
		Similar to, and modeled on the <a href="http://rawgit.com/slightlyoff/IntersectionObserver/master/index.html"> Intersection Observer</a> draft, this specification shares a goal of allowing reliable and low-cost
		calculation of element visibility for, e.g purposes of <a href="http://www.iab.net/iablog/2014/03/viewability-has-arrived-what-you-need-to-know-to-see-through-this-sea-change.html"> reporting ad visibility for monetizing impressions</a>.  The current specification
		adds the goals of preventing clickjacking and other UI redressing attacks both by enforcing that
		an iframe which has requested visibility be free of any transforms, movement or re-clipping
		within a defined time threshold, and by allowing event delivery to be intercepted or
		annotated when policies are not met. 
     <p>Distinct from the <em>Intersection Observer</em> proposal, this specification operates internally on entire
		documents, on a per-iframe basis (although it provides some syntatic sugar for the declarative,
		event-driven API) rather than observing individual elements, and it affirmatively modifies the final 
		composited result in the global viewport by promoting the graphics layer of an iframe that has requested visibility.</p>
    </div>
   </section>
   <section>
    <h2 class="heading settled" data-level="2" id="special-conformance"><span class="secno">2. </span><span class="content">Special Conformance Notes</span><a class="self-link" href="#special-conformance"></a></h2>
    <p><em>This section is not normative.</em></p>
    <p>UI Redressing attacks rely on fooling the subjective perceptions of
    human actors to induce them to interact with a web application out of
    its intended context.  Because of this, the specific mechanisms which
    may be used in attack and defense may vary greatly with the details of
    a user agent implementation.  For example, attacks which rely on
    redressing the cursor may not apply in a touch environment, or entire
    classes of attack may be impossible on a text-only browser or screen
    reader.</p>
    <p>Similarly, the implementation of the policies specified herein is highly
    dependent on internal architecture and implementation strategies of
    the user agent; such strategies may vary greatly between user agents
    or even across versions or platforms for a single user agent.</p>
    <p>This specification provides a normative means by which a resource
    owner can communicate to a user agent its desire for additional
    protective measures, actions to take if violations are detected,
    and tuning hints which may be useful for certain means of
    implementation.  A user agent is conformant if it understands
		these directives and makes a best effort to provide the desired 
		security properties, which might require no additional implementation
		steps, e.g. in the case of a screen reader that does not support
		embedded resources in a manner that is subject to any of the
		attack classes of concern.</p>
    <p>While the indeterminacy of the user agent implementation protects
    applications from needing to constantly update their policies as
    user agents make internal changes, application authors should
    understand that even a conformant user agent cannot make
    perfect security guarantees against UI Redressing.</p>
    <p>These directives should be used as part of a comprehensive risk
    mitigation strategy with an appropriate understanding of their
    limitations.</p>
   </section>
   <section>
    <h2 class="heading settled" data-level="3" id="visibility-observer-api"><span class="secno">3. </span><span class="content">VisibilityObserver API</span><a class="self-link" href="#visibility-observer-api"></a></h2>
    <p>The VisibilityObserver API provides an imperative API for developers to
	receive notification of visibility state changes for their document relative to
	the global viewport.</p>
    <h3 class="heading settled" data-level="3.1" id="visibility-observer-callback"><span class="secno">3.1. </span><span class="content">The VisibilityObserverCallback</span><a class="self-link" href="#visibility-observer-callback"></a></h3>
<pre class="idl highlight def"><c- b>callback</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="callback" data-export id="callbackdef-visibilityobservercallback"><code><c- g>VisibilityObserverCallback</c-></code></dfn> = <a data-link-type="idl-name"><c- n>void</c-></a>(<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#visibilityobserverentry" id="ref-for-visibilityobserverentry"><c- n>VisibilityObserverEntry</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverCallback" data-dfn-type="argument" data-export id="dom-visibilityobservercallback-entries"><code><c- g>entries</c-></code></dfn>, <a data-link-type="idl-name" href="#visibilityobserver" id="ref-for-visibilityobserver"><c- n>VisibilityObserver</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverCallback" data-dfn-type="argument" data-export id="dom-visibilityobservercallback-observer"><code><c- g>observer</c-></code></dfn>);
</pre>
    <p>This callback will be invoked when there are changes to the document’s <em>visibility state</em>.</p>
    <h3 class="heading settled" data-level="3.2" id="visibility-observer-entry"><span class="secno">3.2. </span><span class="content">The VisibilityObserverEntry interface</span><a class="self-link" href="#visibility-observer-entry"></a></h3>
<pre class="idl highlight def">[<c- g>Constructor</c->(<a data-link-type="idl-name" href="#callbackdef-visibilityobservercallback" id="ref-for-callbackdef-visibilityobservercallback"><c- n>VisibilityObserverCallback</c-></a> <c- g>callback</c->, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-visibilityobserverentryinit" id="ref-for-dictdef-visibilityobserverentryinit"><c- n>VisibilityObserverEntryInit</c-></a> <c- g>visibilityObserverEntryInit</c->), <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="visibilityobserverentry"><code><c- g>VisibilityObserverEntry</c-></code></dfn> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#domrectreadonly" id="ref-for-domrectreadonly"><c- n>DOMRectReadOnly</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMRectReadOnly" href="#dom-visibilityobserverentry-globalvisiblebounds" id="ref-for-dom-visibilityobserverentry-globalvisiblebounds"><c- g>globalVisibleBounds</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#domrectreadonly" id="ref-for-domrectreadonly①"><c- n>DOMRectReadOnly</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMRectReadOnly" href="#dom-visibilityobserverentry-visiblebounds" id="ref-for-dom-visibilityobserverentry-visiblebounds"><c- g>visibleBounds</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="http://www.w3.org/TR/hr-time/#domhighrestimestamp" id="ref-for-domhighrestimestamp"><c- n>DOMHighResTimeStamp</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMHighResTimeStamp" href="#dom-visibilityobserverentry-time" id="ref-for-dom-visibilityobserverentry-time"><c- g>time</c-></a>;
 };

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-visibilityobserverentryinit"><code><c- g>VisibilityObserverEntryInit</c-></code></dfn> {
  <c- b>required</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#dictdef-domrectinit" id="ref-for-dictdef-domrectinit"><c- n>DOMRectInit</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntryInit" data-dfn-type="dict-member" data-export data-type="DOMRectInit" id="dom-visibilityobserverentryinit-globalvisiblebounds"><code><c- g>globalVisibleBounds</c-></code></dfn>;
  <c- b>required</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#dictdef-domrectinit" id="ref-for-dictdef-domrectinit①"><c- n>DOMRectInit</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntryInit" data-dfn-type="dict-member" data-export data-type="DOMRectInit" id="dom-visibilityobserverentryinit-visiblebounds"><code><c- g>visibleBounds</c-></code></dfn>;
  <c- b>required</c-> <a data-link-type="idl-name" href="http://www.w3.org/TR/hr-time/#domhighrestimestamp" id="ref-for-domhighrestimestamp①"><c- n>DOMHighResTimeStamp</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntryInit" data-dfn-type="dict-member" data-export data-type="DOMHighResTimeStamp" id="dom-visibilityobserverentryinit-time"><code><c- g>time</c-></code></dfn>;
};
</pre>
    <div>
      <dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntry" data-dfn-type="attribute" data-export id="dom-visibilityobserverentry-globalvisiblebounds"><code>globalVisibleBounds</code></dfn> The <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/geometry-1/#domrect" id="ref-for-domrect">DOMRect</a></code> coresponding to the visible dimensions of the 
				top-level document in the global viewport’s coordinate space. 
     <p><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntry" data-dfn-type="attribute" data-export id="dom-visibilityobserverentry-visiblebounds"><code>visibleBounds</code></dfn> The <code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/geometry-1/#domrect" id="ref-for-domrect①">DOMRect</a></code> corresponding to the document’s <i>boundingClientRect</i>,
				intersected by each of the document’s ancestor’s clipping rects,
				intersected with <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserverentry-globalvisiblebounds" id="ref-for-dom-visibilityobserverentry-globalvisiblebounds①">globalVisibleBounds</a></code>.
				This value represents the portion of the document actually visible within <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserverentry-globalvisiblebounds" id="ref-for-dom-visibilityobserverentry-globalvisiblebounds②">globalVisibleBounds</a></code>.</p>
     <p><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverEntry" data-dfn-type="attribute" data-export id="dom-visibilityobserverentry-time"><code>time</code></dfn> A <code class="idl"><a data-link-type="idl" href="http://www.w3.org/TR/hr-time/#domhighrestimestamp" id="ref-for-domhighrestimestamp②">DOMHighResTimeStamp</a></code> that corresponds to the time the visibility
				state was recorded.</p>
    </div>
    <h3 class="heading settled" data-level="3.3" id="visibility-observer-interface"><span class="secno">3.3. </span><span class="content">The VisibilityObserver Interface</span><a class="self-link" href="#visibility-observer-interface"></a></h3>
     The VisibilityObserver interface can be used to observe changes in the
		document’s visibility state relative to the global viewport. 
<pre class="idl highlight def">[<c- g>Constructor</c->(<a data-link-type="idl-name" href="#callbackdef-visibilityobservercallback" id="ref-for-callbackdef-visibilityobservercallback①"><c- n>VisibilityObserverCallback</c-></a> <c- g>callback</c->), <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed①"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="visibilityobserver"><code><c- g>VisibilityObserver</c-></code></dfn> {
  <a data-link-type="idl-name"><c- n>void</c-></a> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-observe" id="ref-for-dom-visibilityobserver-observe"><c- g>observe</c-></a> ();
  <a data-link-type="idl-name"><c- n>void</c-></a> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-unobserve" id="ref-for-dom-visibilityobserver-unobserve"><c- g>unobserve</c-></a> ();
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence①"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#visibilityobserverentry" id="ref-for-visibilityobserverentry①"><c- n>VisibilityObserverEntry</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-takerecords" id="ref-for-dom-visibilityobserver-takerecords"><c- g>takeRecords</c-></a> ();
};
</pre>
    <div>
     <dl>
      <dt data-md>
       <p><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="constructor" data-export data-lt="VisibilityObserver(callback, options)" id="dom-visibilityobserver-visibilityobserver"><code>new VisibilityObserver(callback, options)</code></dfn></p>
       <dl>
        <dd data-md>
       </dl>
     </dl>
     <ol>
      <li>Let <var>this</var> be a new <code class="idl"><a data-link-type="idl" href="#visibilityobserver" id="ref-for-visibilityobserver①">VisibilityObserver</a></code> object
      <li>Set <var>this</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-callback-slot" id="ref-for-dom-visibilityobserver-callback-slot">[[callback]]</a></code> slot to <var>callback</var>.
     </ol>
     <dl>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="method" data-export id="dom-visibilityobserver-observe"><code>observe()</code></dfn>
      <dd data-md>
       <ol>
        <li>Add <var>this</var> to the document’s <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot">[[RegisteredVisibilityObservers]]</a></code> list
       </ol>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="method" data-export id="dom-visibilityobserver-unobserve"><code>unobserve()</code></dfn>
      <dd data-md>
       <ol>
        <li>Remove <var>this</var> from the document’s <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot①">[[RegisteredVisibilityObservers]]</a></code> set.
       </ol>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="method" data-export id="dom-visibilityobserver-takerecords"><code>takeRecords()</code></dfn>
      <dd data-md>
       <ol>
        <li>Let <var>queue</var> be a copy of <var>this</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot">[[QueuedEntries]]</a></code> slot.
        <li>Clear <var>this</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot①">[[QueuedEntries]]</a></code> slot.
        <li>Return <var>queue</var>.
       </ol>
     </dl>
    </div>
    <h3 class="heading settled" data-level="3.4" id="visibility-observer-init"><span class="secno">3.4. </span><span class="content">The VisibilityObserverInit dictionary</span><a class="self-link" href="#visibility-observer-init"></a></h3>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-visibilityobserverinit"><code><c- g>VisibilityObserverInit</c-></code></dfn> {
  (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-double" id="ref-for-idl-double"><c- b>double</c-></a> <c- b>or</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence②"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-double" id="ref-for-idl-double①"><c- b>double</c-></a>>) <a class="idl-code" data-default="0" data-link-type="dict-member" data-type="(double or sequence<double>)" href="#dom-visibilityobserverinit-areathreshold" id="ref-for-dom-visibilityobserverinit-areathreshold"><c- g>areaThreshold</c-></a> = 0;
 (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a>) <a class="idl-code" data-default="false" data-link-type="dict-member" data-type="(boolean)" href="#dom-visibilityobserverinit-displacementaware" id="ref-for-dom-visibilityobserverinit-displacementaware"><c- g>displacementAware</c-></a> = <c- b>false</c->;
 (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a>) <a class="idl-code" data-default="&quot;0px&quot;" data-link-type="dict-member" data-type="(DOMString)" href="#dom-visibilityobserverinit-visiblemargin" id="ref-for-dom-visibilityobserverinit-visiblemargin"><c- g>visibleMargin</c-></a> = "0px";
 (<a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#element" id="ref-for-element"><c- n>Element</c-></a>)? <a class="idl-code" data-link-type="dict-member" data-type="(Element)?" href="#dom-visibilityobserverinit-observedelement" id="ref-for-dom-visibilityobserverinit-observedelement"><c- g>observedElement</c-></a>;
};
</pre>
    <div>
     <dl>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverInit" data-dfn-type="dict-member" data-export id="dom-visibilityobserverinit-areathreshold"><code>areaThreshold</code></dfn>, <span> of type <code class="idl-code">(double or sequence&lt;double>)</code>, defaulting to <code>0</code></span>
      <dd data-md>
       <p>List of threshold(s) at which to trigger callback.
callback will be invoked when visibleBounds area changes from
greater than or equal to any threshold to less than that threshold,
and vice versa.</p>
       <p>Threshold values must be in the range of [0, 1.0] and represent a
percentage of the area as specified by <em>target</em>.<code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect" id="ref-for-dom-element-getboundingclientrect">getBoundingClientRect()</a></code>.</p>
       <p class="note" role="note"><span class="marker">Note:</span> 0.0 is effectively "any non-zero number of pixels".</p>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverInit" data-dfn-type="dict-member" data-export id="dom-visibilityobserverinit-displacementaware"><code>displacementAware</code></dfn>, <span> of type <code class="idl-code">(boolean)</code>, defaulting to <code>false</code></span>
      <dd data-md>
       <p>If <em>true</em>, this observer should trigger the callback
when the position of the <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-observedelement-slot" id="ref-for-dom-visibilityobserver-observedelement-slot">[[observedElement]]</a></code> changes relative to the
global viewport.</p>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverInit" data-dfn-type="dict-member" data-export id="dom-visibilityobserverinit-visiblemargin"><code>visibleMargin</code></dfn>, <span> of type <code class="idl-code">(DOMString)</code>, defaulting to <code>"0px"</code></span>
      <dd data-md>
       <p>Same as <a class="property css" data-link-type="property" href="https://www.w3.org/TR/css-box-4/#propdef-margin" id="ref-for-propdef-margin">margin</a>, extends the required visibility rectangle
	behind the <a data-link-type="dfn" href="#protected-element" id="ref-for-protected-element">protected-element</a>.<code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect" id="ref-for-dom-element-getboundingclientrect①">getBoundingClientRect()</a></code>.
	Can be 1, 2, 3 or 4 components, possibly negative lengths.</p>
       <p>If there is only one component value, it applies to all sides.
	If there are two values, the top and bottom margins are set to
	the first value and the right and left margins are set to the
	second. If there are three values, the top is set to the first
	value, the left and right are set to the second, and the bottom
	is set to the third. If there are four values, they apply to the
	top, right, bottom, and left, respectively.e.g.</p>
<pre class="example" id="example-105651ff"><a class="self-link" href="#example-105651ff"></a><code class="js">
  "5px"                // all margins set to 5px
  "5px 10px"           // top &amp; bottom = 5px, right &amp; left = 10px
  "-10px 5px 8px"      // top = -10px, right &amp; left = 5px, bottom = 8px
  "-10px -5px 5px 8px" // top = -10px, right = -5px, bottom = 5px, left = 8px
</code></pre>
      <dt data-md><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserverInit" data-dfn-type="dict-member" data-export id="dom-visibilityobserverinit-observedelement"><code>observedElement</code></dfn>, <span> of type <code class="idl-code">(Element)</code>, nullable</span>
      <dd data-md>
       <p>The <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#element" id="ref-for-element①">Element</a></code> being observed.  If unset, the internal slot will be
initialized to the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> element.</p>
     </dl>
    </div>
    <section>
     <section>
      <h2 class="heading settled" data-level="4" id="csp-interface"><span class="secno">4. </span><span class="content">Content Security Policy Interface</span><a class="self-link" href="#csp-interface"></a></h2>
      <p>This section describes the Content Security Policy
    directive introduced in this specification to provide declarative
		configuration of protection against input when an element does not meet it’s
		visibility requirements.</p>
      <p>The optional directive-value allows configuration of conditions for which violations
		will be triggered.</p>
      <h3 class="heading settled" data-level="4.1" id="input-protection-interface"><span class="secno">4.1. </span><span class="content">The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="input-protection-directive">input-protection Directive</dfn></span><a class="self-link" href="#input-protection-interface"></a></h3>
<pre>directive-name    = 'input-protection'
directive-value   = ['area-threshold=' num-val]
                    ['protected-element=' id-selector]
                    ['time-threshold=' num-val]
                    ['visible-margin=' num-val 'px' *3(',' num-val 'px')]
</pre>
      <h4 class="heading settled" data-level="4.1.1" id="directive-value"><span class="secno">4.1.1. </span><span class="content">Directive Value</span><a class="self-link" href="#directive-value"></a></h4>
      <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="area-threshold">area-threshold</dfn> A violation will be triggered if an event is delivered to the
				protected-element or one of its ancestors if the visibility of the
				protected area is below this threshold.</p>
      <p>Threshold values must be in the range [0, 1.0] and represent a
				percentage of the area as specified by <a data-link-type="dfn" href="#protected-element" id="ref-for-protected-element①">protected-element</a>.<code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect" id="ref-for-dom-element-getboundingclientrect②">getBoundingClientRect()</a></code>,
				adjusted by <a data-link-type="dfn" href="#visible-margin" id="ref-for-visible-margin">visible-margin</a>.  Unlike the imperative API,
				only a single value may be specified.</p>
      <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="protected-element">protected-element</dfn> A <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString①">DOMString</a></code> used as the argument to <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" id="ref-for-dom-nonelementparentnode-getelementbyid">getElementById()</a></code> to resolve the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#element" id="ref-for-element②">Element</a></code> to which the policy applies.</p>
      <p>If unspecified the policy is applied to the resource’s <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> node.</p>
      <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="time-threshold">time-threshold</dfn> A numeric value in the range [0, 10000] that specifies how long,
				in milliseconds, the screen area containing the protected-element
				must have unmodified viewiability properties when an event is 
				delivered to it or one of its ancestors.</p>
      <p>If not specified, it defaults to 800.  If a value outside of the
				range stated above is given, it defaults ot the nearest value
				between the lower and higher bounds.</p>
      <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="visible-margin">visible-margin</dfn> Same as <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserverinit-visiblemargin" id="ref-for-dom-visibilityobserverinit-visiblemargin①">visibleMargin</a></code>.</p>
      <p>If unspecified, it defaults to "0px".</p>
     </section>
     <section>
      <h2 class="heading settled" data-level="5" id="processing-model"><span class="secno">5. </span><span class="content">Processing Model</span><a class="self-link" href="#processing-model"></a></h2>
       This section outlines the steps the user agent must take when implementing the
	VisibilityObserver API. 
      <h3 class="heading settled" data-level="5.1" id="defines"><span class="secno">5.1. </span><span class="content">Internal Slot Definitions</span><a class="self-link" href="#defines"></a></h3>
      <h4 class="heading settled" data-level="5.1.1" id="browsing-context-slots"><span class="secno">5.1.1. </span><span class="content">Browsing Contexts</span><a class="self-link" href="#browsing-context-slots"></a></h4>
       Each <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts" id="ref-for-unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has an <dfn class="dfn-paneled" data-dfn-for="browsing context" data-dfn-type="dfn" data-noexport id="browsing-context-visibilityobservertaskqueued">VisibilityObserverTaskQueued</dfn> flag which
			is initialized to false. 
      <h4 class="heading settled" data-level="5.1.2" id="element-private-slots"><span class="secno">5.1.2. </span><span class="content">Element</span><a class="self-link" href="#element-private-slots"></a></h4>
       <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#element" id="ref-for-element③">Element</a></code> objects have an internal <dfn class="dfn-paneled idl-code" data-dfn-for="Element" data-dfn-type="attribute" data-export id="dom-element-inputprotectionobservers-slot"><code>[[InputProtectionObservers]]</code></dfn> list,
			which is initially empty. 
      <h4 class="heading settled" data-level="5.1.3" id="document-private-slots"><span class="secno">5.1.3. </span><span class="content">Document</span><a class="self-link" href="#document-private-slots"></a></h4>
       <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> objects have an internal <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export id="dom-document-registeredvisibilityobservers-slot"><code>[[RegisteredVisibilityObservers]]</code></dfn> list,
			which is initially empty, and an <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export id="dom-document-inputprotectionrequested-slot"><code>[[InputProtectionRequested]]</code></dfn> flag which is intitially <i>false</i>. 
      <h4 class="heading settled" data-level="5.1.4" id="visibility-observer-private-slots"><span class="secno">5.1.4. </span><span class="content">VisibilityObserver</span><a class="self-link" href="#visibility-observer-private-slots"></a></h4>
       <code class="idl"><a data-link-type="idl" href="#visibilityobserver" id="ref-for-visibilityobserver②">VisibilityObserver</a></code> objects have the following internal slots: 
      <ul>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-queuedentries-slot"><code>[[QueuedEntries]]</code></dfn> which is initialized to an empty list
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-previousvisibleratio-slot"><code>[[previousVisibleRatio]]</code></dfn> which is initialized to 0
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-previousglobalviewportposition-slot"><code>[[previousGlobalViewportPosition]]</code></dfn> 
      </ul>
       As well as internal slots initialized by <a data-link-type="functionish" href="#dom-visibilityobserver-visibilityobserver" id="ref-for-dom-visibilityobserver-visibilityobserver">VisibilityObserver(callback,options)</a>: 
      <ul>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-callback-slot"><code>[[callback]]</code></dfn>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-areathreshold-slot"><code>[[areaThreshold]]</code></dfn>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-displacementaware-slot"><code>[[displacementAware]]</code></dfn>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-visiblemargin-slot"><code>[[visibleMargin]]</code></dfn>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-observedelement-slot"><code>[[observedElement]]</code></dfn> which is
				initialized to the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> Element if not set in the <code class="idl"><a data-link-type="idl" href="#dictdef-visibilityobserverinit" id="ref-for-dictdef-visibilityobserverinit">VisibilityObserverInit</a></code> dictionary
      </ul>
       The following internal slots will be initialzed to <i>null</i> unless the 
		 object was constructed to represent an <a data-link-type="dfn" href="#input-protection-directive" id="ref-for-input-protection-directive">input-protection directive</a>. 
      <ul>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-timethreshold-slot"><code>[[timeThreshold]]</code></dfn>
       <li><dfn class="dfn-paneled idl-code" data-dfn-for="VisibilityObserver" data-dfn-type="attribute" data-export id="dom-visibilityobserver-associatedcontentsecuritypolicy-slot"><code>[[associatedContentSecurityPolicy]]</code></dfn>
      </ul>
      <h3 class="heading settled" data-level="5.2" id="algorithms"><span class="secno">5.2. </span><span class="content">Algorithms</span><a class="self-link" href="#algorithms"></a></h3>
      <h4 class="heading settled" data-level="5.2.1" id="queue-visibility-observer-task-algo"><span class="secno">5.2.1. </span><span class="content">Queue a VisibilityObserver Task</span><a class="self-link" href="#queue-visibility-observer-task-algo"></a></h4>
       To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="queue-a-visibility-observer-task">queue a visibility observer task</dfn> for a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts" id="ref-for-unit-of-related-similar-origin-browsing-contexts①">unit of related similar-origin browsing contexts</a> <var>unit</var>,
			run these steps: 
      <ol>
       <li>If <var>unit</var>’s <a data-link-type="dfn" href="#browsing-context-visibilityobservertaskqueued" id="ref-for-browsing-context-visibilityobservertaskqueued">VisibilityObserverTaskQueued</a> flag is set to
						true, return.
       <li>Set <var>unit</var>’s <a data-link-type="dfn" href="#browsing-context-visibilityobservertaskqueued" id="ref-for-browsing-context-visibilityobservertaskqueued①">VisibilityObserverTaskQueued</a> flag to true.
       <li>
        Post a task to <a data-link-type="dfn" href="#notify-visibility-observers" id="ref-for-notify-visibility-observers">notify visibility observers</a>, or enqueue a
						task to <a data-link-type="dfn" href="#notify-visibility-observers" id="ref-for-notify-visibility-observers①">notify visibility observers</a> in the <a data-link-type="dfn" href="http://w3c.github.io/requestidlecallback/#dfn-list-of-idle-request-callbacks" id="ref-for-dfn-list-of-idle-request-callbacks">list of idle request callbacks</a> with an appropriate <var>timeout</var>. 
        <p class="issue" id="issue-338c1e1f"><a class="self-link" href="#issue-338c1e1f"></a> Should we define an appropriate <var>timeout</var>?</p>
      </ol>
      <h4 class="heading settled" data-level="5.2.2" id="notify-visibility-observers-algo"><span class="secno">5.2.2. </span><span class="content">Notify VisibilityObservers</span><a class="self-link" href="#notify-visibility-observers-algo"></a></h4>
       To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="notify-visibility-observers">notify visibility observers</dfn> for a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts" id="ref-for-unit-of-related-similar-origin-browsing-contexts②">unit of related similar-origin browsing contexts</a> <var>unit</var>,
			run these steps: 
      <ol>
       <li>Set <var>unit</var>’s <a data-link-type="dfn" href="#browsing-context-visibilityobservertaskqueued" id="ref-for-browsing-context-visibilityobservertaskqueued②">VisibilityObserverTaskQueued</a> flag to false.
       <li>For each <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code> <var>document</var> in <var>unit</var>
       <ol>
        <li>Let <var>notify list</var> be a copy of <var>document</var>’s <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot②">[[RegisteredVisibilityObservers]]</a></code> list.
        <li>For each <code class="idl"><a data-link-type="idl" href="#visibilityobserver" id="ref-for-visibilityobserver③">VisibilityObserver</a></code> object <var>observer</var> in <var>notify list</var>, run these steps:
        <ol>
         <li>If <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot②">[[QueuedEntries]]</a></code> slot is
										empty, continue.
         <li>Let <var>queue</var> be a copy of <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot③">[[QueuedEntries]]</a></code> slot.
         <li>Clear <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot④">[[QueuedEntries]]</a></code> slot.
         <li>Invoke <var>callback</var> with <var>queue</var> as the first argument and <var>observer</var> as the second argument and <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#dfn-callback-this-value" id="ref-for-dfn-callback-this-value">callback this value</a>. If this throws an exception, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception" id="ref-for-report-the-exception">report the exception</a>.
        </ol>
       </ol>
      </ol>
      <h4 class="heading settled" data-level="5.2.3" id="queue-visibility-observer-entry-algo"><span class="secno">5.2.3. </span><span class="content">Queue a VisibilityObserverEntry</span><a class="self-link" href="#queue-visibility-observer-entry-algo"></a></h4>
       To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="queue-a-visibilityobserverentry">queue a VisibilityObserverEntry</dfn> for <var>observer</var>, given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts" id="ref-for-unit-of-related-similar-origin-browsing-contexts③">unit of related similar-origin browsing contexts</a> <var>unit</var>, VisibilityObserver <var>observer</var>, and VisibilityObserverEntry <var>entry</var> run these steps: 
      <ol>
       <li>Append <var>entry</var> to <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot⑤">[[QueuedEntries]]</a></code> slot.
       <li><a data-link-type="dfn" href="#queue-a-visibility-observer-task" id="ref-for-queue-a-visibility-observer-task">Queue a visibility observer task</a> for <var>unit</var>.
      </ol>
      <h4 class="heading settled" data-level="5.2.4" id="promote-observed-graphicslayers-algo"><span class="secno">5.2.4. </span><span class="content">Promote Observed GraphicsLayers</span><a class="self-link" href="#promote-observed-graphicslayers-algo"></a></h4>
      <p><em>This section is non-normative.</em></p>
      <div class="note" role="note">
        NOTE: The full internal details of rendering a document to the pixels 
				actually displayed to the user is not standardized. UA implementations 
				may vary widely. 
       <p>The implementation strategy detailed in this section is not normative. Any
				strategy which produces correct outcomes for the normative algorithms is 
				conformant and implementers are encouraged to optimize whenever possible.</p>
       <p>The possibility of variance among user agent implementations notwithstanding,
				the normative algorithms of this specification are designed such that a highly performant 
				implementation should be possible on the most common internal software and hardware
				architectures that are state-of-the-art for user agents and consumer computing
				platforms as of the time of writing.</p>
       <p>In particular, the approach here deliberately avoids auditing the correctness
				of the representations displayed to users.  In typical architectures, the pixel-level
				rendering of the global viewport is delgated to a a Graphics Processing Unit (GPU)
				using higher-level abstractions like surfaces, polygons, and vectors. As a consequence,
				the main execution context of the user agent does not "know" what pixels actually result
				without reading them back.  System architectures are optimized for sending data 
				to a GPU, not returning data from it, therefore, approaches which rely on pixel comparisons
				are likely to have an unacceptable performance cost.  Instead, the approach detailed 
				here relies on correctness by design, by manipulating the order in which instructions 
				are sent to the GPU such that malicious interference is not possible.</p>
      </div>
      <p>Generally, at some point in the rendering of a set of documents in nested browsing
				contexts into the fully composed graphical representation in the global viewport,
				a user agent will arrive at a set of intermediate representations we will designate 
				as <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="graphicslayer">GraphicsLayer</dfn>s, each of which represents a graphical surface to be
				painted / clipped / scrolled.</p>
      <p>A <a data-link-type="dfn" href="#graphicslayer" id="ref-for-graphicslayer">GraphicsLayer</a> representing the contents of a document in an iframe will
				be arranged in the layer stack such that at a later phase in the rendering 
				it is automatically clipped and positioned relative to the series of viewports 
				above it, and also subject to being drawn over or transformed by the layers above it.</p>
      <p>To prevent potentially malicious composition, the user agent can <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="promote-observed-graphicslayers">promote observed graphicsLayers</dfn> by manipulating them such that
				a document with <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot③">[[RegisteredVisibilityObservers]]</a></code></p>
      <ul>
       <li>Is clipped and positioned as-if-unmodified within the set of viewports of its ancestor 
							browsing contexts. A promoted document should not be able to occupy more
							screen real estate than it is given by its embedding contexts.
       <li>Responds to hit testing and events as-if-unmodified.  Implementation-specific modifications
							to internal representations of the document should not change the behavior of the DOM.
       <li>Is not subject to being drawn over or transformed by any other <a data-link-type="dfn" href="#graphicslayer" id="ref-for-graphicslayer①">GraphicsLayers</a>,
							except other promoted layers, which should be treated as fully opaque occlusions 
							when reporting the visibility state of the document.
      </ul>
      <p>To <a data-link-type="dfn" href="#promote-observed-graphicslayers" id="ref-for-promote-observed-graphicslayers">promote observed graphicsLayers</a>, given a time <var>now</var>, and an initially empty list <var>promotedLayers</var>, run these steps during the rendering
				loop at the stage where the intermediate representation of a set of <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code>s is a set of <a data-link-type="dfn" href="#graphicslayer" id="ref-for-graphicslayer②">GraphicsLayer</a>s <var>graphicsLayers</var>.</p>
      <ol>
       <li>For each <var>graphicsLayer</var> in <var>graphicsLayers</var>
       <li>For each <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑥">Document</a></code> <var>document</var> with an intermediate representation in <var>graphicsLayer</var>
       <ol>
        <li>If <var>document</var> has an empty list of <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot④">[[RegisteredVisibilityObservers]]</a></code>, continue.
        <li>If <var>document</var> has a non-empty list of <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot⑤">[[RegisteredVisibilityObservers]]</a></code>
        <ol>
         <li>If <var>document</var> is not the only <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑦">Document</a></code> represented  in <var>graphicsLayer</var>, apply
											whatever implementation-specific steps are necessary to place it in its own layer.
											(e.g. apply translatez(0) to the documentElement) Let <var>graphicsLayer</var> be that
											new layer.
        </ol>
        <li>Let <var>rectToRaise</var> be the value of <var>document</var>.<code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect" id="ref-for-dom-element-getboundingclientrect③">getBoundingClientRect()</a></code>.
        <li>Intersect <var>rectToRaise</var> with <var>document</var>’s viewport clip rect.
        <li>For every <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#parent-browsing-context" id="ref-for-parent-browsing-context">parent browsing context</a> <var>parent</var> between <var>document</var> and the top-level document,
									intersect <var>rectToRaise</var> with <var>parent</var>’s viewport clip rect,
									and finally with the global viewport clip rect.
        <li>Clip <var>graphicsLayer</var> to <var>rectToRaise</var>.  (<var>graphicsLayer</var> may have zero width and height
									if it is scrolled off screen by an ancestor browsing context)
        <li>Intersect <var>rectToRaise</var> with any items in the <var>promotedLayers</var> list.
        <li>Add <var>rectToRaise</var> to the <var>promotedLayers</var> list.
        <li>Without reordering prior intermediate representations in a manner which would 
									change event dispatching, hit testing, or the DOM as exposed to JavaScript, reorder
									the <a data-link-type="dfn" href="#graphicslayer" id="ref-for-graphicslayer③">GraphicsLayer</a>s such that <var>rectToRaise</var> is on top of the root <a data-link-type="dfn" href="#graphicslayer" id="ref-for-graphicslayer④">GraphicsLayer</a>. 
									(e.g. by making it a direct child of the root layer) but beneath any layers in <var>promotedLayers</var> that clipped it.
        <li>Let <var>protectedRect</var> be the value of <var>observer</var>’s <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-observedelement-slot" id="ref-for-dom-visibilityobserver-observedelement-slot①">[[observedElement]]</a></code>.<code class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect" id="ref-for-dom-element-getboundingclientrect④">getBoundingClientRect()</a></code>,
									adjusted by <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-visiblemargin-slot" id="ref-for-dom-visibilityobserver-visiblemargin-slot">[[visibleMargin]]</a></code>.
        <li>Let <var>visibleRatio</var> be the intersection of <var>protectedRect</var> with <var>rectToRaise</var>, divided by <var>protectedRect</var> if <var>protectedRect</var> is non-zero, and <i>0</i> otherwise.
        <li>For each of <var>document</var>’s <code class="idl"><a data-link-type="idl" href="#dom-document-registeredvisibilityobservers-slot" id="ref-for-dom-document-registeredvisibilityobservers-slot⑥">[[RegisteredVisibilityObservers]]</a></code> <var>observer</var>
        <ol>
         <li>Let <var>threshold</var> be the index of the first entry in <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-areathreshold-slot" id="ref-for-dom-visibilityobserver-areathreshold-slot">[[areaThreshold]]</a></code> slot whose value
                        is greater than or equal to <var>visibleRatio</var>. If <var>visibleRatio</var> is equal to <i>0</i>, let <var>threshold</var> be <i>-1</i>.
         <li>Let <var>oldVisibleRatio</var> be set to <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousvisibleratio-slot" id="ref-for-dom-visibilityobserver-previousvisibleratio-slot">[[previousVisibleRatio]]</a></code> slot.
         <li>Let <var>oldThreshold</var> be the index of the first entry in <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-areathreshold-slot" id="ref-for-dom-visibilityobserver-areathreshold-slot①">[[areaThreshold]]</a></code> slot whose value
                        is greater than or equal to <var>oldVisibleRatio</var>. If <var>oldVisibleRatio</var> is equal to <i>0</i>, let <var>oldThreshold</var> be <i>-1</i>.
         <li>Let <var>oldPosition</var> be the value of the <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousglobalviewportposition-slot" id="ref-for-dom-visibilityobserver-previousglobalviewportposition-slot">[[previousGlobalViewportPosition]]</a></code>.
         <li>If <var>threshold</var> does not equal <var>oldThreshold</var>, or if <var>observer</var>’s 
												internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-displacementaware-slot" id="ref-for-dom-visibilityobserver-displacementaware-slot">[[displacementAware]]</a></code> slot is <i>true</i> and <var>oldPosition</var> is not equal to <var>protectedRect</var>,
         <ul>
          <li><a data-link-type="dfn" href="#queue-a-visibilityobserverentry" id="ref-for-queue-a-visibilityobserverentry">queue a VisibilityObserverEntry</a>
          <li>Assign <var>visibleRatio</var> to <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousvisibleratio-slot" id="ref-for-dom-visibilityobserver-previousvisibleratio-slot①">[[previousVisibleRatio]]</a></code> slot.
          <li>Assign <var>protectedRect</var> to the value of the <var>observer</var>’s internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousglobalviewportposition-slot" id="ref-for-dom-visibilityobserver-previousglobalviewportposition-slot①">[[previousGlobalViewportPosition]]</a></code> slot.
         </ul>
        </ol>
       </ol>
      </ol>
      <p class="issue" id="issue-99e12d30"><a class="self-link" href="#issue-99e12d30"></a> find exact terms to make sure that we have viewport definitions minus scrollbars</p>
      <p class="issue" id="issue-6397a33f"><a class="self-link" href="#issue-6397a33f"></a> need to also clip to any other layers that were promoted ahead of us!</p>
      <p class="issue" id="issue-22658f2c"><a class="self-link" href="#issue-22658f2c"></a> if a parent and child layer both request to be promoted, the parent’s clipping window will have a complex geometry with holes in it that is not accounted for by this algorithm.  Likely need to specify that graphics layers be processed by order of depth.</p>
      <h4 class="heading settled" data-level="5.2.5" id="enforce-an-input-protection-directive-algo"><span class="secno">5.2.5. </span><span class="content">Enforce An input-protection Directive</span><a class="self-link" href="#enforce-an-input-protection-directive-algo"></a></h4>
       To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="enforce-an-input-protection-directive">enforce an input-protection directive</dfn> for a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑧">Document</a></code> <var>document</var>,
		run the following steps: 
      <ol>
       <li>Parse the policy according to <a data-link-type="biblio" href="#biblio-csp2" title="Content Security Policy Level 2">[CSP2]</a>.
       <li>If a value is set for <a data-link-type="dfn" href="#protected-element" id="ref-for-protected-element②">protected-element</a>, let <var>protectedElement</var> be the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#element" id="ref-for-element④">Element</a></code> returned by invoking <var>document</var>.<code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid" id="ref-for-dom-nonelementparentnode-getelementbyid①">getElementById()</a></code> with
					the value as the input, or <var>document</var> if <i>null</i> or unset.
       <li>If <var>document</var>’s <code class="idl"><a data-link-type="idl" href="#dom-document-inputprotectionrequested-slot" id="ref-for-dom-document-inputprotectionrequested-slot">[[InputProtectionRequested]]</a></code> flag is <i>false</i>, set it
					to <i>true</i>.
       <li>Construct a new <code class="idl"><a data-link-type="idl" href="#visibilityobserver" id="ref-for-visibilityobserver④">VisibilityObserver</a></code> <var>observer</var>, with <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-areathreshold-slot" id="ref-for-dom-visibilityobserver-areathreshold-slot②">[[areaThreshold]]</a></code> set to the value of <a data-link-type="dfn" href="#area-threshold" id="ref-for-area-threshold">area-threshold</a>, <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-visiblemargin-slot" id="ref-for-dom-visibilityobserver-visiblemargin-slot①">[[visibleMargin]]</a></code> set to the value of <a data-link-type="dfn" href="#visible-margin" id="ref-for-visible-margin①">visible-margin</a>, <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-observedelement-slot" id="ref-for-dom-visibilityobserver-observedelement-slot②">[[observedElement]]</a></code> set to <var>protectedElement</var>, <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-displacementaware-slot" id="ref-for-dom-visibilityobserver-displacementaware-slot①">[[displacementAware]]</a></code> set to <i>true</i>,
					and <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-callback-slot" id="ref-for-dom-visibilityobserver-callback-slot①">[[callback]]</a></code> set to a new function with an empty function body.
       <li>Set the internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-timethreshold-slot" id="ref-for-dom-visibilityobserver-timethreshold-slot">[[timeThreshold]]</a></code> slot of <var>observer</var> to the value of <a data-link-type="dfn" href="#time-threshold" id="ref-for-time-threshold">time-threshold</a>
       <li>Set the internal <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-associatedcontentsecuritypolicy-slot" id="ref-for-dom-visibilityobserver-associatedcontentsecuritypolicy-slot">[[associatedContentSecurityPolicy]]</a></code> slot of <var>observer</var> to a reference to the
					Content Security Policy which the <a data-link-type="dfn" href="#input-protection-directive" id="ref-for-input-protection-directive①">input-protection directive</a> is associated with.
       <li>When <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#dispatching-events" id="ref-for-dispatching-events">dispatching events</a>, when an <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#element" id="ref-for-element⑤">Element</a></code> <var>element</var> will handle an <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#event" id="ref-for-event">Event</a></code> <var>event</var>,
					if <var>event</var> is of type Mouse Event, Pointer Event, Drag-and-Drop, or Clipboard Event, (TODO:linkify)
					and if <var>element</var> has <code class="idl"><a data-link-type="idl" href="#dom-element-inputprotectionobservers-slot" id="ref-for-dom-element-inputprotectionobservers-slot">[[InputProtectionObservers]]</a></code> <var>observers</var>:
       <ol>
        <li>If applicable, check the computed style for the cursor.  If a cursor is typically displayed but
								has been hidden or changed to a non-standard bitmap, <a data-link-type="dfn" href="#handle-a-violation" id="ref-for-handle-a-violation">handle a violation</a> for <var>event</var> and each <var>observer</var> in <var>observers</var>.
        <li>Otherwise, for each <var>observer</var> in <var>observers</var>:
        <ol>
         <li>If <var>observer</var>’s <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousvisibleratio-slot" id="ref-for-dom-visibilityobserver-previousvisibleratio-slot②">[[previousVisibleRatio]]</a></code> is less than <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-areathreshold-slot" id="ref-for-dom-visibilityobserver-areathreshold-slot③">[[areaThreshold]]</a></code>, <a data-link-type="dfn" href="#handle-a-violation" id="ref-for-handle-a-violation①">handle a violation</a> for <var>observer</var>.
         <li>If <var>observer</var>’s <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-previousvisibleratio-slot" id="ref-for-dom-visibilityobserver-previousvisibleratio-slot③">[[previousVisibleRatio]]</a></code> is greater than <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-areathreshold-slot" id="ref-for-dom-visibilityobserver-areathreshold-slot④">[[areaThreshold]]</a></code>,
										get the most recent <code class="idl"><a data-link-type="idl" href="#visibilityobserverentry" id="ref-for-visibilityobserverentry②">VisibilityObserverEntry</a></code> <var>entry</var> from <var>observer</var>’s <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-queuedentries-slot" id="ref-for-dom-visibilityobserver-queuedentries-slot⑥">[[QueuedEntries]]</a></code>.  If the difference between <var>entry</var>.<code class="idl"><a data-link-type="idl" href="#dom-visibilityobserverentry-time" id="ref-for-dom-visibilityobserverentry-time①">time</a></code> and <var>now</var> is less than <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-timethreshold-slot" id="ref-for-dom-visibilityobserver-timethreshold-slot①">[[timeThreshold]]</a></code>, <a data-link-type="dfn" href="#handle-a-violation" id="ref-for-handle-a-violation②">handle a violation</a> for <var>observer</var>. 
        </ol>
       </ol>
      </ol>
      <h4 class="heading settled" data-level="5.2.6" id="handle-a-violation-algo"><span class="secno">5.2.6. </span><span class="content">Handle a Violation</span><a class="self-link" href="#handle-a-violation-algo"></a></h4>
       To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="handle-a-violation">handle a violation</dfn> of an <a data-link-type="dfn" href="#input-protection-directive" id="ref-for-input-protection-directive②">input-protection directive</a> for <var>observer</var> and <var>event</var>, run the following steps: 
      <ul>
       <li>Follow the steps in <a data-link-type="biblio" href="#biblio-csp2" title="Content Security Policy Level 2">[CSP2]</a> to report a violation for <var>observer</var>’s <code class="idl"><a data-link-type="idl" href="#dom-visibilityobserver-associatedcontentsecuritypolicy-slot" id="ref-for-dom-visibilityobserver-associatedcontentsecuritypolicy-slot①">[[associatedContentSecurityPolicy]]</a></code> <var>policy</var>.
       <li>Determine if <var>policy</var> is being <i>enforced</i> or <i>monitored</i>. <a data-link-type="biblio" href="#biblio-csp2" title="Content Security Policy Level 2">[CSP2]</a>
       <li>If <var>policy</var> is being <i>enforced</i>, set <var>event</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#cancelled-flag" id="ref-for-cancelled-flag">cancelled flag</a> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#stop-propagation-flag" id="ref-for-stop-propagation-flag">stop propagation flag</a>.
       <li>If <var>policy</var> is being <i>monitored</i>, set <var>event</var>.<code class="idl"><a data-link-type="idl" href="#dom-event-isunsafe" id="ref-for-dom-event-isunsafe">isUnsafe</a></code> to <i>true</i>.
      </ul>
      <h3 class="heading settled" data-level="5.3" id="external-spec-integrations"><span class="secno">5.3. </span><span class="content">External Spec Integrations</span><a class="self-link" href="#external-spec-integrations"></a></h3>
      <h4 class="heading settled" data-level="5.3.1" id="event-loop"><span class="secno">5.3.1. </span><span class="content">HTML Processing Model: Event Loop</span><a class="self-link" href="#event-loop"></a></h4>
       As part of substep 10 of the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#processing-model-8"> update the rendering</a> event loop in the HTML Processing Model, <a data-link-type="dfn" href="#promote-observed-graphicslayers" id="ref-for-promote-observed-graphicslayers①">Promote Observed GraphicsLayers</a>, passing in <i>now</i> as the timestamp. 
      <h4 class="heading settled" data-level="5.3.2" id="dispatching-events-algo"><span class="secno">5.3.2. </span><span class="content">DOM: Dispatching Events</span><a class="self-link" href="#dispatching-events-algo"></a></h4>
       As part of <a href="https://dom.spec.whatwg.org/#dispatching-events" id="db982b430">dispatching events</a> in the DOM Standard, add a substep to step 5, ("For each <i>object</i> in <i>event path</i>..."),
		invoking step 7 of <a data-link-type="dfn" href="#enforce-an-input-protection-directive" id="ref-for-enforce-an-input-protection-directive">enforce an input-protection directive</a> before proceeding to
		"invoke <i>object</i> with <i>event</i>". 
      <h4 class="heading settled" data-level="5.3.3" id="usafe-attribute"><span class="secno">5.3.3. </span><span class="content">isUnsafe Attribute</span><a class="self-link" href="#usafe-attribute"></a></h4>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#event" id="ref-for-event①"><c- g>Event</c-></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean①"><c- b>boolean</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="boolean" href="#dom-event-isunsafe" id="ref-for-dom-event-isunsafe①"><c- g>isUnsafe</c-></a>;
};
</pre>
      <dl>
       <dt><dfn class="dfn-paneled idl-code" data-dfn-for="Event" data-dfn-type="attribute" data-export id="dom-event-isunsafe"><code>isUnsafe</code></dfn>, <span> of type <a data-link-type="idl-name" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean②">boolean</a>, readonly</span>
       <dd> Will be set to true if the event fired when the event did not
				meet the document’s <em>input-protection</em> requirements. 
      </dl>
     </section>
     <section>
      <h2 class="heading settled" data-level="6" id="privacy-considerations"><span class="secno">6. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy-considerations"></a></h2>
      <p><em>This section is non-normative.</em></p>
      <p>The timing of visibilityEvents may leak some information across Origin boundaries.  An embedded
	document might have previously been unable to learn that it was obscured, or the timing and
	nature of repositioning of ancestor frame’s viewports.  In some circumstances, this information
	leak might have privacy implications, but the granularity and nature of the information is such
	that it should not be of much value to attackers.  Compared to anti-clickjacking strategies
	which rely on pixel comparisions, the side channels exposed by comparing rectulangar masks are
	very low bandwidth. The privacy gains from preventing clickjacking, considered in a holistic
	system context, may be quite large.</p>
     </section>
     <section>
      <h2 class="heading settled" data-level="7" id="security-considerations"><span class="secno">7. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
      <p><em>This section is non-normative.</em></p>
      <p>UI Redressing and Clickjacking attacks rely on violating the contextual and temporal
	integrity of embedded content. Because these attacks target the subjective perception 
	of the user and not well-defined security boundaries, the heuristic protections 
	afforded by the input-protection directive can never be 100% effective for every 
	interface. It provides no protection against certain classes of attacks, such as 
	displaying content around an embedded resource that appears to extend a trusted 
	dialog but provides misleading information.</p>
      <p>When used as a mechanism to report visibility for purposes of monetizing content,
	operators should be aware that a malicious or modified user agent can always report
	perfect visibility for content it colludes with.  Determining, through remote measurement,
	whether an ostensible viewer of monetizable content is using an agent which faithfully
	implements and reports in conformance with this specification is out of scope for this
	document.</p>
     </section>
     <section>
      <h2 class="heading settled" data-level="8" id="accessibility-considerations"><span class="secno">8. </span><span class="content">Accessibility Considerations</span><a class="self-link" href="#accessibility-considerations"></a></h2>
      <p>Users of accessibility tools MUST NOT be prevented from accessing content
	because of input-protection or VisibilityEvents. If a user agent’s interaction
	modality is not subject to UI redressing attacks or definitions of "visibility"
	do not apply, the user agent SHOULD report a VisibilityEvent indicating 100%
	visibility, and SHOULD never fire a violation for any input-protection policy.</p>
     </section>
    </section>
   </section>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#dom-visibilityobserver-areathreshold-slot">[[areaThreshold]]</a><span>, in § 5.1.4</span>
   <li><a href="#area-threshold">area-threshold</a><span>, in § 4.1.1</span>
   <li><a href="#dom-visibilityobserverinit-areathreshold">areaThreshold</a><span>, in § 3.4</span>
   <li><a href="#dom-visibilityobserver-associatedcontentsecuritypolicy-slot">[[associatedContentSecurityPolicy]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-visibilityobserver-callback-slot">[[callback]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-visibilityobserver-displacementaware-slot">[[displacementAware]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-visibilityobserverinit-displacementaware">displacementAware</a><span>, in § 3.4</span>
   <li><a href="#enforce-an-input-protection-directive">enforce an input-protection directive</a><span>, in § 5.2.5</span>
   <li>
    globalVisibleBounds
    <ul>
     <li><a href="#dom-visibilityobserverentry-globalvisiblebounds">attribute for VisibilityObserverEntry</a><span>, in § 3.2</span>
     <li><a href="#dom-visibilityobserverentryinit-globalvisiblebounds">dict-member for VisibilityObserverEntryInit</a><span>, in § 3.2</span>
    </ul>
   <li><a href="#graphicslayer">GraphicsLayer</a><span>, in § 5.2.4</span>
   <li><a href="#handle-a-violation">handle a violation</a><span>, in § 5.2.6</span>
   <li><a href="#input-protection-directive">input-protection Directive</a><span>, in § 4.1</span>
   <li><a href="#dom-element-inputprotectionobservers-slot">[[InputProtectionObservers]]</a><span>, in § 5.1.2</span>
   <li><a href="#dom-document-inputprotectionrequested-slot">[[InputProtectionRequested]]</a><span>, in § 5.1.3</span>
   <li><a href="#dom-event-isunsafe">isUnsafe</a><span>, in § 5.3.3</span>
   <li><a href="#notify-visibility-observers">notify visibility observers</a><span>, in § 5.2.2</span>
   <li><a href="#dom-visibilityobserver-observe">observe()</a><span>, in § 3.3</span>
   <li><a href="#dom-visibilityobserver-observedelement-slot">[[observedElement]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-visibilityobserverinit-observedelement">observedElement</a><span>, in § 3.4</span>
   <li><a href="#dom-visibilityobserver-previousglobalviewportposition-slot">[[previousGlobalViewportPosition]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-visibilityobserver-previousvisibleratio-slot">[[previousVisibleRatio]]</a><span>, in § 5.1.4</span>
   <li><a href="#promote-observed-graphicslayers">promote observed graphicsLayers</a><span>, in § 5.2.4</span>
   <li><a href="#protected-element">protected-element</a><span>, in § 4.1.1</span>
   <li><a href="#queue-a-visibilityobserverentry">queue a VisibilityObserverEntry</a><span>, in § 5.2.3</span>
   <li><a href="#queue-a-visibility-observer-task">queue a visibility observer task</a><span>, in § 5.2.1</span>
   <li><a href="#dom-visibilityobserver-queuedentries-slot">[[QueuedEntries]]</a><span>, in § 5.1.4</span>
   <li><a href="#dom-document-registeredvisibilityobservers-slot">[[RegisteredVisibilityObservers]]</a><span>, in § 5.1.3</span>
   <li><a href="#dom-visibilityobserver-takerecords">takeRecords()</a><span>, in § 3.3</span>
   <li>
    time
    <ul>
     <li><a href="#dom-visibilityobserverentry-time">attribute for VisibilityObserverEntry</a><span>, in § 3.2</span>
     <li><a href="#dom-visibilityobserverentryinit-time">dict-member for VisibilityObserverEntryInit</a><span>, in § 3.2</span>
    </ul>
   <li><a href="#dom-visibilityobserver-timethreshold-slot">[[timeThreshold]]</a><span>, in § 5.1.4</span>
   <li><a href="#time-threshold">time-threshold</a><span>, in § 4.1.1</span>
   <li><a href="#dom-visibilityobserver-unobserve">unobserve()</a><span>, in § 3.3</span>
   <li><a href="#visibilityobserver">VisibilityObserver</a><span>, in § 3.3</span>
   <li><a href="#callbackdef-visibilityobservercallback">VisibilityObserverCallback</a><span>, in § 3.1</span>
   <li><a href="#dom-visibilityobserver-visibilityobserver">VisibilityObserver(callback, options)</a><span>, in § 3.3</span>
   <li><a href="#visibilityobserverentry">VisibilityObserverEntry</a><span>, in § 3.2</span>
   <li><a href="#dictdef-visibilityobserverentryinit">VisibilityObserverEntryInit</a><span>, in § 3.2</span>
   <li><a href="#dictdef-visibilityobserverinit">VisibilityObserverInit</a><span>, in § 3.4</span>
   <li><a href="#browsing-context-visibilityobservertaskqueued">VisibilityObserverTaskQueued</a><span>, in § 5.1.1</span>
   <li>
    visibleBounds
    <ul>
     <li><a href="#dom-visibilityobserverentry-visiblebounds">attribute for VisibilityObserverEntry</a><span>, in § 3.2</span>
     <li><a href="#dom-visibilityobserverentryinit-visiblebounds">dict-member for VisibilityObserverEntryInit</a><span>, in § 3.2</span>
    </ul>
   <li><a href="#dom-visibilityobserver-visiblemargin-slot">[[visibleMargin]]</a><span>, in § 5.1.4</span>
   <li><a href="#visible-margin">visible-margin</a><span>, in § 4.1.1</span>
   <li><a href="#dom-visibilityobserverinit-visiblemargin">visibleMargin</a><span>, in § 3.4</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="3b11702b">DOMHighResTimeStamp</span>
     <li><span class="dfn-paneled" id="382d14c8">callback this value</span>
     <li><span class="dfn-paneled" id="2e634af1">cancelled flag</span>
     <li><span class="dfn-paneled" id="2a4aec04">dispatching events</span>
     <li><span class="dfn-paneled" id="84162264">list of idle request callbacks</span>
     <li><span class="dfn-paneled" id="a8958262">parent browsing context</span>
     <li><span class="dfn-paneled" id="04e154c5">report the exception</span>
     <li><span class="dfn-paneled" id="e41477a7">unit of related similar-origin browsing contexts</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-BOX-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="253362bb">margin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSSOM-VIEW-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9f97cd15">getBoundingClientRect()</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="296f3551">Element</span>
     <li><span class="dfn-paneled" id="129bdae8">Event</span>
     <li><span class="dfn-paneled" id="c7af4825">getElementById(elementId)</span>
     <li><span class="dfn-paneled" id="c89908b4">stop propagation flag</span>
    </ul>
   <li>
    <a data-link-type="biblio">[GEOMETRY-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d11c73d6">DOMRect</span>
     <li><span class="dfn-paneled" id="5a9ab3ba">DOMRectInit</span>
     <li><span class="dfn-paneled" id="224fa1d7">DOMRectReadOnly</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
     <li><span class="dfn-paneled" id="889e932f">Exposed</span>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
     <li><span class="dfn-paneled" id="8c800cdf">double</span>
     <li><span class="dfn-paneled" id="9cce47fd">sequence</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-csp2">[CSP2]
   <dd>Mike West; Adam Barth; Daniel Veditz. <a href="https://www.w3.org/TR/CSP2/"><cite>Content Security Policy Level 2</cite></a>. 15 December 2016. REC. URL: <a href="https://www.w3.org/TR/CSP2/">https://www.w3.org/TR/CSP2/</a>
   <dt id="biblio-css-box-4">[CSS-BOX-4]
   <dd>Elika Etemad. <a href="https://www.w3.org/TR/css-box-4/"><cite>CSS Box Model Module Level 4</cite></a>. 4 August 2024. WD. URL: <a href="https://www.w3.org/TR/css-box-4/">https://www.w3.org/TR/css-box-4/</a>
   <dt id="biblio-cssom-view-1">[CSSOM-VIEW-1]
   <dd>Simon Pieters. <a href="https://www.w3.org/TR/cssom-view-1/"><cite>CSSOM View Module</cite></a>. 17 March 2016. WD. URL: <a href="https://www.w3.org/TR/cssom-view-1/">https://www.w3.org/TR/cssom-view-1/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-geometry-1">[GEOMETRY-1]
   <dd>Simon Pieters; Chris Harrelson. <a href="https://www.w3.org/TR/geometry-1/"><cite>Geometry Interfaces Module Level 1</cite></a>. 4 December 2018. CR. URL: <a href="https://www.w3.org/TR/geometry-1/">https://www.w3.org/TR/geometry-1/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>callback</c-> <a href="#callbackdef-visibilityobservercallback"><code><c- g>VisibilityObserverCallback</c-></code></a> = <a data-link-type="idl-name"><c- n>void</c-></a>(<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#visibilityobserverentry"><c- n>VisibilityObserverEntry</c-></a>> <a href="#dom-visibilityobservercallback-entries"><code><c- g>entries</c-></code></a>, <a data-link-type="idl-name" href="#visibilityobserver"><c- n>VisibilityObserver</c-></a> <a href="#dom-visibilityobservercallback-observer"><code><c- g>observer</c-></code></a>);

[<c- g>Constructor</c->(<a data-link-type="idl-name" href="#callbackdef-visibilityobservercallback"><c- n>VisibilityObserverCallback</c-></a> <c- g>callback</c->, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-visibilityobserverentryinit"><c- n>VisibilityObserverEntryInit</c-></a> <c- g>visibilityObserverEntryInit</c->), <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <a href="#visibilityobserverentry"><code><c- g>VisibilityObserverEntry</c-></code></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#domrectreadonly"><c- n>DOMRectReadOnly</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMRectReadOnly" href="#dom-visibilityobserverentry-globalvisiblebounds"><c- g>globalVisibleBounds</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#domrectreadonly"><c- n>DOMRectReadOnly</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMRectReadOnly" href="#dom-visibilityobserverentry-visiblebounds"><c- g>visibleBounds</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="http://www.w3.org/TR/hr-time/#domhighrestimestamp"><c- n>DOMHighResTimeStamp</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMHighResTimeStamp" href="#dom-visibilityobserverentry-time"><c- g>time</c-></a>;
 };

<c- b>dictionary</c-> <a href="#dictdef-visibilityobserverentryinit"><code><c- g>VisibilityObserverEntryInit</c-></code></a> {
  <c- b>required</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#dictdef-domrectinit"><c- n>DOMRectInit</c-></a> <a data-type="DOMRectInit" href="#dom-visibilityobserverentryinit-globalvisiblebounds"><code><c- g>globalVisibleBounds</c-></code></a>;
  <c- b>required</c-> <a data-link-type="idl-name" href="https://www.w3.org/TR/geometry-1/#dictdef-domrectinit"><c- n>DOMRectInit</c-></a> <a data-type="DOMRectInit" href="#dom-visibilityobserverentryinit-visiblebounds"><code><c- g>visibleBounds</c-></code></a>;
  <c- b>required</c-> <a data-link-type="idl-name" href="http://www.w3.org/TR/hr-time/#domhighrestimestamp"><c- n>DOMHighResTimeStamp</c-></a> <a data-type="DOMHighResTimeStamp" href="#dom-visibilityobserverentryinit-time"><code><c- g>time</c-></code></a>;
};

[<c- g>Constructor</c->(<a data-link-type="idl-name" href="#callbackdef-visibilityobservercallback"><c- n>VisibilityObserverCallback</c-></a> <c- g>callback</c->), <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <a href="#visibilityobserver"><code><c- g>VisibilityObserver</c-></code></a> {
  <a data-link-type="idl-name"><c- n>void</c-></a> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-observe"><c- g>observe</c-></a> ();
  <a data-link-type="idl-name"><c- n>void</c-></a> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-unobserve"><c- g>unobserve</c-></a> ();
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#visibilityobserverentry"><c- n>VisibilityObserverEntry</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-visibilityobserver-takerecords"><c- g>takeRecords</c-></a> ();
};

<c- b>dictionary</c-> <a href="#dictdef-visibilityobserverinit"><code><c- g>VisibilityObserverInit</c-></code></a> {
  (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-double"><c- b>double</c-></a> <c- b>or</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-double"><c- b>double</c-></a>>) <a class="idl-code" data-default="0" data-link-type="dict-member" data-type="(double or sequence<double>)" href="#dom-visibilityobserverinit-areathreshold"><c- g>areaThreshold</c-></a> = 0;
 (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a>) <a class="idl-code" data-default="false" data-link-type="dict-member" data-type="(boolean)" href="#dom-visibilityobserverinit-displacementaware"><c- g>displacementAware</c-></a> = <c- b>false</c->;
 (<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a>) <a class="idl-code" data-default="&quot;0px&quot;" data-link-type="dict-member" data-type="(DOMString)" href="#dom-visibilityobserverinit-visiblemargin"><c- g>visibleMargin</c-></a> = "0px";
 (<a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#element"><c- n>Element</c-></a>)? <a class="idl-code" data-link-type="dict-member" data-type="(Element)?" href="#dom-visibilityobserverinit-observedelement"><c- g>observedElement</c-></a>;
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#event"><c- g>Event</c-></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="boolean" href="#dom-event-isunsafe"><c- g>isUnsafe</c-></a>;
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Do we need to deal with form submission / navigations that aren’t JS-event-based? <a class="issue-return" href="#issue-b24dcbe0" title="Jump to section">↵</a></div>
   <div class="issue"> how to interact with frame-ancestors and XFO? <a class="issue-return" href="#issue-b233e40b" title="Jump to section">↵</a></div>
   <div class="issue"> Should we define an appropriate <var>timeout</var>? <a class="issue-return" href="#issue-338c1e1f" title="Jump to section">↵</a></div>
   <div class="issue"> find exact terms to make sure that we have viewport definitions minus scrollbars <a class="issue-return" href="#issue-99e12d30" title="Jump to section">↵</a></div>
   <div class="issue"> need to also clip to any other layers that were promoted ahead of us! <a class="issue-return" href="#issue-6397a33f" title="Jump to section">↵</a></div>
   <div class="issue"> if a parent and child layer both request to be promoted, the parent’s clipping window will have a complex geometry with holes in it that is not accounted for by this algorithm.  Likely need to specify that graphics layers be processed by order of depth. <a class="issue-return" href="#issue-22658f2c" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"04e154c5": {"dfnID":"04e154c5","dfnText":"report the exception","external":true,"refSections":[{"refs":[{"id":"ref-for-report-the-exception"}],"title":"5.2.2. Notify VisibilityObservers"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception"},
"129bdae8": {"dfnID":"129bdae8","dfnText":"Event","external":true,"refSections":[{"refs":[{"id":"ref-for-event"}],"title":"5.2.5. Enforce An input-protection Directive"},{"refs":[{"id":"ref-for-event\u2460"}],"title":"5.3.3. isUnsafe Attribute"}],"url":"https://dom.spec.whatwg.org/#event"},
"224fa1d7": {"dfnID":"224fa1d7","dfnText":"DOMRectReadOnly","external":true,"refSections":[{"refs":[{"id":"ref-for-domrectreadonly"},{"id":"ref-for-domrectreadonly\u2460"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"https://www.w3.org/TR/geometry-1/#domrectreadonly"},
"253362bb": {"dfnID":"253362bb","dfnText":"margin","external":true,"refSections":[{"refs":[{"id":"ref-for-propdef-margin"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"https://www.w3.org/TR/css-box-4/#propdef-margin"},
"296f3551": {"dfnID":"296f3551","dfnText":"Element","external":true,"refSections":[{"refs":[{"id":"ref-for-element"},{"id":"ref-for-element\u2460"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-element\u2461"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-element\u2462"}],"title":"5.1.2. Element"},{"refs":[{"id":"ref-for-element\u2463"},{"id":"ref-for-element\u2464"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"https://dom.spec.whatwg.org/#element"},
"2a4aec04": {"dfnID":"2a4aec04","dfnText":"dispatching events","external":true,"refSections":[{"refs":[{"id":"ref-for-dispatching-events"}],"title":"5.2.5. Enforce An input-protection Directive"},{"refs":[{"id":"db982b430"}],"title":"5.3.2. DOM: Dispatching Events"}],"url":"https://dom.spec.whatwg.org/#dispatching-events"},
"2e634af1": {"dfnID":"2e634af1","dfnText":"cancelled flag","external":true,"refSections":[{"refs":[{"id":"ref-for-cancelled-flag"}],"title":"5.2.6. Handle a Violation"}],"url":"https://dom.spec.whatwg.org/#cancelled-flag"},
"382d14c8": {"dfnID":"382d14c8","dfnText":"callback this value","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-callback-this-value"}],"title":"5.2.2. Notify VisibilityObservers"}],"url":"https://html.spec.whatwg.org/multipage/infrastructure.html#dfn-callback-this-value"},
"3b11702b": {"dfnID":"3b11702b","dfnText":"DOMHighResTimeStamp","external":true,"refSections":[{"refs":[{"id":"ref-for-domhighrestimestamp"},{"id":"ref-for-domhighrestimestamp\u2460"},{"id":"ref-for-domhighrestimestamp\u2461"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"http://www.w3.org/TR/hr-time/#domhighrestimestamp"},
"5372cca8": {"dfnID":"5372cca8","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-boolean"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-idl-boolean\u2460"},{"id":"ref-for-idl-boolean\u2461"}],"title":"5.3.3. isUnsafe Attribute"}],"url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"5a9ab3ba": {"dfnID":"5a9ab3ba","dfnText":"DOMRectInit","external":true,"refSections":[{"refs":[{"id":"ref-for-dictdef-domrectinit"},{"id":"ref-for-dictdef-domrectinit\u2460"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"https://www.w3.org/TR/geometry-1/#dictdef-domrectinit"},
"84162264": {"dfnID":"84162264","dfnText":"list of idle request callbacks","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-list-of-idle-request-callbacks"}],"title":"5.2.1. Queue a VisibilityObserver Task"}],"url":"http://w3c.github.io/requestidlecallback/#dfn-list-of-idle-request-callbacks"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-document\u2460"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-document\u2461"}],"title":"5.1.3. Document"},{"refs":[{"id":"ref-for-document\u2462"}],"title":"5.1.4. VisibilityObserver"},{"refs":[{"id":"ref-for-document\u2463"}],"title":"5.2.2. Notify VisibilityObservers"},{"refs":[{"id":"ref-for-document\u2464"},{"id":"ref-for-document\u2465"},{"id":"ref-for-document\u2466"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-document\u2467"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"https://dom.spec.whatwg.org/#document"},
"8855a9aa": {"dfnID":"8855a9aa","dfnText":"DOMString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMString"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-idl-DOMString\u2460"}],"title":"4.1.1. Directive Value"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"889e932f": {"dfnID":"889e932f","dfnText":"Exposed","external":true,"refSections":[{"refs":[{"id":"ref-for-Exposed"}],"title":"3.2. The VisibilityObserverEntry interface"},{"refs":[{"id":"ref-for-Exposed\u2460"}],"title":"3.3. The VisibilityObserver Interface"}],"url":"https://webidl.spec.whatwg.org/#Exposed"},
"8c800cdf": {"dfnID":"8c800cdf","dfnText":"double","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-double"},{"id":"ref-for-idl-double\u2460"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"https://webidl.spec.whatwg.org/#idl-double"},
"9cce47fd": {"dfnID":"9cce47fd","dfnText":"sequence","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-sequence"}],"title":"3.1. The VisibilityObserverCallback"},{"refs":[{"id":"ref-for-idl-sequence\u2460"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-idl-sequence\u2461"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"9f97cd15": {"dfnID":"9f97cd15","dfnText":"getBoundingClientRect()","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-element-getboundingclientrect"},{"id":"ref-for-dom-element-getboundingclientrect\u2460"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-dom-element-getboundingclientrect\u2461"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-dom-element-getboundingclientrect\u2462"},{"id":"ref-for-dom-element-getboundingclientrect\u2463"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect"},
"a8958262": {"dfnID":"a8958262","dfnText":"parent browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-parent-browsing-context"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#parent-browsing-context"},
"area-threshold": {"dfnID":"area-threshold","dfnText":"area-threshold","external":false,"refSections":[{"refs":[{"id":"ref-for-area-threshold"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#area-threshold"},
"browsing-context-visibilityobservertaskqueued": {"dfnID":"browsing-context-visibilityobservertaskqueued","dfnText":"VisibilityObserverTaskQueued","external":false,"refSections":[{"refs":[{"id":"ref-for-browsing-context-visibilityobservertaskqueued"},{"id":"ref-for-browsing-context-visibilityobservertaskqueued\u2460"}],"title":"5.2.1. Queue a VisibilityObserver Task"},{"refs":[{"id":"ref-for-browsing-context-visibilityobservertaskqueued\u2461"}],"title":"5.2.2. Notify VisibilityObservers"}],"url":"#browsing-context-visibilityobservertaskqueued"},
"c7af4825": {"dfnID":"c7af4825","dfnText":"getElementById(elementId)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-nonelementparentnode-getelementbyid"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-dom-nonelementparentnode-getelementbyid\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"https://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid"},
"c89908b4": {"dfnID":"c89908b4","dfnText":"stop propagation flag","external":true,"refSections":[{"refs":[{"id":"ref-for-stop-propagation-flag"}],"title":"5.2.6. Handle a Violation"}],"url":"https://dom.spec.whatwg.org/#stop-propagation-flag"},
"callbackdef-visibilityobservercallback": {"dfnID":"callbackdef-visibilityobservercallback","dfnText":"VisibilityObserverCallback","external":false,"refSections":[{"refs":[{"id":"ref-for-callbackdef-visibilityobservercallback"}],"title":"3.2. The VisibilityObserverEntry interface"},{"refs":[{"id":"ref-for-callbackdef-visibilityobservercallback\u2460"}],"title":"3.3. The VisibilityObserver Interface"}],"url":"#callbackdef-visibilityobservercallback"},
"d11c73d6": {"dfnID":"d11c73d6","dfnText":"DOMRect","external":true,"refSections":[{"refs":[{"id":"ref-for-domrect"},{"id":"ref-for-domrect\u2460"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"https://www.w3.org/TR/geometry-1/#domrect"},
"dictdef-visibilityobserverentryinit": {"dfnID":"dictdef-visibilityobserverentryinit","dfnText":"VisibilityObserverEntryInit","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-visibilityobserverentryinit"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"#dictdef-visibilityobserverentryinit"},
"dictdef-visibilityobserverinit": {"dfnID":"dictdef-visibilityobserverinit","dfnText":"VisibilityObserverInit","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-visibilityobserverinit"}],"title":"5.1.4. VisibilityObserver"}],"url":"#dictdef-visibilityobserverinit"},
"dom-document-inputprotectionrequested-slot": {"dfnID":"dom-document-inputprotectionrequested-slot","dfnText":"[[InputProtectionRequested]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-inputprotectionrequested-slot"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-document-inputprotectionrequested-slot"},
"dom-document-registeredvisibilityobservers-slot": {"dfnID":"dom-document-registeredvisibilityobservers-slot","dfnText":"[[RegisteredVisibilityObservers]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-registeredvisibilityobservers-slot"},{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2460"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2461"}],"title":"5.2.2. Notify VisibilityObservers"},{"refs":[{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2462"},{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2463"},{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2464"},{"id":"ref-for-dom-document-registeredvisibilityobservers-slot\u2465"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"#dom-document-registeredvisibilityobservers-slot"},
"dom-element-inputprotectionobservers-slot": {"dfnID":"dom-element-inputprotectionobservers-slot","dfnText":"[[InputProtectionObservers]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-element-inputprotectionobservers-slot"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-element-inputprotectionobservers-slot"},
"dom-event-isunsafe": {"dfnID":"dom-event-isunsafe","dfnText":"isUnsafe","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-event-isunsafe"}],"title":"5.2.6. Handle a Violation"},{"refs":[{"id":"ref-for-dom-event-isunsafe\u2460"}],"title":"5.3.3. isUnsafe Attribute"}],"url":"#dom-event-isunsafe"},
"dom-visibilityobserver-areathreshold-slot": {"dfnID":"dom-visibilityobserver-areathreshold-slot","dfnText":"[[areaThreshold]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-areathreshold-slot"},{"id":"ref-for-dom-visibilityobserver-areathreshold-slot\u2460"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-areathreshold-slot\u2461"},{"id":"ref-for-dom-visibilityobserver-areathreshold-slot\u2462"},{"id":"ref-for-dom-visibilityobserver-areathreshold-slot\u2463"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-areathreshold-slot"},
"dom-visibilityobserver-associatedcontentsecuritypolicy-slot": {"dfnID":"dom-visibilityobserver-associatedcontentsecuritypolicy-slot","dfnText":"[[associatedContentSecurityPolicy]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-associatedcontentsecuritypolicy-slot"}],"title":"5.2.5. Enforce An input-protection Directive"},{"refs":[{"id":"ref-for-dom-visibilityobserver-associatedcontentsecuritypolicy-slot\u2460"}],"title":"5.2.6. Handle a Violation"}],"url":"#dom-visibilityobserver-associatedcontentsecuritypolicy-slot"},
"dom-visibilityobserver-callback-slot": {"dfnID":"dom-visibilityobserver-callback-slot","dfnText":"[[callback]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-callback-slot"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-dom-visibilityobserver-callback-slot\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-callback-slot"},
"dom-visibilityobserver-displacementaware-slot": {"dfnID":"dom-visibilityobserver-displacementaware-slot","dfnText":"[[displacementAware]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-displacementaware-slot"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-displacementaware-slot\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-displacementaware-slot"},
"dom-visibilityobserver-observe": {"dfnID":"dom-visibilityobserver-observe","dfnText":"observe()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-observe"}],"title":"3.3. The VisibilityObserver Interface"}],"url":"#dom-visibilityobserver-observe"},
"dom-visibilityobserver-observedelement-slot": {"dfnID":"dom-visibilityobserver-observedelement-slot","dfnText":"[[observedElement]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-observedelement-slot"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-dom-visibilityobserver-observedelement-slot\u2460"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-observedelement-slot\u2461"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-observedelement-slot"},
"dom-visibilityobserver-previousglobalviewportposition-slot": {"dfnID":"dom-visibilityobserver-previousglobalviewportposition-slot","dfnText":"[[previousGlobalViewportPosition]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-previousglobalviewportposition-slot"},{"id":"ref-for-dom-visibilityobserver-previousglobalviewportposition-slot\u2460"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"#dom-visibilityobserver-previousglobalviewportposition-slot"},
"dom-visibilityobserver-previousvisibleratio-slot": {"dfnID":"dom-visibilityobserver-previousvisibleratio-slot","dfnText":"[[previousVisibleRatio]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-previousvisibleratio-slot"},{"id":"ref-for-dom-visibilityobserver-previousvisibleratio-slot\u2460"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-previousvisibleratio-slot\u2461"},{"id":"ref-for-dom-visibilityobserver-previousvisibleratio-slot\u2462"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-previousvisibleratio-slot"},
"dom-visibilityobserver-queuedentries-slot": {"dfnID":"dom-visibilityobserver-queuedentries-slot","dfnText":"[[QueuedEntries]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-queuedentries-slot"},{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2460"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2461"},{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2462"},{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2463"}],"title":"5.2.2. Notify VisibilityObservers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2464"}],"title":"5.2.3. Queue a VisibilityObserverEntry"},{"refs":[{"id":"ref-for-dom-visibilityobserver-queuedentries-slot\u2465"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-queuedentries-slot"},
"dom-visibilityobserver-takerecords": {"dfnID":"dom-visibilityobserver-takerecords","dfnText":"takeRecords()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-takerecords"}],"title":"3.3. The VisibilityObserver Interface"}],"url":"#dom-visibilityobserver-takerecords"},
"dom-visibilityobserver-timethreshold-slot": {"dfnID":"dom-visibilityobserver-timethreshold-slot","dfnText":"[[timeThreshold]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-timethreshold-slot"},{"id":"ref-for-dom-visibilityobserver-timethreshold-slot\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-timethreshold-slot"},
"dom-visibilityobserver-unobserve": {"dfnID":"dom-visibilityobserver-unobserve","dfnText":"unobserve()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-unobserve"}],"title":"3.3. The VisibilityObserver Interface"}],"url":"#dom-visibilityobserver-unobserve"},
"dom-visibilityobserver-visibilityobserver": {"dfnID":"dom-visibilityobserver-visibilityobserver","dfnText":"new VisibilityObserver(callback, options)","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-visibilityobserver"}],"title":"5.1.4. VisibilityObserver"}],"url":"#dom-visibilityobserver-visibilityobserver"},
"dom-visibilityobserver-visiblemargin-slot": {"dfnID":"dom-visibilityobserver-visiblemargin-slot","dfnText":"[[visibleMargin]]","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserver-visiblemargin-slot"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-dom-visibilityobserver-visiblemargin-slot\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserver-visiblemargin-slot"},
"dom-visibilityobservercallback-entries": {"dfnID":"dom-visibilityobservercallback-entries","dfnText":"entries","external":false,"refSections":[],"url":"#dom-visibilityobservercallback-entries"},
"dom-visibilityobservercallback-observer": {"dfnID":"dom-visibilityobservercallback-observer","dfnText":"observer","external":false,"refSections":[],"url":"#dom-visibilityobservercallback-observer"},
"dom-visibilityobserverentry-globalvisiblebounds": {"dfnID":"dom-visibilityobserverentry-globalvisiblebounds","dfnText":"globalVisibleBounds","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverentry-globalvisiblebounds"},{"id":"ref-for-dom-visibilityobserverentry-globalvisiblebounds\u2460"},{"id":"ref-for-dom-visibilityobserverentry-globalvisiblebounds\u2461"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"#dom-visibilityobserverentry-globalvisiblebounds"},
"dom-visibilityobserverentry-time": {"dfnID":"dom-visibilityobserverentry-time","dfnText":"time","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverentry-time"}],"title":"3.2. The VisibilityObserverEntry interface"},{"refs":[{"id":"ref-for-dom-visibilityobserverentry-time\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#dom-visibilityobserverentry-time"},
"dom-visibilityobserverentry-visiblebounds": {"dfnID":"dom-visibilityobserverentry-visiblebounds","dfnText":"visibleBounds","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverentry-visiblebounds"}],"title":"3.2. The VisibilityObserverEntry interface"}],"url":"#dom-visibilityobserverentry-visiblebounds"},
"dom-visibilityobserverentryinit-globalvisiblebounds": {"dfnID":"dom-visibilityobserverentryinit-globalvisiblebounds","dfnText":"globalVisibleBounds","external":false,"refSections":[],"url":"#dom-visibilityobserverentryinit-globalvisiblebounds"},
"dom-visibilityobserverentryinit-time": {"dfnID":"dom-visibilityobserverentryinit-time","dfnText":"time","external":false,"refSections":[],"url":"#dom-visibilityobserverentryinit-time"},
"dom-visibilityobserverentryinit-visiblebounds": {"dfnID":"dom-visibilityobserverentryinit-visiblebounds","dfnText":"visibleBounds","external":false,"refSections":[],"url":"#dom-visibilityobserverentryinit-visiblebounds"},
"dom-visibilityobserverinit-areathreshold": {"dfnID":"dom-visibilityobserverinit-areathreshold","dfnText":"areaThreshold","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverinit-areathreshold"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"#dom-visibilityobserverinit-areathreshold"},
"dom-visibilityobserverinit-displacementaware": {"dfnID":"dom-visibilityobserverinit-displacementaware","dfnText":"displacementAware","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverinit-displacementaware"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"#dom-visibilityobserverinit-displacementaware"},
"dom-visibilityobserverinit-observedelement": {"dfnID":"dom-visibilityobserverinit-observedelement","dfnText":"observedElement","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverinit-observedelement"}],"title":"3.4. The VisibilityObserverInit dictionary"}],"url":"#dom-visibilityobserverinit-observedelement"},
"dom-visibilityobserverinit-visiblemargin": {"dfnID":"dom-visibilityobserverinit-visiblemargin","dfnText":"visibleMargin","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-visibilityobserverinit-visiblemargin"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-dom-visibilityobserverinit-visiblemargin\u2460"}],"title":"4.1.1. Directive Value"}],"url":"#dom-visibilityobserverinit-visiblemargin"},
"e41477a7": {"dfnID":"e41477a7","dfnText":"unit of related similar-origin browsing contexts","external":true,"refSections":[{"refs":[{"id":"ref-for-unit-of-related-similar-origin-browsing-contexts"}],"title":"5.1.1. Browsing Contexts"},{"refs":[{"id":"ref-for-unit-of-related-similar-origin-browsing-contexts\u2460"}],"title":"5.2.1. Queue a VisibilityObserver Task"},{"refs":[{"id":"ref-for-unit-of-related-similar-origin-browsing-contexts\u2461"}],"title":"5.2.2. Notify VisibilityObservers"},{"refs":[{"id":"ref-for-unit-of-related-similar-origin-browsing-contexts\u2462"}],"title":"5.2.3. Queue a VisibilityObserverEntry"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts"},
"enforce-an-input-protection-directive": {"dfnID":"enforce-an-input-protection-directive","dfnText":"enforce an input-protection directive","external":false,"refSections":[{"refs":[{"id":"ref-for-enforce-an-input-protection-directive"}],"title":"5.3.2. DOM: Dispatching Events"}],"url":"#enforce-an-input-protection-directive"},
"graphicslayer": {"dfnID":"graphicslayer","dfnText":"GraphicsLayer","external":false,"refSections":[{"refs":[{"id":"ref-for-graphicslayer"},{"id":"ref-for-graphicslayer\u2460"},{"id":"ref-for-graphicslayer\u2461"},{"id":"ref-for-graphicslayer\u2462"},{"id":"ref-for-graphicslayer\u2463"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"#graphicslayer"},
"handle-a-violation": {"dfnID":"handle-a-violation","dfnText":"handle a violation","external":false,"refSections":[{"refs":[{"id":"ref-for-handle-a-violation"},{"id":"ref-for-handle-a-violation\u2460"},{"id":"ref-for-handle-a-violation\u2461"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#handle-a-violation"},
"input-protection-directive": {"dfnID":"input-protection-directive","dfnText":"input-protection Directive","external":false,"refSections":[{"refs":[{"id":"ref-for-input-protection-directive"}],"title":"5.1.4. VisibilityObserver"},{"refs":[{"id":"ref-for-input-protection-directive\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"},{"refs":[{"id":"ref-for-input-protection-directive\u2461"}],"title":"5.2.6. Handle a Violation"}],"url":"#input-protection-directive"},
"notify-visibility-observers": {"dfnID":"notify-visibility-observers","dfnText":"notify visibility observers","external":false,"refSections":[{"refs":[{"id":"ref-for-notify-visibility-observers"},{"id":"ref-for-notify-visibility-observers\u2460"}],"title":"5.2.1. Queue a VisibilityObserver Task"}],"url":"#notify-visibility-observers"},
"promote-observed-graphicslayers": {"dfnID":"promote-observed-graphicslayers","dfnText":"promote observed graphicsLayers","external":false,"refSections":[{"refs":[{"id":"ref-for-promote-observed-graphicslayers"}],"title":"5.2.4. Promote Observed GraphicsLayers"},{"refs":[{"id":"ref-for-promote-observed-graphicslayers\u2460"}],"title":"5.3.1. HTML Processing Model: Event Loop"}],"url":"#promote-observed-graphicslayers"},
"protected-element": {"dfnID":"protected-element","dfnText":"protected-element","external":false,"refSections":[{"refs":[{"id":"ref-for-protected-element"}],"title":"3.4. The VisibilityObserverInit dictionary"},{"refs":[{"id":"ref-for-protected-element\u2460"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-protected-element\u2461"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#protected-element"},
"queue-a-visibility-observer-task": {"dfnID":"queue-a-visibility-observer-task","dfnText":"queue a visibility observer task","external":false,"refSections":[{"refs":[{"id":"ref-for-queue-a-visibility-observer-task"}],"title":"5.2.3. Queue a VisibilityObserverEntry"}],"url":"#queue-a-visibility-observer-task"},
"queue-a-visibilityobserverentry": {"dfnID":"queue-a-visibilityobserverentry","dfnText":"queue a VisibilityObserverEntry","external":false,"refSections":[{"refs":[{"id":"ref-for-queue-a-visibilityobserverentry"}],"title":"5.2.4. Promote Observed GraphicsLayers"}],"url":"#queue-a-visibilityobserverentry"},
"time-threshold": {"dfnID":"time-threshold","dfnText":"time-threshold","external":false,"refSections":[{"refs":[{"id":"ref-for-time-threshold"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#time-threshold"},
"visibilityobserver": {"dfnID":"visibilityobserver","dfnText":"VisibilityObserver","external":false,"refSections":[{"refs":[{"id":"ref-for-visibilityobserver"}],"title":"3.1. The VisibilityObserverCallback"},{"refs":[{"id":"ref-for-visibilityobserver\u2460"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-visibilityobserver\u2461"}],"title":"5.1.4. VisibilityObserver"},{"refs":[{"id":"ref-for-visibilityobserver\u2462"}],"title":"5.2.2. Notify VisibilityObservers"},{"refs":[{"id":"ref-for-visibilityobserver\u2463"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#visibilityobserver"},
"visibilityobserverentry": {"dfnID":"visibilityobserverentry","dfnText":"VisibilityObserverEntry","external":false,"refSections":[{"refs":[{"id":"ref-for-visibilityobserverentry"}],"title":"3.1. The VisibilityObserverCallback"},{"refs":[{"id":"ref-for-visibilityobserverentry\u2460"}],"title":"3.3. The VisibilityObserver Interface"},{"refs":[{"id":"ref-for-visibilityobserverentry\u2461"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#visibilityobserverentry"},
"visible-margin": {"dfnID":"visible-margin","dfnText":"visible-margin","external":false,"refSections":[{"refs":[{"id":"ref-for-visible-margin"}],"title":"4.1.1. Directive Value"},{"refs":[{"id":"ref-for-visible-margin\u2460"}],"title":"5.2.5. Enforce An input-protection Directive"}],"url":"#visible-margin"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#area-threshold": {"displayText":"area-threshold","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"area-threshold","type":"dfn","url":"#area-threshold"},
"#browsing-context-visibilityobservertaskqueued": {"displayText":"visibilityobservertaskqueued","export":true,"for_":["browsing context"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"visibilityobservertaskqueued","type":"dfn","url":"#browsing-context-visibilityobservertaskqueued"},
"#callbackdef-visibilityobservercallback": {"displayText":"VisibilityObserverCallback","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserverCallback","type":"callback","url":"#callbackdef-visibilityobservercallback"},
"#dictdef-visibilityobserverentryinit": {"displayText":"VisibilityObserverEntryInit","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserverEntryInit","type":"dictionary","url":"#dictdef-visibilityobserverentryinit"},
"#dictdef-visibilityobserverinit": {"displayText":"VisibilityObserverInit","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserverInit","type":"dictionary","url":"#dictdef-visibilityobserverinit"},
"#dom-document-inputprotectionrequested-slot": {"displayText":"[[InputProtectionRequested]]","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[InputProtectionRequested]]","type":"attribute","url":"#dom-document-inputprotectionrequested-slot"},
"#dom-document-registeredvisibilityobservers-slot": {"displayText":"[[RegisteredVisibilityObservers]]","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[RegisteredVisibilityObservers]]","type":"attribute","url":"#dom-document-registeredvisibilityobservers-slot"},
"#dom-element-inputprotectionobservers-slot": {"displayText":"[[InputProtectionObservers]]","export":true,"for_":["Element"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[InputProtectionObservers]]","type":"attribute","url":"#dom-element-inputprotectionobservers-slot"},
"#dom-event-isunsafe": {"displayText":"isUnsafe","export":true,"for_":["Event"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"isUnsafe","type":"attribute","url":"#dom-event-isunsafe"},
"#dom-visibilityobserver-areathreshold-slot": {"displayText":"[[areaThreshold]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[areaThreshold]]","type":"attribute","url":"#dom-visibilityobserver-areathreshold-slot"},
"#dom-visibilityobserver-associatedcontentsecuritypolicy-slot": {"displayText":"[[associatedContentSecurityPolicy]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[associatedContentSecurityPolicy]]","type":"attribute","url":"#dom-visibilityobserver-associatedcontentsecuritypolicy-slot"},
"#dom-visibilityobserver-callback-slot": {"displayText":"[[callback]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[callback]]","type":"attribute","url":"#dom-visibilityobserver-callback-slot"},
"#dom-visibilityobserver-displacementaware-slot": {"displayText":"[[displacementAware]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[displacementAware]]","type":"attribute","url":"#dom-visibilityobserver-displacementaware-slot"},
"#dom-visibilityobserver-observe": {"displayText":"observe()","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"observe()","type":"method","url":"#dom-visibilityobserver-observe"},
"#dom-visibilityobserver-observedelement-slot": {"displayText":"[[observedElement]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[observedElement]]","type":"attribute","url":"#dom-visibilityobserver-observedelement-slot"},
"#dom-visibilityobserver-previousglobalviewportposition-slot": {"displayText":"[[previousGlobalViewportPosition]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[previousGlobalViewportPosition]]","type":"attribute","url":"#dom-visibilityobserver-previousglobalviewportposition-slot"},
"#dom-visibilityobserver-previousvisibleratio-slot": {"displayText":"[[previousVisibleRatio]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[previousVisibleRatio]]","type":"attribute","url":"#dom-visibilityobserver-previousvisibleratio-slot"},
"#dom-visibilityobserver-queuedentries-slot": {"displayText":"[[QueuedEntries]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[QueuedEntries]]","type":"attribute","url":"#dom-visibilityobserver-queuedentries-slot"},
"#dom-visibilityobserver-takerecords": {"displayText":"takeRecords()","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"takeRecords()","type":"method","url":"#dom-visibilityobserver-takerecords"},
"#dom-visibilityobserver-timethreshold-slot": {"displayText":"[[timeThreshold]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[timeThreshold]]","type":"attribute","url":"#dom-visibilityobserver-timethreshold-slot"},
"#dom-visibilityobserver-unobserve": {"displayText":"unobserve()","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"unobserve()","type":"method","url":"#dom-visibilityobserver-unobserve"},
"#dom-visibilityobserver-visibilityobserver": {"displayText":"VisibilityObserver(callback, options)","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserver(callback, options)","type":"constructor","url":"#dom-visibilityobserver-visibilityobserver"},
"#dom-visibilityobserver-visiblemargin-slot": {"displayText":"[[visibleMargin]]","export":true,"for_":["VisibilityObserver"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"[[visibleMargin]]","type":"attribute","url":"#dom-visibilityobserver-visiblemargin-slot"},
"#dom-visibilityobserverentry-globalvisiblebounds": {"displayText":"globalVisibleBounds","export":true,"for_":["VisibilityObserverEntry"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"globalVisibleBounds","type":"attribute","url":"#dom-visibilityobserverentry-globalvisiblebounds"},
"#dom-visibilityobserverentry-time": {"displayText":"time","export":true,"for_":["VisibilityObserverEntry"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"time","type":"attribute","url":"#dom-visibilityobserverentry-time"},
"#dom-visibilityobserverentry-visiblebounds": {"displayText":"visibleBounds","export":true,"for_":["VisibilityObserverEntry"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"visibleBounds","type":"attribute","url":"#dom-visibilityobserverentry-visiblebounds"},
"#dom-visibilityobserverinit-areathreshold": {"displayText":"areaThreshold","export":true,"for_":["VisibilityObserverInit"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"areaThreshold","type":"dict-member","url":"#dom-visibilityobserverinit-areathreshold"},
"#dom-visibilityobserverinit-displacementaware": {"displayText":"displacementAware","export":true,"for_":["VisibilityObserverInit"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"displacementAware","type":"dict-member","url":"#dom-visibilityobserverinit-displacementaware"},
"#dom-visibilityobserverinit-observedelement": {"displayText":"observedElement","export":true,"for_":["VisibilityObserverInit"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"observedElement","type":"dict-member","url":"#dom-visibilityobserverinit-observedelement"},
"#dom-visibilityobserverinit-visiblemargin": {"displayText":"visibleMargin","export":true,"for_":["VisibilityObserverInit"],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"visibleMargin","type":"dict-member","url":"#dom-visibilityobserverinit-visiblemargin"},
"#enforce-an-input-protection-directive": {"displayText":"enforce an input-protection directive","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"enforce an input-protection directive","type":"dfn","url":"#enforce-an-input-protection-directive"},
"#graphicslayer": {"displayText":"graphicslayer","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"graphicslayer","type":"dfn","url":"#graphicslayer"},
"#handle-a-violation": {"displayText":"handle a violation","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"handle a violation","type":"dfn","url":"#handle-a-violation"},
"#input-protection-directive": {"displayText":"input-protection directive","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"input-protection directive","type":"dfn","url":"#input-protection-directive"},
"#notify-visibility-observers": {"displayText":"notify visibility observers","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"notify visibility observers","type":"dfn","url":"#notify-visibility-observers"},
"#promote-observed-graphicslayers": {"displayText":"promote observed graphicslayers","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"promote observed graphicslayers","type":"dfn","url":"#promote-observed-graphicslayers"},
"#protected-element": {"displayText":"protected-element","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"protected-element","type":"dfn","url":"#protected-element"},
"#queue-a-visibility-observer-task": {"displayText":"queue a visibility observer task","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"queue a visibility observer task","type":"dfn","url":"#queue-a-visibility-observer-task"},
"#queue-a-visibilityobserverentry": {"displayText":"queue a visibilityobserverentry","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"queue a visibilityobserverentry","type":"dfn","url":"#queue-a-visibilityobserverentry"},
"#time-threshold": {"displayText":"time-threshold","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"time-threshold","type":"dfn","url":"#time-threshold"},
"#visibilityobserver": {"displayText":"VisibilityObserver","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserver","type":"interface","url":"#visibilityobserver"},
"#visibilityobserverentry": {"displayText":"VisibilityObserverEntry","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"VisibilityObserverEntry","type":"interface","url":"#visibilityobserverentry"},
"#visible-margin": {"displayText":"visible-margin","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"ui security-1","status":"local","text":"visible-margin","type":"dfn","url":"#visible-margin"},
"http://w3c.github.io/requestidlecallback/#dfn-list-of-idle-request-callbacks": {"displayText":"list of idle request callbacks","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"list of idle request callbacks","type":"dfn","url":"http://w3c.github.io/requestidlecallback/#dfn-list-of-idle-request-callbacks"},
"http://www.w3.org/TR/hr-time/#domhighrestimestamp": {"displayText":"DOMHighResTimeStamp","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"DOMHighResTimeStamp","type":"typedef","url":"http://www.w3.org/TR/hr-time/#domhighrestimestamp"},
"https://dom.spec.whatwg.org/#cancelled-flag": {"displayText":"cancelled flag","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"cancelled flag","type":"dfn","url":"https://dom.spec.whatwg.org/#cancelled-flag"},
"https://dom.spec.whatwg.org/#dispatching-events": {"displayText":"dispatching events","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"dispatching events","type":"dfn","url":"https://dom.spec.whatwg.org/#dispatching-events"},
"https://dom.spec.whatwg.org/#document": {"displayText":"Document","export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid": {"displayText":"getElementById(elementId)","export":true,"for_":["NonElementParentNode"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"getElementById(elementId)","type":"method","url":"https://dom.spec.whatwg.org/#dom-nonelementparentnode-getelementbyid"},
"https://dom.spec.whatwg.org/#element": {"displayText":"Element","export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Element","type":"interface","url":"https://dom.spec.whatwg.org/#element"},
"https://dom.spec.whatwg.org/#event": {"displayText":"Event","export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Event","type":"interface","url":"https://dom.spec.whatwg.org/#event"},
"https://dom.spec.whatwg.org/#stop-propagation-flag": {"displayText":"stop propagation flag","export":true,"for_":["Event"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"stop propagation flag","type":"dfn","url":"https://dom.spec.whatwg.org/#stop-propagation-flag"},
"https://html.spec.whatwg.org/multipage/browsers.html#parent-browsing-context": {"displayText":"parent browsing context","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"parent browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#parent-browsing-context"},
"https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts": {"displayText":"unit of related similar-origin browsing contexts","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"unit of related similar-origin browsing contexts","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts"},
"https://html.spec.whatwg.org/multipage/infrastructure.html#dfn-callback-this-value": {"displayText":"callback this value","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"callback this value","type":"dfn","url":"https://html.spec.whatwg.org/multipage/infrastructure.html#dfn-callback-this-value"},
"https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception": {"displayText":"report the exception","export":true,"for_":[],"level":"1","normative":true,"shortname":"ui security","spec":"","status":"anchor-block","text":"report the exception","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception"},
"https://webidl.spec.whatwg.org/#Exposed": {"displayText":"Exposed","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Exposed","type":"extended-attribute","url":"https://webidl.spec.whatwg.org/#Exposed"},
"https://webidl.spec.whatwg.org/#idl-DOMString": {"displayText":"DOMString","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"https://webidl.spec.whatwg.org/#idl-boolean": {"displayText":"boolean","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"boolean","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"https://webidl.spec.whatwg.org/#idl-double": {"displayText":"double","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"double","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-double"},
"https://webidl.spec.whatwg.org/#idl-sequence": {"displayText":"sequence","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"sequence","type":"dfn","url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"https://www.w3.org/TR/css-box-4/#propdef-margin": {"displayText":"margin","export":true,"for_":[],"level":"4","normative":true,"shortname":"css-box","spec":"css-box-4","status":"snapshot","text":"margin","type":"property","url":"https://www.w3.org/TR/css-box-4/#propdef-margin"},
"https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect": {"displayText":"getBoundingClientRect()","export":true,"for_":["Element"],"level":"1","normative":true,"shortname":"cssom-view","spec":"cssom-view-1","status":"snapshot","text":"getBoundingClientRect()","type":"method","url":"https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect"},
"https://www.w3.org/TR/geometry-1/#dictdef-domrectinit": {"displayText":"DOMRectInit","export":true,"for_":[],"level":"1","normative":true,"shortname":"geometry","spec":"geometry-1","status":"snapshot","text":"DOMRectInit","type":"dictionary","url":"https://www.w3.org/TR/geometry-1/#dictdef-domrectinit"},
"https://www.w3.org/TR/geometry-1/#domrect": {"displayText":"DOMRect","export":true,"for_":[],"level":"1","normative":true,"shortname":"geometry","spec":"geometry-1","status":"snapshot","text":"DOMRect","type":"interface","url":"https://www.w3.org/TR/geometry-1/#domrect"},
"https://www.w3.org/TR/geometry-1/#domrectreadonly": {"displayText":"DOMRectReadOnly","export":true,"for_":[],"level":"1","normative":true,"shortname":"geometry","spec":"geometry-1","status":"snapshot","text":"DOMRectReadOnly","type":"interface","url":"https://www.w3.org/TR/geometry-1/#domrectreadonly"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>