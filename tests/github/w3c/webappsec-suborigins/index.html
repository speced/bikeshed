<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Suborigins</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <link href="https://w3c.github.io/webappsec-suborigins/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Suborigins</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/webappsec-suborigins/">https://w3c.github.io/webappsec-suborigins/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webappsec@w3.org?subject=%5Bsuborigins%5D%20YOUR%20TOPIC%20HERE">public-webappsec@w3.org</a> with subject line “<kbd>[suborigins] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webappsec/" rel="discussion">archives</a>)</span>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="https://joelweinberger.us">Joel Weinberger</a> (<span class="p-org org">Google Inc.</span>) <a class="u-email email" href="mailto:jww@google.com">jww@google.com</a>
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-url url" href="http://devd.me">Devdatta Akhawe</a> (<span class="p-org org">Dropbox Inc.</span>) <a class="u-email email" href="mailto:dev.akhawe@gmail.com">dev.akhawe@gmail.com</a>
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:eisinger@google.com">Jochen Eisinger</a> (<span class="p-org org">Google Inc.</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This specification defines a mechanism for programmatically defining origins
to isolate different applications running in the same physical origin. It
allows a server to specify a namespace on a resource response which is paired
with the scheme/host/port origin tuple. User agents extend the same-origin
policy with this new namespace plus origin tuple to create a security
boundary between this resource and resources in other namespaces.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p> <strong>Changes to this document may be tracked at <a href="https://github.com/w3c/webappsec">https://github.com/w3c/webappsec</a>.</strong> </p>
   <p> The (<a href="https://lists.w3.org/Archives/Public/public-webappsec/">archived</a>) public mailing list <a href="mailto:public-webappsec@w3.org?Subject=%5Bsuborigins%5D%20PUT%20SUBJECT%20HERE">public-webappsec@w3.org</a> (see <a href="https://www.w3.org/Mail/Request">instructions</a>)
	is preferred for discussion of this specification.
	When sending e-mail,
	please put the text “suborigins” in the subject,
	preferably like this:
	“[suborigins] <em>…summary of comment…</em>” </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webappsec">Web Application Security Working Group</a>. </p>
   <p> This document was produced by a group operating under
	the <a href="https://www.w3.org/policies/patent-policy/">W3C Patent Policy</a>.
	W3C maintains a <a href="https://www.w3.org/groups/wg/webappsec/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
	that page also includes instructions for disclosing a patent.
	An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/#sec-Disclosure">section 6 of the W3C Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#goals"><span class="secno">1.1</span> <span class="content">Goals</span></a>
      <li><a href="#usecases"><span class="secno">1.2</span> <span class="content">Use Cases/Examples</span></a>
     </ol>
    <li>
     <a href="#terms"><span class="secno">2</span> <span class="content">Key Concepts and Terminology</span></a>
     <ol class="toc">
      <li><a href="#grammar"><span class="secno">2.1</span> <span class="content">Grammatical Concepts</span></a>
     </ol>
    <li>
     <a href="#defining-suborigin"><span class="secno">3</span> <span class="content">Defining a Suborigin</span></a>
     <ol class="toc">
      <li>
       <a href="#difficulties"><span class="secno">3.1</span> <span class="content">Difficulties using subdomains</span></a>
       <ol class="toc">
        <li><a href="#separate-applications-same-origin"><span class="secno">3.1.1</span> <span class="content">Separate applications, same origin</span></a>
        <li><a href="#separation-in-single-application"><span class="secno">3.1.2</span> <span class="content">Separation within a single application</span></a>
       </ol>
      <li>
       <a href="#threat-model"><span class="secno">3.2</span> <span class="content">Threat Model</span></a>
       <ol class="toc">
        <li><a href="#threat-model-cross-doc"><span class="secno">3.2.1</span> <span class="content">Cross-Document Attacker</span></a>
        <li><a href="#threat-model-out-of-scope"><span class="secno">3.2.2</span> <span class="content">Out of Scope Attacker</span></a>
       </ol>
      <li><a href="#suborigins-vs-origins"><span class="secno">3.3</span> <span class="content">Relationship of Suborigins to Origins</span></a>
      <li><a href="#opting-in"><span class="secno">3.4</span> <span class="content">Opting into a Suborigin</span></a>
      <li><a href="#the-suborigin-header"><span class="secno">3.5</span> <span class="content">The <code>suborigin</code> header</span></a>
      <li><a href="#representation"><span class="secno">3.6</span> <span class="content">Representation of Suborigins</span></a>
      <li><a href="#suborigin-in-js"><span class="secno">3.7</span> <span class="content">Accessing the Suborigin in JavaScript</span></a>
     </ol>
    <li>
     <a href="#access-control"><span class="secno">4</span> <span class="content">Access Control</span></a>
     <ol class="toc">
      <li><a href="#cors-ac"><span class="secno">4.1</span> <span class="content">CORS</span></a>
      <li><a href="#postmessage-ac"><span class="secno">4.2</span> <span class="content"><code>postMessage</code></span></a>
      <li><a href="#workers-ac"><span class="secno">4.3</span> <span class="content">Workers</span></a>
     </ol>
    <li>
     <a href="#impact"><span class="secno">5</span> <span class="content">Impact on Web Platform</span></a>
     <ol class="toc">
      <li><a href="#storage"><span class="secno">5.1</span> <span class="content">Storage</span></a>
      <li><a href="#document-domain"><span class="secno">5.2</span> <span class="content"><code>document.domain</code></span></a>
      <li><a href="#websockets"><span class="secno">5.3</span> <span class="content">WebSockets</span></a>
     </ol>
    <li>
     <a href="#framework"><span class="secno">6</span> <span class="content">Framework</span></a>
     <ol class="toc">
      <li>
       <a href="#origin-updates"><span class="secno">6.1</span> <span class="content">Updates to Origin</span></a>
       <ol class="toc">
        <li><a href="#suborigin-of-response"><span class="secno">6.1.1</span> <span class="content">Suborigin of a Response</span></a>
        <li><a href="#origin-tuple"><span class="secno">6.1.2</span> <span class="content">Origin Tuple</span></a>
        <li><a href="#physical-origin-concept"><span class="secno">6.1.3</span> <span class="content">Physical Origin</span></a>
        <li><a href="#comparing-origins"><span class="secno">6.1.4</span> <span class="content">Comparing Origins</span></a>
        <li><a href="#comparing-physical-origins"><span class="secno">6.1.5</span> <span class="content">Comparing Physical Origins</span></a>
        <li>
         <a href="#serializing"><span class="secno">6.1.6</span> <span class="content">Serializing Suborigins</span></a>
         <ol class="toc">
          <li><a href="#unicode-serialization"><span class="secno">6.1.6.1</span> <span class="content">Unicode Serialization of a Suborigin</span></a>
          <li><a href="#ascii-serialization"><span class="secno">6.1.6.2</span> <span class="content">ASCII Serialization of a Suborigin</span></a>
          <li><a href="#document-origin"><span class="secno">6.1.6.3</span> <span class="content"><code>Document</code> object’s origin</span></a>
         </ol>
       </ol>
      <li>
       <a href="#dom-interactions"><span class="secno">6.2</span> <span class="content">Interactions with the DOM</span></a>
       <ol class="toc">
        <li><a href="#cookies"><span class="secno">6.2.1</span> <span class="content">Cookies</span></a>
       </ol>
      <li>
       <a href="#security-model-opt-outs"><span class="secno">6.3</span> <span class="content">Security Model Opt-Outs</span></a>
       <ol class="toc">
        <li><a href="#unsafe-postmessage-receive"><span class="secno">6.3.1</span> <span class="content"><code>'unsafe-postmessage-receive'</code></span></a>
        <li><a href="#unsafe-postmessage-send"><span class="secno">6.3.2</span> <span class="content"><code>'unsafe-postmessage-send'</code></span></a>
        <li><a href="#unsafe-cookies"><span class="secno">6.3.3</span> <span class="content"><code>'unsafe-cookies'</code></span></a>
        <li><a href="#unsafe-credentials"><span class="secno">6.3.4</span> <span class="content"><code>'unsafe-credentials'</code></span></a>
       </ol>
     </ol>
    <li><a href="#practical-considerations"><span class="secno">7</span> <span class="content">Practical Considerations in Using Suborigins</span></a>
    <li>
     <a href="#security-considerations"><span class="secno">8</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#presentation-to-users"><span class="secno">8.1</span> <span class="content">Presentation of Suborigins to Users</span></a>
      <li><a href="#not-overthrowing-sop"><span class="secno">8.2</span> <span class="content">Not Overthrowing Same-Origin Policy</span></a>
      <li><a href="#serialization-concerns"><span class="secno">8.3</span> <span class="content">Problems with Serialized Representation</span></a>
     </ol>
    <li><a href="#privacy-considerations"><span class="secno">9</span> <span class="content">Privacy Considerations</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is not normative.</em></p>
   <p>Currently, web applications are almost always compartmentalized by using
  separate host names to establish separate web origins. This is useful for
  helping to prevent XSS and other cross-origin attacks, but has many unintended
  consequences. For example, it causes latency due to additional DNS lookups,
  removes the ability to use single-origin features (such as the
  history.pushState API), and creates cryptic host name changes in the user
  experience. Perhaps most importantly, it results in an extremely inflexible
  architecture that, once rolled out, cannot be easily and transparently changed
  later on.</p>
   <p>There are several mechanisms for reducing the attack surface for XSS without
  creating separate host-name based origins, but each pose their own problems.
  Per-page Suborigins is an attempt to fill some of those gaps. Two of the most
  notable mechanisms are Sandboxed IFrames <a data-link-type="biblio" href="#biblio-iframesandbox" title="Play safely in sandboxed IFrames">[IFrameSandbox]</a> and Content Security
  Policy (CSP) <a data-link-type="biblio" href="#biblio-csp2" title="Content Security Policy Level 2">[CSP2]</a>. Both are powerful but have shortcomings and there are
  external developers building legacy applications that find they cannot use
  those tools.</p>
   <p>Application developers can use sandboxed frames to completely isolate
  untrusted content, but there are a number of problems with such an approach.
  Since user agents assign sandboxed frames a random, unpredictable origin, it is
  very difficult, by design, for them to communicate with other frames or use
  modern, origin-bound mechanisms like <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage" id="ref-for-dom-messageport-postmessage">postMessage</a> and <a data-link-type="dfn" href="#cors" id="ref-for-cors">CORS</a>.
  Further, there is no easy way to persist client-side state (e.g., using <a data-link-type="dfn">localStorage</a> or <a data-link-type="dfn">sessionStorage</a>) in random, unpredictable origins.
  Finally, sandboxed frames not only sandbox the application but also any other
  frames loaded by the appplication. This makes this technique infeasible for any
  page relying on third-party integrations.  Moreover, because they are by
  definition unique origins, with no relationship to the original origin,
  designing permissions for them to access resources of the original origin would
  be difficult.</p>
   <p>Content Security Policy is also promising but is generally incompatible with
  current website design. Developers and security teams have found it impractical to retrofit
  legacy applications with it. On top of this, until all applications
  hosted within a single origin are simultaneously put behind CSP, the mechanism
  offers limited incremental benefits, which is especially problematic for
  companies with large portfolios of disparate products all under the same domain.</p>
   <h3 class="heading settled" data-level="1.1" id="goals"><span class="secno">1.1. </span><span class="content">Goals</span><a class="self-link" href="#goals"></a></h3>
   <ul>
    <li data-md>
     <p>Provide a way for different applications hosted on a single physical origin to
isolate these into separate logical origins. For example, <code>https://foobar.com/application</code> and <code>https://foobar.com/widget</code>, today, are,
by definition, in the same origin, even if they are different applications.
Thus an XSS at <code>https://foobar.com/application</code> means an XSS at <code>https://foobar.com/widget</code>, even if <code>https://foobar.com/widget</code> is
"protected" by a strong Content Security Policy. Suborigins should allow
isolating /application and /widget.</p>
    <li data-md>
     <p>Similarly, provide a way for content authors to split their applications
into logical modules with origin level separation without using different physical
origins. Content authors should not have to choose between putting all of
their content in the same origin, on different physical origins, or putting
content in anonymous unique origins (sandboxes).</p>
    <li data-md>
     <p>Provide safe defaults but also make it as simple as possible to retrofit
legacy applications on the same physical origin with minimal programmatic changes.
This includes providing security-model opt-outs where necessary.</p>
   </ul>
   <h3 class="heading settled" data-level="1.2" id="usecases"><span class="secno">1.2. </span><span class="content">Use Cases/Examples</span><a class="self-link" href="#usecases"></a></h3>
   <p>We see effectively three different use cases for Per-page Suborigins:</p>
   <ol>
    <li data-md>
     <p>Separating distinct applications served from the same domain due to
 deployment issues but do not need to extensively interact with other
 content. Examples include marketing campaigns, simple search UIs, and so on.</p>
    <li data-md>
     <p>Enable secure isolation at modular boundaries within a larger web
 application by splitting the functional components into different
 suborigins. For example, a blogging application might isolate the main blog
 viewership module, the admin module, and the authoring module via separate
 suborigins.</p>
    <li data-md>
     <p>Similar to (2), applications with many users can split information relating
 to different users into their own suborigin. For example, a social network
 might put each user profile into a unique suborigin so that an XSS within
 one profile cannot be used to immediately infect other users or read their
 personal messages stored within the account.</p>
   </ol>
   <div class="example" id="example-08ad93dd">
    <a class="self-link" href="#example-08ad93dd"></a> <code>https://example.com/</code> runs two applications, Chat and Shopping, used,
    respectively, for instant messaging and Internet shopping.  The site adminstrator runs 
    the former at <code>https://example.com/chat/</code>, and the latter at <code>https://example.com/shopping/</code>. 
    <p>The Shopping application has been very well tested and generally does not
    contain much untrusted content. In fact, it only takes simple text from
    advertisers, and that text only ever appears in HTML contexts, so the
    application is able to entity encode the text and stop nearly all cross-site
    scripting attacks on the application. Further, the developers have also
    enabled a strong Content Security Policy to mitigate potential XSS concerns
    on all pages under <code>https://example.com/shopping/</code>. The CSP policy only allows scripts
    from <code>scripts.example.com</code>.</p>
    <p>Historically, <code>https://example.com/chat/</code> has been riddled with cross-site
    scripting attacks. The application takes untrusted content from a wider
    variety of sources and for added complexity, that content ends up in many more
    contexts, such as HTML tag attributes. On top of that, the developers never
    bothered creating a CSP for the application.</p>
    <p>This is bad enough, but, unfortunately, it has led to the extremely bad
    consequence of attackers using the low hanging fruit of Chat to attack
    Shopping, the more desirable target. Cross-site scripting Shopping allows an
    attacker to buy goods with the user’s account, so this is really the juicy
    target.</p>
    <p>Since the applications share the same physical origin, these attacks have not
    traditionally been that difficult. Once an attacker has executed code on Chat
    with an XSS, they open a new window or iframe at <code>example.com/shopping/</code>.
    Since this is at the same origin as Chat, this allows the attacker to inject
    code through the <code>document</code> object of the window or iframe into the Shopping
    context, allowing the attacker to buy whatever they’d like.</p>
    <p>Historical and branding reasons require hosting both applications on the <code>example.com</code> origin. Thus, while these two applications are completely separate, the
    company cannot split the products into two different origins (e.g. <code>examplechat.com</code> and <code>exampleshopping.com</code>) or different suborigins (e.g. <code>chat.example.com</code> and <code>shopping.example.com</code>).</p>
    <p>To address this, the developers decide to serve both applications on two
    separate suborigins. For all HTTP requests to any subpath of <code>/chat</code> or <code>/shopping</code>, example.com includes a header <code>suborigin: chat</code> or <code>suborigin:     shopping</code>, respectively.</p>
    <p>This does not remove any of the XSS attacks on Chat. However, when an attacker
    injects code into Chat and opens a window or iframe to <code>example.com/shopping/</code>, they can no longer inject content through the
    document as it will fail the same origin check. Of course, the application can
    still use <code>XMLHttpRequest</code> and <code>postMessage</code> to communicate with the document,
    but that will only be through well defined APIs.  In short, the CSP of the
    Shopping application is now actually effective as the permissive Chat
    application is no longer a bypass of it.</p>
   </div>
   <p class="issue" id="issue-21aaf26d"><a class="self-link" href="#issue-21aaf26d"></a> TODO: We probably should add additional examples, or perhaps match an
  example to each bullet above.</p>
   <h2 class="heading settled" data-level="2" id="terms"><span class="secno">2. </span><span class="content">Key Concepts and Terminology</span><a class="self-link" href="#terms"></a></h2>
   <p class="issue" id="issue-7af0036e"><a class="self-link" href="#issue-7af0036e"></a> TODO(jww) This needs to be filled in once we have a pretty good handle on
  the basic structure of this document. At that point, we should extract the terms
  defined throughout the spec and place them here.</p>
   <p>This section defines several terms used throughout the document.</p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="cors">CORS</dfn>, or <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="cross-origin-resource-sharing">Cross-Origin Resource Sharing</dfn>, are defined by the
  CORS specification. <a data-link-type="biblio" href="#biblio-cors" title="Cross-Origin Resource Sharing">[CORS]</a></p>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="xmlhttprequest">XMLHttpRequest</dfn>, or <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="xhr">XHR</dfn>, is defined by the XMLHttpRequest
  specification. <a data-link-type="biblio" href="#biblio-xhr" title="XMLHttpRequest Standard">[XHR]</a></p>
   <p>The term <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="cross-site-scripting">cross-site scripting</dfn>, or <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="xss">XSS</dfn> for short, refers to
  a content injection attack where an attacker is able to execute malicious code
  in a victim origin. See the <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)">OWASP page on
  Cross-site Scripting</a> for more information.</p>
   <h3 class="heading settled" data-level="2.1" id="grammar"><span class="secno">2.1. </span><span class="content">Grammatical Concepts</span><a class="self-link" href="#grammar"></a></h3>
    The Augmented Backus-Naur Form (ABNF) notation used in this document is
  specified in RFC5234. <a data-link-type="biblio" href="#biblio-rfc5234" title="Augmented BNF for Syntax Specifications: ABNF">[RFC5234]</a> 
   <p>Lowercase characters, the <code>a-z</code> portion of <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc5234#appendix-B.1" id="ref-for-appendix-B.1">ALPHA</a>, are defined by the grammar:</p>
<pre><dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-loweralpha">LOWERALPHA</dfn> = %x61-7A   ; a-z
</pre>
   <h2 class="heading settled" data-level="3" id="defining-suborigin"><span class="secno">3. </span><span class="content">Defining a Suborigin</span><a class="self-link" href="#defining-suborigin"></a></h2>
   <p>Origins are a mechanism for user agents to group URIs into protection domains.
  Two URIs are in the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#same-origin" id="ref-for-same-origin">same-origin</a> if they share
  the same <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-scheme" id="ref-for-concept-scheme">scheme</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host">host</a>, and <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-port" id="ref-for-concept-port">port</a>.  If URIs are same-origin,
  then they share the same authority and can access all of each others resources.</p>
   <p>Compared to per-user isolation in traditional operating systems, the
  same-origin policy isolates distinct applications identified by their origins.
  This has been a successful isolation mechanism on the Web.  However, it does
  limit the flexibility of a page to separate itself into a new protection domain
  as it automatically shares authority with all other identical origins. These origins
  are defined by physical, rather than programmatic, properties.  While it is
  possible to setup unique domains and ports for different parts of the same
  application (scheme is more difficult to separate out), there are a diverse set
  of practical problems in doing so.</p>
   <p>Suborigins provide a mechanism for creating this type of separation
  programatically. Any resources may provide, in a manner detailed below, a string
  value <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace">suborigin namespace</a>.  If either of two URIs provide a suborigin
  namespace, then the two URIs are in the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#same-origin" id="ref-for-same-origin①">same-origin</a> if and only if they
  share the same <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-scheme" id="ref-for-concept-scheme①">scheme</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host①">host</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-port" id="ref-for-concept-port①">port</a>, and <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace①">suborigin
  namespace</a>.</p>
   <h3 class="heading settled" data-level="3.1" id="difficulties"><span class="secno">3.1. </span><span class="content">Difficulties using subdomains</span><a class="self-link" href="#difficulties"></a></h3>
   <p><em>This section is not normative.</em></p>
   <p>At first glance, subdomains provide an ability to setup multiple origins and
  isolate applications. Unfortunately, a number of practical difficulties make
  relying on subdomains infeasible.</p>
   <h4 class="heading settled" data-level="3.1.1" id="separate-applications-same-origin"><span class="secno">3.1.1. </span><span class="content">Separate applications, same origin</span><a class="self-link" href="#separate-applications-same-origin"></a></h4>
    Google runs Search and Maps on the same domain, respectively <code>https://www.google.com</code> and <code>https://www.google.com/maps</code>. While these two applications are
  fundamentally separate, there are many reasons for hosting them on the same
  origin, including historical links, branding, and performance.  However, from
  security perspective, this means that a compromise of one application is a
  compromise of the other since the only security boundary in the browser is the
  origin, and both applications run in the same origin.  Thus, even if
  Google Search were to successful implement a strong Content Security Policy <a data-link-type="biblio" href="#biblio-csp2" title="Content Security Policy Level 2">[CSP2]</a>, if Google Maps were to have an XSS vulnerability, it would be
  equivalent to having an XSS on Google Search as well, negating Google Search’s
  security measures. 
   <h4 class="heading settled" data-level="3.1.2" id="separation-in-single-application"><span class="secno">3.1.2. </span><span class="content">Separation within a single application</span><a class="self-link" href="#separation-in-single-application"></a></h4>
    Separation is sometimes desirable within a single application because of the
  presence of untrusted data. Take, for example, a social networking site with
  many different user profiles. Each profile contains lots of untrusted content
  created by a single user but it’s all hosted on a single origin. In order to
  separate untrusted content, the application might want a way to put all profile
  information into separate logical origins while all being hosted at the same
  physical origin. Furthermore, all content within a profile should be able to
  access all other content within the same origin, even if displayed in unique
  frames. 
   <p>This type of privilege separation within an application has been shown to be
  valuable and reasonable for applications to do by work such as
  Privilege Separation in HTML5 Applications by Akhawe et al <a data-link-type="biblio" href="#biblio-privilegeseparation" title="Privilege Separation in HTML5 Applications">[PRIVILEGESEPARATION]</a>. However, these systems rely on cross frame messaging
  using <code>postMessage</code> even for content in the same trust boundary since
  they utilize <code>sandbox</code>. This provides much of the motivation for the
  named container nature of suborigins.</p>
   <h3 class="heading settled" data-level="3.2" id="threat-model"><span class="secno">3.2. </span><span class="content">Threat Model</span><a class="self-link" href="#threat-model"></a></h3>
   <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin">Origins</a> and the <a href="http://www.w3.org/Security/wiki/Same_Origin_Policy">Same-Origin Policy</a> have provided a strong defense against
  malicious applications. Instead of giving the application the power of the user,
  applications on the Web are limited to a unique space that is defined by their
  host. However, by tying the origin to the physical host, this has limited the
  power of developers.</p>
   <p>Suborigins attempt to provide developers with tool to contain two different
  principles that are on the same host. Suborigins allow two or more applications
  or modules to be hosted at the same origin but use the same origin policy to
  separate them from each other.</p>
   <h4 class="heading settled" data-level="3.2.1" id="threat-model-cross-doc"><span class="secno">3.2.1. </span><span class="content">Cross-Document Attacker</span><a class="self-link" href="#threat-model-cross-doc"></a></h4>
   <p>An attacker that is able to compromise one document should not be able to
  control another document that is on the same host but delivered in a different
  suborigin namespace. If an attacker is able to <a data-link-type="dfn" href="#xss" id="ref-for-xss">XSS</a>, for example, a
  document on <code>example.com</code> delivered in the suborigin namespace <code>foo</code>,
  the attacker should not be able to control any document on <code>example.com</code> not in the <code>foo</code> namespace.</p>
   <p class="issue" id="issue-4b8e74eb"><a class="self-link" href="#issue-4b8e74eb"></a> TODO(devd): Should we also assert that attacker on main/parent origin
  cannot compromise the app in sub-origin?</p>
   <p class="issue" id="issue-df2253b2"><a class="self-link" href="#issue-df2253b2"></a> "Should not control" is a stronger statement than I think we want to
  make. The browser can only isolate per origin isolation. If the app has a bug
  (due to postmessage or server-side) the browser can’t do anything. We should
  stick to saying "are isolated like physical origins."</p>
   <h4 class="heading settled" data-level="3.2.2" id="threat-model-out-of-scope"><span class="secno">3.2.2. </span><span class="content">Out of Scope Attacker</span><a class="self-link" href="#threat-model-out-of-scope"></a></h4>
   <p>This tool is purely for modularity and meant to be an application security tool.
  It is <em>not</em> meant to help users differentiate between two different
  applications at the same host, as reflected by the fact that user agents may not
  put the suborigin in user-visible UI. Additionally, suborigins cannot protect
  against colluding malicious or compromised applications.</p>
   <h3 class="heading settled" data-level="3.3" id="suborigins-vs-origins"><span class="secno">3.3. </span><span class="content">Relationship of Suborigins to Origins</span><a class="self-link" href="#suborigins-vs-origins"></a></h3>
   <p>Suborigins, in fact, do not provide any new authority to resources. Suborigins
  simply provide <em>an additional way to construct Origins</em>. That is,
  Suborigins do not supercede Origins or provide any additional authority above
  Origins. From the user agent’s  perspective, two resources in different
  Suborigins are simply in different Origins, and the relationship between the
  two resources should be the same as any other two differing origins as
  described in <a href="https://html.spec.whatwg.org/multipage/browsers.html#origin"><cite>HTML</cite> § 7.1.1 Origins</a> and <a data-link-type="biblio" href="#biblio-rfc6454" title="The Web Origin Concept">[RFC6454]</a>. However, given the
  impracticalities this may impart on some applications who might want to adopt
  Suborigins, a few security-model opt-outs to ease the use of Suborigins in
  legacy applications are also presented. See <a href="#security-model-opt-outs">§ 6.3 Security Model Opt-Outs</a> for
  more information.</p>
   <h3 class="heading settled" data-level="3.4" id="opting-in"><span class="secno">3.4. </span><span class="content">Opting into a Suborigin</span><a class="self-link" href="#opting-in"></a></h3>
   <p>Unlike the <code>sandbox</code> attribute, suborigin namespaces are predictable and
  controllable. Because of this, potentially untrusted content cannot opt into
  suborigins, unlike iframe sandboxes. If they could, then an XSS on a site could
  enter a specific suborigin and access all of its resources, thus violating the
  isolation suborigins intend to provide. To prevent this, the
  server (rather than a resource itself) is the only authoritative
  source of the suborigin namespace of a resource. The server communicates the
  suborigin of a resource to the user agent through a new <code>suborigin</code> header,
  which takes a string value that is the namespace. For example, to put a
  resource in the <code>testing</code> suborigin namespace, the server would specify the
  following HTTP header in the response:</p>
<pre>suborigin: testing
</pre>
   <h3 class="heading settled" data-level="3.5" id="the-suborigin-header"><span class="secno">3.5. </span><span class="content">The <code>suborigin</code> header</span><a class="self-link" href="#the-suborigin-header"></a></h3>
   <p>Suborigins are defined by a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="suborigin">suborigin</dfn> HTTP response header. The syntax
  for the name and value of the header are described by the following ABNF
  grammar <a data-link-type="biblio" href="#biblio-rfc5234" title="Augmented BNF for Syntax Specifications: ABNF">[RFC5234]</a>:</p>
<pre><dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-suborigin-name">suborigin-name</dfn> = <a data-link-type="grammar" href="#grammardef-loweralpha" id="ref-for-grammardef-loweralpha">LOWERALPHA</a> *( <a data-link-type="grammar" href="#grammardef-loweralpha" id="ref-for-grammardef-loweralpha①">LOWERALPHA</a> / <a data-link-type="grammar" href="https://tools.ietf.org/html/rfc5234#appendix-B.1" id="ref-for-appendix-B.1①">DIGIT</a> )
<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-suborigin-policy-option">suborigin-policy-option</dfn> = "'unsafe-postmessage-send'"
                          / "'unsafe-postmessage-receive'"
                          / "'unsafe-cookies'"
                          / "'unsafe-credentials'"
<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-suborigin-policy-list">suborigin-policy-list</dfn> = 1*(<a data-link-type="grammar" href="https://tools.ietf.org/html/rfc7230#section-3.2.3" id="ref-for-section-3.2.3">RWS</a> <a data-link-type="grammar" href="#grammardef-suborigin-policy-option" id="ref-for-grammardef-suborigin-policy-option">suborigin-policy-option</a> <a data-link-type="grammar" href="https://tools.ietf.org/html/rfc7230#section-3.2.3" id="ref-for-section-3.2.3①">OWS</a>)
<dfn class="dfn-paneled" data-dfn-type="grammar" data-export id="grammardef-suborigin-header">suborigin-header</dfn> = <a data-link-type="grammar" href="#grammardef-suborigin-name" id="ref-for-grammardef-suborigin-name">suborigin-name</a> [ <a data-link-type="grammar" href="#grammardef-suborigin-policy-list" id="ref-for-grammardef-suborigin-policy-list">suborigin-policy-list</a> ]
</pre>
   <p>User agents MUST ignore multiple suborigin headers and only apply the first.</p>
   <p>A resource’s <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="suborigin-namespace">suborigin namespace</dfn> is the value of the <a data-link-type="grammar" href="#grammardef-suborigin-name" id="ref-for-grammardef-suborigin-name①">suborigin-name</a> in the <code>suborigin</code> header.</p>
   <p>A resource’s <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="suborigin-policy">suborigin policy</dfn> is the list of individual <a data-link-type="grammar" href="#grammardef-suborigin-policy-option" id="ref-for-grammardef-suborigin-policy-option①">suborigin-policy-option</a> values in the <code>suborigin</code> header’s <a data-link-type="grammar" href="#grammardef-suborigin-policy-list" id="ref-for-grammardef-suborigin-policy-list①">suborigin-policy-list</a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> A suborigin name must start with a lowercase character, but after the
  first character, the name may contain lowercase characters or numerals. This
  is to avoid potential confusion when the origin is serialized if the
  serialization started with a number.</p>
   <h3 class="heading settled" data-level="3.6" id="representation"><span class="secno">3.6. </span><span class="content">Representation of Suborigins</span><a class="self-link" href="#representation"></a></h3>
   <p>At an abstract level, a suborigin consists of the <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin">physical
  origin</a>, which is a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-scheme" id="ref-for-concept-scheme②">scheme</a>, <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host②">host</a>, and <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-port" id="ref-for-concept-port②">port</a>, plus a <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace②">suborigin namespace</a>.  However, as mentioned above, suborigins are
  intended to fit within the framework of <a href="https://html.spec.whatwg.org/multipage/browsers.html#origin"><cite>HTML</cite> § 7.1.1 Origins</a> and <a data-link-type="biblio" href="#biblio-rfc6454" title="The Web Origin Concept">[RFC6454]</a>.
  Therefore, this specification provides a way of serializing a Suborigin bound
  resource into a physical origin. This is done by inserting the suborigin
  namespace into the host of the Origin, thus creating a new host but
  maintaining all of the information about both the original scheme, host, port,
  and the suborigin namespace. The serialization format appends the string "-so"
  to the scheme and prepends the host name with the suborigin namespace followed
  by a "." character.</p>
   <p>For example, a resource hosted at <code>https://example.com/</code> in
  the suborigin namespace <code>profile</code> would be serialized as <code>https-so://profile.example.com/</code>.</p>
   <p>Similarly, a resource hosted at <code>https://example.com:8080/</code> in
  the suborigin namespace <code>separate</code> would be serialized as <code>https-so://separate.example.com:8080/</code>.</p>
   <p>Internally, the user agent just tracks the <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace③">suborigin namespace</a> of the resource.
  When the origin needs to be serialized, the user agent should
  follow the algorithm in <a href="#serializing">§ 6.1.6 Serializing Suborigins</a>.</p>
   <p class="issue" id="issue-f67832ce"><a class="self-link" href="#issue-f67832ce"></a> TODO: Determine how the serialization should relate to the URL spec:
  https://url.spec.whatwg.org/#host-parsing</p>
   <h3 class="heading settled" data-level="3.7" id="suborigin-in-js"><span class="secno">3.7. </span><span class="content">Accessing the Suborigin in JavaScript</span><a class="self-link" href="#suborigin-in-js"></a></h3>
   <p>A <code>suborigin</code> property is added to the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">document</a> object which <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/common-dom-interfaces.html#reflect" id="ref-for-reflect">reflects</a> the value of the suborigin namespace for the current execution
  context. If there is no suborigin namespace, the value should be undefined.</p>
   <p>Additionally, the <code>origin</code> property of the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①">document</a> object should reflect
  the serialized value of the origin as returned by <a href="#serializing">§ 6.1.6 Serializing Suborigins</a>.</p>
   <p class="issue" id="issue-1dbd01cb"><a class="self-link" href="#issue-1dbd01cb"></a> TODO(jww): Need to write the formal IDL for this.</p>
   <h2 class="heading settled" data-level="4" id="access-control"><span class="secno">4. </span><span class="content">Access Control</span><a class="self-link" href="#access-control"></a></h2>
   <p>Cross-origin (including cross-suborigin) communication is tricky when suborigins
  are involved because they need to be backwards compatible with user agents that
  do not support suborigins while providing origin-separation for user agents that
  do support suborigins. The following discussions discuss the three major
  cross-origin mechanisms that are relevant: <a data-link-type="dfn" href="#cors" id="ref-for-cors①">CORS</a>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage" id="ref-for-dom-messageport-postmessage①"><code>postMessage</code></a>,
  and workers <a data-link-type="biblio" href="#biblio-workers" title="Web Workers">[WORKERS]</a>.</p>
   <p class="issue" id="issue-4f0009c4"><a class="self-link" href="#issue-4f0009c4"></a> TODO(devd): Making things specific to XHR or CORS is weird. We should
  just make all fetches inside a suborigin CORS fetches and be done with it.</p>
   <h3 class="heading settled" data-level="4.1" id="cors-ac"><span class="secno">4.1. </span><span class="content">CORS</span><a class="self-link" href="#cors-ac"></a></h3>
   <p>For pages in a suborigin namespace, all <a data-link-type="dfn" href="#xmlhttprequest" id="ref-for-xmlhttprequest"><code>XMLHttpRequest</code></a>s and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#concept-fetch" id="ref-for-concept-fetch"><code>fetch</code></a> requests to any URL should be treated as cross-origin, thus
  triggering a <a data-link-type="dfn" href="https://www.w3.org/TR/cors#cross-origin-request-with-preflight-0" id="ref-for-cross-origin-request-with-preflight-0">cross-origin request with preflight</a> for all non-<a data-link-type="dfn" href="https://www.w3.org/TR/cors#simple-cross-origin-request" id="ref-for-simple-cross-origin-request">simple
  cross-origin requests</a>. Additionally, all requests from a suborigin
  namespace must include a <code>Suborigin</code> header whose value is the context’s
  suborigin name.  Finally, the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#origin-header" id="ref-for-origin-header"><code>Origin</code> header</a> <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> value must use
  the serialized suborigin value instead of the serialized origin, as described
  in <a href="#serializing">§ 6.1.6 Serializing Suborigins</a>.</p>
   <p>Similar changes are needed for responses from the server with the addition of an <code>Access-Control-Allow-Suborigin</code> response header. Its value must match the
  context’s suborigin namespace value, or <code>*</code> to allow all suborigin namespaces.
  At the same time, the <code>Access-Control-Allow-Origin</code> response header value must
  be modified to use the serialized suborigin value instead of the serializied
  origin, as described in <a href="#serializing">§ 6.1.6 Serializing Suborigins</a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Since the suborigin of a server resource is unknown until fetched, all
  requests, even to resources in the same suborigin are <em>cross-origin</em>.
  Concretely, imagine putting https://example.com/widget/ in the 'widget'
  suborigin. An XmlHttpRequest from /widget/index.html to /widget/data.json
  will be treatd as a cross origin request. A simple XmlHttpRequest will need
  an Access-Control-Allow-Suborigin header allowing the page to read the
  response. An XmlHttpRequest of content-type text/json will be preflighted.</p>
   <p class="issue" id="issue-5b3d4495"><a class="self-link" href="#issue-5b3d4495"></a> TODO(jww): Formal definition of the headers and responses w/grammars.
  Also need to be explicit about <code>*</code> having same limitations as <code>Access-Control-Allow-Origin</code> w/credentials.</p>
   <p class="issue" id="issue-6750573e"><a class="self-link" href="#issue-6750573e"></a> Access-Control-Allow-Origin * fails with credentialed requests. Does
  Access-Control-Allow-Suborigin have the same behavior? We should detail that
  in more detail.</p>
   <p class="issue" id="issue-5be18446"><a class="self-link" href="#issue-5be18446"></a> Browsers have a really low cache time (15mins) for preflight responses
  which makes CORS a big pain for websites. This will become even more salient
  with suborigins. Should the spec ask browsers to increase cache times?</p>
   <p class="issue" id="issue-aedb28e2"><a class="self-link" href="#issue-aedb28e2"></a> Serializing the suborigin value into the origin header seems like it
  will break things. Whats the risk with serializing the physical origin in the
  origin header? The browser won’t let you read the responses (or succeed
  preflight) if neither of them have the right allow-suborigin behavior. This
  seems more compatible with no security risk.</p>
   <h3 class="heading settled" data-level="4.2" id="postmessage-ac"><span class="secno">4.2. </span><span class="content"><code>postMessage</code></span><a class="self-link" href="#postmessage-ac"></a></h3>
   <p>Cross-origin messaging via <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage" id="ref-for-dom-messageport-postmessage②"><code>postMessage</code></a> requires that the recipient be
  able to see the suborigin namespace of the message sender so it can make an
  appropriate access control decision. We introduce a new dictionary <code>ExtendedOrigin</code> that holds information about both the origin and
  the suborigin namespace:</p>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-extendedorigin"><code><c- g>ExtendedOrigin</c-></code></dfn> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString"><c- b>USVString</c-></a> <dfn class="dfn-paneled idl-code" data-default="&quot;&quot;" data-dfn-for="ExtendedOrigin" data-dfn-type="dict-member" data-export data-type="USVString" id="dom-extendedorigin-origin"><code><c- g>origin</c-></code></dfn> = "";
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString①"><c- b>USVString</c-></a>? <dfn class="dfn-paneled idl-code" data-default="null" data-dfn-for="ExtendedOrigin" data-dfn-type="dict-member" data-export data-type="USVString?" id="dom-extendedorigin-suborigin"><code><c- g>suborigin</c-></code></dfn> = <c- b>null</c->;
};
</pre>
   <p class="issue" id="issue-c9cb881f"><a class="self-link" href="#issue-c9cb881f"></a> We’re monkey-patching HTML, submit a PR when we’re sure this is the
  general direction we want to go in.</p>
   <p>And we extend the definition of the MessageEvent and MessageEventInit as follows:</p>
<pre class="idl highlight def"><c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="messageevent"><code><c- g>MessageEvent</c-></code></dfn> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString②"><c- b>USVString</c-></a>? <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent" data-dfn-type="attribute" data-export data-readonly data-type="USVString?" id="dom-messageevent-origin"><code><c- g>origin</c-></code></dfn>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin" id="ref-for-dictdef-extendedorigin"><c- n>ExtendedOrigin</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent" data-dfn-type="attribute" data-export data-readonly data-type="ExtendedOrigin" id="dom-messageevent-extendedorigin"><code><c- g>extendedOrigin</c-></code></dfn>;
  <a data-link-type="idl-name"><c- n>void</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent" data-dfn-type="method" data-export data-lt="initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports)|initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source)|initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId)|initMessageEvent(type, bubbles, cancelable, data, extendedOrigin)|initMessageEvent(type, bubbles, cancelable, data)|initMessageEvent(type, bubbles, cancelable)|initMessageEvent(type, bubbles)|initMessageEvent(type)" id="dom-messageevent-initmessageevent"><code><c- g>initMessageEvent</c-></code></dfn>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-type"><code><c- g>type</c-></code></dfn>, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-bubbles"><code><c- g>bubbles</c-></code></dfn> = <c- b>false</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean①"><c- b>boolean</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-cancelable"><code><c- g>cancelable</c-></code></dfn> = <c- b>false</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any" id="ref-for-idl-any"><c- b>any</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-data"><code><c- g>data</c-></code></dfn> = <c- b>null</c->, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin" id="ref-for-dictdef-extendedorigin①"><c- n>ExtendedOrigin</c-></a>? <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-extendedorigin"><code><c- g>extendedOrigin</c-></code></dfn> = <c- b>null</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString①"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-lasteventid"><code><c- g>lastEventId</c-></code></dfn> = "", <c- b>optional</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/comms.html#messageeventsource" id="ref-for-messageeventsource"><c- n>MessageEventSource</c-></a>? <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-source"><code><c- g>source</c-></code></dfn> = <c- b>null</c->, <c- b>optional</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/web-messaging.html#messageport" id="ref-for-messageport"><c- n>MessagePort</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId), MessageEvent/initMessageEvent(type, bubbles, cancelable, data, extendedOrigin), MessageEvent/initMessageEvent(type, bubbles, cancelable, data), MessageEvent/initMessageEvent(type, bubbles, cancelable), MessageEvent/initMessageEvent(type, bubbles), MessageEvent/initMessageEvent(type)" data-dfn-type="argument" data-export id="dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-ports"><code><c- g>ports</c-></code></dfn> = []);
};

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-messageeventinit"><code><c- g>MessageEventInit</c-></code></dfn> {
  <a data-link-type="idl-name" href="#dictdef-extendedorigin" id="ref-for-dictdef-extendedorigin②"><c- n>ExtendedOrigin</c-></a>? <dfn class="dfn-paneled idl-code" data-default="null" data-dfn-for="MessageEventInit" data-dfn-type="dict-member" data-export data-type="ExtendedOrigin?" id="dom-messageeventinit-extendedorigin"><code><c- g>extendedOrigin</c-></code></dfn> = <c- b>null</c->;
};
</pre>
   <p>Similarly, we add a new overloaded version of postMessage to the Window interface:</p>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window"><c- g>Window</c-></a> {
  <a data-link-type="idl-name"><c- n>void</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="Window" data-dfn-type="method" data-export data-lt="postMessage(message, targetOrigin, transfer)|postMessage(message, targetOrigin)|postMessage(message)" id="dom-window-postmessage"><code><c- g>postMessage</c-></code></dfn>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any" id="ref-for-idl-any①"><c- b>any</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="Window/postMessage(message, targetOrigin, transfer), Window/postMessage(message, targetOrigin), Window/postMessage(message)" data-dfn-type="argument" data-export id="dom-window-postmessage-message-targetorigin-transfer-message"><code><c- g>message</c-></code></dfn>, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin" id="ref-for-dictdef-extendedorigin③"><c- n>ExtendedOrigin</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="Window/postMessage(message, targetOrigin, transfer), Window/postMessage(message, targetOrigin), Window/postMessage(message)" data-dfn-type="argument" data-export id="dom-window-postmessage-message-targetorigin-transfer-targetorigin"><code><c- g>targetOrigin</c-></code></dfn>, <c- b>optional</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence①"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-object" id="ref-for-idl-object"><c- b>object</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="Window/postMessage(message, targetOrigin, transfer), Window/postMessage(message, targetOrigin), Window/postMessage(message)" data-dfn-type="argument" data-export id="dom-window-postmessage-message-targetorigin-transfer-transfer"><code><c- g>transfer</c-></code></dfn> = []);
};
</pre>
   <p>Those new interfaces can also be used to communicate with browsing contexts
  that aren’t in a suborigin namespace. Furthermore, the <code>origin</code> attribute of
  an <code>MessageEvent</code> will be <code>null</code> (the value, not the string) if the <code>suborigin</code> attribute of the event’s <code>extendedOrigin</code> is non-<code>null</code>, unless
  either <code>unsafe-postmessage-receive</code> or <code>unsafe-postmessage-send</code> was
  specified (depending on whether the context inside the suborigin, or its
  communication peers don’t support this API).</p>
   <p>If the <code>suborigin</code> attribute of the <code>EventInitializer</code> passed to <code>postMessage</code> is the literal string <code>*</code>, it will match any suborigin
  namespace, including if the receiver doesn’t have any suborigin. Otherwise,
  the suborigin has to match exactly. A browsing context that doesn’t specify a
  suborigin is matched by the value <code>null</code>, and not by the empty string. Again,
  the restriction that a suborigin namespace is required can be removed via the <code>unsafe-postmessage-receive</code> and <code>unsafe-postmessage-send</code> options.</p>
   <p class="example" id="example-f411dc24"><a class="self-link" href="#example-f411dc24"></a> Website authors can use the presence of the EventInitializer constructor to
    feature detect the presence of these new interfaces. For <code>postMessage</code> and <code>initMessageEvent</code>, authors can also add a custom <code>toString</code> method to the
    dictionary they pass to it like so: </p>
<pre>postMessage(data, {
    'origin': 'http://example.com',
    'suborigin': '*',
    'toString': () => { return 'http://example.com' }
});
</pre>
   <p></p>
   <p class="issue" id="issue-ebe2c3d2"><a class="self-link" href="#issue-ebe2c3d2"></a> TODO(jww): Formalize by updating the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage" id="ref-for-dom-messageport-postmessage③">postMessage</a> algorithm</p>
   <h3 class="heading settled" data-level="4.3" id="workers-ac"><span class="secno">4.3. </span><span class="content">Workers</span><a class="self-link" href="#workers-ac"></a></h3>
   <p>User agents MUST refuse to create or execute any workers in a page executing in
  a sub-origin.</p>
   <p class="issue" id="issue-3fffd8fc"><a class="self-link" href="#issue-3fffd8fc"></a> TODO: Formalize. Not sure what this will look like yet. Chrome and
  Opera don’t allow creation of workers from sandbox’d iframes/the 'null'
  origin, but not sure if this formalized in a spec. If it is, should probably
  just update whatever disallows creation from sandbox.</p>
   <p class="note" role="note"><span class="marker">Note:</span> This may change in the future, and suborigins may eventually be allowed to
  register service workers, but, for now, allowing the creation of any workers,
  including service workers and shared workers, from suborigins adds too many
  complications. Applications can still create workers by creating an iframe of
  a page not in a suborigin.</p>
   <h2 class="heading settled" data-level="5" id="impact"><span class="secno">5. </span><span class="content">Impact on Web Platform</span><a class="self-link" href="#impact"></a></h2>
   <p>Content inside a suborigin namespace is restricted in the same way that other
  origins are restricted. There are some additional restrictions as well, in
  order to simplify some complicated cases.</p>
   <h3 class="heading settled" data-level="5.1" id="storage"><span class="secno">5.1. </span><span class="content">Storage</span><a class="self-link" href="#storage"></a></h3>
   <p>The storage APIs, such as <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage" id="ref-for-dom-localstorage">localStorage</a></code> and <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#dom-sessionstorage" id="ref-for-dom-sessionstorage">sessionStorage</a></code>, are
  accessible from within suborigins. By nature of their APIs, they are bound to
  the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin①">origin</a> of the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code>, which has the practical effect of
  giving a separate <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#storage-2" id="ref-for-storage-2">Storage</a></code> object to each <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace④">suborigin namespace</a>. Per
  the definitions in <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage" id="ref-for-dom-localstorage①">localStorage</a></code> and <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#dom-sessionstorage" id="ref-for-dom-sessionstorage①">sessionStorage</a></code>, the user agent
  MUST provide separate <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/webstorage.html#storage-2" id="ref-for-storage-2①">Storage</a></code> objects per <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin②">origin</a>, and thus per <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace⑤">suborigin namespace</a>.</p>
   <h3 class="heading settled" data-level="5.2" id="document-domain"><span class="secno">5.2. </span><span class="content"><code>document.domain</code></span><a class="self-link" href="#document-domain"></a></h3>
   <p>The <code class="idl"><a data-link-type="idl">document.domain</a></code> property
  User agents MUST ignore modifications to the document.domain property of the
  page.</p>
   <h3 class="heading settled" data-level="5.3" id="websockets"><span class="secno">5.3. </span><span class="content">WebSockets</span><a class="self-link" href="#websockets"></a></h3>
   <p>The <a href="https://www.w3.org/TR/websockets/#the-websocket-interface"><code>WebSocket()</code> constructor algrithm</a> <a data-link-type="biblio" href="#biblio-websockets" title="WebSockets Standard">[WebSockets]</a> is modified as follows:</p>
   <p>After  the current step 1, perform the following step:</p>
   <ol start="2">
    <li data-md>
     <p>If the <a href="https://www.w3.org/TR/html51/webappapis.html#environment-settings-object">origin property</a> of the <em>client</em>’s <a href="https://www.w3.org/TR/html51/webappapis.html#relevant-settings-object">relevant settings object</a> has a <a data-link-type="dfn" href="#suborigin" id="ref-for-suborigin">suborigin</a>, throw a <a href="https://www.w3.org/TR/WebIDL-1/#h-idl-domexception-error-names">SecurityError exception</a>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> Suborigins are likely to allow WebSockets in the future, but are
  disabled until it can be decided how they should be protected.</p>
   <h2 class="heading settled" data-level="6" id="framework"><span class="secno">6. </span><span class="content">Framework</span><a class="self-link" href="#framework"></a></h2>
   <p class="note" role="note"><span class="marker">Note:</span> These sections are tricky because, unlike physical origins, we can’t
  define suborigins in terms of URIs. Since the suborigin namespace is defined in
  a header, not in the URI, we need to define them in terms of resources.</p>
   <h3 class="heading settled" data-level="6.1" id="origin-updates"><span class="secno">6.1. </span><span class="content">Updates to Origin</span><a class="self-link" href="#origin-updates"></a></h3>
   <p>Suborigins extends the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin③">origin</a> concept. The following sections define
  how this extension works.</p>
   <h4 class="heading settled" data-level="6.1.1" id="suborigin-of-response"><span class="secno">6.1.1. </span><span class="content">Suborigin of a Response</span><a class="self-link" href="#suborigin-of-response"></a></h4>
   <p>TODO: This needs update Fetch to change the origin of response. Maybe just
  need to make sure that response’s URL has the suborigin serialized?a
  https://fetch.spec.whatwg.org/#responses</p>
   <h4 class="heading settled" data-level="6.1.2" id="origin-tuple"><span class="secno">6.1.2. </span><span class="content">Origin Tuple</span><a class="self-link" href="#origin-tuple"></a></h4>
   <p>Update the definition of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin-tuple" id="ref-for-concept-origin-tuple">tuple origin</a> in the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin④">origin</a> section of <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> to read:</p>
   <p>A tuple consists of:</p>
   <ul>
    <li data-md>
     <p>A scheme (a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-scheme" id="ref-for-concept-scheme③">scheme</a>).</p>
    <li data-md>
     <p>A host (a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host③">host</a>).</p>
    <li data-md>
     <p>A port (a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-port" id="ref-for-concept-port③">port</a>).</p>
    <li data-md>
     <p>A domain (null or a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-domain" id="ref-for-concept-domain">domain</a>). Null unless stated otherwise.</p>
    <li data-md>
     <p>A suborigin (a <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace⑥">suborigin namespace</a>). The empty string unless stated
otherwise.</p>
   </ul>
   <h4 class="heading settled" data-level="6.1.3" id="physical-origin-concept"><span class="secno">6.1.3. </span><span class="content">Physical Origin</span><a class="self-link" href="#physical-origin-concept"></a></h4>
    The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="physical-origin">physical origin</dfn> of an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin" id="ref-for-concept-origin⑤">origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#concept-origin-tuple" id="ref-for-concept-origin-tuple①">origin tuple</a> where the components are: 
   <ul>
    <li data-md>
     <p>The scheme is the scheme component of the origin</p>
    <li data-md>
     <p>The host is the host component of the origin</p>
    <li data-md>
     <p>The port is the port component of the origin</p>
    <li data-md>
     <p>The domain is the domain component of the origin</p>
    <li data-md>
     <p>The suborigin is the empty string</p>
   </ul>
   <h4 class="heading settled" data-level="6.1.4" id="comparing-origins"><span class="secno">6.1.4. </span><span class="content">Comparing Origins</span><a class="self-link" href="#comparing-origins"></a></h4>
   <p>Update the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin②">same origin</a> algorithm in <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> such that step 2 reads:</p>
   <ol start="2">
    <li data-md>
     <p>If A and B are both tuple origins and their schemes, hosts, ports, and
 suborigins are identical, then return true.</p>
   </ol>
   <h4 class="heading settled" data-level="6.1.5" id="comparing-physical-origins"><span class="secno">6.1.5. </span><span class="content">Comparing Physical Origins</span><a class="self-link" href="#comparing-physical-origins"></a></h4>
   <p>Two origins, A and B, are said to be <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="same-physical-origin">same physical origin</dfn> if the
  following algorithm returns true:</p>
   <ol>
    <li data-md>
     <p>Let AP be the <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin①">physical origin</a> of A. Let BP be the <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin②">physical
 origin</a> of B.</p>
    <li data-md>
     <p>If AP and BP are the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin③">same origin</a>, return true.</p>
    <li data-md>
     <p>Return false.</p>
   </ol>
   <h4 class="heading settled" data-level="6.1.6" id="serializing"><span class="secno">6.1.6. </span><span class="content">Serializing Suborigins</span><a class="self-link" href="#serializing"></a></h4>
   <p>This section defines how to serialize an origin to a Unicode <a data-link-type="biblio" href="#biblio-unicode6" title="The Unicode Standard, Version 6.2.0">[Unicode6]</a> string and to an ASCII <a data-link-type="biblio" href="#biblio-rfc0020" title="ASCII format for network interchange">[RFC0020]</a> string.</p>
   <h5 class="heading settled" data-level="6.1.6.1" id="unicode-serialization"><span class="secno">6.1.6.1. </span><span class="content">Unicode Serialization of a Suborigin</span><a class="self-link" href="#unicode-serialization"></a></h5>
   <p>Update the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#unicode-serialisation-of-an-origin" id="ref-for-unicode-serialisation-of-an-origin">Unicode serialization of an origin</a> in <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> by modifying
  step 4 to read:</p>
   <ol start="4">
    <li data-md>
     <p>Let unicodeOrigin be a new tuple origin consisting origin’s scheme,
 unicodeHost, origin’s port, and origin’s suborigin.</p>
   </ol>
   <h5 class="heading settled" data-level="6.1.6.2" id="ascii-serialization"><span class="secno">6.1.6.2. </span><span class="content">ASCII Serialization of a Suborigin</span><a class="self-link" href="#ascii-serialization"></a></h5>
   <p>Update the steps of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#ascii-serialisation-of-an-origin" id="ref-for-ascii-serialisation-of-an-origin">ASCII serialization of an origin</a> in <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a> to
  read:</p>
   <ol>
    <li data-md>
     <p>If origin is an opaque origin, then return "null".</p>
    <li data-md>
     <p>Otherwise, let result be origin’s scheme.</p>
    <li data-md>
     <p>Let <code>schemeSuffix</code> be "-so://" if the suborigin component of origin is not
 the empty string, and "://" otherwise.</p>
    <li data-md>
     <p>Let <code>hostPrefix</code> be the suborigin component of origin with "." appended to
 it if the suborigin component of origin is not the empty string, and ""
 otherwise.</p>
    <li data-md>
     <p>Append <code>schemeSuffix</code> to result.</p>
    <li data-md>
     <p>Append <code>hostPrefix</code> to result.</p>
    <li data-md>
     <p>Append origin’s host, serialized, to result.</p>
    <li data-md>
     <p>If origin’s port is non-null, append a U+003A COLON character (:), and
 origin’s port, serialized, to result.</p>
    <li data-md>
     <p>Return result.</p>
   </ol>
   <h5 class="heading settled" data-level="6.1.6.3" id="document-origin"><span class="secno">6.1.6.3. </span><span class="content"><code>Document</code> object’s origin</span><a class="self-link" href="#document-origin"></a></h5>
   <p>TODO: Need to assign how Document gets a suborigin. Need to patch the "For
  Document objects" subsection of https://html.spec.whatwg.org/#origin. Will
  also probably need to update https://fetch.spec.whatwg.org/#concept-response
  to have a suborigin property, which uses that response to assign a suborigin
  to the origin tuple for Object, similar to
  https://w3c.github.io/webappsec-csp/#sandbox-init.</p>
   <h3 class="heading settled" data-level="6.2" id="dom-interactions"><span class="secno">6.2. </span><span class="content">Interactions with the DOM</span><a class="self-link" href="#dom-interactions"></a></h3>
   <h4 class="heading settled" data-level="6.2.1" id="cookies"><span class="secno">6.2.1. </span><span class="content">Cookies</span><a class="self-link" href="#cookies"></a></h4>
   <p>Append the following to the list of conditions of <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> objects that are <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse">cookie-averse</a> in Section 3.1.2 of HTML5’s <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#resource-metadata-management" id="ref-for-resource-metadata-management">resource metadata
  management</a>:</p>
   <ul>
    <li data-md>
     <p>A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> who has a non-empty <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace⑦">suborigin namespace</a>, unless the <a data-link-type="grammar" href="#grammardef-suborigin-policy-option" id="ref-for-grammardef-suborigin-policy-option②">suborigin-policy-option</a> for the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code>'s <a data-link-type="dfn" href="#suborigin-policy" id="ref-for-suborigin-policy">suborigin policy</a> contains the <a href="#unsafe-cookies">§ 6.3.3 'unsafe-cookies'</a> value.</p>
   </ul>
   <p>Modify the paragraph following this list to read "scheme/host/port/suborigin
  tuple" instead of "scheme/host/port tuple".</p>
   <p>Additionally, modify step 1 of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#attr-meta-http-equiv-set-cookie" id="ref-for-attr-meta-http-equiv-set-cookie">Cookie setter</a> to read:</p>
   <ol>
    <li data-md>
     <p>If the meta element has no content attribute, or if that attribute’s value
 is the empty string, or if the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code> is <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse①">cookie-averse</a> then
 abort these steps.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> A <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse②">cookie-averse</a> <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code> object has the property that direct
  access to <code>document.cookie</code> returns the empty string, and assigning to <code>document.cookie</code> has no effect whatsoever. However, that network cookies are
  not affected and documents with different <a data-link-type="dfn" href="#suborigin-namespace" id="ref-for-suborigin-namespace⑧">suborigin namespaces</a> on the
  same <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin③">physical origin</a> share the same cookies on the network.</p>
   <p class="note" role="note"><span class="marker">Note:</span> For practical purposes, this means that a developer cannot use <code>document.cookie</code> directly because assignment and reading of the object are both
  no-ops. However, a <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse③">cookie-averse</a> <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑥">Document</a></code> may
  still use getters and setters on the <code>cookie</code> property of the <code>document</code> object
  and, in that way, may still simulate cookie access.</p>
   <p class="issue" id="issue-90521f50"><a class="self-link" href="#issue-90521f50"></a> Currently, some browsers do not let applications redefine getters and
  setters on cookie averse documents. Should the spec enforce that this is
  allowed?</p>
   <h3 class="heading settled" data-level="6.3" id="security-model-opt-outs"><span class="secno">6.3. </span><span class="content">Security Model Opt-Outs</span><a class="self-link" href="#security-model-opt-outs"></a></h3>
   <p>For backwards compatibility, Suborigins provide several opt-opts from the
  standard security model. A developer can choose to use these opt-outs by
  specifying a <a data-link-type="dfn" href="#suborigin-policy" id="ref-for-suborigin-policy①">suborigin policy</a> in <a href="#the-suborigin-header">the
  suborigin header</a></p>
   <p>Since these opt-outs weaken the security model of suborigins, developers SHOULD
  NOT use these options unless they are required to make their application work.</p>
   <p>The values of <a data-link-type="grammar" href="#grammardef-suborigin-policy-option" id="ref-for-grammardef-suborigin-policy-option③">suborigin-policy-option</a> that may be
  present in a <a data-link-type="dfn" href="#suborigin-policy" id="ref-for-suborigin-policy②">suborigin policy</a> have the following effects:</p>
   <h4 class="heading settled" data-level="6.3.1" id="unsafe-postmessage-receive"><span class="secno">6.3.1. </span><span class="content"><code>'unsafe-postmessage-receive'</code></span><a class="self-link" href="#unsafe-postmessage-receive"></a></h4>
    If <code>unsafe-postmessage-receive</code> is set, <code>MessageEvent</code>s sent to
  browsing context in the respective suborigin namespace will expose the
  serialization of their physical origin via the <code>origin</code> attribute of the <code>MessageEvent</code>s. Browsing context sending <code>MessageEvent</code>s to the suborigin
  do not need to specify a target suborigin. 
   <h4 class="heading settled" data-level="6.3.2" id="unsafe-postmessage-send"><span class="secno">6.3.2. </span><span class="content"><code>'unsafe-postmessage-send'</code></span><a class="self-link" href="#unsafe-postmessage-send"></a></h4>
    If <code>unsafe-postmessage-send</code> is set, the legacy <code>postMessage</code> method can
  be used to communicate from within the browsing context in the respective
  suborigin. The <code>MessageEvent</code>s dispatched in response to a <code>postMessage</code> from
  the respective suborigin will expose the serializatoin of the suborigin’s
  physical origin via the <code>origin</code> attribute. 
   <h4 class="heading settled" data-level="6.3.3" id="unsafe-cookies"><span class="secno">6.3.3. </span><span class="content"><code>'unsafe-cookies'</code></span><a class="self-link" href="#unsafe-cookies"></a></h4>
    Normally, a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑦">Document</a></code> with a non-empty suborigin namespace is <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse④">cookie-averse</a>, which means that cookies cannot be read or written.
  However, if the <a data-link-type="dfn" href="#suborigin-policy" id="ref-for-suborigin-policy③">suborigin policy</a> contains the <code>unsafe-cookies</code> option,
  the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑧">Document</a></code> is <em>not</em> made <a data-link-type="dfn" href="http://www.w3.org/TR/html51/dom.html#cookie-averse" id="ref-for-cookie-averse⑤">cookie-averse</a>, which leaves
  cookies readable and writable by the execution context. See <a href="#cookies">§ 6.2.1 Cookies</a> for
  the precise definition of how this is defined. 
   <p>Practically speaking, this means that code executing in this suborigin can
  access and set cookies for any other suborigin at that <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin④">physical origin</a>,
  including the empty suborigin. Thus, this option SHOULD NOT be used if cookies
  are security-sensitive in your application.</p>
   <p class="note" role="note"><span class="marker">Note:</span> This option is intended only for easing deployment. Application authors
  should carefully evaluate the risk and impact on their application before
  turning it on. The untrusted sub-origin code can overwrite session cookies
  and execute a session fixation attack on the applications running in the
  physical origin. Worse, if an application on the physical origin relies on
  simple double-submit CSRF tokens (not tied to the session), then an untrusted
  sub-origin can execute arbitrary CSRF attacks. Similarly, if session ccookies
  or CSRF cookies are readable from javascript (i.e., they are not Http-Only),
  then the untrusted sub-origin can steal the user’s session or execute
  arbitrary CSRF attacks.</p>
   <h4 class="heading settled" data-level="6.3.4" id="unsafe-credentials"><span class="secno">6.3.4. </span><span class="content"><code>'unsafe-credentials'</code></span><a class="self-link" href="#unsafe-credentials"></a></h4>
   <p>All cross-origin requests  to the <a data-link-type="dfn" href="#physical-origin" id="ref-for-physical-origin⑤">physical origin</a> for the execution
  context will include <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#credentials" id="ref-for-credentials">credentials</a> if the <code>'unsafe-credentials'</code> suborigin policy option for the execution context is set.</p>
   <p>Specifically, update the step 2 of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#http-network-or-cache-fetch" id="ref-for-http-network-or-cache-fetch">HTTP-network-or-cache fetch</a> in the
  Fetch spec <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a> to read:</p>
   <ol start="2">
    <li data-md>
     <p>Let credentials flag be set if one of</p>
     <ul>
      <li data-md>
       <p><code>request</code>’s credentials mode is "include"</p>
      <li data-md>
       <p><code>request</code>’s credentials mode is "same-origin" and request’s response
 tainting is "basic"</p>
      <li data-md>
       <p><code>request</code>’s credentials mode is "same-origin" and <code>request</code>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a> has the <code>suborigin unsafe        credentials</code> flag set and the request’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#concept-request-current-url" id="ref-for-concept-request-current-url">current url</a> is <a data-link-type="dfn" href="#same-physical-origin" id="ref-for-same-physical-origin">same physical origin</a> with <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#concept-request-origin" id="ref-for-concept-request-origin">request origin</a>.</p>
     </ul>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> This has several important, practical effects. If the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org#concept-request-credentials-mode" id="ref-for-concept-request-credentials-mode">credentials
  mode</a> of a <code>fetch()</code> is set to "same-origin", and if it is to the same
  physical origin as the current execution context, credentials will be
  included. This means that if the <code>crossorigin</code> attribute on elements such
  as <code>&lt;img></code> are set to <code>anonymous</code>, credentials will be sent if the origin
  of the URL is the same physical origin. Similarly, if making an <a data-link-type="dfn" href="#xmlhttprequest" id="ref-for-xmlhttprequest①">XMLHttpRequest</a>, setting this flag is equivalent to setting <a data-link-type="dfn" href="https://xhr.spec.whatwg.org/#the-withcredentials-attribute" id="ref-for-the-withcredentials-attribute"><code>withCredentials</code></a> to <code>true</code> for requests to the same physical
  origin. This means that it credentials will be sent even for requests to
  another suborigin at the same physical origin.</p>
   <p class="issue" id="issue-ec925137"><a class="self-link" href="#issue-ec925137"></a> TODO(jww,aaj): Provide an example of why this might be needed.</p>
   <p class="issue" id="issue-9b7d04a5"><a class="self-link" href="#issue-9b7d04a5"></a> TODO: These opt-out descriptions should probably be moved to the
  individual sections where the behaviors are discussed (i.e. postMessage and
  cookies). These just need to be fleshed out anyway, and examples and reasons
  need to be given. Also, they need to update the processing model, such as
  adding appropriate flags to the environment settings object.</p>
   <h2 class="heading settled" data-level="7" id="practical-considerations"><span class="secno">7. </span><span class="content">Practical Considerations in Using Suborigins</span><a class="self-link" href="#practical-considerations"></a></h2>
   <p>Using suborigins with a Web application should be relatively simple. At the most
  basic level, if you have an application hosted on <code>https://example.com/app/</code>,
  and all of its resources are hosted at subpaths of <code>/app</code>, it requires that the
  server set a Content Security Policy on all HTTP requests to subpaths of <code>/app</code> that contain the header <code>suborigin: namespace</code>, where <code>namespace</code> is of the
  application’s choosing. This will ensure that the user agent loads all of these
  resources into the suborigin <code>namespace</code> and will enforce this boundary
  accordingly.</p>
   <p>Additionally, if your application allows cross-origin requests, instead of
  adding the usual <code>Access-Control-Allow-Origin</code> header for cross-origin requests,
  add <code>Access-Control-Allow-Suborigin</code> headers, as defined in <a href="#cors-ac">§ 4.1 CORS</a>.</p>
   <p>In the client-side portion of the application, if <code>postMessage</code> is used, the
  application must be modified so it does not check the <code>event.origin</code> field.
  Instead, it the <code>event.suborigin</code> fields, as they are defined in <a href="#postmessage-ac">§ 4.2 postMessage</a>.</p>
   <p class="issue" id="issue-810c1065"><a class="self-link" href="#issue-810c1065"></a> TODO(devd): Flesh out the above and make sure it covers all it needs to
  cover.</p>
   <h2 class="heading settled" data-level="8" id="security-considerations"><span class="secno">8. </span><span class="content">Security Considerations</span><a class="self-link" href="#security-considerations"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="presentation-to-users"><span class="secno">8.1. </span><span class="content">Presentation of Suborigins to Users</span><a class="self-link" href="#presentation-to-users"></a></h3>
   <p>A complication of suborigins is that while they provide a meaningful security
  for an application, that boundary makes much less sense to a user. That is,
  physical origins provide a security boundary at a physical level: separate
  scheme, hosts, and ports map to real boundaries external of a given application.
  However, suborigins as a boundary only makes sense <em>within the context of the
  program logic itself</em>, and there is no meaningful way for users to make
  decisions based on suborigins a priori.</p>
   <p>Therefore, suborigins should be used only internally in a user agent and MUST
  NOT be presented to users at all. For example, user agents must never present
  suborigins in link text or a URL bar.</p>
   <p class="issue" id="issue-d4f11cd7"><a class="self-link" href="#issue-d4f11cd7"></a> Is history.pushState allowed in a suborigin? I suggest no to reduce
  complexity and inherit from sandbox behavior. On the other hand, this impacts
  compatibility.</p>
   <h3 class="heading settled" data-level="8.2" id="not-overthrowing-sop"><span class="secno">8.2. </span><span class="content">Not Overthrowing Same-Origin Policy</span><a class="self-link" href="#not-overthrowing-sop"></a></h3>
   <p>Suborigins do not fundamentally change how the same-origin policy works. An
  application without suborigins should work identically to how it always has, and
  even in an application with suborigins, the same-origin policy still applies as
  always. In fact, this document defines suborigins within the context of the
  same-origin policy so that, in theory, serialized suborigins can be thought of
  as a just a special case of the traditional same-origin policy.</p>
   <h3 class="heading settled" data-level="8.3" id="serialization-concerns"><span class="secno">8.3. </span><span class="content">Problems with Serialized Representation</span><a class="self-link" href="#serialization-concerns"></a></h3>
   <p class="issue" id="issue-d8492fe3"><a class="self-link" href="#issue-d8492fe3"></a> TODO: Need to list concerns with serialization, e.g. apps that don’t
  recognize the suborigin serialization, esp. if they blocklist origins.</p>
   <h2 class="heading settled" data-level="9" id="privacy-considerations"><span class="secno">9. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy-considerations"></a></h2>
   <p class="issue" id="issue-747044d5"><a class="self-link" href="#issue-747044d5"></a> TODO: Do we have privacy issues?</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#cors">CORS</a><span>, in § 2</span>
   <li><a href="#cross-origin-resource-sharing">Cross-Origin Resource Sharing</a><span>, in § 2</span>
   <li><a href="#cross-site-scripting">cross-site scripting</a><span>, in § 2</span>
   <li><a href="#dictdef-extendedorigin">ExtendedOrigin</a><span>, in § 4.2</span>
   <li>
    extendedOrigin
    <ul>
     <li><a href="#dom-messageevent-extendedorigin">attribute for MessageEvent</a><span>, in § 4.2</span>
     <li><a href="#dom-messageeventinit-extendedorigin">dict-member for MessageEventInit</a><span>, in § 4.2</span>
    </ul>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable, data)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable, data, extendedOrigin)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source)</a><span>, in § 4.2</span>
   <li><a href="#dom-messageevent-initmessageevent">initMessageEvent(type, bubbles, cancelable, data, extendedOrigin, lastEventId, source, ports)</a><span>, in § 4.2</span>
   <li><a href="#grammardef-loweralpha">LOWERALPHA</a><span>, in § 2.1</span>
   <li><a href="#messageevent">MessageEvent</a><span>, in § 4.2</span>
   <li><a href="#dictdef-messageeventinit">MessageEventInit</a><span>, in § 4.2</span>
   <li>
    origin
    <ul>
     <li><a href="#dom-messageevent-origin">attribute for MessageEvent</a><span>, in § 4.2</span>
     <li><a href="#dom-extendedorigin-origin">dict-member for ExtendedOrigin</a><span>, in § 4.2</span>
    </ul>
   <li><a href="#physical-origin">physical origin</a><span>, in § 6.1.3</span>
   <li><a href="#dom-window-postmessage">postMessage(message)</a><span>, in § 4.2</span>
   <li><a href="#dom-window-postmessage">postMessage(message, targetOrigin)</a><span>, in § 4.2</span>
   <li><a href="#dom-window-postmessage">postMessage(message, targetOrigin, transfer)</a><span>, in § 4.2</span>
   <li><a href="#same-physical-origin">same physical origin</a><span>, in § 6.1.5</span>
   <li>
    suborigin
    <ul>
     <li><a href="#suborigin">definition of</a><span>, in § 3.5</span>
     <li><a href="#dom-extendedorigin-suborigin">dict-member for ExtendedOrigin</a><span>, in § 4.2</span>
    </ul>
   <li><a href="#grammardef-suborigin-header">suborigin-header</a><span>, in § 3.5</span>
   <li><a href="#grammardef-suborigin-name">suborigin-name</a><span>, in § 3.5</span>
   <li><a href="#suborigin-namespace">suborigin namespace</a><span>, in § 3.5</span>
   <li><a href="#suborigin-policy">suborigin policy</a><span>, in § 3.5</span>
   <li><a href="#grammardef-suborigin-policy-list">suborigin-policy-list</a><span>, in § 3.5</span>
   <li><a href="#grammardef-suborigin-policy-option">suborigin-policy-option</a><span>, in § 3.5</span>
   <li><a href="#xhr">XHR</a><span>, in § 2</span>
   <li><a href="#xmlhttprequest">XMLHttpRequest</a><span>, in § 2</span>
   <li><a href="#xss">XSS</a><span>, in § 2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CORS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="962fc3d7">cross-origin request with preflight</span>
     <li><span class="dfn-paneled" id="e412454d">simple cross-origin request</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="efd0980e">credentials</span>
     <li><span class="dfn-paneled" id="4616c738">credentials mode</span>
     <li><span class="dfn-paneled" id="271fa144">current url</span>
     <li><span class="dfn-paneled" id="7d199060">fetch</span>
     <li><span class="dfn-paneled" id="4312a24d">http-network-or-cache fetch</span>
     <li><span class="dfn-paneled" id="47c17863">origin header</span>
     <li><span class="dfn-paneled" id="129a6ca9">request origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1e31e1a5">MessageEventSource</span>
     <li><span class="dfn-paneled" id="df16744f">MessagePort</span>
     <li><span class="dfn-paneled" id="b8bd9c92">Storage</span>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="b3c135e0">ascii serialization of an origin</span>
     <li><span class="dfn-paneled" id="9f7a5afe">cookie setter</span>
     <li><span class="dfn-paneled" id="6b403d32">environment settings object</span>
     <li><span class="dfn-paneled" id="3a2db83f">localStorage</span>
     <li><span class="dfn-paneled" id="21d76096">origin</span>
     <li><span class="dfn-paneled" id="8039907b">origin tuple</span>
     <li><span class="dfn-paneled" id="7da16632">postmessage</span>
     <li><span class="dfn-paneled" id="5ab7b520">reflect</span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="e7815a65">same-origin</span>
     <li><span class="dfn-paneled" id="7a899a17">sessionStorage</span>
     <li><span class="dfn-paneled" id="2b6cda75">tuple origin</span>
     <li><span class="dfn-paneled" id="79bfa43f">unicode serialization of an origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML51]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="96cae01c">cookie-averse</span>
     <li><span class="dfn-paneled" id="5b7e0424">resource metadata management</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTTP]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5d346c26">ows</span>
     <li><span class="dfn-paneled" id="32f92e64">rws</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC5234]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="41a7917e">alpha</span>
     <li><span class="dfn-paneled" id="702d8ead">digit</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="22477314">domain</span>
     <li><span class="dfn-paneled" id="752d140b">host</span>
     <li><span class="dfn-paneled" id="3064a08c">port</span>
     <li><span class="dfn-paneled" id="e022856f">scheme</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
     <li><span class="dfn-paneled" id="b0d7f3c3">USVString</span>
     <li><span class="dfn-paneled" id="6c6b1005">any</span>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
     <li><span class="dfn-paneled" id="efd1ec5d">object</span>
     <li><span class="dfn-paneled" id="9cce47fd">sequence</span>
    </ul>
   <li>
    <a data-link-type="biblio">[XHR]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e71fc65f">withcredentials</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-cors">[CORS]
   <dd>Anne van Kesteren. <a href="https://www.w3.org/TR/cors/"><cite>Cross-Origin Resource Sharing</cite></a>. 2 June 2020. REC. URL: <a href="https://www.w3.org/TR/cors/">https://www.w3.org/TR/cors/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-html51">[HTML51]
   <dd>Steve Faulkner; et al. <a href="https://rawgit.com/w3c/html/html5.1-2/single-page.html"><cite>HTML 5.1 2nd Edition</cite></a>. URL: <a href="https://rawgit.com/w3c/html/html5.1-2/single-page.html">https://rawgit.com/w3c/html/html5.1-2/single-page.html</a>
   <dt id="biblio-rfc0020">[RFC0020]
   <dd>V.G. Cerf. <a href="https://www.rfc-editor.org/rfc/rfc20"><cite>ASCII format for network interchange</cite></a>. October 1969. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc20">https://www.rfc-editor.org/rfc/rfc20</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc5234">[RFC5234]
   <dd>D. Crocker, Ed.; P. Overell. <a href="https://www.rfc-editor.org/rfc/rfc5234"><cite>Augmented BNF for Syntax Specifications: ABNF</cite></a>. January 2008. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5234">https://www.rfc-editor.org/rfc/rfc5234</a>
   <dt id="biblio-unicode6">[Unicode6]
   <dd>The Unicode Consortium. <a href="https://www.unicode.org/versions/Unicode6.2.0/"><cite>The Unicode Standard, Version 6.2.0</cite></a>. URL: <a href="https://www.unicode.org/versions/Unicode6.2.0/">https://www.unicode.org/versions/Unicode6.2.0/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
   <dt id="biblio-websockets">[WebSockets]
   <dd>Adam Rice. <a href="https://websockets.spec.whatwg.org/"><cite>WebSockets Standard</cite></a>. Living Standard. URL: <a href="https://websockets.spec.whatwg.org/">https://websockets.spec.whatwg.org/</a>
   <dt id="biblio-workers">[WORKERS]
   <dd>Ian Hickson. <a href="https://html.spec.whatwg.org/multipage/workers.html"><cite>Web Workers</cite></a>. URL: <a href="https://html.spec.whatwg.org/multipage/workers.html">https://html.spec.whatwg.org/multipage/workers.html</a>
   <dt id="biblio-xhr">[XHR]
   <dd>Anne van Kesteren. <a href="https://xhr.spec.whatwg.org/"><cite>XMLHttpRequest Standard</cite></a>. Living Standard. URL: <a href="https://xhr.spec.whatwg.org/">https://xhr.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-csp2">[CSP2]
   <dd>Mike West; Adam Barth; Daniel Veditz. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 2</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-iframesandbox">[IFrameSandbox]
   <dd>Mike West. <a href="http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/"><cite>Play safely in sandboxed IFrames</cite></a>. URL: <a href="http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/">http://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/</a>
   <dt id="biblio-privilegeseparation">[PRIVILEGESEPARATION]
   <dd>Devdatta Akhawe; Prateek Saxena; Dawn Song. <a href="https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final168.pdf"><cite>Privilege Separation in HTML5 Applications</cite></a>. URL: <a href="https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final168.pdf">https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final168.pdf</a>
   <dt id="biblio-rfc6454">[RFC6454]
   <dd>A. Barth. <a href="https://www.rfc-editor.org/rfc/rfc6454"><cite>The Web Origin Concept</cite></a>. December 2011. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6454">https://www.rfc-editor.org/rfc/rfc6454</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>dictionary</c-> <a href="#dictdef-extendedorigin"><code><c- g>ExtendedOrigin</c-></code></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a data-default="&quot;&quot;" data-type="USVString" href="#dom-extendedorigin-origin"><code><c- g>origin</c-></code></a> = "";
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a>? <a data-default="null" data-type="USVString?" href="#dom-extendedorigin-suborigin"><code><c- g>suborigin</c-></code></a> = <c- b>null</c->;
};

<c- b>interface</c-> <a href="#messageevent"><code><c- g>MessageEvent</c-></code></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a>? <a data-readonly data-type="USVString?" href="#dom-messageevent-origin"><code><c- g>origin</c-></code></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin"><c- n>ExtendedOrigin</c-></a> <a data-readonly data-type="ExtendedOrigin" href="#dom-messageevent-extendedorigin"><code><c- g>extendedOrigin</c-></code></a>;
  <a data-link-type="idl-name"><c- n>void</c-></a> <a href="#dom-messageevent-initmessageevent"><code><c- g>initMessageEvent</c-></code></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-type"><code><c- g>type</c-></code></a>, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-bubbles"><code><c- g>bubbles</c-></code></a> = <c- b>false</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-cancelable"><code><c- g>cancelable</c-></code></a> = <c- b>false</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any"><c- b>any</c-></a> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-data"><code><c- g>data</c-></code></a> = <c- b>null</c->, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin"><c- n>ExtendedOrigin</c-></a>? <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-extendedorigin"><code><c- g>extendedOrigin</c-></code></a> = <c- b>null</c->, <c- b>optional</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-lasteventid"><code><c- g>lastEventId</c-></code></a> = "", <c- b>optional</c-> <a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/comms.html#messageeventsource"><c- n>MessageEventSource</c-></a>? <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-source"><code><c- g>source</c-></code></a> = <c- b>null</c->, <c- b>optional</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/web-messaging.html#messageport"><c- n>MessagePort</c-></a>> <a href="#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-ports"><code><c- g>ports</c-></code></a> = []);
};

<c- b>dictionary</c-> <a href="#dictdef-messageeventinit"><code><c- g>MessageEventInit</c-></code></a> {
  <a data-link-type="idl-name" href="#dictdef-extendedorigin"><c- n>ExtendedOrigin</c-></a>? <a data-default="null" data-type="ExtendedOrigin?" href="#dom-messageeventinit-extendedorigin"><code><c- g>extendedOrigin</c-></code></a> = <c- b>null</c->;
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"><c- g>Window</c-></a> {
  <a data-link-type="idl-name"><c- n>void</c-></a> <a href="#dom-window-postmessage"><code><c- g>postMessage</c-></code></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any"><c- b>any</c-></a> <a href="#dom-window-postmessage-message-targetorigin-transfer-message"><code><c- g>message</c-></code></a>, <c- b>optional</c-> <a data-link-type="idl-name" href="#dictdef-extendedorigin"><c- n>ExtendedOrigin</c-></a> <a href="#dom-window-postmessage-message-targetorigin-transfer-targetorigin"><code><c- g>targetOrigin</c-></code></a>, <c- b>optional</c-> <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-object"><c- b>object</c-></a>> <a href="#dom-window-postmessage-message-targetorigin-transfer-transfer"><code><c- g>transfer</c-></code></a> = []);
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> TODO: We probably should add additional examples, or perhaps match an
  example to each bullet above. <a class="issue-return" href="#issue-21aaf26d" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(jww) This needs to be filled in once we have a pretty good handle on
  the basic structure of this document. At that point, we should extract the terms
  defined throughout the spec and place them here. <a class="issue-return" href="#issue-7af0036e" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(devd): Should we also assert that attacker on main/parent origin
  cannot compromise the app in sub-origin? <a class="issue-return" href="#issue-4b8e74eb" title="Jump to section">↵</a></div>
   <div class="issue"> "Should not control" is a stronger statement than I think we want to
  make. The browser can only isolate per origin isolation. If the app has a bug
  (due to postmessage or server-side) the browser can’t do anything. We should
  stick to saying "are isolated like physical origins." <a class="issue-return" href="#issue-df2253b2" title="Jump to section">↵</a></div>
   <div class="issue"> TODO: Determine how the serialization should relate to the URL spec:
  https://url.spec.whatwg.org/#host-parsing <a class="issue-return" href="#issue-f67832ce" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(jww): Need to write the formal IDL for this. <a class="issue-return" href="#issue-1dbd01cb" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(devd): Making things specific to XHR or CORS is weird. We should
  just make all fetches inside a suborigin CORS fetches and be done with it. <a class="issue-return" href="#issue-4f0009c4" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(jww): Formal definition of the headers and responses w/grammars.
  Also need to be explicit about <code>*</code> having same limitations as <code>Access-Control-Allow-Origin</code> w/credentials. <a class="issue-return" href="#issue-5b3d4495" title="Jump to section">↵</a></div>
   <div class="issue"> Access-Control-Allow-Origin * fails with credentialed requests. Does
  Access-Control-Allow-Suborigin have the same behavior? We should detail that
  in more detail. <a class="issue-return" href="#issue-6750573e" title="Jump to section">↵</a></div>
   <div class="issue"> Browsers have a really low cache time (15mins) for preflight responses
  which makes CORS a big pain for websites. This will become even more salient
  with suborigins. Should the spec ask browsers to increase cache times? <a class="issue-return" href="#issue-5be18446" title="Jump to section">↵</a></div>
   <div class="issue"> Serializing the suborigin value into the origin header seems like it
  will break things. Whats the risk with serializing the physical origin in the
  origin header? The browser won’t let you read the responses (or succeed
  preflight) if neither of them have the right allow-suborigin behavior. This
  seems more compatible with no security risk. <a class="issue-return" href="#issue-aedb28e2" title="Jump to section">↵</a></div>
   <div class="issue"> We’re monkey-patching HTML, submit a PR when we’re sure this is the
  general direction we want to go in. <a class="issue-return" href="#issue-c9cb881f" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(jww): Formalize by updating the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage">postMessage</a> algorithm <a class="issue-return" href="#issue-ebe2c3d2" title="Jump to section">↵</a></div>
   <div class="issue"> TODO: Formalize. Not sure what this will look like yet. Chrome and
  Opera don’t allow creation of workers from sandbox’d iframes/the 'null'
  origin, but not sure if this formalized in a spec. If it is, should probably
  just update whatever disallows creation from sandbox. <a class="issue-return" href="#issue-3fffd8fc" title="Jump to section">↵</a></div>
   <div class="issue"> Currently, some browsers do not let applications redefine getters and
  setters on cookie averse documents. Should the spec enforce that this is
  allowed? <a class="issue-return" href="#issue-90521f50" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(jww,aaj): Provide an example of why this might be needed. <a class="issue-return" href="#issue-ec925137" title="Jump to section">↵</a></div>
   <div class="issue"> TODO: These opt-out descriptions should probably be moved to the
  individual sections where the behaviors are discussed (i.e. postMessage and
  cookies). These just need to be fleshed out anyway, and examples and reasons
  need to be given. Also, they need to update the processing model, such as
  adding appropriate flags to the environment settings object. <a class="issue-return" href="#issue-9b7d04a5" title="Jump to section">↵</a></div>
   <div class="issue"> TODO(devd): Flesh out the above and make sure it covers all it needs to
  cover. <a class="issue-return" href="#issue-810c1065" title="Jump to section">↵</a></div>
   <div class="issue"> Is history.pushState allowed in a suborigin? I suggest no to reduce
  complexity and inherit from sandbox behavior. On the other hand, this impacts
  compatibility. <a class="issue-return" href="#issue-d4f11cd7" title="Jump to section">↵</a></div>
   <div class="issue"> TODO: Need to list concerns with serialization, e.g. apps that don’t
  recognize the suborigin serialization, esp. if they blocklist origins. <a class="issue-return" href="#issue-d8492fe3" title="Jump to section">↵</a></div>
   <div class="issue"> TODO: Do we have privacy issues? <a class="issue-return" href="#issue-747044d5" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"129a6ca9": {"dfnID":"129a6ca9","dfnText":"request origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-origin"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://fetch.spec.whatwg.org#concept-request-origin"},
"1e31e1a5": {"dfnID":"1e31e1a5","dfnText":"MessageEventSource","external":true,"refSections":[{"refs":[{"id":"ref-for-messageeventsource"}],"title":"4.2. postMessage"}],"url":"https://html.spec.whatwg.org/multipage/comms.html#messageeventsource"},
"21d76096": {"dfnID":"21d76096","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"3.2. Threat Model"},{"refs":[{"id":"ref-for-concept-origin\u2460"},{"id":"ref-for-concept-origin\u2461"}],"title":"5.1. Storage"},{"refs":[{"id":"ref-for-concept-origin\u2462"}],"title":"6.1. Updates to Origin"},{"refs":[{"id":"ref-for-concept-origin\u2463"}],"title":"6.1.2. Origin Tuple"},{"refs":[{"id":"ref-for-concept-origin\u2464"}],"title":"6.1.3. Physical Origin"}],"url":"https://html.spec.whatwg.org/multipage/#concept-origin"},
"22477314": {"dfnID":"22477314","dfnText":"domain","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-domain"}],"title":"6.1.2. Origin Tuple"}],"url":"https://url.spec.whatwg.org/#concept-domain"},
"271fa144": {"dfnID":"271fa144","dfnText":"current url","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-current-url"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://fetch.spec.whatwg.org#concept-request-current-url"},
"2b6cda75": {"dfnID":"2b6cda75","dfnText":"tuple origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-tuple"}],"title":"6.1.2. Origin Tuple"},{"refs":[{"id":"ref-for-concept-origin-tuple\u2460"}],"title":"6.1.3. Physical Origin"}],"url":"https://html.spec.whatwg.org/multipage/#concept-origin-tuple"},
"3064a08c": {"dfnID":"3064a08c","dfnText":"port","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-port"},{"id":"ref-for-concept-port\u2460"}],"title":"3. Defining a Suborigin"},{"refs":[{"id":"ref-for-concept-port\u2461"}],"title":"3.6. Representation of Suborigins"},{"refs":[{"id":"ref-for-concept-port\u2462"}],"title":"6.1.2. Origin Tuple"}],"url":"https://url.spec.whatwg.org/#concept-port"},
"32f92e64": {"dfnID":"32f92e64","dfnText":"rws","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.2.3"},{"id":"ref-for-section-3.2.3\u2460"}],"title":"3.5. The suborigin header"}],"url":"https://tools.ietf.org/html/rfc7230#section-3.2.3"},
"3a2db83f": {"dfnID":"3a2db83f","dfnText":"localStorage","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-localstorage"},{"id":"ref-for-dom-localstorage\u2460"}],"title":"5.1. Storage"}],"url":"https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage"},
"41a7917e": {"dfnID":"41a7917e","dfnText":"alpha","external":true,"refSections":[{"refs":[{"id":"ref-for-appendix-B.1"}],"title":"2.1. Grammatical Concepts"},{"refs":[{"id":"ref-for-appendix-B.1\u2460"}],"title":"3.5. The suborigin header"}],"url":"https://tools.ietf.org/html/rfc5234#appendix-B.1"},
"4312a24d": {"dfnID":"4312a24d","dfnText":"http-network-or-cache fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-http-network-or-cache-fetch"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://fetch.spec.whatwg.org#http-network-or-cache-fetch"},
"4616c738": {"dfnID":"4616c738","dfnText":"credentials mode","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-credentials-mode"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://fetch.spec.whatwg.org#concept-request-credentials-mode"},
"47c17863": {"dfnID":"47c17863","dfnText":"origin header","external":true,"refSections":[{"refs":[{"id":"ref-for-origin-header"}],"title":"4.1. CORS"}],"url":"https://fetch.spec.whatwg.org#origin-header"},
"5372cca8": {"dfnID":"5372cca8","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-boolean"},{"id":"ref-for-idl-boolean\u2460"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"5ab7b520": {"dfnID":"5ab7b520","dfnText":"reflect","external":true,"refSections":[{"refs":[{"id":"ref-for-reflect"}],"title":"3.7. Accessing the Suborigin in JavaScript"}],"url":"https://html.spec.whatwg.org/multipage/common-dom-interfaces.html#reflect"},
"5b7e0424": {"dfnID":"5b7e0424","dfnText":"resource metadata management","external":true,"refSections":[{"refs":[{"id":"ref-for-resource-metadata-management"}],"title":"6.2.1. Cookies"}],"url":"http://www.w3.org/TR/html51/dom.html#resource-metadata-management"},
"5d346c26": {"dfnID":"5d346c26","dfnText":"ows","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3.2.3"},{"id":"ref-for-section-3.2.3\u2460"}],"title":"3.5. The suborigin header"}],"url":"https://tools.ietf.org/html/rfc7230#section-3.2.3"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"}],"title":"4.2. postMessage"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"6b403d32": {"dfnID":"6b403d32","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://html.spec.whatwg.org/multipage/comms.html#environment-settings-object"},
"6c6b1005": {"dfnID":"6c6b1005","dfnText":"any","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-any"},{"id":"ref-for-idl-any\u2460"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-any"},
"702d8ead": {"dfnID":"702d8ead","dfnText":"digit","external":true,"refSections":[{"refs":[{"id":"ref-for-appendix-B.1"}],"title":"2.1. Grammatical Concepts"},{"refs":[{"id":"ref-for-appendix-B.1\u2460"}],"title":"3.5. The suborigin header"}],"url":"https://tools.ietf.org/html/rfc5234#appendix-B.1"},
"7393da89": {"dfnID":"7393da89","dfnText":"same origin","external":true,"refSections":[{"refs":[{"id":"ref-for-same-origin\u2461"}],"title":"6.1.4. Comparing Origins"},{"refs":[{"id":"ref-for-same-origin\u2462"}],"title":"6.1.5. Comparing Physical Origins"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"752d140b": {"dfnID":"752d140b","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-host"},{"id":"ref-for-concept-host\u2460"}],"title":"3. Defining a Suborigin"},{"refs":[{"id":"ref-for-concept-host\u2461"}],"title":"3.6. Representation of Suborigins"},{"refs":[{"id":"ref-for-concept-host\u2462"}],"title":"6.1.2. Origin Tuple"}],"url":"https://url.spec.whatwg.org/#concept-host"},
"79bfa43f": {"dfnID":"79bfa43f","dfnText":"unicode serialization of an origin","external":true,"refSections":[{"refs":[{"id":"ref-for-unicode-serialisation-of-an-origin"}],"title":"6.1.6.1. Unicode Serialization of a Suborigin"}],"url":"https://html.spec.whatwg.org/multipage/#unicode-serialisation-of-an-origin"},
"7a899a17": {"dfnID":"7a899a17","dfnText":"sessionStorage","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-sessionstorage"},{"id":"ref-for-dom-sessionstorage\u2460"}],"title":"5.1. Storage"}],"url":"https://html.spec.whatwg.org/multipage/webstorage.html#dom-sessionstorage"},
"7d199060": {"dfnID":"7d199060","dfnText":"fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-fetch"}],"title":"4.1. CORS"}],"url":"https://fetch.spec.whatwg.org#concept-fetch"},
"7da16632": {"dfnID":"7da16632","dfnText":"postmessage","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-messageport-postmessage"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-dom-messageport-postmessage\u2460"}],"title":"4. Access Control"},{"refs":[{"id":"ref-for-dom-messageport-postmessage\u2461"},{"id":"ref-for-dom-messageport-postmessage\u2462"}],"title":"4.2. postMessage"}],"url":"https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage"},
"8039907b": {"dfnID":"8039907b","dfnText":"origin tuple","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-tuple"}],"title":"6.1.2. Origin Tuple"},{"refs":[{"id":"ref-for-concept-origin-tuple\u2460"}],"title":"6.1.3. Physical Origin"}],"url":"https://html.spec.whatwg.org/multipage/#concept-origin-tuple"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"}],"title":"5.1. Storage"},{"refs":[{"id":"ref-for-document\u2460"},{"id":"ref-for-document\u2461"},{"id":"ref-for-document\u2462"},{"id":"ref-for-document\u2463"},{"id":"ref-for-document\u2464"},{"id":"ref-for-document\u2465"}],"title":"6.2.1. Cookies"},{"refs":[{"id":"ref-for-document\u2466"},{"id":"ref-for-document\u2467"}],"title":"6.3.3. 'unsafe-cookies'"}],"url":"https://dom.spec.whatwg.org/#document"},
"8855a9aa": {"dfnID":"8855a9aa","dfnText":"DOMString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMString"},{"id":"ref-for-idl-DOMString\u2460"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"962fc3d7": {"dfnID":"962fc3d7","dfnText":"cross-origin request with preflight","external":true,"refSections":[{"refs":[{"id":"ref-for-cross-origin-request-with-preflight-0"}],"title":"4.1. CORS"}],"url":"https://www.w3.org/TR/cors#cross-origin-request-with-preflight-0"},
"96cae01c": {"dfnID":"96cae01c","dfnText":"cookie-averse","external":true,"refSections":[{"refs":[{"id":"ref-for-cookie-averse"},{"id":"ref-for-cookie-averse\u2460"},{"id":"ref-for-cookie-averse\u2461"},{"id":"ref-for-cookie-averse\u2462"}],"title":"6.2.1. Cookies"},{"refs":[{"id":"ref-for-cookie-averse\u2463"},{"id":"ref-for-cookie-averse\u2464"}],"title":"6.3.3. 'unsafe-cookies'"}],"url":"http://www.w3.org/TR/html51/dom.html#cookie-averse"},
"9cce47fd": {"dfnID":"9cce47fd","dfnText":"sequence","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-sequence"},{"id":"ref-for-idl-sequence\u2460"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"9f7a5afe": {"dfnID":"9f7a5afe","dfnText":"cookie setter","external":true,"refSections":[{"refs":[{"id":"ref-for-attr-meta-http-equiv-set-cookie"}],"title":"6.2.1. Cookies"}],"url":"https://html.spec.whatwg.org/multipage/#attr-meta-http-equiv-set-cookie"},
"a973e0fe": {"dfnID":"a973e0fe","dfnText":"document","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document"},{"id":"ref-for-concept-document\u2460"}],"title":"3.7. Accessing the Suborigin in JavaScript"}],"url":"https://dom.spec.whatwg.org/#concept-document"},
"b0d7f3c3": {"dfnID":"b0d7f3c3","dfnText":"USVString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-USVString"},{"id":"ref-for-idl-USVString\u2460"},{"id":"ref-for-idl-USVString\u2461"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-USVString"},
"b3c135e0": {"dfnID":"b3c135e0","dfnText":"ascii serialization of an origin","external":true,"refSections":[{"refs":[{"id":"ref-for-ascii-serialisation-of-an-origin"}],"title":"6.1.6.2. ASCII Serialization of a Suborigin"}],"url":"https://html.spec.whatwg.org/multipage/#ascii-serialisation-of-an-origin"},
"b8bd9c92": {"dfnID":"b8bd9c92","dfnText":"Storage","external":true,"refSections":[{"refs":[{"id":"ref-for-storage-2"},{"id":"ref-for-storage-2\u2460"}],"title":"5.1. Storage"}],"url":"https://html.spec.whatwg.org/multipage/webstorage.html#storage-2"},
"cors": {"dfnID":"cors","dfnText":"CORS","external":false,"refSections":[{"refs":[{"id":"ref-for-cors"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-cors\u2460"}],"title":"4. Access Control"}],"url":"#cors"},
"cross-origin-resource-sharing": {"dfnID":"cross-origin-resource-sharing","dfnText":"Cross-Origin Resource Sharing","external":false,"refSections":[],"url":"#cross-origin-resource-sharing"},
"cross-site-scripting": {"dfnID":"cross-site-scripting","dfnText":"cross-site scripting","external":false,"refSections":[],"url":"#cross-site-scripting"},
"df16744f": {"dfnID":"df16744f","dfnText":"MessagePort","external":true,"refSections":[{"refs":[{"id":"ref-for-messageport"}],"title":"4.2. postMessage"}],"url":"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport"},
"dictdef-extendedorigin": {"dfnID":"dictdef-extendedorigin","dfnText":"ExtendedOrigin","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-extendedorigin"},{"id":"ref-for-dictdef-extendedorigin\u2460"},{"id":"ref-for-dictdef-extendedorigin\u2461"},{"id":"ref-for-dictdef-extendedorigin\u2462"}],"title":"4.2. postMessage"}],"url":"#dictdef-extendedorigin"},
"dictdef-messageeventinit": {"dfnID":"dictdef-messageeventinit","dfnText":"MessageEventInit","external":false,"refSections":[],"url":"#dictdef-messageeventinit"},
"dom-extendedorigin-origin": {"dfnID":"dom-extendedorigin-origin","dfnText":"origin","external":false,"refSections":[],"url":"#dom-extendedorigin-origin"},
"dom-extendedorigin-suborigin": {"dfnID":"dom-extendedorigin-suborigin","dfnText":"suborigin","external":false,"refSections":[],"url":"#dom-extendedorigin-suborigin"},
"dom-messageevent-extendedorigin": {"dfnID":"dom-messageevent-extendedorigin","dfnText":"extendedOrigin","external":false,"refSections":[],"url":"#dom-messageevent-extendedorigin"},
"dom-messageevent-initmessageevent": {"dfnID":"dom-messageevent-initmessageevent","dfnText":"initMessageEvent","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-bubbles": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-bubbles","dfnText":"bubbles","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-bubbles"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-cancelable": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-cancelable","dfnText":"cancelable","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-cancelable"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-data": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-data","dfnText":"data","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-data"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-extendedorigin": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-extendedorigin","dfnText":"extendedOrigin","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-extendedorigin"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-lasteventid": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-lasteventid","dfnText":"lastEventId","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-lasteventid"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-ports": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-ports","dfnText":"ports","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-ports"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-source": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-source","dfnText":"source","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-source"},
"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-type": {"dfnID":"dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-type","dfnText":"type","external":false,"refSections":[],"url":"#dom-messageevent-initmessageevent-type-bubbles-cancelable-data-extendedorigin-lasteventid-source-ports-type"},
"dom-messageevent-origin": {"dfnID":"dom-messageevent-origin","dfnText":"origin","external":false,"refSections":[],"url":"#dom-messageevent-origin"},
"dom-messageeventinit-extendedorigin": {"dfnID":"dom-messageeventinit-extendedorigin","dfnText":"extendedOrigin","external":false,"refSections":[],"url":"#dom-messageeventinit-extendedorigin"},
"dom-window-postmessage": {"dfnID":"dom-window-postmessage","dfnText":"postMessage","external":false,"refSections":[],"url":"#dom-window-postmessage"},
"dom-window-postmessage-message-targetorigin-transfer-message": {"dfnID":"dom-window-postmessage-message-targetorigin-transfer-message","dfnText":"message","external":false,"refSections":[],"url":"#dom-window-postmessage-message-targetorigin-transfer-message"},
"dom-window-postmessage-message-targetorigin-transfer-targetorigin": {"dfnID":"dom-window-postmessage-message-targetorigin-transfer-targetorigin","dfnText":"targetOrigin","external":false,"refSections":[],"url":"#dom-window-postmessage-message-targetorigin-transfer-targetorigin"},
"dom-window-postmessage-message-targetorigin-transfer-transfer": {"dfnID":"dom-window-postmessage-message-targetorigin-transfer-transfer","dfnText":"transfer","external":false,"refSections":[],"url":"#dom-window-postmessage-message-targetorigin-transfer-transfer"},
"e022856f": {"dfnID":"e022856f","dfnText":"scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-scheme"},{"id":"ref-for-concept-scheme\u2460"}],"title":"3. Defining a Suborigin"},{"refs":[{"id":"ref-for-concept-scheme\u2461"}],"title":"3.6. Representation of Suborigins"},{"refs":[{"id":"ref-for-concept-scheme\u2462"}],"title":"6.1.2. Origin Tuple"}],"url":"https://url.spec.whatwg.org/#concept-scheme"},
"e412454d": {"dfnID":"e412454d","dfnText":"simple cross-origin request","external":true,"refSections":[{"refs":[{"id":"ref-for-simple-cross-origin-request"}],"title":"4.1. CORS"}],"url":"https://www.w3.org/TR/cors#simple-cross-origin-request"},
"e71fc65f": {"dfnID":"e71fc65f","dfnText":"withcredentials","external":true,"refSections":[{"refs":[{"id":"ref-for-the-withcredentials-attribute"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://xhr.spec.whatwg.org/#the-withcredentials-attribute"},
"e7815a65": {"dfnID":"e7815a65","dfnText":"same-origin","external":true,"refSections":[{"refs":[{"id":"ref-for-same-origin"},{"id":"ref-for-same-origin\u2460"}],"title":"3. Defining a Suborigin"}],"url":"https://html.spec.whatwg.org/multipage/#same-origin"},
"efd0980e": {"dfnID":"efd0980e","dfnText":"credentials","external":true,"refSections":[{"refs":[{"id":"ref-for-credentials"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"https://fetch.spec.whatwg.org#credentials"},
"efd1ec5d": {"dfnID":"efd1ec5d","dfnText":"object","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-object"}],"title":"4.2. postMessage"}],"url":"https://webidl.spec.whatwg.org/#idl-object"},
"grammardef-loweralpha": {"dfnID":"grammardef-loweralpha","dfnText":"LOWERALPHA","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-loweralpha"},{"id":"ref-for-grammardef-loweralpha\u2460"}],"title":"3.5. The suborigin header"}],"url":"#grammardef-loweralpha"},
"grammardef-suborigin-header": {"dfnID":"grammardef-suborigin-header","dfnText":"suborigin-header","external":false,"refSections":[],"url":"#grammardef-suborigin-header"},
"grammardef-suborigin-name": {"dfnID":"grammardef-suborigin-name","dfnText":"suborigin-name","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-suborigin-name"},{"id":"ref-for-grammardef-suborigin-name\u2460"}],"title":"3.5. The suborigin header"}],"url":"#grammardef-suborigin-name"},
"grammardef-suborigin-policy-list": {"dfnID":"grammardef-suborigin-policy-list","dfnText":"suborigin-policy-list","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-suborigin-policy-list"},{"id":"ref-for-grammardef-suborigin-policy-list\u2460"}],"title":"3.5. The suborigin header"}],"url":"#grammardef-suborigin-policy-list"},
"grammardef-suborigin-policy-option": {"dfnID":"grammardef-suborigin-policy-option","dfnText":"suborigin-policy-option","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-suborigin-policy-option"},{"id":"ref-for-grammardef-suborigin-policy-option\u2460"}],"title":"3.5. The suborigin header"},{"refs":[{"id":"ref-for-grammardef-suborigin-policy-option\u2461"}],"title":"6.2.1. Cookies"},{"refs":[{"id":"ref-for-grammardef-suborigin-policy-option\u2462"}],"title":"6.3. Security Model Opt-Outs"}],"url":"#grammardef-suborigin-policy-option"},
"messageevent": {"dfnID":"messageevent","dfnText":"MessageEvent","external":false,"refSections":[],"url":"#messageevent"},
"physical-origin": {"dfnID":"physical-origin","dfnText":"physical origin","external":false,"refSections":[{"refs":[{"id":"ref-for-physical-origin"}],"title":"3.6. Representation of Suborigins"},{"refs":[{"id":"ref-for-physical-origin\u2460"},{"id":"ref-for-physical-origin\u2461"}],"title":"6.1.5. Comparing Physical Origins"},{"refs":[{"id":"ref-for-physical-origin\u2462"}],"title":"6.2.1. Cookies"},{"refs":[{"id":"ref-for-physical-origin\u2463"}],"title":"6.3.3. 'unsafe-cookies'"},{"refs":[{"id":"ref-for-physical-origin\u2464"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"#physical-origin"},
"same-physical-origin": {"dfnID":"same-physical-origin","dfnText":"same physical origin","external":false,"refSections":[{"refs":[{"id":"ref-for-same-physical-origin"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"#same-physical-origin"},
"suborigin": {"dfnID":"suborigin","dfnText":"suborigin","external":false,"refSections":[{"refs":[{"id":"ref-for-suborigin"}],"title":"5.3. WebSockets"}],"url":"#suborigin"},
"suborigin-namespace": {"dfnID":"suborigin-namespace","dfnText":"suborigin namespace","external":false,"refSections":[{"refs":[{"id":"ref-for-suborigin-namespace"},{"id":"ref-for-suborigin-namespace\u2460"}],"title":"3. Defining a Suborigin"},{"refs":[{"id":"ref-for-suborigin-namespace\u2461"},{"id":"ref-for-suborigin-namespace\u2462"}],"title":"3.6. Representation of Suborigins"},{"refs":[{"id":"ref-for-suborigin-namespace\u2463"},{"id":"ref-for-suborigin-namespace\u2464"}],"title":"5.1. Storage"},{"refs":[{"id":"ref-for-suborigin-namespace\u2465"}],"title":"6.1.2. Origin Tuple"},{"refs":[{"id":"ref-for-suborigin-namespace\u2466"},{"id":"ref-for-suborigin-namespace\u2467"}],"title":"6.2.1. Cookies"}],"url":"#suborigin-namespace"},
"suborigin-policy": {"dfnID":"suborigin-policy","dfnText":"suborigin policy","external":false,"refSections":[{"refs":[{"id":"ref-for-suborigin-policy"}],"title":"6.2.1. Cookies"},{"refs":[{"id":"ref-for-suborigin-policy\u2460"},{"id":"ref-for-suborigin-policy\u2461"}],"title":"6.3. Security Model Opt-Outs"},{"refs":[{"id":"ref-for-suborigin-policy\u2462"}],"title":"6.3.3. 'unsafe-cookies'"}],"url":"#suborigin-policy"},
"xhr": {"dfnID":"xhr","dfnText":"XHR","external":false,"refSections":[],"url":"#xhr"},
"xmlhttprequest": {"dfnID":"xmlhttprequest","dfnText":"XMLHttpRequest","external":false,"refSections":[{"refs":[{"id":"ref-for-xmlhttprequest"}],"title":"4.1. CORS"},{"refs":[{"id":"ref-for-xmlhttprequest\u2460"}],"title":"6.3.4. 'unsafe-credentials'"}],"url":"#xmlhttprequest"},
"xss": {"dfnID":"xss","dfnText":"XSS","external":false,"refSections":[{"refs":[{"id":"ref-for-xss"}],"title":"3.2.1. Cross-Document Attacker"}],"url":"#xss"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#cors": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"cors","type":"dfn","url":"#cors"},
"#dictdef-extendedorigin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"ExtendedOrigin","type":"dictionary","url":"#dictdef-extendedorigin"},
"#grammardef-loweralpha": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"loweralpha","type":"grammar","url":"#grammardef-loweralpha"},
"#grammardef-suborigin-name": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin-name","type":"grammar","url":"#grammardef-suborigin-name"},
"#grammardef-suborigin-policy-list": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin-policy-list","type":"grammar","url":"#grammardef-suborigin-policy-list"},
"#grammardef-suborigin-policy-option": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin-policy-option","type":"grammar","url":"#grammardef-suborigin-policy-option"},
"#physical-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"physical origin","type":"dfn","url":"#physical-origin"},
"#same-physical-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"same physical origin","type":"dfn","url":"#same-physical-origin"},
"#suborigin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin","type":"dfn","url":"#suborigin"},
"#suborigin-namespace": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin namespace","type":"dfn","url":"#suborigin-namespace"},
"#suborigin-policy": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"suborigin policy","type":"dfn","url":"#suborigin-policy"},
"#xmlhttprequest": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"xmlhttprequest","type":"dfn","url":"#xmlhttprequest"},
"#xss": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"suborigins","spec":"suborigins-1","status":"local","text":"xss","type":"dfn","url":"#xss"},
"http://www.w3.org/TR/html51/dom.html#cookie-averse": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html51","spec":"html51","status":"anchor-block","text":"cookie-averse","type":"dfn","url":"http://www.w3.org/TR/html51/dom.html#cookie-averse"},
"http://www.w3.org/TR/html51/dom.html#resource-metadata-management": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html51","spec":"html51","status":"anchor-block","text":"resource metadata management","type":"dfn","url":"http://www.w3.org/TR/html51/dom.html#resource-metadata-management"},
"https://dom.spec.whatwg.org/#concept-document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"document","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document"},
"https://dom.spec.whatwg.org/#document": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://fetch.spec.whatwg.org#concept-fetch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"fetch","type":"dfn","url":"https://fetch.spec.whatwg.org#concept-fetch"},
"https://fetch.spec.whatwg.org#concept-request-credentials-mode": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"credentials mode","type":"dfn","url":"https://fetch.spec.whatwg.org#concept-request-credentials-mode"},
"https://fetch.spec.whatwg.org#concept-request-current-url": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"current url","type":"dfn","url":"https://fetch.spec.whatwg.org#concept-request-current-url"},
"https://fetch.spec.whatwg.org#concept-request-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"request origin","type":"dfn","url":"https://fetch.spec.whatwg.org#concept-request-origin"},
"https://fetch.spec.whatwg.org#credentials": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"credentials","type":"dfn","url":"https://fetch.spec.whatwg.org#credentials"},
"https://fetch.spec.whatwg.org#http-network-or-cache-fetch": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"http-network-or-cache fetch","type":"dfn","url":"https://fetch.spec.whatwg.org#http-network-or-cache-fetch"},
"https://fetch.spec.whatwg.org#origin-header": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"origin header","type":"dfn","url":"https://fetch.spec.whatwg.org#origin-header"},
"https://html.spec.whatwg.org/multipage/#ascii-serialisation-of-an-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"ascii serialization of an origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#ascii-serialisation-of-an-origin"},
"https://html.spec.whatwg.org/multipage/#attr-meta-http-equiv-set-cookie": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"cookie setter","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#attr-meta-http-equiv-set-cookie"},
"https://html.spec.whatwg.org/multipage/#concept-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#concept-origin"},
"https://html.spec.whatwg.org/multipage/#concept-origin-tuple": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"tuple origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#concept-origin-tuple"},
"https://html.spec.whatwg.org/multipage/#same-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"same-origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#same-origin"},
"https://html.spec.whatwg.org/multipage/#unicode-serialisation-of-an-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"unicode serialization of an origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#unicode-serialisation-of-an-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#same-origin": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"https://html.spec.whatwg.org/multipage/common-dom-interfaces.html#reflect": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"reflect","type":"dfn","url":"https://html.spec.whatwg.org/multipage/common-dom-interfaces.html#reflect"},
"https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"postmessage","type":"dfn","url":"https://html.spec.whatwg.org/multipage/comms.html#dom-messageport-postmessage"},
"https://html.spec.whatwg.org/multipage/comms.html#environment-settings-object": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/comms.html#environment-settings-object"},
"https://html.spec.whatwg.org/multipage/comms.html#messageeventsource": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"MessageEventSource","type":"typedef","url":"https://html.spec.whatwg.org/multipage/comms.html#messageeventsource"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"MessagePort","type":"interface","url":"https://html.spec.whatwg.org/multipage/web-messaging.html#messageport"},
"https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage": {"export":true,"for_":["WindowLocalStorage"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"localStorage","type":"attribute","url":"https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage"},
"https://html.spec.whatwg.org/multipage/webstorage.html#dom-sessionstorage": {"export":true,"for_":["WindowSessionStorage"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"sessionStorage","type":"attribute","url":"https://html.spec.whatwg.org/multipage/webstorage.html#dom-sessionstorage"},
"https://html.spec.whatwg.org/multipage/webstorage.html#storage-2": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Storage","type":"interface","url":"https://html.spec.whatwg.org/multipage/webstorage.html#storage-2"},
"https://tools.ietf.org/html/rfc5234#appendix-B.1": {"export":true,"for_":[],"level":"","normative":true,"shortname":"abnf","spec":"abnf","status":"anchor-block","text":"alpha","type":"dfn","url":"https://tools.ietf.org/html/rfc5234#appendix-B.1"},
"https://tools.ietf.org/html/rfc7230#section-3.2.3": {"export":true,"for_":[],"level":"","normative":true,"shortname":"http","spec":"http","status":"anchor-block","text":"rws","type":"grammar","url":"https://tools.ietf.org/html/rfc7230#section-3.2.3"},
"https://url.spec.whatwg.org/#concept-domain": {"export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"domain","type":"dfn","url":"https://url.spec.whatwg.org/#concept-domain"},
"https://url.spec.whatwg.org/#concept-host": {"export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"host","type":"dfn","url":"https://url.spec.whatwg.org/#concept-host"},
"https://url.spec.whatwg.org/#concept-port": {"export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"port","type":"dfn","url":"https://url.spec.whatwg.org/#concept-port"},
"https://url.spec.whatwg.org/#concept-scheme": {"export":true,"for_":[],"level":"","normative":true,"shortname":"url","spec":"url","status":"anchor-block","text":"scheme","type":"dfn","url":"https://url.spec.whatwg.org/#concept-scheme"},
"https://webidl.spec.whatwg.org/#idl-DOMString": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"https://webidl.spec.whatwg.org/#idl-USVString": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"USVString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-USVString"},
"https://webidl.spec.whatwg.org/#idl-any": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"any","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-any"},
"https://webidl.spec.whatwg.org/#idl-boolean": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"boolean","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"https://webidl.spec.whatwg.org/#idl-object": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"object","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-object"},
"https://webidl.spec.whatwg.org/#idl-sequence": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"sequence","type":"dfn","url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"https://www.w3.org/TR/cors#cross-origin-request-with-preflight-0": {"export":true,"for_":[],"level":"","normative":true,"shortname":"cors","spec":"cors","status":"anchor-block","text":"cross-origin request with preflight","type":"dfn","url":"https://www.w3.org/TR/cors#cross-origin-request-with-preflight-0"},
"https://www.w3.org/TR/cors#simple-cross-origin-request": {"export":true,"for_":[],"level":"","normative":true,"shortname":"cors","spec":"cors","status":"anchor-block","text":"simple cross-origin request","type":"dfn","url":"https://www.w3.org/TR/cors#simple-cross-origin-request"},
"https://xhr.spec.whatwg.org/#the-withcredentials-attribute": {"export":true,"for_":[],"level":"","normative":true,"shortname":"xhr","spec":"xhr","status":"anchor-block","text":"withcredentials","type":"dfn","url":"https://xhr.spec.whatwg.org/#the-withcredentials-attribute"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>