<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Compositing and Blending Level 2</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <link href="https://www.w3.org/TR/compositing-2/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style type="text/css">
a[data-link-type=element]::before,span[data-link-type=element]::before {
  content: '<';
}
a[data-link-type=element]::after,span[data-link-type=element]::after {
  content: '>';
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-mdn-anno */
:root {
	--mdn-bg: #EEE;
	--mdn-shadow: #999;
	--mdn-nosupport-text: #ccc;
	--mdn-pass: green;
	--mdn-fail: red;
}
@media (prefers-color-scheme: dark) {
	:root {
		--mdn-bg: #222;
		--mdn-shadow: #444;
		--mdn-nosupport-text: #666;
		--mdn-pass: #690;
		--mdn-fail: #d22;
	}
}
.mdn-anno {
	background: var(--mdn-bg, #EEE);
	border-radius: .25em;
	box-shadow: 0 0 3px var(--mdn-shadow, #999);
	color: var(--text, black);
	font: 1em sans-serif;
	hyphens: none;
	max-width: min-content;
	overflow: hidden;
	padding: 0.2em;
	position: absolute;
	right: 0.3em;
	top: auto;
	white-space: nowrap;
	word-wrap: normal;
	z-index: 8;
}
.mdn-anno.unpositioned {
	display: none;
}
.mdn-anno.overlapping-main {
	opacity: .2;
	transition: opacity .1s;
}
.mdn-anno[open] {
	opacity: 1;
	z-index: 9;
	min-width: 9em;
}
.mdn-anno:hover {
	opacity: 1;
	outline: var(--text, black) 1px solid;
}
.mdn-anno > summary {
	font-weight: normal;
	text-align: right;
	cursor: pointer;
	display: block;
}
.mdn-anno > summary > .less-than-two-engines-flag {
	color: var(--mdn-fail);
	padding-right: 2px;
}
.mdn-anno > summary > .all-engines-flag {
	color: var(--mdn-pass);
	padding-right: 2px;
}
.mdn-anno > summary > span {
	color: #fff;
	background-color: #000;
	font-weight: normal;
	font-family: zillaslab, Palatino, "Palatino Linotype", serif;
	padding: 2px 3px 0px 3px;
	line-height: 1.3em;
	vertical-align: top;
}
.mdn-anno > .feature {
	margin-top: 20px;
}
.mdn-anno > .feature:not(:first-of-type) {
	border-top: 1px solid #999;
	margin-top: 6px;
	padding-top: 2px;
}
.mdn-anno > .feature > .less-than-two-engines-text {
	color: var(--mdn-fail);
}
.mdn-anno > .feature > .all-engines-text {
	color: var(--mdn-pass);
}
.mdn-anno > .feature > p {
	font-size: .75em;
	margin-top: 6px;
	margin-bottom: 0;
}
.mdn-anno > .feature > p + p {
	margin-top: 3px;
}
.mdn-anno > .feature > .support {
	display: block;
	font-size: 0.6em;
	margin: 0;
	padding: 0;
	margin-top: 2px;
}
.mdn-anno > .feature > .support + div {
	padding-top: 0.5em;
}
.mdn-anno > .feature > .support > hr {
	display: block;
	border: none;
	border-top: 1px dotted #999;
	padding: 3px 0px 0px 0px;
	margin: 2px 3px 0px 3px;
}
.mdn-anno > .feature > .support > hr::before {
	content: "";
}
.mdn-anno > .feature > .support > span {
	padding: 0.2em 0;
	display: block;
	display: table;
}
.mdn-anno > .feature > .support > span.no {
	color: var(--mdn-nosupport-text);
	filter: grayscale(100%);
}
.mdn-anno > .feature > .support > span.no::before {
	opacity: 0.5;
}
.mdn-anno > .feature > .support > span:first-of-type {
	padding-top: 0.5em;
}
.mdn-anno > .feature > .support > span > span {
	padding: 0 0.5em;
	display: table-cell;
}
.mdn-anno > .feature > .support > span > span:first-child {
	width: 100%;
}
.mdn-anno > .feature > .support > span > span:last-child {
	width: 100%;
	white-space: pre;
	padding: 0;
}
.mdn-anno > .feature > .support > span::before {
	content: ' ';
	display: table-cell;
	min-width: 1.5em;
	height: 1.5em;
	background: no-repeat center center;
	background-size: contain;
	text-align: right;
	font-size: 0.75em;
	font-weight: bold;
}
.mdn-anno > .feature > .support > .chrome_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
}
.mdn-anno > .feature > .support > .firefox_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
}
.mdn-anno > .feature > .support > .chrome::before {
	background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
}
.mdn-anno > .feature > .support > .edge_blink::before {
	background-image: url(https://resources.whatwg.org/browser-logos/edge.svg);
}
.mdn-anno > .feature > .support > .edge::before {
	background-image: url(https://resources.whatwg.org/browser-logos/edge_legacy.svg);
}
.mdn-anno > .feature > .support > .firefox::before {
	background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
}
.mdn-anno > .feature > .support > .ie::before {
	background-image: url(https://resources.whatwg.org/browser-logos/ie.png);
}
.mdn-anno > .feature > .support > .safari_ios::before {
	background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg);
}
.mdn-anno > .feature > .support > .nodejs::before {
	background-image: url(https://nodejs.org/static/images/favicons/favicon.ico);
}
.mdn-anno > .feature > .support > .opera_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
}
.mdn-anno > .feature > .support > .opera::before {
	background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
}
.mdn-anno > .feature > .support > .safari::before {
	background-image: url(https://resources.whatwg.org/browser-logos/safari.png);
}
.mdn-anno > .feature > .support > .samsunginternet_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/samsung.svg);
}
.mdn-anno > .feature > .support > .webview_android::before {
	background-image: url(https://resources.whatwg.org/browser-logos/android-webview.png);
}
.name-slug-mismatch {
	color: red;
}
.caniuse-status:hover {
	z-index: 9;
}
/* dt, li, .issue, .note, and .example are "position: relative", so to put annotation at right margin, must move to right of containing block */;
.h-entry:not(.status-LS) dt > .mdn-anno, .h-entry:not(.status-LS) li > .mdn-anno, .h-entry:not(.status-LS) .issue > .mdn-anno, .h-entry:not(.status-LS) .note > .mdn-anno, .h-entry:not(.status-LS) .example > .mdn-anno {
	right: -6.7em;
}
.h-entry p + .mdn-anno {
	margin-top: 0;
}
 h2 + .mdn-anno.after {
	margin: -48px 0 0 0;
}
 h3 + .mdn-anno.after {
	margin: -46px 0 0 0;
}
 h4 + .mdn-anno.after {
	margin: -42px 0 0 0;
}
 h5 + .mdn-anno.after {
	margin: -40px 0 0 0;
}
 h6 + .mdn-anno.after {
	margin: -40px 0 0 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Compositing and Blending Level 2</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://drafts.fxtf.org/compositing-2/">https://drafts.fxtf.org/compositing-2/</a>
      <dt>Latest published version:
      <dd><a href="https://www.w3.org/TR/compositing-2/">https://www.w3.org/TR/compositing-2/</a>
      <dt>Previous Versions:
      <dd><a href rel="prev"></a>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard" data-editor-id="106988"><a class="p-name fn u-email email" href="mailto:cabanier@adobe.com">Rik Cabanier</a> (<span class="p-org org">Adobe Systems Inc.</span>)
      <dd class="editor p-author h-card vcard" data-editor-id="90243"><a class="p-name fn u-email email" href="mailto:chrishtr@chromium.org">Chris Harrelson</a> (<span class="p-org org">Google Inc.</span>)
      <dt class="editor">Former Editor:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:Nikos.Andronikos@cisra.canon.com.au">Nikos Andronikos</a> (<span class="p-org org">Canon Information Systems Research Australia</span>)
      <dt>Issue Tracking:
      <dd><a href="https://github.com/w3c/fxtf-drafts/labels/compositing-2">GitHub Issues</a>
      <dt>Suggest an Edit for this Spec:
      <dd><a href="https://github.com/w3c/fxtf-drafts/blob/main/compositing-2/Overview.bs">GitHub Editor</a>
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Compositing describes how shapes of different elements are combined into a single image. There are various possible approaches for compositing. Previous versions of SVG and CSS used <a href="https://www.w3.org/TR/SVG11/masking.html#SimpleAlphaBlending">Simple Alpha Compositing</a>. In this model, each element is rendered into its own buffer and is then merged with its <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop">backdrop</a> using the Porter Duff <span class="css">source-over</span> operator. This specification will define a new compositing model that expands upon the Simple Alpha Compositing model by offering:</p>
   <ul>
    <li>additional Porter Duff compositing operators
    <li>advanced blending modes which allow control of how colors mix in the areas where shapes overlap
    <li>compositing groups
   </ul>
    In addition, this specification will define CSS properties for blending and group isolation and the properties of the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation" id="ref-for-dom-context-2d-globalcompositeoperation">globalCompositeOperation</a></code> attribute. 
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p> <a href="https://github.com/w3c/fxtf-drafts/issues">GitHub Issues</a> are preferred for discussion of this specification.
	When filing an issue, please put the text “compositing” in the title,
	preferably like this:
	“[compositing] <i data-lt>…summary of comment…</i>”.
	All issues and comments are <a href="https://lists.w3.org/Archives/Public/public-fxtf-archive/">archived</a>,
	and there is also a <a href="http://lists.w3.org/Archives/Public/public-fx/">historical archive</a>. </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/css">CSS Working Group</a> (part of the <a href="https://www.w3.org/Style/">Style Activity</a>). </p>
   <p> This document was produced by a group operating under
	the <a href="https://www.w3.org/policies/patent-policy/20200915/">W3C Patent Policy</a>.
	W3C maintains a <a href="https://www.w3.org/groups/wg/css/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
	that page also includes instructions for disclosing a patent.
	An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/20200915/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/20200915/#sec-Disclosure">section 6 of the W3C Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#reading-this-document"><span class="secno">2</span> <span class="content">Reading This Document</span></a>
     <ol class="toc">
      <li><a href="#module-interactions"><span class="secno">2.1</span> <span class="content">Module interactions</span></a>
      <li><a href="#values"><span class="secno">2.2</span> <span class="content">Values</span></a>
     </ol>
    <li>
     <a href="#csscompositingandblending"><span class="secno">3</span> <span class="content">Specifying Blending in CSS </span></a>
     <ol class="toc">
      <li><a href="#compositingandblendingorder"><span class="secno">3.1</span> <span class="content">Order of graphical operations</span></a>
      <li><a href="#csscompositingrules_CSS"><span class="secno">3.2</span> <span class="content">Behavior specific to HTML</span></a>
      <li><a href="#csscompositingrules_SVG"><span class="secno">3.3</span> <span class="content">Behavior specific to SVG</span></a>
      <li>
       <a href="#csskeywords"><span class="secno">3.4</span> <span class="content">CSS Properties</span></a>
       <ol class="toc">
        <li><a href="#mix-blend-mode"><span class="secno">3.4.1</span> <span class="content">The <span class="property">mix-blend-mode</span> property</span></a>
        <li><a href="#isolation"><span class="secno">3.4.2</span> <span class="content">The <span class="property">isolation</span> property</span></a>
        <li><a href="#background-blend-mode"><span class="secno">3.4.3</span> <span class="content">The <span class="property">background-blend-mode</span> property</span></a>
       </ol>
     </ol>
    <li><a href="#canvascompositingandblending"><span class="secno">4</span> <span class="content">Specifying Compositing and Blending in Canvas 2D</span></a>
    <li>
     <a href="#whatiscompositing"><span class="secno">5</span> <span class="content">Introduction to compositing</span></a>
     <ol class="toc">
      <li>
       <a href="#simplealphacompositing"><span class="secno">5.1</span> <span class="content">Simple alpha compositing</span></a>
       <ol class="toc">
        <li><a href="#simplealphacompositingexamples"><span class="secno">5.1.1</span> <span class="content">Examples of simple alpha compositing</span></a>
       </ol>
     </ol>
    <li><a href="#generalformula"><span class="secno">6</span> <span class="content">General Formula for Compositing and Blending</span></a>
    <li>
     <a href="#backdropCalc"><span class="secno">7</span> <span class="content">Backdrop calculation</span></a>
     <ol class="toc">
      <li><a href="#backdropexamples"><span class="secno">7.1</span> <span class="content">Examples of backdrop calculation</span></a>
     </ol>
    <li>
     <a href="#groups"><span class="secno">8</span> <span class="content">Compositing Groups</span></a>
     <ol class="toc">
      <li><a href="#groupinvariance"><span class="secno">8.1</span> <span class="content">Group invariance</span></a>
      <li><a href="#isolatedgroups"><span class="secno">8.2</span> <span class="content">Isolated Groups</span></a>
      <li><a href="#pagebackdrop"><span class="secno">8.3</span> <span class="content">The Root Element Group</span></a>
      <li><a href="#rootgroup"><span class="secno">8.4</span> <span class="content">The Root Group</span></a>
     </ol>
    <li>
     <a href="#advancedcompositing"><span class="secno">9</span> <span class="content">Advanced compositing features</span></a>
     <ol class="toc">
      <li>
       <a href="#porterduffcompositingoperators"><span class="secno">9.1</span> <span class="content">The Porter Duff Compositing Operators</span></a>
       <ol class="toc">
        <li><a href="#porterduffcompositingoperators_clear"><span class="secno">9.1.1</span> <span class="content">Clear</span></a>
        <li><a href="#porterduffcompositingoperators_src"><span class="secno">9.1.2</span> <span class="content">Copy</span></a>
        <li><a href="#porterduffcompositingoperators_dst"><span class="secno">9.1.3</span> <span class="content">Destination</span></a>
        <li><a href="#porterduffcompositingoperators_srcover"><span class="secno">9.1.4</span> <span class="content">Source Over</span></a>
        <li><a href="#porterduffcompositingoperators_dstover"><span class="secno">9.1.5</span> <span class="content">Destination Over</span></a>
        <li><a href="#porterduffcompositingoperators_srcin"><span class="secno">9.1.6</span> <span class="content">Source In</span></a>
        <li><a href="#porterduffcompositingoperators_dstin"><span class="secno">9.1.7</span> <span class="content">Destination In</span></a>
        <li><a href="#porterduffcompositingoperators_srcout"><span class="secno">9.1.8</span> <span class="content">Source Out</span></a>
        <li><a href="#porterduffcompositingoperators_dstout"><span class="secno">9.1.9</span> <span class="content">Destination Out</span></a>
        <li><a href="#porterduffcompositingoperators_srcatop"><span class="secno">9.1.10</span> <span class="content">Source Atop</span></a>
        <li><a href="#porterduffcompositingoperators_dstatop"><span class="secno">9.1.11</span> <span class="content">Destination Atop</span></a>
        <li><a href="#porterduffcompositingoperators_xor"><span class="secno">9.1.12</span> <span class="content">XOR</span></a>
        <li><a href="#porterduffcompositingoperators_plus"><span class="secno">9.1.13</span> <span class="content">Lighter</span></a>
        <li><a href="#porterduffcompositingoperators_plus_darker"><span class="secno">9.1.14</span> <span class="content">Plus-darker</span></a>
        <li><a href="#porterduffcompositingoperators_plus_lighter"><span class="secno">9.1.15</span> <span class="content">Plus-lighter</span></a>
       </ol>
      <li><a href="#groupcompositing"><span class="secno">9.2</span> <span class="content">Group compositing behavior with Porter Duff modes</span></a>
     </ol>
    <li>
     <a href="#blending"><span class="secno">10</span> <span class="content">Blending</span></a>
     <ol class="toc">
      <li>
       <a href="#blendingseparable"><span class="secno">10.1</span> <span class="content">Separable blend modes</span></a>
       <ol class="toc">
        <li><a href="#blendingnormal"><span class="secno">10.1.1</span> <span class="content"><span>normal</span> blend mode</span></a>
        <li><a href="#blendingmultiply"><span class="secno">10.1.2</span> <span class="content"><span>multiply</span> blend mode</span></a>
        <li><a href="#blendingscreen"><span class="secno">10.1.3</span> <span class="content"><span>screen</span> blend mode</span></a>
        <li><a href="#blendingoverlay"><span class="secno">10.1.4</span> <span class="content"><span>overlay</span> blend mode</span></a>
        <li><a href="#blendingdarken"><span class="secno">10.1.5</span> <span class="content"><span>darken</span> blend mode</span></a>
        <li><a href="#blendinglighten"><span class="secno">10.1.6</span> <span class="content"><span>lighten</span> blend mode</span></a>
        <li><a href="#blendingcolordodge"><span class="secno">10.1.7</span> <span class="content"><span>color-dodge</span> blend mode</span></a>
        <li><a href="#blendingcolorburn"><span class="secno">10.1.8</span> <span class="content"><span>color-burn</span> blend mode</span></a>
        <li><a href="#blendinghardlight"><span class="secno">10.1.9</span> <span class="content"><span>hard-light</span> blend mode</span></a>
        <li><a href="#blendingsoftlight"><span class="secno">10.1.10</span> <span class="content"><span>soft-light</span> blend mode</span></a>
        <li><a href="#blendingdifference"><span class="secno">10.1.11</span> <span class="content"><span>difference</span> blend mode</span></a>
        <li><a href="#blendingexclusion"><span class="secno">10.1.12</span> <span class="content"><span>exclusion</span> blend mode</span></a>
       </ol>
      <li>
       <a href="#blendingnonseparable"><span class="secno">10.2</span> <span class="content">Non-separable blend modes</span></a>
       <ol class="toc">
        <li><a href="#blendinghue"><span class="secno">10.2.1</span> <span class="content"><span>hue</span> blend mode</span></a>
        <li><a href="#blendingsaturation"><span class="secno">10.2.2</span> <span class="content"><span>saturation</span> blend mode</span></a>
        <li><a href="#blendingcolor"><span class="secno">10.2.3</span> <span class="content"><span>color</span> blend mode</span></a>
        <li><a href="#blendingluminosity"><span class="secno">10.2.4</span> <span class="content"><span>luminosity</span> blend mode</span></a>
       </ol>
      <li><a href="#isolationblending"><span class="secno">10.3</span> <span class="content">Effect of group isolation on blending</span></a>
     </ol>
    <li><a href="#security"><span class="secno">11</span> <span class="content">Security issues with compositing and blending</span></a>
    <li><a href="#changes"><span class="secno">12</span> <span class="content">Changes</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content"> Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content"> Document conventions</span></a>
      <li><a href="#w3c-conformance-classes"><span class="secno"></span> <span class="content"> Conformance classes</span></a>
      <li>
       <a href="#w3c-partial"><span class="secno"></span> <span class="content"> Partial implementations</span></a>
       <ol class="toc">
        <li><a href="#w3c-conform-future-proofing"><span class="secno"></span> <span class="content"> Implementations of Unstable and Proprietary Features</span></a>
       </ol>
      <li><a href="#w3c-testing"><span class="secno"></span> <span class="content"> Non-experimental implementations</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#property-index"><span class="secno"></span> <span class="content">Property Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
   <p><em>This subsection is non-normative.</em><br> The first part of this document describes the properties used to control the compositing in CSS.
The second part will describe the algorithms of Porter Duff compositing and blending. </p>
   <h2 class="heading settled" data-level="2" id="reading-this-document"><span class="secno">2. </span><span class="content">Reading This Document</span><a class="self-link" href="#reading-this-document"></a></h2>
   <p>Each section of this document is normative unless otherwise specified.</p>
   <h3 class="heading settled" data-level="2.1" id="module-interactions"><span class="secno">2.1. </span><span class="content">Module interactions</span><a class="self-link" href="#module-interactions"></a></h3>
   <p>This specification defines a set of CSS properties that affect the visual rendering of elements to which
those properties are applied; these effects are applied after elements have been sized and positioned according
to the <a href="https://www.w3.org/TR/CSS21/visuren.html#visual-model-intro">Visual formatting model</a>. Some values of these properties result in the creation of a <a data-link-type="dfn">containing block</a>,
and/or the creation of a <a data-link-type="dfn" href="https://www.w3.org/TR/CSS21/visuren.html#x43" id="ref-for-x43">stacking context</a>.</p>
   <p>The <a class="property css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode">background-blend-mode</a> property also builds upon the properties defined in the <a href="https://www.w3.org/TR/css3-background/#placement" title="Backgrounds and Borders">CSS  Backgrounds and Borders</a> module <a data-link-type="biblio" href="#biblio-css3bg" title="CSS Backgrounds and Borders Module Level 3">[CSS3BG]</a>.</p>
   <p>This specification also enhances the rules as specified in <a href="https://www.w3.org/TR/2003/REC-SVG11-20030114/masking.html#SimpleAlphaBlending" title="simple alpha blending">Section 14.2 Simple alpha compositing</a> of <a data-link-type="biblio" href="#biblio-svg11" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[SVG11]</a> and <a href="https://www.w3.org/TR/css3-color/#alpha" title="simple alpha compositing">simple alpha compositing</a> of <a data-link-type="biblio" href="#biblio-css3color" title="CSS Color Module Level 3">[CSS3COLOR]</a>.</p>
   <p>This module also extends the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation" id="ref-for-dom-context-2d-globalcompositeoperation①">globalCompositeOperation</a></code>.</p>
   <h3 class="heading settled" data-level="2.2" id="values"><span class="secno">2.2. </span><span class="content">Values</span><a class="self-link" href="#values"></a></h3>
   <p>This specification follows the <a href="https://www.w3.org/TR/CSS21/about.html#property-defs">CSS property
definition conventions</a>. Value types not defined in
this specification are defined in CSS Level 2 Revision 1 <a data-link-type="biblio" href="#biblio-css21" title="Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification">[CSS21]</a>. Other CSS
modules may expand the definitions of these value types: for example <a data-link-type="biblio" href="#biblio-css3color" title="CSS Color Module Level 3">[CSS3COLOR]</a>,
when combined with this module, expands the definition of the &lt;color>
value type as used in this specification.</p>
   <p>In addition to the property-specific values listed in their definitions,
all properties defined in this specification also accept the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-3/#css-inheritance" id="ref-for-css-inheritance">inherit</a> keyword as their property value. For readability it has not been repeated
explicitly.</p>
   <h2 class="heading settled" data-level="3" id="csscompositingandblending"><span class="secno">3. </span><span class="content">Specifying Blending in CSS </span><a class="self-link" href="#csscompositingandblending"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="compositingandblendingorder"><span class="secno">3.1. </span><span class="content">Order of graphical operations</span><a class="self-link" href="#compositingandblendingorder"></a></h3>
   <p>The compositing model must follow the <a href="https://www.w3.org/TR/SVG11/render.html#Introduction">SVG compositing</a> model <a data-link-type="biblio" href="#biblio-svg11" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[SVG11]</a>: first any filter effect is applied, then any clipping, masking, blending and compositing.</p>
   <h3 class="heading settled" data-level="3.2" id="csscompositingrules_CSS"><span class="secno">3.2. </span><span class="content">Behavior specific to HTML</span><a class="self-link" href="#csscompositingrules_CSS"></a></h3>
   <p>Everything in CSS that creates a <a data-link-type="dfn" href="https://www.w3.org/TR/CSS21/visuren.html#x43" id="ref-for-x43①">stacking context</a> must be considered an <a href="#isolatedgroups">‘isolated’ group</a>. HTML elements themselves should not create groups.</p>
   <p>An element that has blending applied, must blend with all the underlying content of the <a data-link-type="dfn" href="https://www.w3.org/TR/CSS21/visuren.html#x43" id="ref-for-x43②">stacking context</a> that that element belongs to.</p>
   <p>The root element for an HTML document is the <a href="https://dom.spec.whatwg.org/#document-element">document element</a>.</p>
   <h3 class="heading settled" data-level="3.3" id="csscompositingrules_SVG"><span class="secno">3.3. </span><span class="content">Behavior specific to SVG</span><a class="self-link" href="#csscompositingrules_SVG"></a></h3>
   <p>By default, every element must create a <a href="#isolatedgroups">non-isolated group</a>.</p>
   <p>However, certain operations in SVG will create <a href="#isolatedgroups">isolated groups</a>. If one of the following features is used, the group must become isolated:</p>
   <ul>
    <li>opacity
    <li>filters
    <li>3D transforms (2D transforms must NOT cause isolation)
    <li>blending
    <li>masking
   </ul>
   <p>The root element for SVG is the <a href="https://www.w3.org/TR/SVG11/struct.html#NewDocument">SVG element</a>.</p>
   <h3 class="heading settled" data-level="3.4" id="csskeywords"><span class="secno">3.4. </span><span class="content">CSS Properties</span><a class="self-link" href="#csskeywords"></a></h3>
   <h4 class="heading settled" data-level="3.4.1" id="mix-blend-mode"><span class="secno">3.4.1. </span><span class="content">The <a class="property css" data-link-type="property" href="#propdef-mix-blend-mode" id="ref-for-propdef-mix-blend-mode">mix-blend-mode</a> property</span><a class="self-link" href="#mix-blend-mode"></a></h4>
   <p>The blend mode defines the formula that must be used to mix the colors with the backdrop.
This behavior is described in more detail in <a href="#blending">Blending</a>.</p>
   <table class="def propdef" data-link-for-hint="mix-blend-mode">
    <tbody>
     <tr>
      <th>Name:
      <td><dfn class="dfn-paneled css" data-dfn-type="property" data-export id="propdef-mix-blend-mode">mix-blend-mode</dfn>
     <tr class="value">
      <th><a href="https://www.w3.org/TR/css-values/#value-defs">Value:</a>
      <td class="prod"><a class="production css" data-link-type="type" href="#ltblendmodegt" id="ref-for-ltblendmodegt">&lt;blend-mode></a>
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#initial-values">Initial:</a>
      <td>normal
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#applies-to">Applies to:</a>
      <td>All elements. In SVG, it applies to <a href="https://www.w3.org/TR/SVG/intro.html#TermContainerElement">container elements</a>, <a href="https://www.w3.org/TR/SVG/intro.html#TermGraphicsElement">graphics elements</a> and <a href="https://www.w3.org/TR/2011/REC-SVG11-20110816/intro.html#TermGraphicsReferencingElement">graphics referencing elements</a>. <a data-link-type="biblio" href="#biblio-svg11" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[SVG11]</a>
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#inherited-property">Inherited:</a>
      <td>no
     <tr>
      <th><a href="https://www.w3.org/TR/css-values/#percentages">Percentages:</a>
      <td>N/A
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#computed">Computed value:</a>
      <td>as specified
     <tr>
      <th><a href="https://www.w3.org/TR/cssom/#serializing-css-values">Canonical order:</a>
      <td>per grammar
     <tr>
      <th>Media:
      <td>visual
     <tr>
      <th><a href="https://www.w3.org/TR/web-animations/#animation-type">Animatable:</a>
      <td>no
   </table>
   <p>The syntax of the property of <a class="production css" data-link-type="type" href="#ltblendmodegt" id="ref-for-ltblendmodegt①">&lt;blend-mode></a> is given with:</p>
<pre class="blendmode prod"><dfn class="dfn-paneled" data-dfn-type="type" data-export id="ltblendmodegt">&lt;blend-mode></dfn> = <a data-link-type="value" href="#valdef-blend-mode-normal" id="ref-for-valdef-blend-mode-normal">normal</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one">|</a> <a data-link-type="value" href="#valdef-blend-mode-multiply" id="ref-for-valdef-blend-mode-multiply">multiply</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①">|</a> <a data-link-type="value" href="#valdef-blend-mode-screen" id="ref-for-valdef-blend-mode-screen">screen</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②">|</a> <a data-link-type="value" href="#valdef-blend-mode-overlay" id="ref-for-valdef-blend-mode-overlay">overlay</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one③">|</a> <a data-link-type="value" href="#valdef-blend-mode-darken" id="ref-for-valdef-blend-mode-darken">darken</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one④">|</a> <a data-link-type="value" href="#valdef-blend-mode-lighten" id="ref-for-valdef-blend-mode-lighten">lighten</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one⑤">|</a> <a data-link-type="value" href="#valdef-blend-mode-color-dodge" id="ref-for-valdef-blend-mode-color-dodge">color-dodge</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one⑥">|</a><a data-link-type="value" href="#valdef-blend-mode-color-burn" id="ref-for-valdef-blend-mode-color-burn">color-burn</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one⑦">|</a> <a data-link-type="value" href="#valdef-blend-mode-hard-light" id="ref-for-valdef-blend-mode-hard-light">hard-light</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one⑧">|</a> <a data-link-type="value" href="#valdef-blend-mode-soft-light" id="ref-for-valdef-blend-mode-soft-light">soft-light</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one⑨">|</a> <a data-link-type="value" href="#valdef-blend-mode-difference" id="ref-for-valdef-blend-mode-difference">difference</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⓪">|</a> <a data-link-type="value" href="#valdef-blend-mode-exclusion" id="ref-for-valdef-blend-mode-exclusion">exclusion</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①①">|</a> <a data-link-type="value" href="#valdef-blend-mode-hue" id="ref-for-valdef-blend-mode-hue">hue</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①②">|</a>
<a data-link-type="value" href="#valdef-blend-mode-saturation" id="ref-for-valdef-blend-mode-saturation">saturation</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①③">|</a> <a data-link-type="value" href="#valdef-blend-mode-color" id="ref-for-valdef-blend-mode-color">color</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①④">|</a> <a data-link-type="value" href="#valdef-blend-mode-luminosity" id="ref-for-valdef-blend-mode-luminosity">luminosity</a></pre>
   <p class="note" role="note"><span class="marker">Note:</span> Applying a blendmode other than <a class="css" data-link-type="value" href="#valdef-blend-mode-normal" id="ref-for-valdef-blend-mode-normal①">normal</a> to the element must establish a new <a data-link-type="dfn" href="https://www.w3.org/TR/CSS21/visuren.html#x43" id="ref-for-x43③">stacking context</a>. This group must then be blended and composited with the <span id="ref-for-x43④">stacking context</span> that contains the element.</p>
   <div class="example" id="example-7e584e42">
    <a class="self-link" href="#example-7e584e42"></a> 
    <p>Given the following sample markup:</p>
<pre>&lt;body>
  &lt;img src="ducky.png"/>
&lt;/body>
</pre>
    <p>And the following style rule:</p>
<pre>body { background-color: lime; }
</pre>
    <p> ... will produce the following result: </p>
    <div class="figure">
      <img alt="example of an image of duck with the lime color of the document" src="examples/ducky_normal.png" style="width:30%"> 
     <p class="caption"> Partially transparent image on a lime backdrop</p>
    </div>
    <p>If we change the style rule to include blending:</p>
<pre>body { background-color: lime; }
img { mix-blend-mode: multiply; }
</pre>
    <p> ... the output will be the image blending with the lime background of the &lt;body> element. </p>
    <div class="figure">
      <img alt="example of an image of duck blending with the lime color of the document" src="examples/ducky_multiply.png" style="width:30%"> 
     <p class="caption"> Blending of a transparent image on a lime backdrop. </p>
    </div>
   </div>
   <div class="example" id="example-cc75cc4f">
    <a class="self-link" href="#example-cc75cc4f"></a> 
    <p>Given the following svg code:</p>
<pre>&lt;svg>
  &lt;circle cx="40" cy="40" r="40" fill="red"/>
  &lt;circle cx="80" cy="40" r="40" fill="lime"/>
  &lt;circle cx="60" cy="80" r="40" fill="blue"/>
&lt;/svg>
</pre>
    <p>And the following style rule:</p>
<pre>circle { mix-blend-mode: screen; }
</pre>
    <p> ... the output will be blending of the 3 circles. Each circle is rendered from bottom to top. Where the elements overlap, the blend mode produces a change in color. </p>
    <div class="figure">
      <img alt="example of 3 circles blending with a screen blend mode" src="examples/screen_example.svg" style="width:30%"> 
     <p class="caption"> Example of 3 circles blending with a screen blend mode </p>
    </div>
   </div>
   <div class="example" id="example-0c443386">
    <a class="self-link" href="#example-0c443386"></a> 
    <p>In the following style sheet and document fragment:</p>
<pre>body { background-color: lime; }
div { background-color: red; width: 200px; opacity: .95}
img { mix-blend-mode: difference; }

&lt;body>
  &lt;div>
     &lt;img src="ducky.png"/>
  &lt;/div>
&lt;/body>
</pre>
    <p> ... the <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-color-4/#propdef-opacity" id="ref-for-propdef-opacity">opacity</a> on the &lt;div> element is causing the creation of a stacking context. This causes the creation of a new group so the image doesn’t blend with the color of the &lt;body>. </p>
    <div class="figure">
      <img alt="example of an image of duck blending with the lime color of the document" src="examples/ducky_difference.png" style="width:30%"> 
     <p class="caption"> Example of blending within a stacking context.</p>
    </div>
    <p> Note how the image is not blending with the lime color. </p>
   </div>
   <div class="example" id="example-f6e93bc6">
    <a class="self-link" href="#example-f6e93bc6"></a> 
    <p>Given the following sample markup:</p>
<pre>&lt;body>
   &lt;div>
     &lt;p><a class="css" data-link-type="maybe" href="#valdef-blend-mode-overlay" id="ref-for-valdef-blend-mode-overlay①">overlay</a> blending on text&lt;/p>
   &lt;/div>
&lt;/body>
</pre>
    <p>And the following style rule:</p>
<pre>div { background-image: url('texture.png'); }
@font-face {
  font-family: "Mythos Std";
  src: url("http://myfontvendor.com/mythos.otf");
}
p {
  mix-blend-mode: overlay;
  font-family: "Mythos Std"
}
</pre>
    <div class="figure">
      <img alt="example of text that has an overlay blend on top of a texture" src="examples/overlay_text.png" style="width:75%"> 
     <p class="caption"> Text with a blend overlay on top of an image. </p>
    </div>
   </div>
   <h4 class="heading settled" data-level="3.4.2" id="isolation"><span class="secno">3.4.2. </span><span class="content">The <a class="property css" data-link-type="property" href="#propdef-isolation" id="ref-for-propdef-isolation">isolation</a> property</span><a class="self-link" href="#isolation"></a></h4>
   <p>In SVG, this defines whether an element is isolated or not.<br> For CSS, setting <a class="property css" data-link-type="property" href="#propdef-isolation" id="ref-for-propdef-isolation①">isolation</a> to <span class="css">isolate</span> will turn the element into a stacking context.</p>
   <p>By default, elements use the <span class="css">auto</span> keyword which implies that they are not isolated. However operations that cause the creation of <a data-link-type="dfn" href="https://www.w3.org/TR/CSS21/visuren.html#x43" id="ref-for-x43⑤">stacking context</a> must cause a group to be isolated. These operations are described in <a href="#csscompositingrules_CSS">'behavior specific to HTML'</a> and <a href="#csscompositingrules_SVG">'behavior specific to SVG'</a>.</p>
   <table class="def propdef" data-link-for-hint="isolation">
    <tbody>
     <tr>
      <th>Name:
      <td><dfn class="dfn-paneled css" data-dfn-type="property" data-export id="propdef-isolation">isolation</dfn>
     <tr class="value">
      <th><a href="https://www.w3.org/TR/css-values/#value-defs">Value:</a>
      <td class="prod"><a class="production css" data-link-type="type" href="#isolated-propid" id="ref-for-isolated-propid">&lt;isolation-mode></a>
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#initial-values">Initial:</a>
      <td>auto
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#applies-to">Applies to:</a>
      <td>All elements. In SVG, it applies to <a href="https://www.w3.org/TR/SVG/intro.html#TermContainerElement">container elements</a>, <a href="https://www.w3.org/TR/SVG/intro.html#TermGraphicsElement">graphics elements</a> and <a href="https://www.w3.org/TR/2011/REC-SVG11-20110816/intro.html#TermGraphicsReferencingElement">graphics referencing elements</a>. <a data-link-type="biblio" href="#biblio-svg11" title="Scalable Vector Graphics (SVG) 1.1 (Second Edition)">[SVG11]</a>
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#inherited-property">Inherited:</a>
      <td>no
     <tr>
      <th><a href="https://www.w3.org/TR/css-values/#percentages">Percentages:</a>
      <td>N/A
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#computed">Computed value:</a>
      <td>as specified
     <tr>
      <th><a href="https://www.w3.org/TR/cssom/#serializing-css-values">Canonical order:</a>
      <td>per grammar
     <tr>
      <th>Media:
      <td>visual
     <tr>
      <th><a href="https://www.w3.org/TR/web-animations/#animation-type">Animatable:</a>
      <td>no
   </table>
   <p>The syntax of the property of <a class="production css" data-link-type="type" href="#isolated-propid" id="ref-for-isolated-propid①">&lt;isolation-mode></a> is given with:</p>
<pre class="isolated prod"><dfn class="dfn-paneled" data-dfn-type="type" data-export id="isolated-propid">&lt;isolation-mode></dfn> = auto <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⑤">|</a> isolate</pre>
   <p id="img_isolation"> In CSS, a background image or the content of an <a data-link-type="element" href="https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element" id="ref-for-the-img-element">img</a> must always be rendered into an isolated group.<br>For instance, if you link to an SVG file through the <span id="ref-for-the-img-element①">img</span> tag, the artwork of that SVG will not blend with the backdrop of the content.</p>
   <p>In SVG, <a class="property css" data-link-type="property">mask</a> always creates an isolated group.</p>
   <h4 class="heading settled" data-level="3.4.3" id="background-blend-mode"><span class="secno">3.4.3. </span><span class="content">The <a class="property css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode①">background-blend-mode</a> property</span><a class="self-link" href="#background-blend-mode"></a></h4>
   <p>Defines the blending mode of each background layer.</p>
   <p>Each background layer must blend with the element’s background layer that is below it and the element’s background color. Background layers must not blend with the content that is behind the element, instead they must act as if they are rendered into an isolated group.</p>
   <p>The description of the <a class="property css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode②">background-blend-mode</a> property is as follows:</p>
   <table class="def propdef" data-link-for-hint="background-blend-mode">
    <tbody>
     <tr>
      <th>Name:
      <td><dfn class="dfn-paneled css" data-dfn-type="property" data-export id="propdef-background-blend-mode">background-blend-mode</dfn>
     <tr class="value">
      <th><a href="https://www.w3.org/TR/css-values/#value-defs">Value:</a>
      <td class="prod"><a class="production css" data-link-type="type" href="#ltblendmodegt" id="ref-for-ltblendmodegt②">&lt;blend-mode></a><a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#mult-comma" id="ref-for-mult-comma">#</a>
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#initial-values">Initial:</a>
      <td>normal
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#applies-to">Applies to:</a>
      <td>All HTML elements
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#inherited-property">Inherited:</a>
      <td>no
     <tr>
      <th><a href="https://www.w3.org/TR/css-values/#percentages">Percentages:</a>
      <td>N/A
     <tr>
      <th><a href="https://www.w3.org/TR/css-cascade/#computed">Computed value:</a>
      <td>as specified
     <tr>
      <th><a href="https://www.w3.org/TR/cssom/#serializing-css-values">Canonical order:</a>
      <td>per grammar
     <tr>
      <th>Media:
      <td>visual
     <tr>
      <th><a href="https://www.w3.org/TR/web-animations/#animation-type">Animatable:</a>
      <td>no
   </table>
   <p>The <a class="property css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode③">background-blend-mode</a> list must be applied in the same order as <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image" id="ref-for-propdef-background-image">background-image</a> <a data-link-type="biblio" href="#biblio-css3bg" title="CSS Backgrounds and Borders Module Level 3">[CSS3BG]</a>. This means that the first element in the list will apply to the layer that is on top. If a property doesn’t have enough comma-separated values to match the number of layers, the UA must calculate its used value by repeating the list of values until there are enough.</p>
   <p></p>
   <p>If the <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-backgrounds-3/#propdef-background" id="ref-for-propdef-background">background</a> <a data-link-type="biblio" href="#biblio-css3bg" title="CSS Backgrounds and Borders Module Level 3">[CSS3BG]</a> shorthand is used, the <a class="property css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode④">background-blend-mode</a> property for that element must be reset to its initial value.</p>
   <div class="example" id="example-392c0544">
    <a class="self-link" href="#example-392c0544"></a> 
    <p>Given the following sample markup:</p>
<pre>&lt;body>
   &lt;div>&lt;/div>
&lt;/body>
</pre>
    <p>And the following style rule:</p>
<pre>body { background-color: lime; }
div {
  width: 200px;
  height: 200px;
  background-size: 200px 200px;
  background-repeat:no-repeat;
  background-image: linear-gradient(to right, #000000 0%,#ffffff 100%), url('ducky.png');
  background-blend-mode: difference, normal;
}
</pre>
    <div class="figure">
      <img alt="example of div that has an image of a duck and a gradient that is blending" src="examples/ducky_background_blend.png" style="width:30%"> 
     <p class="caption"> Blending of 2 background images. </p>
    </div>
    <p> Note that the gradient is not blending with the color of <a data-link-type="element" href="https://html.spec.whatwg.org/multipage/sections.html#the-body-element" id="ref-for-the-body-element">body</a>. Instead it retains its original color. </p>
   </div>
   <h2 class="heading settled" data-level="4" id="canvascompositingandblending"><span class="secno">4. </span><span class="content">Specifying Compositing and Blending in Canvas 2D</span><a class="self-link" href="#canvascompositingandblending"></a></h2>
   <p>The <a href="https://html.spec.whatwg.org/multipage/canvas.html#2dcontext">canvas 2d</a> context defines the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation" id="ref-for-dom-context-2d-globalcompositeoperation②">globalCompositeOperation</a></code> attribute that is used to set the current compositing and blending operator.</p>
   <p>This property takes the following value:</p>
   <div class="propdef">
    <dl>
     <dt id="propdef-mix"><a class="self-link" href="#propdef-mix"></a><span class="propdef-title prop-name">‘globalCompositeOperation’</span>
     <dd>
      <table class="propinfo">
       <tbody>
        <tr>
         <td><em>Value:</em>  
         <td> <a class="production css" data-link-type="type" href="#ltblendmodegt" id="ref-for-ltblendmodegt③">&lt;blend-mode></a> | <a class="production css" data-link-type="type" href="#compositemode" id="ref-for-compositemode">&lt;composite-mode></a> 
        <tr>
         <td><em>Initial:</em>  
         <td>source-over
      </table>
    </dl>
   </div>
   <p>The syntax of the property of <a class="production css" data-link-type="type" href="#compositemode" id="ref-for-compositemode①">&lt;composite-mode></a> is given with:</p>
<pre class="compositemode prod"><dfn class="dfn-paneled" data-dfn-type="type" data-export id="compositemode">&lt;composite-mode></dfn> = <a data-link-type="dfn" href="#clear" id="ref-for-clear">clear</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⑥">|</a> <a data-link-type="dfn" href="#copy" id="ref-for-copy">copy</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⑦">|</a> <a data-link-type="dfn" href="#source-over" id="ref-for-source-over">source-over</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⑧">|</a> <a data-link-type="dfn" href="#destination-over" id="ref-for-destination-over">destination-over</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one①⑨">|</a> <a data-link-type="dfn" href="#source-in" id="ref-for-source-in">source-in</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②⓪">|</a>    <br><a data-link-type="dfn" href="#destination-in" id="ref-for-destination-in">destination-in</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②①">|</a> <a data-link-type="dfn" href="#source-out" id="ref-for-source-out">source-out</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②②">|</a> <a data-link-type="dfn" href="#destination-out" id="ref-for-destination-out">destination-out</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②③">|</a> <a data-link-type="dfn" href="#source-atop" id="ref-for-source-atop">source-atop</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②④">|</a>    <br><a data-link-type="dfn" href="#destination-atop" id="ref-for-destination-atop">destination-atop</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②⑤">|</a> <a data-link-type="dfn" href="#xor" id="ref-for-xor">xor</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②⑥">|</a> <a data-link-type="dfn" href="#lighter" id="ref-for-lighter">lighter</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②⑦">|</a> <a data-link-type="dfn" href="#plus-darker" id="ref-for-plus-darker">plus-darker</a> <a data-link-type="grammar" href="https://drafts.csswg.org/css-values-4/#comb-one" id="ref-for-comb-one②⑧">|</a> <a data-link-type="dfn" href="#plus-lighter" id="ref-for-plus-lighter">plus-lighter</a></pre>
   <h2 class="heading settled" data-level="5" id="whatiscompositing"><span class="secno">5. </span><span class="content">Introduction to compositing</span><a class="self-link" href="#whatiscompositing"></a></h2>
   <p>Compositing is the combining of a graphic element with its backdrop.</p>
   <p>In the model described in this specification there are two steps to the overall compositing operation - <a href="#advancedcompositing">Porter-Duff compositing</a> and <a href="#blending">blending</a>.
The blending step determines how the colors from the graphic element and the backdrop interact.</p>
   <p>Typically, the blending step is performed first, followed by the Porter-Duff compositing step.
In the blending step, the resultant color from the mix of the element and the the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①">backdrop</a> is calculated. The graphic element’s color is replaced with this resultant color.
The graphic element is then composited with the <span id="ref-for-backdrop②">backdrop</span> using the specified compositing operator.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Shape is defined by the mathematical description of the shape. A particular point is either inside the shape or it is not. There are no gradations.</p>
   <p class="note" role="note"><span class="marker">Note:</span> Opacity is described using an alpha value, stored alongside the color value for each particular point. The alpha value is between 0 and 1, inclusive.
 A value of 0 means that the pixel has no coverage at that point, and is therefore
transparent; i.e. there is no color contribution from any geometry because the geometry does not overlap this pixel. A value of 1 means that the pixel is fully opaque; the geometry completely overlaps the pixel.</p>
   <h3 class="heading settled" data-level="5.1" id="simplealphacompositing"><span class="secno">5.1. </span><span class="content">Simple alpha compositing</span><a class="self-link" href="#simplealphacompositing"></a></h3>
   <p>The formula for simple alpha compositing is</p>
<pre>co = Cs x αs + Cb x αb x (1 - αs)
</pre>
   <p>Where</p>
   <ul>
    <li>co: the premultiplied pixel value after compositing 
    <li>Cs: the color value of the source graphic element being composited 
    <li>αs: the alpha value of the source graphic element being composited 
    <li>Cb: the color value of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③">backdrop</a> 
    <li>αb: the alpha value of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop④">backdrop</a> 
   </ul>
   <p class="note" role="note"><span class="marker">Note:</span> All values are between 0 and 1 inclusive.</p>
   <p>The pixel value after compositing (co) is given by adding the contributions from the source graphic element [Cs x αs] and the backdrop [Cb x αb x (1 - αs)].
For both the graphic element and the backdrop, the color values are multiplied by the alpha to determine the amount of color that contributes.
With zero alpha meaning that the color does not contribute and partial alpha means that some percentage of the color contributes.
The contribution of the backdrop is further reduced based on the opacity of the graphic element.
Conceptually, (1 - αs) of the backdrop shows through the graphic element, meaning that if the graphic element is fully opaque (αs=1) then no backdrop shows through.</p>
   <p>The simple alpha compositing formula listed above gives a resultant color which is the result of the
weighted average of the backdrop color and graphic element color, with the weighting determined by the backdrop and
graphic element alphas.
The resultant alpha value of the composite is simply the sum of the contributed alpha of the composited elements.
The formula for the resultant alpha of the composite is</p>
<pre>αo = αs + αb x (1 - αs)
</pre>
   <p>Where</p>
   <ul>
    <li>αo: the alpha value of the composite 
    <li>αs: the alpha value of the graphic element being composited 
    <li>αb: the alpha value of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop⑤">backdrop</a> 
   </ul>
   <p></p>
   <div class="note" role="note">
    <p> Often, it can be more efficient to store a <code>pre-multiplied value</code> for the color and opacity.
The pre-multiplied value is given by </p>
<pre>cs = Cs x αs
</pre>
    <p>with</p>
    <ul>
     <li>cs: the pre-multiplied value 
     <li>Cs: the color value 
     <li>αs: the alpha value 
    </ul>
    <p> Thus the formula for simple alpha compositing using pre-multiplied values becomes </p>
<pre>co = cs + cb x (1 - αs)
</pre>
    <p></p>
    <p></p>
    <p> To extract the color component of a pre-multiplied value, the formula is reversed: </p>
<pre>Co = co / αo
</pre>
    <p></p>
   </div>
   <h4 class="heading settled" data-level="5.1.1" id="simplealphacompositingexamples"><span class="secno">5.1.1. </span><span class="content">Examples of simple alpha compositing</span><a class="self-link" href="#simplealphacompositingexamples"></a></h4>
   <div class="example" id="example-01feca57">
    <a class="self-link" href="#example-01feca57"></a> 
    <div class="figure">
      <img alt="Simple box showing alpha compositing" src="examples/simple_box.svg"> 
     <p class="caption"></p>
    </div>
    <p> This describes the most basic case. It consists of 1 shape that is filled with a solid color (α = 1).
The shape is composited with an empty background. The empty background has no effect on the resultant composite. </p>
<pre>Cs = RGB(1,0,0)
αs = 1
Cb = RGB(0,0,0)
αb = 0

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(1,0,0) x 1 + RGB(0,0,0) x 0 x (1 - 1)
co = RGB(1,0,0) x 1
co = RGB(1,0,0)
</pre>
    <p></p>
   </div>
   <div class="example" id="example-189dd094">
    <a class="self-link" href="#example-189dd094"></a> 
    <div class="figure">
      <img alt="simple shape" src="examples/two_box.svg"> 
     <p class="caption"></p>
    </div>
    <p> This is a more complex example. There is no transparency, but the 2 shapes intersect. </p>
    <p> Applying the compositing formula in the area of intersection, gives: </p>
<pre>Cs = RGB(0,0,1)
αs = 1
Cb = RGB(1,0,0)
αb = 1

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 1 + RGB(1,0,0) x 1 x (1 - 1)
co = RGB(0,0,1) x 1 + RGB(1,0,0) x 1 x 0
co = RGB(0,0,1) x 1
co = RGB(0,0,1)
</pre>
    <p>Calculating the alpha of the resultant composite</p>
<pre>αo = αs + αb x (1 - αs)
αo = 1 + 1 x (1 - 1)
αo = 1
</pre>
    <p>Calculating the color component of the resultant composite</p>
<pre>Co = co / αo
Co = RGB(0, 0, 1) / 1
Co = RGB(0, 0, 1)
</pre>
    <p></p>
   </div>
   <div class="example" id="example-418d3c3f">
    <a class="self-link" href="#example-418d3c3f"></a> 
    <div class="figure">
      <img alt="interaction of a solid box with a transparent box on top" src="examples/two_box_transparency.svg"> 
     <p class="caption"></p>
    </div>
    <p> This is an example where the shape has some transparency, but the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop⑥">backdrop</a> is fully opaque. </p>
    <p> Applying the compositing formula in the area of intersection, gives: </p>
<pre>Cs = RGB(0,0,1)
αs = 0.5
Cb = RGB(1,0,0)
αb = 1

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 1 x (1 - 0.5)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.5
co = RGB(0.5,0,0.5)
</pre>
    <p>Calculating the alpha of the resultant composite</p>
<pre>αo = αs + αb x (1 - αs)
αo = 0.5 + 1 x (1 - 0.5)
αo = 1
</pre>
    <p>Calculating the color component of the resultant composite</p>
<pre>Co = co / αo
Co = RGB(0.5, 0, 0.5) / 1
Co = RGB(0.5, 0, 0.5)
</pre>
    <p></p>
   </div>
   <div class="example" id="example-9f8d7c4e">
    <a class="self-link" href="#example-9f8d7c4e"></a> 
    <div class="figure">
      <img alt="interaction of 2 transparent boxes" src="examples/two_box_transparency_both.svg"> 
     <p class="caption"></p>
    </div>
    <p> Figure 4 shows an example where both the shape and the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop⑦">backdrop</a> are transparent. </p>
    <p> Applying the compositing formula in the area of intersection, gives: </p>
<pre>Cs = RGB(0,0,1)
αs = 0.5
Cb = RGB(1,0,0)
αb = 0.5

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.5 x (1 - 0.5)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.25
co = RGB(0.25, 0, 0.5)
</pre>
    <p>Calculating the alpha of the resultant composite</p>
<pre>αo = αs + αb x (1 - αs)
αo = 0.5 + 0.5 x (1 - 0.5)
αo = 0.75
</pre>
    <p>Calculating the color component of the resultant composite</p>
<pre>Co = co / αo
Co = RGB(0.25, 0, 0.5) / 0.75
Co = RGB(0.33, 0, 0.66)
</pre>
    <p></p>
   </div>
   <h2 class="heading settled" data-level="6" id="generalformula"><span class="secno">6. </span><span class="content">General Formula for Compositing and Blending</span><a class="self-link" href="#generalformula"></a></h2>
   <p>The general formula for compositing and blending which allows for selection of the compositing operator and blending function comprises two steps.
The terms used in these functions will be described in detail in the following sections.</p>
   <p>Apply the blend in place</p>
<pre>Cs = (1 - αb) x Cs + αb x B(Cb, Cs)
</pre>
   <p>Composite</p>
<pre>Co = αs x Fa x Cs + αb x Fb x Cb
</pre>
   <p>Where:</p>
   <ul>
    <li><strong>Cs</strong>: is the source color 
    <li><strong>Cb</strong>: is the backdrop color 
    <li><strong>αs</strong>: is the source alpha 
    <li><strong>αb</strong>: is the backdrop alpha 
    <li><strong>B(Cb, Cs)</strong>: is the mixing function 
    <li><strong>Fa</strong>: is defined by the Porter Duff operator in use 
    <li><strong>Fb</strong>: is defined by the Porter Duff operator in use 
   </ul>
   <h2 class="heading settled" data-level="7" id="backdropCalc"><span class="secno">7. </span><span class="content">Backdrop calculation</span><a class="self-link" href="#backdropCalc"></a></h2>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="backdrop">backdrop</dfn> is the content behind the element and is what the element is composited with.
This means that the backdrop is the result of compositing all previous elements.</p>
   <h3 class="heading settled" data-level="7.1" id="backdropexamples"><span class="secno">7.1. </span><span class="content">Examples of backdrop calculation</span><a class="self-link" href="#backdropexamples"></a></h3>
   <div class="example" id="example-fddbb891">
    <a class="self-link" href="#example-fddbb891"></a> 
    <div class="figure">
      <img alt="example of a simple backdrop calculation" src="examples/simple_backdrop.svg"> 
     <p class="caption"></p>
    </div>
    <p> This example has 2 simple shapes. The backdrop for the blue shape includes the bottom right corner of the red shape .
The dotted line shows the area that is examined during compositing of the blue shape. </p>
   </div>
   <div class="example" id="example-5dfb7a50">
    <a class="self-link" href="#example-5dfb7a50"></a> 
    <div class="figure">
      <img alt="example of a backdrop with alpha" src="examples/simple_backdrop_alpha.svg"> 
     <p class="caption"></p>
    </div>
    <p> The shape in the backdrop has an alpha value. The alpha value of the backdrop shape is preserved when the backdrop is calculated. </p>
   </div>
   <h2 class="heading settled" data-level="8" id="groups"><span class="secno">8. </span><span class="content">Compositing Groups</span><a class="self-link" href="#groups"></a></h2>
   <p>Compositing groups allow more control over the interaction of compositing with the backdrop. Groups can be used to specify how a compositing effect
within a group will interact with the content that is already in the scene (the backdrop).</p>
   <p>Compositing groups may be made up of any number of elements, and may contain other compositing groups.</p>
   <p>The default properties of a compositing group shall cause no visual difference compared to having no group. See <a href="#groupinvariance">Group Invariance</a>.</p>
   <p>A compositing group is rendered by first compositing the elements of the group onto the initial backdrop. The result of this is a single element containing
color and alpha information. This element is then composited onto the group backdrop.
Steps shall be taken to ensure the group backdrop makes only a single contribution to the final composite.</p>
   <dl>
    <dt id="initialbackdrop"><a class="self-link" href="#initialbackdrop"></a>initial backdrop
    <dd> The initial backdrop is the backdrop used for compositing the group’s first element. This will be the same as the group backdrop in a non-isolated
group, or a fully transparent backdrop for an isolated group. 
    <dt id="groupbackdrop"><a class="self-link" href="#groupbackdrop"></a>group backdrop
    <dd> The group backdrop is the result of compositing all elements up to but not including the first element in the group. 
   </dl>
   <h3 class="heading settled" data-level="8.1" id="groupinvariance"><span class="secno">8.1. </span><span class="content">Group invariance</span><a class="self-link" href="#groupinvariance"></a></h3>
   <p>An important property of simple alpha compositing is its group invariance. This behavior is preserved in the more complex model described in this specification.
Adding or removing grouping with default attributes shall not show visual differences.</p>
<pre>so: A + B + C = A + (B + C) = (A + B) + C</pre>
   <p>When adding attributes to the group such as <span class="css">isolate</span>, blending modes other than <a class="css" data-link-type="maybe" href="#valdef-blend-mode-normal" id="ref-for-valdef-blend-mode-normal②">normal</a> or Porter Duff compositing operators other than <span class="css">source-over</span>, groups may no longer be invariant.</p>
   <h3 class="heading settled" data-level="8.2" id="isolatedgroups"><span class="secno">8.2. </span><span class="content">Isolated Groups</span><a class="self-link" href="#isolatedgroups"></a></h3>
   <p>In an isolated group, the initial backdrop shall be black and fully transparent.</p>
   <p>In this instance, the initial backdrop is different than the group backdrop. The only interaction with the group backdrop shall occur when the group’s
computed color, shape and alpha are composited with it.</p>
   <p>See '<a href="#groupcompositing">Isolated groups and Porter Duff modes</a>' for a description of the effect of isolated groups on compositing.
See '<a href="#isolationblending">Effect of group isolation on blending</a>' for a description of the effect of isolated groups on blending.</p>
   <h3 class="heading settled" data-level="8.3" id="pagebackdrop"><span class="secno">8.3. </span><span class="content">The Root Element Group</span><a class="self-link" href="#pagebackdrop"></a></h3>
   <p>The <a href="#isolatedgroups">isolated group</a> for the root element is the
root element group. All other elements and groups are composited into this group. The background of the root element (if specified) is painted into the
root element group, and any filter, clip-path, mask and and opacity is then
applied, before compositing into the <a href="#rootgroup">root group</a>,
if present.</p>
   <h3 class="heading settled" data-level="8.4" id="rootgroup"><span class="secno">8.4. </span><span class="content">The Root Group</span><a class="self-link" href="#rootgroup"></a></h3>
    The root group encompasses the entire canvas and contains (or is below) the root element group of the root element of a web page. 
   <p class="note" role="note">Browsers often use an infinite <a href="https://www.w3.org/TR/css-color-4/#sample">white, 100% opaque</a> root group,
for final compositing, but this is not required. </p>
   <h2 class="heading settled" data-level="9" id="advancedcompositing"><span class="secno">9. </span><span class="content">Advanced compositing features</span><a class="self-link" href="#advancedcompositing"></a></h2>
   <p><a href="#simplealphacompositing">Simple alpha compositing</a> uses the <a data-link-type="dfn" href="#source-over" id="ref-for-source-over①">source-over</a> Porter Duff compositing operator. </p>
   <p>Porter Duff compositing is based on a model of a pixel in which two shapes (source and destination) may contribute to the final color of the pixel. The pixel is divided into 4 sub-pixel regions and each region represents a possible combination of source and destination. <a data-link-type="biblio" href="#biblio-porterduff" title="Compositing digital images">[PORTERDUFF]</a></p>
   <p></p>
   <p>The four regions are:</p>
   <dl>
    <dt>Source Only
    <dd>Where only the source contributes to the pixel color
    <dt>Destination only
    <dd>where only the destination contributes to the pixel color
    <dt>Both
    <dd>Source and Destination – where both the source and destination may combine to define the pixel color
    <dt>None
    <dd>No source or Destination – where neither make a contribution to the final pixel color
   </dl>
   <p class="note" role="note"><span class="marker">Note:</span> Destination is synonymous with backdrop. The term destination is used in this section as this is considered the standard when working with Porter Duff compositing. Additionally, the compositing operators use <span class="css">destination</span> in their names.</p>
   <div class="figure">
    <p style="text-align:center"><img alt="overview of the regions affected by porter duff" src="examples/PD_regions.svg"></p>
    <p class="caption"></p>
   </div>
    The contribution from each region to the final pixel color is defined by the coverage of the shape at that pixel, and the operator in use.
Coverage is specified in terms of alpha. Full alpha (1) implies full coverage, while zero alpha (0) implies no coverage.
This means that the area of each region within the sub-pixel is dependent on the coverage of each shape contributing to the pixel.
The area of each region can be calculated with the following equations: 
   <div class="data">
    <table>
     <tbody>
      <tr>
       <th>Both
       <th>αs x αb
      <tr>
       <th>Source only
       <th>αs x (1 – αb)
      <tr>
       <th>Destination only
       <th>αb x (1 – αs)
      <tr>
       <th>None
       <th>(1 – αs) x (1 – αb)
    </table>
   </div>
   <p>The figure above represents coverage of 0.5 for both source and destination.</p>
<pre>Both = 0.5 x 0.5 = 0.25
Source Only = 0.5 (1 – 0.5) = 0.25
Destination Only = 0.5(1 – 0.5) = 0.25
None = (1 – 0.5)(1 – 0.5) = 0.25
</pre>
   <p>Therefore, the coverage of each region is 0.25 in this example.</p>
   <h3 class="heading settled" data-level="9.1" id="porterduffcompositingoperators"><span class="secno">9.1. </span><span class="content">The Porter Duff Compositing Operators</span><a class="self-link" href="#porterduffcompositingoperators"></a></h3>
   <p>The landmark paper by Thomas Porter and Tom Duff, who worked for Lucasfilm, defined the algebra of compositing and developed the twelve "Porter Duff" operators. These operators control the results of mixing the four sub-pixel regions formed by the overlapping of graphical objects that have an alpha or pixel coverage channel/value. The operators use all practical combinations of the four regions.</p>
   <p>There are 12 basic Porter Duff operators, satisfying all possible combinations of source and destination.</p>
   <p>From the geometric representation of each operator, the contribution of each shape can be seen to be expressed as a fraction of the total coverage of the output.
For example, in source over, the possible contribution of source is full (1) and the possible contribution of destination is whatever is remaining (1 – αs). This is modified by the coverage of source and destination to give the equation for the final coverage of the pixel:</p>
<pre>αo = αs x 1 + αb x (1 – αs)
</pre>
   <p>The fractional terms Fa (1 in this example) and Fb (1 – αs in this example) are defined for each operator and specify the fraction of the shapes that may contribute to the final pixel value.
The general form of the equation for coverage is:</p>
<pre>αs x Fa + αb x Fb
</pre>
   <p>and incorporating color gives the general Porter Duff equation</p>
<pre>co = αs x Fa x Cs + αb x Fb x Cb
</pre>
   <p>Where:</p>
   <ul>
    <li>co is the output color pre-multiplied with the output alpha [0 &lt;= co &lt;= 1] 
    <li>αs is the coverage of the source Fa is defined by the operator and controls inclusion of the source Cs is the color of the source (not multiplied by alpha) 
    <li>αb is the coverage of the destination Fb is defined by the operator and controls inclusion of the destination Cb is the color of the destination (not multiplied by alpha) 
   </ul>
   <h4 class="heading settled" data-level="9.1.1" id="porterduffcompositingoperators_clear"><span class="secno">9.1.1. </span><span class="content">Clear</span><a class="self-link" href="#porterduffcompositingoperators_clear"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="clear">clear</dfn> compositing operator, no regions are enabled.</p>
   <div class="figure">
     <img alt="example of porter duff clear" src="examples/PD_clr.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 0; Fb = 0
co = 0
αo = 0
</pre>
   <h4 class="heading settled" data-level="9.1.2" id="porterduffcompositingoperators_src"><span class="secno">9.1.2. </span><span class="content">Copy</span><a class="self-link" href="#porterduffcompositingoperators_src"></a></h4>
    With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="copy">copy</dfn> compositing operator, only the source will be present. 
   <div class="figure">
     <img alt="example of porter duff copy" src="examples/PD_src.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1; Fb = 0
co = αs x Cs
αo = αs
</pre>
   <h4 class="heading settled" data-level="9.1.3" id="porterduffcompositingoperators_dst"><span class="secno">9.1.3. </span><span class="content">Destination</span><a class="self-link" href="#porterduffcompositingoperators_dst"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="destination">destination</dfn> compositing operator, only the destination will be present.</p>
   <div class="figure">
     <img alt="example of porter duff destination" src="examples/PD_dst.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 0; Fb = 1
co = αb x Cb
αo = αb
</pre>
   <h4 class="heading settled" data-level="9.1.4" id="porterduffcompositingoperators_srcover"><span class="secno">9.1.4. </span><span class="content">Source Over</span><a class="self-link" href="#porterduffcompositingoperators_srcover"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="source-over">source-over</dfn> compositing operator, the source is placed over the destination.</p>
   <div class="figure">
     <img alt="example of porter duff source over" src="examples/PD_src-over.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1; Fb = 1 – αs
co = αs x Cs + αb x Cb x (1 – αs)
αo = αs + αb x (1 – αs)
</pre>
   <h4 class="heading settled" data-level="9.1.5" id="porterduffcompositingoperators_dstover"><span class="secno">9.1.5. </span><span class="content">Destination Over</span><a class="self-link" href="#porterduffcompositingoperators_dstover"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="destination-over">destination-over</dfn> compositing operator, Destination is placed over the source.</p>
   <div class="figure">
     <img alt="example of porter duff destination over" src="examples/PD_dst-over.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1 – αb; Fb = 1
co = αs x Cs x (1 – αb) + αb x Cb
αo = αs x (1 – αb) + αb
</pre>
   <h4 class="heading settled" data-level="9.1.6" id="porterduffcompositingoperators_srcin"><span class="secno">9.1.6. </span><span class="content">Source In</span><a class="self-link" href="#porterduffcompositingoperators_srcin"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="source-in">source-in</dfn> compositing operator, the parts of the source that overlap with the desitnation are placed.</p>
   <div class="figure">
     <img alt="example of porter duff source in" src="examples/PD_src-in.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = αb; Fb = 0
co = αs x Cs x αb
αo = αs x αb
</pre>
   <h4 class="heading settled" data-level="9.1.7" id="porterduffcompositingoperators_dstin"><span class="secno">9.1.7. </span><span class="content">Destination In</span><a class="self-link" href="#porterduffcompositingoperators_dstin"></a></h4>
    With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="destination-in">destination-in</dfn> compositing operator, the parts of the destination that overlap with the source are placed. 
   <div class="figure">
     <img alt="example of porter duff destination in " src="examples/PD_dst-in.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 0; Fb = αs
co = αb x Cb x αs
αo = αb x αs
</pre>
   <h4 class="heading settled" data-level="9.1.8" id="porterduffcompositingoperators_srcout"><span class="secno">9.1.8. </span><span class="content">Source Out</span><a class="self-link" href="#porterduffcompositingoperators_srcout"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="source-out">source-out</dfn> compositing operator, the parts of the source that fall outside of the destination are placed.</p>
   <div class="figure">
     <img alt="example of porter duff source out" src="examples/PD_src-out.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1 – αb; Fb = 0
co = αs x Cs x (1 – αb)
αo = αs x (1 – αb)
</pre>
   <h4 class="heading settled" data-level="9.1.9" id="porterduffcompositingoperators_dstout"><span class="secno">9.1.9. </span><span class="content">Destination Out</span><a class="self-link" href="#porterduffcompositingoperators_dstout"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="destination-out">destination-out</dfn> compositing operator, the parts of the destination that fall outside of the source are placed.</p>
   <div class="figure">
     <img alt="example of porter duff destination out" src="examples/PD_dst-out.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 0; Fb = 1 – αs
co = αb x Cb x (1 – αs)
αo = αb x (1 – αs)
</pre>
   <h4 class="heading settled" data-level="9.1.10" id="porterduffcompositingoperators_srcatop"><span class="secno">9.1.10. </span><span class="content">Source Atop</span><a class="self-link" href="#porterduffcompositingoperators_srcatop"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="source-atop">source-atop</dfn> compositing operator, the parts of the source which overlap the destination replace the destination. The destination is placed everywhere else.</p>
   <div class="figure">
     <img alt="example of porter duff source atop" src="examples/PD_src-atop.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = αb; Fb = 1 – αs
co = αs x Cs x αb + αb x Cb x (1 – αs)
αo = αs x αb + αb x (1 – αs)
</pre>
   <h4 class="heading settled" data-level="9.1.11" id="porterduffcompositingoperators_dstatop"><span class="secno">9.1.11. </span><span class="content">Destination Atop</span><a class="self-link" href="#porterduffcompositingoperators_dstatop"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="destination-atop">destination-atop</dfn> compositing operator, the parts of the destination which overlaps the source replace the source. The source is placed everywhere else.</p>
   <div class="figure">
     <img alt="example of porter duff destination atop" src="examples/PD_dst-atop.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1 - αb; Fb = αs
co = αs x Cs x (1 - αb) + αb x Cb x αs
αo = αs x (1 - αb) + αb x αs
</pre>
   <h4 class="heading settled" data-level="9.1.12" id="porterduffcompositingoperators_xor"><span class="secno">9.1.12. </span><span class="content">XOR</span><a class="self-link" href="#porterduffcompositingoperators_xor"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="xor">xor</dfn> compositing operator, the non-overlapping regions of source and destination are combined.</p>
   <div class="figure">
     <img alt="example of porter duff xor" src="examples/PD_xor.svg"> 
    <p class="caption"></p>
   </div>
<pre>Fa = 1 - αb; Fb = 1 – αs
co = αs x Cs x (1 - αb) + αb x Cb x (1 – αs)
αo = αs x (1 - αb) + αb x (1 – αs)
</pre>
   <h4 class="heading settled" data-level="9.1.13" id="porterduffcompositingoperators_plus"><span class="secno">9.1.13. </span><span class="content">Lighter</span><a class="self-link" href="#porterduffcompositingoperators_plus"></a></h4>
    With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="lighter">lighter</dfn> compositing operator, the sum of the source image and destination image is displayed. It is defined in the Porter Duff paper as the <span class="css">plus</span> operator <a data-link-type="biblio" href="#biblio-porterduff" title="Compositing digital images">[PORTERDUFF]</a>. 
<pre>Fa = 1; Fb = 1
co = αs x Cs + αb x Cb;
αo = αs + αb
</pre>
   <h4 class="heading settled" data-level="9.1.14" id="porterduffcompositingoperators_plus_darker"><span class="secno">9.1.14. </span><span class="content">Plus-darker</span><a class="self-link" href="#porterduffcompositingoperators_plus_darker"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="plus-darker">plus-darker</dfn> compositing operator, the following steps are performed:</p>
<pre>Fa = 1; Fb = 1
co = max(0, 1 - αs x Cs + 1 - αb x Cb);
αo = max(0, 1 - αs + 1 - αb);
</pre>
   <h4 class="heading settled" data-level="9.1.15" id="porterduffcompositingoperators_plus_lighter"><span class="secno">9.1.15. </span><span class="content">Plus-lighter</span><a class="self-link" href="#porterduffcompositingoperators_plus_lighter"></a></h4>
   <p>With the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="plus-lighter">plus-lighter</dfn> compositing operator, the following steps are performed:</p>
<pre>Fa = 1; Fb = 1
co = min(1, αs x Cs + αb x Cb);
αo = min(1, αs + αb);
</pre>
   <h3 class="heading settled" data-level="9.2" id="groupcompositing"><span class="secno">9.2. </span><span class="content">Group compositing behavior with Porter Duff modes</span><a class="self-link" href="#groupcompositing"></a></h3>
   <p>When compositing the elements within an isolated group, the elements are composited over a transparent black initial backdrop. If the bottom element in the group uses a Porter Duff compositing operator which is dependent on the backdrop, such as <a data-link-type="dfn" href="#destination" id="ref-for-destination">destination</a>, <a data-link-type="dfn" href="#source-in" id="ref-for-source-in①">source-in</a>, <a data-link-type="dfn" href="#destination-in" id="ref-for-destination-in①">destination-in</a>, <a data-link-type="dfn" href="#destination-out" id="ref-for-destination-out①">destination-out</a>, or <a data-link-type="dfn" href="#source-atop" id="ref-for-source-atop①">source-atop</a>, then the result of the composite will be empty. Subsequent elements within the group are composited with the result of the first composite.</p>
   <h2 class="heading settled" data-level="10" id="blending"><span class="secno">10. </span><span class="content">Blending</span><a class="self-link" href="#blending"></a></h2>
   <p>Blending is the aspect of compositing that calculates the mixing of colors where the source element and <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop⑧">backdrop</a> overlap.<br> Conceptually, the colors in the source element are blended in place with the backdrop.
After blending, the modified source element is composited with the backdrop.
In practice, this is usually all performed in one step. <br>The blending calculations must not use pre-multiplied color values.</p>
   <p>The "mixing" formula is defined as:</p>
<pre>Cm = B(Cb, Cs)
</pre>
   <p>with:</p>
   <ul>
    <li>Cm: the result color after blending 
    <li>B: the formula that does the blending 
    <li>Cb: the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop⑨">backdrop</a> color 
    <li>Cs: the source color 
   </ul>
   <p>The result of the mixing formula must be clamped to the minimum and maximum values of the color range.</p>
   <p>The result of the mixing function is modulated by the backdrop alpha. A fully opaque backdrop allows the mixing function to be fully realized.
A transparent backdrop will cause the final result to be a weighted average between the source color and mixed color with the weight controlled by the backdrop alpha.
The value of the new color  becomes:</p>
<pre>Cr = (1 - αb) x Cs + αb x B(Cb, Cs)
</pre>
   <p>with:</p>
   <ul>
    <li>Cr: the result color 
    <li>B: the formula that does the blending 
    <li>Cs: the source color 
    <li>Cb: the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①⓪">backdrop</a> color 
    <li>αb: the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①①">backdrop</a> alpha 
   </ul>
   <div class="example" id="example-a731b849">
    <a class="self-link" href="#example-a731b849"></a> 
    <div class="figure">
      <img alt="example of blending with opacity" src="examples/blend_background_opacity.svg"> 
     <p class="caption"></p>
    </div>
    <p> This example has a red rectangle with a blending mode that is placed on top of a set of green rectangles that have different levels of opacity.</p>
    <p> Note how the top rectangle shifts more toward red as the opacity of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①②">backdrop</a> gets smaller. </p>
   </div>
   <p class="note" role="note"> Note: The following formula gives the color value in the area where the source and backdrop intersects and then composites with the specified Porter Duff compositing formula. For simple alpha blending, the formula thus becomes: </p>
<pre>simple alpha compositing:
  co = cs + cb x (1 - αs)
written as non-premultiplied:
  αo x Co = αs x Cs + (1 - αs) x αb x Cb
now substitute the result of blending for Cs:
    αo x Co = αs x ((1 - αb) x Cs + αb x B(Cb, Cs)) + (1 - αs) x αb x Cb
            = αs x (1 - αb) x Cs + αs x αb x B(Cb, Cs) + (1 - αs) x αb x Cb
</pre>
   <p></p>
   <h3 class="heading settled" data-level="10.1" id="blendingseparable"><span class="secno">10.1. </span><span class="content">Separable blend modes</span><a class="self-link" href="#blendingseparable"></a></h3>
   <p>A blend mode is termed separable if each component of the result color is completely determined by the corresponding components of the constituent <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①③">backdrop</a> and source colors — that is, if the mixing formula is applied <strong>separately</strong> to each set of corresponding components.</p>
   <p>Each of the following blend modes will apply the blending function B(Cb, Cs) on each of the color components.
For simplicity, all the examples in this chapter use <a data-link-type="dfn" href="#source-over" id="ref-for-source-over②">source-over</a> compositing.</p>
   <h4 class="heading settled" data-level="10.1.1" id="blendingnormal"><span class="secno">10.1.1. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-normal">normal</dfn> blend mode</span><a class="self-link" href="#blendingnormal"></a></h4>
   <p>This is the default attribute which specifies no blending. The blending formula simply selects the source color.</p>
<pre>B(Cb, Cs) = Cs
</pre>
   <div class="figure">
     <img alt="example of normal blending" src="examples/normal.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.2" id="blendingmultiply"><span class="secno">10.1.2. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-multiply">multiply</dfn> blend mode</span><a class="self-link" href="#blendingmultiply"></a></h4>
   <p>The source color is multiplied by the destination color and replaces the destination.</p>
   <p>The resultant color is always at least as dark as either the source or destination color. Multiplying any color with black results in black. Multiplying any color with white preserves the original color.</p>
<pre>B(Cb, Cs) = Cb x Cs
</pre>
   <p></p>
   <div class="figure">
     <img alt="example of multiply blending" src="examples/multiply.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.3" id="blendingscreen"><span class="secno">10.1.3. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-screen">screen</dfn> blend mode</span><a class="self-link" href="#blendingscreen"></a></h4>
   <p>Multiplies the complements of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①④">backdrop</a> and source color values, then complements the result.</p>
   <p>The result color is always at least as light as either of the two constituent colors. Screening any color with white produces white; screening with black leaves the original color unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.</p>
<pre>B(Cb, Cs) = 1 - [(1 - Cb) x (1 - Cs)]
          = Cb + Cs -(Cb x Cs)
</pre>
   <p></p>
   <div class="figure">
     <img alt="example of screen blending" src="examples/screen.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.4" id="blendingoverlay"><span class="secno">10.1.4. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-overlay">overlay</dfn> blend mode</span><a class="self-link" href="#blendingoverlay"></a></h4>
   <p>Multiplies or screens the colors, depending on the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①⑤">backdrop</a> color value.</p>
   <p>Source colors overlay the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①⑥">backdrop</a> while preserving its highlights and shadows. The <span id="ref-for-backdrop①⑦">backdrop</span> color is not replaced but is mixed with the source color to reflect the lightness or darkness of the <span id="ref-for-backdrop①⑧">backdrop</span>.</p>
<pre>B(Cb, Cs) = HardLight(Cs, Cb)
</pre>
   <p>Overlay is the inverse of the <a class="css" data-link-type="value" href="#valdef-blend-mode-hard-light" id="ref-for-valdef-blend-mode-hard-light①">hard-light</a> blend mode. See the definition of <span id="ref-for-valdef-blend-mode-hard-light②">hard-light</span> for the formula.</p>
   <div class="figure">
     <img alt="example of overlay blending" src="examples/overlay.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.5" id="blendingdarken"><span class="secno">10.1.5. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-darken">darken</dfn> blend mode</span><a class="self-link" href="#blendingdarken"></a></h4>
   <p>Selects the darker of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop①⑨">backdrop</a> and source colors.</p>
   <p>The <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⓪">backdrop</a> is replaced with the source where the source is darker; otherwise, it is left unchanged.</p>
<pre>B(Cb, Cs) = min(Cb, Cs)
</pre>
   <div class="figure">
     <img alt="example of darken blending" src="examples/darken.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.6" id="blendinglighten"><span class="secno">10.1.6. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-lighten">lighten</dfn> blend mode</span><a class="self-link" href="#blendinglighten"></a></h4>
   <p>Selects the lighter of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②①">backdrop</a> and source colors.</p>
   <p>The <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②②">backdrop</a> is replaced with the source where the source is lighter; otherwise, it is left unchanged.</p>
<pre>B(Cb, Cs) = max(Cb, Cs)
</pre>
   <p class="note" role="note"><span class="marker">Note:</span> The result must be rounded down if it exceeds the range.</p>
   <div class="figure">
     <img alt="example of lighten blending" src="examples/lighten.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.7" id="blendingcolordodge"><span class="secno">10.1.7. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-color-dodge">color-dodge</dfn> blend mode</span><a class="self-link" href="#blendingcolordodge"></a></h4>
   <p>Brightens the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②③">backdrop</a> color to reflect the source color. Painting with black produces no changes.</p>
<pre>if(Cb == 0)
    B(Cb, Cs) = 0
else if(Cs == 1)
    B(Cb, Cs) = 1
else
    B(Cb, Cs) = min(1, Cb / (1 - Cs))
</pre>
   <div class="figure">
     <img alt="example of color dodge blending" src="examples/colordodge.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.8" id="blendingcolorburn"><span class="secno">10.1.8. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-color-burn">color-burn</dfn> blend mode</span><a class="self-link" href="#blendingcolorburn"></a></h4>
   <p>Darkens the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②④">backdrop</a> color to reflect the source color. Painting with white produces no change.</p>
<pre>if(Cb == 1)
    B(Cb, Cs) = 1
else if(Cs == 0)
    B(Cb, Cs) = 0
else
    B(Cb, Cs) = 1 - min(1, (1 - Cb) / Cs)
</pre>
   <div class="figure">
     <img alt="example of color burn blending" src="examples/colorburn.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.9" id="blendinghardlight"><span class="secno">10.1.9. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-hard-light">hard-light</dfn> blend mode</span><a class="self-link" href="#blendinghardlight"></a></h4>
   <p>Multiplies or screens the colors, depending on the source color value. The effect is similar to shining a harsh spotlight on the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⑤">backdrop</a>.</p>
<pre>if(Cs &lt;= 0.5)
    B(Cb, Cs) = Multiply(Cb, 2 x Cs)
else
    B(Cb, Cs) = Screen(Cb, 2 x Cs -1)
</pre>
   <p>See the definition of <a class="css" data-link-type="value" href="#valdef-blend-mode-multiply" id="ref-for-valdef-blend-mode-multiply①">multiply</a> and <a class="css" data-link-type="value" href="#valdef-blend-mode-screen" id="ref-for-valdef-blend-mode-screen①">screen</a> for their formulas.</p>
   <div class="figure">
     <img alt="example of hard light blending" src="examples/hardlight.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.10" id="blendingsoftlight"><span class="secno">10.1.10. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-soft-light">soft-light</dfn> blend mode</span><a class="self-link" href="#blendingsoftlight"></a></h4>
   <p>Darkens or lightens the colors, depending on the source color value. The effect is similar to shining a diffused spotlight on the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⑥">backdrop</a>.</p>
<pre>    if(Cs &lt;= 0.5)
        B(Cb, Cs) = Cb - (1 - 2 x Cs) x Cb x (1 - Cb)
    else
        B(Cb, Cs) = Cb + (2 x Cs - 1) x (D(Cb) - Cb)
with
    if(Cb &lt;= 0.25)
        D(Cb) = ((16 * Cb - 12) x Cb + 4) x Cb
    else
        D(Cb) = sqrt(Cb)
</pre>
   <div class="figure">
     <img alt="example of soft light blending" src="examples/softlight.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.11" id="blendingdifference"><span class="secno">10.1.11. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-difference">difference</dfn> blend mode</span><a class="self-link" href="#blendingdifference"></a></h4>
   <p>Subtracts the darker of the two constituent colors from the lighter color.</p>
   <p>Painting with white inverts the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⑦">backdrop</a> color; painting with black produces no change.</p>
<pre>B(Cb, Cs) = | Cb - Cs |
</pre>
   <p></p>
   <div class="figure">
     <img alt="example of difference blending" src="examples/difference.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.1.12" id="blendingexclusion"><span class="secno">10.1.12. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-exclusion">exclusion</dfn> blend mode</span><a class="self-link" href="#blendingexclusion"></a></h4>
   <p>Produces an effect similar to that of the Difference mode but lower in contrast. Painting with white inverts the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⑧">backdrop</a> color; painting with black produces no change</p>
<pre>B(Cb, Cs) = Cb + Cs - 2 x Cb x Cs
</pre>
   <p></p>
   <div class="figure">
     <img alt="example of exclusion blending" src="examples/exclusion.png"> 
    <p class="caption"></p>
   </div>
   <h3 class="heading settled" data-level="10.2" id="blendingnonseparable"><span class="secno">10.2. </span><span class="content">Non-separable blend modes</span><a class="self-link" href="#blendingnonseparable"></a></h3>
   <p>Nonseparable blend modes consider all color components in combination as opposed to the separable ones that look at each component individually.
All of these blend modes conceptually entail the following steps:</p>
   <ol>
    <li>Convert the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop②⑨">backdrop</a> and source colors from the blending color space to an intermediate hue-saturation-luminosity representation.
    <li>Create a new color from some combination of hue, saturation, and luminosity components selected from the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③⓪">backdrop</a> and source colors.
    <li>Convert the result back to the original color space.
   </ol>
   <p>The nonseparable blend mode formulas make use of several auxiliary functions:</p>
<pre>    Lum(C) = 0.3 x Cred + 0.59 x Cgreen + 0.11 x Cblue

    ClipColor(C)
        L = Lum(C)
        n = min(Cred, Cgreen, Cblue)
        x = max(Cred, Cgreen, Cblue)
        if(n &lt; 0)
            C = L + (((C - L) * L) / (L - n))

        if(x > 1)
            C = L + (((C - L) * (1 - L)) / (x - L))

        return C

    SetLum(C, l)
        d = l - Lum(C)
        Cred = Cred + d
        Cgreen = Cgreen + d
        Cblue = Cblue + d
        return ClipColor(C)

    Sat(C) = max(Cred, Cgreen, Cblue) - min(Cred, Cgreen, Cblue)

The subscripts min, mid, and max in the next function refer to the color
components having the minimum, middle, and maximum values upon entry to the function.

    SetSat(C, s)
        if(Cmax > Cmin)
            Cmid = (((Cmid - Cmin) x s) / (Cmax - Cmin))
            Cmax = s
        else
            Cmid = Cmax = 0
        Cmin = 0
        return C;
</pre>
   <h4 class="heading settled" data-level="10.2.1" id="blendinghue"><span class="secno">10.2.1. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-hue">hue</dfn> blend mode</span><a class="self-link" href="#blendinghue"></a></h4>
   <p>Creates a color with the hue of the source color and the saturation and luminosity of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③①">backdrop</a> color.</p>
<pre>B(Cb, Cs) = SetLum(SetSat(Cs, Sat(Cb)), Lum(Cb))
</pre>
   <div class="figure">
     <img alt="example of hue blending" src="examples/hue.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.2.2" id="blendingsaturation"><span class="secno">10.2.2. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-saturation">saturation</dfn> blend mode</span><a class="self-link" href="#blendingsaturation"></a></h4>
   <p>Creates a color with the saturation of the source color and the hue and luminosity of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③②">backdrop</a> color. Painting with this mode in an area of the <span id="ref-for-backdrop③③">backdrop</span> that is a pure gray (no saturation) produces no change.</p>
<pre>B(Cb, Cs) = SetLum(SetSat(Cb, Sat(Cs)), Lum(Cb))
</pre>
   <div class="figure">
     <img alt="example of saturation blending" src="examples/saturation.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.2.3" id="blendingcolor"><span class="secno">10.2.3. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-color">color</dfn> blend mode</span><a class="self-link" href="#blendingcolor"></a></h4>
   <p>Creates a color with the hue and saturation of the source color and the luminosity of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③④">backdrop</a> color. This preserves the gray levels of the <span id="ref-for-backdrop③⑤">backdrop</span> and is useful for coloring monochrome images or tinting color images.</p>
<pre>B(Cb, Cs) = SetLum(Cs, Lum(Cb))
</pre>
   <div class="figure">
     <img alt="example of color blending" src="examples/color.png"> 
    <p class="caption"></p>
   </div>
   <h4 class="heading settled" data-level="10.2.4" id="blendingluminosity"><span class="secno">10.2.4. </span><span class="content"><dfn class="dfn-paneled css" data-dfn-for="<blend-mode>" data-dfn-type="value" data-export id="valdef-blend-mode-luminosity">luminosity</dfn> blend mode</span><a class="self-link" href="#blendingluminosity"></a></h4>
   <p>Creates a color with the luminosity of the source color and the hue and saturation of the <a data-link-type="dfn" href="#backdrop" id="ref-for-backdrop③⑥">backdrop</a> color. This produces an inverse effect to that of the Color mode.</p>
<pre>B(Cb, Cs) = SetLum(Cb, Lum(Cs))
</pre>
   <div class="figure">
     <img alt="example of luminosity blending" src="examples/luminosity.png"> 
    <p class="caption"></p>
   </div>
   <h3 class="heading settled" data-level="10.3" id="isolationblending"><span class="secno">10.3. </span><span class="content">Effect of group isolation on blending</span><a class="self-link" href="#isolationblending"></a></h3>
   <p class="note" role="note"><span class="marker">Note:</span> In the following example, the elements used to construct the paper airplane are within a group. Each of these elements has their blend mode set to multiply.</p>
   <div class="example" id="example-63d91a15">
    <a class="self-link" href="#example-63d91a15"></a> The airplane on the left is a normal group, the airplane on the right is an <a href="#isolatedgroups">isolated group</a>.
    <p></p>
    <p> In the isolated group, the elements within the group are composited onto an empty initial backdrop, this stops the elements within the group multiplying with the backdrop.
In the normal group, the elements within the group are composited onto the initial backdrop containing the land and sky. Therefore the elements of the airplane multiply with the land and sky.
In both instances, the result of the group composite is composited onto the land and sky using the normal mix-blend-mode (the default mix-blend-mode applied to the group). </p>
    <div class="figure">
      <img alt="example of isolated group blending" src="examples/isolate_blend_example.png"> 
     <p class="caption"></p>
    </div>
   </div>
   <h2 class="heading settled" data-level="11" id="security"><span class="secno">11. </span><span class="content">Security issues with compositing and blending</span><a class="self-link" href="#security"></a></h2>
   <p>It is important that the timing to the blending and compositing operations is independent of the source and destination pixel. Operations must be implemented in such a way that they always take the same amount of time regardless of the pixel values.</p>
   <p></p>
   <div class="note" role="note">
    <p> If this rule is not followed, an attacker could infer information and mount a timing attack. </p>
    <p>A timing attack is a method of obtaining information about content that
   is otherwise protected, based on studying the amount of time it takes for
   an operation to occur. If, for example, red pixels took longer to
   draw than green pixels, one might be able to reconstruct a rough image of
   the element being rendered, without ever having access to the content
   of the element.</p>
   </div>
   <h2 class="heading settled" data-level="12" id="changes"><span class="secno">12. </span><span class="content">Changes</span><a class="self-link" href="#changes"></a></h2>
   <p>The following changes were made relative to the <a href="https://www.w3.org/TR/2014/CR-compositing-1-20140220/"> Candidate Recommendation of 20 February 2014</a>:</p>
   <ul>
    <li>force isolation of SVG images embedded as &lt;img> no longer at risk
    <li>removed destination as an option for <a class="production css" data-link-type="type" href="#compositemode" id="ref-for-compositemode②">&lt;composite-mode></a>
   </ul>
   <p>The following changes were made relative to the <a href="https://www.w3.org/TR/2013/WD-compositing-1-20131010/"> Last Call
Working draft of 7 January 2014</a>:</p>
   <ul>
    <li>unneeded normative and informative references were removed
   </ul>
   <p>The following changes were made relative to the <a href="https://www.w3.org/TR/2013/WD-compositing-1-20131010/"> Last Call
Working draft of 10 October 2013</a>:</p>
   <ul>
    <li>knockout was removed from the non-normative section
    <li>removed paragraph on SVG from simple alpha compositing
    <li>updated abstract to include CSS and clarify intent
    <li>removed clip-to-self and its references
    <li>Changed section 5-10 to be normative + clarified notes/examples in those sections
   </ul>
   <p>The following changes were made relative to the <a href="https://www.w3.org/TR/2013/WD-compositing-1-20130625/">Working
Draft of 2013-06-25</a>:</p>
   <ul>
    <li>clipping was removed as one of the operators that
 creates an isolated group in SVG 
    <li>background-blend-mode was changed so it matches
 repeating behavior of other background syntaxes. 
    <li>The mix-composite property was removed 
    <li>all open issues were resolved 
   </ul>
  </main>
  <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content"> Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
  <h3 class="no-ref heading settled" id="w3c-conventions"><span class="content"> Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
  <p>Conformance requirements are expressed with a combination of
    descriptive assertions and RFC 2119 terminology. The key words “MUST”,
    “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
    “RECOMMENDED”, “MAY”, and “OPTIONAL” in the normative parts of this
    document are to be interpreted as described in RFC 2119.
    However, for readability, these words do not appear in all uppercase
    letters in this specification. </p>
  <p>All of the text of this specification is normative except sections
    explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a></p>
  <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text with <code>class="example"</code>,
    like this: </p>
  <div class="example" id="example-ae2b6bc0">
   <a class="self-link" href="#example-ae2b6bc0"></a> 
   <p>This is an example of an informative example.</p>
  </div>
  <p>Informative notes begin with the word “Note” and are set apart from the
    normative text with <code>class="note"</code>, like this: </p>
  <p class="note" role="note">Note, this is an informative note.</p>
  <p>Advisements are normative sections styled to evoke special attention and are
    set apart from other normative text with <code>&lt;strong class="advisement"></code>, like
    this: <strong class="advisement"> UAs MUST provide an accessible alternative. </strong></p>
  <h3 class="no-ref heading settled" id="w3c-conformance-classes"><span class="content"> Conformance classes</span><a class="self-link" href="#w3c-conformance-classes"></a></h3>
  <p>Conformance to this specification
    is defined for three conformance classes: </p>
  <dl>
   <dt>style sheet 
   <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#style-sheet">CSS
            style sheet</a>. 
   <dt>renderer 
   <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#user-agent">UA</a> that interprets the semantics of a style sheet and renders
            documents that use them. 
   <dt>authoring tool 
   <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#user-agent">UA</a> that writes a style sheet. 
  </dl>
  <p>A style sheet is conformant to this specification
    if all of its statements that use syntax defined in this module are valid
    according to the generic CSS grammar and the individual grammars of each
    feature defined in this module. </p>
  <p>A renderer is conformant to this specification
    if, in addition to interpreting the style sheet as defined by the
    appropriate specifications, it supports all the features defined
    by this specification by parsing them correctly
    and rendering the document accordingly. However, the inability of a
    UA to correctly render a document due to limitations of the device
    does not make the UA non-conformant. (For example, a UA is not
    required to render color on a monochrome monitor.) </p>
  <p>An authoring tool is conformant to this specification
    if it writes style sheets that are syntactically correct according to the
    generic CSS grammar and the individual grammars of each feature in
    this module, and meet all other conformance requirements of style sheets
    as described in this module. </p>
  <h3 class="no-ref heading settled" id="w3c-partial"><span class="content"> Partial implementations</span><a class="self-link" href="#w3c-partial"></a></h3>
  <p>So that authors can exploit the forward-compatible parsing rules to
    assign fallback values, CSS renderers <strong>must</strong> treat as invalid (and <a href="http://www.w3.org/TR/CSS21/conform.html#ignore">ignore
    as appropriate</a>) any at-rules, properties, property values, keywords,
    and other syntactic constructs for which they have no usable level of
    support. In particular, user agents <strong>must not</strong> selectively
    ignore unsupported component values and honor supported values in a single
    multi-value property declaration: if any value is considered invalid
    (as unsupported values must be), CSS requires that the entire declaration
    be ignored.</p>
  <h4 class="heading settled" id="w3c-conform-future-proofing"><span class="content"> Implementations of Unstable and Proprietary Features</span><a class="self-link" href="#w3c-conform-future-proofing"></a></h4>
  <p>To avoid clashes with future stable CSS features,
        the CSSWG recommends <a href="http://www.w3.org/TR/CSS/#future-proofing">following best practices</a> for the implementation of <a href="http://www.w3.org/TR/CSS/#unstable">unstable</a> features and <a href="http://www.w3.org/TR/CSS/#proprietary-extension">proprietary extensions</a> to CSS. </p>
  <h3 class="no-ref heading settled" id="w3c-testing"><span class="content"> Non-experimental implementations</span><a class="self-link" href="#w3c-testing"></a></h3>
  <p>Once a specification reaches the Candidate Recommendation stage,
    non-experimental implementations are possible, and implementors should
    release an unprefixed implementation of any CR-level feature they
    can demonstrate to be correctly implemented according to spec. </p>
  <p>To establish and maintain the interoperability of CSS across
    implementations, the CSS Working Group requests that non-experimental
    CSS renderers submit an implementation report (and, if necessary, the
    testcases used for that implementation report) to the W3C before
    releasing an unprefixed implementation of any CSS features. Testcases
    submitted to W3C are subject to review and correction by the CSS
    Working Group. </p>
  <p>Further information on submitting testcases and implementation reports
    can be found from on the CSS Working Group’s website at <a href="http://www.w3.org/Style/CSS/Test/">http://www.w3.org/Style/CSS/Test/</a>.
    Questions should be directed to the <a href="http://lists.w3.org/Archives/Public/public-css-testsuite">public-css-testsuite@w3.org</a> mailing list.</p>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#backdrop">backdrop</a><span>, in § 7</span>
   <li><a href="#propdef-background-blend-mode">background-blend-mode</a><span>, in § 3.4.3</span>
   <li><a href="#ltblendmodegt">&lt;blend-mode></a><span>, in § 3.4.1</span>
   <li><a href="#clear">clear</a><span>, in § 9.1.1</span>
   <li><a href="#valdef-blend-mode-color">color</a><span>, in § 10.2.3</span>
   <li><a href="#valdef-blend-mode-color-burn">color-burn</a><span>, in § 10.1.8</span>
   <li><a href="#valdef-blend-mode-color-dodge">color-dodge</a><span>, in § 10.1.7</span>
   <li><a href="#compositemode">&lt;composite-mode></a><span>, in § 4</span>
   <li><a href="#copy">copy</a><span>, in § 9.1.2</span>
   <li><a href="#valdef-blend-mode-darken">darken</a><span>, in § 10.1.5</span>
   <li><a href="#destination">destination</a><span>, in § 9.1.3</span>
   <li><a href="#destination-atop">destination-atop</a><span>, in § 9.1.11</span>
   <li><a href="#destination-in">destination-in</a><span>, in § 9.1.7</span>
   <li><a href="#destination-out">destination-out</a><span>, in § 9.1.9</span>
   <li><a href="#destination-over">destination-over</a><span>, in § 9.1.5</span>
   <li><a href="#valdef-blend-mode-difference">difference</a><span>, in § 10.1.11</span>
   <li><a href="#valdef-blend-mode-exclusion">exclusion</a><span>, in § 10.1.12</span>
   <li><a href="#valdef-blend-mode-hard-light">hard-light</a><span>, in § 10.1.9</span>
   <li><a href="#valdef-blend-mode-hue">hue</a><span>, in § 10.2.1</span>
   <li><a href="#propdef-isolation">isolation</a><span>, in § 3.4.2</span>
   <li><a href="#isolated-propid">&lt;isolation-mode></a><span>, in § 3.4.2</span>
   <li><a href="#valdef-blend-mode-lighten">lighten</a><span>, in § 10.1.6</span>
   <li><a href="#lighter">lighter</a><span>, in § 9.1.13</span>
   <li><a href="#valdef-blend-mode-luminosity">luminosity</a><span>, in § 10.2.4</span>
   <li><a href="#propdef-mix-blend-mode">mix-blend-mode</a><span>, in § 3.4.1</span>
   <li><a href="#valdef-blend-mode-multiply">multiply</a><span>, in § 10.1.2</span>
   <li><a href="#valdef-blend-mode-normal">normal</a><span>, in § 10.1.1</span>
   <li><a href="#valdef-blend-mode-overlay">overlay</a><span>, in § 10.1.4</span>
   <li><a href="#plus-darker">plus-darker</a><span>, in § 9.1.14</span>
   <li><a href="#plus-lighter">plus-lighter</a><span>, in § 9.1.15</span>
   <li><a href="#valdef-blend-mode-saturation">saturation</a><span>, in § 10.2.2</span>
   <li><a href="#valdef-blend-mode-screen">screen</a><span>, in § 10.1.3</span>
   <li><a href="#valdef-blend-mode-soft-light">soft-light</a><span>, in § 10.1.10</span>
   <li><a href="#source-atop">source-atop</a><span>, in § 9.1.10</span>
   <li><a href="#source-in">source-in</a><span>, in § 9.1.6</span>
   <li><a href="#source-out">source-out</a><span>, in § 9.1.8</span>
   <li><a href="#source-over">source-over</a><span>, in § 9.1.4</span>
   <li><a href="#xor">xor</a><span>, in § 9.1.12</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSS-CASCADE-3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="e77b61ad">inherit</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-COLOR-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="91bfbe18">opacity</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-VALUES-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="68487d22">#</span>
     <li><span class="dfn-paneled" id="6ec67710">|</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS21]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a50c2771">stacking context</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS3BG]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="f5eca8c9">background</span>
     <li><span class="dfn-paneled" id="f831c141">background-image</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="2f0492ac">body</span>
     <li><span class="dfn-paneled" id="33db4476">globalCompositeOperation</span>
     <li><span class="dfn-paneled" id="f0811ff8">img</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-cascade-3">[CSS-CASCADE-3]
   <dd>Elika Etemad; Tab Atkins Jr.. <a href="https://drafts.csswg.org/css-cascade-3/"><cite>CSS Cascading and Inheritance Level 3</cite></a>. URL: <a href="https://drafts.csswg.org/css-cascade-3/">https://drafts.csswg.org/css-cascade-3/</a>
   <dt id="biblio-css-values-4">[CSS-VALUES-4]
   <dd>Tab Atkins Jr.; Elika Etemad. <a href="https://drafts.csswg.org/css-values-4/"><cite>CSS Values and Units Module Level 4</cite></a>. URL: <a href="https://drafts.csswg.org/css-values-4/">https://drafts.csswg.org/css-values-4/</a>
   <dt id="biblio-css21">[CSS21]
   <dd>Bert Bos; et al. <a href="https://drafts.csswg.org/css2/"><cite>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</cite></a>. URL: <a href="https://drafts.csswg.org/css2/">https://drafts.csswg.org/css2/</a>
   <dt id="biblio-css3bg">[CSS3BG]
   <dd>Elika Etemad; Brad Kemper. <a href="https://drafts.csswg.org/css-backgrounds/"><cite>CSS Backgrounds and Borders Module Level 3</cite></a>. URL: <a href="https://drafts.csswg.org/css-backgrounds/">https://drafts.csswg.org/css-backgrounds/</a>
   <dt id="biblio-css3color">[CSS3COLOR]
   <dd>Tantek Çelik; Chris Lilley; David Baron. <a href="https://drafts.csswg.org/css-color-3/"><cite>CSS Color Module Level 3</cite></a>. URL: <a href="https://drafts.csswg.org/css-color-3/">https://drafts.csswg.org/css-color-3/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-svg11">[SVG11]
   <dd>Erik Dahlström; et al. <a href="https://www.w3.org/TR/SVG11/"><cite>Scalable Vector Graphics (SVG) 1.1 (Second Edition)</cite></a>. 16 August 2011. REC. URL: <a href="https://www.w3.org/TR/SVG11/">https://www.w3.org/TR/SVG11/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-css-color-4">[CSS-COLOR-4]
   <dd>Chris Lilley; Tab Atkins Jr.; Lea Verou. <a href="https://drafts.csswg.org/css-color-4/"><cite>CSS Color Module Level 4</cite></a>. URL: <a href="https://drafts.csswg.org/css-color-4/">https://drafts.csswg.org/css-color-4/</a>
   <dt id="biblio-porterduff">[PORTERDUFF]
   <dd>Thomas Porter; Tom Duff. <cite>Compositing digital images</cite>. July 1984. 
  </dl>
  <h2 class="no-num no-ref heading settled" id="property-index"><span class="content">Property Index</span><a class="self-link" href="#property-index"></a></h2>
  <div class="big-element-wrapper">
   <table class="index">
    <thead>
     <tr>
      <th scope="col">Name
      <th scope="col">Value
      <th scope="col">Initial
      <th scope="col">Applies to
      <th scope="col">Inh.
      <th scope="col">%ages
      <th scope="col">Ani­mat­able
      <th scope="col">Canonical order
      <th scope="col">Com­puted value
      <th scope="col">Media
    <tbody>
     <tr>
      <th scope="row"><a class="css" data-link-type="property" href="#propdef-background-blend-mode" id="ref-for-propdef-background-blend-mode⑤">background-blend-mode</a>
      <td>&lt;blend-mode>#
      <td>normal
      <td>All HTML elements
      <td>no
      <td>N/A
      <td>no
      <td>per grammar
      <td>as specified
      <td>visual
     <tr>
      <th scope="row"><a class="css" data-link-type="property" href="#propdef-isolation" id="ref-for-propdef-isolation②">isolation</a>
      <td>&lt;isolation-mode>
      <td>auto
      <td>All elements. In SVG, it applies to container elements, graphics elements and graphics referencing elements. [SVG11]
      <td>no
      <td>N/A
      <td>no
      <td>per grammar
      <td>as specified
      <td>visual
     <tr>
      <th scope="row"><a class="css" data-link-type="property" href="#propdef-mix-blend-mode" id="ref-for-propdef-mix-blend-mode①">mix-blend-mode</a>
      <td>&lt;blend-mode>
      <td>normal
      <td>All elements. In SVG, it applies to container elements, graphics elements and graphics referencing elements. [SVG11]
      <td>no
      <td>N/A
      <td>no
      <td>per grammar
      <td>as specified
      <td>visual
   </table>
  </div>
  <details class="mdn-anno unpositioned" data-anno-for="background-blend-mode">
   <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background-blend-mode" title="The background-blend-mode CSS property sets how an element&apos;s background images should blend with each other and with the element&apos;s background color.">background-blend-mode</a></p>
    <p class="all-engines-text">In all current engines.</p>
    <div class="support">
     <span class="firefox yes"><span>Firefox</span><span>30+</span></span><span class="safari yes"><span>Safari</span><span>8+</span></span><span class="chrome yes"><span>Chrome</span><span>35+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>79+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="isolation">
   <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/isolation" title="The isolation CSS property determines whether an element must create a new stacking context.">isolation</a></p>
    <p class="all-engines-text">In all current engines.</p>
    <div class="support">
     <span class="firefox yes"><span>Firefox</span><span>36+</span></span><span class="safari yes"><span>Safari</span><span>8+</span></span><span class="chrome yes"><span>Chrome</span><span>41+</span></span>
     <hr>
     <span class="opera yes"><span>Opera</span><span>30+</span></span><span class="edge_blink yes"><span>Edge</span><span>79+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android yes"><span>Opera Mobile</span><span>30+</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="mix-blend-mode">
   <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/mix-blend-mode" title="The mix-blend-mode CSS property sets how an element&apos;s content should blend with the content of the element&apos;s parent and the element&apos;s background.">mix-blend-mode</a></p>
    <p class="all-engines-text">In all current engines.</p>
    <div class="support">
     <span class="firefox yes"><span>Firefox</span><span>32+</span></span><span class="safari yes"><span>Safari</span><span>8+</span></span><span class="chrome yes"><span>Chrome</span><span>41+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>79+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
    </div>
   </div>
  </details>
  <details class="mdn-anno unpositioned" data-anno-for="ltblendmodegt">
   <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span></summary>
   <div class="feature">
    <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/blend-mode" title="The <blend-mode> CSS data type describes how colors should appear when elements overlap. It is used in the background-blend-mode and mix-blend-mode properties.">blend-mode</a></p>
    <p class="all-engines-text">In all current engines.</p>
    <div class="support">
     <span class="firefox yes"><span>Firefox</span><span>30+</span></span><span class="safari yes"><span>Safari</span><span>8+</span></span><span class="chrome yes"><span>Chrome</span><span>35+</span></span>
     <hr>
     <span class="opera no"><span>Opera</span><span>?</span></span><span class="edge_blink yes"><span>Edge</span><span>79+</span></span>
     <hr>
     <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span class="ie no"><span>IE</span><span>None</span></span>
     <hr>
     <span class="firefox_android yes"><span>Firefox for Android</span><span>54+</span></span><span class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span class="chrome_android yes"><span>Chrome for Android</span><span>59+</span></span><span class="webview_android no"><span>Android WebView</span><span>?</span></span><span class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span class="opera_android yes"><span>Opera Mobile</span><span>22+</span></span>
    </div>
   </div>
  </details>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"2f0492ac": {"dfnID":"2f0492ac","dfnText":"body","external":true,"refSections":[{"refs":[{"id":"ref-for-the-body-element"}],"title":"3.4.3. The background-blend-mode property"}],"url":"https://html.spec.whatwg.org/multipage/sections.html#the-body-element"},
"33db4476": {"dfnID":"33db4476","dfnText":"globalCompositeOperation","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-context-2d-globalcompositeoperation"}],"title":"Unnumbered Section"},{"refs":[{"id":"ref-for-dom-context-2d-globalcompositeoperation\u2460"}],"title":"2.1. Module interactions"},{"refs":[{"id":"ref-for-dom-context-2d-globalcompositeoperation\u2461"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation"},
"68487d22": {"dfnID":"68487d22","dfnText":"#","external":true,"refSections":[{"refs":[{"id":"ref-for-mult-comma"}],"title":"3.4.3. The background-blend-mode property"}],"url":"https://drafts.csswg.org/css-values-4/#mult-comma"},
"6ec67710": {"dfnID":"6ec67710","dfnText":"|","external":true,"refSections":[{"refs":[{"id":"ref-for-comb-one"},{"id":"ref-for-comb-one\u2460"},{"id":"ref-for-comb-one\u2461"},{"id":"ref-for-comb-one\u2462"},{"id":"ref-for-comb-one\u2463"},{"id":"ref-for-comb-one\u2464"},{"id":"ref-for-comb-one\u2465"},{"id":"ref-for-comb-one\u2466"},{"id":"ref-for-comb-one\u2467"},{"id":"ref-for-comb-one\u2468"},{"id":"ref-for-comb-one\u2460\u24ea"},{"id":"ref-for-comb-one\u2460\u2460"},{"id":"ref-for-comb-one\u2460\u2461"},{"id":"ref-for-comb-one\u2460\u2462"},{"id":"ref-for-comb-one\u2460\u2463"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-comb-one\u2460\u2464"}],"title":"3.4.2. The isolation property"},{"refs":[{"id":"ref-for-comb-one\u2460\u2465"},{"id":"ref-for-comb-one\u2460\u2466"},{"id":"ref-for-comb-one\u2460\u2467"},{"id":"ref-for-comb-one\u2460\u2468"},{"id":"ref-for-comb-one\u2461\u24ea"},{"id":"ref-for-comb-one\u2461\u2460"},{"id":"ref-for-comb-one\u2461\u2461"},{"id":"ref-for-comb-one\u2461\u2462"},{"id":"ref-for-comb-one\u2461\u2463"},{"id":"ref-for-comb-one\u2461\u2464"},{"id":"ref-for-comb-one\u2461\u2465"},{"id":"ref-for-comb-one\u2461\u2466"},{"id":"ref-for-comb-one\u2461\u2467"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"https://drafts.csswg.org/css-values-4/#comb-one"},
"91bfbe18": {"dfnID":"91bfbe18","dfnText":"opacity","external":true,"refSections":[{"refs":[{"id":"ref-for-propdef-opacity"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"https://drafts.csswg.org/css-color-4/#propdef-opacity"},
"a50c2771": {"dfnID":"a50c2771","dfnText":"stacking context","external":true,"refSections":[{"refs":[{"id":"ref-for-x43"}],"title":"2.1. Module interactions"},{"refs":[{"id":"ref-for-x43\u2460"},{"id":"ref-for-x43\u2461"}],"title":"3.2. Behavior specific to HTML"},{"refs":[{"id":"ref-for-x43\u2462"},{"id":"ref-for-x43\u2463"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-x43\u2464"}],"title":"3.4.2. The isolation property"}],"url":"https://www.w3.org/TR/CSS21/visuren.html#x43"},
"backdrop": {"dfnID":"backdrop","dfnText":"backdrop","external":false,"refSections":[{"refs":[{"id":"ref-for-backdrop\u2460"},{"id":"ref-for-backdrop\u2461"}],"title":"5. Introduction to compositing"},{"refs":[{"id":"ref-for-backdrop\u2462"},{"id":"ref-for-backdrop\u2463"},{"id":"ref-for-backdrop\u2464"}],"title":"5.1. Simple alpha compositing"},{"refs":[{"id":"ref-for-backdrop\u2465"},{"id":"ref-for-backdrop\u2466"}],"title":"5.1.1. Examples of simple alpha compositing"},{"refs":[{"id":"ref-for-backdrop\u2467"},{"id":"ref-for-backdrop\u2468"},{"id":"ref-for-backdrop\u2460\u24ea"},{"id":"ref-for-backdrop\u2460\u2460"},{"id":"ref-for-backdrop\u2460\u2461"}],"title":"10. Blending"},{"refs":[{"id":"ref-for-backdrop\u2460\u2462"}],"title":"10.1. Separable blend modes"},{"refs":[{"id":"ref-for-backdrop\u2460\u2463"}],"title":"10.1.3. screen blend mode"},{"refs":[{"id":"ref-for-backdrop\u2460\u2464"},{"id":"ref-for-backdrop\u2460\u2465"},{"id":"ref-for-backdrop\u2460\u2466"},{"id":"ref-for-backdrop\u2460\u2467"}],"title":"10.1.4. overlay blend mode"},{"refs":[{"id":"ref-for-backdrop\u2460\u2468"},{"id":"ref-for-backdrop\u2461\u24ea"}],"title":"10.1.5. darken blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2460"},{"id":"ref-for-backdrop\u2461\u2461"}],"title":"10.1.6. lighten blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2462"}],"title":"10.1.7. color-dodge blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2463"}],"title":"10.1.8. color-burn blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2464"}],"title":"10.1.9. hard-light blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2465"}],"title":"10.1.10. soft-light blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2466"}],"title":"10.1.11. difference blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2467"}],"title":"10.1.12. exclusion blend mode"},{"refs":[{"id":"ref-for-backdrop\u2461\u2468"},{"id":"ref-for-backdrop\u2462\u24ea"}],"title":"10.2. Non-separable blend modes"},{"refs":[{"id":"ref-for-backdrop\u2462\u2460"}],"title":"10.2.1. hue blend mode"},{"refs":[{"id":"ref-for-backdrop\u2462\u2461"},{"id":"ref-for-backdrop\u2462\u2462"}],"title":"10.2.2. saturation blend mode"},{"refs":[{"id":"ref-for-backdrop\u2462\u2463"},{"id":"ref-for-backdrop\u2462\u2464"}],"title":"10.2.3. color blend mode"},{"refs":[{"id":"ref-for-backdrop\u2462\u2465"}],"title":"10.2.4. luminosity blend mode"}],"url":"#backdrop"},
"clear": {"dfnID":"clear","dfnText":"clear","external":false,"refSections":[{"refs":[{"id":"ref-for-clear"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#clear"},
"compositemode": {"dfnID":"compositemode","dfnText":"<composite-mode>","external":false,"refSections":[{"refs":[{"id":"ref-for-compositemode"},{"id":"ref-for-compositemode\u2460"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-compositemode\u2461"}],"title":"12. Changes"}],"url":"#compositemode"},
"copy": {"dfnID":"copy","dfnText":"copy","external":false,"refSections":[{"refs":[{"id":"ref-for-copy"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#copy"},
"destination": {"dfnID":"destination","dfnText":"destination","external":false,"refSections":[{"refs":[{"id":"ref-for-destination"}],"title":"9.2. Group compositing behavior with Porter Duff modes"}],"url":"#destination"},
"destination-atop": {"dfnID":"destination-atop","dfnText":"destination-atop","external":false,"refSections":[{"refs":[{"id":"ref-for-destination-atop"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#destination-atop"},
"destination-in": {"dfnID":"destination-in","dfnText":"destination-in","external":false,"refSections":[{"refs":[{"id":"ref-for-destination-in"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-destination-in\u2460"}],"title":"9.2. Group compositing behavior with Porter Duff modes"}],"url":"#destination-in"},
"destination-out": {"dfnID":"destination-out","dfnText":"destination-out","external":false,"refSections":[{"refs":[{"id":"ref-for-destination-out"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-destination-out\u2460"}],"title":"9.2. Group compositing behavior with Porter Duff modes"}],"url":"#destination-out"},
"destination-over": {"dfnID":"destination-over","dfnText":"destination-over","external":false,"refSections":[{"refs":[{"id":"ref-for-destination-over"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#destination-over"},
"e77b61ad": {"dfnID":"e77b61ad","dfnText":"inherit","external":true,"refSections":[{"refs":[{"id":"ref-for-css-inheritance"}],"title":"2.2. Values"}],"url":"https://drafts.csswg.org/css-cascade-3/#css-inheritance"},
"f0811ff8": {"dfnID":"f0811ff8","dfnText":"img","external":true,"refSections":[{"refs":[{"id":"ref-for-the-img-element"},{"id":"ref-for-the-img-element\u2460"}],"title":"3.4.2. The isolation property"}],"url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element"},
"f5eca8c9": {"dfnID":"f5eca8c9","dfnText":"background","external":true,"refSections":[{"refs":[{"id":"ref-for-propdef-background"}],"title":"3.4.3. The background-blend-mode property"}],"url":"https://drafts.csswg.org/css-backgrounds-3/#propdef-background"},
"f831c141": {"dfnID":"f831c141","dfnText":"background-image","external":true,"refSections":[{"refs":[{"id":"ref-for-propdef-background-image"}],"title":"3.4.3. The background-blend-mode property"}],"url":"https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image"},
"isolated-propid": {"dfnID":"isolated-propid","dfnText":"<isolation-mode>","external":false,"refSections":[{"refs":[{"id":"ref-for-isolated-propid"},{"id":"ref-for-isolated-propid\u2460"}],"title":"3.4.2. The isolation property"}],"url":"#isolated-propid"},
"lighter": {"dfnID":"lighter","dfnText":"lighter","external":false,"refSections":[{"refs":[{"id":"ref-for-lighter"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#lighter"},
"ltblendmodegt": {"dfnID":"ltblendmodegt","dfnText":"<blend-mode>","external":false,"refSections":[{"refs":[{"id":"ref-for-ltblendmodegt"},{"id":"ref-for-ltblendmodegt\u2460"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-ltblendmodegt\u2461"}],"title":"3.4.3. The background-blend-mode property"},{"refs":[{"id":"ref-for-ltblendmodegt\u2462"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#ltblendmodegt"},
"plus-darker": {"dfnID":"plus-darker","dfnText":"plus-darker","external":false,"refSections":[{"refs":[{"id":"ref-for-plus-darker"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#plus-darker"},
"plus-lighter": {"dfnID":"plus-lighter","dfnText":"plus-lighter","external":false,"refSections":[{"refs":[{"id":"ref-for-plus-lighter"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#plus-lighter"},
"propdef-background-blend-mode": {"dfnID":"propdef-background-blend-mode","dfnText":"background-blend-mode","external":false,"refSections":[{"refs":[{"id":"ref-for-propdef-background-blend-mode"}],"title":"2.1. Module interactions"},{"refs":[{"id":"ref-for-propdef-background-blend-mode\u2460"},{"id":"ref-for-propdef-background-blend-mode\u2461"},{"id":"ref-for-propdef-background-blend-mode\u2462"},{"id":"ref-for-propdef-background-blend-mode\u2463"}],"title":"3.4.3. The background-blend-mode property"}],"url":"#propdef-background-blend-mode"},
"propdef-isolation": {"dfnID":"propdef-isolation","dfnText":"isolation","external":false,"refSections":[{"refs":[{"id":"ref-for-propdef-isolation"},{"id":"ref-for-propdef-isolation\u2460"}],"title":"3.4.2. The isolation property"}],"url":"#propdef-isolation"},
"propdef-mix-blend-mode": {"dfnID":"propdef-mix-blend-mode","dfnText":"mix-blend-mode","external":false,"refSections":[{"refs":[{"id":"ref-for-propdef-mix-blend-mode"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#propdef-mix-blend-mode"},
"source-atop": {"dfnID":"source-atop","dfnText":"source-atop","external":false,"refSections":[{"refs":[{"id":"ref-for-source-atop"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-source-atop\u2460"}],"title":"9.2. Group compositing behavior with Porter Duff modes"}],"url":"#source-atop"},
"source-in": {"dfnID":"source-in","dfnText":"source-in","external":false,"refSections":[{"refs":[{"id":"ref-for-source-in"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-source-in\u2460"}],"title":"9.2. Group compositing behavior with Porter Duff modes"}],"url":"#source-in"},
"source-out": {"dfnID":"source-out","dfnText":"source-out","external":false,"refSections":[{"refs":[{"id":"ref-for-source-out"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#source-out"},
"source-over": {"dfnID":"source-over","dfnText":"source-over","external":false,"refSections":[{"refs":[{"id":"ref-for-source-over"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"},{"refs":[{"id":"ref-for-source-over\u2460"}],"title":"9. Advanced compositing features"},{"refs":[{"id":"ref-for-source-over\u2461"}],"title":"10.1. Separable blend modes"}],"url":"#source-over"},
"valdef-blend-mode-color": {"dfnID":"valdef-blend-mode-color","dfnText":"color","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-color"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-color"},
"valdef-blend-mode-color-burn": {"dfnID":"valdef-blend-mode-color-burn","dfnText":"color-burn","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-color-burn"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-color-burn"},
"valdef-blend-mode-color-dodge": {"dfnID":"valdef-blend-mode-color-dodge","dfnText":"color-dodge","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-color-dodge"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-color-dodge"},
"valdef-blend-mode-darken": {"dfnID":"valdef-blend-mode-darken","dfnText":"darken","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-darken"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-darken"},
"valdef-blend-mode-difference": {"dfnID":"valdef-blend-mode-difference","dfnText":"difference","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-difference"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-difference"},
"valdef-blend-mode-exclusion": {"dfnID":"valdef-blend-mode-exclusion","dfnText":"exclusion","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-exclusion"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-exclusion"},
"valdef-blend-mode-hard-light": {"dfnID":"valdef-blend-mode-hard-light","dfnText":"hard-light","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-hard-light"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-valdef-blend-mode-hard-light\u2460"},{"id":"ref-for-valdef-blend-mode-hard-light\u2461"}],"title":"10.1.4. overlay blend mode"}],"url":"#valdef-blend-mode-hard-light"},
"valdef-blend-mode-hue": {"dfnID":"valdef-blend-mode-hue","dfnText":"hue","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-hue"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-hue"},
"valdef-blend-mode-lighten": {"dfnID":"valdef-blend-mode-lighten","dfnText":"lighten","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-lighten"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-lighten"},
"valdef-blend-mode-luminosity": {"dfnID":"valdef-blend-mode-luminosity","dfnText":"luminosity","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-luminosity"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-luminosity"},
"valdef-blend-mode-multiply": {"dfnID":"valdef-blend-mode-multiply","dfnText":"multiply","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-multiply"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-valdef-blend-mode-multiply\u2460"}],"title":"10.1.9. hard-light blend mode"}],"url":"#valdef-blend-mode-multiply"},
"valdef-blend-mode-normal": {"dfnID":"valdef-blend-mode-normal","dfnText":"normal","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-normal"},{"id":"ref-for-valdef-blend-mode-normal\u2460"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-valdef-blend-mode-normal\u2461"}],"title":"8.1. Group invariance"}],"url":"#valdef-blend-mode-normal"},
"valdef-blend-mode-overlay": {"dfnID":"valdef-blend-mode-overlay","dfnText":"overlay","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-overlay"},{"id":"ref-for-valdef-blend-mode-overlay\u2460"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-overlay"},
"valdef-blend-mode-saturation": {"dfnID":"valdef-blend-mode-saturation","dfnText":"saturation","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-saturation"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-saturation"},
"valdef-blend-mode-screen": {"dfnID":"valdef-blend-mode-screen","dfnText":"screen","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-screen"}],"title":"3.4.1. The mix-blend-mode property"},{"refs":[{"id":"ref-for-valdef-blend-mode-screen\u2460"}],"title":"10.1.9. hard-light blend mode"}],"url":"#valdef-blend-mode-screen"},
"valdef-blend-mode-soft-light": {"dfnID":"valdef-blend-mode-soft-light","dfnText":"soft-light","external":false,"refSections":[{"refs":[{"id":"ref-for-valdef-blend-mode-soft-light"}],"title":"3.4.1. The mix-blend-mode property"}],"url":"#valdef-blend-mode-soft-light"},
"xor": {"dfnID":"xor","dfnText":"xor","external":false,"refSections":[{"refs":[{"id":"ref-for-xor"}],"title":"4. Specifying Compositing and Blending in Canvas 2D"}],"url":"#xor"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-link-titles */
"use strict";
{
let linkTitleData = {
"#ltblendmodegt": "Expands to: color | color-burn | color-dodge | darken | difference | exclusion | hard-light | hue | lighten | luminosity | multiply | normal | overlay | saturation | screen | soft-light",
};

function setTypeTitles() {
	for(let el of document.querySelectorAll("a[href]")) {
		if(el.href in linkTitleData && !el.hasAttribute("title")) {
			el.setAttribute("title", linkTitleData[el.href]);
		}
	}
}

document.addEventListener("DOMContentLoaded", setTypeTitles);
}
</script>
<script>/* Boilerplate: script-position-annos */
"use strict";
{
function repositionAnnoPanels(){
    const panels = [...document.querySelectorAll("[data-anno-for]")];
    hydratePanels(panels);
    let vSoFar = 0;
    for(const panel of panels.sort(cmpTops)) {
        if(panel.top < vSoFar) {
            panel.top = vSoFar;
            panel.style.top = vSoFar + "px";
        }
        vSoFar = panel.top + panel.height + 15;
    }
}
function hydratePanels(panels) {
    const main = document.querySelector("main");
    let mainRect;
    if(main) mainRect = main.getBoundingClientRect();
    // First display them all, if they're not already visible.
    for(const panel of panels) {
        panel.classList.remove("unpositioned");
    }
    // Measure them all
    for(const panel of panels) {
        const dfn = document.getElementById(panel.getAttribute("data-anno-for"));
        if(!dfn) {
            console.log("Can't find the annotation panel target:", panel);
            continue;
        }
        panel.dfn = dfn;
        panel.top = window.scrollY + dfn.getBoundingClientRect().top;
        let panelRect = panel.getBoundingClientRect();
        panel.height = panelRect.height;
        if(main) {
            panel.overlappingMain = panelRect.left < mainRect.right;
        } else {
            panel.overlappingMain = false;
        }
    }
    // And finally position them
    for(const panel of panels) {
        const dfn = panel.dfn;
        if(!dfn) continue;
        panel.style.top = panel.top + "px";
        panel.classList.toggle("overlapping-main", panel.overlappingMain);
    }
}

function cmpTops(a,b) {
    return a.top - b.top;
}

window.addEventListener("load", repositionAnnoPanels);
window.addEventListener("resize", repositionAnnoPanels);
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#backdrop": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"backdrop","type":"dfn","url":"#backdrop"},
"#clear": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"clear","type":"dfn","url":"#clear"},
"#compositemode": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"<composite-mode>","type":"type","url":"#compositemode"},
"#copy": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"copy","type":"dfn","url":"#copy"},
"#destination": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"destination","type":"dfn","url":"#destination"},
"#destination-atop": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"destination-atop","type":"dfn","url":"#destination-atop"},
"#destination-in": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"destination-in","type":"dfn","url":"#destination-in"},
"#destination-out": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"destination-out","type":"dfn","url":"#destination-out"},
"#destination-over": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"destination-over","type":"dfn","url":"#destination-over"},
"#isolated-propid": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"<isolation-mode>","type":"type","url":"#isolated-propid"},
"#lighter": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"lighter","type":"dfn","url":"#lighter"},
"#ltblendmodegt": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"<blend-mode>","type":"type","url":"#ltblendmodegt"},
"#plus-darker": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"plus-darker","type":"dfn","url":"#plus-darker"},
"#plus-lighter": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"plus-lighter","type":"dfn","url":"#plus-lighter"},
"#propdef-background-blend-mode": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"background-blend-mode","type":"property","url":"#propdef-background-blend-mode"},
"#propdef-isolation": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"isolation","type":"property","url":"#propdef-isolation"},
"#propdef-mix-blend-mode": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"mix-blend-mode","type":"property","url":"#propdef-mix-blend-mode"},
"#source-atop": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"source-atop","type":"dfn","url":"#source-atop"},
"#source-in": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"source-in","type":"dfn","url":"#source-in"},
"#source-out": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"source-out","type":"dfn","url":"#source-out"},
"#source-over": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"source-over","type":"dfn","url":"#source-over"},
"#valdef-blend-mode-color": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"color","type":"value","url":"#valdef-blend-mode-color"},
"#valdef-blend-mode-color-burn": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"color-burn","type":"value","url":"#valdef-blend-mode-color-burn"},
"#valdef-blend-mode-color-dodge": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"color-dodge","type":"value","url":"#valdef-blend-mode-color-dodge"},
"#valdef-blend-mode-darken": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"darken","type":"value","url":"#valdef-blend-mode-darken"},
"#valdef-blend-mode-difference": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"difference","type":"value","url":"#valdef-blend-mode-difference"},
"#valdef-blend-mode-exclusion": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"exclusion","type":"value","url":"#valdef-blend-mode-exclusion"},
"#valdef-blend-mode-hard-light": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"hard-light","type":"value","url":"#valdef-blend-mode-hard-light"},
"#valdef-blend-mode-hue": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"hue","type":"value","url":"#valdef-blend-mode-hue"},
"#valdef-blend-mode-lighten": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"lighten","type":"value","url":"#valdef-blend-mode-lighten"},
"#valdef-blend-mode-luminosity": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"luminosity","type":"value","url":"#valdef-blend-mode-luminosity"},
"#valdef-blend-mode-multiply": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"multiply","type":"value","url":"#valdef-blend-mode-multiply"},
"#valdef-blend-mode-normal": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"normal","type":"value","url":"#valdef-blend-mode-normal"},
"#valdef-blend-mode-overlay": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"overlay","type":"value","url":"#valdef-blend-mode-overlay"},
"#valdef-blend-mode-saturation": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"saturation","type":"value","url":"#valdef-blend-mode-saturation"},
"#valdef-blend-mode-screen": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"screen","type":"value","url":"#valdef-blend-mode-screen"},
"#valdef-blend-mode-soft-light": {"export":true,"for_":["<blend-mode>"],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"soft-light","type":"value","url":"#valdef-blend-mode-soft-light"},
"#xor": {"export":true,"for_":[],"level":"2","normative":true,"shortname":"compositing","spec":"compositing-2","status":"local","text":"xor","type":"dfn","url":"#xor"},
"https://drafts.csswg.org/css-backgrounds-3/#propdef-background": {"export":true,"for_":[],"level":"3","normative":true,"shortname":"css-backgrounds","spec":"css-backgrounds-3","status":"current","text":"background","type":"property","url":"https://drafts.csswg.org/css-backgrounds-3/#propdef-background"},
"https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image": {"export":true,"for_":[],"level":"3","normative":true,"shortname":"css-backgrounds","spec":"css-backgrounds-3","status":"current","text":"background-image","type":"property","url":"https://drafts.csswg.org/css-backgrounds-3/#propdef-background-image"},
"https://drafts.csswg.org/css-cascade-3/#css-inheritance": {"export":true,"for_":["CSS"],"level":"3","normative":true,"shortname":"css-cascade","spec":"css-cascade-3","status":"current","text":"inherit","type":"dfn","url":"https://drafts.csswg.org/css-cascade-3/#css-inheritance"},
"https://drafts.csswg.org/css-color-4/#propdef-opacity": {"export":true,"for_":[],"level":"4","normative":true,"shortname":"css-color","spec":"css-color-4","status":"current","text":"opacity","type":"property","url":"https://drafts.csswg.org/css-color-4/#propdef-opacity"},
"https://drafts.csswg.org/css-values-4/#comb-one": {"export":true,"for_":[],"level":"4","normative":true,"shortname":"css-values","spec":"css-values-4","status":"current","text":"|","type":"grammar","url":"https://drafts.csswg.org/css-values-4/#comb-one"},
"https://drafts.csswg.org/css-values-4/#mult-comma": {"export":true,"for_":[],"level":"4","normative":true,"shortname":"css-values","spec":"css-values-4","status":"current","text":"#","type":"grammar","url":"https://drafts.csswg.org/css-values-4/#mult-comma"},
"https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation": {"export":true,"for_":["CanvasCompositing"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"globalCompositeOperation","type":"attribute","url":"https://html.spec.whatwg.org/multipage/canvas.html#dom-context-2d-globalcompositeoperation"},
"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"img","type":"element","url":"https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element"},
"https://html.spec.whatwg.org/multipage/sections.html#the-body-element": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"body","type":"element","url":"https://html.spec.whatwg.org/multipage/sections.html#the-body-element"},
"https://www.w3.org/TR/CSS21/visuren.html#x43": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"css","spec":"css2","status":"current","text":"stacking context","type":"dfn","url":"https://www.w3.org/TR/CSS21/visuren.html#x43"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>