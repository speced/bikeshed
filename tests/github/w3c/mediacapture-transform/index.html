<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>MediaStreamTrack Insertable Media Processing using Streams</title>
  <meta content="UD" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-UD" rel="stylesheet">
  <link href="https://w3c.github.io/mediacapture-insertable-streams/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">MediaStreamTrack Insertable Media Processing using Streams</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#UD">Unofficial Proposal Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/mediacapture-insertable-streams/">https://w3c.github.io/mediacapture-insertable-streams/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webrtc@w3.org?subject=%5Bmediacapture-insertable-streams%5D%20YOUR%20TOPIC%20HERE">public-webrtc@w3.org</a> with subject line “<kbd>[mediacapture-insertable-streams] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webrtc/" rel="discussion">archives</a>)</span>
      <dt class="editor">Editors:
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:hta@google.com">Harald Alvestrand</a> (<a class="p-org org" href="https://google.com">Google</a>)
      <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:guidou@google.com">Guido Urdaneta</a> (<a class="p-org org" href="https://google.com">Google</a>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>This API defines an API surface for manipulating the bits on <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack">MediaStreamTrack</a></code>s carrying raw data.
NOT AN ADOPTED WORKING GROUP DOCUMENT.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#terminology"><span class="secno">2</span> <span class="content">Terminology</span></a>
    <li>
     <a href="#specification"><span class="secno">3</span> <span class="content">Specification</span></a>
     <ol class="toc">
      <li>
       <a href="#track-processor"><span class="secno">3.1</span> <span class="content">MediaStreamTrackProcessor interface</span></a>
       <ol class="toc">
        <li><a href="#internal-slots"><span class="secno">3.1.1</span> <span class="content">Internal slots</span></a>
        <li><a href="#constructor"><span class="secno">3.1.2</span> <span class="content">Constructor</span></a>
        <li><a href="#attributes"><span class="secno">3.1.3</span> <span class="content">Attributes</span></a>
       </ol>
      <li>
       <a href="#track-generator"><span class="secno">3.2</span> <span class="content">MediaStreamTrackGenerator interface</span></a>
       <ol class="toc">
        <li><a href="#internal-slots①"><span class="secno">3.2.1</span> <span class="content">Internal slots</span></a>
        <li><a href="#constructor①"><span class="secno">3.2.2</span> <span class="content">Constructor</span></a>
        <li><a href="#attributes①"><span class="secno">3.2.3</span> <span class="content">Attributes</span></a>
       </ol>
      <li>
       <a href="#stream-control"><span class="secno">3.3</span> <span class="content">Stream control</span></a>
       <ol class="toc">
        <li><a href="#implicit-signaling"><span class="secno">3.3.1</span> <span class="content">Implicit signaling</span></a>
       </ol>
     </ol>
    <li><a href="#examples"><span class="secno">4</span> <span class="content">Examples</span></a>
    <li><a href="#security-considerations"><span class="secno">5</span> <span class="content">Security and Privacy considerations</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
   <p>The <a data-link-type="biblio" href="#biblio-webrtc-nv-use-cases" title="WebRTC Extended Use Cases">[WEBRTC-NV-USE-CASES]</a> document describes several functions that
can only be achieved by access to media (requirements N20-N22),
including, but not limited to:</p>
   <ul>
    <li data-md>
     <p>Funny Hats</p>
    <li data-md>
     <p>Machine Learning</p>
    <li data-md>
     <p>Virtual Reality Gaming</p>
   </ul>
   <p>These use cases further require that processing can be done in worker
threads (requirement N23-N24).</p>
   <p>This specification gives an interface inspired by <a data-link-type="biblio" href="#biblio-webcodecs" title="WebCodecs">[WEBCODECS]</a> to
provide access to such functionality.</p>
   <p>This specification provides access to raw media,
which is the output of a media source such as a camera, microphone, screen capture,
or the decoder part of a codec and the input to the
decoder part of a codec. The processed media can be consumed by any destination
that can take a MediaStreamTrack, including HTML &lt;video> and &lt;audio> tags,
RTCPeerConnection, canvas or MediaRecorder.</p>
   <h2 class="heading settled" data-level="2" id="terminology"><span class="secno">2. </span><span class="content">Terminology</span><a class="self-link" href="#terminology"></a></h2>
   <h2 class="heading settled" data-level="3" id="specification"><span class="secno">3. </span><span class="content">Specification</span><a class="self-link" href="#specification"></a></h2>
   <p>This specification shows the IDL extensions for <a data-link-type="biblio" href="#biblio-mediacapture-streams" title="Media Capture and Streams">[MEDIACAPTURE-STREAMS]</a>.
It defines some new objects that inherit the <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack①">MediaStreamTrack</a></code> interface, and
can be constructed from a <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack②">MediaStreamTrack</a></code>.</p>
   <p>The API consists of two elements. One is a track sink that is
capable of exposing the unencoded frames from the track to a ReadableStream, and exposes a control
channel for signals going in the oppposite direction. The other one is the inverse of that: it takes
video frames as input, and emits control signals that result from subsequent processing.</p>
   <h3 class="heading settled" data-level="3.1" id="track-processor"><span class="secno">3.1. </span><span class="content">MediaStreamTrackProcessor interface</span><a class="self-link" href="#track-processor"></a></h3>
<pre class="idl highlight def"><c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="mediastreamtrackprocessor"><code><c- g>MediaStreamTrackProcessor</c-></code></dfn> {
    <a class="idl-code" data-link-type="constructor" href="#dom-mediastreamtrackprocessor-mediastreamtrackprocessor" id="ref-for-dom-mediastreamtrackprocessor-mediastreamtrackprocessor"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#dictdef-mediastreamtrackprocessorinit" id="ref-for-dictdef-mediastreamtrackprocessorinit"><c- n>MediaStreamTrackProcessorInit</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessor/MediaStreamTrackProcessor(init), MediaStreamTrackProcessor/constructor(init)" data-dfn-type="argument" data-export id="dom-mediastreamtrackprocessor-mediastreamtrackprocessor-init-init"><code><c- g>init</c-></code></dfn>);
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream"><c- n>ReadableStream</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="attribute" data-export data-type="ReadableStream" id="dom-mediastreamtrackprocessor-readable"><code><c- g>readable</c-></code></dfn>;  // VideoFrame or AudioFrame
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#writablestream" id="ref-for-writablestream"><c- n>WritableStream</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="attribute" data-export data-type="WritableStream" id="dom-mediastreamtrackprocessor-writablecontrol"><code><c- g>writableControl</c-></code></dfn>;  // MediaStreamTrackSignal
};

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-mediastreamtrackprocessorinit"><code><c- g>MediaStreamTrackProcessorInit</c-></code></dfn> {
  <c- b>required</c-> <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack③"><c- n>MediaStreamTrack</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessorInit" data-dfn-type="dict-member" data-export data-type="MediaStreamTrack" id="dom-mediastreamtrackprocessorinit-track"><code><c- g>track</c-></code></dfn>;
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#EnforceRange" id="ref-for-EnforceRange"><c- g>EnforceRange</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-unsigned-short" id="ref-for-idl-unsigned-short"><c- b>unsigned</c-> <c- b>short</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessorInit" data-dfn-type="dict-member" data-export data-type="unsigned short" id="dom-mediastreamtrackprocessorinit-maxbuffersize"><code><c- g>maxBufferSize</c-></code></dfn>;
};
</pre>
   <h4 class="heading settled" data-level="3.1.1" id="internal-slots"><span class="secno">3.1.1. </span><span class="content">Internal slots</span><a class="self-link" href="#internal-slots"></a></h4>
   <dl>
    <dt><dfn class="dfn-paneled" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="dfn" data-noexport id="mediastreamtrackprocessor-track"><code>[[track]]</code></dfn>
    <dd>Track whose raw data is to be exposed by the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackprocessor" id="ref-for-mediastreamtrackprocessor">MediaStreamTrackProcessor</a></code>.
    <dt><dfn class="dfn-paneled" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="dfn" data-noexport id="mediastreamtrackprocessor-maxbuffersize"><code>[[maxBufferSize]]</code></dfn>
    <dd>The maximum number of media frames buffered by the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackprocessor" id="ref-for-mediastreamtrackprocessor①">MediaStreamTrackProcessor</a></code>.
   </dl>
   <h4 class="heading settled" data-level="3.1.2" id="constructor"><span class="secno">3.1.2. </span><span class="content">Constructor</span><a class="self-link" href="#constructor"></a></h4>
    <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="constructor" data-export data-lt="MediaStreamTrackProcessor(init)|constructor(init)" id="dom-mediastreamtrackprocessor-mediastreamtrackprocessor" title="MediaStreamTrackProcessor(init)"><code> MediaStreamTrackProcessor(<var>init</var>) </code></dfn> 
   <ol>
    <li data-md>
     <p>If <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessorinit-track" id="ref-for-dom-mediastreamtrackprocessorinit-track">track</a></code> is not a valid <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack④">MediaStreamTrack</a></code>,
throw a <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror">TypeError</a></code>.</p>
    <li data-md>
     <p>Let <var>processor</var> be a new <code class="idl"><a data-link-type="idl" href="#mediastreamtrackprocessor" id="ref-for-mediastreamtrackprocessor②">MediaStreamTrackProcessor</a></code> object.</p>
    <li data-md>
     <p>Assign <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessorinit-track" id="ref-for-dom-mediastreamtrackprocessorinit-track①">track</a></code> to the <code>[[track]]</code> internal slot of <var>processor</var>.</p>
    <li data-md>
     <p>Assign <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessorinit-maxbuffersize" id="ref-for-dom-mediastreamtrackprocessorinit-maxbuffersize">maxBufferSize</a></code> to the <code>[[maxBufferSize]]</code> internal slot of <var>processor</var>.</p>
    <li data-md>
     <p>Return <var>processor</var>.</p>
   </ol>
   <h4 class="heading settled" data-level="3.1.3" id="attributes"><span class="secno">3.1.3. </span><span class="content">Attributes</span><a class="self-link" href="#attributes"></a></h4>
   <dl>
    <dt><dfn class="dfn-paneled" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="dfn" data-noexport id="mediastreamtrackprocessor-readable">readable</dfn>
    <dd>Allows reading the frames flowing through the <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack⑤">MediaStreamTrack</a></code> stored
in the <code>[[track]]</code> internal slot. If <code>[[track]]</code> is a video track, chunks read from <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessor-readable" id="ref-for-dom-mediastreamtrackprocessor-readable">readable</a></code> will be <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#videoframe" id="ref-for-videoframe">VideoFrame</a></code> objects. If <code>[[track]]</code> is an audio track, chunks read from <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessor-readable" id="ref-for-dom-mediastreamtrackprocessor-readable①">readable</a></code> will produce <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#audioframe" id="ref-for-audioframe">AudioFrame</a></code> objects.
If media frames are not read from <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessor-readable" id="ref-for-dom-mediastreamtrackprocessor-readable②">readable</a></code> quickly enough,
the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackprocessor" id="ref-for-mediastreamtrackprocessor③">MediaStreamTrackProcessor</a></code> will internally buffer up to <code>[[maxBufferSize]]</code> of the frames produced by <code>[[track]]</code>. If the internal buffer
is full, each time <code>[[track]]</code> produces a new frame, the oldest frame
in the buffer MUST be dropped and the new frame MUST be added to the buffer. </dd>
    <p class="note" role="note"> The application may detect that frames have been dropped by noticing that there is a gap in the
timestamps of the frames. </p>
    <dt><dfn class="dfn-paneled" data-dfn-for="MediaStreamTrackProcessor" data-dfn-type="dfn" data-noexport id="mediastreamtrackprocessor-writablecontrol">writableControl</dfn>
    <dd>Allows sending control signals to <code>[[track]]</code>.
Control signals are objects of type <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtracksignal" id="ref-for-dictdef-mediastreamtracksignal">MediaStreamTrackSignal</a></code>. 
   </dl>
   <h3 class="heading settled" data-level="3.2" id="track-generator"><span class="secno">3.2. </span><span class="content">MediaStreamTrackGenerator interface</span><a class="self-link" href="#track-generator"></a></h3>
<pre class="idl highlight def"><c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="mediastreamtrackgenerator"><code><c- g>MediaStreamTrackGenerator</c-></code></dfn> : <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack⑥"><c- n>MediaStreamTrack</c-></a> {
    <a class="idl-code" data-link-type="constructor" href="#dom-mediastreamtrackgenerator-mediastreamtrackgenerator" id="ref-for-dom-mediastreamtrackgenerator-mediastreamtrackgenerator"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#dictdef-mediastreamtrackgeneratorinit" id="ref-for-dictdef-mediastreamtrackgeneratorinit"><c- n>MediaStreamTrackGeneratorInit</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGenerator/MediaStreamTrackGenerator(init), MediaStreamTrackGenerator/constructor(init)" data-dfn-type="argument" data-export id="dom-mediastreamtrackgenerator-mediastreamtrackgenerator-init-init"><code><c- g>init</c-></code></dfn>);
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#writablestream" id="ref-for-writablestream①"><c- n>WritableStream</c-></a> <a class="idl-code" data-link-type="attribute" data-type="WritableStream" href="#dom-mediastreamtrackgenerator-writable" id="ref-for-dom-mediastreamtrackgenerator-writable"><c- g>writable</c-></a>;  // VideoFrame or AudioFrame
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream①"><c- n>ReadableStream</c-></a> <a class="idl-code" data-link-type="attribute" data-type="ReadableStream" href="#dom-mediastreamtrackgenerator-readablecontrol" id="ref-for-dom-mediastreamtrackgenerator-readablecontrol"><c- g>readableControl</c-></a>;  // MediaStreamTrackSignal
};

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-mediastreamtrackgeneratorinit"><code><c- g>MediaStreamTrackGeneratorInit</c-></code></dfn> {
  <c- b>required</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGeneratorInit" data-dfn-type="dict-member" data-export data-type="DOMString" id="dom-mediastreamtrackgeneratorinit-kind"><code><c- g>kind</c-></code></dfn>;
  // If signalTarget is provided and signalTarget.kind and kind do not match,
  // the MediaStreamTrackGenerator’s constructor will raise an exception.
  <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack⑦"><c- n>MediaStreamTrack</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGeneratorInit" data-dfn-type="dict-member" data-export data-type="MediaStreamTrack" id="dom-mediastreamtrackgeneratorinit-signaltarget"><code><c- g>signalTarget</c-></code></dfn>;
};
</pre>
   <h4 class="heading settled" data-level="3.2.1" id="internal-slots①"><span class="secno">3.2.1. </span><span class="content">Internal slots</span><a class="self-link" href="#internal-slots①"></a></h4>
   <dl>
    <dt><dfn class="dfn-paneled" data-dfn-for="MediaStreamTrackGenerator" data-dfn-type="dfn" data-noexport id="mediastreamtrackgenerator-signaltarget"><code>[[signalTarget]]</code></dfn>
    <dd>(Optional) track to which the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackgenerator" id="ref-for-mediastreamtrackgenerator">MediaStreamTrackGenerator</a></code> will automatically forward control signals.
   </dl>
   <h4 class="heading settled" data-level="3.2.2" id="constructor①"><span class="secno">3.2.2. </span><span class="content">Constructor</span><a class="self-link" href="#constructor①"></a></h4>
    <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGenerator" data-dfn-type="constructor" data-export data-lt="MediaStreamTrackGenerator(init)|constructor(init)" id="dom-mediastreamtrackgenerator-mediastreamtrackgenerator" title="MediaStreamTrackGenerator(init)"><code> MediaStreamTrackGenerator(init) </code></dfn> 
   <ol>
    <li data-md>
     <p>If <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget">signalTarget</a></code> is not empty and is not a valid <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack⑧">MediaStreamTrack</a></code>,
or <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-kind" id="ref-for-dom-mediastreamtrackgeneratorinit-kind">kind</a></code> is not <code>"audio"</code> or <code>"video"</code>,
throw a <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror①">TypeError</a></code>.</p>
    <li data-md>
     <p>If <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget①">signalTarget</a></code> is not empty, and <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget②">signalTarget</a></code>.<code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind" id="ref-for-dom-mediastreamtrack-kind">kind</a></code> does not match <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-kind" id="ref-for-dom-mediastreamtrackgeneratorinit-kind①">kind</a></code>, throw a <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror②">TypeError</a></code>.</p>
    <li data-md>
     <p>Let <var>g</var> be a new <code class="idl"><a data-link-type="idl" href="#mediastreamtrackgenerator" id="ref-for-mediastreamtrackgenerator①">MediaStreamTrackGenerator</a></code> object.</p>
    <li data-md>
     <p>Initialize the <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind" id="ref-for-dom-mediastreamtrack-kind①">kind</a></code> field of <var>g</var> (inherited from <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack⑨">MediaStreamTrack</a></code>)
with <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-kind" id="ref-for-dom-mediastreamtrackgeneratorinit-kind②">kind</a></code>.</p>
    <li data-md>
     <p>If <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget③">signalTarget</a></code> is not empty,
assign <var>init</var>.<code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget④">signalTarget</a></code> to the <code>[[signalTarget]]</code> internal slot of <var>g</var>.</p>
    <li data-md>
     <p>Return <var>g</var>.</p>
   </ol>
   <h4 class="heading settled" data-level="3.2.3" id="attributes①"><span class="secno">3.2.3. </span><span class="content">Attributes</span><a class="self-link" href="#attributes①"></a></h4>
   <dl>
    <dt><dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGenerator" data-dfn-type="attribute" data-export id="dom-mediastreamtrackgenerator-writable"><code>writable</code></dfn>, <span> of type <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#writablestream" id="ref-for-writablestream②">WritableStream</a></span>
    <dd>Allows writing media frames the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackgenerator" id="ref-for-mediastreamtrackgenerator②">MediaStreamTrackGenerator</a></code>, which is
itself a <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack" id="ref-for-dom-mediastreamtrack①⓪">MediaStreamTrack</a></code>. If the <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind" id="ref-for-dom-mediastreamtrack-kind②">kind</a></code> attribute is <code>"audio"</code>,
the stream will accept <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#audioframe" id="ref-for-audioframe①">AudioFrame</a></code> objects and fail with any other type. If <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind" id="ref-for-dom-mediastreamtrack-kind③">kind</a></code> is <code>"video"</code>, the stream will accept <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#videoframe" id="ref-for-videoframe①">VideoFrame</a></code> objects
and fail with any other type. When a frame is written to <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgenerator-writable" id="ref-for-dom-mediastreamtrackgenerator-writable①">writable</a></code>,
the frame’s <code>close()</code> method is automatically invoked, so that its internal resources are no longer
accessible from JavaScript. 
    <dt><dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackGenerator" data-dfn-type="attribute" data-export id="dom-mediastreamtrackgenerator-readablecontrol"><code>readableControl</code></dfn>, <span> of type <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream②">ReadableStream</a></span>
    <dd>Allows reading control signals sent from any sinks connected to the <code class="idl"><a data-link-type="idl" href="#mediastreamtrackgenerator" id="ref-for-mediastreamtrackgenerator③">MediaStreamTrackGenerator</a></code>. Control signals are objects of type <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtracksignal" id="ref-for-dictdef-mediastreamtracksignal①">MediaStreamTrackSignal</a></code>. 
   </dl>
   <h3 class="heading settled" data-level="3.3" id="stream-control"><span class="secno">3.3. </span><span class="content">Stream control</span><a class="self-link" href="#stream-control"></a></h3>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-mediastreamtracksignal"><code><c- g>MediaStreamTrackSignal</c-></code></dfn> {
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-mediastreamtracksignaltype" id="ref-for-enumdef-mediastreamtracksignaltype"><c- n>MediaStreamTrackSignalType</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackSignal" data-dfn-type="dict-member" data-export data-type="MediaStreamTrackSignalType" id="dom-mediastreamtracksignal-signaltype"><code><c- g>signalType</c-></code></dfn>;
};

<c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-mediastreamtracksignaltype"><code><c- g>MediaStreamTrackSignalType</c-></code></dfn> {
  <dfn class="dfn-paneled idl-code" data-dfn-for="MediaStreamTrackSignalType" data-dfn-type="enum-value" data-export id="dom-mediastreamtracksignaltype-request-frame"><code><c- s>"request-frame"</c-></code></dfn>,
};
</pre>
   <p>In the MediaStream model, apart from media, which flows from sources to sinks, there are also
control signals that flow in the opposite direction (i.e., from sinks to sources via the track).
A <code class="idl"><a data-link-type="idl" href="#mediastreamtrackprocessor" id="ref-for-mediastreamtrackprocessor④">MediaStreamTrackProcessor</a></code> is a sink and it allows sending control
signals to its track and source via its <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessor-writablecontrol" id="ref-for-dom-mediastreamtrackprocessor-writablecontrol">writableControl</a></code> field.
A <code class="idl"><a data-link-type="idl" href="#mediastreamtrackgenerator" id="ref-for-mediastreamtrackgenerator④">MediaStreamTrackGenerator</a></code> is a track for which a custom source can be implemented
by writing media frames to its <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgenerator-writable" id="ref-for-dom-mediastreamtrackgenerator-writable②">writable</a></code> field. Such a source can
receive control signals sent by sinks via its <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgenerator-readablecontrol" id="ref-for-dom-mediastreamtrackgenerator-readablecontrol①">readableControl</a></code> field.
Note that control signals are just hints that a sink can send to its track (or the source
backing it). There is no obligation for a source or track to react to them.</p>
   <p>Control signals are represented as <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtracksignal" id="ref-for-dictdef-mediastreamtracksignal②">MediaStreamTrackSignal</a></code> objects.
The <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtracksignal" id="ref-for-dictdef-mediastreamtracksignal③">MediaStreamTrackSignal</a></code> dictionary has the following fields:</p>
   <ul>
    <li data-md>
     <p><code class="idl"><a data-link-type="idl" href="#dom-mediastreamtracksignal-signaltype" id="ref-for-dom-mediastreamtracksignal-signaltype">signalType</a></code>, which specifies the action to be requested to
the track or source. The possible values are defined by the <code class="idl"><a data-link-type="idl" href="#enumdef-mediastreamtracksignaltype" id="ref-for-enumdef-mediastreamtracksignaltype①">MediaStreamTrackSignalType</a></code> enum and are the following:</p>
     <ul>
      <li data-md>
       <p><code>"request-frame"</code>, tells the source to produce a new frame.</p>
     </ul>
   </ul>
   <p>This set of control signals is intended to be extensible, so it is possible that new signal types
and parameters may be added in the future. Note also that this set of control signals is
not intended to cover all possible signaling that may occur between platform sinks and
tracks/sources. A user agent implementation is free to implement any internal signaling between
specific types of sinks and specific types of sources, and it would not make sense to expose all
such specific signaling to generic Web platform objects like track generators and processors,
as they can be considered implementation details that may differ significantly across browsers.
It is, however, a requirement of this specification that it is possible to operate a
MediaStreamTrackGenerator connected to a MediaStreamTrackProcessor using only the
Web Platform-exposed signals and without connecting any implicit signalling.</p>
   <h4 class="heading settled" data-level="3.3.1" id="implicit-signaling"><span class="secno">3.3.1. </span><span class="content">Implicit signaling</span><a class="self-link" href="#implicit-signaling"></a></h4>
    A common use case for processors and generators is to connect the media flow from
a pre-existing platform track (e.g., camera, screen capture) to pre-existing platform sinks
(e.g., peer connection, media element) with a transformation in between, in a chain like this: 
   <p>Platform Track -> Processor -> Transform -> Generator -> Platform Sinks</p>
   <p>Absent the Breakout Box elements, the platform sinks would normally send the signals directly
to the platform track (and its source). Arguably, in many cases the source of the platform track
can still be considered the source for the platform sinks and it would be desirable to keep
the original platform signaling even with the Processor -> Transform -> Generator chain between
them. This can be achieved by assigning the platform track to the <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgeneratorinit-signaltarget" id="ref-for-dom-mediastreamtrackgeneratorinit-signaltarget⑤">signalTarget</a></code> field in <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtrackgeneratorinit" id="ref-for-dictdef-mediastreamtrackgeneratorinit①">MediaStreamTrackGeneratorInit</a></code>. Note that such a connection between the platform track and the
generator includes all possible internal signaling coming from the platform sinks and not just
the generic signals exposed as <code class="idl"><a data-link-type="idl" href="#dictdef-mediastreamtracksignal" id="ref-for-dictdef-mediastreamtracksignal④">MediaStreamTrackSignal</a></code> objects via the <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackgenerator-readablecontrol" id="ref-for-dom-mediastreamtrackgenerator-readablecontrol②">readableControl</a></code> and <code class="idl"><a data-link-type="idl" href="#dom-mediastreamtrackprocessor-writablecontrol" id="ref-for-dom-mediastreamtrackprocessor-writablecontrol①">writableControl</a></code> fields. Just connecting explicit signals from
a generator to a processor (e.g., with a call like <code>generator.readableControl.pipeTo(processor.writableControl</code>) forwards only
the Web Platform-exposed signals, but ignores any internal custom signals as there is no
way for the platform sinks to know what the upstream source is.</p>
   <h2 class="heading settled" data-level="4" id="examples"><span class="secno">4. </span><span class="content">Examples</span><a class="self-link" href="#examples"></a></h2>
    Consider a face recognition function <code>detectFace(videoFrame)</code> that returns a face position
(in some format), and a manipulation function <code>blurBackground(videoFrame, facePosition)</code> that
returns a new VideoFrame similar to the given <code>videoFrame</code>, but with the non-face parts blurred. 
<pre class="example" id="example-2531ccc5"><a class="self-link" href="#example-2531ccc5"></a>let stream = await getUserMedia({video:true});
let videoTrack = stream.getVideoTracks()[0];
let trackProcessor = new TrackProcessor(videoTrack);
let trackGenerator = new TrackGenerator();
let transformer = new TransformStream({
   async transform(videoFrame, controller) {
      let facePosition = detectFace(videoFrame);
      let newFrame = blurBackground(videoFrame.data, facePosition);
      videoFrame.close();
      controller.enqueue(newFrame);
  }
});

// After this, trackGenerator can be assigned to any sink such as a
// peer connection, or media element.
trackProcessor.readable
    .pipeThrough(transformer)
    .pipeTo(trackGenerator.writable);

// Forward Web-exposed signals to the original videoTrack.
trackGenerator.readableControl.pipeTo(trackProcessor.writableControl);
</pre>
   <h2 class="heading settled" data-level="5" id="security-considerations"><span class="secno">5. </span><span class="content">Security and Privacy considerations</span><a class="self-link" href="#security-considerations"></a></h2>
   <p>The security of this API relies on existing mechanisms in the Web platform.
As data is exposed using the <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#videoframe" id="ref-for-videoframe②">VideoFrame</a></code> and <code class="idl"><a data-link-type="idl" href="https://wicg.github.io/web-codecs/#audioframe" id="ref-for-audioframe②">AudioFrame</a></code> interfaces,
the rules of those interfaces to deal with origin-tained data apply.
For example, data from cross-origin resources cannot be accessed due to existing
restrictions to access such resources (e.g., it is not possible to access the pixels of
a cross-origin image or video element).
In addition to this, access to media data from cameras, microphones or the screen is subject
to user authorization as specified in <a data-link-type="biblio" href="#biblio-mediacapture-streams" title="Media Capture and Streams">[MEDIACAPTURE-STREAMS]</a> and <a data-link-type="biblio" href="#biblio-mediacapture-screen-share" title="Screen Capture">[MEDIACAPTURE-SCREEN-SHARE]</a>.</p>
   <p>The media data this API exposes is already available through other APIs (e.g., media elements +
canvas + canvas capture). In addition to the media data, this API exposes some control signals
such as requests for new frames. These signals are intended as hints and do not pose a
significant security risk.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li>
    constructor(init)
    <ul>
     <li><a href="#dom-mediastreamtrackgenerator-mediastreamtrackgenerator">constructor for MediaStreamTrackGenerator</a><span>, in § 3.2.2</span>
     <li><a href="#dom-mediastreamtrackprocessor-mediastreamtrackprocessor">constructor for MediaStreamTrackProcessor</a><span>, in § 3.1.2</span>
    </ul>
   <li><a href="#dom-mediastreamtrackgeneratorinit-kind">kind</a><span>, in § 3.2</span>
   <li><a href="#mediastreamtrackprocessor-maxbuffersize">[[maxBufferSize]]</a><span>, in § 3.1.1</span>
   <li><a href="#dom-mediastreamtrackprocessorinit-maxbuffersize">maxBufferSize</a><span>, in § 3.1</span>
   <li><a href="#mediastreamtrackgenerator">MediaStreamTrackGenerator</a><span>, in § 3.2</span>
   <li><a href="#dom-mediastreamtrackgenerator-mediastreamtrackgenerator">MediaStreamTrackGenerator(init)</a><span>, in § 3.2.2</span>
   <li><a href="#dictdef-mediastreamtrackgeneratorinit">MediaStreamTrackGeneratorInit</a><span>, in § 3.2</span>
   <li><a href="#mediastreamtrackprocessor">MediaStreamTrackProcessor</a><span>, in § 3.1</span>
   <li><a href="#dom-mediastreamtrackprocessor-mediastreamtrackprocessor">MediaStreamTrackProcessor(init)</a><span>, in § 3.1.2</span>
   <li><a href="#dictdef-mediastreamtrackprocessorinit">MediaStreamTrackProcessorInit</a><span>, in § 3.1</span>
   <li><a href="#dictdef-mediastreamtracksignal">MediaStreamTrackSignal</a><span>, in § 3.3</span>
   <li><a href="#enumdef-mediastreamtracksignaltype">MediaStreamTrackSignalType</a><span>, in § 3.3</span>
   <li>
    readable
    <ul>
     <li><a href="#dom-mediastreamtrackprocessor-readable">attribute for MediaStreamTrackProcessor</a><span>, in § 3.1</span>
     <li><a href="#mediastreamtrackprocessor-readable">dfn for MediaStreamTrackProcessor</a><span>, in § 3.1.3</span>
    </ul>
   <li><a href="#dom-mediastreamtrackgenerator-readablecontrol">readableControl</a><span>, in § 3.2.3</span>
   <li><a href="#dom-mediastreamtracksignaltype-request-frame">"request-frame"</a><span>, in § 3.3</span>
   <li><a href="#mediastreamtrackgenerator-signaltarget">[[signalTarget]]</a><span>, in § 3.2.1</span>
   <li><a href="#dom-mediastreamtrackgeneratorinit-signaltarget">signalTarget</a><span>, in § 3.2</span>
   <li><a href="#dom-mediastreamtracksignal-signaltype">signalType</a><span>, in § 3.3</span>
   <li><a href="#mediastreamtrackprocessor-track">[[track]]</a><span>, in § 3.1.1</span>
   <li><a href="#dom-mediastreamtrackprocessorinit-track">track</a><span>, in § 3.1</span>
   <li><a href="#dom-mediastreamtrackgenerator-writable">writable</a><span>, in § 3.2.3</span>
   <li>
    writableControl
    <ul>
     <li><a href="#dom-mediastreamtrackprocessor-writablecontrol">attribute for MediaStreamTrackProcessor</a><span>, in § 3.1</span>
     <li><a href="#mediastreamtrackprocessor-writablecontrol">dfn for MediaStreamTrackProcessor</a><span>, in § 3.1.3</span>
    </ul>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[MEDIACAPTURE-STREAMS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="bc1e4fa1">MediaStreamTrack</span>
     <li><span class="dfn-paneled" id="29e497a3">kind</span>
    </ul>
   <li>
    <a data-link-type="biblio">[STREAMS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="59ed4e57">ReadableStream</span>
     <li><span class="dfn-paneled" id="59dc45b5">WritableStream</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBCODECS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d41b4309">AudioFrame</span>
     <li><span class="dfn-paneled" id="822758a8">VideoFrame</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
     <li><span class="dfn-paneled" id="c01cbda0">EnforceRange</span>
     <li><span class="dfn-paneled" id="82ca3efc">TypeError</span>
     <li><span class="dfn-paneled" id="450958f7">unsigned short</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-mediacapture-streams">[MEDIACAPTURE-STREAMS]
   <dd>Cullen Jennings; et al. <a href="https://w3c.github.io/mediacapture-main/"><cite>Media Capture and Streams</cite></a>. URL: <a href="https://w3c.github.io/mediacapture-main/">https://w3c.github.io/mediacapture-main/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-streams">[STREAMS]
   <dd>Adam Rice; et al. <a href="https://streams.spec.whatwg.org/"><cite>Streams Standard</cite></a>. Living Standard. URL: <a href="https://streams.spec.whatwg.org/">https://streams.spec.whatwg.org/</a>
   <dt id="biblio-webcodecs">[WEBCODECS]
   <dd><a href="https://wicg.github.io/web-codecs/"><cite>WebCodecs</cite></a>. URL: <a href="https://wicg.github.io/web-codecs/">https://wicg.github.io/web-codecs/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-mediacapture-screen-share">[MEDIACAPTURE-SCREEN-SHARE]
   <dd><a href="https://w3c.github.io/mediacapture-screen-share/"><cite>Screen Capture</cite></a>. URL: <a href="https://w3c.github.io/mediacapture-screen-share/">https://w3c.github.io/mediacapture-screen-share/</a>
   <dt id="biblio-webrtc-nv-use-cases">[WEBRTC-NV-USE-CASES]
   <dd>Bernard Aboba. <a href="https://w3c.github.io/webrtc-nv-use-cases/"><cite>WebRTC Extended Use Cases</cite></a>. URL: <a href="https://w3c.github.io/webrtc-nv-use-cases/">https://w3c.github.io/webrtc-nv-use-cases/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>interface</c-> <a href="#mediastreamtrackprocessor"><code><c- g>MediaStreamTrackProcessor</c-></code></a> {
    <a class="idl-code" data-link-type="constructor" href="#dom-mediastreamtrackprocessor-mediastreamtrackprocessor"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#dictdef-mediastreamtrackprocessorinit"><c- n>MediaStreamTrackProcessorInit</c-></a> <a href="#dom-mediastreamtrackprocessor-mediastreamtrackprocessor-init-init"><code><c- g>init</c-></code></a>);
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#readablestream"><c- n>ReadableStream</c-></a> <a data-type="ReadableStream" href="#dom-mediastreamtrackprocessor-readable"><code><c- g>readable</c-></code></a>;  // VideoFrame or AudioFrame
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#writablestream"><c- n>WritableStream</c-></a> <a data-type="WritableStream" href="#dom-mediastreamtrackprocessor-writablecontrol"><code><c- g>writableControl</c-></code></a>;  // MediaStreamTrackSignal
};

<c- b>dictionary</c-> <a href="#dictdef-mediastreamtrackprocessorinit"><code><c- g>MediaStreamTrackProcessorInit</c-></code></a> {
  <c- b>required</c-> <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack"><c- n>MediaStreamTrack</c-></a> <a data-type="MediaStreamTrack" href="#dom-mediastreamtrackprocessorinit-track"><code><c- g>track</c-></code></a>;
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#EnforceRange"><c- g>EnforceRange</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-unsigned-short"><c- b>unsigned</c-> <c- b>short</c-></a> <a data-type="unsigned short" href="#dom-mediastreamtrackprocessorinit-maxbuffersize"><code><c- g>maxBufferSize</c-></code></a>;
};

<c- b>interface</c-> <a href="#mediastreamtrackgenerator"><code><c- g>MediaStreamTrackGenerator</c-></code></a> : <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack"><c- n>MediaStreamTrack</c-></a> {
    <a class="idl-code" data-link-type="constructor" href="#dom-mediastreamtrackgenerator-mediastreamtrackgenerator"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#dictdef-mediastreamtrackgeneratorinit"><c- n>MediaStreamTrackGeneratorInit</c-></a> <a href="#dom-mediastreamtrackgenerator-mediastreamtrackgenerator-init-init"><code><c- g>init</c-></code></a>);
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#writablestream"><c- n>WritableStream</c-></a> <a class="idl-code" data-link-type="attribute" data-type="WritableStream" href="#dom-mediastreamtrackgenerator-writable"><c- g>writable</c-></a>;  // VideoFrame or AudioFrame
    <c- b>attribute</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#readablestream"><c- n>ReadableStream</c-></a> <a class="idl-code" data-link-type="attribute" data-type="ReadableStream" href="#dom-mediastreamtrackgenerator-readablecontrol"><c- g>readableControl</c-></a>;  // MediaStreamTrackSignal
};

<c- b>dictionary</c-> <a href="#dictdef-mediastreamtrackgeneratorinit"><code><c- g>MediaStreamTrackGeneratorInit</c-></code></a> {
  <c- b>required</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a data-type="DOMString" href="#dom-mediastreamtrackgeneratorinit-kind"><code><c- g>kind</c-></code></a>;
  // If signalTarget is provided and signalTarget.kind and kind do not match,
  // the MediaStreamTrackGenerator’s constructor will raise an exception.
  <a data-link-type="idl-name" href="https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack"><c- n>MediaStreamTrack</c-></a> <a data-type="MediaStreamTrack" href="#dom-mediastreamtrackgeneratorinit-signaltarget"><code><c- g>signalTarget</c-></code></a>;
};

<c- b>dictionary</c-> <a href="#dictdef-mediastreamtracksignal"><code><c- g>MediaStreamTrackSignal</c-></code></a> {
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-mediastreamtracksignaltype"><c- n>MediaStreamTrackSignalType</c-></a> <a data-type="MediaStreamTrackSignalType" href="#dom-mediastreamtracksignal-signaltype"><code><c- g>signalType</c-></code></a>;
};

<c- b>enum</c-> <a href="#enumdef-mediastreamtracksignaltype"><code><c- g>MediaStreamTrackSignalType</c-></code></a> {
  <a href="#dom-mediastreamtracksignaltype-request-frame"><code><c- s>"request-frame"</c-></code></a>,
};

</pre>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"29e497a3": {"dfnID":"29e497a3","dfnText":"kind","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrack-kind"},{"id":"ref-for-dom-mediastreamtrack-kind\u2460"}],"title":"3.2.2. Constructor"},{"refs":[{"id":"ref-for-dom-mediastreamtrack-kind\u2461"},{"id":"ref-for-dom-mediastreamtrack-kind\u2462"}],"title":"3.2.3. Attributes"}],"url":"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind"},
"450958f7": {"dfnID":"450958f7","dfnText":"unsigned short","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-unsigned-short"}],"title":"3.1. MediaStreamTrackProcessor interface"}],"url":"https://webidl.spec.whatwg.org/#idl-unsigned-short"},
"59dc45b5": {"dfnID":"59dc45b5","dfnText":"WritableStream","external":true,"refSections":[{"refs":[{"id":"ref-for-writablestream"}],"title":"3.1. MediaStreamTrackProcessor interface"},{"refs":[{"id":"ref-for-writablestream\u2460"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-writablestream\u2461"}],"title":"3.2.3. Attributes"}],"url":"https://streams.spec.whatwg.org/#writablestream"},
"59ed4e57": {"dfnID":"59ed4e57","dfnText":"ReadableStream","external":true,"refSections":[{"refs":[{"id":"ref-for-readablestream"}],"title":"3.1. MediaStreamTrackProcessor interface"},{"refs":[{"id":"ref-for-readablestream\u2460"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-readablestream\u2461"}],"title":"3.2.3. Attributes"}],"url":"https://streams.spec.whatwg.org/#readablestream"},
"822758a8": {"dfnID":"822758a8","dfnText":"VideoFrame","external":true,"refSections":[{"refs":[{"id":"ref-for-videoframe"}],"title":"3.1.3. Attributes"},{"refs":[{"id":"ref-for-videoframe\u2460"}],"title":"3.2.3. Attributes"},{"refs":[{"id":"ref-for-videoframe\u2461"}],"title":"5. Security and Privacy considerations"}],"url":"https://wicg.github.io/web-codecs/#videoframe"},
"82ca3efc": {"dfnID":"82ca3efc","dfnText":"TypeError","external":true,"refSections":[{"refs":[{"id":"ref-for-exceptiondef-typeerror"}],"title":"3.1.2. Constructor"},{"refs":[{"id":"ref-for-exceptiondef-typeerror\u2460"},{"id":"ref-for-exceptiondef-typeerror\u2461"}],"title":"3.2.2. Constructor"}],"url":"https://webidl.spec.whatwg.org/#exceptiondef-typeerror"},
"8855a9aa": {"dfnID":"8855a9aa","dfnText":"DOMString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMString"}],"title":"3.2. MediaStreamTrackGenerator interface"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"bc1e4fa1": {"dfnID":"bc1e4fa1","dfnText":"MediaStreamTrack","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrack"}],"title":"Unnumbered Section"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2460"},{"id":"ref-for-dom-mediastreamtrack\u2461"}],"title":"3. Specification"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2462"}],"title":"3.1. MediaStreamTrackProcessor interface"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2463"}],"title":"3.1.2. Constructor"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2464"}],"title":"3.1.3. Attributes"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2465"},{"id":"ref-for-dom-mediastreamtrack\u2466"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2467"},{"id":"ref-for-dom-mediastreamtrack\u2468"}],"title":"3.2.2. Constructor"},{"refs":[{"id":"ref-for-dom-mediastreamtrack\u2460\u24ea"}],"title":"3.2.3. Attributes"}],"url":"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack"},
"c01cbda0": {"dfnID":"c01cbda0","dfnText":"EnforceRange","external":true,"refSections":[{"refs":[{"id":"ref-for-EnforceRange"}],"title":"3.1. MediaStreamTrackProcessor interface"}],"url":"https://webidl.spec.whatwg.org/#EnforceRange"},
"d41b4309": {"dfnID":"d41b4309","dfnText":"AudioFrame","external":true,"refSections":[{"refs":[{"id":"ref-for-audioframe"}],"title":"3.1.3. Attributes"},{"refs":[{"id":"ref-for-audioframe\u2460"}],"title":"3.2.3. Attributes"},{"refs":[{"id":"ref-for-audioframe\u2461"}],"title":"5. Security and Privacy considerations"}],"url":"https://wicg.github.io/web-codecs/#audioframe"},
"dictdef-mediastreamtrackgeneratorinit": {"dfnID":"dictdef-mediastreamtrackgeneratorinit","dfnText":"MediaStreamTrackGeneratorInit","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-mediastreamtrackgeneratorinit"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-dictdef-mediastreamtrackgeneratorinit\u2460"}],"title":"3.3.1. Implicit signaling"}],"url":"#dictdef-mediastreamtrackgeneratorinit"},
"dictdef-mediastreamtrackprocessorinit": {"dfnID":"dictdef-mediastreamtrackprocessorinit","dfnText":"MediaStreamTrackProcessorInit","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-mediastreamtrackprocessorinit"}],"title":"3.1. MediaStreamTrackProcessor interface"}],"url":"#dictdef-mediastreamtrackprocessorinit"},
"dictdef-mediastreamtracksignal": {"dfnID":"dictdef-mediastreamtracksignal","dfnText":"MediaStreamTrackSignal","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-mediastreamtracksignal"}],"title":"3.1.3. Attributes"},{"refs":[{"id":"ref-for-dictdef-mediastreamtracksignal\u2460"}],"title":"3.2.3. Attributes"},{"refs":[{"id":"ref-for-dictdef-mediastreamtracksignal\u2461"},{"id":"ref-for-dictdef-mediastreamtracksignal\u2462"}],"title":"3.3. Stream control"},{"refs":[{"id":"ref-for-dictdef-mediastreamtracksignal\u2463"}],"title":"3.3.1. Implicit signaling"}],"url":"#dictdef-mediastreamtracksignal"},
"dom-mediastreamtrackgenerator-mediastreamtrackgenerator": {"dfnID":"dom-mediastreamtrackgenerator-mediastreamtrackgenerator","dfnText":"\n  MediaStreamTrackGenerator(init)\n","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-mediastreamtrackgenerator"}],"title":"3.2. MediaStreamTrackGenerator interface"}],"url":"#dom-mediastreamtrackgenerator-mediastreamtrackgenerator"},
"dom-mediastreamtrackgenerator-mediastreamtrackgenerator-init-init": {"dfnID":"dom-mediastreamtrackgenerator-mediastreamtrackgenerator-init-init","dfnText":"init","external":false,"refSections":[],"url":"#dom-mediastreamtrackgenerator-mediastreamtrackgenerator-init-init"},
"dom-mediastreamtrackgenerator-readablecontrol": {"dfnID":"dom-mediastreamtrackgenerator-readablecontrol","dfnText":"readableControl","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-readablecontrol"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-readablecontrol\u2460"}],"title":"3.3. Stream control"},{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-readablecontrol\u2461"}],"title":"3.3.1. Implicit signaling"}],"url":"#dom-mediastreamtrackgenerator-readablecontrol"},
"dom-mediastreamtrackgenerator-writable": {"dfnID":"dom-mediastreamtrackgenerator-writable","dfnText":"writable","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-writable"}],"title":"3.2. MediaStreamTrackGenerator interface"},{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-writable\u2460"}],"title":"3.2.3. Attributes"},{"refs":[{"id":"ref-for-dom-mediastreamtrackgenerator-writable\u2461"}],"title":"3.3. Stream control"}],"url":"#dom-mediastreamtrackgenerator-writable"},
"dom-mediastreamtrackgeneratorinit-kind": {"dfnID":"dom-mediastreamtrackgeneratorinit-kind","dfnText":"kind","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackgeneratorinit-kind"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-kind\u2460"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-kind\u2461"}],"title":"3.2.2. Constructor"}],"url":"#dom-mediastreamtrackgeneratorinit-kind"},
"dom-mediastreamtrackgeneratorinit-signaltarget": {"dfnID":"dom-mediastreamtrackgeneratorinit-signaltarget","dfnText":"signalTarget","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget\u2460"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget\u2461"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget\u2462"},{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget\u2463"}],"title":"3.2.2. Constructor"},{"refs":[{"id":"ref-for-dom-mediastreamtrackgeneratorinit-signaltarget\u2464"}],"title":"3.3.1. Implicit signaling"}],"url":"#dom-mediastreamtrackgeneratorinit-signaltarget"},
"dom-mediastreamtrackprocessor-mediastreamtrackprocessor": {"dfnID":"dom-mediastreamtrackprocessor-mediastreamtrackprocessor","dfnText":"\n  MediaStreamTrackProcessor(init)\n","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessor-mediastreamtrackprocessor"}],"title":"3.1. MediaStreamTrackProcessor interface"}],"url":"#dom-mediastreamtrackprocessor-mediastreamtrackprocessor"},
"dom-mediastreamtrackprocessor-mediastreamtrackprocessor-init-init": {"dfnID":"dom-mediastreamtrackprocessor-mediastreamtrackprocessor-init-init","dfnText":"init","external":false,"refSections":[],"url":"#dom-mediastreamtrackprocessor-mediastreamtrackprocessor-init-init"},
"dom-mediastreamtrackprocessor-readable": {"dfnID":"dom-mediastreamtrackprocessor-readable","dfnText":"readable","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessor-readable"},{"id":"ref-for-dom-mediastreamtrackprocessor-readable\u2460"},{"id":"ref-for-dom-mediastreamtrackprocessor-readable\u2461"}],"title":"3.1.3. Attributes"}],"url":"#dom-mediastreamtrackprocessor-readable"},
"dom-mediastreamtrackprocessor-writablecontrol": {"dfnID":"dom-mediastreamtrackprocessor-writablecontrol","dfnText":"writableControl","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessor-writablecontrol"}],"title":"3.3. Stream control"},{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessor-writablecontrol\u2460"}],"title":"3.3.1. Implicit signaling"}],"url":"#dom-mediastreamtrackprocessor-writablecontrol"},
"dom-mediastreamtrackprocessorinit-maxbuffersize": {"dfnID":"dom-mediastreamtrackprocessorinit-maxbuffersize","dfnText":"maxBufferSize","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessorinit-maxbuffersize"}],"title":"3.1.2. Constructor"}],"url":"#dom-mediastreamtrackprocessorinit-maxbuffersize"},
"dom-mediastreamtrackprocessorinit-track": {"dfnID":"dom-mediastreamtrackprocessorinit-track","dfnText":"track","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtrackprocessorinit-track"},{"id":"ref-for-dom-mediastreamtrackprocessorinit-track\u2460"}],"title":"3.1.2. Constructor"}],"url":"#dom-mediastreamtrackprocessorinit-track"},
"dom-mediastreamtracksignal-signaltype": {"dfnID":"dom-mediastreamtracksignal-signaltype","dfnText":"signalType","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-mediastreamtracksignal-signaltype"}],"title":"3.3. Stream control"}],"url":"#dom-mediastreamtracksignal-signaltype"},
"dom-mediastreamtracksignaltype-request-frame": {"dfnID":"dom-mediastreamtracksignaltype-request-frame","dfnText":"\"request-frame\"","external":false,"refSections":[],"url":"#dom-mediastreamtracksignaltype-request-frame"},
"enumdef-mediastreamtracksignaltype": {"dfnID":"enumdef-mediastreamtracksignaltype","dfnText":"MediaStreamTrackSignalType","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-mediastreamtracksignaltype"},{"id":"ref-for-enumdef-mediastreamtracksignaltype\u2460"}],"title":"3.3. Stream control"}],"url":"#enumdef-mediastreamtracksignaltype"},
"mediastreamtrackgenerator": {"dfnID":"mediastreamtrackgenerator","dfnText":"MediaStreamTrackGenerator","external":false,"refSections":[{"refs":[{"id":"ref-for-mediastreamtrackgenerator"}],"title":"3.2.1. Internal slots"},{"refs":[{"id":"ref-for-mediastreamtrackgenerator\u2460"}],"title":"3.2.2. Constructor"},{"refs":[{"id":"ref-for-mediastreamtrackgenerator\u2461"},{"id":"ref-for-mediastreamtrackgenerator\u2462"}],"title":"3.2.3. Attributes"},{"refs":[{"id":"ref-for-mediastreamtrackgenerator\u2463"}],"title":"3.3. Stream control"}],"url":"#mediastreamtrackgenerator"},
"mediastreamtrackgenerator-signaltarget": {"dfnID":"mediastreamtrackgenerator-signaltarget","dfnText":"[[signalTarget]]","external":false,"refSections":[],"url":"#mediastreamtrackgenerator-signaltarget"},
"mediastreamtrackprocessor": {"dfnID":"mediastreamtrackprocessor","dfnText":"MediaStreamTrackProcessor","external":false,"refSections":[{"refs":[{"id":"ref-for-mediastreamtrackprocessor"},{"id":"ref-for-mediastreamtrackprocessor\u2460"}],"title":"3.1.1. Internal slots"},{"refs":[{"id":"ref-for-mediastreamtrackprocessor\u2461"}],"title":"3.1.2. Constructor"},{"refs":[{"id":"ref-for-mediastreamtrackprocessor\u2462"}],"title":"3.1.3. Attributes"},{"refs":[{"id":"ref-for-mediastreamtrackprocessor\u2463"}],"title":"3.3. Stream control"}],"url":"#mediastreamtrackprocessor"},
"mediastreamtrackprocessor-maxbuffersize": {"dfnID":"mediastreamtrackprocessor-maxbuffersize","dfnText":"[[maxBufferSize]]","external":false,"refSections":[],"url":"#mediastreamtrackprocessor-maxbuffersize"},
"mediastreamtrackprocessor-readable": {"dfnID":"mediastreamtrackprocessor-readable","dfnText":"readable","external":false,"refSections":[],"url":"#mediastreamtrackprocessor-readable"},
"mediastreamtrackprocessor-track": {"dfnID":"mediastreamtrackprocessor-track","dfnText":"[[track]]","external":false,"refSections":[],"url":"#mediastreamtrackprocessor-track"},
"mediastreamtrackprocessor-writablecontrol": {"dfnID":"mediastreamtrackprocessor-writablecontrol","dfnText":"writableControl","external":false,"refSections":[],"url":"#mediastreamtrackprocessor-writablecontrol"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#dictdef-mediastreamtrackgeneratorinit": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackGeneratorInit","type":"dictionary","url":"#dictdef-mediastreamtrackgeneratorinit"},
"#dictdef-mediastreamtrackprocessorinit": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackProcessorInit","type":"dictionary","url":"#dictdef-mediastreamtrackprocessorinit"},
"#dictdef-mediastreamtracksignal": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackSignal","type":"dictionary","url":"#dictdef-mediastreamtracksignal"},
"#dom-mediastreamtrackgenerator-mediastreamtrackgenerator": {"export":true,"for_":["MediaStreamTrackGenerator"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackGenerator(init)","type":"constructor","url":"#dom-mediastreamtrackgenerator-mediastreamtrackgenerator"},
"#dom-mediastreamtrackgenerator-readablecontrol": {"export":true,"for_":["MediaStreamTrackGenerator"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"readableControl","type":"attribute","url":"#dom-mediastreamtrackgenerator-readablecontrol"},
"#dom-mediastreamtrackgenerator-writable": {"export":true,"for_":["MediaStreamTrackGenerator"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"writable","type":"attribute","url":"#dom-mediastreamtrackgenerator-writable"},
"#dom-mediastreamtrackgeneratorinit-kind": {"export":true,"for_":["MediaStreamTrackGeneratorInit"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"kind","type":"dict-member","url":"#dom-mediastreamtrackgeneratorinit-kind"},
"#dom-mediastreamtrackgeneratorinit-signaltarget": {"export":true,"for_":["MediaStreamTrackGeneratorInit"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"signalTarget","type":"dict-member","url":"#dom-mediastreamtrackgeneratorinit-signaltarget"},
"#dom-mediastreamtrackprocessor-mediastreamtrackprocessor": {"export":true,"for_":["MediaStreamTrackProcessor"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackProcessor(init)","type":"constructor","url":"#dom-mediastreamtrackprocessor-mediastreamtrackprocessor"},
"#dom-mediastreamtrackprocessor-readable": {"export":true,"for_":["MediaStreamTrackProcessor"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"readable","type":"attribute","url":"#dom-mediastreamtrackprocessor-readable"},
"#dom-mediastreamtrackprocessor-writablecontrol": {"export":true,"for_":["MediaStreamTrackProcessor"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"writableControl","type":"attribute","url":"#dom-mediastreamtrackprocessor-writablecontrol"},
"#dom-mediastreamtrackprocessorinit-maxbuffersize": {"export":true,"for_":["MediaStreamTrackProcessorInit"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"maxBufferSize","type":"dict-member","url":"#dom-mediastreamtrackprocessorinit-maxbuffersize"},
"#dom-mediastreamtrackprocessorinit-track": {"export":true,"for_":["MediaStreamTrackProcessorInit"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"track","type":"dict-member","url":"#dom-mediastreamtrackprocessorinit-track"},
"#dom-mediastreamtracksignal-signaltype": {"export":true,"for_":["MediaStreamTrackSignal"],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"signalType","type":"dict-member","url":"#dom-mediastreamtracksignal-signaltype"},
"#enumdef-mediastreamtracksignaltype": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackSignalType","type":"enum","url":"#enumdef-mediastreamtracksignaltype"},
"#mediastreamtrackgenerator": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackGenerator","type":"interface","url":"#mediastreamtrackgenerator"},
"#mediastreamtrackprocessor": {"export":true,"for_":[],"level":"","normative":true,"shortname":"mediacapture-insertable-streams","spec":"mediacapture-insertable-streams","status":"local","text":"MediaStreamTrackProcessor","type":"interface","url":"#mediastreamtrackprocessor"},
"https://streams.spec.whatwg.org/#readablestream": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"streams","spec":"streams","status":"current","text":"ReadableStream","type":"interface","url":"https://streams.spec.whatwg.org/#readablestream"},
"https://streams.spec.whatwg.org/#writablestream": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"streams","spec":"streams","status":"current","text":"WritableStream","type":"interface","url":"https://streams.spec.whatwg.org/#writablestream"},
"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"mediacapture-streams","spec":"mediacapture-streams","status":"current","text":"MediaStreamTrack","type":"interface","url":"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack"},
"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind": {"export":true,"for_":["MediaStreamTrack"],"level":"1","normative":true,"shortname":"mediacapture-streams","spec":"mediacapture-streams","status":"current","text":"kind","type":"attribute","url":"https://w3c.github.io/mediacapture-main/#dom-mediastreamtrack-kind"},
"https://webidl.spec.whatwg.org/#EnforceRange": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"EnforceRange","type":"extended-attribute","url":"https://webidl.spec.whatwg.org/#EnforceRange"},
"https://webidl.spec.whatwg.org/#exceptiondef-typeerror": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"TypeError","type":"exception","url":"https://webidl.spec.whatwg.org/#exceptiondef-typeerror"},
"https://webidl.spec.whatwg.org/#idl-DOMString": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"https://webidl.spec.whatwg.org/#idl-unsigned-short": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"unsigned short","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-unsigned-short"},
"https://wicg.github.io/web-codecs/#audioframe": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webcodecs","spec":"webcodecs","status":"anchor-block","text":"AudioFrame","type":"interface","url":"https://wicg.github.io/web-codecs/#audioframe"},
"https://wicg.github.io/web-codecs/#videoframe": {"export":true,"for_":[],"level":"","normative":true,"shortname":"webcodecs","spec":"webcodecs","status":"anchor-block","text":"VideoFrame","type":"interface","url":"https://wicg.github.io/web-codecs/#videoframe"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>