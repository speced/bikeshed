<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Post-Spectre Web Development</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <link href="https://www.w3.org/TR/post-spectre-webdev/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Post-Spectre Web Development</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/webappsec-post-spectre-webdev/">https://w3c.github.io/webappsec-post-spectre-webdev/</a>
      <dt>Latest published version:
      <dd><a href="https://www.w3.org/TR/post-spectre-webdev/">https://www.w3.org/TR/post-spectre-webdev/</a>
      <dt>Previous Versions:
      <dd><a href="https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/" rel="prev">https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/</a>
      <dt>Feedback:
      <dd><span><a href="mailto:public-webappsec@w3.org?subject=%5Bpost-spectre-webdev%5D%20YOUR%20TOPIC%20HERE">public-webappsec@w3.org</a> with subject line “<kbd>[post-spectre-webdev] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webappsec/" rel="discussion">archives</a>)</span>
      <dt class="editor">Editor:
      <dd class="editor p-author h-card vcard" data-editor-id="56384"><a class="p-name fn u-email email" href="mailto:mkwst@google.com">Mike West</a> (<span class="p-org org">Google</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Post-Spectre, we need to adopt some new strategies for safe and secure web development. This
document outlines a threat model we can share, and a set of mitigation recommendations.</p>
   <p><strong>TL;DR</strong>: Your data must not unexpectedly enter an attacker’s process.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p> <strong>Changes to this document may be tracked at <a href="https://github.com/w3c/webappsec">https://github.com/w3c/webappsec</a>.</strong> </p>
   <p> The (<a href="https://lists.w3.org/Archives/Public/public-webappsec/">archived</a>) public mailing list <a href="mailto:public-webappsec@w3.org?Subject=%5Bpost-spectre-webdev%5D%20PUT%20SUBJECT%20HERE">public-webappsec@w3.org</a> (see <a href="https://www.w3.org/Mail/Request">instructions</a>)
	is preferred for discussion of this specification.
	When sending e-mail,
	please put the text “post-spectre-webdev” in the subject,
	preferably like this:
	“[post-spectre-webdev] <em>…summary of comment…</em>” </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webappsec">Web Application Security Working Group</a>. </p>
   <p> This document was produced by a group operating under
	the <a href="https://www.w3.org/policies/patent-policy/">W3C Patent Policy</a>.
	W3C maintains a <a href="https://www.w3.org/groups/wg/webappsec/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
	that page also includes instructions for disclosing a patent.
	An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/#sec-Disclosure">section 6 of the W3C Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#threat-model"><span class="secno">1.1</span> <span class="content">Threat Model</span></a>
      <li><a href="#tldr"><span class="secno">1.2</span> <span class="content">TL;DR</span></a>
     </ol>
    <li>
     <a href="#examples"><span class="secno">2</span> <span class="content">Practical Examples</span></a>
     <ol class="toc">
      <li>
       <a href="#subresources"><span class="secno">2.1</span> <span class="content">Subresources</span></a>
       <ol class="toc">
        <li><a href="#static-subresources"><span class="secno">2.1.1</span> <span class="content">Static Subresources</span></a>
        <li><a href="#dynamic-subresources"><span class="secno">2.1.2</span> <span class="content">Dynamic Subresources</span></a>
       </ol>
      <li>
       <a href="#documents"><span class="secno">2.2</span> <span class="content">Documents</span></a>
       <ol class="toc">
        <li><a href="#documents-isolated"><span class="secno">2.2.1</span> <span class="content">Fully-Isolated Documents</span></a>
        <li><a href="#documents-with-popups"><span class="secno">2.2.2</span> <span class="content">Documents Expecting to Open Cross-Origin Windows</span></a>
        <li><a href="#documents-as-popups"><span class="secno">2.2.3</span> <span class="content">Documents Expecting Cross-Origin Openers</span></a>
       </ol>
     </ol>
    <li>
     <a href="#considerations"><span class="secno">3</span> <span class="content">Implementation Considerations</span></a>
     <ol class="toc">
      <li><a href="#explicit-defaults"><span class="secno">3.1</span> <span class="content">Explicitly Setting Headers with Default Values</span></a>
     </ol>
    <li><a href="#acks"><span class="secno">4</span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>In early 2018, Spectre made it clear that a foundational security boundary the web aimed to
maintain was substantially less robust than expected. <a data-link-type="biblio" href="#biblio-spectre" title="Spectre Attacks: Exploiting Speculative Execution">[SPECTRE]</a> This revelation has pushed web
browsers to shift their focus from the platform-level <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/origin.html#concept-origin" id="ref-for-concept-origin">origin</a> boundary to an OS-level
process boundary. Chromium’s threat model, for instance, now asserts that "active web content …
will be able to read any and all data in the address space of the process that hosts it". <a data-link-type="biblio" href="#biblio-post-spectre-rethink" title="Post-Spectre Threat Model Re-Think">[POST-SPECTRE-RETHINK]</a> This shift in thinking imposes a shift in development practice, both
for browser vendors, and for web developers. Browsers need to align the origin boundary with the
process boundary through fundamental refactoring projects (for example, <a data-link-type="biblio" href="#biblio-site-isolation" title="Site Isolation">[SITE-ISOLATION]</a> and <a data-link-type="biblio" href="#biblio-project-fission" title="Project Fission">[PROJECT-FISSION]</a>). Moreover, browsers must provide web developers with tools to mitigate risk
in the short term, and should push the platform towards safe default behaviors in the long term.
The bad news is that this is going to be a lot of work, much of it falling on the shoulders of
web developers. The good news is that a reasonable set of mitigation primitives exists today,
ready and waiting for use.</p>
   <p>This document will summarize the threat model which the Web Application Security Working Group
espouses, point to a set of mitigations which seem promising, and provide concrete recommendations
for developers responsible for protecting users' data.</p>
   <h3 class="heading settled" data-level="1.1" id="threat-model"><span class="secno">1.1. </span><span class="content">Threat Model</span><a class="self-link" href="#threat-model"></a></h3>
   <p>Spectre-like side-channel attacks inexorably lead to a model in which active web content
(JavaScript, WASM, probably CSS if we tried hard enough, and so on) can read any and all data which
has entered the address space of the process which hosts it. While this has deep implications for
user agent implementations' internal hardening strategies (stack canaries, ASLR, etc), here we’ll
remain focused on the core implication at the web platform level, which is both simple and profound:
any data which flows into a process hosting a given origin is legible to that origin. We must design
accordingly.</p>
   <p>In order to determine the scope of data that can be assumed accessible to an attacker, we must make
a few assumptions about the normally-not-web-exposed process model which the user agent implements.
The following seems like a good place to start:</p>
   <ol>
    <li data-md>
     <p>User agents are capable of separating the execution of a web origin’s code into a process
distinct from the agent’s core. This separation enables the agent itself to access local
devices, fetch resources, broker cross-process communication, and so on, in a way which remains
invisible to any process potentially hosting untrusted code.</p>
    <li data-md>
     <p>User agents are able to make decisions about whether or not a given resource should be delivered
to a process hosting a given origin based on characteristics of both the request and the
response (headers, etc).</p>
    <li data-md>
     <p>User agents can consistently separate top-level, cross-origin windows into distinct processes.
They cannot consistently separate same-site or same-origin windows into distinct processes given
the potential for synchronous access between the windows.</p>
    <li data-md>
     <p>User agents cannot yet consistently separate framed origins into processes distinct from their
embedders' origin.</p>
     <p class="note" role="note"><span class="marker">Note:</span> Though some user agents support out-of-process frames <a data-link-type="biblio" href="#biblio-oopif" title="Out-of-Process iframes (OOPIFs)">[OOPIF]</a>, no agent supports it
consistently across a broad range of devices and platforms. Ideally this will change over time,
as the frame boundary <em>must</em> be one we can eventually consider robust.</p>
   </ol>
   <p>With this in mind, our general assumption will be that an origin gains access to any resource which
it renders (including images, stylesheets, scripts, frames, etc). Likewise, embedded frames gain
access to their ancestors' content.</p>
   <p class="issue" id="issue-340f57a5"><a class="self-link" href="#issue-340f57a5"></a> <a data-link-type="biblio" href="#biblio-coi-threat-model" title="Notes on the threat model of cross-origin isolation">[COI-THREAT-MODEL]</a> spells out more implications. Bring them in here for more nuance.</p>
   <h3 class="heading settled" data-level="1.2" id="tldr"><span class="secno">1.2. </span><span class="content">TL;DR</span><a class="self-link" href="#tldr"></a></h3>
   <ol>
    <li data-md>
     <p><strong>Decide when (not!) to respond to requests</strong> by examining incoming headers, paying special
attention to the <a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#origin-header" id="ref-for-origin-header"><code>Origin</code></a> header on the one hand, and various <code>Sec-Fetch-</code> prefixed headers on the other, as described in <a data-link-type="biblio" href="#biblio-resource-isolation-policy" title="Resource Isolation Policy">[resource-isolation-policy]</a>.</p>
    <li data-md>
     <p><strong>Restrict attackers' ability to load your data as a subresource</strong> by setting a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy" id="ref-for-http-cross-origin-resource-policy">cross-origin resource policy</a> (CORP) of <code>same-origin</code> (opening up to <code>same-site</code> or <code>cross-origin</code> only when necessary).</p>
    <li data-md>
     <p><strong>Restrict attackers' ability to frame your data as a document</strong> by opt-ing into framing
protections via <code>X-Frame-Options: SAMEORIGIN</code> or CSP’s more granular <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#frame-ancestors" id="ref-for-frame-ancestors">frame-ancestors</a> directive (<code>frame-ancestors 'self' https://trusted.embedder</code>, for example).</p>
    <li data-md>
     <p><strong>Restrict attackers' ability to obtain a handle to your window</strong> by setting a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies" id="ref-for-cross-origin-opener-policies">cross-origin opener policy</a> (COOP). In the best case, you can default to a restrictive <code>same-origin</code> value, opening up to <code>same-origin-allow-popups</code> or <code>unsafe-none</code> only if
necessary.</p>
    <li data-md>
     <p><strong>Prevent MIME-type confusion attacks</strong> and increase the robustness of passive defenses like <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#corb" id="ref-for-corb">cross-origin read blocking</a> (CORB) / <a href="https://github.com/annevk/orb">opaque response blocking</a> (<a data-link-type="biblio" href="#biblio-orb" title="Opaque Response Blocking (ORB, aka CORB++)">[ORB]</a>) by setting
correct <code>Content-Type</code> headers, and globally asserting <code>X-Content-Type-Options: nosniff</code>.</p>
   </ol>
   <p class="issue" id="issue-db0b0c7b"><a class="self-link" href="#issue-db0b0c7b"></a> Describe these mitigations in more depth, swiping liberally from <a href="https://docs.google.com/document/d/1JBUaX1xSOZRxBk5bRNZWgnzyJoCQC52TIRokACBSmGc/edit?resourcekey=0-cZ7da6v52enjwRSsp_tLyQ">Notes on the threat model of <em>cross-origin isolation</em></a>, <a href="https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit">Safely reviving shared memory</a>, etc.</p>
   <h2 class="heading settled" data-level="2" id="examples"><span class="secno">2. </span><span class="content">Practical Examples</span><a class="self-link" href="#examples"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="subresources"><span class="secno">2.1. </span><span class="content">Subresources</span><a class="self-link" href="#subresources"></a></h3>
   <p>Resources which are intended to be loaded into documents should protect themselves from being used
in unexpected ways. Before walking through strategies for specific kinds of resources, a few headers
seem generally applicable:</p>
   <ol>
    <li data-md>
     <p>Sites should use Fetch Metadata to make good decisions about when to serve resources, as
described in <a data-link-type="biblio" href="#biblio-resource-isolation-policy" title="Resource Isolation Policy">[resource-isolation-policy]</a>. In order to ensure that decision sticks, servers
should explain its decision to the browser by sending a <a data-link-type="http-header" href="https://tools.ietf.org/html/rfc7231#section-7.1.4" id="ref-for-section-7.1.4"><code>Vary</code></a> header
containing <code>Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User</code>. This ensures that
the server has a chance to make different decisions for requests which will be <em>used</em> differently.</p>
    <li data-md>
     <p>Subresources should opt-out of MIME type sniffing by sending an <a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-x-content-type-options" id="ref-for-http-x-content-type-options"><code>X-Content-Type-Options</code></a> header with a value of <code>nosniff</code>. This increases the
robustness of MIME-based checks like <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#corb" id="ref-for-corb①">cross-origin read blocking</a> (CORB) / <a href="https://github.com/annevk/orb">opaque response blocking</a> (<a data-link-type="biblio" href="#biblio-orb" title="Opaque Response Blocking (ORB, aka CORB++)">[ORB]</a>), and mitigates
some well-known risks around type confusion for scripts.</p>
    <li data-md>
     <p>Subresources are intended for inclusion in a given context, not as independently navigable
documents. To mitigate the risk that navigation to a subresource causes script execution or
opens an origin up to attack in some other way, servers can assert the following set of headers
which collectively make it difficult to meaningfully abuse a subresource via navigation:</p>
     <ul>
      <li data-md>
       <p>Using the <a data-link-type="http-header" href="https://w3c.github.io/webappsec-csp/#header-content-security-policy" id="ref-for-header-content-security-policy"><code>Content-Security-Policy</code></a> header’s to assert the <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#sandbox" id="ref-for-sandbox"><code>sandbox</code></a> directive ensures that these resources remain inactive if navigated to
directly as a top-level document. No scripts will execute, and the resource will be pushed
into an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>.</p>
       <p class="note" role="note"><span class="marker">Note:</span> Some servers deliver <code>Content-Disposition: attachment; filename=file.name</code> to obtain
a similar effect. This was valuable to mitigate vulnerabilities in Flash, but the sandbox
approach seems to more straightforwardly address the threats we care about today.</p>
      <li data-md>
       <p>Asserting the <a data-link-type="http-header" href="https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies" id="ref-for-cross-origin-opener-policies①"><code>Cross-Origin-Opener-Policy</code></a> header with a value of <code>same-origin</code> prevents cross-origin documents from retaining a handle to the resource’s
window if it’s opened in a popup.</p>
      <li data-md>
       <p>The <a data-link-type="http-header" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-x-frame-options-header" id="ref-for-the-x-frame-options-header"><code>X-Frame-Options</code></a> header with a value of <code>DENY</code> prevents the resource
from being framed.</p>
     </ul>
   </ol>
   <p>Most subresources, then, should contain the following block of headers, which you’ll see repeated a
few times below:</p>
<pre class="highlight">Content-Security-Policy: sandbox
Cross-Origin-Opener-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
</pre>
   <p>With these generic protections in mind, let’s sift through a few scenarios to determine what headers
a server would be well-served to assert:</p>
   <h4 class="heading settled" data-level="2.1.1" id="static-subresources"><span class="secno">2.1.1. </span><span class="content">Static Subresources</span><a class="self-link" href="#static-subresources"></a></h4>
   <p>By their nature, static resources contain the same data no matter who requests them, and therefore
cannot contain interesting information that an attacker couldn’t otherwise obtain. There’s no risk
to making these resources widely available, and value in allowing embedders to robustly debug, so
something like the following response headers could be appropriate:</p>
<pre class="highlight"><strong>Access-Control-Allow-Origin: *
Cross-Origin-Resource-Policy: cross-origin
Timing-Allow-Origin: *</strong>
Content-Security-Policy: sandbox
Cross-Origin-Opener-Policy: same-origin
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
</pre>
   <p class="note" role="note"><span class="marker">Note:</span> Purely static resources always respond with the same data, no matter the request. There’s
therefore little benefit to sending a <code>Vary</code> header: it can be safely omitted for these responses.</p>
   <p>CDNs are the canonical static resource distribution points, and many use the pattern above. Take
a look at the following common resources' response headers for inspiration:</p>
   <ul>
    <li data-md>
     <p><a href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"><code>https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js</code></a></p>
    <li data-md>
     <p><a href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"><code>https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js</code></a></p>
    <li data-md>
     <p><a href="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"><code>https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js</code></a></p>
    <li data-md>
     <p><a href="https://ssl.google-analytics.com/ga.js"><code>https://ssl.google-analytics.com/ga.js</code></a></p>
   </ul>
   <p>Similarly, application-specific static resource servers are a good place to look for this practice. Consider:</p>
   <ul>
    <li data-md>
     <p><a href="https://static.xx.fbcdn.net/rsrc.php/v3/y2/r/zVvRrO8pOtu.png"><code>https://static.xx.fbcdn.net/rsrc.php/v3/y2/r/zVvRrO8pOtu.png</code></a></p>
    <li data-md>
     <p><a href="https://www.gstatic.com/images/branding/googlelogo/svg/googlelogo_clr_74x24px.svg"><code>https://www.gstatic.com/images/branding/googlelogo/svg/googlelogo_clr_74x24px.svg</code></a></p>
   </ul>
   <h4 class="heading settled" data-level="2.1.2" id="dynamic-subresources"><span class="secno">2.1.2. </span><span class="content">Dynamic Subresources</span><a class="self-link" href="#dynamic-subresources"></a></h4>
   <p>Subresources that contain data personalized to a given user are juicy targets for attackers, and
must be defended by ensuring that they’re loaded only in ways that are appropriate for the data
in question. A few cases are well worth considering:</p>
   <ol>
    <li data-md>
     <p>Application-internal resources (private API endpoints, avatar images, uploaded data, etc.)
should not be available to any cross-origin requestor. These resources should be restricted to
usage as a subresource in same-origin contexts by sending a <a data-link-type="http-header" href="https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy" id="ref-for-http-cross-origin-resource-policy①"><code>Cross-Origin-Resource-Policy</code></a> header with a value of <code>same-origin</code>:</p>
<pre class="highlight"><strong>Cross-Origin-Resource-Policy: same-origin</strong>
Content-Security-Policy: sandbox
Cross-Origin-Opener-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
</pre>
     <p>This header will prevent cross-origin attackers from loading the resource as a response to a <code>no-cors</code> request.</p>
     <p>For example, examine the headers returned when requesting endpoints like the following:</p>
     <ul>
      <li data-md>
       <p><a href="https://myaccount.google.com/_/AccountSettingsUi/browserinfo"><code>https://myaccount.google.com/_/AccountSettingsUi/browserinfo</code></a></p>
      <li data-md>
       <p><a href="https://twitter.com/i/api/1.1/branch/init.json"><code>https://twitter.com/i/api/1.1/branch/init.json</code></a></p>
      <li data-md>
       <p><a href="https://www.facebook.com/ajax/webstorage/process_keys/?state=0"><code>https://www.facebook.com/ajax/webstorage/process_keys/?state=0</code></a></p>
     </ul>
    <li data-md>
     <p>Personalized resources intended for cross-origin use (public API endpoints, etc) should
carefully consider incoming requests' properties before responding. These endpoints can only
safely be enabled by requiring CORS, and choosing the set of origins for which a given response
can be exposed by setting the appropriate access-control headers, for example:</p>
<pre class="highlight"><strong>Access-Control-Allow-Credentials: true
Access-Control-Allow-Origin: https://trusted.example
Access-Control-Allow-Methods: POST
Access-Control-Allow-Headers: ...
Access-Control-Allow-...: ...
Cross-Origin-Resource-Policy: same-origin</strong>
Content-Security-Policy: sandbox
Cross-Origin-Opener-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
</pre>
     <p class="note" role="note"><span class="marker">Note:</span> The <code>Cross-Origin-Resource-Policy</code> header is only processed for requests that are _not_
using CORS for access control ("<code>no-cors</code> requests"). Sending <code>Cross-Origin-Resource-Policy: same-origin</code> is therefore not harmful, and works to ensure that <code>no-cors</code> usage isn’t accidentally allowed.</p>
     <p>For example, examine the headers returned when requesting endpoints like the following:</p>
     <ul>
      <li data-md>
       <p><a href="https://api.twitter.com/1.1/jot/client_event.json"><code>https://api.twitter.com/1.1/jot/client_event.json</code></a></p>
      <li data-md>
       <p><a href="https://play.google.com/log?format=json&amp;hasfast=true"><code>https://play.google.com/log?format=json&amp;hasfast=true</code></a></p>
      <li data-md>
       <p><a href="https://securepubads.g.doubleclick.net/pcs/view"><code>https://securepubads.g.doubleclick.net/pcs/view</code></a></p>
      <li data-md>
       <p><a href="https://c.amazon-adsystem.com/e/dtb/bid"><code>https://c.amazon-adsystem.com/e/dtb/bid</code></a></p>
     </ul>
    <li data-md>
     <p>Personalized resources that are intended for cross-origin <code>no-cors</code> embedding, but which don’t
intend to be directly legible in that context (avatar images, authenticated media, etc). These
should enable cross-origin embedding via <code>Cross-Origin-Resource-Policy</code>, but _not_ via CORS
access control headers:</p>
<pre class="highlight"><strong>Cross-Origin-Resource-Policy: cross-origin</strong>
Content-Security-Policy: sandbox
Cross-Origin-Opener-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
</pre>
     <div class="note" role="note">
       Note: That this allows the resource to be used by any cross-origin document. That’s
    reasonable for some use cases, but requiring CORS, and opting-in a small set of origins via
    appropriate access-control headers is a possible alternative for some resources. This
    approach will give those contexts trivial access to the resource’s bits, so the granularity
    is a tradeoff. Still, considering this case to be the same as the "personalized resources
    intended for cross-origin use" isn’t unreasonable. 
      <p class="issue" id="issue-ae9c0065"><a class="self-link" href="#issue-ae9c0065"></a> If we implemented more granular bindings for CORP headers (along
    the lines of <code>Cross-Origin-Resource-Policy: https://trusted.example</code>), we could avoid this
    tradeoff entirely. <a href="https://github.com/whatwg/fetch/issues/760">[Issue #whatwg/fetch#760]</a></p>
     </div>
     <p>For example:</p>
     <ul>
      <li data-md>
       <p><a href="https://lh3.google.com/u/0/d/1JBUaX1xSOZRxBk5bRNZWgnzyJoCQC52TIRokACBSmGc=w512"><code>https://lh3.google.com/u/0/d/1JBUaX1xSOZRxBk5bRNZWgnzyJoCQC52TIRokACBSmGc=w512</code></a></p>
     </ul>
   </ol>
   <h3 class="heading settled" data-level="2.2" id="documents"><span class="secno">2.2. </span><span class="content">Documents</span><a class="self-link" href="#documents"></a></h3>
   <h4 class="heading settled" data-level="2.2.1" id="documents-isolated"><span class="secno">2.2.1. </span><span class="content">Fully-Isolated Documents</span><a class="self-link" href="#documents-isolated"></a></h4>
   <p>Documents that require users to be signed-in almost certainly contain information that shouldn’t be
revealed to attackers. These pages should take care to isolate themselves from other origins, both
by making _a priori_ decisions about whether to serve the page at all (see <a data-link-type="biblio" href="#biblio-resource-isolation-policy" title="Resource Isolation Policy">[resource-isolation-policy]</a>, for example), and by giving clients careful instructions about how
the page can be used once delivered. For instance, something like the following set of response
headers could be appropriate:</p>
<pre class="highlight">Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
</pre>
   <p class="note" role="note"><span class="marker">Note:</span> Documents which need to make use of APIs that require full cross-origin isolation (such
as <code class="idl"><a data-link-type="idl" href="https://tc39.es/ecma262/#sec-sharedarraybuffer-objects" id="ref-for-sec-sharedarraybuffer-objects">SharedArrayBuffer</a></code>), will also need to serve a <code>Cross-Origin-Embedder-Policy</code> header, as
outlined in <a data-link-type="biblio" href="#biblio-coop-coep" title="Making your website &apos;cross-origin isolated&apos; using COOP and COEP">[coop-coep]</a> and <a data-link-type="biblio" href="#biblio-cross-origin-isolation-guide" title="A guide to enable cross-origin isolation">[cross-origin-isolation-guide]</a>.</p>
   <p>Account settings pages, admin panels, and application-specific documents are all good examples of
resources which would benefit from as much isolation as possible. For real-life examples, consider:</p>
   <ul>
    <li data-md>
     <p><a href="https://myaccount.google.com/"><code>https://myaccount.google.com/</code></a></p>
   </ul>
   <h4 class="heading settled" data-level="2.2.2" id="documents-with-popups"><span class="secno">2.2.2. </span><span class="content">Documents Expecting to Open Cross-Origin Windows</span><a class="self-link" href="#documents-with-popups"></a></h4>
   <p>Not every document that requires sign-in can be fully-isolated from the rest of the internet. It’s
often the case that partial isolation is a better fit. Consider sites that depend upon cross-origin
windows for federated workflows involving payments or sign-in, for example. These pages would
generally benefit from restricting attackers' ability to embed them, or obtain their window handle,
but they can’t easily lock themselves off from all such vectors via <code>Cross-Origin-Opener-Policy: same-origin</code> and <code>X-Frame-Options: DENY</code>. In these cases, something
like the following set of response headers might be appropriate:</p>
<pre class="highlight">Cross-Origin-Opener-Policy: same-origin-allow-popups
Cross-Origin-Resource-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
</pre>
   <p>The only difference between this case and the "Fully-Isolated" case above is the <code>Cross-Origin-Opener-Policy</code> value. <code>same-origin</code> will break the opener relationship between the
document and any cross-origin window, regardless of who opened whom. <code>same-origin-allow-popups</code> will break cross-origin opener relationships initiated by a cross-origin
document’s use of <code>window.open()</code>, but will allow the asserting document to open cross-origin
windows that retain an opener relationship.</p>
   <h4 class="heading settled" data-level="2.2.3" id="documents-as-popups"><span class="secno">2.2.3. </span><span class="content">Documents Expecting Cross-Origin Openers</span><a class="self-link" href="#documents-as-popups"></a></h4>
   <p>Federated sign-in forms and payment providers are clear examples of documents which intend to be
opened by cross-origin windows, and require that relationship to be maintained in order to
facilitate communication via channels like <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/web-messaging.html#dom-window-postmessage-options" id="ref-for-dom-window-postmessage-options">postMessage(message, options)</a></code> or navigation.
These documents cannot isolate themselves completely, but can prevent themselves from being embedded
or fetched cross-origin. Three scenarios are worth considering:</p>
   <ol>
    <li data-md>
     <p>Documents that only wish to be opened in cross-origin popups could loosen their cross-origin
opener policy by serving the following headers:</p>
<pre class="highlight">Cross-Origin-Resource-Policy: same-origin
<strong>Cross-Origin-Opener-Policy: unsafe-none</strong>
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
</pre>
     <p>For example:</p>
     <ul>
      <li data-md>
       <p class="issue" id="issue-94179e25"><a class="self-link" href="#issue-94179e25"></a> Find some links.</p>
     </ul>
    <li data-md>
     <p>Documents that only wish to be framed in cross-origin contexts could loosen their framing
protections by serving the following headers:</p>
<pre class="highlight">Cross-Origin-Resource-Policy: same-origin
Cross-Origin-Opener-Policy: same-origin
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
<strong>X-Frame-Options: ALLOWALL</strong>
</pre>
     <div class="note" role="note">
       Note: That this allows embedding by any cross-origin documents. That’s reasonable for some
    widgety use cases, but when possible, a more secure alternative would specify a list of origins
    which are allowed to embed the document via the <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#frame-ancestors" id="ref-for-frame-ancestors①">frame-ancestors</a> CSP directive. That is, in
    addition to the <code>X-Frame-Options</code> header above, the following header could also be included to
    restrict the document to a short list of trusted embedders: 
<pre class="highlight">Content-Security-Policy: frame-ancestors https://trusted1.example https://trusted2.example
</pre>
     </div>
     <p>For example:</p>
     <ul>
      <li data-md>
       <p class="issue" id="issue-94179e25①"><a class="self-link" href="#issue-94179e25①"></a> Find some links.</p>
     </ul>
    <li data-md>
     <p>Documents that support both popup and framing scenarios need to loosen both their cross-origin
opener policies and framing protections by combining the recommendations above, serving the
following headers:</p>
<pre class="lang-http highlight">Cross-Origin-Resource-Policy: same-origin
<strong>Cross-Origin-Opener-Policy: unsafe-none</strong>
Vary: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site, Sec-Fetch-User
X-Content-Type-Options: nosniff
<strong>X-Frame-Options: ALLOWALL</strong>
</pre>
     <p>For example:</p>
     <ul>
      <li data-md>
       <p class="issue" id="issue-94179e25②"><a class="self-link" href="#issue-94179e25②"></a> Find some links.</p>
     </ul>
   </ol>
   <h2 class="heading settled" data-level="3" id="considerations"><span class="secno">3. </span><span class="content">Implementation Considerations</span><a class="self-link" href="#considerations"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="explicit-defaults"><span class="secno">3.1. </span><span class="content">Explicitly Setting Headers with Default Values</span><a class="self-link" href="#explicit-defaults"></a></h3>
   <p>Several recommendations above suggest that developers would be well-served to set headers like <code>X-Frame-Options: ALLOWALL</code> or <code>Cross-Origin-Opener-Policy: unsafe-none</code> on responses. These
map to the web’s status quo behavior, and seem therefore superfluous. Why should developers
set them?</p>
   <p>The core reason is that these defaults are poor fits for today’s threats, and we ought to be working
to change them. Proposals like <a data-link-type="biblio" href="#biblio-embedding-requires-opt-in" title="Embedding Should Require Explicit Opt-In">[EMBEDDING-REQUIRES-OPT-IN]</a> and <a data-link-type="biblio" href="#biblio-coop-by-default" title="COOP By Default">[COOP-BY-DEFAULT]</a> suggest that
we shift the web’s defaults away from requiring developers to opt-into more secure behaviors by
making them opt-out rather than opt-in. This would place the configuration cost on those developers
whose projects require risky settings.</p>
   <p>This document recommends setting those less-secure header values explicitly, as that makes it more
likely that we’ll be able to shift the web’s defaults in the future.</p>
   <h2 class="heading settled" data-level="4" id="acks"><span class="secno">4. </span><span class="content">Acknowledgements</span><a class="self-link" href="#acks"></a></h2>
   <p>This document relies upon a number of excellent resources that spell out much of the foundation
of our understanding of Spectre’s implications for the web, and justify the mitigation strategies
we currently espouse. The following is an incomplete list of those works:</p>
   <p><a data-link-type="biblio" href="#biblio-application-principals" title="Isolating Application-Defined Principals">[APPLICATION-PRINCIPALS]</a>, <a data-link-type="biblio" href="#biblio-long-term-mitigations" title="Long-Term Web Browser Mitigations for Spectre">[LONG-TERM-MITIGATIONS]</a>, <a data-link-type="biblio" href="#biblio-spectre-shaped-web" title="A Spectre-shaped Web">[SPECTRE-SHAPED-WEB]</a>, <a data-link-type="biblio" href="#biblio-post-spectre-rethink" title="Post-Spectre Threat Model Re-Think">[POST-SPECTRE-RETHINK]</a>, <a data-link-type="biblio" href="#biblio-spilling-the-beans" title="How do we Stop Spilling The Beans Across Origins?">[SPILLING-THE-BEANS]</a>, <a data-link-type="biblio" href="#biblio-cross-origin-embedder-policy" title="Cross-Origin Embedder Policy">[CROSS-ORIGIN-EMBEDDER-POLICY]</a>, <a data-link-type="biblio" href="#biblio-cross-origin-opener-policy-explainer" title="Cross-Origin-Opener-Policy Explainer">[CROSS-ORIGIN-OPENER-POLICY-EXPLAINER]</a>, <a data-link-type="biblio" href="#biblio-coop-coep-explained" title="COOP and COEP Explained">[COOP-COEP-EXPLAINED]</a>, <a data-link-type="biblio" href="#biblio-safely-reviving-shared-memory" title="Safely reviving shared memory">[SAFELY-REVIVING-SHARED-MEMORY]</a>, <a data-link-type="biblio" href="#biblio-coi-threat-model" title="Notes on the threat model of cross-origin isolation">[COI-THREAT-MODEL]</a></p>
  </main>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b7c21a86">content-security-policy</span>
     <li><span class="dfn-paneled" id="251f80a9">frame-ancestors</span>
     <li><span class="dfn-paneled" id="8ea172e9">sandbox</span>
    </ul>
   <li>
    <a data-link-type="biblio">[ECMA262]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="91890fa8">SharedArrayBuffer</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="388997ea">cross-origin read blocking</span>
     <li><span class="dfn-paneled" id="bc2f1a3d">cross-origin resource policy</span>
     <li><span class="dfn-paneled" id="7e8a44f1">cross-origin-resource-policy</span>
     <li><span class="dfn-paneled" id="f0e1d33e">origin</span>
     <li><span class="dfn-paneled" id="8b1d49ab">x-content-type-options</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="6b3e31cd">cross-origin opener policy</span>
     <li><span class="dfn-paneled" id="7e56321a">cross-origin-opener-policy</span>
     <li><span class="dfn-paneled" id="b01b1359">opaque origin</span>
     <li><span class="dfn-paneled" id="a944ac4c">origin</span>
     <li><span class="dfn-paneled" id="8a7dfd23">postMessage(message, options)</span>
     <li><span class="dfn-paneled" id="b0120874">x-frame-options</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC7231]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9de4af9f">vary</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-csp3">[CSP3]
   <dd>Mike West; Antonio Sartori. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 3</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-rfc7231">[RFC7231]
   <dd>R. Fielding, Ed.; J. Reschke, Ed.. <a href="https://httpwg.org/specs/rfc7231.html"><cite>Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content</cite></a>. June 2014. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc7231.html">https://httpwg.org/specs/rfc7231.html</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-application-principals">[APPLICATION-PRINCIPALS]
   <dd>Chris Palmer. <a href="https://noncombatant.org/application-principals/"><cite>Isolating Application-Defined Principals</cite></a>. 2018-06-19. URL: <a href="https://noncombatant.org/application-principals/">https://noncombatant.org/application-principals/</a>
   <dt id="biblio-coi-threat-model">[COI-THREAT-MODEL]
   <dd>Artur Janc. <a href="https://arturjanc.com/coi-threat-model.pdf"><cite>Notes on the threat model of cross-origin isolation</cite></a>. 2020-12. URL: <a href="https://arturjanc.com/coi-threat-model.pdf">https://arturjanc.com/coi-threat-model.pdf</a>
   <dt id="biblio-coop-by-default">[COOP-BY-DEFAULT]
   <dd>Mike West. <a href="https://github.com/mikewest/coop-by-default"><cite>COOP By Default</cite></a>. URL: <a href="https://github.com/mikewest/coop-by-default">https://github.com/mikewest/coop-by-default</a>
   <dt id="biblio-coop-coep">[COOP-COEP]
   <dd>Eiji Kitamura. <a href="https://web.dev/coop-coep/"><cite>Making your website 'cross-origin isolated' using COOP and COEP</cite></a>. URL: <a href="https://web.dev/coop-coep/">https://web.dev/coop-coep/</a>
   <dt id="biblio-coop-coep-explained">[COOP-COEP-EXPLAINED]
   <dd>Artur Janc; Charlie Reis; Anne van Kesteren. <a href="https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit"><cite>COOP and COEP Explained</cite></a>. 2020-01-03. URL: <a href="https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit">https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit</a>
   <dt id="biblio-cross-origin-embedder-policy">[CROSS-ORIGIN-EMBEDDER-POLICY]
   <dd>Mike West. <a href="https://wicg.github.io/cross-origin-embedder-policy/"><cite>Cross-Origin Embedder Policy</cite></a>. 2020-09-29. URL: <a href="https://wicg.github.io/cross-origin-embedder-policy/">https://wicg.github.io/cross-origin-embedder-policy/</a>
   <dt id="biblio-cross-origin-isolation-guide">[CROSS-ORIGIN-ISOLATION-GUIDE]
   <dd>Eiji Kitamura. <a href="https://web.dev/cross-origin-isolation-guide/"><cite>A guide to enable cross-origin isolation</cite></a>. URL: <a href="https://web.dev/cross-origin-isolation-guide/">https://web.dev/cross-origin-isolation-guide/</a>
   <dt id="biblio-cross-origin-opener-policy-explainer">[CROSS-ORIGIN-OPENER-POLICY-EXPLAINER]
   <dd>Charlie Reis; Camille Lamy. <a href="https://docs.google.com/document/d/1Ey3MXcLzwR1T7aarkpBXEwP7jKdd2NvQdgYvF8_8scI/edit"><cite>Cross-Origin-Opener-Policy Explainer</cite></a>. 2020-05-24. URL: <a href="https://docs.google.com/document/d/1Ey3MXcLzwR1T7aarkpBXEwP7jKdd2NvQdgYvF8_8scI/edit">https://docs.google.com/document/d/1Ey3MXcLzwR1T7aarkpBXEwP7jKdd2NvQdgYvF8_8scI/edit</a>
   <dt id="biblio-embedding-requires-opt-in">[EMBEDDING-REQUIRES-OPT-IN]
   <dd>Mike West. <a href="https://github.com/mikewest/embedding-requires-opt-in"><cite>Embedding Should Require Explicit Opt-In</cite></a>. URL: <a href="https://github.com/mikewest/embedding-requires-opt-in">https://github.com/mikewest/embedding-requires-opt-in</a>
   <dt id="biblio-long-term-mitigations">[LONG-TERM-MITIGATIONS]
   <dd>Charlie Reis. <a href="https://docs.google.com/document/d/1dnUjxfGWnvhQEIyCZb0F2LmCZ9gio6ogu2rhMGqi6gY/edit"><cite>Long-Term Web Browser Mitigations for Spectre</cite></a>. 2019-03-04. URL: <a href="https://docs.google.com/document/d/1dnUjxfGWnvhQEIyCZb0F2LmCZ9gio6ogu2rhMGqi6gY/edit">https://docs.google.com/document/d/1dnUjxfGWnvhQEIyCZb0F2LmCZ9gio6ogu2rhMGqi6gY/edit</a>
   <dt id="biblio-oopif">[OOPIF]
   <dd>Chromium. <a href="https://www.chromium.org/developers/design-documents/oop-iframes"><cite>Out-of-Process iframes (OOPIFs)</cite></a>. URL: <a href="https://www.chromium.org/developers/design-documents/oop-iframes">https://www.chromium.org/developers/design-documents/oop-iframes</a>
   <dt id="biblio-orb">[ORB]
   <dd>Anne van Kesteren. <a href="https://github.com/annevk/orb"><cite>Opaque Response Blocking (ORB, aka CORB++)</cite></a>. URL: <a href="https://github.com/annevk/orb">https://github.com/annevk/orb</a>
   <dt id="biblio-post-spectre-rethink">[POST-SPECTRE-RETHINK]
   <dd>Chromium. <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/side-channel-threat-model.md"><cite>Post-Spectre Threat Model Re-Think</cite></a>. URL: <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/side-channel-threat-model.md">https://chromium.googlesource.com/chromium/src/+/master/docs/security/side-channel-threat-model.md</a>
   <dt id="biblio-project-fission">[PROJECT-FISSION]
   <dd>Mozilla. <a href="https://wiki.mozilla.org/Project_Fission"><cite>Project Fission</cite></a>. URL: <a href="https://wiki.mozilla.org/Project_Fission">https://wiki.mozilla.org/Project_Fission</a>
   <dt id="biblio-resource-isolation-policy">[RESOURCE-ISOLATION-POLICY]
   <dd>XSLeaks Wiki. <a href="https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/"><cite>Resource Isolation Policy</cite></a>. URL: <a href="https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/">https://xsleaks.dev/docs/defenses/isolation-policies/resource-isolation/</a>
   <dt id="biblio-safely-reviving-shared-memory">[SAFELY-REVIVING-SHARED-MEMORY]
   <dd>Anne van Kesteren. <a href="https://hacks.mozilla.org/2020/07/safely-reviving-shared-memory/"><cite>Safely reviving shared memory</cite></a>. 2020-07-21. URL: <a href="https://hacks.mozilla.org/2020/07/safely-reviving-shared-memory/">https://hacks.mozilla.org/2020/07/safely-reviving-shared-memory/</a>
   <dt id="biblio-site-isolation">[SITE-ISOLATION]
   <dd>Chromium. <a href="https://www.chromium.org/Home/chromium-security/site-isolation"><cite>Site Isolation</cite></a>. URL: <a href="https://www.chromium.org/Home/chromium-security/site-isolation">https://www.chromium.org/Home/chromium-security/site-isolation</a>
   <dt id="biblio-spectre">[SPECTRE]
   <dd>Paul Kocher; et al. <a href="https://ieeexplore.ieee.org/document/8835233"><cite>Spectre Attacks: Exploiting Speculative Execution</cite></a>. May 2019. URL: <a href="https://ieeexplore.ieee.org/document/8835233">https://ieeexplore.ieee.org/document/8835233</a>
   <dt id="biblio-spectre-shaped-web">[SPECTRE-SHAPED-WEB]
   <dd>Anne van Kesteren. <a href="https://docs.google.com/presentation/d/1sadl7jTrBIECCanuqSrNndnDr82NGW1yyuXFT1Dc7SQ/edit#slide=id.p"><cite>A Spectre-shaped Web</cite></a>. 2019-04-16. URL: <a href="https://docs.google.com/presentation/d/1sadl7jTrBIECCanuqSrNndnDr82NGW1yyuXFT1Dc7SQ/edit#slide=id.p">https://docs.google.com/presentation/d/1sadl7jTrBIECCanuqSrNndnDr82NGW1yyuXFT1Dc7SQ/edit#slide=id.p</a>
   <dt id="biblio-spilling-the-beans">[SPILLING-THE-BEANS]
   <dd>Artur Janc; Mike West. <a href="https://www.arturjanc.com/cross-origin-infoleaks.pdf"><cite>How do we Stop Spilling The Beans Across Origins?</cite></a>. 2018-05-16. URL: <a href="https://www.arturjanc.com/cross-origin-infoleaks.pdf">https://www.arturjanc.com/cross-origin-infoleaks.pdf</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> <a data-link-type="biblio" href="#biblio-coi-threat-model" title="Notes on the threat model of cross-origin isolation">[COI-THREAT-MODEL]</a> spells out more implications. Bring them in here for more nuance. <a class="issue-return" href="#issue-340f57a5" title="Jump to section">↵</a></div>
   <div class="issue"> Describe these mitigations in more depth, swiping liberally from <a href="https://docs.google.com/document/d/1JBUaX1xSOZRxBk5bRNZWgnzyJoCQC52TIRokACBSmGc/edit?resourcekey=0-cZ7da6v52enjwRSsp_tLyQ">Notes on the threat model of <em>cross-origin isolation</em></a>, <a href="https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit">Safely reviving shared memory</a>, etc. <a class="issue-return" href="#issue-db0b0c7b" title="Jump to section">↵</a></div>
   <div class="issue"> If we implemented more granular bindings for CORP headers (along
    the lines of <code>Cross-Origin-Resource-Policy: https://trusted.example</code>), we could avoid this
    tradeoff entirely. <a href="https://github.com/whatwg/fetch/issues/760">[Issue #whatwg/fetch#760]</a> <a class="issue-return" href="#issue-ae9c0065" title="Jump to section">↵</a></div>
   <div class="issue"> Find some links. <a class="issue-return" href="#issue-94179e25" title="Jump to section">↵</a></div>
   <div class="issue"> Find some links. <a class="issue-return" href="#issue-94179e25①" title="Jump to section">↵</a></div>
   <div class="issue"> Find some links. <a class="issue-return" href="#issue-94179e25②" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"251f80a9": {"dfnID":"251f80a9","dfnText":"frame-ancestors","external":true,"refSections":[{"refs":[{"id":"ref-for-frame-ancestors"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-frame-ancestors\u2460"}],"title":"2.2.3. Documents Expecting Cross-Origin Openers"}],"url":"https://w3c.github.io/webappsec-csp/#frame-ancestors"},
"388997ea": {"dfnID":"388997ea","dfnText":"cross-origin read blocking","external":true,"refSections":[{"refs":[{"id":"ref-for-corb"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-corb\u2460"}],"title":"2.1. Subresources"}],"url":"https://fetch.spec.whatwg.org/#corb"},
"6b3e31cd": {"dfnID":"6b3e31cd","dfnText":"cross-origin opener policy","external":true,"refSections":[{"refs":[{"id":"ref-for-cross-origin-opener-policies"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-cross-origin-opener-policies\u2460"}],"title":"2.1. Subresources"}],"url":"https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies"},
"7e56321a": {"dfnID":"7e56321a","dfnText":"cross-origin-opener-policy","external":true,"refSections":[{"refs":[{"id":"ref-for-cross-origin-opener-policies"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-cross-origin-opener-policies\u2460"}],"title":"2.1. Subresources"}],"url":"https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies"},
"7e8a44f1": {"dfnID":"7e8a44f1","dfnText":"cross-origin-resource-policy","external":true,"refSections":[{"refs":[{"id":"ref-for-http-cross-origin-resource-policy"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-http-cross-origin-resource-policy\u2460"}],"title":"2.1.2. Dynamic Subresources"}],"url":"https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy"},
"8a7dfd23": {"dfnID":"8a7dfd23","dfnText":"postMessage(message, options)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-window-postmessage-options"}],"title":"2.2.3. Documents Expecting Cross-Origin Openers"}],"url":"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-window-postmessage-options"},
"8b1d49ab": {"dfnID":"8b1d49ab","dfnText":"x-content-type-options","external":true,"refSections":[{"refs":[{"id":"ref-for-http-x-content-type-options"}],"title":"2.1. Subresources"}],"url":"https://fetch.spec.whatwg.org/#http-x-content-type-options"},
"8ea172e9": {"dfnID":"8ea172e9","dfnText":"sandbox","external":true,"refSections":[{"refs":[{"id":"ref-for-sandbox"}],"title":"2.1. Subresources"}],"url":"https://w3c.github.io/webappsec-csp/#sandbox"},
"91890fa8": {"dfnID":"91890fa8","dfnText":"SharedArrayBuffer","external":true,"refSections":[{"refs":[{"id":"ref-for-sec-sharedarraybuffer-objects"}],"title":"2.2.1. Fully-Isolated Documents"}],"url":"https://tc39.es/ecma262/#sec-sharedarraybuffer-objects"},
"9de4af9f": {"dfnID":"9de4af9f","dfnText":"vary","external":true,"refSections":[{"refs":[{"id":"ref-for-section-7.1.4"}],"title":"2.1. Subresources"}],"url":"https://tools.ietf.org/html/rfc7231#section-7.1.4"},
"a944ac4c": {"dfnID":"a944ac4c","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"}],"title":"1. Introduction"}],"url":"https://html.spec.whatwg.org/multipage/origin.html#concept-origin"},
"b0120874": {"dfnID":"b0120874","dfnText":"x-frame-options","external":true,"refSections":[{"refs":[{"id":"ref-for-the-x-frame-options-header"}],"title":"2.1. Subresources"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-x-frame-options-header"},
"b01b1359": {"dfnID":"b01b1359","dfnText":"opaque origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-opaque"}],"title":"2.1. Subresources"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"b7c21a86": {"dfnID":"b7c21a86","dfnText":"content-security-policy","external":true,"refSections":[{"refs":[{"id":"ref-for-header-content-security-policy"}],"title":"2.1. Subresources"}],"url":"https://w3c.github.io/webappsec-csp/#header-content-security-policy"},
"bc2f1a3d": {"dfnID":"bc2f1a3d","dfnText":"cross-origin resource policy","external":true,"refSections":[{"refs":[{"id":"ref-for-http-cross-origin-resource-policy"}],"title":"1.2. TL;DR"},{"refs":[{"id":"ref-for-http-cross-origin-resource-policy\u2460"}],"title":"2.1.2. Dynamic Subresources"}],"url":"https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy"},
"f0e1d33e": {"dfnID":"f0e1d33e","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-origin-header"}],"title":"1.2. TL;DR"}],"url":"https://fetch.spec.whatwg.org/#origin-header"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"https://fetch.spec.whatwg.org/#corb": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"cross-origin read blocking","type":"dfn","url":"https://fetch.spec.whatwg.org/#corb"},
"https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"cross-origin resource policy","type":"dfn","url":"https://fetch.spec.whatwg.org/#http-cross-origin-resource-policy"},
"https://fetch.spec.whatwg.org/#http-x-content-type-options": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"x-content-type-options","type":"http-header","url":"https://fetch.spec.whatwg.org/#http-x-content-type-options"},
"https://fetch.spec.whatwg.org/#origin-header": {"export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"origin","type":"http-header","url":"https://fetch.spec.whatwg.org/#origin-header"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque": {"export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opaque origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-x-frame-options-header": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"x-frame-options","type":"http-header","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-x-frame-options-header"},
"https://html.spec.whatwg.org/multipage/origin.html#concept-origin": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/origin.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies": {"export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"cross-origin opener policy","type":"dfn","url":"https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies"},
"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-window-postmessage-options": {"export":true,"for_":["Window"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"postMessage(message, options)","type":"method","url":"https://html.spec.whatwg.org/multipage/web-messaging.html#dom-window-postmessage-options"},
"https://tc39.es/ecma262/#sec-sharedarraybuffer-objects": {"export":true,"for_":[],"level":"","normative":true,"shortname":"ecma262","spec":"ecma262","status":"anchor-block","text":"SharedArrayBuffer","type":"interface","url":"https://tc39.es/ecma262/#sec-sharedarraybuffer-objects"},
"https://tools.ietf.org/html/rfc7231#section-7.1.4": {"export":true,"for_":[],"level":"","normative":true,"shortname":"rfc7231","spec":"rfc7231","status":"anchor-block","text":"vary","type":"http-header","url":"https://tools.ietf.org/html/rfc7231#section-7.1.4"},
"https://w3c.github.io/webappsec-csp/#frame-ancestors": {"export":true,"for_":[],"level":"3","normative":true,"shortname":"csp","spec":"csp3","status":"current","text":"frame-ancestors","type":"dfn","url":"https://w3c.github.io/webappsec-csp/#frame-ancestors"},
"https://w3c.github.io/webappsec-csp/#header-content-security-policy": {"export":true,"for_":[],"level":"3","normative":true,"shortname":"csp","spec":"csp3","status":"current","text":"content-security-policy","type":"http-header","url":"https://w3c.github.io/webappsec-csp/#header-content-security-policy"},
"https://w3c.github.io/webappsec-csp/#sandbox": {"export":true,"for_":[],"level":"3","normative":true,"shortname":"csp","spec":"csp3","status":"current","text":"sandbox","type":"dfn","url":"https://w3c.github.io/webappsec-csp/#sandbox"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.text != linkText) {
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.text)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const ref = refsData[url];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>