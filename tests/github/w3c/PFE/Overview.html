<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Incremental Font Transfer</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <link href="https://www.w3.org/TR/example/" rel="canonical">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Incremental Font Transfer</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="1970-01-01">1 January 1970</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://w3c.github.io/PFE/Overview.html">https://w3c.github.io/PFE/Overview.html</a>
     <dt>Latest published version:
     <dd><a href="https://www.w3.org/TR/example/">https://www.w3.org/TR/example/</a>
     <dt>Feedback:
     <dd><span><a href="mailto:public-webfonts-wg@w3.org?subject=%5BPFE%5D%20YOUR%20TOPIC%20HERE">public-webfonts-wg@w3.org</a> with subject line “<kbd>[PFE] <i data-lt>… message topic …</i></kbd>” (<a href="https://lists.w3.org/Archives/Public/public-webfonts-wg/" rel="discussion">archives</a>)</span>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard" data-editor-id="1438"><a class="p-name fn u-url url" href="https://svgees.us/">Chris Lilley</a> (<span class="p-org org">W3C</span>)
     <dd class="editor p-author h-card vcard" data-editor-id="77180"><a class="p-name fn u-email email" href="mailto:mmaxfield@apple.com">Myles C. Maxfield</a> (<span class="p-org org">Apple Inc.</span>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:grieger@google.com">Garret Rieger</a> (<span class="p-org org">Google Inc.</span>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 1970 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Example example</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This is a public copy of the editors’ draft.
	It is provided for discussion only and may change at any moment.
	Its publication here does not imply endorsement of its contents by W3C.
	Don’t cite this document other than as work in progress. </p>
   <p> If you wish to make comments regarding this document, please <a href="https://github.com/w3c/PFE/issues/new">file an issue on the specification repository</a>. </p>
   <p> This document was produced by the <a href="https://www.w3.org/groups/wg/webfonts">Web Fonts Working Group</a> </p>
   <p> This document was produced by a group operating under
  the <a href="https://www.w3.org/policies/patent-policy/20200915/">W3C Patent Policy</a>.
  W3C maintains a <a href="https://www.w3.org/groups/wg/webfonts/ipr" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group;
  that page also includes instructions for disclosing a patent.
  An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/20200915/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/20200915/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
   <p></p>
   <p>This is a largely empty document because we have just started working on it.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li>
     <a href="#patch-incxfer"><span class="secno">2</span> <span class="content">Patch Based Incremental Transfer</span></a>
     <ol class="toc">
      <li>
       <a href="#data-types"><span class="secno">2.1</span> <span class="content">Data Types</span></a>
       <ol class="toc">
        <li><a href="#encoding"><span class="secno">2.1.1</span> <span class="content">Encoding</span></a>
        <li><a href="#primitives"><span class="secno">2.1.2</span> <span class="content">Primitives</span></a>
        <li><a href="#sparsebitset"><span class="secno">2.1.3</span> <span class="content">SparseBitSet</span></a>
        <li><a href="#objects"><span class="secno">2.1.4</span> <span class="content">Objects</span></a>
        <li>
         <a href="#schemas"><span class="secno">2.1.5</span> <span class="content">Object Schemas</span></a>
         <ol class="toc">
          <li><a href="#CompressedList"><span class="secno">2.1.5.1</span> <span class="content">CompressedList</span></a>
          <li><a href="#CompressedSet"><span class="secno">2.1.5.2</span> <span class="content">CompressedSet</span></a>
          <li><a href="#PatchRequest"><span class="secno">2.1.5.3</span> <span class="content">PatchRequest</span></a>
          <li><a href="#PatchResponse"><span class="secno">2.1.5.4</span> <span class="content">PatchResponse</span></a>
         </ol>
       </ol>
      <li>
       <a href="#rebase-request"><span class="secno">2.2</span> <span class="content">New Font Request</span></a>
       <ol class="toc">
        <li><a href="#rebase-standard-response"><span class="secno">2.2.1</span> <span class="content">Standard Response</span></a>
        <li><a href="#rebase-errors"><span class="secno">2.2.2</span> <span class="content">Errors</span></a>
       </ol>
      <li>
       <a href="#patch-request"><span class="secno">2.3</span> <span class="content">Patch Font Request</span></a>
       <ol class="toc">
        <li><a href="#patch-standard-response"><span class="secno">2.3.1</span> <span class="content">Standard Response</span></a>
        <li>
         <a href="#patch-recoverable-errors"><span class="secno">2.3.2</span> <span class="content">Recoverable Errors</span></a>
         <ol class="toc">
          <li><a href="#client-font-mismatch"><span class="secno">2.3.2.1</span> <span class="content">Client’s Original Font does not Match Server’s</span></a>
          <li><a href="#client-base-mismatch"><span class="secno">2.3.2.2</span> <span class="content">Client’s Base does not Match Server’s</span></a>
          <li><a href="#codepoint-reordering-mismatch"><span class="secno">2.3.2.3</span> <span class="content">Client Codepoint Reordering does not Match Servers</span></a>
          <li><a href="#patch-mismatch"><span class="secno">2.3.2.4</span> <span class="content">Client Side Patched Base Checksum Mismatch</span></a>
          <li><a href="#cmap4-overflow"><span class="secno">2.3.2.5</span> <span class="content">Cmap Format 4 Overflow</span></a>
          <li><a href="#offset-overflow"><span class="secno">2.3.2.6</span> <span class="content">Offset Overflow during Subsetting</span></a>
         </ol>
        <li><a href="#errors"><span class="secno">2.3.3</span> <span class="content">Errors</span></a>
       </ol>
      <li><a href="#rebase-response"><span class="secno">2.4</span> <span class="content">New Font Response</span></a>
      <li><a href="#patch-response"><span class="secno">2.5</span> <span class="content">Patch Font Response</span></a>
      <li><a href="#reindex-response"><span class="secno">2.6</span> <span class="content">Update Codepoint Ordering Response</span></a>
      <li><a href="#error-response"><span class="secno">2.7</span> <span class="content">Error Response</span></a>
      <li>
       <a href="#procedures"><span class="secno">2.8</span> <span class="content">Procedures</span></a>
       <ol class="toc">
        <li><a href="#computing-checksums"><span class="secno">2.8.1</span> <span class="content">Computing Checksums</span></a>
        <li>
         <a href="#codepoint-reodering"><span class="secno">2.8.2</span> <span class="content">Codepoint reodering</span></a>
         <ol class="toc">
          <li><a href="#reodering-checksum"><span class="secno">2.8.2.1</span> <span class="content">Computing Checksum</span></a>
          <li><a href="#reordering-algorithm"><span class="secno">2.8.2.2</span> <span class="content">Recommended algorithm</span></a>
         </ol>
        <li><a href="#patch-formats"><span class="secno">2.8.3</span> <span class="content">Patch and Compression Formats</span></a>
       </ol>
     </ol>
    <li><a href="#range-request-incxfer"><span class="secno">3</span> <span class="content">Range Request Incremental Transfer</span></a>
    <li><a href="#negotiating-transfer-type"><span class="secno">4</span> <span class="content">Negotiating Incremental Transfer Type</span></a>
    <li><a href="#priv-sec"><span class="secno"></span> <span class="content">Privacy and Security Considerations</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p><em>This section is not normative.</em></p>
   <p>The success of WebFonts is unevenly distributed. This specification allows WebFonts to be used where slow networks, very large fonts, or complex subsetting requirements currently preclude their use. For example, even using WOFF 2 <a data-link-type="biblio" href="#biblio-woff2" title="WOFF File Format 2.0">[WOFF2]</a>, fonts for CJK languages are too large to be practical.</p>
   <p>See the Progressive Font Enrichment: Evaluation Report <a data-link-type="biblio" href="#biblio-pfe-report" title="Progressive Font Enrichment: Evaluation Report">[PFE-report]</a> for the investigation which led to this specification.</p>
   <h2 class="heading settled" data-level="2" id="patch-incxfer"><span class="secno">2. </span><span class="content">Patch Based Incremental Transfer</span><a class="self-link" href="#patch-incxfer"></a></h2>
   <p>TODO(garretrieger): Describe the high level version of how this version operates.</p>
   <h3 class="heading settled" data-level="2.1" id="data-types"><span class="secno">2.1. </span><span class="content">Data Types</span><a class="self-link" href="#data-types"></a></h3>
   <p>This section lists all of the data types that are used to form the request and response messages
sent between the client and server.</p>
   <h4 class="heading settled" data-level="2.1.1" id="encoding"><span class="secno">2.1.1. </span><span class="content">Encoding</span><a class="self-link" href="#encoding"></a></h4>
   <p>All data types defined here are encoded into a byte representation for transport using CBOR
(Concise Binary Object Representation) <a data-link-type="biblio" href="#biblio-rfc8949" title="Concise Binary Object Representation (CBOR)">[rfc8949]</a>. More information on how each data types
should be encoded by CBOR are given in the definition of those data types.</p>
   <h4 class="heading settled" data-level="2.1.2" id="primitives"><span class="secno">2.1.2. </span><span class="content">Primitives</span><a class="self-link" href="#primitives"></a></h4>
   <table>
    <tbody>
     <tr>
      <th>Data Type
      <th>Description
      <th>CBOR Major Type
     <tr>
      <td>Integer
      <td>An integer value range [-2^64 - 1, 2^64 - 1] inclusive
      <td>0 or 1
     <tr>
      <td>ByteString
      <td>Variable number of bytes
      <td>2
     <tr>
      <td>ArrayOf&lt;Type>
      <td>Array of a variable number of items of Type
      <td>4
   </table>
   <h4 class="heading settled" data-level="2.1.3" id="sparsebitset"><span class="secno">2.1.3. </span><span class="content">SparseBitSet</span><a class="self-link" href="#sparsebitset"></a></h4>
   <p>A data structure which compactly stores a set of distinct unsigned integers. The set is represented as
a tree where each node has a fixed number of children that recursively sub-divides an interval into
equal partitions. A tree of height <i>H</i> with branching factor <i>B</i> can store set membership
for integers in the interval [0 to <i>B</i><sup><i>H</i></sup>-1] inclusive. The tree is encoded into
a ByteString for transport.</p>
   <p>To construct the tree <i>T</i> which encodes set <i>S</i> first select the branching factor <i>B</i> (how many children each node has). <i>B</i> can be 4, 8, 16, or 32.</p>
   <p class="note" role="note"><span class="marker">Note:</span> the encoder can use any of the possible branching factors, but it is recommended to
use 4 as that has been shown to give the smallest encodings for most sets typically encountered.</p>
   <p>Next, determine the height, <i>H</i>, of the tree:</p>
   <p><i>H</i> = ceil(log<sub><i>B</i></sub>(max(S) + 1))</p>
   <p>Next create a tree of height H where all non-leaf nodes have <i>B</i> children. Each node in the tree
has a single value composed of <i>B</i> bits. Given a node <i>p</i> which has <i>B</i> children: <i>c<sub>0</sub></i> ... <i>c<sub><i>B</i> - 1</sub></i> and is in a tree, <i>T</i>, of height <i>H</i>, then:</p>
   <ul>
    <li data-md>
     <p>D(<i>c<sub>i</sub></i>) is depth of node <i>c<sub>i</sub></i>, that is the number of edges between
the root node and <i>c<sub>i</sub></i>.</p>
    <li data-md>
     <p>Start(<i>c<sub>i</sub></i>) is the start (inclusive) of the interval  covered by <i>c<sub>i</sub></i> :<br> Start(<i>c<sub>i</sub></i>) =
 Start(<i>p</i>) + <i>i</i> * <i>B</i><sup><i>H</i> - D(<i>c<sub>i</sub></i>)</sup></p>
    <li data-md>
     <p>End(<i>c<sub>i</sub></i>) is the end (exclusive) of the interval  covered by <i>c<sub>i</sub></i> :<br> End(<i>c<sub>i</sub></i>) =
 Start(<i>p</i>) + (<i>i</i> + 1) * <i>B</i><sup><i>H</i> - D(<i>c<sub>i</sub></i>)</sup></p>
    <li data-md>
     <p>Start(root node) = 0</p>
    <li data-md>
     <p>The value of node <i>p</i> is a string of <i>B</i> bits. If its bits are numbered from 0 (least
significant) to <i>B</i> - 1 (most significant) then bit <i>i</i> will be 1 if the set <i>S</i> contains at least one member in the interval [Start(<i>c<sub>i</sub></i>),
End(<i>c<sub>i</sub></i>)), otherwise bit <i>i</i> will be 0.</p>
    <li data-md>
     <p>If for node <i>p</i>, End(<i>p</i>) - Start(<i>p</i>) = <i>B</i>, then <i>p</i> will have no
children.</p>
   </ul>
   <p>The tree is encoded into a bit string. The bits of the bit string are numbered from 0 to M. When
appending multi bit values to the bit string, bits are added in order from least significant bit to
most significant bit.</p>
   <p>First append 2 bits which encode the branching factor:</p>
   <table>
    <tbody>
     <tr>
      <th>Bits
      <th>Branching Factor
     <tr>
      <td>00
      <td>4
     <tr>
      <td>01
      <td>8
     <tr>
      <td>10
      <td>16
     <tr>
      <td>11
      <td>32
   </table>
   <p>Then append the value <i>H</i> - 1 as a 6 bit unsigned integer.</p>
   <p>Next the nodes are encoded into the bit string by traversing the nodes of the <i>T</i> in level
order and appending the value for each non-zero node to the bit string.If all set values
covered by a node’s interval are present within set <i>S</i> that node can instead be encoded in the
bit string as <i>B</i> bits all set to zero. All children of that node must not be encoded.</p>
   <p>Lastly the bit string is converted into a ByteString by converting each consecutive group of 8 bits
into the next byte of the string. The bit with the smallest index in the bit string is the least
significant bit in the byte and the bit with the largest index is the most significant bit.</p>
   <div class="example" id="example-76606ecb">
    <a class="self-link" href="#example-76606ecb"></a> The set {2, 33, 323} in a tree with a branching factor of 8 is encoded as the bit string: 
<pre>BitString:
|- header |- lvl 0 |---- level 1 ----|------- level 2 -----------|
|         |   n0   |   n1       n2   |   n3       n4       n5    |
[ 10010000 10000100 10001000 10000000 00100000 01000000 00010000 ]

Which then becomes the ByteString:
[
  0b00001001,
  0b00100001,
  0b00010001,
  0b00000001,
  0b00000100,
  0b00000010,
  0b00001000
]
</pre>
    <p>First determine the height of the tree:</p>
    <p><i>H</i> = ceil(log<sub>8</sub>(323 + 1)) = 3</p>
    <p>Then append</p>
    <ul>
     <li data-md>
      <p>branching factor = 8 = 01</p>
     <li data-md>
      <p><i>H</i> - 1 = 2 = 000010</p>
    </ul>
    <p>Level 0:</p>
    <ul>
     <li data-md>
      <p>root node, n<sub>0</sub> append 00100001. Since there are set members in the intervals
 [0, 64) for bit 0 and [320, 384) for bit 5.</p>
    </ul>
    <p>Level 1:</p>
    <ul>
     <li data-md>
      <p>There will be two non-zero children corresponding to bit 0 and bit 5 in n<sub>0</sub>:</p>
     <li data-md>
      <p>n<sub>1</sub> append 00010001. It is child 0 of n<sub>0</sub> and subdivides the interval
 [0, 64). Bit 0 is set since there are set members in [0, 8) and bit 4 for [32, 40).</p>
     <li data-md>
      <p>n<sub>2</sub> append 00000001. It is child 5 of n<sub>0</sub> it subdivides the interval
 [320, 384). Bit 0 is set since there are set members in [320 - 328).</p>
    </ul>
    <p>Level 2:</p>
    <ul>
     <li data-md>
      <p>n<sub>3</sub> append 00000100. Child 0 of n<sub>1</sub>, bit 2 is set for the interval [2, 3) or 2.</p>
     <li data-md>
      <p>n<sub>4</sub> append 00000010. Child 4 of n<sub>1</sub>, bit 1 is set for the interval [33, 34) or 33.</p>
     <li data-md>
      <p>n<sub>5</sub> append 00001000. Child 0 of n<sub>2</sub>, bit 3 is set for the interval [323, 324)
 or 323.</p>
    </ul>
   </div>
   <div class="example" id="example-88b1de08">
    <a class="self-link" href="#example-88b1de08"></a> The set {0, 1, 2, ..., 17} can be encoded with a branching factor of 4 as: 
<pre>BitString:
|- header | l0 |- lvl 1 -| l2  |
|         | n0 | n1 | n2 | n3  |
[ 00010000 1100 0000 1000 1100 ]

ByteString:
[
  0b00001000,
  0b00000011,
  0b00110001
]
</pre>
    <p>First determine the height of the tree:</p>
    <p><i>H</i> = ceil(log<sub>4</sub>(17 + 1)) = 3</p>
    <p>Then append</p>
    <ul>
     <li data-md>
      <p>branching factor = 4 = 00</p>
     <li data-md>
      <p><i>H</i> - 1 = 2 = 000010</p>
    </ul>
    <p>Level 0:</p>
    <ul>
     <li data-md>
      <p>n<sub>0</sub> append 0011. Bit 0 set for [0, 16), bit 1 set for [16, 32)</p>
    </ul>
    <p>Level 1:</p>
    <ul>
     <li data-md>
      <p>n<sub>1</sub> append 0000. All bits zero to indicate interval [0, 16) is fully filled.</p>
     <li data-md>
      <p>n<sub>2</sub> append 0001. Bit 0 set for [16, 20)</p>
    </ul>
    <p>Level 2:</p>
    <ul>
     <li data-md>
      <p>n<sub>3</sub> append 0011. Bit 0 set for value 16, bit 1 set for value 17.</p>
    </ul>
   </div>
   <h4 class="heading settled" data-level="2.1.4" id="objects"><span class="secno">2.1.4. </span><span class="content">Objects</span><a class="self-link" href="#objects"></a></h4>
   <p>Objects are data structures comprised of key and value pairs. Objects are encoded via CBOR as maps
(major type 5). Each key and value pair is encoded as a single map entry. Keys are always unsigned
integers and are encoded using major type 0. Values are encoded using the encoding specified by the
type of the value.</p>
   <p>All fields in an object are optional and do not need to have an associated value. Conversely when
decoding and object fields may be present which are not specified in the schema. The decoder must
ignore without error any key and value pairs where the key is not recognized.</p>
   <p>There are several types of object used, each type is defined by a schema in <a href="#schemas">§ 2.1.5 Object Schemas</a>. The schema
for a type specifies for each field:</p>
   <ul>
    <li data-md>
     <p>A human readable name for the field. For reference only, not used in the encoding.</p>
    <li data-md>
     <p>A unsigned integer id for the field. This is used as the key in the encoding.</p>
    <li data-md>
     <p>The type of the value stored in this field. Can be any of the types defined in <a href="#data-types">§ 2.1 Data Types</a> including object types.</p>
   </ul>
   <h4 class="heading settled" data-level="2.1.5" id="schemas"><span class="secno">2.1.5. </span><span class="content">Object Schemas</span><a class="self-link" href="#schemas"></a></h4>
   <h5 class="heading settled" data-level="2.1.5.1" id="CompressedList"><span class="secno">2.1.5.1. </span><span class="content">CompressedList</span><a class="self-link" href="#CompressedList"></a></h5>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td>value_deltas
      <td>ArrayOf&lt;Integer>
   </table>
   <p>Encodes a list of unsigned integers. The list is ordered and allows
duplicate values. Given a list L to be encoded the array value_deltas is calculated:</p>
<pre>value_deltas = []
if len(value_deltas) > 0:
  value_deltas[0] = L[0]
  for i in range(1, len(value_deltas)):
    value_deltas[i] = L[i] - L[i-1]
</pre>
   <div class="example" id="example-6e146a01"><a class="self-link" href="#example-6e146a01"></a> The list [2, 2, 5, 1, 3, 7] would be encoded as [2, 0, 3, -4, 2, 4]. </div>
   <h5 class="heading settled" data-level="2.1.5.2" id="CompressedSet"><span class="secno">2.1.5.2. </span><span class="content">CompressedSet</span><a class="self-link" href="#CompressedSet"></a></h5>
   <p>Encodes a set of unsigned integers. The set is not ordered and does not
allow duplicates. Members of the set are encoded into either a sparse bit
set or a list of ranges. To obtain the final set the members of the sparse
bit set and the list of ranges are unioned together.</p>
   <p>The list of ranges is encoded as a series of deltas. For example the ranges</p>
   <p>[3, 10\], [13, 15\], [17, 17\] would be encoded as [3, 7, 3, 2, 2, 0\].</p>
   <p>| ID | Field Name             | Type                   |
  | -- | ---------------------- | ---------------------- |
  | 0  | sparse_bit_set         | SparseBitSet           |
  | 1  | range_deltas           | ArrayOf&lt;Integer> |</p>
   <h5 class="heading settled" data-level="2.1.5.3" id="PatchRequest"><span class="secno">2.1.5.3. </span><span class="content">PatchRequest</span><a class="self-link" href="#PatchRequest"></a></h5>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td>protocol_version
      <td>Integer
     <tr>
      <td>1
      <td>original_font_checksum
      <td>Integer
     <tr>
      <td>2
      <td>base_checksum
      <td>Integer
     <tr>
      <td>3
      <td>patch_format
      <td>ArrayOf&lt;Integer>
     <tr>
      <td>4
      <td>codepoints_have
      <td>CompressedSet
     <tr>
      <td>5
      <td>codepoints_needed
      <td>CompressedSet
     <tr>
      <td>6
      <td>ordering_checksum
      <td>Integer
     <tr>
      <td>7
      <td>indices_have
      <td>CompressedSet
     <tr>
      <td>8
      <td>indices_needed
      <td>CompressedSet
   </table>
   <p>patch_format can include be any of the values specified in <a href="#patch-formats">§ 2.8.3 Patch and Compression Formats</a>.</p>
   <h5 class="heading settled" data-level="2.1.5.4" id="PatchResponse"><span class="secno">2.1.5.4. </span><span class="content">PatchResponse</span><a class="self-link" href="#PatchResponse"></a></h5>
   <table>
    <tbody>
     <tr>
      <th>ID
      <th>Field Name
      <th>Value Type
     <tr>
      <td>0
      <td>response_type
      <td>Integer
     <tr>
      <td>1
      <td>original_font_checksum
      <td>Integer
     <tr>
      <td>2
      <td>patch_format
      <td>Integer
     <tr>
      <td>3
      <td>patch
      <td>ByteString
     <tr>
      <td>4
      <td>patched_checksum
      <td>Integer
     <tr>
      <td>4
      <td>codepoint_ordering
      <td>CompressedList
     <tr>
      <td>5
      <td>ordering_checksum
      <td>Integer
   </table>
   <p>response_type can be one of the following values:</p>
   <table>
    <tbody>
     <tr>
      <th>Value
      <th>Response Type
     <tr>
      <td>0
      <td>PATCH
     <tr>
      <td>1
      <td>REBASE
     <tr>
      <td>2
      <td>REINDEX
   </table>
   <h3 class="heading settled" data-level="2.2" id="rebase-request"><span class="secno">2.2. </span><span class="content">New Font Request</span><a class="self-link" href="#rebase-request"></a></h3>
   <h4 class="heading settled" data-level="2.2.1" id="rebase-standard-response"><span class="secno">2.2.1. </span><span class="content">Standard Response</span><a class="self-link" href="#rebase-standard-response"></a></h4>
   <h4 class="heading settled" data-level="2.2.2" id="rebase-errors"><span class="secno">2.2.2. </span><span class="content">Errors</span><a class="self-link" href="#rebase-errors"></a></h4>
   <h3 class="heading settled" data-level="2.3" id="patch-request"><span class="secno">2.3. </span><span class="content">Patch Font Request</span><a class="self-link" href="#patch-request"></a></h3>
   <h4 class="heading settled" data-level="2.3.1" id="patch-standard-response"><span class="secno">2.3.1. </span><span class="content">Standard Response</span><a class="self-link" href="#patch-standard-response"></a></h4>
   <h4 class="heading settled" data-level="2.3.2" id="patch-recoverable-errors"><span class="secno">2.3.2. </span><span class="content">Recoverable Errors</span><a class="self-link" href="#patch-recoverable-errors"></a></h4>
   <h5 class="heading settled" data-level="2.3.2.1" id="client-font-mismatch"><span class="secno">2.3.2.1. </span><span class="content">Client’s Original Font does not Match Server’s</span><a class="self-link" href="#client-font-mismatch"></a></h5>
   <h5 class="heading settled" data-level="2.3.2.2" id="client-base-mismatch"><span class="secno">2.3.2.2. </span><span class="content">Client’s Base does not Match Server’s</span><a class="self-link" href="#client-base-mismatch"></a></h5>
   <h5 class="heading settled" data-level="2.3.2.3" id="codepoint-reordering-mismatch"><span class="secno">2.3.2.3. </span><span class="content">Client Codepoint Reordering does not Match Servers</span><a class="self-link" href="#codepoint-reordering-mismatch"></a></h5>
   <h5 class="heading settled" data-level="2.3.2.4" id="patch-mismatch"><span class="secno">2.3.2.4. </span><span class="content">Client Side Patched Base Checksum Mismatch</span><a class="self-link" href="#patch-mismatch"></a></h5>
   <h5 class="heading settled" data-level="2.3.2.5" id="cmap4-overflow"><span class="secno">2.3.2.5. </span><span class="content">Cmap Format 4 Overflow</span><a class="self-link" href="#cmap4-overflow"></a></h5>
   <h5 class="heading settled" data-level="2.3.2.6" id="offset-overflow"><span class="secno">2.3.2.6. </span><span class="content">Offset Overflow during Subsetting</span><a class="self-link" href="#offset-overflow"></a></h5>
   <h4 class="heading settled" data-level="2.3.3" id="errors"><span class="secno">2.3.3. </span><span class="content">Errors</span><a class="self-link" href="#errors"></a></h4>
   <h3 class="heading settled" data-level="2.4" id="rebase-response"><span class="secno">2.4. </span><span class="content">New Font Response</span><a class="self-link" href="#rebase-response"></a></h3>
   <h3 class="heading settled" data-level="2.5" id="patch-response"><span class="secno">2.5. </span><span class="content">Patch Font Response</span><a class="self-link" href="#patch-response"></a></h3>
   <h3 class="heading settled" data-level="2.6" id="reindex-response"><span class="secno">2.6. </span><span class="content">Update Codepoint Ordering Response</span><a class="self-link" href="#reindex-response"></a></h3>
   <h3 class="heading settled" data-level="2.7" id="error-response"><span class="secno">2.7. </span><span class="content">Error Response</span><a class="self-link" href="#error-response"></a></h3>
   <ul>
    <li data-md>
     <p>font not found.</p>
    <li data-md>
     <p>bad request.</p>
    <li data-md>
     <p>internal error.</p>
   </ul>
   <h3 class="heading settled" data-level="2.8" id="procedures"><span class="secno">2.8. </span><span class="content">Procedures</span><a class="self-link" href="#procedures"></a></h3>
   <h4 class="heading settled" data-level="2.8.1" id="computing-checksums"><span class="secno">2.8.1. </span><span class="content">Computing Checksums</span><a class="self-link" href="#computing-checksums"></a></h4>
   <h4 class="heading settled" data-level="2.8.2" id="codepoint-reodering"><span class="secno">2.8.2. </span><span class="content">Codepoint reodering</span><a class="self-link" href="#codepoint-reodering"></a></h4>
   <h5 class="heading settled" data-level="2.8.2.1" id="reodering-checksum"><span class="secno">2.8.2.1. </span><span class="content">Computing Checksum</span><a class="self-link" href="#reodering-checksum"></a></h5>
   <h5 class="heading settled" data-level="2.8.2.2" id="reordering-algorithm"><span class="secno">2.8.2.2. </span><span class="content">Recommended algorithm</span><a class="self-link" href="#reordering-algorithm"></a></h5>
   <h4 class="heading settled" data-level="2.8.3" id="patch-formats"><span class="secno">2.8.3. </span><span class="content">Patch and Compression Formats</span><a class="self-link" href="#patch-formats"></a></h4>
   <h2 class="heading settled" data-level="3" id="range-request-incxfer"><span class="secno">3. </span><span class="content">Range Request Incremental Transfer</span><a class="self-link" href="#range-request-incxfer"></a></h2>
   <h2 class="heading settled" data-level="4" id="negotiating-transfer-type"><span class="secno">4. </span><span class="content">Negotiating Incremental Transfer Type</span><a class="self-link" href="#negotiating-transfer-type"></a></h2>
   <h2 class="no-num heading settled" id="priv-sec"><span class="content">Privacy and Security Considerations</span><a class="self-link" href="#priv-sec"></a></h2>
   <p class="issue" id="issue-b39f1b18"><a class="self-link" href="#issue-b39f1b18"></a> Note any issues that have been raised about privacy and security.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc8949">[RFC8949]
   <dd>C. Bormann; P. Hoffman. <a href="https://www.rfc-editor.org/rfc/rfc8949"><cite>Concise Binary Object Representation (CBOR)</cite></a>. December 2020. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8949">https://www.rfc-editor.org/rfc/rfc8949</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-pfe-report">[PFE-report]
   <dd>Chris Lilley. <a href="https://www.w3.org/TR/PFE-evaluation/"><cite>Progressive Font Enrichment: Evaluation Report</cite></a>. 15 October 2020. Note. URL: <a href="https://www.w3.org/TR/PFE-evaluation/">https://www.w3.org/TR/PFE-evaluation/</a>
   <dt id="biblio-woff2">[WOFF2]
   <dd>Vladimir Levantovsky. <a href="https://w3c.github.io/woff/woff2/"><cite>WOFF File Format 2.0</cite></a>. URL: <a href="https://w3c.github.io/woff/woff2/">https://w3c.github.io/woff/woff2/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Note any issues that have been raised about privacy and security. <a class="issue-return" href="#issue-b39f1b18" title="Jump to section">↵</a></div>
  </div>